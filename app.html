<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Aplicaci√≥n para gestionar tu tiempo, h√°bitos, metas y gastos">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>Mi Plan - Gesti√≥n del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="src/js/services/sync-service.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- M√≥dulos refactorizados -->
    <script type="module" src="src/js/legacy-bridge.js"></script>
    <style>
        :root {
            --theme-primary: #ec4899;
            --theme-secondary: #8b5cf6;
            --theme-accent: #a855f7;
            --theme-glow-1: rgba(236, 72, 153, 0.4);
            --theme-glow-2: rgba(139, 92, 246, 0.3);
            --theme-ring: rgba(168, 85, 247, 0.4);
            --theme-bg-light: #fdf2f8;
            --theme-bg-light-2: #f3e8ff;
        }
        body.theme-male {
            --theme-primary: #3b82f6;
            --theme-secondary: #06b6d4;
            --theme-accent: #6366f1;
            --theme-glow-1: rgba(59, 130, 246, 0.4);
            --theme-glow-2: rgba(6, 182, 212, 0.3);
            --theme-ring: rgba(99, 102, 241, 0.4);
            --theme-bg-light: #eff6ff;
            --theme-bg-light-2: #e0f2fe;
        }
        * { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.5s ease; }
        .tab-active { background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); color: white; }
        .checked-item { opacity: 0.6; transform: scale(0.98); }
        .habit-checked { background: linear-gradient(135deg, var(--theme-bg-light), var(--theme-bg-light-2)); border-color: var(--theme-accent); }
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .btn-icon { transition: all 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); border-radius: 10px; }
        .glow { box-shadow: 0 0 20px var(--theme-ring); }
        .photo-glow { box-shadow: 0 0 20px var(--theme-glow-1), 0 0 40px var(--theme-glow-2); }
        .theme-gradient { background: linear-gradient(to right, var(--theme-primary), var(--theme-secondary)); }
        .theme-btn { background: linear-gradient(to right, var(--theme-primary), var(--theme-secondary)); color: white; }
        .theme-card { background: linear-gradient(to bottom right, var(--theme-primary), var(--theme-secondary)); }
        .theme-share { background: linear-gradient(to bottom right, var(--theme-primary), var(--theme-accent), #3b82f6); }
        body.theme-male .theme-share { background: linear-gradient(to bottom right, #3b82f6, #6366f1, #06b6d4); }
        .photo-border { border-color: #c084fc; }
        body.theme-male .photo-border { border-color: #93c5fd; }
        .theme-progress { background: linear-gradient(to right, var(--theme-primary), var(--theme-secondary)); }
        .theme-bar { background: linear-gradient(to top, var(--theme-primary), var(--theme-accent)); }
        .theme-bar-light { background: linear-gradient(to top, #d8b4fe, #c084fc); }
        body.theme-male .theme-bar-light { background: linear-gradient(to top, #93c5fd, #60a5fa); }
        .theme-text { color: var(--theme-secondary); }
        body.theme-male .text-purple-600 { color: #3b82f6 !important; }
        body.theme-male .text-purple-500 { color: #60a5fa !important; }
        body.theme-male .ring-purple-400 { --tw-ring-color: rgb(96 165 250) !important; }
        body.theme-male .ring-purple-200 { --tw-ring-color: rgb(191 219 254) !important; }
        body.theme-male .focus\:ring-purple-400:focus { --tw-ring-color: rgb(96 165 250) !important; }
        body.theme-male .focus\:ring-purple-500:focus { --tw-ring-color: rgb(59 130 246) !important; }
        body.theme-male .border-purple-200 { border-color: rgb(191 219 254) !important; }
        body.theme-male .bg-purple-100 { background-color: rgb(219 234 254) !important; }
        body.theme-male .bg-purple-500 { background-color: rgb(59 130 246) !important; }
        body.theme-male .hover\:bg-purple-600:hover { background-color: rgb(37 99 235) !important; }
        body.theme-male .bg-rose-100 { background-color: rgb(219 234 254) !important; }
        body.theme-male .text-rose-600 { color: #3b82f6 !important; }
        body.theme-male .hover\:bg-rose-200:hover { background-color: rgb(191 219 254) !important; }

        /* Theme Verde (Emerald) */
        body.theme-verde {
            --theme-primary: #10b981;
            --theme-secondary: #059669;
            --theme-accent: #34d399;
            --theme-glow-1: rgba(16, 185, 129, 0.4);
            --theme-glow-2: rgba(5, 150, 105, 0.3);
            --theme-ring: rgba(52, 211, 153, 0.4);
            --theme-bg-light: #ecfdf5;
            --theme-bg-light-2: #d1fae5;
        }
        body.theme-verde .photo-border { border-color: #6ee7b7; }
        body.theme-verde .theme-bar-light { background: linear-gradient(to top, #6ee7b7, #34d399); }
        body.theme-verde .text-purple-600 { color: #059669 !important; }
        body.theme-verde .text-purple-500 { color: #10b981 !important; }
        body.theme-verde .ring-purple-400 { --tw-ring-color: rgb(52 211 153) !important; }
        body.theme-verde .focus\:ring-purple-400:focus { --tw-ring-color: rgb(52 211 153) !important; }
        body.theme-verde .border-purple-200 { border-color: rgb(167 243 208) !important; }
        body.theme-verde .bg-purple-100 { background-color: rgb(209 250 229) !important; }
        body.theme-verde .bg-purple-500 { background-color: rgb(16 185 129) !important; }
        body.theme-verde .hover\:bg-purple-600:hover { background-color: rgb(5 150 105) !important; }
        body.theme-verde .bg-rose-100 { background-color: rgb(209 250 229) !important; }
        body.theme-verde .text-rose-600 { color: #059669 !important; }

        /* Theme Naranja (Orange) */
        body.theme-naranja {
            --theme-primary: #f97316;
            --theme-secondary: #eab308;
            --theme-accent: #fb923c;
            --theme-glow-1: rgba(249, 115, 22, 0.4);
            --theme-glow-2: rgba(234, 179, 8, 0.3);
            --theme-ring: rgba(251, 146, 60, 0.4);
            --theme-bg-light: #fff7ed;
            --theme-bg-light-2: #fef3c7;
        }
        body.theme-naranja .photo-border { border-color: #fdba74; }
        body.theme-naranja .theme-bar-light { background: linear-gradient(to top, #fcd34d, #fbbf24); }
        body.theme-naranja .text-purple-600 { color: #ea580c !important; }
        body.theme-naranja .text-purple-500 { color: #f97316 !important; }
        body.theme-naranja .ring-purple-400 { --tw-ring-color: rgb(251 146 60) !important; }
        body.theme-naranja .focus\:ring-purple-400:focus { --tw-ring-color: rgb(251 146 60) !important; }
        body.theme-naranja .border-purple-200 { border-color: rgb(254 215 170) !important; }
        body.theme-naranja .bg-purple-100 { background-color: rgb(255 237 213) !important; }
        body.theme-naranja .bg-purple-500 { background-color: rgb(249 115 22) !important; }
        body.theme-naranja .hover\:bg-purple-600:hover { background-color: rgb(234 88 12) !important; }
        body.theme-naranja .bg-rose-100 { background-color: rgb(255 237 213) !important; }
        body.theme-naranja .text-rose-600 { color: #ea580c !important; }

        /* Theme Coral (Rose/Red) */
        body.theme-coral {
            --theme-primary: #f43f5e;
            --theme-secondary: #e11d48;
            --theme-accent: #fb7185;
            --theme-glow-1: rgba(244, 63, 94, 0.4);
            --theme-glow-2: rgba(225, 29, 72, 0.3);
            --theme-ring: rgba(251, 113, 133, 0.4);
            --theme-bg-light: #fff1f2;
            --theme-bg-light-2: #ffe4e6;
        }
        body.theme-coral .photo-border { border-color: #fda4af; }
        body.theme-coral .theme-bar-light { background: linear-gradient(to top, #fda4af, #fb7185); }
        body.theme-coral .text-purple-600 { color: #e11d48 !important; }
        body.theme-coral .text-purple-500 { color: #f43f5e !important; }
        body.theme-coral .ring-purple-400 { --tw-ring-color: rgb(251 113 133) !important; }
        body.theme-coral .focus\:ring-purple-400:focus { --tw-ring-color: rgb(251 113 133) !important; }
        body.theme-coral .border-purple-200 { border-color: rgb(254 205 211) !important; }
        body.theme-coral .bg-purple-100 { background-color: rgb(255 228 230) !important; }
        body.theme-coral .bg-purple-500 { background-color: rgb(244 63 94) !important; }
        body.theme-coral .hover\:bg-purple-600:hover { background-color: rgb(225 29 72) !important; }
        body.theme-coral .bg-rose-100 { background-color: rgb(255 228 230) !important; }
        body.theme-coral .text-rose-600 { color: #e11d48 !important; }

        /* Theme Morado (Violet/Indigo) */
        body.theme-morado {
            --theme-primary: #8b5cf6;
            --theme-secondary: #6366f1;
            --theme-accent: #a78bfa;
            --theme-glow-1: rgba(139, 92, 246, 0.4);
            --theme-glow-2: rgba(99, 102, 241, 0.3);
            --theme-ring: rgba(167, 139, 250, 0.4);
            --theme-bg-light: #f5f3ff;
            --theme-bg-light-2: #ede9fe;
        }
        body.theme-morado .photo-border { border-color: #c4b5fd; }
        body.theme-morado .theme-bar-light { background: linear-gradient(to top, #c4b5fd, #a78bfa); }
        body.theme-morado .text-purple-600 { color: #7c3aed !important; }
        body.theme-morado .text-purple-500 { color: #8b5cf6 !important; }
        body.theme-morado .ring-purple-400 { --tw-ring-color: rgb(167 139 250) !important; }
        body.theme-morado .focus\:ring-purple-400:focus { --tw-ring-color: rgb(167 139 250) !important; }
        body.theme-morado .border-purple-200 { border-color: rgb(221 214 254) !important; }
        body.theme-morado .bg-purple-100 { background-color: rgb(237 233 254) !important; }
        body.theme-morado .bg-purple-500 { background-color: rgb(139 92 246) !important; }
        body.theme-morado .hover\:bg-purple-600:hover { background-color: rgb(124 58 237) !important; }
        body.theme-morado .bg-rose-100 { background-color: rgb(237 233 254) !important; }
        body.theme-morado .text-rose-600 { color: #7c3aed !important; }

        @keyframes celebrationFall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* Dark Mode Styles */
        .dark { background: linear-gradient(135deg, #1a1a2e, #16213e, #1a1a2e) !important; }
        .dark .bg-white { background: #1e293b !important; }
        .dark .bg-white\/90 { background: rgba(30, 41, 59, 0.95) !important; }
        .dark .bg-white\/80 { background: rgba(30, 41, 59, 0.9) !important; }
        .dark .bg-white\/60 { background: rgba(30, 41, 59, 0.8) !important; }
        .dark .bg-white\/40 { background: rgba(30, 41, 59, 0.6) !important; }
        .dark .bg-white\/50 { background: rgba(30, 41, 59, 0.7) !important; }
        .dark .text-gray-800 { color: #f1f5f9 !important; }
        .dark .text-gray-700 { color: #e2e8f0 !important; }
        .dark .text-gray-600 { color: #cbd5e1 !important; }
        .dark .text-gray-500 { color: #94a3b8 !important; }
        .dark .text-gray-400 { color: #64748b !important; }
        .dark .border-gray-200 { border-color: #334155 !important; }
        .dark .border-gray-100 { border-color: #1e293b !important; }
        .dark .border-b { border-color: #334155 !important; }
        .dark .hover\:bg-gray-50:hover { background: #334155 !important; }
        .dark .hover\:bg-gray-100:hover { background: #334155 !important; }
        .dark .hover\:bg-white:hover { background: #334155 !important; }
        .dark .bg-gray-50 { background: #1e293b !important; }
        .dark .bg-gray-100 { background: #334155 !important; }
        .dark input, .dark select, .dark textarea { background: #1e293b !important; color: #f1f5f9 !important; border-color: #334155 !important; }
        .dark .modal-backdrop { background: rgba(0,0,0,0.7); }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark .habit-checked { background: linear-gradient(135deg, #2d1f3d, #1e293b) !important; }
        .dark .from-rose-50, .dark .via-purple-50, .dark .to-blue-50 { --tw-gradient-stops: #1a1a2e, #16213e, #1a1a2e !important; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Prevent scroll chaining and improve scroll stability */
        html, body {
            overscroll-behavior: none;
            scroll-behavior: auto;
        }

        /* Prevent nested scroll containers from affecting main scroll */
        .overflow-y-auto, .overflow-x-auto {
            overscroll-behavior: contain;
        }

        /* ====== MODOS DE VISTA ====== */

        /* Vista Minimalista - Oculta elementos, mismas fuentes */

        /* Ocultar dashboard de progreso completo */
        body.view-minimal .progress-dashboard { display: none !important; }

        /* Ocultar footer motivacional */
        body.view-minimal footer { display: none !important; }

        /* Ocultar botones flotantes */
        body.view-minimal #pomodoroFloat { display: none !important; }
        body.view-minimal #expensesFloat { display: none !important; }

        /* Ocultar botones secundarios (limpiar, restaurar, buscar) */
        body.view-minimal .action-buttons-grid { display: none !important; }

        /* Ocultar elementos del header */
        body.view-minimal .header-subtext { display: none !important; }
        body.view-minimal .header-badges { display: none !important; }
        body.view-minimal .header-photo-edit { display: none !important; }

        /* Ocultar hero card de agenda */
        body.view-minimal .agenda-hero { display: none !important; }

        /* Ocultar elementos decorativos */
        body.view-minimal .glow { box-shadow: none !important; }
        body.view-minimal .photo-glow { box-shadow: none !important; }
        body.view-minimal .card-hover:hover { transform: none !important; }
        body.view-minimal .animate-pulse { animation: none !important; }

        /* Ocultar extras */
        body.view-minimal .extra-stats { display: none !important; }
        body.view-minimal .decorative-elements { display: none !important; }

        /* Vista Media - Equilibrada (por defecto) */
        body.view-medium .card-hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        body.view-medium .habit-item { padding: 1rem 1.25rem; }
        body.view-medium .schedule-item { padding: 1rem 1.25rem; }

        /* Vista Maximalista - Rica en detalles, informaci√≥n densa */
        body.view-maximal .card-hover { box-shadow: 0 8px 32px rgba(0,0,0,0.12); border: 1px solid rgba(0,0,0,0.05); }
        body.view-maximal .card-hover:hover { box-shadow: 0 12px 48px rgba(0,0,0,0.15); transform: translateY(-4px); }
        body.view-maximal .habit-item { padding: 1.25rem 1.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); }
        body.view-maximal .schedule-item { padding: 1.25rem 1.5rem; border-left: 4px solid var(--theme-primary); }
        body.view-maximal .progress-ring { transform: scale(1.1); }
        body.view-maximal .streak-section { padding: 1rem; }
        body.view-maximal .category-badge { font-size: 0.75rem; padding: 0.375rem 0.75rem; font-weight: 600; }
        body.view-maximal .duration-badge { font-size: 0.8rem; padding: 0.375rem 0.75rem; font-weight: 500; }
        body.view-maximal .emoji-indicator { font-size: 2rem; }
        body.view-maximal .section-header { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.025em; }
        body.view-maximal .tab-label { font-size: 0.875rem; font-weight: 600; }
        body.view-maximal .floating-buttons { transform: scale(1.1); }
        body.view-maximal .goal-card { padding: 1.5rem; border-radius: 1.25rem; }
        body.view-maximal .goal-card .text-2xl { font-size: 2rem; }
        body.view-maximal .glow { box-shadow: 0 0 30px var(--theme-ring), 0 0 60px var(--theme-glow-2); }
        body.view-maximal .photo-glow { box-shadow: 0 0 30px var(--theme-glow-1), 0 0 60px var(--theme-glow-2), 0 0 90px var(--theme-ring); }
        body.view-maximal header { padding-top: 1.25rem; padding-bottom: 1.25rem; }
        body.view-maximal .header-greeting { font-size: 1.75rem; font-weight: 700; }
        body.view-maximal .header-subtext { font-size: 0.95rem; opacity: 0.9; }
        body.view-maximal .extra-stats { display: flex !important; }
        body.view-maximal .motivational-text { display: block !important; font-style: italic; opacity: 0.8; }
        body.view-maximal .progress-bar { height: 10px; border-radius: 5px; }
        body.view-maximal .habit-checked { border-width: 2px; }

        /* Transiciones suaves entre vistas */
        .view-transition * {
            transition: all 0.3s ease !important;
        }

        /* Lucide icons stability */
        .lucide-processed {
            display: inline-flex;
            align-items: center;
        }
        [data-lucide] {
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }
        /* Prevent layout shift during icon replacement */
        #app {
            transition: opacity 0.1s ease-out;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-purple-50 to-blue-50">
    <div id="app"></div>

    <!-- Modal para Editar Actividad -->
    <div id="editModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Actividad</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="editTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 08:30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Actividad</label>
                    <input type="text" id="editActivity" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Descripci√≥n de la actividad">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Duraci√≥n</label>
                    <input type="text" id="editDuration" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1 hr">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categor√≠a</label>
                    <select id="editCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none bg-white"></select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveEdit()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmar Borrado -->
    <div id="deleteModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <div class="text-center">
                <span class="text-5xl">üóëÔ∏è</span>
                <h3 class="text-xl font-bold text-gray-800 mt-3">¬øEliminar elemento?</h3>
                <p class="text-gray-500 mt-2" id="deleteActivityName">Esta acci√≥n no se puede deshacer</p>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition font-medium">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nueva Actividad -->
    <div id="addModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Actividad</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="addTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 08:30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Actividad</label>
                    <input type="text" id="addActivity" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Descripci√≥n de la actividad">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Duraci√≥n</label>
                    <input type="text" id="addDuration" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1 hr">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categor√≠a</label>
                    <select id="addCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none bg-white"></select>
                </div>

                <!-- Opci√≥n de repetir -->
                <div class="border-t pt-4">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="addRepeat" onchange="toggleRepeatOptions()" class="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">üîÑ Repetir en varios d√≠as</span>
                    </label>
                </div>

                <!-- Opciones de fecha (ocultas por defecto) -->
                <div id="repeatOptions" class="hidden space-y-3 bg-purple-50 p-3 rounded-xl">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">üìÖ Fecha inicio</label>
                        <input type="date" id="addStartDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">üìÖ Fecha fin</label>
                        <input type="date" id="addEndDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                    </div>
                    <p class="text-xs text-purple-600">La actividad se agregar√° a todos los d√≠as en este rango</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewActivity()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar H√°bito -->
    <div id="editHabitModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar H√°bito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="editHabitIcon" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: ‚òÄÔ∏è">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del h√°bito</label>
                    <input type="text" id="editHabitName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Despertar 7:00 AM">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditHabitModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveHabitEdit()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar H√°bito -->
    <div id="addHabitModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nuevo H√°bito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="addHabitIcon" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: ‚òÄÔ∏è">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del h√°bito</label>
                    <input type="text" id="addHabitName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Despertar 7:00 AM">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddHabitModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewHabit()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Ejercicio Gym -->
    <div id="editGymModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Ejercicio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Ejercicio</label>
                    <input type="text" id="editGymExercise" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Hip Thrust con barra 4x12">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditGymModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveGymEdit()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Ejercicio Gym -->
    <div id="addGymModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nuevo Ejercicio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Ejercicio</label>
                    <input type="text" id="addGymExercise" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Hip Thrust con barra 4x12">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddGymModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewGymExercise()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Peso/Medidas -->
    <div id="weightModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeWeightModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚öñÔ∏è Registrar Peso</h3>
                <button onclick="closeWeightModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Fecha</label>
                    <input type="date" id="weightDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Peso (kg)</label>
                    <input type="number" step="0.1" id="weightValue" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 62.5">
                </div>
                <div class="border-t pt-4 mt-4">
                    <p class="text-sm font-medium text-gray-600 mb-3">Medidas opcionales (cm)</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Cintura</label>
                            <input type="number" step="0.1" id="measureWaist" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Cadera</label>
                            <input type="number" step="0.1" id="measureHip" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Pierna</label>
                            <input type="number" step="0.1" id="measureThigh" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Brazo</label>
                            <input type="number" step="0.1" id="measureArm" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">% Grasa corporal (opcional)</label>
                    <input type="number" step="0.1" id="bodyFat" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 22.5">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeWeightModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveWeightEntry()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Configurar Perfil F√≠sico -->
    <div id="profileModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeProfileModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚öñÔ∏è Datos F√≠sicos</h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Peso actual (kg)</label>
                        <input type="number" step="0.1" id="profileCurrentWeight" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-center font-bold" placeholder="ej: 70">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Peso objetivo (kg)</label>
                        <input type="number" step="0.1" id="profileGoalWeight" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-center" placeholder="ej: 58">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Estatura (cm)</label>
                    <input type="number" id="profileHeight" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 165">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">D√≠a de check-in semanal</label>
                    <select id="profileCheckinDay" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none bg-white">
                        <option value="1">Lunes</option>
                        <option value="2">Martes</option>
                        <option value="3">Mi√©rcoles</option>
                        <option value="4">Jueves</option>
                        <option value="5">Viernes</option>
                        <option value="6">S√°bado</option>
                        <option value="0">Domingo</option>
                    </select>
                </div>
                <p class="text-xs text-gray-400">El peso actual se guardar√° en tu historial de check-ins</p>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeProfileModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="savePhysicalProfile()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Ejercicio a Rutina -->
    <div id="addWorkoutExerciseModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeAddWorkoutExerciseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üèãÔ∏è Agregar Ejercicio</h3>
                <button onclick="closeAddWorkoutExerciseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="exerciseSearch" oninput="filterExerciseLibrary()" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="üîç Buscar ejercicio...">
            </div>

            <!-- Filter buttons -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button onclick="filterByMuscle('all')" class="muscle-filter-btn px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium" data-muscle="all">Todos</button>
                <button onclick="filterByMuscle('gluteos')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="gluteos">Gl√∫teos</button>
                <button onclick="filterByMuscle('piernas')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="piernas">Piernas</button>
                <button onclick="filterByMuscle('espalda')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="espalda">Espalda</button>
                <button onclick="filterByMuscle('pecho')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="pecho">Pecho</button>
                <button onclick="filterByMuscle('brazos')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="brazos">Brazos</button>
                <button onclick="filterByMuscle('core')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="core">Core</button>
            </div>

            <!-- Exercise list -->
            <div id="exerciseLibraryList" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Populated by JS -->
            </div>

            <!-- Custom exercise -->
            <div class="border-t mt-4 pt-4">
                <p class="text-sm text-gray-500 mb-2">¬øNo encuentras tu ejercicio?</p>
                <div class="flex gap-2">
                    <input type="text" id="customExerciseName" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Nombre del ejercicio">
                    <button onclick="addCustomExercise()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200 transition">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Serie -->
    <div id="logSetModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeLogSetModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800" id="logSetTitle">Serie 1</h3>
                <button onclick="closeLogSetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Peso (kg)</label>
                        <input type="number" step="0.5" id="setWeight" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-center text-xl font-bold" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Reps</label>
                        <input type="number" id="setReps" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-center text-xl font-bold" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">RPE (1-10) <span class="text-gray-400 text-xs">opcional</span></label>
                    <div class="flex gap-1">
                        <button type="button" onclick="selectRPE(1)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="1">1</button>
                        <button type="button" onclick="selectRPE(2)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="2">2</button>
                        <button type="button" onclick="selectRPE(3)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="3">3</button>
                        <button type="button" onclick="selectRPE(4)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="4">4</button>
                        <button type="button" onclick="selectRPE(5)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="5">5</button>
                        <button type="button" onclick="selectRPE(6)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="6">6</button>
                        <button type="button" onclick="selectRPE(7)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="7">7</button>
                        <button type="button" onclick="selectRPE(8)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="8">8</button>
                        <button type="button" onclick="selectRPE(9)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="9">9</button>
                        <button type="button" onclick="selectRPE(10)" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="10">10</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Notas <span class="text-gray-400 text-xs">opcional</span></label>
                    <input type="text" id="setNotes" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-sm" placeholder="ej: t√©cnica, dolor, ajustes...">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeLogSetModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveSetLog()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">‚úì Completar</button>
            </div>
        </div>
    </div>

    <!-- Floating Rest Timer -->
    <div id="restTimerFloat" class="fixed bottom-24 right-6 z-50 hidden">
        <div class="theme-gradient rounded-2xl shadow-2xl p-4 text-white min-w-[200px]">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium opacity-90">‚è±Ô∏è Descanso</span>
                <button onclick="closeRestTimer()" class="text-white/70 hover:text-white">√ó</button>
            </div>
            <div class="text-center">
                <span id="restTimerDisplay" class="text-4xl font-bold">1:30</span>
            </div>
            <div class="flex gap-2 mt-3">
                <button onclick="adjustRestTimer(-15)" class="flex-1 py-1 bg-white/20 rounded-lg text-sm hover:bg-white/30 transition">-15s</button>
                <button onclick="toggleRestTimer()" id="restTimerToggle" class="flex-1 py-1 bg-white/30 rounded-lg text-sm font-medium hover:bg-white/40 transition">‚è∏Ô∏è</button>
                <button onclick="adjustRestTimer(15)" class="flex-1 py-1 bg-white/20 rounded-lg text-sm hover:bg-white/30 transition">+15s</button>
            </div>
            <div class="flex gap-1 mt-2">
                <button onclick="setRestTimer(30)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">30s</button>
                <button onclick="setRestTimer(60)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">60s</button>
                <button onclick="setRestTimer(90)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">90s</button>
                <button onclick="setRestTimer(120)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">2m</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Comida -->
    <div id="editMealModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Comida</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="editMealTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 07:45">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="editMealName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Desayuno">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="editMealEmoji" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: üåÖ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Opciones (una por l√≠nea)</label>
                    <textarea id="editMealOptions" rows="4" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Opci√≥n 1&#10;Opci√≥n 2&#10;Opci√≥n 3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Macros</label>
                    <input type="text" id="editMealMacros" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: P:30g | C:45g | G:15g">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditMealModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveMealEdit()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Comida -->
    <div id="addMealModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Comida</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="addMealTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 07:45">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="addMealName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Desayuno">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="addMealEmoji" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: üåÖ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Opciones (una por l√≠nea)</label>
                    <textarea id="addMealOptions" rows="4" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Opci√≥n 1&#10;Opci√≥n 2&#10;Opci√≥n 3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Macros</label>
                    <input type="text" id="addMealMacros" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: P:30g | C:45g | G:15g">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddMealModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewMeal()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Prote√≠na -->
    <div id="addProteinModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ü•© Registrar Prote√≠na</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Alimento / Fuente</label>
                    <input type="text" id="proteinSource" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-400 focus:border-transparent outline-none" placeholder="ej: Pechuga de pollo">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Gramos de prote√≠na</label>
                    <input type="number" id="proteinGrams" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-400 focus:border-transparent outline-none" placeholder="ej: 30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nota (opcional)</label>
                    <input type="text" id="proteinNote" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-400 focus:border-transparent outline-none" placeholder="ej: Almuerzo">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddProteinModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewProtein()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Favorito de Prote√≠na -->
    <div id="addFavoriteModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚≠ê Nuevo Alimento Favorito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del alimento</label>
                    <input type="text" id="favoriteName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Pechuga de pollo (100g)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Gramos de prote√≠na</label>
                    <input type="number" id="favoriteGrams" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 31">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddFavoriteModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewFavorite()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle de Prote√≠na del D√≠a -->
    <div id="proteinDetailModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeProteinDetailModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">ü•© Detalle de Prote√≠na</h3>
                <button onclick="closeProteinDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Summary -->
            <div id="proteinDetailSummary" class="bg-gradient-to-br from-green-500 to-teal-600 rounded-xl p-4 text-white mb-4">
                <!-- Populated dynamically -->
            </div>

            <!-- Items List -->
            <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">üìã Lo que sumaste hoy:</h4>
                <div id="proteinDetailList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Empty State -->
            <div id="proteinDetailEmpty" class="hidden text-center py-8">
                <span class="text-5xl block mb-3">üçΩÔ∏è</span>
                <p class="text-gray-500">No has registrado prote√≠na hoy</p>
                <button onclick="closeProteinDetailModal(); openAddProteinModal();" class="mt-3 px-4 py-2 bg-green-500 text-white rounded-xl text-sm font-medium">
                    + Agregar ahora
                </button>
            </div>

            <div class="flex gap-3 mt-4">
                <button onclick="closeProteinDetailModal(); openAddProteinModal();" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl font-medium hover:opacity-90 transition">
                    ‚ûï Agregar m√°s
                </button>
                <button onclick="closeProteinDetailModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Meta Semanal -->
    <div id="editGoalModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Meta Semanal</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Semana</label>
                    <input type="number" id="editGoalWeek" min="1" max="12" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Fechas</label>
                    <input type="text" id="editGoalDates" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 2-8 Feb">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üí™ Meta F√≠sica</label>
                    <input type="text" id="editGoalFisica" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üìö Meta Personal</label>
                    <input type="text" id="editGoalPersonal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üì± Meta Digital</label>
                    <input type="text" id="editGoalDigital" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üßò Meta Espiritual</label>
                    <input type="text" id="editGoalEspiritual" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditGoalModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveGoalEdit()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Meta -->
    <div id="addGoalModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Meta Semanal</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Semana</label>
                        <input type="number" id="addGoalWeek" min="1" max="52" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Fechas</label>
                        <input type="text" id="addGoalDates" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 2-8 Mar">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üí™ Meta F√≠sica</label>
                    <input type="text" id="addGoalFisica" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Tu meta de salud/fitness">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üìö Meta Personal</label>
                    <input type="text" id="addGoalPersonal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Tu meta de desarrollo personal">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üì± Meta Digital/Profesional</label>
                    <input type="text" id="addGoalDigital" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Tu meta de trabajo/proyectos">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üßò Meta Espiritual</label>
                    <input type="text" id="addGoalEspiritual" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Tu meta de bienestar mental">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddGoalModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewGoal()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Crear Meta</button>
            </div>
        </div>
    </div>

    <!-- Modal para Reemplazar Todos -->
    <div id="replaceAllModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">üîÑ ¬øAplicar a todos?</h3>
            <p id="replaceAllMessage" class="text-gray-600 text-center mb-6">¬øQuieres aplicar este cambio a todos los d√≠as?</p>

            <div class="space-y-3">
                <button onclick="confirmReplaceAll(true)" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    ‚úÖ S√≠, aplicar a todos
                </button>
                <button onclick="confirmReplaceAll(false)" class="w-full py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition">
                    üìÖ Solo este d√≠a
                </button>
                <button onclick="closeReplaceAllModal()" class="w-full py-2 text-gray-400 hover:text-gray-600 transition text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Perfil Completo -->
    <div id="photoModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closePhotoModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üë§ Mi Perfil</h3>
                <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Vista normal (sin edici√≥n de foto) -->
            <div id="photoNormalView">
                <!-- Foto de perfil -->
                <div class="flex justify-center mb-4">
                    <div class="relative">
                        <div id="photoPreview" class="w-24 h-24 rounded-full theme-gradient flex items-center justify-center text-white text-3xl font-bold border-4 photo-border overflow-hidden">
                            <!-- Se llena din√°micamente -->
                        </div>
                        <label class="absolute bottom-0 right-0 w-8 h-8 theme-btn rounded-full flex items-center justify-center cursor-pointer hover:opacity-90 transition shadow-lg">
                            <span class="text-white text-sm">üì∑</span>
                            <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                        </label>
                    </div>
                </div>

                <!-- Campos del perfil -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Nombre completo</label>
                        <input type="text" id="profileName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Tu nombre">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Correo electr√≥nico</label>
                        <input type="email" id="profileEmail" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="tu@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Tel√©fono</label>
                        <input type="tel" id="profilePhone" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="+56 9 1234 5678">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Fecha de nacimiento</label>
                        <input type="date" id="profileBirthdate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">G√©nero</label>
                        <select id="profileGender" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                            <option value="">Seleccionar...</option>
                            <option value="female">Femenino</option>
                            <option value="male">Masculino</option>
                            <option value="other">Otro</option>
                            <option value="prefer_not">Prefiero no decir</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Bio / Motivaci√≥n</label>
                        <textarea id="profileBio" rows="2" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none resize-none" placeholder="¬øCu√°l es tu motivaci√≥n?"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">üåê Idioma / Language</label>
                        <select id="profileLanguage" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                            <option value="es">üá™üá∏ Espa√±ol</option>
                            <option value="en">üá∫üá∏ English</option>
                        </select>
                    </div>
                </div>

                <!-- Opciones de foto -->
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <p class="text-sm text-gray-500 mb-2">Foto de perfil</p>
                    <div class="flex gap-2">
                        <label class="flex-1 flex items-center justify-center gap-2 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm cursor-pointer hover:bg-gray-200 transition">
                            <span>üìÅ Subir</span>
                            <input type="file" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                        </label>
                        <label class="flex-1 flex items-center justify-center gap-2 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm cursor-pointer hover:bg-gray-200 transition">
                            <span>üì∑ C√°mara</span>
                            <input type="file" id="cameraInput" accept="image/*" capture="user" class="hidden" onchange="handlePhotoUpload(event)">
                        </label>
                        <button onclick="removePhoto()" id="removePhotoBtn" class="px-3 py-2 text-red-500 rounded-lg text-sm hover:bg-red-50 transition hidden">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex gap-3 mt-6">
                    <button onclick="closePhotoModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button onclick="saveFullProfile()" class="flex-1 px-4 py-3 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                        üíæ Guardar
                    </button>
                </div>
            </div>

            <!-- Vista de edici√≥n de foto (ajustar posici√≥n) -->
            <div id="photoEditView" class="hidden">
                <p class="text-sm text-gray-500 text-center mb-3">üëÜ Arrastra para ajustar la posici√≥n</p>

                <!-- √Årea de recorte -->
                <div class="flex justify-center mb-4">
                    <div id="cropperContainer" class="w-48 h-48 rounded-full border-4 border-purple-400 overflow-hidden relative cursor-move bg-gray-100"
                        onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                        <img id="cropperImage" class="absolute" style="max-width: none;" draggable="false">
                    </div>
                </div>

                <!-- Zoom slider -->
                <div class="mb-4">
                    <label class="text-sm text-gray-600 flex items-center justify-between mb-1">
                        <span>üîç Zoom</span>
                        <span id="zoomValue">100%</span>
                    </label>
                    <input type="range" id="zoomSlider" min="100" max="300" value="100"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        oninput="updateZoom(this.value)">
                </div>

                <!-- Botones de edici√≥n -->
                <div class="flex gap-3">
                    <button onclick="cancelCrop()" class="flex-1 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button onclick="saveCrop()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                        ‚úì Aplicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Felicitaciones -->
    <div id="congratsModal" class="fixed inset-0 modal-backdrop z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all text-center">
            <div id="congratsEmoji" class="text-7xl mb-4"></div>
            <h3 id="congratsTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p id="congratsMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closeCongratsModal()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                ¬°Gracias! üôå
            </button>
        </div>
    </div>

    <!-- Modal Calendario -->
    <div id="calendarModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeCalendarModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-4 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition">‚óÄÔ∏è</button>
                <h3 id="calendarTitle" class="text-lg font-bold text-gray-800"></h3>
                <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition">‚ñ∂Ô∏è</button>
            </div>

            <!-- D√≠as de la semana -->
            <div class="grid grid-cols-7 gap-1 mb-2">
                <div class="text-center text-xs font-medium text-gray-500 py-1">Dom</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Lun</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Mar</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Mi√©</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Jue</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Vie</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">S√°b</div>
            </div>

            <!-- D√≠as del mes -->
            <div id="calendarDays" class="grid grid-cols-7 gap-1">
                <!-- Se genera din√°micamente -->
            </div>

            <button onclick="goToToday()" class="w-full mt-4 py-2 text-purple-600 font-medium hover:bg-purple-50 rounded-xl transition">
                üìç Ir a hoy
            </button>
        </div>
    </div>

    <!-- Modal Pomodoro -->
    <div id="pomodoroModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closePomodoroModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="text-center">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <h3 class="text-xl font-bold text-gray-800">üçÖ Pomodoro Timer</h3>
                    <button onclick="togglePomodoroInfo()" class="w-6 h-6 bg-gray-100 hover:bg-purple-100 text-gray-500 hover:text-purple-600 rounded-full flex items-center justify-center text-sm font-bold transition" title="¬øQu√© es Pomodoro?">
                        i
                    </button>
                </div>
                <p class="text-gray-500 text-sm mb-4">Enf√≥cate en tus tareas</p>

                <!-- Info Panel -->
                <div id="pomodoroInfoPanel" class="hidden mb-4 p-4 bg-gradient-to-br from-rose-50 to-purple-50 rounded-xl text-left border border-purple-100">
                    <h4 class="font-bold text-purple-800 mb-2 text-sm">üçÖ ¬øQu√© es la T√©cnica Pomodoro?</h4>
                    <p class="text-gray-600 text-xs mb-3">Es un m√©todo de gesti√≥n del tiempo que mejora tu concentraci√≥n y productividad.</p>
                    <div class="space-y-2 text-xs text-gray-700">
                        <div class="flex gap-2">
                            <span class="text-purple-500 font-bold">1.</span>
                            <span>Elige una tarea a realizar</span>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-purple-500 font-bold">2.</span>
                            <span>Trabaja 25 minutos sin distracciones</span>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-purple-500 font-bold">3.</span>
                            <span>Toma un descanso corto (5 min)</span>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-purple-500 font-bold">4.</span>
                            <span>Cada 4 pomodoros, descansa 15-30 min</span>
                        </div>
                    </div>
                    <p class="text-purple-600 text-xs mt-3 font-medium">üí° El nombre viene de un temporizador de cocina con forma de tomate (pomodoro en italiano)</p>
                </div>

                <!-- Timer Display -->
                <div id="pomodoroDisplay" class="text-6xl font-mono font-bold gradient-text my-6">
                    25:00
                </div>

                <!-- Status -->
                <div id="pomodoroStatus" class="text-sm text-gray-500 mb-4">
                    ‚è±Ô∏è Listo para comenzar
                </div>

                <!-- Preset buttons -->
                <div class="flex justify-center gap-2 mb-6">
                    <button onclick="setPomodoroTime(25)" class="px-3 py-1 bg-rose-100 text-rose-600 rounded-full text-sm font-medium hover:bg-rose-200 transition">
                        üçÖ 25 min
                    </button>
                    <button onclick="setPomodoroTime(5)" class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-sm font-medium hover:bg-green-200 transition">
                        ‚òï 5 min
                    </button>
                    <button onclick="setPomodoroTime(15)" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-sm font-medium hover:bg-blue-200 transition">
                        üßò 15 min
                    </button>
                </div>

                <!-- Controls -->
                <div class="flex gap-3">
                    <button id="pomodoroStartBtn" onclick="togglePomodoro()" class="flex-1 px-4 py-3 theme-btn rounded-xl hover:opacity-90 transition font-medium">
                        ‚ñ∂Ô∏è Iniciar
                    </button>
                    <button onclick="resetPomodoro()" class="px-4 py-3 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition font-medium">
                        üîÑ
                    </button>
                </div>

                <!-- Stats -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-sm text-gray-500">
                        üèÜ Pomodoros hoy: <span id="pomodoroCount" class="font-bold text-purple-600">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones flotantes -->
    <button id="pomodoroFloatBtn" onclick="openPomodoroModal()" class="fixed bottom-6 right-6 w-14 h-14 theme-btn rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110 z-40 flex items-center justify-center text-2xl" title="Pomodoro Timer">
        üçÖ
    </button>
    <button id="expensesFloatBtn" onclick="openScanReceiptModal()" class="fixed bottom-6 right-24 w-14 h-14 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110 z-40 flex items-center justify-center text-2xl hidden" title="Registrar Gasto">
        üí∞
    </button>

    <!-- Modal Exportar -->
    <div id="exportModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeExportModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-2">üì• Exportar Datos</h3>
            <p class="text-gray-500 text-sm mb-6">Descarga tu progreso y actividades</p>

            <div class="space-y-3">
                <button onclick="exportToCSV()" class="w-full flex items-center gap-4 p-4 border-2 border-gray-100 rounded-xl hover:border-green-300 hover:bg-green-50 transition">
                    <span class="text-3xl">üìä</span>
                    <div class="text-left">
                        <p class="font-medium text-gray-800">Exportar a CSV</p>
                        <p class="text-sm text-gray-500">Compatible con Excel y Google Sheets</p>
                    </div>
                </button>

                <button onclick="exportToPrint()" class="w-full flex items-center gap-4 p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 hover:bg-blue-50 transition">
                    <span class="text-3xl">üñ®Ô∏è</span>
                    <div class="text-left">
                        <p class="font-medium text-gray-800">Imprimir / PDF</p>
                        <p class="text-sm text-gray-500">Vista de impresi√≥n optimizada</p>
                    </div>
                </button>

                <button onclick="exportWeekSummary()" class="w-full flex items-center gap-4 p-4 border-2 border-gray-100 rounded-xl hover:border-purple-300 hover:bg-purple-50 transition">
                    <span class="text-3xl">üìã</span>
                    <div class="text-left">
                        <p class="font-medium text-gray-800">Resumen Semanal</p>
                        <p class="text-sm text-gray-500">Descarga el resumen de la semana actual</p>
                    </div>
                </button>
            </div>

            <button onclick="closeExportModal()" class="w-full mt-6 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Escanear Boleta -->
    <div id="scanReceiptModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeScanReceiptModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üì∏ Escanear Boleta</h3>
                <button onclick="closeScanReceiptModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Step 1: Capture/Upload -->
            <div id="scanStep1">
                <p class="text-gray-500 text-sm mb-4">Toma una foto o sube una imagen de tu boleta</p>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="startCamera()" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-center">
                        <span class="text-4xl block mb-2">üì∑</span>
                        <p class="text-sm font-medium text-gray-700">Usar C√°mara</p>
                    </button>
                    <label class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-center cursor-pointer">
                        <span class="text-4xl block mb-2">üñºÔ∏è</span>
                        <p class="text-sm font-medium text-gray-700">Subir Imagen</p>
                        <input type="file" accept="image/*" onchange="handleReceiptUpload(event)" class="hidden">
                    </label>
                </div>

                <!-- Camera Preview -->
                <div id="cameraContainer" class="hidden mb-4">
                    <video id="cameraPreview" class="w-full rounded-xl bg-black" autoplay playsinline></video>
                    <div class="flex gap-3 mt-3">
                        <button onclick="capturePhoto()" class="flex-1 py-3 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                            üì∏ Capturar
                        </button>
                        <button onclick="stopCamera()" class="px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                            Cancelar
                        </button>
                    </div>
                </div>

                <!-- Image Preview -->
                <div id="imagePreviewContainer" class="hidden mb-4">
                    <img id="receiptImagePreview" class="w-full rounded-xl max-h-64 object-contain bg-gray-100">
                    <div class="flex gap-3 mt-3">
                        <button onclick="processReceiptImage()" class="flex-1 py-3 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                            üîç Analizar Boleta
                        </button>
                        <button onclick="clearReceiptImage()" class="px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Processing -->
            <div id="scanStep2" class="hidden text-center py-8">
                <div class="animate-spin text-5xl mb-4">‚è≥</div>
                <p class="text-gray-600 font-medium">Analizando boleta...</p>
                <p class="text-gray-400 text-sm mt-2" id="ocrProgress">Iniciando OCR...</p>
            </div>

            <!-- Step 3: Results Form -->
            <div id="scanStep3" class="hidden">
                <p class="text-green-600 text-sm mb-4 flex items-center gap-2">
                    <span>‚úÖ</span> Datos extra√≠dos - verifica y corrige si es necesario
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tienda / Comercio</label>
                        <input type="text" id="expenseStore" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Nombre del comercio">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                            <input type="date" id="expenseDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                            <input type="number" step="0.01" id="expenseTotal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                        <select id="expenseCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none bg-white"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n (opcional)</label>
                        <input type="text" id="expenseDescription" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Detalles adicionales">
                    </div>

                    <!-- Extracted items -->
                    <div id="extractedItemsContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Items detectados</label>
                        <div id="extractedItems" class="bg-gray-50 rounded-xl p-3 max-h-32 overflow-y-auto text-sm text-gray-600"></div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="resetScanModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                        Escanear otra
                    </button>
                    <button onclick="saveExpenseFromScan()" class="flex-1 px-4 py-3 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                        üíæ Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Gasto Manual -->
    <div id="addExpenseModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeAddExpenseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Agregar Gasto</h3>
                <button onclick="closeAddExpenseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tienda / Comercio</label>
                    <input type="text" id="manualExpenseStore" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Nombre del comercio">
                </div>
                <div class="flex gap-3">
                    <div class="flex-1 min-w-0">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="manualExpenseDate" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-sm">
                    </div>
                    <div class="w-24 flex-shrink-0">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total $</label>
                        <input type="number" step="1" id="manualExpenseTotal" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-sm text-right" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <select id="manualExpenseCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none bg-white"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n (opcional)</label>
                    <input type="text" id="manualExpenseDescription" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Detalles adicionales">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeAddExpenseModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button onclick="saveManualExpense()" class="flex-1 px-4 py-3 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Gasto -->
    <div id="editExpenseModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeEditExpenseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Editar Gasto</h3>
                <button onclick="closeEditExpenseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tienda / Comercio</label>
                    <input type="text" id="editExpenseStore" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Nombre del comercio">
                </div>
                <div class="flex gap-3">
                    <div class="flex-1 min-w-0">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="editExpenseDate" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-sm">
                    </div>
                    <div class="w-24 flex-shrink-0">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total $</label>
                        <input type="number" step="1" id="editExpenseTotal" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-sm text-right" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <select id="editExpenseCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none bg-white"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n (opcional)</label>
                    <input type="text" id="editExpenseDescription" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Detalles adicionales">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeEditExpenseModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button onclick="saveEditedExpense()" class="flex-1 px-4 py-3 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Administrar Categor√≠as -->
    <div id="categoriesModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeCategoriesModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üè∑Ô∏è Administrar Categor√≠as</h3>
                <button onclick="closeCategoriesModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Category Type Tabs -->
            <div class="flex gap-2 p-1 bg-gray-100 rounded-xl mb-4">
                <button onclick="setCategoryTab('expenses')" id="catTabExpenses" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition bg-white shadow text-purple-600">
                    üí∞ Gastos
                </button>
                <button onclick="setCategoryTab('activities')" id="catTabActivities" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition text-gray-500">
                    üìÖ Actividades
                </button>
            </div>

            <!-- Categories List -->
            <div id="categoriesList" class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                <!-- Populated dynamically -->
            </div>

            <!-- Add New Category -->
            <div class="border-t pt-4">
                <p class="text-sm font-medium text-gray-700 mb-2">‚ûï Agregar nueva categor√≠a</p>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="newCategoryEmoji" class="w-14 px-2 py-2 border border-gray-200 rounded-xl text-center text-xl" placeholder="üÜï" maxlength="2">
                    <input type="text" id="newCategoryName" class="flex-1 px-3 py-2 border border-gray-200 rounded-xl text-sm" placeholder="Nombre de categor√≠a">
                </div>
                <button onclick="addNewCategory()" class="w-full py-2 theme-btn rounded-xl font-medium hover:opacity-90 transition">
                    ‚ûï A√±adir Categor√≠a
                </button>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="resetCategoriesToDefault()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition text-sm">
                    üîÑ Restaurar por defecto
                </button>
                <button onclick="closeCategoriesModal()" class="flex-1 px-4 py-2 bg-gray-800 text-white rounded-xl font-medium hover:opacity-90 transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Compartir -->
    <div id="shareModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeShareModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-2">üì§ Compartir Logros</h3>
            <p class="text-gray-500 text-sm mb-4">¬°Muestra tu progreso al mundo!</p>

            <!-- Preview Card -->
            <div id="sharePreview" class="theme-share rounded-2xl p-6 text-white mb-4">
                <div class="text-center">
                    <p class="text-sm opacity-80">Mi progreso en</p>
                    <h4 class="text-xl font-bold mb-4">üéØ Gesti√≥n del Tiempo</h4>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-white/20 rounded-xl p-3">
                            <p id="shareDailyProgress" class="text-2xl font-bold">0%</p>
                            <p class="text-xs opacity-80">Hoy</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p id="shareWeeklyProgress" class="text-2xl font-bold">0%</p>
                            <p class="text-xs opacity-80">Semana</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p id="shareTotalProgress" class="text-2xl font-bold">0%</p>
                            <p class="text-xs opacity-80">Total</p>
                        </div>
                    </div>

                    <div class="flex justify-center gap-4">
                        <div class="flex items-center gap-1">
                            <span>üî•</span>
                            <span id="shareStreak" class="font-bold">0</span>
                            <span class="text-xs opacity-80">d√≠as</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span>üèÜ</span>
                            <span id="shareBestStreak" class="font-bold">0</span>
                            <span class="text-xs opacity-80">mejor</span>
                        </div>
                    </div>

                    <p id="shareMessage" class="mt-4 text-sm opacity-90 italic"></p>
                </div>
            </div>

            <!-- Share Options -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="copyShareText()" class="flex items-center justify-center gap-2 p-3 bg-gray-100 rounded-xl hover:bg-gray-200 transition">
                    <span class="text-xl">üìã</span>
                    <span class="text-sm font-medium text-gray-700">Copiar texto</span>
                </button>
                <button onclick="shareToTwitter()" class="flex items-center justify-center gap-2 p-3 bg-blue-100 rounded-xl hover:bg-blue-200 transition">
                    <span class="text-xl">üê¶</span>
                    <span class="text-sm font-medium text-blue-700">Twitter</span>
                </button>
                <button onclick="shareToWhatsApp()" class="flex items-center justify-center gap-2 p-3 bg-green-100 rounded-xl hover:bg-green-200 transition">
                    <span class="text-xl">üí¨</span>
                    <span class="text-sm font-medium text-green-700">WhatsApp</span>
                </button>
                <button onclick="shareNative()" class="flex items-center justify-center gap-2 p-3 bg-purple-100 rounded-xl hover:bg-purple-200 transition">
                    <span class="text-xl">üì≤</span>
                    <span class="text-sm font-medium text-purple-700">Compartir</span>
                </button>
            </div>

            <button onclick="closeShareModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Plantillas -->
    <div id="templateModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeTemplateModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[85vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <button onclick="closeTemplateModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition" title="Cerrar">
                ‚úï
            </button>
            <h3 class="text-xl font-bold text-gray-800 mb-2">üìã Plantillas</h3>
            <p class="text-gray-500 text-sm mb-4">Carga planes completos o guarda tus propios horarios</p>

            <!-- Community Templates Section -->
            <div class="mb-6">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">üë•</span>
                    <h4 class="font-semibold text-gray-800">Plantillas de la Comunidad</h4>
                </div>
                <div id="communityTemplatesList" class="space-y-3">
                    <!-- Community templates will be rendered here -->
                </div>
            </div>

            <hr class="my-4 border-gray-200">

            <!-- Save current as template -->
            <div class="bg-gradient-to-r from-rose-50 to-purple-50 rounded-xl p-4 mb-4">
                <p class="font-medium text-gray-800 mb-2">üíæ Guardar d√≠a actual como plantilla</p>
                <div class="flex gap-2">
                    <input type="text" id="templateName" placeholder="Nombre de la plantilla..." class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-400 outline-none">
                    <button onclick="saveTemplate()" class="px-4 py-2 theme-btn rounded-lg text-sm font-medium hover:opacity-90 transition">
                        Guardar
                    </button>
                </div>
            </div>

            <!-- My Templates list -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">üìÅ</span>
                    <h4 class="font-semibold text-gray-800">Mis Plantillas</h4>
                </div>
                <div id="templatesList" class="space-y-2">
                    <!-- Templates will be rendered here -->
                </div>
            </div>

            <button onclick="closeTemplateModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Limpiar Secci√≥n -->
    <div id="cleanModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeCleanModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="text-center">
                <span class="text-5xl">üßπ</span>
                <h3 class="text-xl font-bold text-gray-800 mt-3">Limpiar Secci√≥n</h3>
                <p class="text-gray-500 mt-2" id="cleanModalDescription">Selecciona qu√© deseas limpiar</p>
            </div>

            <div id="cleanOptions" class="space-y-3 mt-6">
                <!-- Options will be rendered dynamically -->
            </div>

            <button onclick="closeCleanModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Modal Reinicio Total -->
    <div id="resetModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeResetModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="text-center">
                <span class="text-5xl">‚ö†Ô∏è</span>
                <h3 class="text-xl font-bold text-gray-800 mt-3">Reiniciar Datos</h3>
                <p class="text-gray-500 mt-2">Selecciona el nivel de reinicio</p>
            </div>

            <div class="space-y-3 mt-6">
                <!-- Opci√≥n 1: Limpiar progreso -->
                <button onclick="resetProgress()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-yellow-300 hover:bg-yellow-50 transition text-left">
                    <span class="text-3xl">üßπ</span>
                    <div>
                        <p class="font-medium text-gray-800">Limpiar todo el progreso</p>
                        <p class="text-sm text-gray-500">Desmarcar todas las actividades, h√°bitos y ejercicios completados</p>
                    </div>
                </button>

                <!-- Opci√≥n 2: Restaurar valores por defecto -->
                <button onclick="resetToDefaults()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition text-left">
                    <span class="text-3xl">üîÑ</span>
                    <div>
                        <p class="font-medium text-gray-800">Restaurar valores por defecto</p>
                        <p class="text-sm text-gray-500">Eliminar personalizaciones y volver a la configuraci√≥n inicial</p>
                    </div>
                </button>

                <!-- Opci√≥n 3: Reinicio parcial (mantener perfil) -->
                <button onclick="resetKeepProfile()" class="w-full flex items-center gap-3 p-4 border-2 border-orange-200 rounded-xl hover:border-orange-400 hover:bg-orange-50 transition text-left">
                    <span class="text-3xl">üîÉ</span>
                    <div>
                        <p class="font-medium text-orange-700">Empezar de nuevo (mantener perfil)</p>
                        <p class="text-sm text-gray-500">Borrar TODO excepto tu perfil y datos personales</p>
                    </div>
                </button>

                <!-- Opci√≥n 4: Reinicio total -->
                <button onclick="resetTotal()" class="w-full flex items-center gap-3 p-4 border-2 border-red-200 rounded-xl hover:border-red-400 hover:bg-red-50 transition text-left">
                    <span class="text-3xl">üí•</span>
                    <div>
                        <p class="font-medium text-red-600">REINICIO TOTAL</p>
                        <p class="text-sm text-gray-500">Borrar ABSOLUTAMENTE TODO y empezar desde cero</p>
                    </div>
                </button>
            </div>

            <button onclick="closeResetModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Modal Iniciar Ayuno -->
    <div id="startFastingModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeStartFastingModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üïê Iniciar Ayuno</h3>
                <button onclick="closeStartFastingModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <p class="text-gray-500 text-sm mb-4">Selecciona el tipo de ayuno intermitente</p>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="selectFastingType('12:12')" class="fasting-type-btn flex flex-col items-center p-4 border-2 border-gray-200 rounded-xl hover:border-amber-300 transition">
                    <span class="text-2xl mb-1">üåÖ</span>
                    <span class="font-bold text-gray-800">12:12</span>
                    <span class="text-xs text-gray-500">Principiante</span>
                </button>
                <button onclick="selectFastingType('14:10')" class="fasting-type-btn flex flex-col items-center p-4 border-2 border-gray-200 rounded-xl hover:border-amber-300 transition">
                    <span class="text-2xl mb-1">üå§Ô∏è</span>
                    <span class="font-bold text-gray-800">14:10</span>
                    <span class="text-xs text-gray-500">Intermedio</span>
                </button>
                <button onclick="selectFastingType('16:8')" class="fasting-type-btn flex flex-col items-center p-4 border-2 border-gray-200 rounded-xl hover:border-amber-300 transition">
                    <span class="text-2xl mb-1">‚≠ê</span>
                    <span class="font-bold text-gray-800">16:8</span>
                    <span class="text-xs text-amber-600 font-medium">Popular</span>
                </button>
                <button onclick="selectFastingType('18:6')" class="fasting-type-btn flex flex-col items-center p-4 border-2 border-gray-200 rounded-xl hover:border-amber-300 transition">
                    <span class="text-2xl mb-1">üî•</span>
                    <span class="font-bold text-gray-800">18:6</span>
                    <span class="text-xs text-gray-500">Avanzado</span>
                </button>
                <button onclick="selectFastingType('20:4')" class="fasting-type-btn flex flex-col items-center p-4 border-2 border-gray-200 rounded-xl hover:border-amber-300 transition">
                    <span class="text-2xl mb-1">‚öîÔ∏è</span>
                    <span class="font-bold text-gray-800">20:4</span>
                    <span class="text-xs text-gray-500">Guerrero</span>
                </button>
                <button onclick="selectFastingType('24:0')" class="fasting-type-btn flex flex-col items-center p-4 border-2 border-gray-200 rounded-xl hover:border-amber-300 transition">
                    <span class="text-2xl mb-1">üèÜ</span>
                    <span class="font-bold text-gray-800">24h</span>
                    <span class="text-xs text-gray-500">OMAD</span>
                </button>
            </div>

            <button onclick="selectFastingType('custom')" class="fasting-type-btn w-full flex items-center justify-center gap-2 p-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-amber-300 transition mb-3">
                <span>‚öôÔ∏è</span>
                <span class="text-gray-600">Personalizado</span>
            </button>

            <div id="customFastingHoursGroup" class="hidden mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Duraci√≥n (horas)</label>
                <input type="number" id="customFastingHours" min="1" max="72" step="0.5" placeholder="Ej: 20" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent">
            </div>

            <div class="flex gap-3">
                <button onclick="closeStartFastingModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button onclick="confirmStartFasting()" class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    üöÄ Comenzar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Ayuno (Historial) -->
    <div id="editFastingModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeEditFastingModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <input type="hidden" id="editFastingId">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Editar Notas</h3>
                <button onclick="closeEditFastingModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‚ö° Nivel de Energ√≠a</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="editFastingEnergy" min="1" max="5" value="3" class="flex-1 accent-amber-500" oninput="document.getElementById('editFastingEnergyValue').textContent = this.value">
                        <span id="editFastingEnergyValue" class="w-8 text-center font-bold text-amber-600">3</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üçΩÔ∏è Nivel de Hambre</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="editFastingHunger" min="1" max="5" value="3" class="flex-1 accent-amber-500" oninput="document.getElementById('editFastingHungerValue').textContent = this.value">
                        <span id="editFastingHungerValue" class="w-8 text-center font-bold text-amber-600">3</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üß† Nivel de Enfoque</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="editFastingFocus" min="1" max="5" value="3" class="flex-1 accent-amber-500" oninput="document.getElementById('editFastingFocusValue').textContent = this.value">
                        <span id="editFastingFocusValue" class="w-8 text-center font-bold text-amber-600">3</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìù Comentarios</label>
                    <textarea id="editFastingFeedback" rows="3" placeholder="¬øC√≥mo te sentiste?" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeEditFastingModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button onclick="saveEditedFasting()" class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Notas Ayuno Activo -->
    <div id="fastingNotesModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeFastingNotesModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìù ¬øC√≥mo te sientes?</h3>
                <button onclick="closeFastingNotesModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <p class="text-gray-500 text-sm mb-4">Registra tus sensaciones durante el ayuno</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‚ö° Nivel de Energ√≠a</label>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">Bajo</span>
                        <input type="range" id="activeFastingEnergy" min="1" max="5" value="3" class="flex-1 accent-amber-500" oninput="document.getElementById('activeFastingEnergyValue').textContent = this.value">
                        <span class="text-xs text-gray-400">Alto</span>
                        <span id="activeFastingEnergyValue" class="w-8 text-center font-bold text-amber-600">3</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üçΩÔ∏è Nivel de Hambre</label>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">Poco</span>
                        <input type="range" id="activeFastingHunger" min="1" max="5" value="3" class="flex-1 accent-amber-500" oninput="document.getElementById('activeFastingHungerValue').textContent = this.value">
                        <span class="text-xs text-gray-400">Mucho</span>
                        <span id="activeFastingHungerValue" class="w-8 text-center font-bold text-amber-600">3</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üß† Nivel de Enfoque</label>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">Disperso</span>
                        <input type="range" id="activeFastingFocus" min="1" max="5" value="3" class="flex-1 accent-amber-500" oninput="document.getElementById('activeFastingFocusValue').textContent = this.value">
                        <span class="text-xs text-gray-400">Enfocado</span>
                        <span id="activeFastingFocusValue" class="w-8 text-center font-bold text-amber-600">3</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeFastingNotesModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button onclick="saveFastingNotes()" class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ayuno Completado -->
    <div id="fastingCompletionModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeFastingCompletionModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all text-center" onclick="event.stopPropagation()">
            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mb-4">
                <span id="completionIcon" class="text-4xl">üéâ</span>
            </div>

            <h3 id="completionFeedback" class="text-2xl font-bold text-gray-800 mb-2">¬°Excelente!</h3>
            <p class="text-gray-500 mb-4">Has completado tu ayuno</p>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3">
                    <p id="completionActualHours" class="text-xl font-bold text-amber-600">0h</p>
                    <p class="text-xs text-gray-500">Duraci√≥n</p>
                </div>
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3">
                    <p id="completionTargetHours" class="text-xl font-bold text-amber-600">0h</p>
                    <p class="text-xs text-gray-500">Meta</p>
                </div>
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3">
                    <p id="completionPercentage" class="text-xl font-bold text-amber-600">0%</p>
                    <p class="text-xs text-gray-500">Logro</p>
                </div>
            </div>

            <button onclick="closeFastingCompletionModal()" class="w-full px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                ¬°Genial! üëè
            </button>
        </div>
    </div>

    <!-- Modal Wizard Plan de Entrenamiento -->
    <div id="trainingPlanWizardModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeTrainingPlanWizard()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all" onclick="event.stopPropagation()">
            <!-- Header with Progress -->
            <div class="sticky top-0 bg-white p-4 border-b border-gray-100 z-10">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-gray-800">üèãÔ∏è Crear Plan de Entrenamiento</h3>
                    <button onclick="closeTrainingPlanWizard()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                </div>
                <!-- Progress Bar -->
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div id="trainingPlanProgress" class="h-full bg-gradient-to-r from-rose-500 to-purple-500 transition-all duration-300" style="width: 20%"></div>
                    </div>
                    <span id="trainingPlanStepLabel" class="text-xs font-medium text-gray-500">1/5</span>
                </div>
            </div>

            <!-- Step Content Container -->
            <div id="trainingPlanStepContent" class="p-5">
                <!-- Steps will be rendered here dynamically -->
            </div>

            <!-- Footer with Navigation -->
            <div class="sticky bottom-0 bg-white p-4 border-t border-gray-100 flex gap-3">
                <button id="trainingPlanBackBtn" onclick="prevTrainingPlanStep()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition hidden">
                    ‚Üê Atr√°s
                </button>
                <button id="trainingPlanNextBtn" onclick="nextTrainingPlanStep()" class="flex-1 px-4 py-3 bg-gradient-to-r from-rose-500 to-purple-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Info de Ejercicio -->
    <div id="exerciseInfoModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeExerciseInfoModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all" onclick="event.stopPropagation()">
            <!-- Exercise Image -->
            <div id="exerciseInfoImage" class="w-full h-48 bg-gradient-to-br from-purple-100 to-rose-100 flex items-center justify-center">
                <span class="text-6xl">üèãÔ∏è</span>
            </div>

            <!-- Content -->
            <div class="p-5">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <h3 id="exerciseInfoName" class="text-xl font-bold text-gray-800">Nombre del Ejercicio</h3>
                        <p id="exerciseInfoSpanish" class="text-sm text-purple-600 font-medium"></p>
                    </div>
                    <span id="exerciseInfoMuscle" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">M√∫sculo</span>
                </div>

                <div class="space-y-4">
                    <!-- Description -->
                    <div>
                        <h4 class="text-sm font-bold text-gray-700 mb-1 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4"></i> C√≥mo hacerlo
                        </h4>
                        <p id="exerciseInfoDescription" class="text-sm text-gray-600 leading-relaxed"></p>
                    </div>

                    <!-- Tips -->
                    <div class="bg-amber-50 rounded-xl p-3">
                        <h4 class="text-sm font-bold text-amber-700 mb-1 flex items-center gap-2">
                            <i data-lucide="lightbulb" class="w-4 h-4"></i> Tips
                        </h4>
                        <p id="exerciseInfoTips" class="text-sm text-amber-800"></p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-5 pb-5">
                <button onclick="closeExerciseInfoModal()" class="w-full py-3 bg-gradient-to-r from-rose-500 to-purple-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Guardar/Cargar Rutina -->
    <div id="routineTemplatesModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeRoutineTemplatesModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-hidden transform transition-all" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-800">üìã Mis Rutinas Guardadas</h3>
                <button onclick="closeRoutineTemplatesModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <div id="routineTemplatesContent" class="p-4 overflow-y-auto max-h-[60vh]">
                <!-- Templates will be rendered here -->
            </div>
            <div class="p-4 border-t border-gray-100">
                <button onclick="saveCurrentRoutineAsTemplate()" class="w-full px-4 py-3 bg-gradient-to-r from-rose-500 to-purple-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    üíæ Guardar rutina actual
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nombrar Rutina -->
    <div id="nameRoutineModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeNameRoutineModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üíæ Guardar Rutina</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre de la rutina</label>
                    <input type="text" id="routineTemplateName" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: Piernas intenso, Full body...">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeNameRoutineModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="confirmSaveRoutineTemplate()" class="flex-1 px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Check login
        const currentUser = JSON.parse(localStorage.getItem('gestion-currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // Check if user needs onboarding (and hasn't completed it)
        if (currentUser && currentUser.needsOnboarding && !currentUser.onboardingCompleted) {
            window.location.href = 'onboarding.html';
        }

        // Check if user needs activity setup wizard
        if (currentUser && currentUser.needsActivitySetup && !currentUser.activitySetupCompleted) {
            window.location.href = 'activity-setup.html';
        }

        // User-specific storage key prefix
        const userKey = currentUser ? currentUser.email.replace(/[^a-z0-9]/gi, '_') : 'guest';

        // Initialize Supabase sync service
        if (currentUser && currentUser.email && typeof syncService !== 'undefined') {
            syncService.initUser(currentUser.email, currentUser.name || '').then(async user => {
                if (user) {
                    console.log('Sync service initialized for:', currentUser.email);

                    // Download all user data from Supabase first
                    console.log('Downloading all user data from Supabase...');
                    await syncService.downloadAllUserData();

                    // Then sync any local-only data to Supabase
                    await syncService.syncAll();

                    // Load expenses from server
                    if (typeof loadExpensesFromServer === 'function') {
                        await loadExpensesFromServer();
                    }

                    // Refresh UI with synced data
                    console.log('Sync complete - refreshing UI');
                    if (typeof render === 'function') {
                        render();
                    }
                }
            }).catch(err => {
                console.log('Sync service offline, using localStorage');
            });
        }

        function getStorage(key) {
            return localStorage.getItem(`${userKey}-${key}`);
        }

        // ==================== TRANSLATIONS SYSTEM ====================
        const translations = {
            es: {
                // Navigation & Tabs
                agenda: 'Agenda',
                habits: 'H√°bitos',
                gym: 'Gym',
                nutrition: 'Nutrici√≥n',
                goals: 'Metas',
                statistics: 'Estad√≠sticas',
                expenses: 'Gastos',

                // Common Actions
                save: 'Guardar',
                cancel: 'Cancelar',
                delete: 'Eliminar',
                edit: 'Editar',
                add: 'Agregar',
                close: 'Cerrar',
                search: 'Buscar',
                filter: 'Filtrar',
                loading: 'Cargando...',

                // Time
                today: 'Hoy',
                yesterday: 'Ayer',
                tomorrow: 'Ma√±ana',
                week: 'Semana',
                month: 'Mes',

                // Days
                monday: 'Lunes',
                tuesday: 'Martes',
                wednesday: 'Mi√©rcoles',
                thursday: 'Jueves',
                friday: 'Viernes',
                saturday: 'S√°bado',
                sunday: 'Domingo',

                // Agenda
                activities: 'actividades',
                completed: 'completadas',
                addActivity: 'Agregar Actividad',
                editActivity: 'Editar Actividad',
                activityTime: 'Hora',
                activityName: 'Actividad',
                activityDuration: 'Duraci√≥n',
                activityCategory: 'Categor√≠a',
                noActivities: 'No hay actividades para este d√≠a',

                // Habits
                dailyHabits: 'H√°bitos Diarios',
                habitCompleted: 'Completado',
                addHabit: 'Agregar H√°bito',
                editHabit: 'Editar H√°bito',
                habitName: 'Nombre del h√°bito',
                habitIcon: 'Icono',

                // Gym
                todayRoutine: 'Rutina de Hoy',
                exercises: 'ejercicios',
                sets: 'series',
                addExercise: 'Agregar Ejercicio',
                editExercise: 'Editar Ejercicio',
                restTimer: 'Temporizador de Descanso',

                // Nutrition
                meals: 'Comidas',
                macros: 'Macros',
                calories: 'Calor√≠as',
                protein: 'Prote√≠na',
                carbs: 'Carbohidratos',
                fats: 'Grasas',
                addMeal: 'Agregar Comida',
                editMeal: 'Editar Comida',

                // Goals
                weeklyGoals: 'Metas Semanales',
                physical: 'F√≠sico',
                personal: 'Personal',
                digital: 'Digital',
                spiritual: 'Espiritual',

                // Progress
                progress: 'Progreso',
                dailyProgress: 'Progreso Diario',
                weeklyProgress: 'Progreso Semanal',
                totalProgress: 'Progreso Total',

                // Profile
                profile: 'Perfil',
                name: 'Nombre',
                email: 'Correo electr√≥nico',
                phone: 'Tel√©fono',
                birthdate: 'Fecha de nacimiento',
                gender: 'G√©nero',
                female: 'Femenino',
                male: 'Masculino',
                other: 'Otro',
                preferNotSay: 'Prefiero no decir',
                bio: 'Bio / Motivaci√≥n',
                language: 'Idioma',
                profilePhoto: 'Foto de perfil',
                upload: 'Subir',
                camera: 'C√°mara',

                // Settings
                settings: 'Configuraci√≥n',
                darkMode: 'Modo Oscuro',
                notifications: 'Notificaciones',
                exportData: 'Exportar Datos',
                logout: 'Cerrar Sesi√≥n',

                // Pomodoro
                pomodoroTimer: 'Pomodoro Timer',
                pomodorosToday: 'Pomodoros hoy',
                start: 'Iniciar',
                pause: 'Pausar',
                reset: 'Reiniciar',

                // Messages
                savedSuccessfully: 'Guardado correctamente',
                deletedSuccessfully: 'Eliminado correctamente',
                confirmDelete: '¬øEst√°s seguro de eliminar?',
                selectOption: 'Seleccionar...',

                // Templates
                templates: 'Plantillas',
                loadTemplate: 'Cargar Plantilla',
                replaceAll: 'Reemplazar todo',
                addToExisting: 'Agregar a lo existente',

                // Expenses
                scanReceipt: 'Escanear Recibo',
                addExpense: 'Agregar Gasto',
                totalExpenses: 'Total Gastos',

                // Share
                shareAchievements: 'Compartir Logros',
                shareMessage: '¬°Mira mi progreso!'
            },
            en: {
                // Navigation & Tabs
                agenda: 'Schedule',
                habits: 'Habits',
                gym: 'Gym',
                nutrition: 'Nutrition',
                goals: 'Goals',
                statistics: 'Statistics',
                expenses: 'Expenses',

                // Common Actions
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                add: 'Add',
                close: 'Close',
                search: 'Search',
                filter: 'Filter',
                loading: 'Loading...',

                // Time
                today: 'Today',
                yesterday: 'Yesterday',
                tomorrow: 'Tomorrow',
                week: 'Week',
                month: 'Month',

                // Days
                monday: 'Monday',
                tuesday: 'Tuesday',
                wednesday: 'Wednesday',
                thursday: 'Thursday',
                friday: 'Friday',
                saturday: 'Saturday',
                sunday: 'Sunday',

                // Agenda
                activities: 'activities',
                completed: 'completed',
                addActivity: 'Add Activity',
                editActivity: 'Edit Activity',
                activityTime: 'Time',
                activityName: 'Activity',
                activityDuration: 'Duration',
                activityCategory: 'Category',
                noActivities: 'No activities for this day',

                // Habits
                dailyHabits: 'Daily Habits',
                habitCompleted: 'Completed',
                addHabit: 'Add Habit',
                editHabit: 'Edit Habit',
                habitName: 'Habit name',
                habitIcon: 'Icon',

                // Gym
                todayRoutine: "Today's Routine",
                exercises: 'exercises',
                sets: 'sets',
                addExercise: 'Add Exercise',
                editExercise: 'Edit Exercise',
                restTimer: 'Rest Timer',

                // Nutrition
                meals: 'Meals',
                macros: 'Macros',
                calories: 'Calories',
                protein: 'Protein',
                carbs: 'Carbs',
                fats: 'Fats',
                addMeal: 'Add Meal',
                editMeal: 'Edit Meal',

                // Goals
                weeklyGoals: 'Weekly Goals',
                physical: 'Physical',
                personal: 'Personal',
                digital: 'Digital',
                spiritual: 'Spiritual',

                // Progress
                progress: 'Progress',
                dailyProgress: 'Daily Progress',
                weeklyProgress: 'Weekly Progress',
                totalProgress: 'Total Progress',

                // Profile
                profile: 'Profile',
                name: 'Name',
                email: 'Email',
                phone: 'Phone',
                birthdate: 'Birthdate',
                gender: 'Gender',
                female: 'Female',
                male: 'Male',
                other: 'Other',
                preferNotSay: 'Prefer not to say',
                bio: 'Bio / Motivation',
                language: 'Language',
                profilePhoto: 'Profile Photo',
                upload: 'Upload',
                camera: 'Camera',

                // Settings
                settings: 'Settings',
                darkMode: 'Dark Mode',
                notifications: 'Notifications',
                exportData: 'Export Data',
                logout: 'Logout',

                // Pomodoro
                pomodoroTimer: 'Pomodoro Timer',
                pomodorosToday: 'Pomodoros today',
                start: 'Start',
                pause: 'Pause',
                reset: 'Reset',

                // Messages
                savedSuccessfully: 'Saved successfully',
                deletedSuccessfully: 'Deleted successfully',
                confirmDelete: 'Are you sure you want to delete?',
                selectOption: 'Select...',

                // Templates
                templates: 'Templates',
                loadTemplate: 'Load Template',
                replaceAll: 'Replace all',
                addToExisting: 'Add to existing',

                // Expenses
                scanReceipt: 'Scan Receipt',
                addExpense: 'Add Expense',
                totalExpenses: 'Total Expenses',

                // Share
                shareAchievements: 'Share Achievements',
                shareMessage: 'Check out my progress!'
            }
        };

        // Get current language
        function getLang() {
            const profile = JSON.parse(getStorage('user-profile') || '{}');
            return profile.language || 'es';
        }

        // Translation function
        function t(key) {
            const lang = getLang();
            return translations[lang][key] || translations['es'][key] || key;
        }

        // Get day name translated
        function getDayName(dayIndex) {
            const days = {
                0: t('sunday'),
                1: t('monday'),
                2: t('tuesday'),
                3: t('wednesday'),
                4: t('thursday'),
                5: t('friday'),
                6: t('saturday')
            };
            return days[dayIndex] || '';
        }

        // ==================== END TRANSLATIONS ====================

        // Theme Colors based on user preference
        function getUserThemeColor() {
            const profile = JSON.parse(getStorage('user-profile') || '{}');
            // First check for new themeColor preference
            if (profile.themeColor) {
                return profile.themeColor;
            }
            // Fallback to legacy gender-based theme
            const gender = profile.gender || 'female';
            if (gender === 'male' || gender === 'Male' || gender === 'masculino' || gender === 'Masculino') {
                return 'azul';
            }
            return 'rosa';
        }

        function getThemeColors() {
            const themeColor = getUserThemeColor();

            const themes = {
                rosa: {
                    primary: 'rose',
                    secondary: 'purple',
                    gradientFrom: 'from-rose-500',
                    gradientTo: 'to-purple-600',
                    gradientVia: 'via-pink-500',
                    accent: 'purple',
                    accentLight: 'purple-100',
                    accentDark: 'purple-600',
                    headerGradient: 'from-rose-500 to-purple-600',
                    cardGradient: 'from-rose-500 to-purple-600',
                    buttonGradient: 'from-rose-500 to-purple-500',
                    textGradient: 'from-rose-600 to-purple-600',
                    photoGlow: 'from-pink-500 to-purple-500',
                    border: 'purple-200'
                },
                azul: {
                    primary: 'blue',
                    secondary: 'cyan',
                    gradientFrom: 'from-blue-500',
                    gradientTo: 'to-cyan-600',
                    gradientVia: 'via-indigo-500',
                    accent: 'blue',
                    accentLight: 'blue-100',
                    accentDark: 'blue-600',
                    headerGradient: 'from-blue-500 to-cyan-600',
                    cardGradient: 'from-blue-500 to-indigo-600',
                    buttonGradient: 'from-blue-500 to-cyan-500',
                    textGradient: 'from-blue-600 to-cyan-600',
                    photoGlow: 'from-blue-500 to-cyan-500',
                    border: 'blue-200'
                },
                verde: {
                    primary: 'emerald',
                    secondary: 'teal',
                    gradientFrom: 'from-emerald-500',
                    gradientTo: 'to-teal-600',
                    gradientVia: 'via-green-500',
                    accent: 'emerald',
                    accentLight: 'emerald-100',
                    accentDark: 'emerald-600',
                    headerGradient: 'from-emerald-500 to-teal-600',
                    cardGradient: 'from-emerald-500 to-teal-600',
                    buttonGradient: 'from-emerald-500 to-teal-500',
                    textGradient: 'from-emerald-600 to-teal-600',
                    photoGlow: 'from-emerald-500 to-teal-500',
                    border: 'emerald-200'
                },
                naranja: {
                    primary: 'orange',
                    secondary: 'amber',
                    gradientFrom: 'from-orange-500',
                    gradientTo: 'to-amber-500',
                    gradientVia: 'via-yellow-500',
                    accent: 'orange',
                    accentLight: 'orange-100',
                    accentDark: 'orange-600',
                    headerGradient: 'from-orange-500 to-amber-500',
                    cardGradient: 'from-orange-500 to-amber-500',
                    buttonGradient: 'from-orange-500 to-amber-500',
                    textGradient: 'from-orange-600 to-amber-600',
                    photoGlow: 'from-orange-500 to-amber-500',
                    border: 'orange-200'
                },
                coral: {
                    primary: 'rose',
                    secondary: 'red',
                    gradientFrom: 'from-rose-500',
                    gradientTo: 'to-red-600',
                    gradientVia: 'via-pink-500',
                    accent: 'rose',
                    accentLight: 'rose-100',
                    accentDark: 'rose-600',
                    headerGradient: 'from-rose-500 to-red-600',
                    cardGradient: 'from-rose-500 to-red-600',
                    buttonGradient: 'from-rose-500 to-red-500',
                    textGradient: 'from-rose-600 to-red-600',
                    photoGlow: 'from-rose-500 to-red-500',
                    border: 'rose-200'
                },
                morado: {
                    primary: 'violet',
                    secondary: 'indigo',
                    gradientFrom: 'from-violet-500',
                    gradientTo: 'to-indigo-600',
                    gradientVia: 'via-purple-500',
                    accent: 'violet',
                    accentLight: 'violet-100',
                    accentDark: 'violet-600',
                    headerGradient: 'from-violet-500 to-indigo-600',
                    cardGradient: 'from-violet-500 to-indigo-600',
                    buttonGradient: 'from-violet-500 to-indigo-500',
                    textGradient: 'from-violet-600 to-indigo-600',
                    photoGlow: 'from-violet-500 to-indigo-500',
                    border: 'violet-200'
                }
            };

            return themes[themeColor] || themes.rosa;
        }

        const theme = getThemeColors();

        function setStorage(key, value) {
            localStorage.setItem(`${userKey}-${key}`, value);

            // Auto-sync ALL data to Supabase in real-time
            if (typeof syncService !== 'undefined' && syncService.userId) {
                // Debounce sync to avoid too many requests
                if (!window._syncDebounce) window._syncDebounce = {};

                clearTimeout(window._syncDebounce[key]);
                window._syncDebounce[key] = setTimeout(async () => {
                    try {
                        // Parse value if it's JSON
                        let parsedValue;
                        try {
                            parsedValue = JSON.parse(value);
                        } catch (e) {
                            parsedValue = value;
                        }

                        // Save to user_data table
                        await syncService.saveUserData(key, key, parsedValue);
                        console.log(`Synced ${key} to Supabase`);
                    } catch (e) {
                        console.log('Sync error for', key, ':', e.message);
                    }
                }, 500); // 500ms debounce
            }
        }

        function removeStorage(key) {
            localStorage.removeItem(`${userKey}-${key}`);
        }

        // Dark Mode Functions
        function isDarkMode() {
            return getStorage('dark-mode') === 'true';
        }

        function toggleDarkMode() {
            const isDark = !isDarkMode();
            setStorage('dark-mode', isDark.toString());
            applyDarkMode();
            render();
        }

        function applyDarkMode() {
            if (isDarkMode()) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }

        function applyTheme() {
            const themeColor = getUserThemeColor();
            // Remove all theme classes
            document.body.classList.remove('theme-male', 'theme-rosa', 'theme-azul', 'theme-verde', 'theme-naranja', 'theme-coral', 'theme-morado');
            // Apply new theme class
            document.body.classList.add('theme-' + themeColor);
            // Keep theme-male for backwards compatibility with azul
            if (themeColor === 'azul') {
                document.body.classList.add('theme-male');
            }
        }

        // ====== FUNCIONES DE MODO DE VISTA ======
        // Opciones: 'minimal', 'medium', 'maximal'
        function getViewMode() {
            return getStorage('view-mode') || 'medium';
        }

        function setViewMode(mode) {
            if (['minimal', 'medium', 'maximal'].includes(mode)) {
                setStorage('view-mode', mode);
                applyViewMode();
                render();
            }
        }

        function applyViewMode() {
            const mode = getViewMode();
            // Remove all view mode classes
            document.body.classList.remove('view-minimal', 'view-medium', 'view-maximal');
            // Apply current view mode
            document.body.classList.add('view-' + mode);
            // Add transition class temporarily for smooth animation
            document.body.classList.add('view-transition');
            setTimeout(() => {
                document.body.classList.remove('view-transition');
            }, 300);
        }

        function getViewModeLabel(mode) {
            const labels = {
                'minimal': 'Minimalista',
                'medium': 'Media',
                'maximal': 'Maximalista'
            };
            return labels[mode] || 'Media';
        }

        function getViewModeIcon(mode) {
            const icons = {
                'minimal': '‚óØ',
                'medium': '‚óê',
                'maximal': '‚óè'
            };
            return icons[mode] || '‚óê';
        }

        // ====== FUNCIONES DE ESTILO DE ICONOS ======
        // Opciones: 'emoji', 'lucide'
        function getIconStyle() {
            return getStorage('icon-style') || 'emoji';
        }

        function setIconStyle(style) {
            if (['emoji', 'lucide'].includes(style)) {
                setStorage('icon-style', style);
                // Force full re-render to apply icon changes
                render();
            }
        }

        function isLucideMode() {
            return getIconStyle() === 'lucide';
        }

        // Icon mapping: emoji -> lucide icon name
        const ICON_MAP = {
            // Navigation & UI
            '‚öôÔ∏è': 'settings',
            'üîî': 'bell',
            'üìÖ': 'calendar',
            '‚úèÔ∏è': 'pencil',
            'üóëÔ∏è': 'trash-2',
            '‚ûï': 'plus',
            '‚úì': 'check',
            '√ó': 'x',
            '‚Üê': 'arrow-left',
            '‚Üí': 'arrow-right',
            'üîç': 'search',
            'üìã': 'clipboard-list',
            'üíæ': 'save',
            'üì•': 'download',
            'üì§': 'upload',
            'üîÑ': 'refresh-cw',

            // Fitness & Health
            'üí™': 'dumbbell',
            'üèãÔ∏è': 'dumbbell',
            'ü¶µ': 'footprints',
            'üçë': 'heart',
            'üî•': 'flame',
            '‚è±Ô∏è': 'timer',
            'üßò': 'flower-2',
            'üèÉ': 'person-standing',
            '‚ù§Ô∏è': 'heart',
            '‚öñÔ∏è': 'scale',
            'üìä': 'bar-chart-3',
            'üéØ': 'target',

            // Time & Schedule
            '‚òÄÔ∏è': 'sun',
            'üåô': 'moon',
            'üåÖ': 'sunrise',
            '‚è∞': 'alarm-clock',
            'üçÖ': 'clock',

            // Food & Nutrition
            'ü•ó': 'salad',
            'üçé': 'apple',
            'üíß': 'droplet',
            'üí¶': 'droplets',
            'ü•§': 'cup-soda',
            '‚òï': 'coffee',

            // Goals & Progress
            '‚ú®': 'sparkles',
            'üèÜ': 'trophy',
            '‚≠ê': 'star',
            'üéâ': 'party-popper',
            '‚úÖ': 'check-circle',
            'üìà': 'trending-up',

            // Categories
            'üíº': 'briefcase',
            'üìö': 'book-open',
            'üè†': 'home',
            'üë§': 'user',
            'üë•': 'users',
            'üí∞': 'wallet',
            'üõí': 'shopping-cart',
            'üéÆ': 'gamepad-2',
            'üì±': 'smartphone',
            'üíª': 'laptop',

            // Misc
            'üîô': 'undo-2',
            'üì∏': 'camera',
            'üí¨': 'message-circle',
            'üè∑Ô∏è': 'tag',
            'üìù': 'file-text',
            'üßπ': 'eraser',
            'üò¥': 'moon',
            'üôè': 'hand',
            'üíä': 'pill',
            'üß¥': 'droplet',
            'üá¨üáß': 'languages'
        };

        // Get icon based on current style
        function getIcon(emoji, size) {
            size = size || 'md';
            if (!isLucideMode()) {
                return emoji;
            }

            var iconName = ICON_MAP[emoji];
            if (!iconName) {
                return emoji; // Fallback to emoji if no mapping
            }

            var sizeClass = '';
            switch(size) {
                case 'xs': sizeClass = 'w-3 h-3'; break;
                case 'sm': sizeClass = 'w-4 h-4'; break;
                case 'md': sizeClass = 'w-5 h-5'; break;
                case 'lg': sizeClass = 'w-6 h-6'; break;
                case 'xl': sizeClass = 'w-8 h-8'; break;
                case '2xl': sizeClass = 'w-10 h-10'; break;
                default: sizeClass = 'w-5 h-5';
            }

            return '<i data-lucide="' + iconName + '" class="' + sizeClass + ' inline-block"></i>';
        }

        // Initialize lucide icons after DOM updates
        function initLucideIcons() {
            if (!window.lucide) return;

            if (isLucideMode()) {
                // Hide app briefly to prevent layout shift
                var app = document.getElementById('app');
                if (app) {
                    app.style.opacity = '0';
                    app.style.transition = 'opacity 0.1s';
                }

                // Replace emojis with Lucide icons immediately
                replaceEmojisWithLucide();
                lucide.createIcons();

                // Show app after replacement
                if (app) {
                    requestAnimationFrame(function() {
                        app.style.opacity = '1';
                    });
                }
            }
        }

        // Replace emojis in the DOM with Lucide icon elements
        function replaceEmojisWithLucide() {
            var app = document.getElementById('app');
            if (!app) return;

            // Get all text nodes and elements that might contain emojis
            var walker = document.createTreeWalker(
                app,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            var textNodes = [];
            var node;
            while (node = walker.nextNode()) {
                // Skip script and style tags
                if (node.parentNode.tagName === 'SCRIPT' || node.parentNode.tagName === 'STYLE') continue;
                // Check if the text contains any emoji from our map
                var hasEmoji = Object.keys(ICON_MAP).some(function(emoji) {
                    return node.textContent.indexOf(emoji) !== -1;
                });
                if (hasEmoji) {
                    textNodes.push(node);
                }
            }

            // Replace emojis in collected text nodes
            textNodes.forEach(function(textNode) {
                var text = textNode.textContent;
                var parent = textNode.parentNode;

                // Skip if parent is an input, textarea, or already processed
                if (parent.tagName === 'INPUT' || parent.tagName === 'TEXTAREA') return;
                if (parent.classList && parent.classList.contains('lucide-processed')) return;

                var hasReplacement = false;
                var html = text;

                Object.keys(ICON_MAP).forEach(function(emoji) {
                    if (html.indexOf(emoji) !== -1) {
                        var iconName = ICON_MAP[emoji];
                        var replacement = '<i data-lucide="' + iconName + '" class="w-5 h-5 inline-block align-middle"></i>';
                        html = html.split(emoji).join(replacement);
                        hasReplacement = true;
                    }
                });

                if (hasReplacement) {
                    var span = document.createElement('span');
                    span.innerHTML = html;
                    span.className = 'lucide-processed';
                    parent.replaceChild(span, textNode);
                }
            });

            // Also handle elements with emoji in specific attributes or as direct content
            var emojiElements = app.querySelectorAll('.text-xl, .text-2xl, .text-3xl, .text-4xl, .text-5xl');
            emojiElements.forEach(function(el) {
                if (el.classList.contains('lucide-processed')) return;
                if (el.children.length > 0) return; // Skip if has child elements

                var text = el.textContent.trim();
                if (ICON_MAP[text]) {
                    var iconName = ICON_MAP[text];
                    var sizeClass = 'w-6 h-6';
                    if (el.classList.contains('text-3xl')) sizeClass = 'w-8 h-8';
                    if (el.classList.contains('text-4xl')) sizeClass = 'w-10 h-10';
                    if (el.classList.contains('text-5xl')) sizeClass = 'w-12 h-12';

                    el.innerHTML = '<i data-lucide="' + iconName + '" class="' + sizeClass + '"></i>';
                    el.classList.add('lucide-processed');
                }
            });
        }

        // Apply dark mode, theme, and view mode on page load
        applyDarkMode();
        applyTheme();
        applyViewMode();

        function logout() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('gestion-currentUser');
                window.location.href = 'login.html';
            }
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        // Open activity setup wizard
        function openActivitySetupWizard() {
            window.location.href = 'activity-setup.html';
        }

        // Sync all data to cloud
        async function syncAllData() {
            if (typeof syncService === 'undefined' || !syncService.userId) {
                alert('No hay conexi√≥n con el servidor. Intenta de nuevo m√°s tarde.');
                return;
            }

            // Show loading notification
            addNotification('Sincronizando datos...', '‚òÅÔ∏è');

            try {
                // Upload all local data to Supabase
                console.log('Starting full sync...');
                await syncService.uploadLocalUserData();

                // Also sync expenses specifically
                const expenses = getExpenses();
                if (expenses.length > 0) {
                    console.log('Syncing', expenses.length, 'expenses...');
                    // Save all expenses to user_data
                    await syncService.saveUserData('expenses', 'expenses', expenses);

                    // Also try to save each to expenses table
                    for (const expense of expenses) {
                        try {
                            await syncService.saveExpense(expense);
                        } catch (e) {
                            console.log('Error syncing expense:', e);
                        }
                    }
                }

                // Sync habits
                const habits = JSON.parse(getStorage('habits') || '{}');
                if (Object.keys(habits).length > 0) {
                    await syncService.saveUserData('habits', 'habits', habits);
                }

                // Sync activities
                const activities = JSON.parse(getStorage('activities') || '{}');
                if (Object.keys(activities).length > 0) {
                    await syncService.saveUserData('activities', 'activities', activities);
                }

                // Sync custom schedules
                const customSchedules = JSON.parse(getStorage('custom-schedules') || '{}');
                if (Object.keys(customSchedules).length > 0) {
                    await syncService.saveUserData('custom-schedules', 'custom-schedules', customSchedules);
                }

                addNotification('Sincronizaci√≥n completada', '‚úÖ');
                console.log('Full sync completed!');
            } catch (error) {
                console.error('Sync error:', error);
                addNotification('Error al sincronizar: ' + error.message, '‚ùå');
            }
        }

        // Floating Buttons Settings
        function getFloatingButtonSettings() {
            return JSON.parse(getStorage('floating-buttons') || '{"pomodoro": true, "expenses": false}');
        }

        function isFloatingButtonEnabled(button) {
            const settings = getFloatingButtonSettings();
            return settings[button] !== false;
        }

        function toggleFloatingButton(button) {
            const settings = getFloatingButtonSettings();
            settings[button] = !settings[button];
            setStorage('floating-buttons', JSON.stringify(settings));
            updateFloatingButtons();
            render(); // Re-render to update toggle UI
        }

        function updateFloatingButtons() {
            const settings = getFloatingButtonSettings();

            const pomodoroBtn = document.getElementById('pomodoroFloatBtn');
            const expensesBtn = document.getElementById('expensesFloatBtn');

            if (pomodoroBtn) {
                pomodoroBtn.classList.toggle('hidden', !settings.pomodoro);
            }
            if (expensesBtn) {
                expensesBtn.classList.toggle('hidden', !settings.expenses);
                // Adjust position based on whether pomodoro is visible
                if (settings.expenses && settings.pomodoro) {
                    expensesBtn.classList.remove('right-6');
                    expensesBtn.classList.add('right-24');
                } else if (settings.expenses) {
                    expensesBtn.classList.remove('right-24');
                    expensesBtn.classList.add('right-6');
                }
            }
        }

        // Initialize floating buttons on load
        document.addEventListener('DOMContentLoaded', updateFloatingButtons);

        // Close settings menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('settingsMenu');
            const settingsBtn = e.target.closest('[onclick*="toggleSettingsMenu"]');
            if (menu && !menu.contains(e.target) && !settingsBtn) {
                menu.classList.add('hidden');
            }
            // Also close notifications menu
            const notifMenu = document.getElementById('notificationsMenu');
            const notifBtn = e.target.closest('[onclick*="toggleNotificationsMenu"]');
            if (notifMenu && !notifMenu.contains(e.target) && !notifBtn) {
                notifMenu.classList.add('hidden');
            }

        });

        // ==================== NOTIFICATIONS SYSTEM ====================

        function getNotifications() {
            return JSON.parse(getStorage('notifications') || '[]');
        }

        function saveNotifications(notifications) {
            setStorage('notifications', JSON.stringify(notifications));
        }

        function getUnreadNotificationsCount() {
            const notifications = getNotifications();
            return notifications.filter(n => !n.read).length;
        }

        function toggleNotificationsMenu() {
            const menu = document.getElementById('notificationsMenu');
            if (menu) {
                const wasHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                if (wasHidden) {
                    renderNotificationsList();
                }
            }
        }

        function renderNotificationsList() {
            const container = document.getElementById('notificationsList');
            if (!container) return;

            const notifications = getNotifications();

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-400">
                        <span class="text-4xl block mb-2">üîï</span>
                        <p>No tienes notificaciones</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map((notif, index) => `
                <div class="px-4 py-3 border-b border-gray-50 hover:bg-gray-50 transition cursor-pointer ${notif.read ? 'opacity-60' : ''}" onclick="markNotificationRead(${index})">
                    <div class="flex items-start gap-3">
                        <span class="text-xl">${notif.icon || 'üìå'}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-800 ${notif.read ? '' : 'font-medium'}">${notif.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${formatNotificationTime(notif.timestamp)}</p>
                        </div>
                        ${notif.read ? '' : '<span class="w-2 h-2 bg-purple-500 rounded-full flex-shrink-0 mt-2"></span>'}
                    </div>
                </div>
            `).join('');
        }

        function formatNotificationTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Ahora mismo';
            if (minutes < 60) return `Hace ${minutes} min`;
            if (hours < 24) return `Hace ${hours} hr`;
            if (days < 7) return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }

        function markNotificationRead(index) {
            const notifications = getNotifications();
            if (notifications[index]) {
                notifications[index].read = true;
                saveNotifications(notifications);
                renderNotificationsList();
                updateNotificationBadge();
            }
        }

        function markAllNotificationsRead() {
            const notifications = getNotifications();
            notifications.forEach(n => n.read = true);
            saveNotifications(notifications);
            renderNotificationsList();
            updateNotificationBadge();
        }

        function clearAllNotifications() {
            saveNotifications([]);
            renderNotificationsList();
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                const count = getUnreadNotificationsCount();
                badge.textContent = count > 9 ? '9+' : count;
                badge.classList.toggle('hidden', count === 0);
            }
        }

        function addNotification(message, icon = 'üìå') {
            const notifications = getNotifications();
            notifications.unshift({
                message,
                icon,
                timestamp: new Date().toISOString(),
                read: false
            });
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications.pop();
            }
            saveNotifications(notifications);
            updateNotificationBadge();
        }

        // Generate notifications based on user activity
        function generateDailyNotifications() {
            const today = getTodayKey();
            const lastNotifDay = getStorage('lastNotificationDay');

            if (lastNotifDay === today) return; // Already generated today

            setStorage('lastNotificationDay', today);

            const dayNum = getDayNumber();
            const userDuration = currentUser.duration || 60;

            // Welcome notification
            if (dayNum === 1) {
                addNotification(`¬°Bienvenido a tu primer d√≠a! üéâ Tu viaje de ${userDuration} d√≠as comienza hoy.`, 'üöÄ');
            }

            // Milestone notifications
            if (dayNum === 7) {
                addNotification('¬°Primera semana completada! üí™ Sigue as√≠.', 'üèÜ');
            } else if (dayNum === 14) {
                addNotification('¬°Dos semanas de progreso! üìà Ya eres un campe√≥n.', 'üåü');
            } else if (dayNum === 30) {
                addNotification('¬°Un mes de dedicaci√≥n! üéä Incre√≠ble logro.', 'üëë');
            } else if (dayNum === Math.floor(userDuration / 2)) {
                addNotification('¬°Mitad del camino! üõ§Ô∏è Ya puedes ver la meta.', 'üéØ');
            }

            // Check yesterday's progress
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().split('T')[0];
            const yesterdayCompleted = JSON.parse(getStorage(`completed-${yesterdayKey}`) || '[]');

            if (yesterdayCompleted.length >= 10) {
                addNotification('¬°Ayer completaste muchas actividades! üî• Excelente trabajo.', '‚≠ê');
            }

            // Motivational based on day of week
            const dayOfWeek = new Date().getDay();
            if (dayOfWeek === 1) { // Monday
                addNotification('¬°Nuevo lunes, nuevas oportunidades! üí™ A darle con todo.', 'üåÖ');
            } else if (dayOfWeek === 5) { // Friday
                addNotification('¬°Viernes! Termina fuerte la semana. üéâ', 'üéä');
            }
        }

        // Call this when app loads
        setTimeout(() => {
            generateDailyNotifications();
            updateNotificationBadge();
        }, 1000);

        // ==================== END NOTIFICATIONS ====================

        // ==================== WEB PUSH REMINDERS ====================

        let reminderInterval = null;
        let notifiedActivities = new Set(); // Track which activities we've already notified

        function getReminderSettings() {
            return JSON.parse(getStorage('reminder-settings') || '{"enabled": false, "minutesBefore": 5}');
        }

        function saveReminderSettings(settings) {
            setStorage('reminder-settings', JSON.stringify(settings));
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert(getLang() === 'en'
                    ? 'This browser does not support notifications'
                    : 'Este navegador no soporta notificaciones');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        async function toggleReminders() {
            const settings = getReminderSettings();

            if (!settings.enabled) {
                // Trying to enable - need permission
                const hasPermission = await requestNotificationPermission();
                if (!hasPermission) {
                    alert(getLang() === 'en'
                        ? 'Please allow notifications in your browser settings to enable reminders'
                        : 'Por favor permite las notificaciones en tu navegador para habilitar recordatorios');
                    return;
                }
                settings.enabled = true;
                startReminderChecker();
                addNotification(getLang() === 'en' ? 'Reminders enabled! üîî' : '¬°Recordatorios activados! üîî', '‚è∞');
            } else {
                settings.enabled = false;
                stopReminderChecker();
                addNotification(getLang() === 'en' ? 'Reminders disabled' : 'Recordatorios desactivados', 'üîï');
            }

            saveReminderSettings(settings);
            render();
        }

        function setReminderMinutes(minutes) {
            const settings = getReminderSettings();
            settings.minutesBefore = parseInt(minutes);
            saveReminderSettings(settings);
        }

        function startReminderChecker() {
            if (reminderInterval) clearInterval(reminderInterval);

            // Check every 30 seconds
            reminderInterval = setInterval(checkUpcomingActivities, 30000);

            // Also check immediately
            checkUpcomingActivities();
        }

        function stopReminderChecker() {
            if (reminderInterval) {
                clearInterval(reminderInterval);
                reminderInterval = null;
            }
        }

        function checkUpcomingActivities() {
            const settings = getReminderSettings();
            if (!settings.enabled) return;

            const now = new Date();
            const todayKey = getDateKey(now);

            // Reset notified activities at midnight
            const currentDay = now.toDateString();
            if (getStorage('lastReminderDay') !== currentDay) {
                notifiedActivities.clear();
                setStorage('lastReminderDay', currentDay);
            }

            const schedule = getSchedule();

            schedule.forEach((activity, idx) => {
                const activityKey = `${todayKey}-${idx}`;

                // Skip if already notified or already completed
                if (notifiedActivities.has(activityKey)) return;
                if (completedActivities[activityKey]) return;

                // Parse activity time
                const [hours, minutes] = activity.time.split(':').map(Number);
                const activityTime = new Date(now);
                activityTime.setHours(hours, minutes, 0, 0);

                // Calculate minutes until activity
                const minutesUntil = (activityTime - now) / (1000 * 60);

                // Check if within reminder window
                if (minutesUntil > 0 && minutesUntil <= settings.minutesBefore) {
                    sendActivityReminder(activity, Math.round(minutesUntil));
                    notifiedActivities.add(activityKey);
                }
            });
        }

        function sendActivityReminder(activity, minutesUntil) {
            if (Notification.permission !== 'granted') return;

            const title = getLang() === 'en' ? '‚è∞ Upcoming Activity' : '‚è∞ Actividad Pr√≥xima';
            const body = getLang() === 'en'
                ? `${activity.activity} in ${minutesUntil} minute${minutesUntil !== 1 ? 's' : ''}`
                : `${activity.activity} en ${minutesUntil} minuto${minutesUntil !== 1 ? 's' : ''}`;

            const notification = new Notification(title, {
                body: body,
                icon: 'üìÖ',
                tag: `activity-${activity.time}`,
                requireInteraction: true
            });

            notification.onclick = () => {
                window.focus();
                notification.close();
            };

            // Auto-close after 30 seconds
            setTimeout(() => notification.close(), 30000);
        }

        // Initialize reminders on page load
        setTimeout(() => {
            const settings = getReminderSettings();
            if (settings.enabled && Notification.permission === 'granted') {
                startReminderChecker();
            }
        }, 2000);

        // ==================== END WEB PUSH REMINDERS ====================

        // Profile Photo Functions
        let cropperState = {
            image: null,
            imgWidth: 0,
            imgHeight: 0,
            posX: 0,
            posY: 0,
            zoom: 100,
            isDragging: false,
            startX: 0,
            startY: 0,
            containerSize: 192 // 48 * 4 = w-48
        };

        function getUserProfile() {
            return JSON.parse(getStorage('user-profile') || '{}');
        }

        function saveUserProfile(profile) {
            setStorage('user-profile', JSON.stringify(profile));
        }

        function openPhotoModal() {
            const modal = document.getElementById('photoModal');
            const preview = document.getElementById('photoPreview');
            const removeBtn = document.getElementById('removePhotoBtn');
            const photo = getStorage('profile-photo');

            // Mostrar vista normal, ocultar editor
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');

            if (photo) {
                preview.innerHTML = `<img src="${photo}" class="w-full h-full object-cover">`;
                removeBtn.classList.remove('hidden');
            } else {
                preview.innerHTML = currentUser.name.charAt(0).toUpperCase();
                removeBtn.classList.add('hidden');
            }

            // Cargar datos del perfil
            const profile = getUserProfile();
            document.getElementById('profileName').value = profile.name || currentUser.name || '';
            document.getElementById('profileEmail').value = profile.email || currentUser.email || '';
            document.getElementById('profilePhone').value = profile.phone || '';
            document.getElementById('profileBirthdate').value = profile.birthdate || '';
            document.getElementById('profileGender').value = profile.gender || '';
            document.getElementById('profileBio').value = profile.bio || '';
            document.getElementById('profileLanguage').value = profile.language || 'es';

            modal.classList.remove('hidden');
        }

        function saveFullProfile() {
            const profile = {
                name: document.getElementById('profileName').value.trim(),
                email: document.getElementById('profileEmail').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                birthdate: document.getElementById('profileBirthdate').value,
                gender: document.getElementById('profileGender').value,
                bio: document.getElementById('profileBio').value.trim(),
                language: document.getElementById('profileLanguage').value
            };

            saveUserProfile(profile);

            // Actualizar el nombre del usuario actual si cambi√≥
            if (profile.name && profile.name !== currentUser.name) {
                currentUser.name = profile.name;
                // Actualizar en la lista de usuarios
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIdx = users.findIndex(u => u.email === currentUser.email);
                if (userIdx >= 0) {
                    users[userIdx].name = profile.name;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }

            closePhotoModal();
            addNotification(t('savedSuccessfully'), '‚úÖ');
            applyTheme(); // Aplicar tema seg√∫n g√©nero
            render();
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (max 15MB original)
            if (file.size > 15 * 1024 * 1024) {
                alert('La imagen es muy grande. M√°ximo 15MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Guardar imagen original
                    cropperState.image = img;
                    cropperState.imgWidth = img.width;
                    cropperState.imgHeight = img.height;
                    cropperState.zoom = 100;

                    // Mostrar editor
                    showCropperEditor(e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Limpiar input para permitir subir la misma imagen
            event.target.value = '';
        }

        function showCropperEditor(imageSrc) {
            // Ocultar vista normal, mostrar editor
            document.getElementById('photoNormalView').classList.add('hidden');
            document.getElementById('photoEditView').classList.remove('hidden');

            const cropperImg = document.getElementById('cropperImage');
            cropperImg.src = imageSrc;

            // Resetear zoom
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomValue').textContent = '100%';
            cropperState.zoom = 100;

            // Calcular tama√±o inicial para que cubra el contenedor
            setTimeout(() => {
                const container = cropperState.containerSize;
                const imgRatio = cropperState.imgWidth / cropperState.imgHeight;

                let displayWidth, displayHeight;
                if (imgRatio > 1) {
                    // Imagen horizontal
                    displayHeight = container;
                    displayWidth = container * imgRatio;
                } else {
                    // Imagen vertical o cuadrada
                    displayWidth = container;
                    displayHeight = container / imgRatio;
                }

                cropperImg.style.width = displayWidth + 'px';
                cropperImg.style.height = displayHeight + 'px';

                // Centrar imagen
                cropperState.posX = (container - displayWidth) / 2;
                cropperState.posY = (container - displayHeight) / 2;
                updateCropperPosition();
            }, 50);
        }

        function updateCropperPosition() {
            const cropperImg = document.getElementById('cropperImage');
            cropperImg.style.left = cropperState.posX + 'px';
            cropperImg.style.top = cropperState.posY + 'px';
        }

        function updateZoom(value) {
            const zoomFactor = value / cropperState.zoom;
            cropperState.zoom = parseInt(value);
            document.getElementById('zoomValue').textContent = value + '%';

            const cropperImg = document.getElementById('cropperImage');
            const container = cropperState.containerSize;
            const imgRatio = cropperState.imgWidth / cropperState.imgHeight;

            let baseWidth, baseHeight;
            if (imgRatio > 1) {
                baseHeight = container;
                baseWidth = container * imgRatio;
            } else {
                baseWidth = container;
                baseHeight = container / imgRatio;
            }

            const newWidth = baseWidth * (value / 100);
            const newHeight = baseHeight * (value / 100);

            // Ajustar posici√≥n para mantener el centro
            const centerX = cropperState.posX + parseFloat(cropperImg.style.width) / 2;
            const centerY = cropperState.posY + parseFloat(cropperImg.style.height) / 2;

            cropperState.posX = centerX - newWidth / 2;
            cropperState.posY = centerY - newHeight / 2;

            cropperImg.style.width = newWidth + 'px';
            cropperImg.style.height = newHeight + 'px';
            updateCropperPosition();
        }

        function startDrag(e) {
            e.preventDefault();
            cropperState.isDragging = true;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropperState.startX = clientX - cropperState.posX;
            cropperState.startY = clientY - cropperState.posY;

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function doDrag(e) {
            if (!cropperState.isDragging) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropperState.posX = clientX - cropperState.startX;
            cropperState.posY = clientY - cropperState.startY;
            updateCropperPosition();
        }

        function stopDrag() {
            cropperState.isDragging = false;
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', doDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        function cancelCrop() {
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');
        }

        function saveCrop() {
            const container = cropperState.containerSize;
            const cropperImg = document.getElementById('cropperImage');

            // Crear canvas para recortar
            const canvas = document.createElement('canvas');
            const outputSize = 400; // Tama√±o final (mayor = mejor calidad)
            canvas.width = outputSize;
            canvas.height = outputSize;
            const ctx = canvas.getContext('2d');

            // Calcular qu√© parte de la imagen original recortar
            const displayWidth = parseFloat(cropperImg.style.width);
            const displayHeight = parseFloat(cropperImg.style.height);
            const scaleX = cropperState.imgWidth / displayWidth;
            const scaleY = cropperState.imgHeight / displayHeight;

            const srcX = -cropperState.posX * scaleX;
            const srcY = -cropperState.posY * scaleY;
            const srcSize = container * scaleX;

            // Dibujar la porci√≥n recortada
            ctx.drawImage(
                cropperState.image,
                srcX, srcY, srcSize, srcSize,
                0, 0, outputSize, outputSize
            );

            // Comprimir con alta calidad
            let photoData = canvas.toDataURL('image/jpeg', 0.92);
            let sizeKB = (photoData.length * 3/4) / 1024;

            // Reducir calidad solo si excede 150KB
            let quality = 0.92;
            while (sizeKB > 150 && quality > 0.5) {
                quality -= 0.05;
                photoData = canvas.toDataURL('image/jpeg', quality);
                sizeKB = (photoData.length * 3/4) / 1024;
            }

            console.log(`Foto guardada: ${Math.round(sizeKB)}KB (calidad: ${Math.round(quality*100)}%)`);

            // Guardar
            setStorage('profile-photo', photoData);

            // Actualizar preview y cerrar editor
            document.getElementById('photoPreview').innerHTML = `<img src="${photoData}" class="w-full h-full object-cover">`;
            document.getElementById('removePhotoBtn').classList.remove('hidden');
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');

            render();
        }

        function removePhoto() {
            if (confirm('¬øEliminar foto de perfil?')) {
                removeStorage('profile-photo');
                document.getElementById('photoPreview').innerHTML = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('removePhotoBtn').classList.add('hidden');
                render();
            }
        }

        function getUserPhoto() {
            return getStorage('profile-photo');
        }

        // Replace All Modal Functions
        let pendingReplaceAll = null; // { type, oldValue, newValue, callback }

        function showReplaceAllModal(type, message, callback) {
            pendingReplaceAll = { type, callback };
            document.getElementById('replaceAllMessage').textContent = message;
            document.getElementById('replaceAllModal').classList.remove('hidden');
        }

        function closeReplaceAllModal() {
            document.getElementById('replaceAllModal').classList.add('hidden');
            pendingReplaceAll = null;
        }

        function confirmReplaceAll(replaceAll) {
            if (pendingReplaceAll && pendingReplaceAll.callback) {
                pendingReplaceAll.callback(replaceAll);
            }
            closeReplaceAllModal();
            render();
        }

        // Goal text mapping
        function getGoalText(goal) {
            const goals = {
                fitness: 'üí™ Mejorando mi f√≠sico',
                productivity: 'üìà Siendo m√°s productivo',
                learning: 'üìö Aprendiendo algo nuevo',
                health: 'ü•ó Mejorando mi salud',
                business: 'üíº Haciendo crecer mi negocio',
                competition: 'üëë Prepar√°ndome para competir',
                personal: '‚ú® Desarrollo personal',
                other: 'üéØ Alcanzando mis metas'
            };
            return goals[goal] || goals.other;
        }

        // Data - User specific dates based on their plan
        const userStartDate = currentUser ? new Date(currentUser.startDate) : new Date();
        const userDuration = currentUser ? currentUser.duration : 60;
        const totalWeeks = Math.ceil(userDuration / 7);
        const startDate = new Date(userStartDate);
        const endDate = new Date(userStartDate);
        endDate.setDate(endDate.getDate() + userDuration - 1);

        let currentDate = new Date();
        // Clamp current date to plan range
        if (currentDate < startDate) currentDate = new Date(startDate);
        if (currentDate > endDate) currentDate = new Date(endDate);

        let activeTab = 'agenda';
        let checkedHabits = JSON.parse(getStorage('habits') || '{}');
        let completedActivities = JSON.parse(getStorage('activities') || '{}');
        let customSchedules = JSON.parse(getStorage('custom-schedules') || '{}');
        let customHabits = JSON.parse(getStorage('custom-habits') || 'null');
        let customGym = JSON.parse(getStorage('custom-gym') || '{}');
        let customMeals = JSON.parse(getStorage('custom-meals') || 'null');
        let customGoals = JSON.parse(getStorage('custom-goals') || 'null');

        let editingIndex = null;
        let deletingIndex = null;
        let deleteType = 'activity';

        // Search and Filter state
        let searchQuery = '';
        let activeFilter = '';
        let searchVisible = false;

        // Dashboard visibility state - hidden by default
        let dashboardVisible = getStorage('dashboard-visible') === 'true';

        // Training Plan Wizard State
        let trainingPlanStep = 1;
        let trainingPlanData = {
            profile: { age: null, sex: null, height: null, weight: null, level: 'beginner', injuries: [] },
            goal: { primary: null, secondary: null },
            availability: { daysPerWeek: 3, preferredTime: 'morning', sessionDuration: 45, selectedDays: [] },
            preferences: { location: 'gym', equipment: ['dumbbells', 'machines'], priorityZones: [], avoidZones: [] }
        };

        // Training Plan Exercise Database
        const TRAINING_EXERCISE_DB = {
            glutes: [
                { name: 'Hip Thrust', equipment: ['barbell', 'machines'], level: 'all', sets: 4, reps: '10-12' },
                { name: 'Romanian Deadlift', equipment: ['barbell', 'dumbbells'], level: 'all', sets: 4, reps: '10-12' },
                { name: 'Bulgarian Split Squat', equipment: ['dumbbells', 'bodyweight'], level: 'intermediate', sets: 3, reps: '10-12' },
                { name: 'Cable Kickback', equipment: ['cables'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Glute Bridge', equipment: ['bodyweight'], level: 'beginner', sets: 3, reps: '15-20' },
                { name: 'Sumo Squat', equipment: ['dumbbells', 'barbell'], level: 'all', sets: 3, reps: '12-15' }
            ],
            legs: [
                { name: 'Squat', equipment: ['barbell', 'machines'], level: 'all', sets: 4, reps: '8-10' },
                { name: 'Leg Press', equipment: ['machines'], level: 'all', sets: 4, reps: '10-12' },
                { name: 'Leg Extension', equipment: ['machines'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Leg Curl', equipment: ['machines'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Lunges', equipment: ['dumbbells', 'bodyweight'], level: 'all', sets: 3, reps: '10-12' },
                { name: 'Calf Raises', equipment: ['machines', 'bodyweight'], level: 'all', sets: 4, reps: '15-20' }
            ],
            chest: [
                { name: 'Bench Press', equipment: ['barbell'], level: 'all', sets: 4, reps: '8-10' },
                { name: 'Incline DB Press', equipment: ['dumbbells'], level: 'all', sets: 3, reps: '10-12' },
                { name: 'Cable Flyes', equipment: ['cables'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Push Ups', equipment: ['bodyweight'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Chest Press Machine', equipment: ['machines'], level: 'beginner', sets: 3, reps: '10-12' }
            ],
            back: [
                { name: 'Lat Pulldown', equipment: ['cables', 'machines'], level: 'all', sets: 4, reps: '10-12' },
                { name: 'Barbell Row', equipment: ['barbell'], level: 'intermediate', sets: 4, reps: '8-10' },
                { name: 'Seated Cable Row', equipment: ['cables'], level: 'all', sets: 3, reps: '10-12' },
                { name: 'Pull Ups', equipment: ['bodyweight'], level: 'intermediate', sets: 3, reps: '8-12' },
                { name: 'Dumbbell Row', equipment: ['dumbbells'], level: 'all', sets: 3, reps: '10-12' },
                { name: 'Face Pulls', equipment: ['cables'], level: 'all', sets: 3, reps: '15-20' }
            ],
            shoulders: [
                { name: 'Overhead Press', equipment: ['barbell', 'dumbbells'], level: 'all', sets: 4, reps: '8-10' },
                { name: 'Lateral Raises', equipment: ['dumbbells', 'cables'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Front Raises', equipment: ['dumbbells'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Rear Delt Flyes', equipment: ['dumbbells', 'cables'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Arnold Press', equipment: ['dumbbells'], level: 'intermediate', sets: 3, reps: '10-12' }
            ],
            arms: [
                { name: 'Bicep Curls', equipment: ['dumbbells', 'barbell', 'cables'], level: 'all', sets: 3, reps: '10-12' },
                { name: 'Tricep Pushdown', equipment: ['cables'], level: 'all', sets: 3, reps: '12-15' },
                { name: 'Hammer Curls', equipment: ['dumbbells'], level: 'all', sets: 3, reps: '10-12' },
                { name: 'Skull Crushers', equipment: ['barbell', 'dumbbells'], level: 'intermediate', sets: 3, reps: '10-12' },
                { name: 'Tricep Dips', equipment: ['bodyweight'], level: 'intermediate', sets: 3, reps: '10-15' },
                { name: 'Preacher Curls', equipment: ['barbell', 'dumbbells'], level: 'all', sets: 3, reps: '10-12' }
            ],
            core: [
                { name: 'Plank', equipment: ['bodyweight'], level: 'all', sets: 3, reps: '30-60s' },
                { name: 'Cable Crunch', equipment: ['cables'], level: 'all', sets: 3, reps: '15-20' },
                { name: 'Hanging Leg Raise', equipment: ['bodyweight'], level: 'intermediate', sets: 3, reps: '10-15' },
                { name: 'Russian Twist', equipment: ['bodyweight', 'dumbbells'], level: 'all', sets: 3, reps: '20-30' },
                { name: 'Dead Bug', equipment: ['bodyweight'], level: 'beginner', sets: 3, reps: '10-12' },
                { name: 'Ab Wheel Rollout', equipment: ['bodyweight'], level: 'advanced', sets: 3, reps: '8-12' }
            ]
        };

        // Training Split Types
        const TRAINING_SPLIT_TYPES = {
            3: {
                full_body: { name: 'Full Body', routine: ['full', 'full', 'full'], icon: 'üîÑ' },
                push_pull_legs: { name: 'Push/Pull/Legs', routine: ['push', 'pull', 'legs'], icon: 'üí™' }
            },
            4: {
                upper_lower: { name: 'Upper/Lower', routine: ['upper', 'lower', 'upper', 'lower'], icon: '‚¨ÜÔ∏è‚¨áÔ∏è' },
                push_pull: { name: 'Push/Pull 2x', routine: ['push', 'pull', 'push', 'pull'], icon: 'üîÅ' }
            },
            5: {
                ppl_upper_lower: { name: 'PPL + Upper/Lower', routine: ['push', 'pull', 'legs', 'upper', 'lower'], icon: 'üìÖ' },
                bro_split: { name: 'Bro Split', routine: ['chest', 'back', 'shoulders', 'legs', 'arms'], icon: 'üí•' }
            },
            6: {
                ppl_2x: { name: 'PPL 2x/semana', routine: ['push', 'pull', 'legs', 'push', 'pull', 'legs'], icon: 'üî•' }
            }
        };

        // Exercise Info Database (descriptions and images) - ALL with unique photos
        const EXERCISE_INFO = {
            // === PECHO (CHEST) ===
            'Bench Press': {
                spanish: 'Press de Banca',
                muscle: 'Pecho',
                description: 'Acostado en un banco plano, baja la barra al pecho y empuja hacia arriba. Mant√©n los pies firmes en el suelo y la espalda ligeramente arqueada.',
                tips: 'Agarra la barra un poco m√°s ancho que los hombros. Baja controladamente y explota al subir.',
                image: 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=400&h=300&fit=crop'
            },
            'Incline DB Press': {
                spanish: 'Press Inclinado con Mancuernas',
                muscle: 'Pecho superior',
                description: 'En banco inclinado (30-45¬∞), presiona las mancuernas hacia arriba desde los hombros.',
                tips: 'No inclines demasiado el banco. Junta las mancuernas arriba sin chocarlas.',
                image: 'https://images.unsplash.com/photo-1583454110551-21f2fa2afe61?w=400&h=300&fit=crop'
            },
            'Cable Flyes': {
                spanish: 'Aperturas en Polea',
                muscle: 'Pecho',
                description: 'De pie entre poleas, junta las manos al frente en un movimiento de abrazo.',
                tips: 'Codos ligeramente flexionados. Aprieta el pecho al juntar las manos.',
                image: 'https://images.unsplash.com/photo-1597452485677-d661670d9640?w=400&h=300&fit=crop'
            },
            'Push Ups': {
                spanish: 'Flexiones',
                muscle: 'Pecho, tr√≠ceps',
                description: 'Boca abajo, empuja el cuerpo hacia arriba manteniendo el cuerpo recto.',
                tips: 'Manos a la anchura de hombros. Baja hasta que el pecho casi toque el suelo.',
                image: 'https://images.unsplash.com/photo-1598971639058-fab3c3109a00?w=400&h=300&fit=crop'
            },
            'Chest Press Machine': {
                spanish: 'Press de Pecho en M√°quina',
                muscle: 'Pecho',
                description: 'Sentado en la m√°quina, empuja las manijas hacia adelante extendiendo los brazos.',
                tips: 'Ajusta el asiento para que las manijas est√©n a la altura del pecho. Controla el movimiento.',
                image: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=400&h=300&fit=crop'
            },

            // === ESPALDA (BACK) ===
            'Lat Pulldown': {
                spanish: 'Jal√≥n al Pecho',
                muscle: 'Dorsales',
                description: 'Sentado, jala la barra hacia el pecho superior, apretando los dorsales.',
                tips: 'Incl√≠nate ligeramente hacia atr√°s. Lleva los codos hacia abajo y atr√°s.',
                image: 'https://images.unsplash.com/photo-1605296867304-46d5465a13f1?w=400&h=300&fit=crop'
            },
            'Barbell Row': {
                spanish: 'Remo con Barra',
                muscle: 'Espalda media',
                description: 'Inclinado hacia adelante, jala la barra hacia el abdomen bajo apretando la espalda.',
                tips: 'Espalda recta, core apretado. Jala con los codos, no con los brazos.',
                image: 'https://images.unsplash.com/photo-1603287681836-b174ce5074c2?w=400&h=300&fit=crop'
            },
            'Seated Cable Row': {
                spanish: 'Remo Sentado en Polea',
                muscle: 'Espalda media',
                description: 'Sentado, jala el agarre hacia el abdomen manteniendo el torso erguido.',
                tips: 'No te inclines hacia atr√°s. Aprieta los om√≥platos al final.',
                image: 'https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?w=400&h=300&fit=crop'
            },
            'Pull Ups': {
                spanish: 'Dominadas',
                muscle: 'Espalda, b√≠ceps',
                description: 'Colgado de una barra, j√°late hacia arriba hasta que la barbilla pase la barra.',
                tips: 'Agarre m√°s ancho que hombros. Aprieta dorsales al subir.',
                image: 'https://images.unsplash.com/photo-1598266663439-2056e6900339?w=400&h=300&fit=crop'
            },
            'Dumbbell Row': {
                spanish: 'Remo con Mancuerna',
                muscle: 'Espalda',
                description: 'Apoyado en banco con una mano, jala la mancuerna hacia la cadera.',
                tips: 'Codo cerca del cuerpo. Aprieta el dorsal arriba.',
                image: 'https://images.unsplash.com/photo-1532029837206-abbe2b7620e3?w=400&h=300&fit=crop'
            },
            'Face Pulls': {
                spanish: 'Tir√≥n a la Cara',
                muscle: 'Deltoides posterior, trapecios',
                description: 'En polea alta, jala la cuerda hacia la cara separando las manos.',
                tips: 'Codos altos. Aprieta los om√≥platos. Excelente para postura.',
                image: 'https://images.unsplash.com/photo-1576678927484-cc907957088c?w=400&h=300&fit=crop'
            },

            // === HOMBROS (SHOULDERS) ===
            'Overhead Press': {
                spanish: 'Press Militar',
                muscle: 'Hombros',
                description: 'De pie o sentado, presiona la barra/mancuernas desde los hombros hacia arriba.',
                tips: 'Core apretado. No arquees la espalda. Extiende completamente arriba.',
                image: 'https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?w=400&h=300&fit=crop'
            },
            'Lateral Raises': {
                spanish: 'Elevaciones Laterales',
                muscle: 'Deltoides lateral',
                description: 'De pie, eleva las mancuernas a los lados hasta la altura de los hombros.',
                tips: 'Codos ligeramente flexionados. Controla la bajada. No uses impulso.',
                image: 'https://images.unsplash.com/photo-1581009146145-b5ef050c149a?w=400&h=300&fit=crop'
            },
            'Front Raises': {
                spanish: 'Elevaciones Frontales',
                muscle: 'Deltoides anterior',
                description: 'De pie, eleva las mancuernas al frente hasta la altura de los hombros.',
                tips: 'Brazos casi rectos. Alterna brazos o hazlo simult√°neo. Sin balanceo.',
                image: 'https://images.unsplash.com/photo-1584863231364-2edc166de576?w=400&h=300&fit=crop'
            },
            'Rear Delt Flyes': {
                spanish: 'Aperturas para Deltoides Posterior',
                muscle: 'Deltoides posterior',
                description: 'Inclinado hacia adelante, eleva las mancuernas a los lados apretando la espalda alta.',
                tips: 'Codos ligeramente flexionados. Aprieta los om√≥platos al subir.',
                image: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop'
            },
            'Arnold Press': {
                spanish: 'Press Arnold',
                muscle: 'Hombros completos',
                description: 'Sentado, comienza con mancuernas frente a ti y rota mientras presionas hacia arriba.',
                tips: 'Rotaci√≥n suave durante el movimiento. Creado por Arnold Schwarzenegger.',
                image: 'https://images.unsplash.com/photo-1583454110551-21f2fa2afe61?w=400&h=300&fit=crop'
            },

            // === PIERNAS (LEGS) ===
            'Squat': {
                spanish: 'Sentadilla',
                muscle: 'Piernas completas',
                description: 'Con la barra en la espalda alta, baja flexionando rodillas y caderas hasta que los muslos est√©n paralelos al suelo.',
                tips: 'Rodillas en l√≠nea con los pies. Pecho arriba. Baja hasta romper el paralelo.',
                image: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=400&h=300&fit=crop'
            },
            'Leg Press': {
                spanish: 'Prensa de Piernas',
                muscle: 'Cu√°driceps, gl√∫teos',
                description: 'Sentado en la m√°quina, empuja la plataforma con los pies hasta extender las piernas (sin bloquear rodillas).',
                tips: 'Pies a la anchura de hombros. No bajes demasiado para proteger la espalda baja.',
                image: 'https://images.unsplash.com/photo-1434608519344-49d77a699e1d?w=400&h=300&fit=crop'
            },
            'Leg Extension': {
                spanish: 'Extensi√≥n de Piernas',
                muscle: 'Cu√°driceps',
                description: 'Sentado en la m√°quina, extiende las piernas hasta que est√©n rectas, apretando los cu√°driceps.',
                tips: 'Movimiento controlado. Aprieta arriba por 1 segundo.',
                image: 'https://images.unsplash.com/photo-1534368786749-b63e05c90863?w=400&h=300&fit=crop'
            },
            'Leg Curl': {
                spanish: 'Curl de Piernas',
                muscle: 'Isquiotibiales',
                description: 'Acostado boca abajo, flexiona las piernas llevando los talones hacia los gl√∫teos.',
                tips: 'No uses impulso. Contrae los isquios en cada repetici√≥n.',
                image: 'https://images.unsplash.com/photo-1597347316205-36f6c451902a?w=400&h=300&fit=crop'
            },
            'Lunges': {
                spanish: 'Zancadas',
                muscle: 'Piernas, gl√∫teos',
                description: 'Da un paso adelante y baja hasta que ambas rodillas formen 90 grados.',
                tips: 'Rodilla delantera no pasa la punta del pie. Torso erguido.',
                image: 'https://images.unsplash.com/photo-1609899464726-209befafa5c3?w=400&h=300&fit=crop'
            },
            'Calf Raises': {
                spanish: 'Elevaciones de Pantorrilla',
                muscle: 'Pantorrillas',
                description: 'De pie, el√©vate sobre las puntas de los pies y baja controladamente.',
                tips: 'Pausa arriba 1 segundo. Baja completamente para estirar.',
                image: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop'
            },

            // === GL√öTEOS (GLUTES) ===
            'Hip Thrust': {
                spanish: 'Empuje de Cadera',
                muscle: 'Gl√∫teos',
                description: 'Espalda apoyada en banco, barra sobre la cadera. Empuja la cadera hacia arriba apretando gl√∫teos.',
                tips: 'Aprieta fuerte los gl√∫teos arriba. Barbilla al pecho. No hiperextiendas.',
                image: 'https://images.unsplash.com/photo-1574680178050-55c6a6a96e0a?w=400&h=300&fit=crop'
            },
            'Romanian Deadlift': {
                spanish: 'Peso Muerto Rumano',
                muscle: 'Isquiotibiales, gl√∫teos',
                description: 'De pie con barra, baja el torso manteniendo piernas casi rectas, sintiendo estiramiento en isquios.',
                tips: 'Espalda recta siempre. La barra roza las piernas. Rodillas ligeramente flexionadas.',
                image: 'https://images.unsplash.com/photo-1599058917765-a780eda07a3e?w=400&h=300&fit=crop'
            },
            'Bulgarian Split Squat': {
                spanish: 'Sentadilla B√∫lgara',
                muscle: 'Cu√°driceps, gl√∫teos',
                description: 'Pie trasero elevado en banco, baja en sentadilla con la pierna delantera.',
                tips: 'Torso erguido. Rodilla delantera en l√≠nea con el pie.',
                image: 'https://images.unsplash.com/photo-1434682881908-b43d0467b798?w=400&h=300&fit=crop'
            },
            'Cable Kickback': {
                spanish: 'Patada en Polea',
                muscle: 'Gl√∫teos',
                description: 'Con tobillera en polea baja, extiende la pierna hacia atr√°s apretando gl√∫teo.',
                tips: 'No arquees la espalda. Movimiento controlado.',
                image: 'https://images.unsplash.com/photo-1518611012118-696072aa579a?w=400&h=300&fit=crop'
            },
            'Glute Bridge': {
                spanish: 'Puente de Gl√∫teos',
                muscle: 'Gl√∫teos',
                description: 'Acostado boca arriba, eleva la cadera apretando los gl√∫teos.',
                tips: 'Aprieta fuerte arriba. Rodillas a 90 grados.',
                image: 'https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=400&h=300&fit=crop'
            },
            'Sumo Squat': {
                spanish: 'Sentadilla Sumo',
                muscle: 'Aductores, gl√∫teos',
                description: 'Sentadilla con pies muy separados y puntas hacia afuera.',
                tips: 'Rodillas siguen la direcci√≥n de los pies. Baja profundo.',
                image: 'https://images.unsplash.com/photo-1566241142559-40e1dab266c6?w=400&h=300&fit=crop'
            },

            // === BRAZOS (ARMS) ===
            'Bicep Curls': {
                spanish: 'Curl de B√≠ceps',
                muscle: 'B√≠ceps',
                description: 'De pie, flexiona los codos llevando las mancuernas hacia los hombros.',
                tips: 'Codos pegados al cuerpo. No balancees. Aprieta arriba.',
                image: 'https://images.unsplash.com/photo-1581009146145-b5ef050c149a?w=400&h=300&fit=crop'
            },
            'Tricep Pushdown': {
                spanish: 'Extensi√≥n de Tr√≠ceps en Polea',
                muscle: 'Tr√≠ceps',
                description: 'En polea alta, empuja la barra hacia abajo extendiendo los codos.',
                tips: 'Codos pegados al cuerpo. Solo mueve el antebrazo.',
                image: 'https://images.unsplash.com/photo-1597347316205-36f6c451902a?w=400&h=300&fit=crop'
            },
            'Hammer Curls': {
                spanish: 'Curl Martillo',
                muscle: 'B√≠ceps, antebrazo',
                description: 'Curl con mancuernas manteniendo las palmas mir√°ndose entre s√≠.',
                tips: 'Mismo movimiento que curl normal pero con agarre neutro.',
                image: 'https://images.unsplash.com/photo-1583454155184-870a1f63be96?w=400&h=300&fit=crop'
            },
            'Skull Crushers': {
                spanish: 'Rompecr√°neos',
                muscle: 'Tr√≠ceps',
                description: 'Acostado, baja la barra hacia la frente flexionando solo los codos.',
                tips: 'Codos apuntando al techo. Movimiento solo en el codo.',
                image: 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=400&h=300&fit=crop'
            },
            'Tricep Dips': {
                spanish: 'Fondos de Tr√≠ceps',
                muscle: 'Tr√≠ceps, pecho',
                description: 'En barras paralelas, baja el cuerpo flexionando los codos y sube empujando.',
                tips: 'Incl√≠nate hacia adelante para m√°s pecho, recto para m√°s tr√≠ceps.',
                image: 'https://images.unsplash.com/photo-1598266663439-2056e6900339?w=400&h=300&fit=crop'
            },
            'Preacher Curls': {
                spanish: 'Curl en Banco Scott',
                muscle: 'B√≠ceps',
                description: 'Brazos apoyados en banco inclinado, curl con barra o mancuernas.',
                tips: 'Excelente para aislar el b√≠ceps. No balancees.',
                image: 'https://images.unsplash.com/photo-1581009146145-b5ef050c149a?w=400&h=300&fit=crop'
            },

            // === CORE ===
            'Plank': {
                spanish: 'Plancha',
                muscle: 'Core completo',
                description: 'Apoyado en antebrazos y puntas de pies, mant√©n el cuerpo recto como una tabla.',
                tips: 'Gl√∫teos apretados. No dejes caer la cadera. Respira normal.',
                image: 'https://images.unsplash.com/photo-1566241142559-40e1dab266c6?w=400&h=300&fit=crop'
            },
            'Cable Crunch': {
                spanish: 'Crunch en Polea',
                muscle: 'Abdominales',
                description: 'De rodillas frente a polea alta, flexiona el tronco hacia abajo contrayendo abdominales.',
                tips: 'No jales con los brazos. El movimiento es del core.',
                image: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop'
            },
            'Hanging Leg Raise': {
                spanish: 'Elevaci√≥n de Piernas Colgado',
                muscle: 'Abdominales inferiores',
                description: 'Colgado de una barra, eleva las piernas rectas hasta la horizontal.',
                tips: 'No balancees. Controla la bajada. Flexiona rodillas si es muy dif√≠cil.',
                image: 'https://images.unsplash.com/photo-1598266663439-2056e6900339?w=400&h=300&fit=crop'
            },
            'Russian Twist': {
                spanish: 'Giro Ruso',
                muscle: 'Oblicuos',
                description: 'Sentado con pies elevados, gira el torso de lado a lado con o sin peso.',
                tips: 'Mant√©n la espalda recta. El movimiento es del core, no de los brazos.',
                image: 'https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=400&h=300&fit=crop'
            },
            'Dead Bug': {
                spanish: 'Bicho Muerto',
                muscle: 'Core profundo',
                description: 'Acostado boca arriba, extiende brazo y pierna opuestos mientras mantienes espalda baja pegada al suelo.',
                tips: 'Espalda baja siempre pegada al suelo. Movimiento lento y controlado.',
                image: 'https://images.unsplash.com/photo-1518611012118-696072aa579a?w=400&h=300&fit=crop'
            },
            'Ab Wheel Rollout': {
                spanish: 'Rueda Abdominal',
                muscle: 'Core completo',
                description: 'De rodillas, rueda hacia adelante extendiendo el cuerpo y regresa apretando abdominales.',
                tips: 'Mant√©n el core apretado. No dejes caer la cadera. Avanza solo lo que controles.',
                image: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop'
            }
        };

        // Exercise Info Modal Functions
        function openExerciseInfoModal(exerciseName) {
            const info = EXERCISE_INFO[exerciseName];
            const modal = document.getElementById('exerciseInfoModal');

            // Set content
            document.getElementById('exerciseInfoName').textContent = exerciseName;

            if (info) {
                document.getElementById('exerciseInfoSpanish').textContent = info.spanish || '';
                document.getElementById('exerciseInfoMuscle').textContent = info.muscle || 'General';
                document.getElementById('exerciseInfoDescription').textContent = info.description || 'Sin descripci√≥n disponible.';
                document.getElementById('exerciseInfoTips').textContent = info.tips || 'Mant√©n buena forma y controla el movimiento.';

                // Set image
                const imageContainer = document.getElementById('exerciseInfoImage');
                if (info.image) {
                    imageContainer.innerHTML = `<img src="${info.image}" alt="${exerciseName}" class="w-full h-full object-cover">`;
                } else {
                    imageContainer.innerHTML = '<span class="text-6xl">üèãÔ∏è</span>';
                }
            } else {
                // Default info for unknown exercises
                document.getElementById('exerciseInfoSpanish').textContent = '';
                document.getElementById('exerciseInfoMuscle').textContent = 'General';
                document.getElementById('exerciseInfoDescription').textContent = 'Informaci√≥n no disponible para este ejercicio. Consulta con un entrenador para la t√©cnica correcta.';
                document.getElementById('exerciseInfoTips').textContent = 'Mant√©n buena postura, controla el movimiento y no uses demasiado peso.';
                document.getElementById('exerciseInfoImage').innerHTML = '<span class="text-6xl">üèãÔ∏è</span>';
            }

            modal.classList.remove('hidden');

            // Initialize Lucide icons in modal
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function closeExerciseInfoModal() {
            document.getElementById('exerciseInfoModal').classList.add('hidden');
        }

        // Routine type definitions for exercise selection
        const ROUTINE_MUSCLES = {
            push: ['chest', 'shoulders', 'arms'],
            pull: ['back', 'arms'],
            legs: ['legs', 'glutes'],
            upper: ['chest', 'back', 'shoulders', 'arms'],
            lower: ['legs', 'glutes', 'core'],
            full: ['chest', 'back', 'shoulders', 'legs', 'glutes', 'core'],
            chest: ['chest'],
            back: ['back'],
            shoulders: ['shoulders'],
            arms: ['arms'],
            core: ['core']
        };

        const daysSpanish = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const monthsSpanish = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        const defaultGymFocus = {
            0: { name: "Descanso Activo", icon: "üßò", exercises: ["Yoga suave 30-45min", "Estiramientos profundos 20min", "Caminata ligera opcional", "Meditaci√≥n con movimiento 15min"] },
            1: { name: "Gl√∫teos + Cu√°driceps", icon: "üçë", exercises: ["Hip Thrust con barra 4x12", "Sentadilla profunda 4x10", "Prensa inclinada 4x12", "Zancadas caminando 3x12", "Extensi√≥n cu√°driceps 3x15", "Abductores m√°quina 3x20"] },
            2: { name: "Isquios + Gl√∫teos", icon: "ü¶µ", exercises: ["Peso muerto rumano 4x10", "Curl femoral acostada 4x12", "Patada gl√∫teo polea 3x15", "Puente gl√∫teos elevado 4x15", "Good mornings 3x12", "Hip abduction 3x20"] },
            3: { name: "Tren Superior + Core", icon: "üí™", exercises: ["Press pecho mancuernas 3x12", "Remo mancuerna 3x12", "Press hombro 3x12", "Curl b√≠ceps 3x15", "Tr√≠ceps polea 3x15", "Plancha 3x30seg + Crunches 3x20"] },
            4: { name: "Piernas + HIIT", icon: "üî•", exercises: ["Sentadilla b√∫lgara 4x10", "Leg press pies juntos 4x12", "Step ups con peso 3x12", "Curl femoral sentada 3x15", "HIIT: Burpees, Jumping jacks 4 rondas"] },
            5: { name: "Gl√∫teos (√©nfasis) + Brazos", icon: "‚ú®", exercises: ["Hip thrust unilateral 4x12", "Sumo squat mancuerna 4x15", "Kickbacks polea 3x15", "Frog pumps 3x25", "Curl martillo 3x12", "Fondos tr√≠ceps 3x12"] },
            6: { name: "Baile + Stretching", icon: "üíÉ", exercises: ["Clase baile/gimnasia 60-90min", "Estiramiento din√°mico 15min", "Foam roller piernas 15min", "Yoga flow 20min"] }
        };

        function getGymFocus(dayIndex) {
            // Check if gym has been cleared by reset
            if (customGym.__cleared__) {
                return customGym[dayIndex] || { name: "", icon: "üí™", exercises: [] };
            }
            if (customGym[dayIndex]) {
                return customGym[dayIndex];
            }
            return defaultGymFocus[dayIndex];
        }

        const defaultHabits = [
            { id: 1, name: "Despertar 7:00 AM", icon: "‚òÄÔ∏è" },
            { id: 2, name: "Agua al despertar (500ml)", icon: "üíß" },
            { id: 3, name: "Suplementos tomados", icon: "üíä" },
            { id: 4, name: "Meditaci√≥n 30 min", icon: "üßò" },
            { id: 5, name: "Afirmaciones positivas", icon: "‚ú®" },
            { id: 6, name: "Desayuno proteico", icon: "ü•ó" },
            { id: 7, name: "Clase de ingl√©s", icon: "üá¨üáß" },
            { id: 8, name: "Skincare AM", icon: "üß¥" },
            { id: 9, name: "Entrenamiento completado", icon: "üí™" },
            { id: 10, name: "Post-entreno proteico", icon: "ü•§" },
            { id: 11, name: "Contenido RRSS creado", icon: "üì∏" },
            { id: 12, name: "Publicado en RRSS", icon: "üì±" },
            { id: 13, name: "Interacci√≥n audiencia", icon: "üí¨" },
            { id: 14, name: "Cena sin az√∫car", icon: "ü•¶" },
            { id: 15, name: "Skincare PM + celulitis", icon: "üåô" },
            { id: 16, name: "Gratitud (3 cosas)", icon: "üôè" },
            { id: 17, name: "En cama 22:00", icon: "üò¥" },
            { id: 18, name: "3L agua bebidos", icon: "üí¶" }
        ];

        function getHabits() {
            return customHabits || defaultHabits;
        }

        const defaultMeals = [
            { time: "07:45", name: "Desayuno", emoji: "üåÖ", options: ["Avena + prote√≠na + frutos rojos", "Huevos revueltos + verduras + tostada integral", "Smoothie bowl proteico con semillas"], macros: "P:30g | C:45g | G:15g" },
            { time: "10:30", name: "Snack AM", emoji: "üçé", options: ["Yogurt griego + nueces", "Fruta + almendras", "Batido verde proteico"], macros: "P:15g | C:20g | G:10g" },
            { time: "12:00", name: "Almuerzo", emoji: "ü•ó", options: ["Prote√≠na 150g (pollo/pescado/pavo)", "Carbohidrato complejo 1 taza", "Vegetales variados ilimitados", "Grasa saludable (aguacate)"], macros: "P:40g | C:50g | G:15g" },
            { time: "16:00", name: "Post-Entreno", emoji: "üí™", options: ["Prote√≠na whey + banana + leche vegetal", "Yogurt griego + granola sin az√∫car"], macros: "P:30g | C:30g | G:5g" },
            { time: "20:00", name: "Cena", emoji: "üåô", options: ["Prote√≠na magra 120g", "Vegetales al vapor o ensalada grande", "Sin carbohidratos pesados"], macros: "P:35g | C:20g | G:12g" }
        ];

        function getMeals() {
            return customMeals || defaultMeals;
        }

        const defaultWeeklyGoals = [
            { week: 1, dates: "2-8 Feb", fisica: "Establecer rutina gym. Medir peso inicial", personal: "Inicio ingl√©s intensivo + pasarela", digital: "Crear web b√°sica", espiritual: "Establecer meditaci√≥n diaria" },
            { week: 2, dates: "9-15 Feb", fisica: "Ajustar plan nutricional. -0.5kg grasa", personal: "Mejorar pronunciaci√≥n ingl√©s", digital: "5 posts. Contactar marcas", espiritual: "Journaling diario" },
            { week: 3, dates: "16-22 Feb", fisica: "Incrementar peso en gl√∫teos", personal: "Conversaciones b√°sicas ingl√©s", digital: "12K seguidores. Portafolio", espiritual: "Bajar autoexigencia" },
            { week: 4, dates: "23 Feb-1 Mar", fisica: "Definici√≥n visible piernas", personal: "Presentaci√≥n en ingl√©s", digital: "15K. Primera colaboraci√≥n", espiritual: "Sin episodios nerviosismo" },
            { week: 5, dates: "2-8 Mar", fisica: "Abdominales marcados", personal: "Fluidez conversacional", digital: "Blog semanal. 5%+ engagement", espiritual: "Manejo emocional estable" },
            { week: 6, dates: "9-15 Mar", fisica: "Gl√∫teos definidos. Verificar 58kg", personal: "Speech en ingl√©s listo", digital: "17K. Contenido viral", espiritual: "Autoconfianza alta" },
            { week: 7, dates: "16-22 Mar", fisica: "Cuerpo √≥ptimo. Piel radiante", personal: "Ingl√©s intermedio-alto", digital: "19K. Portafolio completo", espiritual: "Nervios controlados" },
            { week: 8, dates: "23-30 Mar", fisica: "üéØ 58kg, definici√≥n total", personal: "üéØ Ingl√©s fluido, pasarela 100%", digital: "üéØ 20K+, marca s√≥lida", espiritual: "üéØ Confianza total" }
        ];

        function getWeeklyGoals() {
            return customGoals || defaultWeeklyGoals;
        }

        // Community Templates - Plantillas de usuarios que otros pueden cargar
        const communityTemplates = [
            {
                id: 'arantxa_miss_universo',
                name: 'Plan Miss Universo - Arantxa',
                author: 'Arantxa Ram√≠rez',
                description: 'Plan de 90 d√≠as para preparaci√≥n Miss Universo: fitness, ingl√©s, pasarela y redes sociales.',
                icon: 'üëë',
                duration: 90,
                goal: 'salud',
                gymFocus: {
                    0: { name: "Descanso Activo", icon: "üßò", exercises: ["Yoga suave 30-45min", "Estiramientos profundos 20min", "Caminata ligera opcional", "Meditaci√≥n con movimiento 15min"] },
                    1: { name: "Gl√∫teos + Cu√°driceps", icon: "üçë", exercises: ["Hip Thrust con barra 4x12", "Sentadilla profunda 4x10", "Prensa inclinada 4x12", "Zancadas caminando 3x12", "Extensi√≥n cu√°driceps 3x15", "Abductores m√°quina 3x20"] },
                    2: { name: "Isquios + Gl√∫teos", icon: "ü¶µ", exercises: ["Peso muerto rumano 4x10", "Curl femoral acostada 4x12", "Patada gl√∫teo polea 3x15", "Puente gl√∫teos elevado 4x15", "Good mornings 3x12", "Hip abduction 3x20"] },
                    3: { name: "Tren Superior + Core", icon: "üí™", exercises: ["Press pecho mancuernas 3x12", "Remo mancuerna 3x12", "Press hombro 3x12", "Curl b√≠ceps 3x15", "Tr√≠ceps polea 3x15", "Plancha 3x30seg + Crunches 3x20"] },
                    4: { name: "Piernas + HIIT", icon: "üî•", exercises: ["Sentadilla b√∫lgara 4x10", "Leg press pies juntos 4x12", "Step ups con peso 3x12", "Curl femoral sentada 3x15", "HIIT: Burpees, Jumping jacks 4 rondas"] },
                    5: { name: "Gl√∫teos (√©nfasis) + Brazos", icon: "‚ú®", exercises: ["Hip thrust unilateral 4x12", "Sumo squat mancuerna 4x15", "Kickbacks polea 3x15", "Frog pumps 3x25", "Curl martillo 3x12", "Fondos tr√≠ceps 3x12"] },
                    6: { name: "Baile + Stretching", icon: "üíÉ", exercises: ["Clase baile/gimnasia 60-90min", "Estiramiento din√°mico 15min", "Foam roller piernas 15min", "Yoga flow 20min"] }
                },
                habits: [
                    { id: 1, name: "Despertar 7:00 AM", icon: "‚òÄÔ∏è" },
                    { id: 2, name: "Agua al despertar (500ml)", icon: "üíß" },
                    { id: 3, name: "Suplementos tomados", icon: "üíä" },
                    { id: 4, name: "Meditaci√≥n 30 min", icon: "üßò" },
                    { id: 5, name: "Afirmaciones positivas", icon: "‚ú®" },
                    { id: 6, name: "Desayuno proteico", icon: "ü•ó" },
                    { id: 7, name: "Clase de ingl√©s", icon: "üá¨üáß" },
                    { id: 8, name: "Skincare AM", icon: "üß¥" },
                    { id: 9, name: "Entrenamiento completado", icon: "üí™" },
                    { id: 10, name: "Post-entreno proteico", icon: "ü•§" },
                    { id: 11, name: "Contenido RRSS creado", icon: "üì∏" },
                    { id: 12, name: "Publicado en RRSS", icon: "üì±" },
                    { id: 13, name: "Interacci√≥n audiencia", icon: "üí¨" },
                    { id: 14, name: "Cena sin az√∫car", icon: "ü•¶" },
                    { id: 15, name: "Skincare PM + celulitis", icon: "üåô" },
                    { id: 16, name: "Gratitud (3 cosas)", icon: "üôè" },
                    { id: 17, name: "En cama 22:00", icon: "üò¥" },
                    { id: 18, name: "3L agua bebidos", icon: "üí¶" }
                ],
                meals: [
                    { time: "07:45", name: "Desayuno", emoji: "üåÖ", options: ["Avena + prote√≠na + frutos rojos", "Huevos revueltos + verduras + tostada integral", "Smoothie bowl proteico con semillas"], macros: "P:30g | C:45g | G:15g" },
                    { time: "10:30", name: "Snack AM", emoji: "üçé", options: ["Yogurt griego + nueces", "Fruta + almendras", "Batido verde proteico"], macros: "P:15g | C:20g | G:10g" },
                    { time: "12:00", name: "Almuerzo", emoji: "ü•ó", options: ["Prote√≠na 150g (pollo/pescado/pavo)", "Carbohidrato complejo 1 taza", "Vegetales variados ilimitados", "Grasa saludable (aguacate)"], macros: "P:40g | C:50g | G:15g" },
                    { time: "16:00", name: "Post-Entreno", emoji: "üí™", options: ["Prote√≠na whey + banana + leche vegetal", "Yogurt griego + granola sin az√∫car"], macros: "P:30g | C:30g | G:5g" },
                    { time: "20:00", name: "Cena", emoji: "üåô", options: ["Prote√≠na magra 120g", "Vegetales al vapor o ensalada grande", "Sin carbohidratos pesados"], macros: "P:35g | C:20g | G:12g" }
                ],
                weeklyGoals: [
                    { week: 1, dates: "Semana 1", fisica: "Establecer rutina gym. Medir peso inicial", personal: "Inicio ingl√©s intensivo + pasarela", digital: "Crear web b√°sica", espiritual: "Establecer meditaci√≥n diaria" },
                    { week: 2, dates: "Semana 2", fisica: "Ajustar plan nutricional. -0.5kg grasa", personal: "Mejorar pronunciaci√≥n ingl√©s", digital: "5 posts. Contactar marcas", espiritual: "Journaling diario" },
                    { week: 3, dates: "Semana 3", fisica: "Incrementar peso en gl√∫teos", personal: "Conversaciones b√°sicas ingl√©s", digital: "12K seguidores. Portafolio", espiritual: "Bajar autoexigencia" },
                    { week: 4, dates: "Semana 4", fisica: "Definici√≥n visible piernas", personal: "Presentaci√≥n en ingl√©s", digital: "15K. Primera colaboraci√≥n", espiritual: "Sin episodios nerviosismo" },
                    { week: 5, dates: "Semana 5", fisica: "Abdominales marcados", personal: "Fluidez conversacional", digital: "Blog semanal. 5%+ engagement", espiritual: "Manejo emocional estable" },
                    { week: 6, dates: "Semana 6", fisica: "Gl√∫teos definidos. Verificar 58kg", personal: "Speech en ingl√©s listo", digital: "17K. Contenido viral", espiritual: "Autoconfianza alta" },
                    { week: 7, dates: "Semana 7", fisica: "Cuerpo √≥ptimo. Piel radiante", personal: "Ingl√©s intermedio-alto", digital: "19K. Portafolio completo", espiritual: "Nervios controlados" },
                    { week: 8, dates: "Semana 8", fisica: "üéØ 58kg, definici√≥n total", personal: "üéØ Ingl√©s fluido, pasarela 100%", digital: "üéØ 20K+, marca s√≥lida", espiritual: "üéØ Confianza total" }
                ],
                weekdaySchedule: [
                    { time: "06:45", activity: "Despertar + Agua tibia con lim√≥n üçã", duration: "15 min", category: "habitos" },
                    { time: "07:00", activity: "Suplementos: Creatina + Omega 3 + Vitamina C", duration: "15 min", category: "nutricion" },
                    { time: "07:15", activity: "Meditaci√≥n guiada + Afirmaciones ‚ú®", duration: "30 min", category: "espiritual" },
                    { time: "07:45", activity: "Desayuno proteico", duration: "45 min", category: "nutricion" },
                    { time: "08:30", activity: "Clase de Ingl√©s Intensivo üá¨üáß", duration: "2 hrs", category: "personal" },
                    { time: "10:30", activity: "Snack saludable + Hidrataci√≥n", duration: "30 min", category: "nutricion" },
                    { time: "11:00", activity: "Skincare facial + Cuidado capilar üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "fisico" },
                    { time: "12:00", activity: "Almuerzo balanceado", duration: "1 hr", category: "nutricion" },
                    { time: "13:00", activity: "Descanso / Lectura / Journaling üìñ", duration: "1 hr", category: "espiritual" },
                    { time: "14:00", activity: "Gimnasio: Entrenamiento del d√≠a üí™", duration: "2 hrs", category: "fisico" },
                    { time: "16:00", activity: "Batido proteico post-entreno ü•§", duration: "30 min", category: "nutricion" },
                    { time: "16:30", activity: "Clase de Pasarela (estilo Sheynnis Palacios) üë†", duration: "1.5 hrs", category: "personal" },
                    { time: "18:00", activity: "Creaci√≥n contenido RRSS üì∏", duration: "1 hr", category: "digital" },
                    { time: "19:00", activity: "Publicar + Interactuar audiencia üì±", duration: "30 min", category: "digital" },
                    { time: "19:30", activity: "Revisar m√©tricas + Planificar üìä", duration: "30 min", category: "digital" },
                    { time: "20:00", activity: "Cena saludable", duration: "1 hr", category: "nutricion" },
                    { time: "21:00", activity: "Skincare nocturno + Tratamiento celulitis üåô", duration: "30 min", category: "fisico" },
                    { time: "21:30", activity: "Gratitud + Preparar ma√±ana üôè", duration: "30 min", category: "espiritual" },
                    { time: "22:00", activity: "DORMIR üò¥ (9 horas)", duration: "9 hrs", category: "descanso" }
                ],
                weekendSchedule: [
                    { time: "07:00", activity: "Despertar + Hidrataci√≥n üíß", duration: "15 min", category: "habitos" },
                    { time: "07:15", activity: "Suplementos matutinos", duration: "15 min", category: "nutricion" },
                    { time: "07:30", activity: "Meditaci√≥n + Afirmaciones ‚ú®", duration: "30 min", category: "espiritual" },
                    { time: "08:00", activity: "Desayuno proteico", duration: "1 hr", category: "nutricion" },
                    { time: "09:00", activity: "Clase de Baile / Gimnasia üíÉ", duration: "1.5 hrs", category: "personal" },
                    { time: "10:30", activity: "Snack + Hidrataci√≥n", duration: "30 min", category: "nutricion" },
                    { time: "11:00", activity: "Sesi√≥n fotos / Contenido semanal üì∏", duration: "2 hrs", category: "digital" },
                    { time: "13:00", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                    { time: "14:00", activity: "Descanso / Autocuidado üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "espiritual" },
                    { time: "15:00", activity: "Trabajo en P√°gina Web / Portafolio üíª", duration: "2 hrs", category: "digital" },
                    { time: "17:00", activity: "Cardio suave + Stretching üßò", duration: "1 hr", category: "fisico" },
                    { time: "18:00", activity: "Programar contenido semanal", duration: "1 hr", category: "digital" },
                    { time: "19:00", activity: "Tiempo libre / Social üëØ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "personal" },
                    { time: "20:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                    { time: "21:00", activity: "Rutina nocturna + Planificaci√≥n üåô", duration: "1 hr", category: "espiritual" },
                    { time: "22:00", activity: "DORMIR üò¥", duration: "9 hrs", category: "descanso" }
                ]
            },
            // PLANTILLA 2: EMPRENDEDOR / STARTUP FOUNDER
            {
                id: 'emprendedor_startup',
                name: 'Plan Emprendedor - Startup Mode',
                author: 'Carlos M√©ndez',
                description: 'Plan para founders y emprendedores: productividad extrema, networking, desarrollo de negocio y bienestar.',
                icon: 'üöÄ',
                duration: 60,
                goal: 'productividad',
                gymFocus: {
                    0: { name: "Descanso Activo", icon: "üßò", exercises: ["Caminata al aire libre 45min", "Estiramientos 20min", "Meditaci√≥n guiada 15min", "Lectura recreativa"] },
                    1: { name: "Full Body Express", icon: "üí™", exercises: ["Sentadillas 4x12", "Press banca 4x10", "Remo con barra 4x10", "Plancha 3x45seg", "Burpees 3x10"] },
                    2: { name: "Cardio HIIT", icon: "üî•", exercises: ["HIIT 20min (sprints)", "Jumping jacks 3x30", "Mountain climbers 3x20", "Box jumps 3x12", "Core circuit 10min"] },
                    3: { name: "Tren Superior", icon: "üèãÔ∏è", exercises: ["Press militar 4x10", "Dominadas asistidas 4x8", "Curl b√≠ceps 3x12", "Tr√≠ceps fondos 3x12", "Face pulls 3x15"] },
                    4: { name: "Piernas + Core", icon: "ü¶µ", exercises: ["Peso muerto 4x8", "Prensa 4x12", "Zancadas 3x12", "Leg curl 3x15", "Abdominales 4x20"] },
                    5: { name: "Funcional", icon: "‚ö°", exercises: ["Kettlebell swings 4x15", "Turkish get-up 3x5", "Farmer walks 3x30m", "Battle ropes 3x30seg", "Stretching 15min"] },
                    6: { name: "Deporte/Recreativo", icon: "üéæ", exercises: ["Deporte favorito 60-90min", "Padel, tenis, f√∫tbol, nataci√≥n", "Estiramientos post-actividad"] }
                },
                habits: [
                    { id: 1, name: "Despertar 6:00 AM", icon: "‚è∞" },
                    { id: 2, name: "No revisar celular 30min", icon: "üìµ" },
                    { id: 3, name: "Journaling matutino", icon: "üìù" },
                    { id: 4, name: "Bloque deep work AM", icon: "üéØ" },
                    { id: 5, name: "Inbox zero", icon: "üìß" },
                    { id: 6, name: "1 llamada networking", icon: "ü§ù" },
                    { id: 7, name: "Ejercicio completado", icon: "üí™" },
                    { id: 8, name: "Lectura 30min", icon: "üìö" },
                    { id: 9, name: "Revisar m√©tricas negocio", icon: "üìä" },
                    { id: 10, name: "Planificar ma√±ana", icon: "üìã" },
                    { id: 11, name: "Gratitud 3 cosas", icon: "üôè" },
                    { id: 12, name: "Dormir antes de 23:00", icon: "üò¥" }
                ],
                meals: [
                    { time: "06:30", name: "Pre-workout", emoji: "‚ö°", options: ["Caf√© negro + banana", "T√© verde + tostada integral"], macros: "P:5g | C:25g | G:2g" },
                    { time: "08:30", name: "Desayuno", emoji: "üåÖ", options: ["Huevos + aguacate + pan integral", "Overnight oats con prote√≠na", "Smoothie verde proteico"], macros: "P:30g | C:40g | G:15g" },
                    { time: "12:30", name: "Almuerzo", emoji: "ü•ó", options: ["Bowl proteico con quinoa", "Pollo a la plancha + verduras", "Salm√≥n + arroz integral"], macros: "P:40g | C:50g | G:15g" },
                    { time: "16:00", name: "Snack", emoji: "ü•ú", options: ["Frutos secos + fruta", "Yogurt griego + granola", "Prote√≠na + almendras"], macros: "P:15g | C:20g | G:12g" },
                    { time: "20:00", name: "Cena", emoji: "üåô", options: ["Prote√≠na ligera + ensalada", "Sopa de verduras + pollo", "Pescado al horno + vegetales"], macros: "P:35g | C:25g | G:10g" }
                ],
                weeklyGoals: [
                    { week: 1, dates: "Semana 1", fisica: "Establecer rutina ejercicio", personal: "Definir OKRs del trimestre", digital: "Auditar presencia online", espiritual: "Implementar meditaci√≥n diaria" },
                    { week: 2, dates: "Semana 2", fisica: "Cardio 3x por semana", personal: "5 reuniones networking", digital: "Optimizar LinkedIn", espiritual: "Journaling consistente" },
                    { week: 3, dates: "Semana 3", fisica: "Agregar entrenamiento fuerza", personal: "Pitch deck actualizado", digital: "Estrategia contenido", espiritual: "Reducir tiempo pantalla" },
                    { week: 4, dates: "Semana 4", fisica: "Rutina completa establecida", personal: "10 leads calificados", digital: "Newsletter lanzada", espiritual: "Balance trabajo-vida" },
                    { week: 5, dates: "Semana 5", fisica: "Incrementar intensidad", personal: "2 propuestas enviadas", digital: "500 nuevos seguidores", espiritual: "Gesti√≥n estr√©s mejorada" },
                    { week: 6, dates: "Semana 6", fisica: "Medir progreso f√≠sico", personal: "Cerrar primer cliente", digital: "Engagement +20%", espiritual: "Dormir 7hrs consistente" },
                    { week: 7, dates: "Semana 7", fisica: "Mantener consistencia", personal: "Pipeline de ventas s√≥lido", digital: "Automatizar marketing", espiritual: "Hobbies fuera trabajo" },
                    { week: 8, dates: "Semana 8", fisica: "üéØ H√°bito ejercicio s√≥lido", personal: "üéØ Revenue goal alcanzado", digital: "üéØ Marca personal establecida", espiritual: "üéØ Equilibrio logrado" }
                ],
                weekdaySchedule: [
                    { time: "06:00", activity: "Despertar + Agua + No celular üìµ", duration: "30 min", category: "habitos" },
                    { time: "06:30", activity: "Ejercicio / Gym üí™", duration: "1 hr", category: "fisico" },
                    { time: "07:30", activity: "Ducha + Prepararse", duration: "30 min", category: "habitos" },
                    { time: "08:00", activity: "Desayuno + Journaling üìù", duration: "30 min", category: "nutricion" },
                    { time: "08:30", activity: "Deep Work - Bloque 1 üéØ", duration: "2 hrs", category: "personal" },
                    { time: "10:30", activity: "Snack + Revisar emails üìß", duration: "30 min", category: "nutricion" },
                    { time: "11:00", activity: "Reuniones / Llamadas networking ü§ù", duration: "1.5 hrs", category: "personal" },
                    { time: "12:30", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                    { time: "13:30", activity: "Deep Work - Bloque 2 üöÄ", duration: "2 hrs", category: "personal" },
                    { time: "15:30", activity: "Snack + Pausa activa", duration: "30 min", category: "nutricion" },
                    { time: "16:00", activity: "Tareas administrativas / M√©tricas üìä", duration: "1.5 hrs", category: "digital" },
                    { time: "17:30", activity: "Contenido / LinkedIn / RRSS üì±", duration: "1 hr", category: "digital" },
                    { time: "18:30", activity: "Cierre del d√≠a + Planificar ma√±ana üìã", duration: "30 min", category: "personal" },
                    { time: "19:00", activity: "Tiempo personal / Familia üë®‚Äçüë©‚Äçüëß", duration: "1 hr", category: "espiritual" },
                    { time: "20:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                    { time: "21:00", activity: "Lectura / Aprendizaje üìö", duration: "1 hr", category: "personal" },
                    { time: "22:00", activity: "Rutina nocturna + Gratitud üôè", duration: "30 min", category: "espiritual" },
                    { time: "22:30", activity: "DORMIR üò¥", duration: "7.5 hrs", category: "descanso" }
                ],
                weekendSchedule: [
                    { time: "07:30", activity: "Despertar natural + Agua ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                    { time: "08:00", activity: "Desayuno tranquilo", duration: "1 hr", category: "nutricion" },
                    { time: "09:00", activity: "Deporte recreativo / Ejercicio üéæ", duration: "1.5 hrs", category: "fisico" },
                    { time: "10:30", activity: "Ducha + Snack", duration: "30 min", category: "habitos" },
                    { time: "11:00", activity: "Revisi√≥n semanal + Planning üìã", duration: "1 hr", category: "personal" },
                    { time: "12:00", activity: "Aprendizaje / Curso online üíª", duration: "1 hr", category: "personal" },
                    { time: "13:00", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                    { time: "14:00", activity: "Tiempo libre / Hobbies üé®", duration: "2 hrs", category: "espiritual" },
                    { time: "16:00", activity: "Networking informal / Social ‚òï", duration: "2 hrs", category: "personal" },
                    { time: "18:00", activity: "Preparar semana siguiente", duration: "1 hr", category: "personal" },
                    { time: "19:00", activity: "Tiempo familiar / Pareja ‚ù§Ô∏è", duration: "2 hrs", category: "espiritual" },
                    { time: "21:00", activity: "Cena ligera", duration: "1 hr", category: "nutricion" },
                    { time: "22:00", activity: "Relax + Dormir üò¥", duration: "8 hrs", category: "descanso" }
                ]
            },
            // PLANTILLA 3: ESTUDIANTE UNIVERSITARIO
            {
                id: 'estudiante_universitario',
                name: 'Plan Estudiante - Alto Rendimiento',
                author: 'Mar√≠a Gonz√°lez',
                description: 'Plan para estudiantes universitarios: estudio efectivo, ex√°menes, vida social y bienestar mental.',
                icon: 'üìö',
                duration: 120,
                goal: 'estudio',
                gymFocus: {
                    0: { name: "Descanso Total", icon: "üò¥", exercises: ["Dormir hasta tarde permitido", "Paseo relajado", "Actividad social libre", "Preparar semana"] },
                    1: { name: "Cardio Ligero", icon: "üèÉ", exercises: ["Correr 30min", "Caminata r√°pida 45min", "Bicicleta est√°tica 30min", "Estiramientos 15min"] },
                    2: { name: "Fuerza Express", icon: "üí™", exercises: ["Circuito full body 30min", "Sentadillas 3x15", "Flexiones 3x12", "Plancha 3x30seg", "Abdominales 3x20"] },
                    3: { name: "Yoga/Stretching", icon: "üßò", exercises: ["Yoga para estudiantes 45min", "Estiramientos de espalda", "Ejercicios posturales", "Respiraci√≥n profunda"] },
                    4: { name: "HIIT Corto", icon: "üî•", exercises: ["HIIT 20min", "Tabata 4 rondas", "Jumping jacks", "Burpees", "Mountain climbers"] },
                    5: { name: "Deporte Grupal", icon: "‚öΩ", exercises: ["F√∫tbol/B√°squet/V√≥ley con amigos", "Cualquier deporte 60min", "Actividad recreativa"] },
                    6: { name: "Actividad Libre", icon: "üéØ", exercises: ["Ejercicio que disfrutes", "Nataci√≥n, baile, caminata", "Sin presi√≥n, solo mover el cuerpo"] }
                },
                habits: [
                    { id: 1, name: "Despertar consistente", icon: "‚è∞" },
                    { id: 2, name: "Desayuno nutritivo", icon: "ü•£" },
                    { id: 3, name: "Revisar agenda del d√≠a", icon: "üìÖ" },
                    { id: 4, name: "Bloque estudio Pomodoro", icon: "üçÖ" },
                    { id: 5, name: "Tomar apuntes activos", icon: "üìù" },
                    { id: 6, name: "Ejercicio 30min m√≠nimo", icon: "üèÉ" },
                    { id: 7, name: "Beber 2L agua", icon: "üíß" },
                    { id: 8, name: "Repasar del d√≠a", icon: "üîÑ" },
                    { id: 9, name: "Preparar mochila", icon: "üéí" },
                    { id: 10, name: "Desconectar pantallas 22:00", icon: "üìµ" },
                    { id: 11, name: "8 horas de sue√±o", icon: "üò¥" }
                ],
                meals: [
                    { time: "08:00", name: "Desayuno", emoji: "üåÖ", options: ["Avena con frutas y miel", "Tostadas + huevo + jugo", "Cereal integral + leche + banana"], macros: "P:15g | C:50g | G:10g" },
                    { time: "11:00", name: "Snack Uni", emoji: "üçé", options: ["Fruta + barra de cereal", "Sandwich peque√±o", "Yogurt + nueces"], macros: "P:8g | C:25g | G:8g" },
                    { time: "14:00", name: "Almuerzo", emoji: "üçΩÔ∏è", options: ["Men√∫ universitario balanceado", "Tupperware de casa", "Prote√≠na + carbohidrato + verdura"], macros: "P:30g | C:60g | G:15g" },
                    { time: "17:30", name: "Merienda Estudio", emoji: "‚òï", options: ["Caf√©/t√© + galletas integrales", "Fruta + chocolate negro", "Smoothie energ√©tico"], macros: "P:5g | C:30g | G:8g" },
                    { time: "21:00", name: "Cena", emoji: "üåô", options: ["Cena ligera en casa", "Ensalada completa", "Sopa + pan integral"], macros: "P:25g | C:35g | G:12g" }
                ],
                weeklyGoals: [
                    { week: 1, dates: "Semana 1", fisica: "Establecer rutina ejercicio", personal: "Organizar material por materia", digital: "Apps estudio configuradas", espiritual: "Horario sue√±o fijo" },
                    { week: 2, dates: "Semana 2", fisica: "3 d√≠as ejercicio m√≠nimo", personal: "T√©cnica Pomodoro dominada", digital: "Calendario digital al d√≠a", espiritual: "Gestionar ansiedad ex√°menes" },
                    { week: 3, dates: "Semana 3", fisica: "Incluir yoga/stretching", personal: "Grupo de estudio formado", digital: "Flashcards digitales", espiritual: "Balance estudio-ocio" },
                    { week: 4, dates: "Semana 4", fisica: "Energ√≠a estable todo el d√≠a", personal: "Primeros parciales OK", digital: "Notas organizadas en la nube", espiritual: "T√©cnicas anti-estr√©s" },
                    { week: 5, dates: "Semana 5", fisica: "Mantener consistencia", personal: "Tutor√≠as si necesario", digital: "Backup de todo", espiritual: "Tiempo para hobbies" },
                    { week: 6, dates: "Semana 6", fisica: "Ejercicio como h√°bito", personal: "Avance en trabajos", digital: "Productividad medida", espiritual: "Red de apoyo activa" },
                    { week: 7, dates: "Semana 7", fisica: "Preparaci√≥n pre-finales", personal: "Repasos completos", digital: "Material de estudio listo", espiritual: "Confianza en preparaci√≥n" },
                    { week: 8, dates: "Semana 8", fisica: "üéØ Cuerpo activo y sano", personal: "üéØ Ex√°menes aprobados", digital: "üéØ Sistema estudio efectivo", espiritual: "üéØ Bienestar mental OK" }
                ],
                weekdaySchedule: [
                    { time: "07:30", activity: "Despertar + Prepararse üöø", duration: "30 min", category: "habitos" },
                    { time: "08:00", activity: "Desayuno nutritivo ü•£", duration: "30 min", category: "nutricion" },
                    { time: "08:30", activity: "Traslado a universidad / Repasar üìñ", duration: "30 min", category: "personal" },
                    { time: "09:00", activity: "Clases de la ma√±ana üìö", duration: "3 hrs", category: "personal" },
                    { time: "12:00", activity: "Snack + Socializar con compa√±eros ‚òï", duration: "30 min", category: "nutricion" },
                    { time: "12:30", activity: "Clases del mediod√≠a üìö", duration: "1.5 hrs", category: "personal" },
                    { time: "14:00", activity: "Almuerzo üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                    { time: "15:00", activity: "Estudio en biblioteca - Pomodoro üçÖ", duration: "2 hrs", category: "personal" },
                    { time: "17:00", activity: "Ejercicio / Deporte üèÉ", duration: "1 hr", category: "fisico" },
                    { time: "18:00", activity: "Merienda + Descanso", duration: "30 min", category: "nutricion" },
                    { time: "18:30", activity: "Estudio grupal / Trabajos üë•", duration: "1.5 hrs", category: "personal" },
                    { time: "20:00", activity: "Traslado a casa / Podcast educativo üéß", duration: "30 min", category: "personal" },
                    { time: "20:30", activity: "Cena en familia üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                    { time: "21:30", activity: "Repaso del d√≠a + Preparar ma√±ana üìù", duration: "30 min", category: "personal" },
                    { time: "22:00", activity: "Tiempo libre / Relax üìµ", duration: "1 hr", category: "espiritual" },
                    { time: "23:00", activity: "DORMIR üò¥", duration: "8 hrs", category: "descanso" }
                ],
                weekendSchedule: [
                    { time: "09:00", activity: "Despertar natural ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                    { time: "09:30", activity: "Desayuno tranquilo", duration: "1 hr", category: "nutricion" },
                    { time: "10:30", activity: "Estudio intensivo - Bloque 1 üìö", duration: "2 hrs", category: "personal" },
                    { time: "12:30", activity: "Ejercicio / Deporte con amigos ‚öΩ", duration: "1.5 hrs", category: "fisico" },
                    { time: "14:00", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                    { time: "15:00", activity: "Tiempo libre / Hobbies üéÆ", duration: "2 hrs", category: "espiritual" },
                    { time: "17:00", activity: "Estudio - Bloque 2 / Trabajos üìù", duration: "2 hrs", category: "personal" },
                    { time: "19:00", activity: "Social / Amigos / Pareja üë´", duration: "2 hrs", category: "espiritual" },
                    { time: "21:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                    { time: "22:00", activity: "Preparar semana + Organizar üìã", duration: "30 min", category: "personal" },
                    { time: "22:30", activity: "Relax + Dormir üò¥", duration: "8.5 hrs", category: "descanso" }
                ]
            },
            // PLANTILLA 4: PROFESIONAL DE OFICINA
            {
                id: 'profesional_oficina',
                name: 'Plan Profesional - Work-Life Balance',
                author: 'Andrea Torres',
                description: 'Plan para profesionales de oficina: combatir sedentarismo, productividad laboral y tiempo de calidad personal.',
                icon: 'üíº',
                duration: 90,
                goal: 'balance',
                gymFocus: {
                    0: { name: "Descanso Activo", icon: "üå≥", exercises: ["Caminata en naturaleza 60min", "Estiramientos suaves", "Actividad familiar/social", "Desconexi√≥n total"] },
                    1: { name: "Cardio Pre-Trabajo", icon: "üèÉ", exercises: ["Correr 30-40min", "El√≠ptica 35min", "Bicicleta 40min", "Estiramientos 10min"] },
                    2: { name: "Fuerza Tren Superior", icon: "üí™", exercises: ["Press banca 4x10", "Remo 4x10", "Press hombro 3x12", "B√≠ceps/tr√≠ceps 3x12", "Core 3x20"] },
                    3: { name: "Yoga Oficina", icon: "üßò", exercises: ["Yoga para oficinistas 45min", "Estiramientos cuello/espalda", "Ejercicios posturales", "Meditaci√≥n 10min"] },
                    4: { name: "Fuerza Tren Inferior", icon: "ü¶µ", exercises: ["Sentadillas 4x12", "Peso muerto 4x10", "Prensa 4x12", "Zancadas 3x12", "Gemelos 3x20"] },
                    5: { name: "HIIT Express", icon: "üî•", exercises: ["HIIT 25min", "Circuito metab√≥lico", "Sin equipamiento necesario", "Ducha y al fin de semana"] },
                    6: { name: "Actividad Recreativa", icon: "üéæ", exercises: ["Deporte con amigos/pareja", "Padel, tenis, nataci√≥n", "Caminata larga", "Lo que disfrutes"] }
                },
                habits: [
                    { id: 1, name: "Despertar 6:30 AM", icon: "‚è∞" },
                    { id: 2, name: "Ejercicio matutino", icon: "üèÉ" },
                    { id: 3, name: "Desayuno sin prisa", icon: "ü•£" },
                    { id: 4, name: "Planificar 3 MIT del d√≠a", icon: "üéØ" },
                    { id: 5, name: "Pausas activas c/2hrs", icon: "üö∂" },
                    { id: 6, name: "Almuerzo fuera del escritorio", icon: "ü•ó" },
                    { id: 7, name: "Beber 2L agua", icon: "üíß" },
                    { id: 8, name: "Salir del trabajo a tiempo", icon: "üö™" },
                    { id: 9, name: "Tiempo calidad familia/pareja", icon: "‚ù§Ô∏è" },
                    { id: 10, name: "Sin trabajo despu√©s de cena", icon: "üìµ" },
                    { id: 11, name: "Leer 20min antes de dormir", icon: "üìñ" },
                    { id: 12, name: "Dormir 7-8 horas", icon: "üò¥" }
                ],
                meals: [
                    { time: "07:00", name: "Desayuno", emoji: "üåÖ", options: ["Avena + prote√≠na + caf√©", "Tostadas integrales + huevo + fruta", "Smoothie completo + pan"], macros: "P:25g | C:45g | G:12g" },
                    { time: "10:30", name: "Snack Oficina", emoji: "‚òï", options: ["Frutos secos + t√© verde", "Yogurt + fruta", "Barra proteica"], macros: "P:10g | C:15g | G:8g" },
                    { time: "13:00", name: "Almuerzo", emoji: "ü•ó", options: ["Meal prep de casa", "Ensalada completa + prote√≠na", "Bowl saludable"], macros: "P:35g | C:50g | G:15g" },
                    { time: "17:00", name: "Pre-salida", emoji: "üçé", options: ["Fruta + pu√±ado nueces", "T√© + galletas integrales"], macros: "P:5g | C:20g | G:8g" },
                    { time: "20:30", name: "Cena", emoji: "üåô", options: ["Prote√≠na + verduras", "Cena ligera y temprana", "Sopa/crema + pan integral"], macros: "P:30g | C:30g | G:10g" }
                ],
                weeklyGoals: [
                    { week: 1, dates: "Semana 1", fisica: "Establecer hora gym fija", personal: "Auditar uso del tiempo", digital: "Limpiar email/notificaciones", espiritual: "Definir prioridades vida" },
                    { week: 2, dates: "Semana 2", fisica: "4 d√≠as ejercicio", personal: "L√≠mites trabajo claros", digital: "Automatizar tareas repetitivas", espiritual: "Meditaci√≥n 10min/d√≠a" },
                    { week: 3, dates: "Semana 3", fisica: "Incluir pausas activas", personal: "Hobby retomado", digital: "Tiempo pantalla reducido", espiritual: "Gratitud diaria" },
                    { week: 4, dates: "Semana 4", fisica: "Postura mejorada", personal: "Calidad tiempo familia", digital: "Productividad sin horas extra", espiritual: "Estr√©s laboral controlado" },
                    { week: 5, dates: "Semana 5", fisica: "Energ√≠a todo el d√≠a", personal: "Vacaciones planeadas", digital: "Inbox bajo control", espiritual: "Desconexi√≥n fin de semana" },
                    { week: 6, dates: "Semana 6", fisica: "Fuerza incrementada", personal: "Relaciones fortalecidas", digital: "Reuniones optimizadas", espiritual: "Prop√≥sito claro" },
                    { week: 7, dates: "Semana 7", fisica: "Consistencia total", personal: "Desarrollo profesional activo", digital: "Balance digital logrado", espiritual: "Paz mental estable" },
                    { week: 8, dates: "Semana 8", fisica: "üéØ Sedentarismo vencido", personal: "üéØ Work-life balance real", digital: "üéØ Productivo sin burnout", espiritual: "üéØ Felicidad sostenible" }
                ],
                weekdaySchedule: [
                    { time: "06:00", activity: "Despertar + Ejercicio matutino üèÉ", duration: "1 hr", category: "fisico" },
                    { time: "07:00", activity: "Ducha + Prepararse para oficina", duration: "30 min", category: "habitos" },
                    { time: "07:30", activity: "Desayuno tranquilo (sin prisa) ü•£", duration: "30 min", category: "nutricion" },
                    { time: "08:00", activity: "Traslado al trabajo üöó", duration: "30 min", category: "personal" },
                    { time: "08:30", activity: "Trabajo - Bloque productivo AM üíº", duration: "2 hrs", category: "personal" },
                    { time: "10:30", activity: "Pausa activa + Snack + Caf√© ‚òï", duration: "15 min", category: "nutricion" },
                    { time: "10:45", activity: "Reuniones / Colaboraci√≥n üë•", duration: "1.5 hrs", category: "personal" },
                    { time: "12:15", activity: "Pausa activa - Estiramientos üßò", duration: "15 min", category: "fisico" },
                    { time: "12:30", activity: "Almuerzo FUERA del escritorio ü•ó", duration: "1 hr", category: "nutricion" },
                    { time: "13:30", activity: "Trabajo - Bloque productivo PM üíº", duration: "2.5 hrs", category: "personal" },
                    { time: "16:00", activity: "Snack + Pausa activa", duration: "15 min", category: "nutricion" },
                    { time: "16:15", activity: "Cierre de pendientes + Emails üìß", duration: "1.5 hrs", category: "personal" },
                    { time: "17:45", activity: "Planificar ma√±ana + SALIR A TIEMPO üö™", duration: "15 min", category: "personal" },
                    { time: "18:00", activity: "Traslado a casa (podcast/m√∫sica) üéß", duration: "30 min", category: "espiritual" },
                    { time: "18:30", activity: "Tiempo personal / Hobby üé®", duration: "1 hr", category: "espiritual" },
                    { time: "19:30", activity: "Tiempo calidad familia/pareja ‚ù§Ô∏è", duration: "1 hr", category: "espiritual" },
                    { time: "20:30", activity: "Cena (sin trabajo despu√©s) üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                    { time: "21:30", activity: "Relax + Lectura üìñ", duration: "1 hr", category: "espiritual" },
                    { time: "22:30", activity: "DORMIR üò¥", duration: "7.5 hrs", category: "descanso" }
                ],
                weekendSchedule: [
                    { time: "08:00", activity: "Despertar natural (sin alarma) ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                    { time: "08:30", activity: "Desayuno especial en familia ü•û", duration: "1 hr", category: "nutricion" },
                    { time: "09:30", activity: "Ejercicio / Deporte recreativo üéæ", duration: "1.5 hrs", category: "fisico" },
                    { time: "11:00", activity: "Mandados / Compras de la semana üõí", duration: "1.5 hrs", category: "habitos" },
                    { time: "12:30", activity: "Snack ligero", duration: "30 min", category: "nutricion" },
                    { time: "13:00", activity: "Cocinar comida de la semana (batch) üç≥", duration: "2 hrs", category: "nutricion" },
                    { time: "15:00", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                    { time: "16:00", activity: "Hobby / Tiempo personal üé®", duration: "2 hrs", category: "espiritual" },
                    { time: "18:00", activity: "Social / Amigos / Familia üë®‚Äçüë©‚Äçüëß", duration: "2 hrs", category: "espiritual" },
                    { time: "20:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                    { time: "21:00", activity: "Preparar semana + Ropa üëî", duration: "1 hr", category: "habitos" },
                    { time: "22:00", activity: "Relax + DORMIR temprano üò¥", duration: "9 hrs", category: "descanso" }
                ]
            },
            // PLANTILLA 5: MAM√Å EMPRENDEDORA
            {
                id: 'mama_emprendedora',
                name: 'Plan Mam√° Emprendedora',
                author: 'Luc√≠a Fern√°ndez',
                description: 'Plan para mam√°s que emprenden: gesti√≥n del hogar, negocio propio, autocuidado y tiempo en familia.',
                icon: 'üë©‚Äçüëß‚Äçüë¶',
                duration: 60,
                goal: 'balance',
                gymFocus: {
                    0: { name: "D√≠a Familiar", icon: "üë®‚Äçüë©‚Äçüëß", exercises: ["Actividad con los ni√±os", "Caminata en familia", "Juegos activos en el parque", "Descanso cuando se pueda"] },
                    1: { name: "Cardio en Casa", icon: "üè†", exercises: ["Video cardio 30min", "Saltar cuerda 15min", "Baile con los ni√±os 20min", "Subir escaleras 10min"] },
                    2: { name: "Fuerza Express", icon: "üí™", exercises: ["Circuito con peso corporal 25min", "Sentadillas con beb√© 3x15", "Plancha 3x30seg", "Gl√∫teos 3x20", "Brazos con botellas 3x15"] },
                    3: { name: "Yoga/Pilates", icon: "üßò", exercises: ["Yoga en casa 30min", "Pilates core 20min", "Estiramientos espalda", "Respiraci√≥n y relajaci√≥n"] },
                    4: { name: "HIIT Mam√°", icon: "üî•", exercises: ["HIIT 20min en casa", "Ejercicios sin ruido si duermen", "Tabata silencioso", "Cardio bajo impacto"] },
                    5: { name: "Caminata Activa", icon: "üö∂‚Äç‚ôÄÔ∏è", exercises: ["Caminata con cochecito 45min", "Paseo al parque", "Ejercicios en el parque", "Estiramientos"] },
                    6: { name: "Tiempo Libre", icon: "‚ú®", exercises: ["Ejercicio si hay oportunidad", "Priorizar descanso", "Actividad que disfrutes", "Sin culpa si no se puede"] }
                },
                habits: [
                    { id: 1, name: "Despertar antes que los ni√±os", icon: "‚è∞" },
                    { id: 2, name: "Mi momento de caf√©/t√©", icon: "‚òï" },
                    { id: 3, name: "Planificar el d√≠a", icon: "üìã" },
                    { id: 4, name: "Bloque trabajo en negocio", icon: "üíº" },
                    { id: 5, name: "Ejercicio (aunque sea 20min)", icon: "üèÉ‚Äç‚ôÄÔ∏è" },
                    { id: 6, name: "Comida saludable", icon: "ü•ó" },
                    { id: 7, name: "Tiempo de calidad con hijos", icon: "üë∂" },
                    { id: 8, name: "Delegar una tarea", icon: "ü§ù" },
                    { id: 9, name: "Momento de autocuidado", icon: "üíÜ‚Äç‚ôÄÔ∏è" },
                    { id: 10, name: "Gratitud del d√≠a", icon: "üôè" },
                    { id: 11, name: "Preparar ma√±ana", icon: "üåô" },
                    { id: 12, name: "Dormir cuando pueda", icon: "üò¥" }
                ],
                meals: [
                    { time: "07:00", name: "Desayuno r√°pido", emoji: "üåÖ", options: ["Overnight oats (preparado anoche)", "Smoothie express + tostada", "Yogurt + granola + fruta"], macros: "P:20g | C:40g | G:10g" },
                    { time: "10:00", name: "Snack con ni√±os", emoji: "üçé", options: ["Fruta cortada para todos", "Galletas caseras saludables", "Queso + crackers integrales"], macros: "P:8g | C:20g | G:8g" },
                    { time: "13:00", name: "Almuerzo familiar", emoji: "üçΩÔ∏è", options: ["Comida batch cooking", "Prote√≠na + arroz + verduras", "Pasta integral con vegetales"], macros: "P:30g | C:50g | G:12g" },
                    { time: "16:30", name: "Merienda", emoji: "ü•™", options: ["Lo mismo que los ni√±os (saludable)", "Fruta + nueces", "Sandwich peque√±o"], macros: "P:10g | C:25g | G:8g" },
                    { time: "20:00", name: "Cena", emoji: "üåô", options: ["Cena r√°pida y nutritiva", "Tortilla de verduras", "Ensalada completa + prote√≠na"], macros: "P:25g | C:30g | G:10g" }
                ],
                weeklyGoals: [
                    { week: 1, dates: "Semana 1", fisica: "Encontrar 30min ejercicio/d√≠a", personal: "Definir horarios negocio", digital: "Automatizar redes sociales", espiritual: "Soltar culpa mam√° perfecta" },
                    { week: 2, dates: "Semana 2", fisica: "Rutina en casa establecida", personal: "Sistema de organizaci√≥n hogar", digital: "Batch content 1x semana", espiritual: "Pedir ayuda sin culpa" },
                    { week: 3, dates: "Semana 3", fisica: "Incluir a los ni√±os en ejercicio", personal: "Red de apoyo mam√°s", digital: "Tienda/servicio optimizado", espiritual: "Tiempo a solas sagrado" },
                    { week: 4, dates: "Semana 4", fisica: "Energ√≠a mejorada", personal: "Delegar tareas hogar", digital: "Primeras ventas/clientes", espiritual: "Celebrar peque√±os logros" },
                    { week: 5, dates: "Semana 5", fisica: "Constancia en movimiento", personal: "Rutina ni√±os establecida", digital: "Engagement creciendo", espiritual: "Manejo del estr√©s" },
                    { week: 6, dates: "Semana 6", fisica: "Cuerpo m√°s fuerte", personal: "Balance hogar-negocio", digital: "Ingresos consistentes", espiritual: "Conexi√≥n con pareja" },
                    { week: 7, dates: "Semana 7", fisica: "H√°bito ejercicio instalado", personal: "Sistema funcionando", digital: "Crecimiento sostenido", espiritual: "Identidad m√°s all√° de mam√°" },
                    { week: 8, dates: "Semana 8", fisica: "üéØ Mam√° fit y con energ√≠a", personal: "üéØ Hogar y negocio en armon√≠a", digital: "üéØ Negocio rentable", espiritual: "üéØ Mam√° feliz = familia feliz" }
                ],
                weekdaySchedule: [
                    { time: "05:30", activity: "Despertar ANTES que los ni√±os ‚è∞", duration: "15 min", category: "habitos" },
                    { time: "05:45", activity: "Mi momento: caf√©/t√© + silencio ‚òï", duration: "15 min", category: "espiritual" },
                    { time: "06:00", activity: "Ejercicio en casa (mientras duermen) üè†", duration: "30 min", category: "fisico" },
                    { time: "06:30", activity: "Ducha r√°pida + Prepararme", duration: "30 min", category: "habitos" },
                    { time: "07:00", activity: "Despertar ni√±os + Rutina ma√±ana üë∂", duration: "30 min", category: "habitos" },
                    { time: "07:30", activity: "Desayuno familiar ü•£", duration: "30 min", category: "nutricion" },
                    { time: "08:00", activity: "Llevar ni√±os colegio/guarder√≠a üöó", duration: "30 min", category: "habitos" },
                    { time: "08:30", activity: "BLOQUE NEGOCIO - Deep Work üíº", duration: "2.5 hrs", category: "personal" },
                    { time: "11:00", activity: "Snack + Revisar pedidos/emails üìß", duration: "30 min", category: "nutricion" },
                    { time: "11:30", activity: "Tareas del hogar esenciales üè†", duration: "30 min", category: "habitos" },
                    { time: "12:00", activity: "Preparar almuerzo (batch cooking) üç≥", duration: "30 min", category: "nutricion" },
                    { time: "12:30", activity: "Recoger ni√±os / Almuerzo juntos üë®‚Äçüë©‚Äçüëß", duration: "1.5 hrs", category: "nutricion" },
                    { time: "14:00", activity: "Siesta ni√±os = TRABAJO negocio üíª", duration: "1.5 hrs", category: "personal" },
                    { time: "15:30", activity: "Merienda + Tiempo calidad hijos üß∏", duration: "1.5 hrs", category: "espiritual" },
                    { time: "17:00", activity: "Actividades ni√±os / Parque üå≥", duration: "1 hr", category: "espiritual" },
                    { time: "18:00", activity: "Redes sociales negocio üì±", duration: "30 min", category: "digital" },
                    { time: "18:30", activity: "Preparar cena", duration: "30 min", category: "nutricion" },
                    { time: "19:00", activity: "Cena familiar üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                    { time: "20:00", activity: "Rutina ni√±os: ba√±o + cuento üõÅ", duration: "1 hr", category: "habitos" },
                    { time: "21:00", activity: "Tiempo pareja / Autocuidado üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "espiritual" },
                    { time: "22:00", activity: "Preparar ma√±ana + DORMIR üò¥", duration: "7.5 hrs", category: "descanso" }
                ],
                weekendSchedule: [
                    { time: "07:00", activity: "Despertar (un poco m√°s tarde) ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                    { time: "07:30", activity: "Desayuno especial en familia ü•û", duration: "1 hr", category: "nutricion" },
                    { time: "08:30", activity: "Actividad familiar: parque/paseo üë®‚Äçüë©‚Äçüëß", duration: "2 hrs", category: "espiritual" },
                    { time: "10:30", activity: "Snack + Juegos en casa", duration: "30 min", category: "nutricion" },
                    { time: "11:00", activity: "Tiempo a solas (pareja cuida ni√±os) üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "espiritual" },
                    { time: "12:00", activity: "Preparar almuerzo juntos üë®‚Äçüë©‚Äçüëß‚Äçüë¶", duration: "1 hr", category: "nutricion" },
                    { time: "13:00", activity: "Almuerzo familiar", duration: "1 hr", category: "nutricion" },
                    { time: "14:00", activity: "Siesta / Descanso todos üò¥", duration: "1.5 hrs", category: "descanso" },
                    { time: "15:30", activity: "Batch cooking semana üç≥", duration: "1.5 hrs", category: "nutricion" },
                    { time: "17:00", activity: "Planificar negocio semana üìã", duration: "1 hr", category: "personal" },
                    { time: "18:00", activity: "Tiempo libre familia üéÆ", duration: "2 hrs", category: "espiritual" },
                    { time: "20:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                    { time: "21:00", activity: "Preparar semana + Dormir temprano üò¥", duration: "8 hrs", category: "descanso" }
                ]
            }
        ];

        const categoryColors = {
            habitos: { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-700", badge: "bg-amber-100" },
            nutricion: { bg: "bg-green-50", border: "border-green-200", text: "text-green-700", badge: "bg-green-100" },
            fisico: { bg: "bg-rose-50", border: "border-rose-200", text: "text-rose-700", badge: "bg-rose-100" },
            personal: { bg: "bg-blue-50", border: "border-blue-200", text: "text-blue-700", badge: "bg-blue-100" },
            digital: { bg: "bg-purple-50", border: "border-purple-200", text: "text-purple-700", badge: "bg-purple-100" },
            espiritual: { bg: "bg-indigo-50", border: "border-indigo-200", text: "text-indigo-700", badge: "bg-indigo-100" },
            descanso: { bg: "bg-slate-50", border: "border-slate-200", text: "text-slate-700", badge: "bg-slate-100" }
        };

        function getDefaultSchedule(dayIndex) {
            // Check if there's an active template with custom schedules
            const activeTemplateSchedules = JSON.parse(getStorage('active-template-schedules') || 'null');

            if (activeTemplateSchedules) {
                const gym = getGymFocus(dayIndex);

                // Sunday (0) or Saturday (6) = weekend
                if (dayIndex === 0 || dayIndex === 6) {
                    if (activeTemplateSchedules.weekend) {
                        // Replace gym placeholder in schedule
                        return activeTemplateSchedules.weekend.map(item => ({
                            ...item,
                            activity: item.activity.includes('${gym') ?
                                item.activity.replace(/\$\{gym\.name\}/g, gym.name).replace(/\$\{gym\.icon\}/g, gym.icon) :
                                item.activity
                        }));
                    }
                } else {
                    // Weekday
                    if (activeTemplateSchedules.weekday) {
                        return activeTemplateSchedules.weekday.map(item => ({
                            ...item,
                            activity: item.activity.includes('${gym') ?
                                item.activity.replace(/\$\{gym\.name\}/g, gym.name).replace(/\$\{gym\.icon\}/g, gym.icon) :
                                item.activity
                        }));
                    }
                }
            }

            // Fallback to original default schedules
            if (dayIndex === 0) return getSundaySchedule();
            if (dayIndex === 6) return getSaturdaySchedule();
            return getWeekdaySchedule(dayIndex);
        }

        function getSchedule(dayIndex = currentDate.getDay(), dateKey = getDateKey(currentDate)) {
            // Check if schedules have been cleared by reset
            if (customSchedules.__cleared__) {
                return customSchedules[dateKey] || [];
            }
            if (customSchedules[dateKey]) {
                return customSchedules[dateKey];
            }
            return getDefaultSchedule(dayIndex);
        }

        function saveCustomSchedule(dateKey, schedule) {
            customSchedules[dateKey] = schedule;
            setStorage('custom-schedules', JSON.stringify(customSchedules));
        }

        // Get user profile for schedule customization
        function getUserSchedulePrefs() {
            // Try user-profile first, then fall back to currentUser.preferences (from onboarding)
            const profile = JSON.parse(getStorage('user-profile') || '{}');
            const onboardingPrefs = currentUser?.preferences || {};

            return {
                wakeUp: profile.wakeUp || onboardingPrefs.wakeUp || '07:00',
                sleep: profile.sleep || onboardingPrefs.sleep || '22:00',
                goal: profile.goal || onboardingPrefs.goal || currentUser?.goal || 'fitness',
                occupation: profile.occupation || onboardingPrefs.occupation || 'working'
            };
        }

        function getWeekdaySchedule(dayIndex) {
            const gym = getGymFocus(dayIndex);
            const prefs = getUserSchedulePrefs();
            const wakeHour = parseInt(prefs.wakeUp.split(':')[0]);
            const sleepHour = parseInt(prefs.sleep.split(':')[0]);

            // Base schedule adapts to wake/sleep times
            const schedule = [
                { time: prefs.wakeUp, activity: "Despertar + Hidrataci√≥n üíß", duration: "15 min", category: "habitos" },
                { time: `${String(wakeHour).padStart(2,'0')}:15`, activity: "Rutina matutina ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                { time: `${String(wakeHour).padStart(2,'0')}:45`, activity: "Desayuno saludable üç≥", duration: "30 min", category: "nutricion" },
            ];

            // Add goal-specific morning activity
            const goalActivities = {
                fitness: { time: `${String(wakeHour + 1).padStart(2,'0')}:15`, activity: `Ejercicio: ${gym.name} ${gym.icon}`, duration: "1.5 hrs", category: "fisico" },
                productivity: { time: `${String(wakeHour + 1).padStart(2,'0')}:15`, activity: "Bloque de trabajo profundo üíª", duration: "2 hrs", category: "trabajo" },
                learning: { time: `${String(wakeHour + 1).padStart(2,'0')}:15`, activity: "Sesi√≥n de estudio üìö", duration: "2 hrs", category: "estudio" },
                business: { time: `${String(wakeHour + 1).padStart(2,'0')}:15`, activity: "Trabajo en proyecto/negocio üíº", duration: "2 hrs", category: "trabajo" },
                competition: { time: `${String(wakeHour + 1).padStart(2,'0')}:15`, activity: `Entrenamiento: ${gym.name} ${gym.icon}`, duration: "2 hrs", category: "fisico" },
                wellness: { time: `${String(wakeHour + 1).padStart(2,'0')}:15`, activity: "Yoga / Meditaci√≥n üßò", duration: "1 hr", category: "espiritual" }
            };
            schedule.push(goalActivities[prefs.goal] || goalActivities.fitness);

            // Mid-day activities
            schedule.push(
                { time: "10:30", activity: "Snack + Pausa activa ü•§", duration: "30 min", category: "nutricion" },
                { time: "11:00", activity: "Actividades productivas üìã", duration: "1 hr", category: "trabajo" },
                { time: "12:00", activity: "Almuerzo üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                { time: "13:00", activity: "Descanso / Tiempo personal üìñ", duration: "30 min", category: "descanso" }
            );

            // Afternoon based on goal
            if (prefs.goal === 'fitness' || prefs.goal === 'competition') {
                schedule.push(
                    { time: "13:30", activity: "Actividades del d√≠a üìã", duration: "2.5 hrs", category: "personal" },
                    { time: "16:00", activity: "Snack post-actividad ü•§", duration: "30 min", category: "nutricion" },
                    { time: "16:30", activity: "Tiempo libre / Hobbies ‚ú®", duration: "1.5 hrs", category: "personal" }
                );
            } else if (prefs.goal === 'productivity' || prefs.goal === 'business') {
                schedule.push(
                    { time: "13:30", activity: "Reuniones / Llamadas üìû", duration: "1.5 hrs", category: "trabajo" },
                    { time: "15:00", activity: "Bloque de trabajo üíª", duration: "2 hrs", category: "trabajo" },
                    { time: "17:00", activity: "Revisi√≥n del d√≠a + Planificaci√≥n üìä", duration: "1 hr", category: "trabajo" }
                );
            } else if (prefs.goal === 'learning') {
                schedule.push(
                    { time: "13:30", activity: "Pr√°ctica / Ejercicios üìù", duration: "2 hrs", category: "estudio" },
                    { time: "15:30", activity: "Revisi√≥n de material üìö", duration: "1.5 hrs", category: "estudio" },
                    { time: "17:00", activity: "Descanso mental üéÆ", duration: "1 hr", category: "personal" }
                );
            } else {
                schedule.push(
                    { time: "13:30", activity: "Actividades del d√≠a üìã", duration: "2 hrs", category: "personal" },
                    { time: "15:30", activity: "Ejercicio suave / Caminata üö∂", duration: "1 hr", category: "fisico" },
                    { time: "16:30", activity: "Autocuidado / Hobbies ‚ú®", duration: "1.5 hrs", category: "personal" }
                );
            }

            // Evening routine
            schedule.push(
                { time: "18:00", activity: "Tiempo libre üéØ", duration: "1 hr", category: "personal" },
                { time: "19:00", activity: "Cena üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                { time: "20:00", activity: "Relax / Familia / Social üíï", duration: "1 hr", category: "personal" },
                { time: `${String(sleepHour - 1).padStart(2,'0')}:00`, activity: "Rutina nocturna üåô", duration: "30 min", category: "habitos" },
                { time: `${String(sleepHour - 1).padStart(2,'0')}:30`, activity: "Preparar ma√±ana + Gratitud üôè", duration: "30 min", category: "espiritual" },
                { time: prefs.sleep, activity: "Dormir üò¥", duration: "8 hrs", category: "descanso" }
            );

            return schedule;
        }

        function getSaturdaySchedule() {
            const gym = getGymFocus(6);
            const prefs = getUserSchedulePrefs();
            const wakeHour = parseInt(prefs.wakeUp.split(':')[0]) + 1; // Weekend: 1 hour later
            const sleepHour = parseInt(prefs.sleep.split(':')[0]);

            return [
                { time: `${String(wakeHour).padStart(2,'0')}:00`, activity: "Despertar tranquilo + Hidrataci√≥n ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                { time: `${String(wakeHour).padStart(2,'0')}:30`, activity: "Desayuno especial de fin de semana ü•û", duration: "1 hr", category: "nutricion" },
                { time: `${String(wakeHour + 1).padStart(2,'0')}:30`, activity: `Ejercicio: ${gym.name} ${gym.icon}`, duration: "1.5 hrs", category: "fisico" },
                { time: `${String(wakeHour + 3).padStart(2,'0')}:00`, activity: "Snack + Hidrataci√≥n ü•§", duration: "30 min", category: "nutricion" },
                { time: `${String(wakeHour + 3).padStart(2,'0')}:30`, activity: "Tiempo personal / Hobbies üé®", duration: "1.5 hrs", category: "personal" },
                { time: "13:00", activity: "Almuerzo üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                { time: "14:00", activity: "Descanso / Siesta üò¥", duration: "1 hr", category: "descanso" },
                { time: "15:00", activity: "Actividades libres ‚ú®", duration: "2 hrs", category: "personal" },
                { time: "17:00", activity: "Organizar semana / Planificar üìã", duration: "1 hr", category: "personal" },
                { time: "18:00", activity: "Tiempo social / Familia üë®‚Äçüë©‚Äçüëß‚Äçüë¶", duration: "2 hrs", category: "personal" },
                { time: "20:00", activity: "Cena üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Relax / Pel√≠cula / Lectura üé¨", duration: "1 hr", category: "personal" },
                { time: prefs.sleep, activity: "Dormir üò¥", duration: "8 hrs", category: "descanso" }
            ];
        }

        function getSundaySchedule() {
            const prefs = getUserSchedulePrefs();
            const wakeHour = parseInt(prefs.wakeUp.split(':')[0]) + 1; // Weekend: 1 hour later
            const sleepHour = parseInt(prefs.sleep.split(':')[0]);

            return [
                { time: `${String(wakeHour).padStart(2,'0')}:00`, activity: "Despertar natural ‚òÄÔ∏è", duration: "30 min", category: "habitos" },
                { time: `${String(wakeHour).padStart(2,'0')}:30`, activity: "Meditaci√≥n / Reflexi√≥n üßò", duration: "30 min", category: "espiritual" },
                { time: `${String(wakeHour + 1).padStart(2,'0')}:00`, activity: "Brunch dominical ü•ë", duration: "1 hr", category: "nutricion" },
                { time: `${String(wakeHour + 2).padStart(2,'0')}:00`, activity: "Revisar metas de la semana üéØ", duration: "1 hr", category: "personal" },
                { time: `${String(wakeHour + 3).padStart(2,'0')}:00`, activity: "Actividad al aire libre / Paseo üå≥", duration: "1.5 hrs", category: "fisico" },
                { time: "13:00", activity: "Almuerzo üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                { time: "14:00", activity: "Descanso / Tiempo tranquilo üìñ", duration: "1.5 hrs", category: "descanso" },
                { time: "15:30", activity: "Preparar semana / Organizar üìã", duration: "1 hr", category: "personal" },
                { time: "16:30", activity: "Hobby / Actividad recreativa üé®", duration: "1.5 hrs", category: "personal" },
                { time: "18:00", activity: "Tiempo familiar / Social üíï", duration: "2 hrs", category: "personal" },
                { time: "20:00", activity: "Cena ligera üçΩÔ∏è", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Rutina nocturna + Gratitud üåô", duration: "30 min", category: "espiritual" },
                { time: `${String(sleepHour - 1).padStart(2,'0')}:30`, activity: "Preparar lunes + Relajaci√≥n üôè", duration: "30 min", category: "habitos" },
                { time: prefs.sleep, activity: "Dormir temprano üò¥", duration: "8 hrs", category: "descanso" }
            ];
        }

        function getDateKey(date = currentDate) {
            return date.toISOString().split('T')[0];
        }

        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function getWeekNumber(date = currentDate) {
            return Math.min(totalWeeks, Math.max(1, Math.floor((date - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1));
        }

        function getDayNumber(date = currentDate) {
            return Math.floor((date - startDate) / (24 * 60 * 60 * 1000)) + 1;
        }

        function getDailyProgress(date = currentDate) {
            const dateKey = getDateKey(date);
            const schedule = getSchedule(date.getDay(), dateKey);
            const totalActivities = schedule.length;
            if (totalActivities === 0) return 0;
            let completed = 0;

            for (let i = 0; i < totalActivities; i++) {
                if (completedActivities[`${dateKey}-${i}`]) {
                    completed++;
                }
            }

            return Math.round((completed / totalActivities) * 100);
        }

        function getWeeklyProgress() {
            const weekNum = getWeekNumber();
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (weekNum - 1) * 7);

            let totalActivities = 0;
            let completedCount = 0;

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + i);

                if (dayDate > endDate) break;

                const dateKey = getDateKey(dayDate);
                const schedule = getSchedule(dayDate.getDay(), dateKey);
                totalActivities += schedule.length;

                for (let j = 0; j < schedule.length; j++) {
                    if (completedActivities[`${dateKey}-${j}`]) {
                        completedCount++;
                    }
                }
            }

            return totalActivities > 0 ? Math.round((completedCount / totalActivities) * 100) : 0;
        }

        function getTotalProgress() {
            let totalActivities = 0;
            let completedCount = 0;

            const tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                const dateKey = getDateKey(tempDate);
                const schedule = getSchedule(tempDate.getDay(), dateKey);
                totalActivities += schedule.length;

                for (let j = 0; j < schedule.length; j++) {
                    if (completedActivities[`${dateKey}-${j}`]) {
                        completedCount++;
                    }
                }

                tempDate.setDate(tempDate.getDate() + 1);
            }

            return totalActivities > 0 ? Math.round((completedCount / totalActivities) * 100) : 0;
        }

        // Calcular racha de d√≠as consecutivos con 100%
        function getStreak() {
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Empezar desde ayer (o hoy si ya complet√≥)
            const checkDate = new Date(today);

            // Si hoy a√∫n no tiene 100%, empezar desde ayer
            const todayProgress = getDailyProgress(today);
            if (todayProgress < 100) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // Contar d√≠as hacia atr√°s con 100%
            while (checkDate >= startDate) {
                const dayProgress = getDailyProgress(checkDate);
                if (dayProgress === 100) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        // Calcular mejor racha hist√≥rica
        function getBestStreak() {
            let bestStreak = 0;
            let currentStreak = 0;

            const tempDate = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            while (tempDate <= today && tempDate <= endDate) {
                const dayProgress = getDailyProgress(tempDate);
                if (dayProgress === 100) {
                    currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            return bestStreak;
        }

        function navigateDay(direction) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + direction);
            if (newDate >= startDate && newDate <= endDate) {
                currentDate = newDate;
                render();
            }
        }

        // Calendar Modal Functions
        let calendarMonth = new Date();

        function openCalendarModal() {
            calendarMonth = new Date(currentDate);
            renderCalendar();
            document.getElementById('calendarModal').classList.remove('hidden');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.add('hidden');
        }

        function changeCalendarMonth(direction) {
            calendarMonth.setMonth(calendarMonth.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            document.getElementById('calendarTitle').textContent =
                `${monthNames[calendarMonth.getMonth()]} ${calendarMonth.getFullYear()}`;

            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            // Primer d√≠a del mes
            const firstDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), 1);
            const lastDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0);

            // D√≠as vac√≠os al inicio
            for (let i = 0; i < firstDay.getDay(); i++) {
                container.innerHTML += '<div></div>';
            }

            // D√≠as del mes
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), day);
                const isInRange = date >= startDate && date <= endDate;
                const isSelected = date.toDateString() === currentDate.toDateString();
                const isToday = date.toDateString() === new Date().toDateString();

                let classes = 'w-10 h-10 flex items-center justify-center rounded-full text-sm transition ';

                if (!isInRange) {
                    classes += 'text-gray-300 cursor-not-allowed';
                } else if (isSelected) {
                    classes += 'bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold cursor-pointer';
                } else if (isToday) {
                    classes += 'border-2 border-purple-400 text-purple-600 font-medium cursor-pointer hover:bg-purple-50';
                } else {
                    classes += 'text-gray-700 cursor-pointer hover:bg-gray-100';
                }

                container.innerHTML += `
                    <button class="${classes}"
                            ${isInRange ? `onclick="selectDate(${date.getFullYear()}, ${date.getMonth()}, ${day})"` : 'disabled'}>
                        ${day}
                    </button>
                `;
            }
        }

        function selectDate(year, month, day) {
            currentDate = new Date(year, month, day);
            closeCalendarModal();
            render();
        }

        function goToToday() {
            const today = new Date();
            if (today >= startDate && today <= endDate) {
                currentDate = today;
                closeCalendarModal();
                render();
            } else {
                alert('Hoy est√° fuera del rango de tu plan');
            }
        }

        // Congratulations Modal Functions
        const congratsShown = JSON.parse(getStorage('congrats-shown') || '{}');

        function closeCongratsModal() {
            document.getElementById('congratsModal').classList.add('hidden');
        }

        function showCongrats(type, emoji, title, message) {
            document.getElementById('congratsEmoji').textContent = emoji;
            document.getElementById('congratsTitle').textContent = title;
            document.getElementById('congratsMessage').textContent = message;
            document.getElementById('congratsModal').classList.remove('hidden');

            // Mostrar celebraci√≥n extra grande
            showBigCelebration();
        }

        function showBigCelebration() {
            const emojis = ['üéâ', 'üéä', 'ü•≥', '‚≠ê', '‚ú®', 'üåü', 'üèÜ', 'üëë', 'üí™', 'üî•', 'üíñ', 'üéÜ', 'üéá'];
            const container = document.createElement('div');
            container.className = 'fixed inset-0 pointer-events-none z-[150]';
            document.body.appendChild(container);

            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.cssText = `
                        position: absolute;
                        font-size: ${30 + Math.random() * 40}px;
                        left: ${Math.random() * 100}%;
                        top: -60px;
                        animation: celebrationFall 2s ease-out forwards;
                    `;
                    container.appendChild(emoji);
                }, i * 80);
            }

            setTimeout(() => container.remove(), 3500);
        }

        function checkAndShowCongrats(dailyProgress, weeklyProgress, totalProgress) {
            const dateKey = getDateKey();
            const weekKey = `week-${getWeekNumber()}`;

            // D√≠a completo (100%)
            if (dailyProgress === 100 && !congratsShown[dateKey]) {
                congratsShown[dateKey] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('day', 'üåü', '¬°D√≠a completado!',
                        '¬°Incre√≠ble! Completaste todas las tareas del d√≠a. ¬°Sigue as√≠!');
                }, 500);
                return;
            }

            // Semana completa (100%)
            if (weeklyProgress === 100 && !congratsShown[weekKey]) {
                congratsShown[weekKey] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('week', 'üèÜ', '¬°Semana perfecta!',
                        '¬°WOW! Completaste toda la semana. ¬°Eres imparable!');
                }, 500);
                return;
            }

            // Plan completo (100%)
            if (totalProgress === 100 && !congratsShown['plan-complete']) {
                congratsShown['plan-complete'] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('plan', 'üëë', '¬°¬°PLAN COMPLETADO!!',
                        '¬°LO LOGRASTE! Completaste todo tu plan. ¬°Eres una leyenda! üéâüéäü•≥');
                }, 500);
                return;
            }
        }

        function setTab(tab) {
            activeTab = tab;
            render();
        }

        function toggleHabit(habitId) {
            const key = `${getDateKey()}-${habitId}`;
            const wasCompleted = checkedHabits[key];
            checkedHabits[key] = !checkedHabits[key];
            setStorage('habits', JSON.stringify(checkedHabits));

            // Mostrar celebraci√≥n si se complet√≥
            if (!wasCompleted && checkedHabits[key]) {
                showCelebration();
                // Verificar si se complet√≥ d√≠a/semana/plan
                setTimeout(() => {
                    checkAndShowCongrats(getDailyProgress(), getWeeklyProgress(), getTotalProgress());
                }, 1000);
            }
            render();
        }

        function toggleActivity(index) {
            const key = `${getDateKey()}-${index}`;
            const wasCompleted = completedActivities[key];
            completedActivities[key] = !completedActivities[key];
            setStorage('activities', JSON.stringify(completedActivities));

            // Mostrar celebraci√≥n si se complet√≥
            if (!wasCompleted && completedActivities[key]) {
                showCelebration();
                // Verificar si se complet√≥ d√≠a/semana/plan
                setTimeout(() => {
                    checkAndShowCongrats(getDailyProgress(), getWeeklyProgress(), getTotalProgress());
                }, 1000);
            }
            render();
        }

        function moveActivity(index, direction) {
            const dateKey = getDateKey();
            let schedule = getSchedule();

            // Make a copy of the current schedule if not already customized
            if (!customSchedules[dateKey]) {
                customSchedules[dateKey] = JSON.parse(JSON.stringify(schedule));
                schedule = customSchedules[dateKey];
            } else {
                schedule = customSchedules[dateKey];
            }

            const newIndex = index + direction;

            // Validate bounds
            if (newIndex < 0 || newIndex >= schedule.length) return;

            // Swap activities
            const temp = schedule[index];
            schedule[index] = schedule[newIndex];
            schedule[newIndex] = temp;

            // Also swap completion status
            const key1 = `${dateKey}-${index}`;
            const key2 = `${dateKey}-${newIndex}`;
            const tempCompleted = completedActivities[key1];
            completedActivities[key1] = completedActivities[key2];
            completedActivities[key2] = tempCompleted;

            // Save changes
            customSchedules[dateKey] = schedule;
            setStorage('custom-schedules', JSON.stringify(customSchedules));
            setStorage('activities', JSON.stringify(completedActivities));

            render();
        }

        // Animaci√≥n de celebraci√≥n con emojis (3 opciones aleatorias)
        function showCelebration() {
            const emojiSets = [
                ['üéâ', 'üéä', 'ü•≥', 'üéà', 'üéÅ', 'ü™Ö', 'üéÄ', 'üçæ', 'ü•Ç', 'üéÜ'],  // Fiesta
                ['‚≠ê', '‚ú®', 'üåü', 'üí´', 'üåà', 'ü¶ã', 'üíñ', 'üíù', 'üå∏', 'üå∫'],  // M√°gico
                ['üèÜ', 'ü•á', 'üí™', 'üî•', 'üëë', 'üöÄ', 'üíØ', '‚ö°', 'üéØ', 'üëè']   // Campe√≥n
            ];
            const emojis = emojiSets[Math.floor(Math.random() * emojiSets.length)];
            const container = document.createElement('div');
            container.className = 'fixed inset-0 pointer-events-none z-[100]';
            document.body.appendChild(container);

            // Crear 15 emojis que caen
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.cssText = `
                        position: absolute;
                        font-size: ${20 + Math.random() * 25}px;
                        left: ${Math.random() * 100}%;
                        top: -50px;
                        animation: celebrationFall 1.5s ease-out forwards;
                        opacity: 1;
                    `;
                    container.appendChild(emoji);
                }, i * 50);
            }

            // Eliminar despu√©s de la animaci√≥n
            setTimeout(() => container.remove(), 2000);
        }

        // ========== ACTIVITY MODALS ==========
        function openEditModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const dateKey = getDateKey();
            const schedule = getSchedule(currentDate.getDay(), dateKey);
            const item = schedule[index];

            populateCategorySelect('editCategory', 'activities');
            document.getElementById('editTime').value = item.time;
            document.getElementById('editActivity').value = item.activity;
            document.getElementById('editDuration').value = item.duration;
            document.getElementById('editCategory').value = item.category;

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveEdit() {
            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);
            const originalActivity = schedule[editingIndex].activity;

            const newItem = {
                time: document.getElementById('editTime').value,
                activity: document.getElementById('editActivity').value,
                duration: document.getElementById('editDuration').value,
                category: document.getElementById('editCategory').value
            };

            // Guardar este d√≠a primero
            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }
            schedule[editingIndex] = newItem;
            schedule.sort((a, b) => a.time.localeCompare(b.time));
            saveCustomSchedule(dateKey, schedule);

            closeEditModal();

            // Preguntar si reemplazar en todos los d√≠as
            showReplaceAllModal('schedule',
                `¬øAplicar este cambio a "${originalActivity}" en todos los d√≠as?`,
                (replaceAll) => {
                    if (replaceAll) {
                        replaceActivityInAllDays(originalActivity, newItem);
                    }
                }
            );
        }

        function replaceActivityInAllDays(originalName, newItem) {
            // 1. Reemplazar en horarios customizados existentes
            Object.keys(customSchedules).forEach(key => {
                if (key === '__cleared__') return;
                const schedule = customSchedules[key];
                schedule.forEach((item, idx) => {
                    if (item.activity === originalName) {
                        schedule[idx] = { ...newItem };
                    }
                });
                setStorage(`schedule-${key}`, JSON.stringify(schedule));
            });

            // 2. Reemplazar en plantillas activas (weekday/weekend)
            const activeTemplateSchedules = JSON.parse(getStorage('active-template-schedules') || 'null');
            if (activeTemplateSchedules) {
                let updated = false;
                ['weekday', 'weekend'].forEach(type => {
                    if (activeTemplateSchedules[type]) {
                        activeTemplateSchedules[type].forEach((item, idx) => {
                            if (item.activity === originalName) {
                                activeTemplateSchedules[type][idx] = { ...newItem };
                                updated = true;
                            }
                        });
                    }
                });
                if (updated) {
                    setStorage('active-template-schedules', JSON.stringify(activeTemplateSchedules));
                }
            }

            // 3. Crear horarios personalizados para los pr√≥ximos 60 d√≠as
            try {
                const today = new Date();
                for (let i = 0; i < 60; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    const dateKey = date.toISOString().split('T')[0];

                    // Si ya existe, ya fue actualizado arriba
                    if (customSchedules[dateKey]) continue;

                    // Obtener el horario por defecto para este d√≠a
                    const defaultSchedule = getDefaultSchedule(date.getDay());

                    // Validar que existe y es un array
                    if (!defaultSchedule || !Array.isArray(defaultSchedule)) continue;

                    let hasMatch = false;

                    const updatedSchedule = defaultSchedule.map(item => {
                        if (item && item.activity === originalName) {
                            hasMatch = true;
                            return { ...newItem };
                        }
                        return item ? { ...item } : item;
                    }).filter(Boolean);

                    // Solo guardar si hab√≠a coincidencia
                    if (hasMatch && updatedSchedule.length > 0) {
                        updatedSchedule.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                        saveCustomSchedule(dateKey, updatedSchedule);
                    }
                }
            } catch (error) {
                console.error('Error al aplicar cambios a todos los d√≠as:', error);
            }

            render();
        }

        function openDeleteModal(index, type = 'activity') {
            event.stopPropagation();
            deletingIndex = index;
            deleteType = type;

            let itemName = '';
            if (type === 'activity') {
                const dateKey = getDateKey();
                const schedule = getSchedule(currentDate.getDay(), dateKey);
                itemName = schedule[index].activity;
            } else if (type === 'habit') {
                itemName = getHabits()[index].name;
            } else if (type === 'gym') {
                const dayIndex = currentDate.getDay();
                itemName = getGymFocus(dayIndex).exercises[index];
            } else if (type === 'meal') {
                itemName = getMeals()[index].name;
            } else if (type === 'goal') {
                itemName = `Semana ${getWeeklyGoals()[index].week}`;
            }

            document.getElementById('deleteActivityName').textContent = `"${itemName}"`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deletingIndex = null;
        }

        let pendingDeleteName = null; // Nombre del item a borrar

        function confirmDelete() {
            if (deleteType === 'activity') {
                // Guardar nombre antes de borrar
                const dateKey = getDateKey();
                const schedule = getSchedule(currentDate.getDay(), dateKey);
                pendingDeleteName = schedule[deletingIndex]?.activity;

                deleteActivity();
                closeDeleteModal();
                render();

                // Preguntar si borrar de todos los d√≠as
                if (pendingDeleteName) {
                    showReplaceAllModal('deleteActivity',
                        `¬øEliminar "${pendingDeleteName}" de todos los dem√°s d√≠as?`,
                        (deleteAll) => {
                            if (deleteAll) {
                                deleteActivityFromAllDays(pendingDeleteName);
                            }
                        }
                    );
                }
            } else if (deleteType === 'habit') {
                deleteHabit();
                closeDeleteModal();
                render();
            } else if (deleteType === 'gym') {
                // Guardar nombre antes de borrar
                const dayIndex = currentDate.getDay();
                const gym = getGymFocus(dayIndex);
                pendingDeleteName = gym.exercises[deletingIndex];

                deleteGymExercise();
                closeDeleteModal();
                render();

                // Preguntar si borrar de todos los d√≠as
                if (pendingDeleteName) {
                    showReplaceAllModal('deleteGym',
                        `¬øEliminar "${pendingDeleteName}" de todos los dem√°s d√≠as?`,
                        (deleteAll) => {
                            if (deleteAll) {
                                deleteGymFromAllDays(pendingDeleteName, dayIndex);
                            }
                        }
                    );
                }
            } else if (deleteType === 'meal') {
                deleteMeal();
                closeDeleteModal();
                render();
            } else if (deleteType === 'goal') {
                deleteGoal();
                closeDeleteModal();
                render();
            }
        }

        function deleteActivityFromAllDays(activityName) {
            Object.keys(customSchedules).forEach(key => {
                const schedule = customSchedules[key];
                const originalLength = schedule.length;
                customSchedules[key] = schedule.filter(item => item.activity !== activityName);
                if (customSchedules[key].length !== originalLength) {
                    setStorage(`schedule-${key}`, JSON.stringify(customSchedules[key]));
                }
            });
            render();
        }

        function deleteGymFromAllDays(exerciseName, excludeDayIndex) {
            for (let d = 0; d < 7; d++) {
                if (d !== excludeDayIndex && customGym[d]) {
                    const originalLength = customGym[d].exercises.length;
                    customGym[d].exercises = customGym[d].exercises.filter(ex => ex !== exerciseName);
                    if (customGym[d].exercises.length !== originalLength) {
                        setStorage('custom-gym', JSON.stringify(customGym));
                    }
                }
            }
            render();
        }

        function deleteActivity() {
            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);

            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }

            schedule.splice(deletingIndex, 1);

            const newCompleted = {};
            Object.keys(completedActivities).forEach(key => {
                if (key.startsWith(dateKey)) {
                    const idx = parseInt(key.split('-').pop());
                    if (idx < deletingIndex) {
                        newCompleted[key] = completedActivities[key];
                    } else if (idx > deletingIndex) {
                        newCompleted[`${dateKey}-${idx - 1}`] = completedActivities[key];
                    }
                } else {
                    newCompleted[key] = completedActivities[key];
                }
            });
            completedActivities = newCompleted;
            setStorage('activities', JSON.stringify(completedActivities));

            saveCustomSchedule(dateKey, schedule);
        }

        function openAddModal() {
            populateCategorySelect('addCategory', 'activities');
            document.getElementById('addTime').value = '';
            document.getElementById('addActivity').value = '';
            document.getElementById('addDuration').value = '';
            document.getElementById('addCategory').value = 'personal';
            document.getElementById('addRepeat').checked = false;
            document.getElementById('repeatOptions').classList.add('hidden');

            // Establecer fechas por defecto
            const today = currentDate.toISOString().split('T')[0];
            document.getElementById('addStartDate').value = today;
            document.getElementById('addEndDate').value = today;

            document.getElementById('addModal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        function toggleRepeatOptions() {
            const isChecked = document.getElementById('addRepeat').checked;
            const options = document.getElementById('repeatOptions');

            if (isChecked) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        function saveNewActivity() {
            const time = document.getElementById('addTime').value;
            const activity = document.getElementById('addActivity').value;
            const duration = document.getElementById('addDuration').value;
            const category = document.getElementById('addCategory').value;
            const isRepeat = document.getElementById('addRepeat').checked;

            if (!time || !activity) {
                alert('Por favor completa la hora y la actividad');
                return;
            }

            const newItem = { time, activity, duration, category };

            if (isRepeat) {
                // Agregar a m√∫ltiples d√≠as
                const startDateStr = document.getElementById('addStartDate').value;
                const endDateStr = document.getElementById('addEndDate').value;

                if (!startDateStr || !endDateStr) {
                    alert('Por favor selecciona las fechas de inicio y fin');
                    return;
                }

                const repeatStartDate = new Date(startDateStr + 'T00:00:00');
                const repeatEndDate = new Date(endDateStr + 'T00:00:00');

                if (repeatEndDate < repeatStartDate) {
                    alert('La fecha fin debe ser igual o posterior a la fecha inicio');
                    return;
                }

                // Validar que las fechas est√©n dentro del rango del plan
                if (repeatStartDate < startDate || repeatEndDate > endDate) {
                    alert('Las fechas deben estar dentro del rango de tu plan');
                    return;
                }

                let daysAdded = 0;
                const tempDate = new Date(repeatStartDate);

                while (tempDate <= repeatEndDate) {
                    const dateKey = `${tempDate.getFullYear()}-${String(tempDate.getMonth() + 1).padStart(2, '0')}-${String(tempDate.getDate()).padStart(2, '0')}`;
                    let schedule = customSchedules[dateKey] || JSON.parse(JSON.stringify(getSchedule(tempDate.getDay(), dateKey)));

                    schedule.push({ ...newItem });
                    schedule.sort((a, b) => a.time.localeCompare(b.time));

                    customSchedules[dateKey] = schedule;
                    setStorage(`schedule-${dateKey}`, JSON.stringify(schedule));

                    daysAdded++;
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                alert(`‚úÖ Actividad agregada a ${daysAdded} d√≠as`);
            } else {
                // Agregar solo al d√≠a actual
                const dateKey = getDateKey();
                let schedule = getSchedule(currentDate.getDay(), dateKey);

                if (!customSchedules[dateKey]) {
                    schedule = JSON.parse(JSON.stringify(schedule));
                }

                schedule.push(newItem);
                schedule.sort((a, b) => a.time.localeCompare(b.time));

                saveCustomSchedule(dateKey, schedule);
            }

            closeAddModal();
            render();
        }

        function resetDay() {
            if (confirm('¬øRestaurar el plan original de este d√≠a? Se perder√°n los cambios.')) {
                const dateKey = getDateKey();
                delete customSchedules[dateKey];
                setStorage('custom-schedules', JSON.stringify(customSchedules));

                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(dateKey)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));

                render();
            }
        }

        // ========== HABIT MODALS ==========
        function openEditHabitModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const habit = getHabits()[index];

            document.getElementById('editHabitIcon').value = habit.icon;
            document.getElementById('editHabitName').value = habit.name;

            document.getElementById('editHabitModal').classList.remove('hidden');
        }

        function closeEditHabitModal() {
            document.getElementById('editHabitModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveHabitEdit() {
            const newIcon = document.getElementById('editHabitIcon').value;
            const newName = document.getElementById('editHabitName').value;
            const indexToEdit = editingIndex; // Guardar antes de cerrar modal

            closeEditHabitModal();

            showReplaceAllModal('habit',
                `Este cambio aplicar√° a "${newName}" en todos los d√≠as. ¬øContinuar?`,
                (confirmed) => {
                    if (confirmed) {
                        let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
                        habits[indexToEdit] = {
                            id: habits[indexToEdit].id,
                            icon: newIcon,
                            name: newName
                        };
                        customHabits = habits;
                        setStorage('custom-habits', JSON.stringify(customHabits));
                    }
                }
            );
        }

        function deleteHabit() {
            let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
            habits.splice(deletingIndex, 1);
            customHabits = habits;
            setStorage('custom-habits', JSON.stringify(customHabits));
        }

        function openAddHabitModal() {
            document.getElementById('addHabitIcon').value = '‚≠ê';
            document.getElementById('addHabitName').value = '';
            document.getElementById('addHabitModal').classList.remove('hidden');
        }

        function closeAddHabitModal() {
            document.getElementById('addHabitModal').classList.add('hidden');
        }

        function saveNewHabit() {
            const icon = document.getElementById('addHabitIcon').value;
            const name = document.getElementById('addHabitName').value;

            if (!name) {
                alert('Por favor ingresa el nombre del h√°bito');
                return;
            }

            let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
            const newId = Math.max(...habits.map(h => h.id)) + 1;
            habits.push({ id: newId, icon, name });

            customHabits = habits;
            setStorage('custom-habits', JSON.stringify(customHabits));
            closeAddHabitModal();
            render();
        }

        function resetHabits() {
            if (confirm('¬øRestaurar los h√°bitos originales?')) {
                customHabits = null;
                removeStorage('custom-habits');
                render();
            }
        }

        // ========== GYM MODALS ==========
        function openEditGymModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const dayIndex = currentDate.getDay();
            const gym = getGymFocus(dayIndex);

            document.getElementById('editGymExercise').value = gym.exercises[index];

            document.getElementById('editGymModal').classList.remove('hidden');
        }

        function closeEditGymModal() {
            document.getElementById('editGymModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveGymEdit() {
            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            const originalExercise = gym.exercises[editingIndex];
            const newExercise = document.getElementById('editGymExercise').value;

            // Guardar este d√≠a primero
            gym.exercises[editingIndex] = newExercise;
            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));

            closeEditGymModal();

            showReplaceAllModal('gym',
                `¬øReemplazar "${originalExercise}" en todos los d√≠as de la semana?`,
                (replaceAll) => {
                    if (replaceAll) {
                        // Reemplazar en todos los d√≠as
                        for (let d = 0; d < 7; d++) {
                            if (d !== dayIndex && customGym[d]) {
                                customGym[d].exercises = customGym[d].exercises.map(ex =>
                                    ex === originalExercise ? newExercise : ex
                                );
                            }
                        }
                        setStorage('custom-gym', JSON.stringify(customGym));
                    }
                }
            );
        }

        function deleteGymExercise() {
            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            gym.exercises.splice(deletingIndex, 1);
            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));
        }

        function openAddGymModal() {
            document.getElementById('addGymExercise').value = '';
            document.getElementById('addGymModal').classList.remove('hidden');
        }

        function closeAddGymModal() {
            document.getElementById('addGymModal').classList.add('hidden');
        }

        function saveNewGymExercise() {
            const exercise = document.getElementById('addGymExercise').value;

            if (!exercise) {
                alert('Por favor ingresa el ejercicio');
                return;
            }

            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            gym.exercises.push(exercise);

            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));
            closeAddGymModal();
            render();
        }

        function resetGym() {
            if (confirm('¬øRestaurar la rutina original de este d√≠a?')) {
                const dayIndex = currentDate.getDay();
                delete customGym[dayIndex];
                setStorage('custom-gym', JSON.stringify(customGym));
                render();
            }
        }

        // ========== ENHANCED GYM SYSTEM ==========

        // State for gym subsection
        let gymSubTab = 'workout'; // 'profile', 'workout', 'history', 'macros'
        let activeWorkoutExerciseIdx = null;
        let currentSetIdx = 0;

        // State for meals/nutrition subsection
        let mealsSubTab = 'goal'; // Default to goal (META)

        // ==================== UNIFIED TAB SYSTEM ====================
        // Main tabs configuration (uses translation keys)
        function getMainTabsConfig() {
            return {
                agenda: { emoji: 'üìÖ', label: t('agenda'), color: 'blue' },
                habits: { emoji: '‚úÖ', label: t('habits'), color: 'green' },
                gym: { emoji: 'üí™', label: t('gym'), color: 'rose' },
                meals: { emoji: 'ü•ó', label: t('nutrition'), color: 'orange' },
                fasting: { emoji: 'üïê', label: getLang() === 'en' ? 'Fasting' : 'Ayuno', color: 'amber' },
                goals: { emoji: 'üéØ', label: t('goals'), color: 'purple' },
                notes: { emoji: 'üìù', label: getLang() === 'en' ? 'Notes' : 'Notas', color: 'yellow' },
                gastos: { emoji: 'üí∞', label: t('expenses'), color: 'emerald' },
                stats: { emoji: 'üìä', label: t('statistics'), color: 'indigo' }
            };
        }

        // For backwards compatibility
        const mainTabsConfig = getMainTabsConfig();

        // Gym sub-tabs configuration
        function getGymTabsConfig() {
            return {
                profile: { emoji: 'üìä', label: t('profile'), color: 'blue' },
                workout: { emoji: 'üèãÔ∏è', label: getLang() === 'en' ? 'Workout' : 'Entreno', color: 'rose' },
                macros: { emoji: 'ü•ó', label: t('macros'), color: 'green' },
                history: { emoji: 'üìà', label: getLang() === 'en' ? 'History' : 'Historial', color: 'purple' }
            };
        }

        const gymTabsConfig = getGymTabsConfig();

        // Nutrition sub-tabs configuration
        function getNutritionTabsConfig() {
            return {
                goal: { emoji: 'üéØ', label: getLang() === 'en' ? 'Goal' : 'Meta', color: 'purple' },
                plan: { emoji: 'üçΩÔ∏è', label: getLang() === 'en' ? 'Plan' : 'Plan', color: 'orange' },
                protein: { emoji: 'ü•©', label: t('protein'), color: 'green' },
                guide: { emoji: 'üìã', label: getLang() === 'en' ? 'Guide' : 'Gu√≠a', color: 'blue' }
            };
        }

        const nutritionTabsConfig = getNutritionTabsConfig();

        // Generic function to get tab order
        function getTabsOrder(key, defaultOrder) {
            return JSON.parse(getStorage(`tabs-order-${key}`) || JSON.stringify(defaultOrder));
        }

        // Generic function to save tab order
        function saveTabsOrder(key, order) {
            setStorage(`tabs-order-${key}`, JSON.stringify(order));
        }

        // Specific getters for backwards compatibility
        function getMainTabsOrder() {
            const defaultOrder = ['agenda', 'habits', 'gym', 'meals', 'fasting', 'goals', 'notes', 'gastos', 'stats'];
            const savedOrder = getTabsOrder('main', defaultOrder);

            // Ensure new tabs are added if they exist in config but not in saved order
            const config = getMainTabsConfig();
            const configTabs = Object.keys(config);
            const missingTabs = configTabs.filter(tab => !savedOrder.includes(tab));

            if (missingTabs.length > 0) {
                // Add missing tabs at their default position
                missingTabs.forEach(tab => {
                    const defaultIndex = defaultOrder.indexOf(tab);
                    if (defaultIndex !== -1) {
                        savedOrder.splice(defaultIndex, 0, tab);
                    } else {
                        savedOrder.push(tab);
                    }
                });
                saveTabsOrder('main', savedOrder);
            }

            // Remove tabs that no longer exist in config
            return savedOrder.filter(tab => configTabs.includes(tab));
        }
        function getGymTabsOrder() {
            return getTabsOrder('gym', ['profile', 'workout', 'macros', 'history']);
        }
        function getNutritionTabsOrder() {
            return getTabsOrder('nutrition', ['goal', 'plan', 'protein', 'guide']);
        }

        // ==================== GENERIC DRAG & DROP SYSTEM ====================
        let draggedTab = null;
        let dragStartX = 0;
        let longPressTimer = null;
        let isDragging = false;
        let currentDragContainer = null; // Track which container we're dragging in
        let currentDragType = null; // 'main', 'gym', 'nutrition'

        // Generic tab drag handlers
        function handleTabTouchStart(event, tabId, containerType) {
            const touch = event.touches[0];
            dragStartX = touch.clientX;
            currentDragType = containerType;
            longPressTimer = setTimeout(() => {
                startDragging(tabId, event.target, containerType);
            }, 500);
        }

        function handleTabMouseDown(event, tabId, containerType) {
            dragStartX = event.clientX;
            currentDragType = containerType;
            longPressTimer = setTimeout(() => {
                startDragging(tabId, event.target, containerType);
            }, 500);
        }

        function startDragging(tabId, element, containerType) {
            isDragging = true;
            draggedTab = tabId;
            currentDragType = containerType;
            currentDragContainer = element.closest('[data-tabs-container]');
            element.style.opacity = '0.5';
            element.style.transform = 'scale(1.05)';
            document.body.style.cursor = 'grabbing';

            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function handleTabTouchMove(event) {
            if (!isDragging) {
                const touch = event.touches[0];
                if (Math.abs(touch.clientX - dragStartX) > 10) {
                    clearTimeout(longPressTimer);
                }
                return;
            }

            event.preventDefault();
            const touch = event.touches[0];
            updateDragPosition(touch.clientX);
        }

        function updateDragPosition(clientX) {
            if (!currentDragContainer) return;

            const tabs = currentDragContainer.querySelectorAll('button[data-tab]');
            const indicator = currentDragContainer.querySelector('.drag-indicator');

            let insertIndex = -1;
            tabs.forEach((tab, index) => {
                const rect = tab.getBoundingClientRect();
                const midPoint = rect.left + rect.width / 2;
                if (clientX < midPoint && insertIndex === -1) {
                    insertIndex = index;
                }
            });

            if (insertIndex === -1) insertIndex = tabs.length;

            if (indicator && insertIndex >= 0) {
                const targetTab = tabs[Math.min(insertIndex, tabs.length - 1)];
                if (targetTab) {
                    const rect = targetTab.getBoundingClientRect();
                    const containerRect = currentDragContainer.getBoundingClientRect();
                    indicator.classList.remove('hidden');
                    if (insertIndex < tabs.length) {
                        indicator.style.left = (rect.left - containerRect.left - 2) + 'px';
                    } else {
                        indicator.style.left = (rect.right - containerRect.left + 2) + 'px';
                    }
                }
            }
        }

        function handleTabTouchEnd(event) {
            clearTimeout(longPressTimer);
            if (!isDragging) return;
            const touch = event.changedTouches[0];
            finishDragging(touch.clientX);
        }

        function handleTabMouseUp(event) {
            clearTimeout(longPressTimer);
            if (!isDragging) return;
            finishDragging(event.clientX);
        }

        function finishDragging(clientX) {
            if (!currentDragContainer || !draggedTab || !currentDragType) {
                resetDragState();
                return;
            }

            const tabs = currentDragContainer.querySelectorAll('button[data-tab]');
            let insertIndex = tabs.length;

            tabs.forEach((tab, index) => {
                const rect = tab.getBoundingClientRect();
                const midPoint = rect.left + rect.width / 2;
                if (clientX < midPoint && insertIndex === tabs.length) {
                    insertIndex = index;
                }
            });

            // Get the correct order based on container type
            let currentOrder;
            if (currentDragType === 'main') {
                currentOrder = getMainTabsOrder();
            } else if (currentDragType === 'gym') {
                currentOrder = getGymTabsOrder();
            } else {
                currentOrder = getNutritionTabsOrder();
            }

            const draggedIndex = currentOrder.indexOf(draggedTab);

            if (draggedIndex !== -1 && draggedIndex !== insertIndex) {
                currentOrder.splice(draggedIndex, 1);
                if (insertIndex > draggedIndex) insertIndex--;
                currentOrder.splice(insertIndex, 0, draggedTab);

                // Save based on container type
                if (currentDragType === 'main') {
                    saveTabsOrder('main', currentOrder);
                } else if (currentDragType === 'gym') {
                    saveTabsOrder('gym', currentOrder);
                } else {
                    saveTabsOrder('nutrition', currentOrder);
                }
            }

            resetDragState();
            render();
        }

        function resetDragState() {
            isDragging = false;
            draggedTab = null;
            currentDragContainer = null;
            currentDragType = null;
            document.body.style.cursor = '';

            document.querySelectorAll('.drag-indicator').forEach(ind => ind.classList.add('hidden'));
            document.querySelectorAll('button[data-tab]').forEach(tab => {
                tab.style.opacity = '';
                tab.style.transform = '';
            });
        }

        document.addEventListener('mouseup', () => {
            if (isDragging) resetDragState();
        });

        // ==================== RENDER SUB-TABS HELPER ====================
        function renderSubTabs(config, order, activeTab, setterFn, containerType, accentColor = 'purple') {
            return `
                <div data-tabs-container="${containerType}" class="flex gap-1 p-1 bg-gray-100 rounded-xl relative overflow-x-auto no-scrollbar">
                    ${order.map((tabId, index) => {
                        const tab = config[tabId];
                        if (!tab) return '';
                        const isActive = activeTab === tabId;
                        return `
                            <button
                                data-tab="${tabId}"
                                data-index="${index}"
                                onclick="if(!isDragging) { ${setterFn}('${tabId}'); render(); }"
                                ontouchstart="handleTabTouchStart(event, '${tabId}', '${containerType}')"
                                ontouchmove="handleTabTouchMove(event)"
                                ontouchend="handleTabTouchEnd(event)"
                                onmousedown="handleTabMouseDown(event, '${tabId}', '${containerType}')"
                                onmouseup="handleTabMouseUp(event)"
                                class="flex-1 py-2 px-2 rounded-lg text-xs font-medium transition select-none whitespace-nowrap ${isActive ? 'bg-white shadow text-' + tab.color + '-600' : 'text-gray-500 hover:bg-gray-50'}"
                                style="touch-action: none;">
                                ${tab.emoji} ${tab.label}
                            </button>
                        `;
                    }).join('')}
                    <div class="drag-indicator hidden absolute top-0 bottom-0 w-0.5 bg-${accentColor}-500 rounded-full z-10"></div>
                </div>
                <p class="text-xs text-gray-400 text-center mt-1">üí° Mant√©n presionado para reordenar</p>
            `;
        }

        // Setters for sub-tabs
        function setGymSubTabValue(tabId) { gymSubTab = tabId; }
        function setMealsSubTabValue(tabId) { mealsSubTab = tabId; }

        let selectedRPE = null;

        // Rest Timer State
        let restTimerInterval = null;
        let restTimerSeconds = 90;
        let restTimerRunning = false;

        // Exercise Library
        const exerciseLibrary = [
            { name: 'Hip Thrust (Smith Machine)', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Hip Thrust con Barra', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Peso Muerto Rumano', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Peso Muerto (M√°quina Smith)', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Patada de Gl√∫teo con Cable', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Empuje de Caderas (Barra)', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Elevaci√≥n de Cadera', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Sentadilla (M√°quina Smith)', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Sentadilla B√∫lgara', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Sentadilla Goblet', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Prensa de Piernas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Extensi√≥n de Cu√°driceps', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Curl de Piernas Acostado', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Curl de Piernas Sentado', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Step con Mancuerna', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Zancada con Mancuernas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Abducci√≥n de Caderas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Aducci√≥n de Caderas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Pantorrillas en M√°quina', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Jal√≥n al Pecho', muscle: 'espalda', icon: 'üí™' },
            { name: 'Remo con Barra', muscle: 'espalda', icon: 'üí™' },
            { name: 'Remo con Mancuerna', muscle: 'espalda', icon: 'üí™' },
            { name: 'Remo en M√°quina', muscle: 'espalda', icon: 'üí™' },
            { name: 'Pullover con Mancuerna', muscle: 'espalda', icon: 'üí™' },
            { name: 'Press de Banca', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Press Inclinado', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Aperturas con Mancuernas', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Fondos en Paralelas', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Curl de B√≠ceps', muscle: 'brazos', icon: 'üí™' },
            { name: 'Curl Martillo', muscle: 'brazos', icon: 'üí™' },
            { name: 'Extensi√≥n de Tr√≠ceps', muscle: 'brazos', icon: 'üí™' },
            { name: 'Press Franc√©s', muscle: 'brazos', icon: 'üí™' },
            { name: 'Plancha', muscle: 'core', icon: 'üßò' },
            { name: 'Crunch Abdominal', muscle: 'core', icon: 'üßò' },
            { name: 'Elevaci√≥n de Piernas', muscle: 'core', icon: 'üßò' },
            { name: 'Russian Twist', muscle: 'core', icon: 'üßò' },
        ];

        // Physical Profile Functions
        function getPhysicalProfile() {
            return JSON.parse(getStorage('physical-profile') || '{"height": null, "goalWeight": null, "checkinDay": 1}');
        }

        function savePhysicalProfile() {
            const profile = {
                height: parseFloat(document.getElementById('profileHeight').value) || null,
                goalWeight: parseFloat(document.getElementById('profileGoalWeight').value) || null,
                checkinDay: parseInt(document.getElementById('profileCheckinDay').value) || 1
            };
            setStorage('physical-profile', JSON.stringify(profile));

            // Save current weight to history if provided
            const currentWeight = parseFloat(document.getElementById('profileCurrentWeight').value);
            if (currentWeight && currentWeight > 0) {
                const entry = {
                    date: getTodayKey(),
                    weight: currentWeight,
                    waist: null,
                    hip: null,
                    thigh: null,
                    arm: null,
                    bodyFat: null
                };

                const history = getWeightHistory();
                // Replace if same date exists
                const existingIdx = history.findIndex(h => h.date === entry.date);
                if (existingIdx >= 0) {
                    // Keep measurements if they exist
                    entry.waist = history[existingIdx].waist;
                    entry.hip = history[existingIdx].hip;
                    entry.thigh = history[existingIdx].thigh;
                    entry.arm = history[existingIdx].arm;
                    entry.bodyFat = history[existingIdx].bodyFat;
                    history[existingIdx] = entry;
                } else {
                    history.push(entry);
                }
                history.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveWeightHistory(history);

                // Update protein goal if not using manual goal
                const proteinConfig = getProteinConfig();
                if (!proteinConfig.manualGoal) {
                    const calculated = calculateProteinGoal(currentWeight, proteinConfig.objective, proteinConfig.activityLevel);
                    proteinConfig.goal = calculated.goal;
                    proteinConfig.minRange = calculated.minRange;
                    proteinConfig.maxRange = calculated.maxRange;
                    saveProteinConfig(proteinConfig);
                }

                addNotification(`Peso actualizado: ${currentWeight} kg`, '‚öñÔ∏è');
            }

            closeProfileModal();
            render();
        }

        function openProfileModal() {
            const profile = getPhysicalProfile();
            const latestWeight = getLatestWeight();
            document.getElementById('profileCurrentWeight').value = latestWeight?.weight || '';
            document.getElementById('profileHeight').value = profile.height || '';
            document.getElementById('profileGoalWeight').value = profile.goalWeight || '';
            document.getElementById('profileCheckinDay').value = profile.checkinDay || 1;
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        // Weight/Measurements Functions
        function getWeightHistory() {
            return JSON.parse(getStorage('weight-history') || '[]');
        }

        function saveWeightHistory(history) {
            setStorage('weight-history', JSON.stringify(history));
        }

        function openWeightModal() {
            document.getElementById('weightDate').value = getTodayKey();
            document.getElementById('weightValue').value = '';
            document.getElementById('measureWaist').value = '';
            document.getElementById('measureHip').value = '';
            document.getElementById('measureThigh').value = '';
            document.getElementById('measureArm').value = '';
            document.getElementById('bodyFat').value = '';
            document.getElementById('weightModal').classList.remove('hidden');
        }

        function closeWeightModal() {
            document.getElementById('weightModal').classList.add('hidden');
        }

        function saveWeightEntry() {
            const weight = parseFloat(document.getElementById('weightValue').value);
            if (!weight) {
                alert('Por favor ingresa tu peso');
                return;
            }

            const entry = {
                date: document.getElementById('weightDate').value,
                weight: weight,
                waist: parseFloat(document.getElementById('measureWaist').value) || null,
                hip: parseFloat(document.getElementById('measureHip').value) || null,
                thigh: parseFloat(document.getElementById('measureThigh').value) || null,
                arm: parseFloat(document.getElementById('measureArm').value) || null,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || null
            };

            const history = getWeightHistory();
            // Replace if same date exists
            const existingIdx = history.findIndex(h => h.date === entry.date);
            if (existingIdx >= 0) {
                history[existingIdx] = entry;
            } else {
                history.push(entry);
            }
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveWeightHistory(history);
            closeWeightModal();
            addNotification(`Peso registrado: ${weight} kg`, '‚öñÔ∏è');

            // Update protein goal if not using manual goal
            const proteinConfig = getProteinConfig();
            if (!proteinConfig.manualGoal) {
                const calculated = calculateProteinGoal(weight, proteinConfig.objective, proteinConfig.activityLevel);
                proteinConfig.goal = calculated.goal;
                proteinConfig.minRange = calculated.minRange;
                proteinConfig.maxRange = calculated.maxRange;
                saveProteinConfig(proteinConfig);
                addNotification(`Meta de prote√≠na actualizada: ${calculated.goal}g/d√≠a`, 'ü•©');
            }

            render();
        }

        function getLatestWeight() {
            const history = getWeightHistory();
            return history.length > 0 ? history[history.length - 1] : null;
        }

        // Workout Log Functions
        function getWorkoutLogs() {
            return JSON.parse(getStorage('workout-logs') || '[]');
        }

        function saveWorkoutLogs(logs) {
            setStorage('workout-logs', JSON.stringify(logs));
        }

        function getTodayWorkout() {
            const logs = getWorkoutLogs();
            const today = getTodayKey();
            const existingWorkout = logs.find(l => l.date === today);

            if (existingWorkout) {
                return existingWorkout;
            }

            // If no workout exists for today, check if there's a training plan
            const plan = getActiveTrainingPlan();
            const dayIndex = new Date().getDay();

            if (plan && plan.weeklyPlan && plan.weeklyPlan[dayIndex]) {
                // Auto-populate from training plan
                const planRoutine = plan.weeklyPlan[dayIndex];
                const workout = {
                    date: today,
                    exercises: planRoutine.exercises.map(function(ex) {
                        return {
                            name: ex.name,
                            sets: Array(ex.sets || 4).fill(null)
                        };
                    })
                };
                // Auto-save this workout
                saveTodayWorkout(workout);
                return workout;
            }

            return { date: today, exercises: [] };
        }

        function saveTodayWorkout(workout) {
            const logs = getWorkoutLogs();
            const idx = logs.findIndex(l => l.date === workout.date);
            if (idx >= 0) {
                logs[idx] = workout;
            } else {
                logs.push(workout);
            }
            saveWorkoutLogs(logs);
        }

        // Exercise Library Modal
        let exerciseFilter = 'all';
        let exerciseSearchQuery = '';

        function openAddWorkoutExerciseModal() {
            exerciseFilter = 'all';
            exerciseSearchQuery = '';
            document.getElementById('exerciseSearch').value = '';
            document.getElementById('customExerciseName').value = '';
            renderExerciseLibrary();
            document.getElementById('addWorkoutExerciseModal').classList.remove('hidden');
        }

        function closeAddWorkoutExerciseModal() {
            document.getElementById('addWorkoutExerciseModal').classList.add('hidden');
        }

        function filterExerciseLibrary() {
            exerciseSearchQuery = document.getElementById('exerciseSearch').value.toLowerCase();
            renderExerciseLibrary();
        }

        function filterByMuscle(muscle) {
            exerciseFilter = muscle;
            document.querySelectorAll('.muscle-filter-btn').forEach(btn => {
                btn.classList.remove('bg-purple-100', 'text-purple-700');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            document.querySelector(`.muscle-filter-btn[data-muscle="${muscle}"]`).classList.remove('bg-gray-100', 'text-gray-600');
            document.querySelector(`.muscle-filter-btn[data-muscle="${muscle}"]`).classList.add('bg-purple-100', 'text-purple-700');
            renderExerciseLibrary();
        }

        function renderExerciseLibrary() {
            const container = document.getElementById('exerciseLibraryList');
            let filtered = exerciseLibrary;

            if (exerciseFilter !== 'all') {
                filtered = filtered.filter(e => e.muscle === exerciseFilter);
            }
            if (exerciseSearchQuery) {
                filtered = filtered.filter(e => e.name.toLowerCase().includes(exerciseSearchQuery));
            }

            container.innerHTML = filtered.map(ex => `
                <button onclick="addExerciseToWorkout('${ex.name}')" class="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-purple-50 transition text-left">
                    <span class="text-2xl">${ex.icon}</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${ex.name}</p>
                        <p class="text-xs text-gray-500 capitalize">${ex.muscle}</p>
                    </div>
                    <span class="text-purple-500">+</span>
                </button>
            `).join('');
        }

        function addExerciseToWorkout(exerciseName) {
            const workout = getTodayWorkout();
            workout.exercises.push({
                name: exerciseName,
                sets: []
            });
            saveTodayWorkout(workout);
            closeAddWorkoutExerciseModal();
            render();
        }

        function addCustomExercise() {
            const name = document.getElementById('customExerciseName').value.trim();
            if (!name) return;
            addExerciseToWorkout(name);
        }

        function removeExerciseFromWorkout(idx) {
            if (!confirm('¬øEliminar este ejercicio del entrenamiento de hoy?')) return;
            const workout = getTodayWorkout();
            workout.exercises.splice(idx, 1);
            saveTodayWorkout(workout);
            render();
        }

        // Set Logging
        function openLogSetModal(exerciseIdx, setIdx) {
            activeWorkoutExerciseIdx = exerciseIdx;
            currentSetIdx = setIdx;
            selectedRPE = null;

            const workout = getTodayWorkout();
            const exercise = workout.exercises[exerciseIdx];
            const existingSet = exercise.sets[setIdx];

            document.getElementById('logSetTitle').textContent = `${exercise.name} - Serie ${setIdx + 1}`;
            document.getElementById('setWeight').value = existingSet?.weight || getLastWeight(exercise.name) || '';
            document.getElementById('setReps').value = existingSet?.reps || '';
            document.getElementById('setNotes').value = existingSet?.notes || '';

            // Reset RPE buttons
            document.querySelectorAll('.rpe-btn').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'text-white');
            });
            if (existingSet?.rpe) {
                selectRPE(existingSet.rpe);
            }

            document.getElementById('logSetModal').classList.remove('hidden');
        }

        function closeLogSetModal() {
            document.getElementById('logSetModal').classList.add('hidden');
        }

        function selectRPE(value) {
            selectedRPE = value;
            document.querySelectorAll('.rpe-btn').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'text-white');
            });
            document.querySelector(`.rpe-btn[data-rpe="${value}"]`).classList.add('bg-purple-500', 'text-white');
        }

        function saveSetLog() {
            const weight = parseFloat(document.getElementById('setWeight').value) || 0;
            const reps = parseInt(document.getElementById('setReps').value) || 0;
            const notes = document.getElementById('setNotes').value;

            if (!reps) {
                alert('Por favor ingresa las repeticiones');
                return;
            }

            const workout = getTodayWorkout();
            const exercise = workout.exercises[activeWorkoutExerciseIdx];

            // Ensure sets array is long enough
            while (exercise.sets.length <= currentSetIdx) {
                exercise.sets.push(null);
            }

            exercise.sets[currentSetIdx] = {
                weight,
                reps,
                rpe: selectedRPE,
                notes,
                completedAt: new Date().toISOString()
            };

            saveTodayWorkout(workout);
            closeLogSetModal();

            // Check for PR
            checkAndNotifyPR(exercise.name, weight, reps);

            // Start rest timer
            startRestTimer();

            render();
        }

        function getLastWeight(exerciseName) {
            const logs = getWorkoutLogs();
            for (let i = logs.length - 1; i >= 0; i--) {
                const ex = logs[i].exercises.find(e => e.name === exerciseName);
                if (ex && ex.sets.length > 0) {
                    const lastSet = ex.sets.filter(s => s).pop();
                    if (lastSet) return lastSet.weight;
                }
            }
            return null;
        }

        function getExercisePR(exerciseName) {
            const logs = getWorkoutLogs();
            let maxWeight = 0;
            let maxVolume = 0;

            logs.forEach(log => {
                const ex = log.exercises.find(e => e.name === exerciseName);
                if (ex) {
                    ex.sets.filter(s => s).forEach(set => {
                        if (set.weight > maxWeight) maxWeight = set.weight;
                        const volume = set.weight * set.reps;
                        if (volume > maxVolume) maxVolume = volume;
                    });
                }
            });

            return { maxWeight, maxVolume };
        }

        function checkAndNotifyPR(exerciseName, weight, reps) {
            const pr = getExercisePR(exerciseName);
            if (weight > pr.maxWeight && pr.maxWeight > 0) {
                addNotification(`üèÜ ¬°Nuevo PR! ${exerciseName}: ${weight}kg`, 'üéâ');
            }
        }

        function addSetToExercise(exerciseIdx) {
            const workout = getTodayWorkout();
            const exercise = workout.exercises[exerciseIdx];
            exercise.sets.push(null);
            saveTodayWorkout(workout);
            render();
        }

        function removeSetFromExercise(exerciseIdx, setIdx) {
            const workout = getTodayWorkout();
            const exercise = workout.exercises[exerciseIdx];
            if (exercise.sets.length > 1) {
                exercise.sets.splice(setIdx, 1);
                saveTodayWorkout(workout);
                render();
            }
        }

        // Routine Templates Functions
        function getRoutineTemplates() {
            return JSON.parse(getStorage('routine-templates') || '[]');
        }

        function saveRoutineTemplates(templates) {
            setStorage('routine-templates', JSON.stringify(templates));
        }

        function openRoutineTemplatesModal() {
            renderRoutineTemplates();
            document.getElementById('routineTemplatesModal').classList.remove('hidden');
        }

        function closeRoutineTemplatesModal() {
            document.getElementById('routineTemplatesModal').classList.add('hidden');
        }

        function renderRoutineTemplates() {
            const templates = getRoutineTemplates();
            const container = document.getElementById('routineTemplatesContent');

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <span class="text-4xl block mb-3">üìã</span>
                        <p class="text-gray-500 mb-2">No tienes rutinas guardadas</p>
                        <p class="text-sm text-gray-400">Guarda tu rutina actual para usarla otro d√≠a</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = templates.map(function(template, idx) {
                var exerciseCount = template.exercises.length;
                var exerciseNames = template.exercises.map(function(e) { return e.name; }).slice(0, 3).join(', ');
                if (template.exercises.length > 3) exerciseNames += '...';
                return `
                    <div class="bg-gray-50 rounded-xl p-4 mb-3">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800">${template.name}</h4>
                                <p class="text-xs text-gray-500">${exerciseCount} ejercicios</p>
                            </div>
                            <button onclick="deleteRoutineTemplate(${idx})" class="text-gray-400 hover:text-red-500 p-1" title="Eliminar">üóëÔ∏è</button>
                        </div>
                        <p class="text-xs text-gray-600 mb-3">${exerciseNames}</p>
                        <button onclick="loadRoutineTemplate(${idx})" class="w-full py-2 bg-purple-100 text-purple-700 rounded-lg font-medium hover:bg-purple-200 transition text-sm">
                            üì• Cargar esta rutina
                        </button>
                    </div>
                `;
            }).join('');
        }

        function saveCurrentRoutineAsTemplate() {
            const workout = getTodayWorkout();
            if (workout.exercises.length === 0) {
                alert('No hay ejercicios para guardar. Agrega ejercicios primero.');
                return;
            }
            document.getElementById('routineTemplateName').value = '';
            document.getElementById('nameRoutineModal').classList.remove('hidden');
        }

        function closeNameRoutineModal() {
            document.getElementById('nameRoutineModal').classList.add('hidden');
        }

        function confirmSaveRoutineTemplate() {
            var name = document.getElementById('routineTemplateName').value.trim();
            if (!name) {
                alert('Por favor ingresa un nombre para la rutina');
                return;
            }

            var workout = getTodayWorkout();
            var templates = getRoutineTemplates();

            var template = {
                id: Date.now(),
                name: name,
                createdAt: new Date().toISOString(),
                exercises: workout.exercises.map(function(ex) {
                    return {
                        name: ex.name,
                        targetSets: Math.max(4, ex.sets.length)
                    };
                })
            };

            templates.push(template);
            saveRoutineTemplates(templates);

            closeNameRoutineModal();
            renderRoutineTemplates();
            showNotification('Rutina guardada: ' + name, 'üíæ');
        }

        function loadRoutineTemplate(templateIdx) {
            var templates = getRoutineTemplates();
            var template = templates[templateIdx];
            if (!template) return;

            if (confirm('¬øCargar la rutina "' + template.name + '"? Se agregar√°n los ejercicios a tu entrenamiento de hoy.')) {
                var workout = getTodayWorkout();

                template.exercises.forEach(function(ex) {
                    var exists = workout.exercises.some(function(e) { return e.name === ex.name; });
                    if (!exists) {
                        workout.exercises.push({
                            name: ex.name,
                            sets: Array(ex.targetSets || 4).fill(null)
                        });
                    }
                });

                saveTodayWorkout(workout);
                closeRoutineTemplatesModal();
                render();
                showNotification('Rutina cargada: ' + template.name, 'üì•');
            }
        }

        function deleteRoutineTemplate(templateIdx) {
            if (confirm('¬øEliminar esta rutina guardada?')) {
                var templates = getRoutineTemplates();
                templates.splice(templateIdx, 1);
                saveRoutineTemplates(templates);
                renderRoutineTemplates();
            }
        }

        function showNotification(message, icon) {
            var existing = document.getElementById('quickNotification');
            if (existing) existing.remove();

            var notification = document.createElement('div');
            notification.id = 'quickNotification';
            notification.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[100]';
            notification.innerHTML = '<div class="bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2"><span>' + icon + '</span><span>' + message + '</span></div>';
            document.body.appendChild(notification);

            setTimeout(function() {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '0';
                setTimeout(function() { notification.remove(); }, 300);
            }, 2500);
        }

        // Rest Timer
        function startRestTimer(seconds = 90) {
            restTimerSeconds = seconds;
            restTimerRunning = true;
            document.getElementById('restTimerFloat').classList.remove('hidden');
            document.getElementById('restTimerToggle').textContent = '‚è∏Ô∏è';
            updateRestTimerDisplay();

            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerInterval = setInterval(() => {
                if (restTimerRunning) {
                    restTimerSeconds--;
                    updateRestTimerDisplay();
                    if (restTimerSeconds <= 0) {
                        finishRestTimer();
                    }
                }
            }, 1000);
        }

        function updateRestTimerDisplay() {
            const mins = Math.floor(restTimerSeconds / 60);
            const secs = restTimerSeconds % 60;
            document.getElementById('restTimerDisplay').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function toggleRestTimer() {
            restTimerRunning = !restTimerRunning;
            document.getElementById('restTimerToggle').textContent = restTimerRunning ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        }

        function adjustRestTimer(delta) {
            restTimerSeconds = Math.max(0, restTimerSeconds + delta);
            updateRestTimerDisplay();
        }

        function setRestTimer(seconds) {
            restTimerSeconds = seconds;
            restTimerRunning = true;
            document.getElementById('restTimerToggle').textContent = '‚è∏Ô∏è';
            updateRestTimerDisplay();
        }

        function finishRestTimer() {
            clearInterval(restTimerInterval);
            restTimerInterval = null;
            restTimerRunning = false;

            // Play sound or vibrate
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }

            // Try to play a sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {}

            // Visual alert in timer
            const display = document.getElementById('restTimerDisplay');
            display.textContent = '¬°GO!';
            display.classList.add('animate-pulse');

            // Show motivational notification
            const messages = [
                '¬°Se termin√≥ el descanso! ¬°Vamos con todo! üí™',
                '¬°A darle! ¬°Siguiente serie! üî•',
                '¬°Descanso completado! ¬°T√∫ puedes! üí•',
                '¬°Vamos! ¬°Una serie m√°s! üöÄ',
                '¬°Arriba! ¬°A por la siguiente! ‚ö°'
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            showRestEndNotification(randomMsg);

            setTimeout(() => {
                display.classList.remove('animate-pulse');
                closeRestTimer();
            }, 4000);
        }

        function showRestEndNotification(message) {
            // Remove existing notification if any
            const existing = document.getElementById('restEndNotification');
            if (existing) existing.remove();

            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'restEndNotification';
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-[100] animate-bounce';
            notification.innerHTML = `
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3">
                    <span class="text-3xl">‚è∞</span>
                    <div>
                        <p class="font-bold text-lg">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s, transform 0.5s';
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => notification.remove(), 500);
            }, 4000);

            // Also try browser notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('‚è∞ ¬°Descanso terminado!', {
                    body: message,
                    icon: '/icons/icon-192x192.png',
                    tag: 'rest-timer'
                });
            }
        }

        function closeRestTimer() {
            if (restTimerInterval) clearInterval(restTimerInterval);
            document.getElementById('restTimerFloat').classList.add('hidden');
        }

        // Set gym sub-tab
        function setGymSubTab(tab) {
            gymSubTab = tab;
            render();
        }

        // ========== MEAL MODALS ==========
        function openEditMealModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const meal = getMeals()[index];

            document.getElementById('editMealTime').value = meal.time;
            document.getElementById('editMealName').value = meal.name;
            document.getElementById('editMealEmoji').value = meal.emoji;
            document.getElementById('editMealOptions').value = meal.options.join('\n');
            document.getElementById('editMealMacros').value = meal.macros;

            document.getElementById('editMealModal').classList.remove('hidden');
        }

        function closeEditMealModal() {
            document.getElementById('editMealModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveMealEdit() {
            const newMeal = {
                time: document.getElementById('editMealTime').value,
                name: document.getElementById('editMealName').value,
                emoji: document.getElementById('editMealEmoji').value,
                options: document.getElementById('editMealOptions').value.split('\n').filter(o => o.trim()),
                macros: document.getElementById('editMealMacros').value
            };
            const indexToEdit = editingIndex; // Guardar antes de cerrar modal

            closeEditMealModal();

            showReplaceAllModal('meal',
                `Este cambio aplicar√° a "${newMeal.name}" en todos los d√≠as. ¬øContinuar?`,
                (confirmed) => {
                    if (confirmed) {
                        let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
                        meals[indexToEdit] = newMeal;
                        meals.sort((a, b) => a.time.localeCompare(b.time));
                        customMeals = meals;
                        setStorage('custom-meals', JSON.stringify(customMeals));
                    }
                }
            );
        }

        function deleteMeal() {
            let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
            meals.splice(deletingIndex, 1);
            customMeals = meals;
            setStorage('custom-meals', JSON.stringify(customMeals));
        }

        function openAddMealModal() {
            document.getElementById('addMealTime').value = '';
            document.getElementById('addMealName').value = '';
            document.getElementById('addMealEmoji').value = 'üçΩÔ∏è';
            document.getElementById('addMealOptions').value = '';
            document.getElementById('addMealMacros').value = '';
            document.getElementById('addMealModal').classList.remove('hidden');
        }

        function closeAddMealModal() {
            document.getElementById('addMealModal').classList.add('hidden');
        }

        function saveNewMeal() {
            const time = document.getElementById('addMealTime').value;
            const name = document.getElementById('addMealName').value;

            if (!time || !name) {
                alert('Por favor completa la hora y el nombre');
                return;
            }

            let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
            meals.push({
                time,
                name,
                emoji: document.getElementById('addMealEmoji').value || 'üçΩÔ∏è',
                options: document.getElementById('addMealOptions').value.split('\n').filter(o => o.trim()),
                macros: document.getElementById('addMealMacros').value
            });

            meals.sort((a, b) => a.time.localeCompare(b.time));

            customMeals = meals;
            setStorage('custom-meals', JSON.stringify(customMeals));
            closeAddMealModal();
            render();
        }

        function resetMeals() {
            if (confirm('¬øRestaurar el plan de comidas original?')) {
                customMeals = null;
                removeStorage('custom-meals');
                render();
            }
        }

        // ========== GOAL MODALS ==========
        function openEditGoalModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const goal = getWeeklyGoals()[index];

            document.getElementById('editGoalWeek').value = goal.week;
            document.getElementById('editGoalDates').value = goal.dates;
            document.getElementById('editGoalFisica').value = goal.fisica;
            document.getElementById('editGoalPersonal').value = goal.personal;
            document.getElementById('editGoalDigital').value = goal.digital;
            document.getElementById('editGoalEspiritual').value = goal.espiritual;

            document.getElementById('editGoalModal').classList.remove('hidden');
        }

        function closeEditGoalModal() {
            document.getElementById('editGoalModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveGoalEdit() {
            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));

            goals[editingIndex] = {
                week: parseInt(document.getElementById('editGoalWeek').value),
                dates: document.getElementById('editGoalDates').value,
                fisica: document.getElementById('editGoalFisica').value,
                personal: document.getElementById('editGoalPersonal').value,
                digital: document.getElementById('editGoalDigital').value,
                espiritual: document.getElementById('editGoalEspiritual').value
            };

            goals.sort((a, b) => a.week - b.week);

            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
            closeEditGoalModal();
            render();
        }

        function deleteGoal() {
            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));
            goals.splice(deletingIndex, 1);
            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
        }

        function resetGoals() {
            if (confirm('¬øRestaurar las metas originales?')) {
                customGoals = null;
                removeStorage('custom-goals');
                render();
            }
        }

        function openAddGoalModal() {
            // Pre-fill with next week number
            const goals = getWeeklyGoals();
            const maxWeek = goals.length > 0 ? Math.max(...goals.map(g => g.week)) : 0;
            document.getElementById('addGoalWeek').value = maxWeek + 1;
            document.getElementById('addGoalDates').value = '';
            document.getElementById('addGoalFisica').value = '';
            document.getElementById('addGoalPersonal').value = '';
            document.getElementById('addGoalDigital').value = '';
            document.getElementById('addGoalEspiritual').value = '';
            document.getElementById('addGoalModal').classList.remove('hidden');
        }

        function closeAddGoalModal() {
            document.getElementById('addGoalModal').classList.add('hidden');
        }

        function saveNewGoal() {
            const week = parseInt(document.getElementById('addGoalWeek').value);
            const dates = document.getElementById('addGoalDates').value;
            const fisica = document.getElementById('addGoalFisica').value;
            const personal = document.getElementById('addGoalPersonal').value;
            const digital = document.getElementById('addGoalDigital').value;
            const espiritual = document.getElementById('addGoalEspiritual').value;

            if (!week || !dates) {
                alert(getLang() === 'en' ? 'Please enter week number and dates' : 'Por favor ingresa el n√∫mero de semana y las fechas');
                return;
            }

            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));

            goals.push({
                week: week,
                dates: dates,
                fisica: fisica,
                personal: personal,
                digital: digital,
                espiritual: espiritual
            });

            // Sort by week number
            goals.sort((a, b) => a.week - b.week);

            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
            closeAddGoalModal();
            addNotification(getLang() === 'en' ? 'New goal added!' : '¬°Nueva meta agregada!', 'üéØ');
            render();
        }

        function renderProgressCircle(percent, size, strokeWidth, color, label) {
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percent / 100) * circumference;

            return `
                <div class="flex flex-col items-center">
                    <div class="relative" style="width: ${size}px; height: ${size}px;">
                        <svg class="transform -rotate-90" width="${size}" height="${size}">
                            <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="#e5e7eb" stroke-width="${strokeWidth}" fill="none"/>
                            <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#gradient-${label})" stroke-width="${strokeWidth}" fill="none" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" class="progress-ring"/>
                            <defs>
                                <linearGradient id="gradient-${label}" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:${color === 'rose' ? '#ec4899' : color === 'purple' ? '#8b5cf6' : '#06b6d4'}"/>
                                    <stop offset="100%" style="stop-color:${color === 'rose' ? '#f43f5e' : color === 'purple' ? '#a855f7' : '#0891b2'}"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-800">${percent}%</span>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500 mt-1 font-medium">${label}</span>
                </div>
            `;
        }

        function render() {
            // Preserve scroll position before re-render
            const scrollY = window.scrollY;

            const dayIndex = currentDate.getDay();
            const weekNum = getWeekNumber();
            const dayNum = getDayNumber();
            const dateKey = getDateKey();
            const dailyProgress = getDailyProgress();
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const currentStreak = getStreak();
            const bestStreak = getBestStreak();
            const schedule = getSchedule(dayIndex, dateKey);
            const gym = getGymFocus(dayIndex);
            const isCustomized = !!customSchedules[dateKey];

            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header -->
                <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-50">
                    <div class="max-w-4xl mx-auto px-3 py-2">
                        <div class="flex items-center gap-3">
                            <div class="relative flex-shrink-0 cursor-pointer group" onclick="openPhotoModal()" title="Cambiar foto de perfil">
                                <div class="w-12 h-12 rounded-full theme-gradient flex items-center justify-center text-white text-lg font-bold border-2 photo-border photo-glow overflow-hidden group-hover:opacity-80 transition">
                                    ${getUserPhoto() ? `<img src="${getUserPhoto()}" class="w-full h-full object-cover">` : currentUser.name.charAt(0).toUpperCase()}
                                </div>
                                <span class="header-photo-edit absolute -bottom-0.5 -right-0.5 text-sm group-hover:scale-110 transition">üì∑</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h1 class="header-greeting text-base font-bold gradient-text">üëã ${currentUser.name}</h1>
                                <p class="header-subtext text-xs text-gray-500">${getGoalText(currentUser.goal)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="header-badges flex flex-col items-end gap-1 text-xs flex-shrink-0">
                                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium">S${weekNum}/${totalWeeks}</span>
                                    <span class="px-2 py-0.5 bg-rose-100 text-rose-700 rounded-full font-medium">D${dayNum}/${userDuration}</span>
                                </div>
                                <!-- Notifications -->
                                <div class="relative">
                                    <button onclick="toggleNotificationsMenu()" class="p-2 text-gray-400 hover:text-purple-500 transition text-xl relative" title="Notificaciones">
                                        üîî
                                        <span id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold ${getUnreadNotificationsCount() > 0 ? '' : 'hidden'}">${getUnreadNotificationsCount()}</span>
                                    </button>
                                    <div id="notificationsMenu" class="hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-100 z-50 max-h-96 overflow-hidden">
                                        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                                            <h4 class="font-bold text-gray-800">üîî Notificaciones</h4>
                                            <button onclick="markAllNotificationsRead()" class="text-xs text-purple-600 hover:underline">Marcar todo le√≠do</button>
                                        </div>
                                        <div id="notificationsList" class="overflow-y-auto max-h-72">
                                            <!-- Notifications will be rendered here -->
                                        </div>
                                        <div class="px-4 py-2 border-t border-gray-100 bg-gray-50">
                                            <button onclick="clearAllNotifications()" class="text-xs text-red-500 hover:underline">Limpiar todas</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Settings Menu -->
                                <div class="relative">
                                    <button onclick="toggleSettingsMenu()" class="p-2 text-gray-400 hover:text-purple-500 transition text-xl" title="Configuraci√≥n">
                                        ‚öôÔ∏è
                                    </button>
                                    <div id="settingsMenu" class="hidden absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 z-50 flex flex-col" style="max-height: 70vh;">
                                        <!-- Scrollable content -->
                                        <div class="overflow-y-auto flex-1 py-2">
                                            <!-- APARIENCIA - Lo m√°s usado -->
                                            <p class="px-4 py-1 text-xs text-gray-400 font-medium uppercase">Apariencia</p>
                                            <button onclick="toggleDarkMode(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">${isDarkMode() ? '‚òÄÔ∏è' : 'üåô'}</span>
                                                <span class="text-gray-700">${isDarkMode() ? 'Modo claro' : 'Modo oscuro'}</span>
                                            </button>
                                            <div class="px-4 py-2">
                                                <p class="text-xs text-gray-400 mb-1">Vista</p>
                                                <div class="flex gap-1 p-1 bg-gray-100 rounded-xl">
                                                    <button onclick="setViewMode('minimal')" class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1.5 rounded-lg transition ${getViewMode() === 'minimal' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'}">
                                                        <span class="text-sm">${getViewModeIcon('minimal')}</span>
                                                        <span class="text-xs ${getViewMode() === 'minimal' ? 'text-purple-600 font-medium' : 'text-gray-500'}">Min</span>
                                                    </button>
                                                    <button onclick="setViewMode('medium')" class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1.5 rounded-lg transition ${getViewMode() === 'medium' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'}">
                                                        <span class="text-sm">${getViewModeIcon('medium')}</span>
                                                        <span class="text-xs ${getViewMode() === 'medium' ? 'text-purple-600 font-medium' : 'text-gray-500'}">Media</span>
                                                    </button>
                                                    <button onclick="setViewMode('maximal')" class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1.5 rounded-lg transition ${getViewMode() === 'maximal' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'}">
                                                        <span class="text-sm">${getViewModeIcon('maximal')}</span>
                                                        <span class="text-xs ${getViewMode() === 'maximal' ? 'text-purple-600 font-medium' : 'text-gray-500'}">Max</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="px-4 py-2">
                                                <p class="text-xs text-gray-400 mb-1">Iconos</p>
                                                <div class="flex gap-1 p-1 bg-gray-100 rounded-xl">
                                                    <button onclick="setIconStyle('emoji')" class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1.5 rounded-lg transition ${getIconStyle() === 'emoji' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'}">
                                                        <span class="text-sm">üòÄ</span>
                                                        <span class="text-xs ${getIconStyle() === 'emoji' ? 'text-purple-600 font-medium' : 'text-gray-500'}">Emoji</span>
                                                    </button>
                                                    <button onclick="setIconStyle('lucide')" class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1.5 rounded-lg transition ${getIconStyle() === 'lucide' ? 'bg-white shadow-sm' : 'hover:bg-gray-50'}">
                                                        <span class="text-sm"><i data-lucide="hexagon" class="w-4 h-4 inline-block"></i></span>
                                                        <span class="text-xs ${getIconStyle() === 'lucide' ? 'text-purple-600 font-medium' : 'text-gray-500'}">Lucide</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <hr class="my-2 border-gray-100">

                                            <!-- CUENTA -->
                                            <p class="px-4 py-1 text-xs text-gray-400 font-medium uppercase">Cuenta</p>
                                            <button onclick="openPhotoModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">üë§</span>
                                                <span class="text-gray-700">Mi Perfil</span>
                                            </button>
                                            <hr class="my-2 border-gray-100">

                                            <!-- FUNCIONES - Toggles √∫tiles -->
                                            <p class="px-4 py-1 text-xs text-gray-400 font-medium uppercase">Funciones</p>
                                            <button onclick="toggleReminders()" class="w-full flex items-center justify-between px-4 py-1.5 hover:bg-gray-50 transition">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-lg">üîî</span>
                                                    <span class="text-gray-700 text-sm">Notificaciones</span>
                                                </div>
                                                <div class="w-9 h-5 rounded-full transition ${getReminderSettings().enabled ? 'bg-purple-500' : 'bg-gray-300'} relative">
                                                    <div class="absolute top-0.5 ${getReminderSettings().enabled ? 'right-0.5' : 'left-0.5'} w-4 h-4 bg-white rounded-full shadow transition-all"></div>
                                                </div>
                                            </button>
                                            ${getReminderSettings().enabled ? `
                                            <div class="px-4 py-1">
                                                <select onchange="setReminderMinutes(this.value)" class="w-full px-2 py-1 text-xs border border-gray-200 rounded-lg">
                                                    <option value="3" ${getReminderSettings().minutesBefore === 3 ? 'selected' : ''}>Avisar 3 min antes</option>
                                                    <option value="5" ${getReminderSettings().minutesBefore === 5 ? 'selected' : ''}>Avisar 5 min antes</option>
                                                    <option value="10" ${getReminderSettings().minutesBefore === 10 ? 'selected' : ''}>Avisar 10 min antes</option>
                                                    <option value="15" ${getReminderSettings().minutesBefore === 15 ? 'selected' : ''}>Avisar 15 min antes</option>
                                                </select>
                                            </div>
                                            ` : ''}
                                            <button onclick="toggleFloatingButton('pomodoro')" class="w-full flex items-center justify-between px-4 py-1.5 hover:bg-gray-50 transition">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-lg">üçÖ</span>
                                                    <span class="text-gray-700 text-sm">Pomodoro</span>
                                                </div>
                                                <div class="w-9 h-5 rounded-full transition ${isFloatingButtonEnabled('pomodoro') ? 'bg-purple-500' : 'bg-gray-300'} relative">
                                                    <div class="absolute top-0.5 ${isFloatingButtonEnabled('pomodoro') ? 'right-0.5' : 'left-0.5'} w-4 h-4 bg-white rounded-full shadow transition-all"></div>
                                                </div>
                                            </button>
                                            <button onclick="toggleFloatingButton('expenses')" class="w-full flex items-center justify-between px-4 py-1.5 hover:bg-gray-50 transition">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-lg">üí∞</span>
                                                    <span class="text-gray-700 text-sm">Gastos</span>
                                                </div>
                                                <div class="w-9 h-5 rounded-full transition ${isFloatingButtonEnabled('expenses') ? 'bg-purple-500' : 'bg-gray-300'} relative">
                                                    <div class="absolute top-0.5 ${isFloatingButtonEnabled('expenses') ? 'right-0.5' : 'left-0.5'} w-4 h-4 bg-white rounded-full shadow transition-all"></div>
                                                </div>
                                            </button>
                                            <hr class="my-2 border-gray-100">

                                            <!-- AVANZADO - Cosas menos usadas -->
                                            <p class="px-4 py-1 text-xs text-gray-400 font-medium uppercase">Avanzado</p>
                                            <button onclick="openActivitySetupWizard(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">üìÖ</span>
                                                <span class="text-gray-700">Personalizar actividades</span>
                                            </button>
                                            <button onclick="openTemplateModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">üìã</span>
                                                <span class="text-gray-700">Plantillas</span>
                                            </button>
                                            <button onclick="openCategoriesModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">üè∑Ô∏è</span>
                                                <span class="text-gray-700">Categor√≠as</span>
                                            </button>
                                            <button onclick="openProfileModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">‚öñÔ∏è</span>
                                                <span class="text-gray-700">Datos F√≠sicos</span>
                                            </button>
                                            <hr class="my-2 border-gray-100">

                                            <!-- DATOS -->
                                            <p class="px-4 py-1 text-xs text-gray-400 font-medium uppercase">Datos</p>
                                            <button onclick="syncAllData(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-blue-50 transition text-left">
                                                <span class="text-xl">‚òÅÔ∏è</span>
                                                <span class="text-blue-600">Sincronizar</span>
                                            </button>
                                            <button onclick="openExportModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition text-left">
                                                <span class="text-xl">üì•</span>
                                                <span class="text-gray-700">Exportar</span>
                                            </button>
                                            <button onclick="openResetModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-orange-50 transition text-left">
                                                <span class="text-xl">üîÑ</span>
                                                <span class="text-orange-600">Reiniciar</span>
                                            </button>
                                        </div>
                                        <!-- Fixed logout button at bottom -->
                                        <div class="border-t border-gray-100 py-2 bg-white rounded-b-xl">
                                            <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-red-50 transition text-left">
                                                <span class="text-xl">üö™</span>
                                                <span class="text-red-600">Cerrar sesi√≥n</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Progress Dashboard -->
                <div class="progress-dashboard bg-white/80 backdrop-blur-sm border-b">
                    <div class="max-w-4xl mx-auto px-4 py-1">
                        <!-- Toggle Button -->
                        <button onclick="toggleDashboard()" class="w-full flex items-center justify-center gap-2 py-1 text-gray-500 hover:text-purple-600 transition">
                            <span class="text-xs font-medium">${dashboardVisible ? 'üìä Ocultar' : 'üìä Mostrar progreso'}</span>
                            <span class="text-sm">${dashboardVisible ? '‚ñ≤' : '‚ñº'}</span>
                        </button>

                        <!-- Collapsible Content -->
                        <div class="${dashboardVisible ? '' : 'hidden'} pt-3">
                            <div class="flex justify-around items-center">
                                ${renderProgressCircle(dailyProgress, 80, 8, 'rose', 'HOY')}
                                ${renderProgressCircle(weeklyProgress, 80, 8, 'purple', 'SEMANA')}
                                ${renderProgressCircle(totalProgress, 80, 8, 'cyan', 'TOTAL')}
                            </div>

                            <!-- Racha de d√≠as -->
                            <div class="streak-section mt-4 flex justify-center gap-6">
                                <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-100 to-yellow-100 rounded-xl">
                                    <span class="text-2xl">üî•</span>
                                    <div>
                                        <p class="text-lg font-bold text-orange-600">${currentStreak}</p>
                                        <p class="text-xs text-orange-500">Racha actual</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl">
                                    <span class="text-2xl">üèÜ</span>
                                    <div>
                                        <p class="text-lg font-bold text-purple-600">${bestStreak}</p>
                                        <p class="text-xs text-purple-500">Mejor racha</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 text-center">
                                <p class="motivational-text text-sm text-gray-500">
                                    ${totalProgress === 100 ? 'üèÜ ¬°PROGRAMA COMPLETADO! ¬°Eres una campeona!' :
                                      currentStreak >= 7 ? 'üî• ¬°' + currentStreak + ' d√≠as seguidos! ¬°Imparable!' :
                                      currentStreak >= 3 ? 'üí™ ¬°' + currentStreak + ' d√≠as de racha! ¬°Sigue as√≠!' :
                                      totalProgress >= 50 ? '‚ú® ¬°M√°s de la mitad! No te detengas' :
                                      'üåü ¬°Cada d√≠a cuenta! T√∫ puedes'}
                                </p>
                                <button onclick="openShareModal()" class="share-button mt-2 px-4 py-2 theme-btn rounded-full text-sm font-medium hover:opacity-90 transition inline-flex items-center gap-2">
                                    üì§ Compartir mi progreso
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Navigation -->
                <div class="bg-white/60 backdrop-blur-sm border-b">
                    <div class="max-w-4xl mx-auto px-4 py-2">
                        <div class="flex items-center justify-between">
                            <button onclick="navigateDay(-1)" class="p-2 hover:bg-white rounded-full transition text-xl ${currentDate <= startDate ? 'opacity-30' : ''}">‚óÄÔ∏è</button>
                            <div class="text-center cursor-pointer hover:bg-white/50 px-3 py-1 rounded-xl transition" onclick="openCalendarModal()">
                                <p class="text-lg font-bold text-gray-800">${daysSpanish[dayIndex]} <span class="font-normal text-gray-500 text-sm">üìÖ ${currentDate.getDate()} ${monthsSpanish[currentDate.getMonth()]}</span></p>
                                ${isCustomized ? '<span class="text-xs text-purple-500">‚úèÔ∏è Personalizado</span>' : ''}
                            </div>
                            <button onclick="navigateDay(1)" class="p-2 hover:bg-white rounded-full transition text-xl ${currentDate >= endDate ? 'opacity-30' : ''}">‚ñ∂Ô∏è</button>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white/40 border-b sticky top-[56px] z-40 mt-1">
                    <div class="max-w-4xl mx-auto px-4 py-2">
                        <div data-tabs-container="main" class="flex gap-2 overflow-x-auto no-scrollbar py-1 relative" style="-webkit-overflow-scrolling: touch;">
                            ${getMainTabsOrder().map((tabId, index) => {
                                const tabsConfig = getMainTabsConfig();
                                const tab = tabsConfig[tabId];
                                if (!tab) return '';
                                const isActive = activeTab === tabId;
                                return `
                                    <button
                                        data-tab="${tabId}"
                                        data-index="${index}"
                                        onclick="if(!isDragging) setTab('${tabId}')"
                                        ontouchstart="handleTabTouchStart(event, '${tabId}', 'main')"
                                        ontouchmove="handleTabTouchMove(event)"
                                        ontouchend="handleTabTouchEnd(event)"
                                        onmousedown="handleTabMouseDown(event, '${tabId}', 'main')"
                                        onmouseup="handleTabMouseUp(event)"
                                        class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap select-none flex-shrink-0 ${isActive ? 'bg-white shadow-md text-purple-600' : 'bg-white/80 text-gray-600 hover:bg-white'}"
                                        style="touch-action: pan-x;">
                                        <span>${tab.emoji}</span> <span class="tab-label">${tab.label}</span>
                                    </button>
                                `;
                            }).join('')}
                            <div class="drag-indicator hidden absolute top-0 bottom-0 w-0.5 bg-purple-500 rounded-full z-10"></div>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <main class="max-w-4xl mx-auto px-4 py-3">
                    ${activeTab === 'agenda' ? renderAgenda(schedule, gym, dateKey, dailyProgress, isCustomized) : ''}
                    ${activeTab === 'habits' ? renderHabits(dateKey) : ''}
                    ${activeTab === 'gym' ? renderGym(gym, dayIndex, weekNum) : ''}
                    ${activeTab === 'meals' ? renderMeals() : ''}
                    ${activeTab === 'fasting' ? renderFasting() : ''}
                    ${activeTab === 'goals' ? renderGoals(weekNum) : ''}
                    ${activeTab === 'notes' ? renderNotes(dateKey) : ''}
                    ${activeTab === 'gastos' ? renderGastos() : ''}
                    ${activeTab === 'stats' ? renderStats() : ''}
                </main>

                <!-- Footer -->
                <footer class="bg-white/80 backdrop-blur-sm border-t mt-8">
                    <div class="max-w-4xl mx-auto px-4 py-6 text-center">
                        <p class="text-lg font-medium text-gray-700">"El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a"</p>
                        <p class="text-purple-500 mt-2 text-xl">‚ú® ¬°T√∫ puedes, ${currentUser.name.split(' ')[0]}! ‚ú®</p>
                    </div>
                </footer>
            `;

            // Restore scroll position after re-render
            requestAnimationFrame(() => {
                window.scrollTo(0, scrollY);
            });

            // Initialize Lucide icons if in lucide mode
            initLucideIcons();
        }

        function renderAgenda(schedule, gym, dateKey, dailyProgress, isCustomized) {
            const completedCount = schedule.filter((_, idx) => completedActivities[`${dateKey}-${idx}`]).length;

            return `
                <div class="space-y-3">
                    <div class="agenda-hero theme-gradient rounded-2xl p-5 text-white shadow-lg mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <span class="emoji-indicator text-5xl">${gym.icon}</span>
                                <div>
                                    <p class="font-bold text-xl">${gym.name}</p>
                                    <p class="text-white/80 text-sm">${schedule.length} actividades hoy</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-4xl font-bold">${dailyProgress}%</p>
                                <p class="text-white/80 text-sm">${completedCount}/${schedule.length} completadas</p>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-white rounded-full progress-bar" style="width: ${dailyProgress}%"></div>
                        </div>
                    </div>

                    <div class="action-buttons-grid grid grid-cols-4 gap-2 mb-4">
                        <button onclick="openAddModal()" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-purple-600 border border-purple-100" title="Agregar Actividad">
                            <span class="text-lg">‚ûï</span>
                            <span class="text-xs">Agregar</span>
                        </button>
                        <button onclick="focusSearchInput()" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-blue-600 border border-blue-100" title="Buscar">
                            <span class="text-lg">üîç</span>
                            <span class="text-xs">Buscar</span>
                        </button>
                        <button onclick="openCleanModal('agenda')" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-orange-500 border border-orange-100" title="Limpiar">
                            <span class="text-lg">üßπ</span>
                            <span class="text-xs">Limpiar</span>
                        </button>
                        <button onclick="resetDay()" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-gray-500 border border-gray-100" title="Restaurar">
                            <span class="text-lg">üîÑ</span>
                            <span class="text-xs">Restaurar</span>
                        </button>
                    </div>

                    <!-- Search and Filter Bar (toggle visibility) -->
                    ${searchVisible ? `
                    <div id="searchSection" class="bg-white rounded-xl p-3 shadow-sm mb-4 border-2 border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">üîç Buscar y Filtrar</span>
                            <button onclick="toggleSearch()" class="text-gray-400 hover:text-gray-600 text-lg">‚úï</button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative flex-1">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                                <input type="text" id="searchInput" value="${searchQuery}" oninput="filterActivities()" placeholder="Buscar actividades..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none text-sm">
                            </div>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar">
                                <button onclick="setFilter('')" class="filter-btn px-3 py-2 rounded-lg text-xs font-medium transition whitespace-nowrap ${!activeFilter ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                    Todas
                                </button>
                                ${Object.entries(categoryColors).map(([cat, colors]) => `
                                    <button onclick="setFilter('${cat}')" class="filter-btn px-3 py-2 rounded-lg text-xs font-medium transition whitespace-nowrap ${activeFilter === cat ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                        ${cat === 'habitos' ? '‚òÄÔ∏è' : cat === 'nutricion' ? 'ü•ó' : cat === 'fisico' ? 'üí™' : cat === 'personal' ? 'üìö' : cat === 'digital' ? 'üì±' : cat === 'espiritual' ? 'üßò' : 'üò¥'}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${schedule.filter((item, idx) => {
                        const searchTerm = (searchQuery || '').toLowerCase();
                        const matchesSearch = !searchTerm || item.activity.toLowerCase().includes(searchTerm) || item.time.includes(searchTerm);
                        const matchesFilter = !activeFilter || item.category === activeFilter;
                        return matchesSearch && matchesFilter;
                    }).map((item) => {
                        const originalIdx = schedule.indexOf(item);
                        const colors = categoryColors[item.category] || categoryColors.personal;
                        const isCompleted = completedActivities[`${dateKey}-${originalIdx}`];
                        return `
                            <div class="schedule-item ${colors.bg} ${colors.border} border rounded-xl p-4 transition-all card-hover ${isCompleted ? 'checked-item' : ''}">
                                <div class="flex items-start gap-4">
                                    <div onclick="toggleActivity(${originalIdx})" class="emoji-indicator w-12 h-12 rounded-full ${isCompleted ? 'bg-green-500' : colors.badge} flex items-center justify-center flex-shrink-0 text-xl transition-all cursor-pointer hover:scale-110 ${isCompleted ? 'text-white' : ''}">
                                        ${isCompleted ? '‚úì' : '‚óã'}
                                    </div>
                                    <div class="flex-1 min-w-0" onclick="toggleActivity(${originalIdx})" style="cursor: pointer;">
                                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                                            <span class="font-mono text-sm text-gray-500">${item.time}</span>
                                            <span class="duration-badge text-xs px-2 py-0.5 rounded-full ${colors.badge} ${colors.text}">${item.duration}</span>
                                        </div>
                                        <p class="font-medium ${isCompleted ? 'line-through text-gray-400' : 'text-gray-800'}">${item.activity}</p>
                                    </div>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <div class="flex flex-col gap-0.5 mr-1">
                                            <button onclick="moveActivity(${originalIdx}, -1)" class="btn-icon w-7 h-7 rounded bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 text-xs ${originalIdx === 0 ? 'opacity-30 cursor-not-allowed' : ''}" title="Subir" ${originalIdx === 0 ? 'disabled' : ''}>
                                                ‚ñ≤
                                            </button>
                                            <button onclick="moveActivity(${originalIdx}, 1)" class="btn-icon w-7 h-7 rounded bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 text-xs ${originalIdx === schedule.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" title="Bajar" ${originalIdx === schedule.length - 1 ? 'disabled' : ''}>
                                                ‚ñº
                                            </button>
                                        </div>
                                        <button onclick="openEditModal(${originalIdx})" class="btn-icon w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${originalIdx}, 'activity')" class="btn-icon w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}

                    ${schedule.length === 0 ? `
                        <div class="text-center py-12 text-gray-400">
                            <span class="text-5xl block mb-4">üìù</span>
                            <p>No hay actividades para este d√≠a</p>
                            <p class="text-sm">Presiona "Agregar Actividad" para comenzar</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderHabits(dateKey) {
            const habits = getHabits();
            const completedCount = habits.filter(h => checkedHabits[`${dateKey}-${h.id}`]).length;
            const progress = Math.round((completedCount / habits.length) * 100);
            const isCustomized = customHabits !== null;

            return `
                <div class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="section-header font-bold text-lg text-gray-800">H√°bitos del d√≠a</h3>
                            <span class="text-2xl font-bold text-purple-600">${completedCount}/${habits.length}</span>
                        </div>
                        <div class="h-4 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-rose-400 to-purple-500 progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-center mt-3 text-sm text-gray-500">
                            ${progress === 100 ? 'üéâ ¬°Todos los h√°bitos completados!' : progress >= 80 ? 'üí™ ¬°Casi perfecto!' : progress >= 50 ? '‚ú® ¬°Vas muy bien!' : 'üåü ¬°Sigue adelante!'}
                        </p>
                    </div>

                    <div class="action-buttons-grid grid grid-cols-3 gap-2 mb-4">
                        <button onclick="openAddHabitModal()" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-purple-600 border border-purple-100" title="Agregar H√°bito">
                            <span class="text-lg">‚ûï</span>
                            <span class="text-xs">Agregar</span>
                        </button>
                        <button onclick="openCleanModal('habits')" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-orange-500 border border-orange-100" title="Limpiar">
                            <span class="text-lg">üßπ</span>
                            <span class="text-xs">Limpiar</span>
                        </button>
                        <button onclick="resetHabits()" class="flex flex-col items-center justify-center gap-1 px-2 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-gray-500 border border-gray-100" title="Restaurar">
                            <span class="text-lg">üîÑ</span>
                            <span class="text-xs">Restaurar</span>
                        </button>
                    </div>

                    <div class="grid gap-3">
                        ${habits.map((habit, idx) => {
                            const isChecked = checkedHabits[`${dateKey}-${habit.id}`];
                            return `
                                <div class="habit-item flex items-center gap-2 p-4 rounded-xl border-2 transition-all ${isChecked ? 'habit-checked' : 'bg-white border-gray-100 hover:border-gray-200'}">
                                    <button onclick="toggleHabit(${habit.id})" class="flex items-center gap-4 flex-1 text-left">
                                        <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${isChecked ? 'bg-purple-500 border-purple-500 text-white' : 'border-gray-300'}">
                                            ${isChecked ? '‚úì' : ''}
                                        </div>
                                        <span class="emoji-indicator text-2xl">${habit.icon}</span>
                                        <span class="font-medium ${isChecked ? 'text-purple-700' : 'text-gray-700'}">${habit.name}</span>
                                    </button>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="openEditHabitModal(${idx})" class="btn-icon w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-sm" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${idx}, 'habit')" class="btn-icon w-9 h-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-sm" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderGym(gym, dayIndex, weekNum) {
            try {
                const profile = getPhysicalProfile();
                const latestWeight = getLatestWeight();
                const weightHistory = getWeightHistory();
                const todayWorkout = getTodayWorkout();

                const gymTabsOrder = getGymTabsOrder();

                return `
                <div class="space-y-4">
                    <!-- Sub-tabs -->
                    <div data-tabs-container="gym" class="flex gap-2 p-1.5 bg-gradient-to-r from-rose-100 to-purple-100 rounded-2xl relative overflow-x-auto no-scrollbar shadow-sm border border-rose-200/50">
                        ${gymTabsOrder.map((tabId, index) => {
                            const tabsConfig = getGymTabsConfig();
                            const tab = tabsConfig[tabId];
                            if (!tab) return '';
                            const isActive = gymSubTab === tabId;
                            return `
                                <button
                                    data-tab="${tabId}"
                                    data-index="${index}"
                                    onclick="if(!isDragging) { setGymSubTabValue('${tabId}'); render(); }"
                                    ontouchstart="handleTabTouchStart(event, '${tabId}', 'gym')"
                                    ontouchmove="handleTabTouchMove(event)"
                                    ontouchend="handleTabTouchEnd(event)"
                                    onmousedown="handleTabMouseDown(event, '${tabId}', 'gym')"
                                    onmouseup="handleTabMouseUp(event)"
                                    class="flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition select-none whitespace-nowrap ${isActive ? 'bg-white shadow-md text-rose-600 border border-rose-200' : 'text-gray-600 hover:bg-white/50'}"
                                    style="touch-action: pan-x;">
                                    ${tab.emoji} ${tab.label}
                                </button>
                            `;
                        }).join('')}
                        <div class="drag-indicator hidden absolute top-0 bottom-0 w-0.5 bg-rose-500 rounded-full z-10"></div>
                    </div>

                    ${gymSubTab === 'profile' ? renderGymProfile(profile, latestWeight, weightHistory) : ''}
                    ${gymSubTab === 'workout' ? renderGymWorkout(gym, dayIndex, todayWorkout) : ''}
                    ${gymSubTab === 'macros' ? renderGymMacros() : ''}
                    ${gymSubTab === 'history' ? renderGymHistory() : ''}
                </div>
            `;
            } catch (error) {
                console.error('Error in renderGym:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-xl">Error: ${error.message}</div>`;
            }
        }

        function renderGymProfile(profile, latestWeight, weightHistory) {
            try {
                const goalDiff = latestWeight && profile.goalWeight ? (latestWeight.weight - profile.goalWeight).toFixed(1) : null;
                const last7Days = weightHistory.slice(-7);

            return `
                <!-- Current Stats -->
                <div class="theme-card rounded-2xl p-5 text-white shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">‚öñÔ∏è Mi Progreso</h3>
                        <button onclick="openProfileModal()" class="text-white/80 hover:text-white text-sm">‚öôÔ∏è Configurar</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div class="bg-white/20 rounded-xl p-3">
                            <p class="text-2xl font-bold">${latestWeight ? latestWeight.weight : '--'}</p>
                            <p class="text-xs opacity-80">kg actual</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p class="text-2xl font-bold">${profile.goalWeight || '--'}</p>
                            <p class="text-xs opacity-80">kg meta</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p class="text-2xl font-bold">${goalDiff ? (goalDiff > 0 ? '-' + goalDiff : '+' + Math.abs(goalDiff)) : '--'}</p>
                            <p class="text-xs opacity-80">kg faltan</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-3">
                    <button onclick="openWeightModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                        <span class="text-xl">‚öñÔ∏è</span> Registrar Peso
                    </button>
                </div>

                <!-- Weight Graph -->
                ${weightHistory.length > 1 ? `
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4">üìà Evoluci√≥n del Peso</h4>
                        <div class="h-40 flex items-end gap-1">
                            ${(() => {
                                const weights = last7Days.map(w => w.weight);
                                const min = Math.min(...weights) - 1;
                                const max = Math.max(...weights) + 1;
                                const range = max - min || 1;
                                return last7Days.map((entry, i) => {
                                    const height = ((entry.weight - min) / range) * 100;
                                    const isLatest = i === last7Days.length - 1;
                                    return `
                                        <div class="flex-1 flex flex-col items-center gap-1">
                                            <span class="text-xs font-medium ${isLatest ? 'text-purple-600' : 'text-gray-500'}">${entry.weight}</span>
                                            <div class="w-full ${isLatest ? 'bg-gradient-to-t from-purple-500 to-pink-500' : 'bg-gray-200'} rounded-t" style="height: ${Math.max(height, 10)}%"></div>
                                            <span class="text-xs text-gray-400">${new Date(entry.date).toLocaleDateString('es', {day: 'numeric', month: 'short'}).split(' ')[0]}</span>
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                ` : `
                    <div class="bg-white rounded-2xl p-5 shadow-sm text-center">
                        <span class="text-4xl mb-2 block">üìä</span>
                        <p class="text-gray-500">Registra tu peso para ver el gr√°fico de evoluci√≥n</p>
                    </div>
                `}

                <!-- Latest Measurements -->
                ${latestWeight && (latestWeight.waist || latestWeight.hip || latestWeight.thigh) ? `
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">üìê √öltimas Medidas</h4>
                        <div class="grid grid-cols-4 gap-3 text-center">
                            ${latestWeight.waist ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.waist}</p><p class="text-xs text-gray-500">Cintura</p></div>` : ''}
                            ${latestWeight.hip ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.hip}</p><p class="text-xs text-gray-500">Cadera</p></div>` : ''}
                            ${latestWeight.thigh ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.thigh}</p><p class="text-xs text-gray-500">Pierna</p></div>` : ''}
                            ${latestWeight.arm ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.arm}</p><p class="text-xs text-gray-500">Brazo</p></div>` : ''}
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-right">Actualizado: ${new Date(latestWeight.date).toLocaleDateString('es-CL')}</p>
                    </div>
                ` : ''}

                <!-- Profile Info -->
                <div class="bg-purple-50 border border-purple-200 rounded-2xl p-5">
                    <h4 class="font-bold text-purple-800 mb-2">üë§ Mi Perfil</h4>
                    <div class="text-purple-700 text-sm space-y-1">
                        <p>üìè Estatura: ${profile.height ? profile.height + ' cm' : 'No configurada'}</p>
                        <p>üéØ Meta: ${profile.goalWeight ? profile.goalWeight + ' kg' : 'No configurada'}</p>
                        <p>üìÖ Check-in: ${['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][profile.checkinDay || 1]}</p>
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('Error in renderGymProfile:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-xl">Error en Perfil: ${error.message}</div>`;
            }
        }

        function renderGymWorkout(gym, dayIndex, todayWorkout) {
            try {
                const completedSets = todayWorkout.exercises.reduce((sum, ex) => sum + ex.sets.filter(s => s).length, 0);
                const totalSets = todayWorkout.exercises.length * 4;
                const activePlan = getActiveTrainingPlan();
                const hasNoPlan = !activePlan;
                const isEmptyRoutine = !gym.name || gym.name === '' || gym.name === 'Descanso';
                const noExercisesToday = todayWorkout.exercises.length === 0;

                // Show "Create Plan" empty state if no plan and empty routine
                if (hasNoPlan && isEmptyRoutine && noExercisesToday) {
                    return `
                        <div class="text-center py-12">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-rose-100 to-purple-100 rounded-full flex items-center justify-center mb-4">
                                <span class="text-4xl">üèãÔ∏è</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Sin plan de entrenamiento</h3>
                            <p class="text-gray-500 mb-6">Crea un plan personalizado basado en tus objetivos</p>
                            <button onclick="openTrainingPlanWizard()" class="px-6 py-3 bg-gradient-to-r from-rose-500 to-purple-500 text-white rounded-xl font-medium hover:opacity-90 transition shadow-lg">
                                ‚ûï Agregar Plan
                            </button>
                            <div class="mt-4">
                                <button onclick="openAddWorkoutExerciseModal()" class="text-purple-600 text-sm hover:underline">
                                    o agregar ejercicios manualmente
                                </button>
                            </div>
                        </div>
                    `;
                }

            return `
                <!-- Today's Routine Header -->
                <div class="theme-card rounded-2xl p-5 text-white shadow-lg">
                    <div class="flex items-center gap-4">
                        <span class="text-5xl">${gym.icon}</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold">${gym.name}</h3>
                            <p class="opacity-90 text-sm">${daysSpanish[dayIndex]}</p>
                            ${activePlan ? '<span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">' + activePlan.splitName + '</span>' : ''}
                        </div>
                        ${todayWorkout.exercises.length > 0 ? `
                            <div class="text-right">
                                <p class="text-2xl font-bold">${completedSets}</p>
                                <p class="text-xs opacity-80">series</p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Plan Actions -->
                <div class="flex gap-2">
                    <button onclick="openAddWorkoutExerciseModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-dashed border-purple-200">
                        <span class="text-lg">‚ûï</span> Ejercicio
                    </button>
                    <button onclick="openTrainingPlanWizard()" class="px-4 py-3 bg-gradient-to-r from-rose-500 to-purple-500 text-white rounded-xl shadow-sm hover:opacity-90 transition" title="${activePlan ? 'Crear nuevo plan' : 'Crear plan de entrenamiento'}">
                        üéØ
                    </button>
                    <button onclick="openRoutineTemplatesModal()" class="px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition text-amber-600 border border-amber-200" title="Mis rutinas guardadas">
                        üìã
                    </button>
                    ${activePlan ? `
                        <button onclick="deleteTrainingPlan()" class="px-4 py-3 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition" title="Eliminar plan">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>

                <!-- Exercises -->
                ${todayWorkout.exercises.length === 0 ? `
                    <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
                        <span class="text-5xl mb-3 block">üèãÔ∏è</span>
                        <p class="text-gray-500 mb-2">No hay ejercicios registrados hoy</p>
                        <p class="text-sm text-gray-400">Los ejercicios de tu plan aparecer√°n cuando los agregues</p>
                    </div>
                ` : `
                    <div class="space-y-4">
                        ${todayWorkout.exercises.map((exercise, exIdx) => {
                            const pr = getExercisePR(exercise.name);
                            const lastWeight = getLastWeight(exercise.name);
                            const completedSetsCount = exercise.sets.filter(s => s).length;

                            return `
                                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                                    <div class="p-4 border-b border-gray-100">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <span class="w-10 h-10 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold">${exIdx + 1}</span>
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <h4 class="font-bold text-gray-800">${exercise.name}</h4>
                                                        <button onclick="openExerciseInfoModal('${exercise.name.replace(/'/g, "\\'")}')" class="w-5 h-5 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center hover:bg-purple-200 transition" title="Ver informaci√≥n">
                                                            <span class="text-xs font-bold">i</span>
                                                        </button>
                                                    </div>
                                                    <div class="flex gap-3 text-xs text-gray-500">
                                                        ${lastWeight ? `<span>√öltimo: ${lastWeight}kg</span>` : ''}
                                                        ${pr.maxWeight ? `<span class="text-purple-600">üèÜ PR: ${pr.maxWeight}kg</span>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="removeExerciseFromWorkout(${exIdx})" class="text-gray-400 hover:text-red-500 p-2">üóëÔ∏è</button>
                                        </div>
                                    </div>

                                    <!-- Sets -->
                                    <div class="p-4">
                                        <div class="grid grid-cols-4 gap-2 text-center text-xs text-gray-500 mb-2">
                                            <span>SERIE</span>
                                            <span>KG</span>
                                            <span>REPS</span>
                                            <span></span>
                                        </div>
                                        ${(() => {
                                            const numSets = Math.max(4, exercise.sets.length);
                                            return Array.from({length: numSets}, (_, setIdx) => {
                                                const set = exercise.sets[setIdx];
                                                const isCompleted = !!set;
                                                return `
                                                    <div class="grid grid-cols-4 gap-2 items-center py-2 ${isCompleted ? 'bg-green-50 -mx-4 px-4 rounded' : ''}">
                                                        <span class="font-bold text-center ${isCompleted ? 'text-green-600' : 'text-gray-400'}">${setIdx + 1}</span>
                                                        <span class="text-center font-medium ${isCompleted ? 'text-gray-800' : 'text-gray-300'}">${set ? set.weight : '-'}</span>
                                                        <span class="text-center font-medium ${isCompleted ? 'text-gray-800' : 'text-gray-300'}">${set ? set.reps : '-'}</span>
                                                        <button onclick="openLogSetModal(${exIdx}, ${setIdx})" class="py-2 px-3 rounded-lg text-sm font-medium transition ${isCompleted ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}" title="${isCompleted ? 'Editar serie' : 'Registrar serie'}">
                                                            ${isCompleted ? '‚úèÔ∏è' : 'Log'}
                                                        </button>
                                                    </div>
                                                `;
                                            }).join('');
                                        })()}
                                        <!-- Add Set Button -->
                                        <button onclick="addSetToExercise(${exIdx})" class="w-full mt-2 py-2 border-2 border-dashed border-gray-200 rounded-lg text-gray-500 hover:border-purple-300 hover:text-purple-600 text-sm font-medium transition">
                                            + Agregar serie
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}

                <!-- Tips -->
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                    <h4 class="font-bold text-amber-800 mb-2 text-sm">üí° Tips</h4>
                    <p class="text-amber-700 text-xs">Descanso recomendado: 60-90s entre series. El temporizador se iniciar√° autom√°ticamente al completar cada serie.</p>
                </div>
            `;
            } catch (error) {
                console.error('Error in renderGymWorkout:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-xl">Error en Entreno: ${error.message}</div>`;
            }
        }

        function renderGymHistory() {
            try {
                const logs = getWorkoutLogs().slice(-14).reverse(); // Last 14 workouts
                const allExercises = new Set();
                logs.forEach(log => log.exercises.forEach(ex => allExercises.add(ex.name)));

            return `
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-4">üìÖ Entrenamientos Recientes</h4>
                    ${logs.length === 0 ? `
                        <div class="text-center py-6 text-gray-400">
                            <span class="text-4xl mb-2 block">üìã</span>
                            <p>No hay entrenamientos registrados</p>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${logs.map(log => {
                                const totalSets = log.exercises.reduce((sum, ex) => sum + ex.sets.filter(s => s).length, 0);
                                const totalVolume = log.exercises.reduce((sum, ex) => {
                                    return sum + ex.sets.filter(s => s).reduce((s, set) => s + (set.weight * set.reps), 0);
                                }, 0);

                                return `
                                    <div class="p-3 bg-gray-50 rounded-xl">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-medium text-gray-800">${new Date(log.date).toLocaleDateString('es-CL', {weekday: 'short', day: 'numeric', month: 'short'})}</span>
                                            <div class="flex gap-3 text-xs">
                                                <span class="text-purple-600">${log.exercises.length} ejercicios</span>
                                                <span class="text-gray-500">${totalSets} series</span>
                                                <span class="text-green-600">${Math.round(totalVolume).toLocaleString()}kg vol</span>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500">${log.exercises.map(e => e.name).join(', ')}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>

                <!-- PRs Section -->
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-4">üèÜ Mis Records (PRs)</h4>
                    ${allExercises.size === 0 ? `
                        <p class="text-center text-gray-400 py-4">Completa ejercicios para ver tus PRs</p>
                    ` : `
                        <div class="space-y-2">
                            ${Array.from(allExercises).slice(0, 10).map(exName => {
                                const pr = getExercisePR(exName);
                                if (!pr.maxWeight) return '';
                                return `
                                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl">
                                        <span class="text-sm font-medium text-gray-700">${exName}</span>
                                        <span class="font-bold text-orange-600">${pr.maxWeight} kg</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            } catch (error) {
                console.error('Error in renderGymHistory:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-xl">Error en Historial: ${error.message}</div>`;
            }
        }

        // ==================== MACROS CALCULATOR ====================

        function getMacrosProfile() {
            return JSON.parse(getStorage('macros-profile') || '{}');
        }

        function saveMacrosProfile(data) {
            setStorage('macros-profile', JSON.stringify(data));
        }

        function calculateBMR(weight, height, age, gender) {
            // Mifflin-St Jeor Equation
            if (gender === 'male') {
                return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
        }

        function calculateTDEE(bmr, activityLevel) {
            const multipliers = {
                sedentary: 1.2,      // Poco o nada de ejercicio
                light: 1.375,        // Ejercicio ligero 1-3 d√≠as/semana
                moderate: 1.55,      // Ejercicio moderado 3-5 d√≠as/semana
                active: 1.725,       // Ejercicio intenso 6-7 d√≠as/semana
                veryActive: 1.9      // Ejercicio muy intenso o trabajo f√≠sico
            };
            return bmr * (multipliers[activityLevel] || 1.55);
        }

        function calculateMacros(tdee, goal, weight) {
            let calories = tdee;
            let proteinMultiplier = 2.0; // g per kg

            // Adjust calories based on goal
            if (goal === 'lose') {
                calories = tdee - 500; // Deficit for weight loss
                proteinMultiplier = 2.2; // Higher protein when cutting
            } else if (goal === 'gain') {
                calories = tdee + 300; // Surplus for muscle gain
                proteinMultiplier = 2.0;
            }

            // Calculate macros
            const protein = Math.round(weight * proteinMultiplier);
            const fat = Math.round((calories * 0.25) / 9); // 25% of calories from fat
            const carbs = Math.round((calories - (protein * 4) - (fat * 9)) / 4);

            return {
                calories: Math.round(calories),
                protein,
                carbs: Math.max(carbs, 50), // Minimum 50g carbs
                fat
            };
        }

        function renderGymMacros() {
            try {
                const profile = getPhysicalProfile();
                const userProfile = getUserProfile();
                const macrosData = getMacrosProfile();
                const latestWeight = getLatestWeight();

                // Get data from profiles
                const weight = latestWeight?.weight || macrosData.weight || 60;
                const height = profile.height || macrosData.height || 165;
                const age = macrosData.age || (userProfile.birthdate ? Math.floor((new Date() - new Date(userProfile.birthdate)) / 31557600000) : 25);
                const gender = macrosData.gender || userProfile.gender || 'female';
                const activityLevel = macrosData.activityLevel || 'moderate';
                const goal = macrosData.goal || 'maintain';

                // Calculate
                const bmr = calculateBMR(weight, height, age, gender === 'male' || gender === 'Male' ? 'male' : 'female');
                const tdee = calculateTDEE(bmr, activityLevel);
                const macros = calculateMacros(tdee, goal, weight);

                const activityLabels = {
                    sedentary: 'Sedentario (poco ejercicio)',
                    light: 'Ligero (1-3 d√≠as/sem)',
                    moderate: 'Moderado (3-5 d√≠as/sem)',
                    active: 'Activo (6-7 d√≠as/sem)',
                    veryActive: 'Muy activo (atleta)'
                };

                const goalLabels = {
                    lose: 'üî• Perder grasa',
                    maintain: '‚öñÔ∏è Mantener peso',
                    gain: 'üí™ Ganar m√∫sculo'
                };

                return `
                    <!-- Results -->
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg relative">
                        <button onclick="openMacrosInfoModal()" class="absolute top-4 right-4 w-7 h-7 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition">
                            <span class="text-sm">‚ÑπÔ∏è</span>
                        </button>
                        <h3 class="text-lg font-bold mb-1">ü•ó Tus Macros Diarios</h3>
                        <p class="text-sm opacity-80 mb-4">${goalLabels[goal]}</p>
                        <div class="text-center mb-4">
                            <span class="text-4xl font-bold">${macros.calories}</span>
                            <span class="text-lg opacity-80"> kcal/d√≠a</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-white/20 rounded-xl p-3">
                                <p class="text-2xl font-bold">${macros.protein}g</p>
                                <p class="text-xs opacity-80">Prote√≠na</p>
                            </div>
                            <div class="bg-white/20 rounded-xl p-3">
                                <p class="text-2xl font-bold">${macros.carbs}g</p>
                                <p class="text-xs opacity-80">Carbos</p>
                            </div>
                            <div class="bg-white/20 rounded-xl p-3">
                                <p class="text-2xl font-bold">${macros.fat}g</p>
                                <p class="text-xs opacity-80">Grasas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-blue-50 rounded-xl p-3">
                                <p class="text-lg font-bold text-blue-700">${Math.round(bmr)}</p>
                                <p class="text-xs text-blue-600">BMR (Metabolismo basal)</p>
                            </div>
                            <div class="bg-purple-50 rounded-xl p-3">
                                <p class="text-lg font-bold text-purple-700">${Math.round(tdee)}</p>
                                <p class="text-xs text-purple-600">TDEE (Gasto diario)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Calculator Form -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4">‚öôÔ∏è Ajustar C√°lculo</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Peso (kg)</label>
                                    <input type="number" id="macroWeight" value="${weight}" onchange="updateMacrosCalc()" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-400 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Altura (cm)</label>
                                    <input type="number" id="macroHeight" value="${height}" onchange="updateMacrosCalc()" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-400 outline-none text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Edad</label>
                                    <input type="number" id="macroAge" value="${age}" onchange="updateMacrosCalc()" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-400 outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">G√©nero</label>
                                    <select id="macroGender" onchange="updateMacrosCalc()" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-400 outline-none text-sm">
                                        <option value="female" ${gender !== 'male' ? 'selected' : ''}>Femenino</option>
                                        <option value="male" ${gender === 'male' ? 'selected' : ''}>Masculino</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nivel de actividad</label>
                                <select id="macroActivity" onchange="updateMacrosCalc()" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-400 outline-none text-sm">
                                    <option value="sedentary" ${activityLevel === 'sedentary' ? 'selected' : ''}>Sedentario (poco ejercicio)</option>
                                    <option value="light" ${activityLevel === 'light' ? 'selected' : ''}>Ligero (1-3 d√≠as/sem)</option>
                                    <option value="moderate" ${activityLevel === 'moderate' ? 'selected' : ''}>Moderado (3-5 d√≠as/sem)</option>
                                    <option value="active" ${activityLevel === 'active' ? 'selected' : ''}>Activo (6-7 d√≠as/sem)</option>
                                    <option value="veryActive" ${activityLevel === 'veryActive' ? 'selected' : ''}>Muy activo (atleta)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-2">Objetivo</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="setMacroGoal('lose')" class="py-2 px-3 rounded-lg text-xs font-medium transition ${goal === 'lose' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                        üî• Perder
                                    </button>
                                    <button onclick="setMacroGoal('maintain')" class="py-2 px-3 rounded-lg text-xs font-medium transition ${goal === 'maintain' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                        ‚öñÔ∏è Mantener
                                    </button>
                                    <button onclick="setMacroGoal('gain')" class="py-2 px-3 rounded-lg text-xs font-medium transition ${goal === 'gain' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                        üí™ Ganar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tips -->
                    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                        <h4 class="font-bold text-amber-800 mb-2 text-sm">üí° Gu√≠a de Macros</h4>
                        <ul class="text-amber-700 text-xs space-y-1">
                            <li>‚Ä¢ <strong>Prote√≠na:</strong> Carnes, huevos, l√°cteos, legumbres</li>
                            <li>‚Ä¢ <strong>Carbos:</strong> Arroz, avena, frutas, verduras</li>
                            <li>‚Ä¢ <strong>Grasas:</strong> Aceite de oliva, frutos secos, palta</li>
                            <li>‚Ä¢ Distribuye las comidas en 4-5 tomas al d√≠a</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                console.error('Error in renderGymMacros:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-xl">Error en Macros: ${error.message}</div>`;
            }
        }

        function openMacrosInfoModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-sm w-full max-h-[85vh] overflow-y-auto">
                    <div class="p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">üìö Gu√≠a de Conceptos</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-green-50 rounded-xl p-4">
                                <h4 class="font-bold text-green-700 mb-2">ü•ó Calor√≠as Diarias</h4>
                                <p class="text-sm text-gray-600">Son las calor√≠as que debes consumir seg√∫n tu objetivo. Este n√∫mero ya incluye el ajuste para perder grasa, mantener o ganar masa muscular.</p>
                            </div>

                            <div class="bg-blue-50 rounded-xl p-4">
                                <h4 class="font-bold text-blue-700 mb-2">üîµ BMR (Metabolismo Basal)</h4>
                                <p class="text-sm text-gray-600">Calor√≠as que tu cuerpo quema en reposo total (sin moverte). Es la energ√≠a m√≠nima para funciones vitales como respirar, bombear sangre y mantener temperatura corporal.</p>
                            </div>

                            <div class="bg-purple-50 rounded-xl p-4">
                                <h4 class="font-bold text-purple-700 mb-2">üü£ TDEE (Gasto Diario)</h4>
                                <p class="text-sm text-gray-600">Tu gasto cal√≥rico total incluyendo actividad f√≠sica diaria. Es el BMR multiplicado por tu nivel de actividad. Si comes esto, mantienes tu peso.</p>
                            </div>

                            <div class="bg-red-50 rounded-xl p-4">
                                <h4 class="font-bold text-red-700 mb-2">ü•© Prote√≠na</h4>
                                <p class="text-sm text-gray-600">Esencial para construir y mantener m√∫sculo. Consumir suficiente prote√≠na ayuda a preservar masa muscular al bajar de peso y a ganarla en volumen.</p>
                            </div>

                            <div class="bg-yellow-50 rounded-xl p-4">
                                <h4 class="font-bold text-yellow-700 mb-2">üçû Carbohidratos</h4>
                                <p class="text-sm text-gray-600">Fuente principal de energ√≠a para entrenamientos intensos y actividades diarias. Importantes para rendimiento deportivo y recuperaci√≥n.</p>
                            </div>

                            <div class="bg-orange-50 rounded-xl p-4">
                                <h4 class="font-bold text-orange-700 mb-2">ü•ë Grasas</h4>
                                <p class="text-sm text-gray-600">Necesarias para hormonas, absorci√≥n de vitaminas y salud celular. No eliminarlas por completo, son vitales para el funcionamiento del cuerpo.</p>
                            </div>
                        </div>

                        <button onclick="this.closest('.fixed').remove()" class="w-full mt-5 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium text-gray-700 transition">
                            Entendido üëç
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateMacrosCalc() {
            const data = {
                weight: parseFloat(document.getElementById('macroWeight').value) || 60,
                height: parseFloat(document.getElementById('macroHeight').value) || 165,
                age: parseInt(document.getElementById('macroAge').value) || 25,
                gender: document.getElementById('macroGender').value,
                activityLevel: document.getElementById('macroActivity').value,
                goal: getMacrosProfile().goal || 'maintain'
            };
            saveMacrosProfile(data);
            render();
        }

        function setMacroGoal(goal) {
            const data = getMacrosProfile();
            data.goal = goal;
            saveMacrosProfile(data);
            render();
        }

        // ==================== END MACROS CALCULATOR ====================

        // ==================== PROTEIN TRACKING ====================

        // Get protein configuration
        function getProteinConfig() {
            const defaultConfig = {
                goal: 120,
                minRange: 100,
                maxRange: 140,
                objective: 'maintain', // 'lose', 'maintain', 'gain'
                activityLevel: 'medium', // 'low', 'medium', 'high'
                manualGoal: false
            };
            return JSON.parse(getStorage('protein-config') || JSON.stringify(defaultConfig));
        }

        function saveProteinConfig(config) {
            setStorage('protein-config', JSON.stringify(config));
        }

        // Calculate protein goal based on weight and objective
        function calculateProteinGoal(weight, objective, activityLevel) {
            let baseMultiplier = 1.6; // g per kg
            let rangeVariation = 0.2;

            if (objective === 'lose') {
                baseMultiplier = 2.0; // Higher protein for fat loss
                rangeVariation = 0.3;
            } else if (objective === 'gain') {
                baseMultiplier = 1.8; // Higher for muscle gain
                rangeVariation = 0.2;
            }

            // Adjust for activity level
            if (activityLevel === 'high') {
                baseMultiplier += 0.2;
            } else if (activityLevel === 'low') {
                baseMultiplier -= 0.2;
            }

            const goal = Math.round(weight * baseMultiplier);
            const minRange = Math.round(weight * (baseMultiplier - rangeVariation));
            const maxRange = Math.round(weight * (baseMultiplier + rangeVariation));

            return { goal, minRange, maxRange };
        }

        // Get today's protein log
        function getProteinLog(dateKey = null) {
            const key = dateKey || getTodayKey();
            const allLogs = JSON.parse(getStorage('protein-logs') || '{}');
            return allLogs[key] || [];
        }

        function saveProteinLog(entries, dateKey = null) {
            const key = dateKey || getTodayKey();
            const allLogs = JSON.parse(getStorage('protein-logs') || '{}');
            allLogs[key] = entries;
            setStorage('protein-logs', JSON.stringify(allLogs));
        }

        function addProteinEntry(source, grams, note = '') {
            const log = getProteinLog();
            log.push({
                id: Date.now(),
                source,
                grams: parseFloat(grams),
                time: new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' }),
                note
            });
            saveProteinLog(log);
            render();
        }

        function deleteProteinEntry(id) {
            const log = getProteinLog().filter(e => e.id !== id);
            saveProteinLog(log);
            render();
        }

        // Protein favorites (quick add foods)
        function getProteinFavorites() {
            const defaultFavorites = [
                { id: 1, name: 'Pechuga de pollo (100g)', grams: 31 },
                { id: 2, name: 'At√∫n en lata (1 lata)', grams: 25 },
                { id: 3, name: 'Huevos (2 unidades)', grams: 12 },
                { id: 4, name: 'Yogurt griego (170g)', grams: 17 },
                { id: 5, name: 'Whey protein (1 scoop)', grams: 25 },
                { id: 6, name: 'Carne molida (100g)', grams: 26 },
                { id: 7, name: 'Salm√≥n (100g)', grams: 25 },
                { id: 8, name: 'Queso cottage (100g)', grams: 11 },
                { id: 9, name: 'Leche (1 vaso)', grams: 8 },
                { id: 10, name: 'Almendras (30g)', grams: 6 }
            ];
            return JSON.parse(getStorage('protein-favorites') || JSON.stringify(defaultFavorites));
        }

        function saveProteinFavorites(favorites) {
            setStorage('protein-favorites', JSON.stringify(favorites));
        }

        function addProteinFavorite(name, grams) {
            const favorites = getProteinFavorites();
            favorites.push({ id: Date.now(), name, grams: parseFloat(grams) });
            saveProteinFavorites(favorites);
            render();
        }

        function deleteProteinFavorite(id) {
            const favorites = getProteinFavorites().filter(f => f.id !== id);
            saveProteinFavorites(favorites);
            render();
        }

        function quickAddProtein(favoriteId) {
            const favorites = getProteinFavorites();
            const fav = favorites.find(f => f.id === favoriteId);
            if (fav) {
                addProteinEntry(fav.name, fav.grams);
            }
        }

        // Get weekly protein stats
        function getProteinWeeklyStats() {
            const stats = { days: [], total: 0, daysCompleted: 0, average: 0 };
            const config = getProteinConfig();

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                const log = getProteinLog(key);
                const total = log.reduce((sum, e) => sum + e.grams, 0);
                const completed = total >= config.goal;

                stats.days.push({
                    date: key,
                    dayName: date.toLocaleDateString('es-CL', { weekday: 'short' }),
                    total,
                    completed,
                    percentage: Math.min(100, Math.round((total / config.goal) * 100))
                });

                stats.total += total;
                if (completed) stats.daysCompleted++;
            }

            stats.average = Math.round(stats.total / 7);
            return stats;
        }

        // Update protein config from form
        function updateProteinConfig() {
            const latestWeight = getLatestWeight();
            const weight = parseFloat(document.getElementById('proteinWeight')?.value) || latestWeight?.weight || 70;
            const objective = document.getElementById('proteinObjective')?.value || 'maintain';
            const activityLevel = document.getElementById('proteinActivity')?.value || 'medium';
            const manualGoal = document.getElementById('proteinManual')?.checked || false;
            const customGoal = parseFloat(document.getElementById('proteinCustomGoal')?.value) || 120;

            const calculated = calculateProteinGoal(weight, objective, activityLevel);

            const config = {
                ...calculated,
                goal: manualGoal ? customGoal : calculated.goal,
                objective,
                activityLevel,
                manualGoal,
                customGoal
            };

            saveProteinConfig(config);
            render();
        }

        // Open modal to add protein
        function openAddProteinModal() {
            document.getElementById('addProteinModal').classList.remove('hidden');
        }

        function closeAddProteinModal() {
            document.getElementById('addProteinModal').classList.add('hidden');
            document.getElementById('proteinSource').value = '';
            document.getElementById('proteinGrams').value = '';
            document.getElementById('proteinNote').value = '';
        }

        function saveNewProtein() {
            const source = document.getElementById('proteinSource').value.trim();
            const grams = document.getElementById('proteinGrams').value;
            const note = document.getElementById('proteinNote').value.trim();

            if (source && grams) {
                addProteinEntry(source, grams, note);
                closeAddProteinModal();
            }
        }

        // Open modal to add favorite
        function openAddFavoriteModal() {
            document.getElementById('addFavoriteModal').classList.remove('hidden');
        }

        function closeAddFavoriteModal() {
            document.getElementById('addFavoriteModal').classList.add('hidden');
            document.getElementById('favoriteName').value = '';
            document.getElementById('favoriteGrams').value = '';
        }

        function saveNewFavorite() {
            const name = document.getElementById('favoriteName').value.trim();
            const grams = document.getElementById('favoriteGrams').value;

            if (name && grams) {
                addProteinFavorite(name, grams);
                closeAddFavoriteModal();
            }
        }

        // Protein Detail Modal
        function openProteinDetailModal() {
            const config = getProteinConfig();
            const todayLog = getProteinLog();
            const todayTotal = todayLog.reduce((sum, e) => sum + e.grams, 0);
            const percentage = Math.min(100, Math.round((todayTotal / config.goal) * 100));
            const remaining = Math.max(0, config.goal - todayTotal);

            // Update summary
            document.getElementById('proteinDetailSummary').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-3xl font-bold">${todayTotal}g <span class="text-lg opacity-80">/ ${config.goal}g</span></p>
                        <p class="text-sm opacity-80">${remaining > 0 ? `Faltan ${remaining}g` : 'üéâ ¬°Meta completada!'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-4xl font-bold">${percentage}%</p>
                        <p class="text-xs opacity-80">${todayLog.length} alimentos</p>
                    </div>
                </div>
            `;

            // Update list
            const listContainer = document.getElementById('proteinDetailList');
            const emptyState = document.getElementById('proteinDetailEmpty');

            if (todayLog.length > 0) {
                listContainer.classList.remove('hidden');
                emptyState.classList.add('hidden');

                listContainer.innerHTML = todayLog.map(entry => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl group">
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${entry.source}</p>
                            <p class="text-xs text-gray-400">${entry.time}${entry.note ? ' ‚Ä¢ ' + entry.note : ''}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-green-600 font-bold text-lg">+${entry.grams}g</span>
                            <button onclick="confirmDeleteProteinEntry(${entry.id}, '${entry.source.replace(/'/g, "\\'")}', ${entry.grams})"
                                class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition"
                                title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                listContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
            }

            document.getElementById('proteinDetailModal').classList.remove('hidden');
        }

        function closeProteinDetailModal() {
            document.getElementById('proteinDetailModal').classList.add('hidden');
        }

        function confirmDeleteProteinEntry(id, name, grams) {
            if (confirm(`¬øEliminar "${name}" (${grams}g) de tu registro de hoy?`)) {
                deleteProteinEntry(id);
                openProteinDetailModal(); // Refresh the modal
            }
        }

        // Render protein tracking sub-section
        function renderProteinTracking() {
            try {
                const config = getProteinConfig();
                const todayLog = getProteinLog();
                const todayTotal = todayLog.reduce((sum, e) => sum + e.grams, 0);
                const percentage = Math.min(100, Math.round((todayTotal / config.goal) * 100));
                const remaining = Math.max(0, config.goal - todayTotal);
                const favorites = getProteinFavorites();
                const weeklyStats = getProteinWeeklyStats();
                const latestWeight = getLatestWeight();

                return `
                    <!-- Today's Progress (Clickable) -->
                    <div onclick="openProteinDetailModal()" class="bg-gradient-to-br from-green-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg cursor-pointer hover:shadow-xl transition active:scale-[0.98]">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-lg">ü•© Prote√≠na Hoy</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-sm opacity-80">${new Date().toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'short' })}</span>
                                <span class="text-xs bg-white/20 px-2 py-0.5 rounded-full">${todayLog.length} items ‚Üí</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-4 mb-4">
                            <div class="relative w-24 h-24">
                                <svg class="w-24 h-24 transform -rotate-90">
                                    <circle cx="48" cy="48" r="40" stroke="rgba(255,255,255,0.3)" stroke-width="8" fill="none"/>
                                    <circle cx="48" cy="48" r="40" stroke="white" stroke-width="8" fill="none"
                                        stroke-dasharray="${2 * Math.PI * 40}"
                                        stroke-dashoffset="${2 * Math.PI * 40 * (1 - percentage / 100)}"
                                        class="progress-ring"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-2xl font-bold">${percentage}%</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-3xl font-bold">${todayTotal}g <span class="text-lg opacity-80">/ ${config.goal}g</span></p>
                                <p class="text-sm opacity-80 mt-1">
                                    ${remaining > 0 ? `Faltan ${remaining}g para tu meta` : 'üéâ ¬°Meta completada!'}
                                </p>
                            </div>
                        </div>

                        <div class="w-full bg-white/30 rounded-full h-3">
                            <div class="bg-white rounded-full h-3 transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-xs text-center mt-3 opacity-70">Toca para ver detalle y editar</p>
                    </div>

                    <!-- Quick Add from Favorites -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-gray-800">‚ö° Agregar R√°pido</h4>
                            <button onclick="openAddProteinModal()" class="text-sm text-purple-600 hover:text-purple-700 font-medium">+ Manual</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                            ${favorites.slice(0, 8).map(fav => `
                                <button onclick="quickAddProtein(${fav.id})" class="flex items-center justify-between gap-2 px-3 py-2 bg-gray-50 hover:bg-green-50 rounded-lg text-left transition text-sm">
                                    <span class="truncate text-gray-700">${fav.name}</span>
                                    <span class="text-green-600 font-bold whitespace-nowrap">+${fav.grams}g</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Today's Log -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">üìã Registro de Hoy</h4>
                        ${todayLog.length > 0 ? `
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${todayLog.map(entry => `
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                        <div class="flex-1">
                                            <p class="text-gray-800 text-sm">${entry.source}</p>
                                            <p class="text-xs text-gray-400">${entry.time}${entry.note ? ' ‚Ä¢ ' + entry.note : ''}</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-green-600 font-bold">${entry.grams}g</span>
                                            <button onclick="deleteProteinEntry(${entry.id})" class="text-red-400 hover:text-red-600 text-xs">‚úï</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-gray-400 text-center py-4 text-sm">No has registrado prote√≠na hoy</p>
                        `}
                    </div>

                    <!-- Weekly Summary -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">üìä Resumen Semanal</h4>
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-purple-600">${weeklyStats.daysCompleted}/7</p>
                                <p class="text-xs text-gray-500">D√≠as cumplidos</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-green-600">${weeklyStats.average}g</p>
                                <p class="text-xs text-gray-500">Promedio diario</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-blue-600">${config.goal}g</p>
                                <p class="text-xs text-gray-500">Meta diaria</p>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            ${weeklyStats.days.map(day => `
                                <div class="flex-1 text-center">
                                    <div class="h-16 bg-gray-100 rounded relative overflow-hidden mb-1">
                                        <div class="absolute bottom-0 left-0 right-0 ${day.completed ? 'bg-green-400' : 'bg-orange-300'} transition-all" style="height: ${day.percentage}%"></div>
                                    </div>
                                    <p class="text-xs text-gray-500">${day.dayName}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Quick Link to Goal Config -->
                    <button onclick="mealsSubTab='goal'; render();" class="w-full p-3 bg-purple-50 border border-purple-200 rounded-xl flex items-center justify-between hover:bg-purple-100 transition">
                        <div class="flex items-center gap-2">
                            <span>üéØ</span>
                            <span class="text-sm text-purple-700">Meta: <strong>${config.goal}g/d√≠a</strong></span>
                            <span class="text-xs text-purple-400">(${config.minRange}-${config.maxRange}g)</span>
                        </div>
                        <span class="text-purple-400 text-sm">Configurar ‚Üí</span>
                    </button>

                    <!-- Manage Favorites -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-gray-800">‚≠ê Mis Alimentos Favoritos</h4>
                            <button onclick="openAddFavoriteModal()" class="text-sm text-purple-600 hover:text-purple-700 font-medium">+ Agregar</button>
                        </div>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${favorites.map(fav => `
                                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                    <span class="text-gray-700 text-sm">${fav.name}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-green-600 font-medium text-sm">${fav.grams}g</span>
                                        <button onclick="deleteProteinFavorite(${fav.id})" class="text-red-400 hover:text-red-600 text-xs">‚úï</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error in renderProteinTracking:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
            }
        }

        // ==================== END PROTEIN TRACKING ====================

        // Render Nutrition Goal Configuration
        function renderNutritionGoal() {
            try {
                const config = getProteinConfig();
                const latestWeight = getLatestWeight();
                const profile = getPhysicalProfile();
                const weeklyStats = getProteinWeeklyStats();

                const objectiveLabels = {
                    'lose': { name: 'Bajar Grasa', emoji: 'üî•', color: 'orange' },
                    'maintain': { name: 'Recomp.', emoji: '‚öñÔ∏è', color: 'blue' },
                    'gain': { name: 'Ganar Masa', emoji: 'üí™', color: 'green' }
                };
                const currentObj = objectiveLabels[config.objective] || objectiveLabels['maintain'];

                return `
                    <!-- Current Goal Summary -->
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-lg">üéØ Tu Meta Nutricional</h3>
                            <span class="text-sm opacity-80">${currentObj.emoji} ${currentObj.name}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-white/20 rounded-xl p-3">
                                <p class="text-2xl font-bold">${config.goal}g</p>
                                <p class="text-xs opacity-80">Prote√≠na/d√≠a</p>
                            </div>
                            <div class="bg-white/20 rounded-xl p-3">
                                <p class="text-2xl font-bold">${latestWeight?.weight || '--'}</p>
                                <p class="text-xs opacity-80">kg actual</p>
                            </div>
                            <div class="bg-white/20 rounded-xl p-3">
                                <p class="text-2xl font-bold">${weeklyStats.daysCompleted}/7</p>
                                <p class="text-xs opacity-80">d√≠as cumplidos</p>
                            </div>
                        </div>
                        <p class="text-sm mt-3 opacity-80 text-center">
                            Rango recomendado: ${config.minRange}g - ${config.maxRange}g/d√≠a
                        </p>
                    </div>

                    <!-- Weight & Physical Data -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4">‚öñÔ∏è Datos F√≠sicos</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 font-medium">Peso Actual (kg)</label>
                                <input type="number" id="goalWeight" value="${latestWeight?.weight || 70}"
                                    onchange="updateProteinConfig()"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-200 text-lg font-bold text-center mt-1 focus:ring-2 focus:ring-purple-400 outline-none">
                                <p class="text-xs text-gray-400 mt-1 text-center">
                                    ${latestWeight ? `√öltimo check-in: ${new Date(latestWeight.date).toLocaleDateString('es-CL')}` : 'Sin registro'}
                                </p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 font-medium">Altura (cm)</label>
                                <input type="number" id="goalHeight" value="${profile.height || 165}"
                                    class="w-full px-4 py-3 rounded-xl border border-gray-200 text-lg font-bold text-center mt-1 focus:ring-2 focus:ring-purple-400 outline-none" disabled>
                                <p class="text-xs text-gray-400 mt-1 text-center">Configura en Gym ‚Üí Perfil</p>
                            </div>
                        </div>
                    </div>

                    <!-- Objective Selection -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4">üéØ Objetivo</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setNutritionObjective('lose')"
                                class="p-3 rounded-xl border-2 transition text-center ${config.objective === 'lose' ? 'border-orange-500 bg-orange-50' : 'border-gray-200 hover:border-orange-300'}">
                                <span class="text-2xl block mb-1">üî•</span>
                                <span class="text-xs font-medium leading-tight block ${config.objective === 'lose' ? 'text-orange-600' : 'text-gray-600'}">Bajar Grasa</span>
                            </button>
                            <button onclick="setNutritionObjective('maintain')"
                                class="p-3 rounded-xl border-2 transition text-center ${config.objective === 'maintain' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'}">
                                <span class="text-2xl block mb-1">‚öñÔ∏è</span>
                                <span class="text-xs font-medium leading-tight block ${config.objective === 'maintain' ? 'text-blue-600' : 'text-gray-600'}">Recomp.</span>
                            </button>
                            <button onclick="setNutritionObjective('gain')"
                                class="p-3 rounded-xl border-2 transition text-center ${config.objective === 'gain' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-green-300'}">
                                <span class="text-2xl block mb-1">üí™</span>
                                <span class="text-xs font-medium leading-tight block ${config.objective === 'gain' ? 'text-green-600' : 'text-gray-600'}">Ganar Masa</span>
                            </button>
                        </div>
                    </div>

                    <!-- Activity Level -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4">üèÉ Nivel de Actividad</h4>
                        <div class="space-y-2">
                            <button onclick="setActivityLevel('low')"
                                class="w-full p-3 rounded-xl border-2 flex items-center gap-3 transition ${config.activityLevel === 'low' ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300'}">
                                <span class="text-xl">üö∂</span>
                                <div class="text-left flex-1">
                                    <span class="font-medium ${config.activityLevel === 'low' ? 'text-purple-600' : 'text-gray-700'}">Bajo</span>
                                    <p class="text-xs text-gray-400">Sedentario, poco ejercicio</p>
                                </div>
                                ${config.activityLevel === 'low' ? '<span class="text-purple-500">‚úì</span>' : ''}
                            </button>
                            <button onclick="setActivityLevel('medium')"
                                class="w-full p-3 rounded-xl border-2 flex items-center gap-3 transition ${config.activityLevel === 'medium' ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300'}">
                                <span class="text-xl">üèãÔ∏è</span>
                                <div class="text-left flex-1">
                                    <span class="font-medium ${config.activityLevel === 'medium' ? 'text-purple-600' : 'text-gray-700'}">Medio</span>
                                    <p class="text-xs text-gray-400">Entreno 3-4 veces por semana</p>
                                </div>
                                ${config.activityLevel === 'medium' ? '<span class="text-purple-500">‚úì</span>' : ''}
                            </button>
                            <button onclick="setActivityLevel('high')"
                                class="w-full p-3 rounded-xl border-2 flex items-center gap-3 transition ${config.activityLevel === 'high' ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300'}">
                                <span class="text-xl">‚ö°</span>
                                <div class="text-left flex-1">
                                    <span class="font-medium ${config.activityLevel === 'high' ? 'text-purple-600' : 'text-gray-700'}">Alto</span>
                                    <p class="text-xs text-gray-400">Entreno diario o muy intenso</p>
                                </div>
                                ${config.activityLevel === 'high' ? '<span class="text-purple-500">‚úì</span>' : ''}
                            </button>
                        </div>
                    </div>

                    <!-- Calculated Goal -->
                    <div class="bg-gradient-to-r from-green-50 to-teal-50 border border-green-200 rounded-2xl p-5">
                        <h4 class="font-bold text-green-800 mb-3">üìä Meta Calculada</h4>
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-3xl font-bold text-green-600">${config.goal}g</p>
                                <p class="text-sm text-green-500">prote√≠na por d√≠a</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Rango saludable:</p>
                                <p class="font-bold text-gray-700">${config.minRange}g - ${config.maxRange}g</p>
                            </div>
                        </div>

                        <!-- Manual Override -->
                        <div class="border-t border-green-200 pt-4 mt-4">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="goalManualOverride" ${config.manualGoal ? 'checked' : ''}
                                    onchange="toggleManualGoal()" class="w-5 h-5 rounded text-purple-500">
                                <span class="text-sm text-gray-600">Usar meta personalizada (ej: la que te dio tu nutri√≥logo)</span>
                            </label>
                            ${config.manualGoal ? `
                                <div class="mt-3 flex items-center gap-3">
                                    <input type="number" id="goalCustomValue" value="${config.customGoal || config.goal}"
                                        onchange="updateCustomGoal()"
                                        class="flex-1 px-4 py-3 rounded-xl border border-purple-300 text-lg font-bold text-center focus:ring-2 focus:ring-purple-400 outline-none">
                                    <span class="text-gray-500">g/d√≠a</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Info Box -->
                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
                        <div class="flex gap-3">
                            <span class="text-xl">üí°</span>
                            <div class="text-sm text-blue-700">
                                <p class="font-medium mb-1">¬øC√≥mo se calcula?</p>
                                <p class="text-blue-600">Tu meta se basa en: peso √ó multiplicador seg√∫n objetivo y actividad.
                                Para bajar grasa se recomienda m√°s prote√≠na (2.0-2.2g/kg) para preservar m√∫sculo.</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error in renderNutritionGoal:', error);
                return `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
            }
        }

        // Functions for nutrition goal
        function setNutritionObjective(objective) {
            const config = getProteinConfig();
            config.objective = objective;

            // Recalculate with new objective
            const latestWeight = getLatestWeight();
            const weight = latestWeight?.weight || 70;
            const calculated = calculateProteinGoal(weight, objective, config.activityLevel);

            if (!config.manualGoal) {
                config.goal = calculated.goal;
            }
            config.minRange = calculated.minRange;
            config.maxRange = calculated.maxRange;

            saveProteinConfig(config);
            render();
        }

        function setActivityLevel(level) {
            const config = getProteinConfig();
            config.activityLevel = level;

            // Recalculate
            const latestWeight = getLatestWeight();
            const weight = latestWeight?.weight || 70;
            const calculated = calculateProteinGoal(weight, config.objective, level);

            if (!config.manualGoal) {
                config.goal = calculated.goal;
            }
            config.minRange = calculated.minRange;
            config.maxRange = calculated.maxRange;

            saveProteinConfig(config);
            render();
        }

        function toggleManualGoal() {
            const config = getProteinConfig();
            config.manualGoal = !config.manualGoal;

            if (!config.manualGoal) {
                // Recalculate automatic goal
                const latestWeight = getLatestWeight();
                const weight = latestWeight?.weight || 70;
                const calculated = calculateProteinGoal(weight, config.objective, config.activityLevel);
                config.goal = calculated.goal;
            }

            saveProteinConfig(config);
            render();
        }

        function updateCustomGoal() {
            const config = getProteinConfig();
            const customValue = parseFloat(document.getElementById('goalCustomValue')?.value) || config.goal;
            config.customGoal = customValue;
            config.goal = customValue;
            saveProteinConfig(config);
            render();
        }

        function renderMeals() {
            const meals = getMeals();
            const isCustomized = customMeals !== null;

            const tabsOrder = getNutritionTabsOrder();

            return `
                <div class="space-y-4">
                    <!-- Sub-tabs for Nutrition section (draggable) -->
                    <div data-tabs-container="nutrition" class="flex gap-2 p-1.5 bg-gradient-to-r from-green-100 to-orange-100 rounded-2xl relative overflow-x-auto no-scrollbar shadow-sm border border-green-200/50">
                        ${tabsOrder.map((tabId, index) => {
                            const tabsConfig = getNutritionTabsConfig();
                            const tab = tabsConfig[tabId];
                            if (!tab) return '';
                            const isActive = mealsSubTab === tabId;
                            return `
                                <button
                                    data-tab="${tabId}"
                                    data-index="${index}"
                                    onclick="if(!isDragging) { setMealsSubTabValue('${tabId}'); render(); }"
                                    ontouchstart="handleTabTouchStart(event, '${tabId}', 'nutrition')"
                                    ontouchmove="handleTabTouchMove(event)"
                                    ontouchend="handleTabTouchEnd(event)"
                                    onmousedown="handleTabMouseDown(event, '${tabId}', 'nutrition')"
                                    onmouseup="handleTabMouseUp(event)"
                                    class="flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition select-none whitespace-nowrap ${isActive ? 'bg-white shadow-md text-green-600 border border-green-200' : 'text-gray-600 hover:bg-white/50'}"
                                    style="touch-action: pan-x;">
                                    ${tab.emoji} ${tab.label}
                                </button>
                            `;
                        }).join('')}
                        <div class="drag-indicator hidden absolute top-0 bottom-0 w-0.5 bg-green-500 rounded-full z-10"></div>
                    </div>

                    ${mealsSubTab === 'protein' ? renderProteinTracking() : ''}
                    ${mealsSubTab === 'goal' ? renderNutritionGoal() : ''}

                    ${mealsSubTab === 'plan' ? `
                    <!-- Meal Plan Section -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddMealModal()" class="flex items-center justify-center gap-1 px-3 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-purple-600 border border-purple-100 text-sm" title="Agregar Comida">
                            <span>‚ûï</span> Agregar
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetMeals()" class="flex items-center justify-center gap-1 px-3 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-gray-500 border border-gray-100 text-sm" title="Restaurar">
                                <span>üîÑ</span> Restaurar
                            </button>
                        ` : ''}
                    </div>

                    ${meals.map((meal, idx) => `
                        <div class="bg-white rounded-2xl p-4 shadow-sm card-hover">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-3xl">${meal.emoji}</span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${meal.name}</h4>
                                    <p class="text-xs text-gray-500">${meal.time}</p>
                                </div>
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium">${meal.macros}</span>
                                <div class="flex gap-1 flex-shrink-0">
                                    <button onclick="openEditMealModal(${idx})" class="btn-icon w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-xs" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="openDeleteModal(${idx}, 'meal')" class="btn-icon w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-xs" title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-1 ml-12">
                                ${meal.options.map(opt => `
                                    <div class="flex items-center gap-2 text-gray-600 text-sm">
                                        <span class="w-1.5 h-1.5 bg-purple-400 rounded-full flex-shrink-0"></span>
                                        <span>${opt}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    ` : ''}

                    ${mealsSubTab === 'guide' ? `
                    <!-- Nutrition Guide Section -->
                    <div class="bg-gradient-to-br from-green-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg mb-4">
                        <h3 class="font-bold text-lg mb-2">üìñ Gu√≠a Nutricional</h3>
                        <p class="text-sm opacity-90">Consejos y reglas para mantener una alimentaci√≥n saludable</p>
                    </div>

                    <div class="bg-red-50 border border-red-200 rounded-2xl p-5">
                        <h4 class="font-bold text-red-700 mb-3">üö´ Alimentos a Evitar</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center gap-2 text-red-600 text-sm">
                                <span>‚ùå</span> Az√∫car refinada
                            </div>
                            <div class="flex items-center gap-2 text-red-600 text-sm">
                                <span>‚ùå</span> Bebidas azucaradas
                            </div>
                            <div class="flex items-center gap-2 text-red-600 text-sm">
                                <span>‚ùå</span> Frituras
                            </div>
                            <div class="flex items-center gap-2 text-red-600 text-sm">
                                <span>‚ùå</span> Harinas blancas
                            </div>
                            <div class="flex items-center gap-2 text-red-600 text-sm">
                                <span>‚ùå</span> Alcohol
                            </div>
                            <div class="flex items-center gap-2 text-red-600 text-sm">
                                <span>‚ùå</span> Ultraprocesados
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-2xl p-5">
                        <h4 class="font-bold text-green-700 mb-3">üíä Suplementaci√≥n Recomendada</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">üí™</span>
                                    <span class="text-green-700 font-medium">Creatina</span>
                                </div>
                                <span class="text-sm text-green-600 bg-green-100 px-2 py-1 rounded-full">5g / d√≠a (AM)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">üêü</span>
                                    <span class="text-green-700 font-medium">Omega 3</span>
                                </div>
                                <span class="text-sm text-green-600 bg-green-100 px-2 py-1 rounded-full">1000mg / d√≠a</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">üçä</span>
                                    <span class="text-green-700 font-medium">Vitamina C</span>
                                </div>
                                <span class="text-sm text-green-600 bg-green-100 px-2 py-1 rounded-full">1000mg / d√≠a</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">ü•õ</span>
                                    <span class="text-green-700 font-medium">Whey Protein</span>
                                </div>
                                <span class="text-sm text-green-600 bg-green-100 px-2 py-1 rounded-full">25-30g post-entreno</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-5">
                        <h4 class="font-bold text-blue-700 mb-3">üíß Hidrataci√≥n</h4>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-700 font-medium">Meta diaria de agua</p>
                                <p class="text-sm text-blue-500">M√≠nimo recomendado para adultos activos</p>
                            </div>
                            <span class="text-2xl font-bold text-blue-600">3L</span>
                        </div>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 rounded-2xl p-5">
                        <h4 class="font-bold text-purple-700 mb-3">üí° Tips R√°pidos</h4>
                        <ul class="space-y-2 text-purple-600 text-sm">
                            <li class="flex items-start gap-2">
                                <span>‚úì</span>
                                <span>Come prote√≠na en cada comida principal</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span>‚úì</span>
                                <span>Prioriza alimentos integrales sobre procesados</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span>‚úì</span>
                                <span>No saltes el desayuno</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span>‚úì</span>
                                <span>Prepara tus comidas con anticipaci√≥n</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span>‚úì</span>
                                <span>Lleva snacks saludables contigo</span>
                            </li>
                        </ul>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function renderGoals(currentWeek) {
            const goals = getWeeklyGoals();
            const isCustomized = customGoals !== null;

            return `
                <div class="space-y-4">
                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddGoalModal()" class="flex items-center justify-center gap-1 px-3 py-2 bg-purple-500 text-white rounded-lg shadow-sm hover:shadow-md hover:bg-purple-600 transition text-sm font-medium" title="Agregar Meta">
                            <span>‚ûï</span> Nueva Meta
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetGoals()" class="flex items-center justify-center gap-1 px-3 py-2 bg-white rounded-lg shadow-sm hover:shadow-md transition text-gray-500 border border-gray-100 text-sm" title="Restaurar">
                                <span>üîÑ</span> Restaurar Metas
                            </button>
                        ` : ''}
                    </div>

                    ${goals.map((goal, idx) => `
                        <div class="goal-card rounded-2xl p-5 shadow-sm transition-all ${
                            goal.week === currentWeek
                                ? 'theme-btn ring-4 ring-purple-200 glow'
                                : goal.week < currentWeek
                                ? 'bg-gray-100 opacity-70'
                                : 'bg-white'
                        }">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${
                                    goal.week === currentWeek ? 'bg-white/20' : goal.week < currentWeek ? 'bg-green-100 text-green-600' : 'bg-purple-100 text-purple-600'
                                }">
                                    ${goal.week < currentWeek ? '‚úì' : goal.week}
                                </span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-lg">Semana ${goal.week}</h4>
                                    <p class="text-sm ${goal.week === currentWeek ? 'text-white/80' : 'text-gray-500'}">${goal.dates}</p>
                                </div>
                                ${goal.week === currentWeek ? '<span class="px-3 py-1 bg-white/20 rounded-full text-sm animate-pulse">üìç Est√°s aqu√≠</span>' : ''}
                                <button onclick="openEditGoalModal(${idx})" class="btn-icon w-10 h-10 rounded-full ${goal.week === currentWeek ? 'bg-white/20 text-white hover:bg-white/30' : 'bg-blue-100 text-blue-600 hover:bg-blue-200'} flex items-center justify-center" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-rose-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-rose-700'}">üí™ F√≠sica</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.fisica}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-blue-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-blue-700'}">üìö Personal</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.personal}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-purple-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-purple-700'}">üì± Digital</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.digital}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-indigo-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-indigo-700'}">üßò Espiritual</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.espiritual}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Notes Functions
        function getNotes(dateKey) {
            const saved = getStorage(`notes-${dateKey}`);
            return saved || '';
        }

        function saveNotes(dateKey) {
            const textarea = document.getElementById('notesTextarea');
            if (textarea) {
                setStorage(`notes-${dateKey}`, textarea.value);
                showNotification('üìù Nota guardada');
                render(); // Actualizar la vista para mostrar la nota en el historial
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 theme-btn px-6 py-3 rounded-xl shadow-lg z-50 animate-pulse';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function renderNotes(dateKey) {
            const notes = getNotes(dateKey);
            const allNotes = getAllNotesWithContent();

            return `
                <div class="space-y-4">
                    <!-- Editor de nota del d√≠a -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">üìù</span>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">Notas del D√≠a</h3>
                                <p class="text-gray-500 text-sm">Escribe tus pensamientos, reflexiones o recordatorios</p>
                            </div>
                        </div>
                        <textarea
                            id="notesTextarea"
                            class="w-full h-48 p-4 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none text-gray-700"
                            placeholder="¬øQu√© quieres recordar de hoy? ‚ú®"
                            onblur="saveNotes('${dateKey}')"
                        >${notes}</textarea>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-sm text-gray-400">Se guarda autom√°ticamente</span>
                            <button onclick="saveNotes('${dateKey}')" class="px-4 py-2 theme-btn rounded-xl hover:opacity-90 transition font-medium text-sm">
                                üíæ Guardar
                            </button>
                        </div>
                    </div>

                    <!-- Historial de notas -->
                    ${allNotes.length > 0 ? `
                        <div class="bg-white rounded-2xl p-5 shadow-sm">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">üìö Historial de Notas</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${allNotes.map(note => `
                                    <div class="p-4 bg-gradient-to-r from-rose-50 to-purple-50 rounded-xl border border-purple-100 ${note.dateKey === dateKey ? 'ring-2 ring-purple-300' : ''}">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-medium text-purple-600">${formatNoteDate(note.dateKey)}</span>
                                                ${note.dateKey === dateKey ? '<span class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full">Hoy</span>' : ''}
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button onclick="editNote('${note.dateKey}')" class="text-sm text-purple-500 hover:text-purple-700 transition" title="Editar nota">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                <button onclick="deleteNote('${note.dateKey}')" class="text-sm text-red-400 hover:text-red-600 transition" title="Eliminar nota">
                                                    üóëÔ∏è
                                                </button>
                                                <button onclick="goToNoteDate('${note.dateKey}')" class="text-sm text-gray-400 hover:text-purple-600 transition">
                                                    üìÖ Ver d√≠a
                                                </button>
                                            </div>
                                        </div>
                                        <p class="text-gray-700 text-sm whitespace-pre-wrap line-clamp-3">${note.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
                            <span class="text-5xl">‚ú®</span>
                            <p class="text-gray-500 mt-3">A√∫n no tienes notas guardadas</p>
                            <p class="text-gray-400 text-sm">Empieza a escribir tus reflexiones diarias</p>
                        </div>
                    `}
                </div>
            `;
        }

        function getAllNotesWithContent() {
            const notes = [];
            const prefix = `${userKey}-notes-`;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(prefix)) {
                    const dateKey = key.replace(prefix, '');
                    const content = localStorage.getItem(key);
                    if (content && content.trim()) {
                        notes.push({ dateKey, content });
                    }
                }
            }

            // Ordenar por fecha (m√°s reciente primero)
            notes.sort((a, b) => b.dateKey.localeCompare(a.dateKey));
            return notes.slice(0, 10); // √öltimas 10 notas
        }

        function formatNoteDate(dateKey) {
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                return date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            }
            return dateKey;
        }

        function goToNoteDate(dateKey) {
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                currentDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                render();
            }
        }

        function editNote(dateKey) {
            // Navegar al d√≠a de la nota
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                currentDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                activeTab = 'notes';
                render();
                // Enfocar el textarea despu√©s del render (sin scroll)
                setTimeout(() => {
                    const textarea = document.getElementById('notesTextarea');
                    if (textarea) {
                        textarea.focus({ preventScroll: true });
                    }
                }, 100);
            }
        }

        function deleteNote(dateKey) {
            if (confirm('¬øEliminar esta nota? Esta acci√≥n no se puede deshacer.')) {
                setStorage(`notes-${dateKey}`, '');
                showNotification('üóëÔ∏è Nota eliminada');
                render();
            }
        }

        // ==================== FASTING INTERMITTENT ====================
        // Fasting types configuration
        const FASTING_TYPES = {
            '12:12': { hours: 12, label: '12:12', description: 'Principiante' },
            '14:10': { hours: 14, label: '14:10', description: 'Intermedio' },
            '16:8':  { hours: 16, label: '16:8',  description: 'Popular' },
            '18:6':  { hours: 18, label: '18:6',  description: 'Avanzado' },
            '20:4':  { hours: 20, label: '20:4',  description: 'Guerrero' },
            '24:0':  { hours: 24, label: '24h',   description: 'OMAD' },
            'custom': { hours: null, label: 'Personalizado', description: 'Define tu tiempo' }
        };

        // Fasting timer state
        let fastingTimerInterval = null;

        // Fasting Storage Functions
        function getFastingData() {
            const data = getStorage(`${userKey}-fasting`);
            if (data) {
                return JSON.parse(data);
            }
            return {
                activeFast: null,
                history: [],
                settings: { defaultType: '16:8', reminderEnabled: false }
            };
        }

        function saveFastingData(data) {
            setStorage(`${userKey}-fasting`, JSON.stringify(data));
        }

        function hasActiveFast() {
            const data = getFastingData();
            return data.activeFast !== null;
        }

        // Fasting Timer Functions
        function calculateFastingElapsed() {
            const data = getFastingData();
            if (!data.activeFast) return 0;
            return Math.floor((Date.now() - new Date(data.activeFast.startedAt).getTime()) / 1000);
        }

        function formatFastingTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startFastingTimer() {
            if (fastingTimerInterval) {
                clearInterval(fastingTimerInterval);
            }
            fastingTimerInterval = setInterval(() => {
                updateFastingDisplay();
            }, 1000);
        }

        function stopFastingTimer() {
            if (fastingTimerInterval) {
                clearInterval(fastingTimerInterval);
                fastingTimerInterval = null;
            }
        }

        function updateFastingDisplay() {
            const data = getFastingData();
            if (!data.activeFast) return;

            const elapsed = calculateFastingElapsed();
            const targetSeconds = data.activeFast.targetHours * 3600;
            const progress = Math.min((elapsed / targetSeconds) * 100, 100);
            const remaining = Math.max(targetSeconds - elapsed, 0);

            // Update timer display
            const timerEl = document.getElementById('fastingTimer');
            if (timerEl) {
                timerEl.textContent = formatFastingTime(elapsed);
            }

            // Update progress circle
            const progressEl = document.getElementById('fastingProgress');
            if (progressEl) {
                progressEl.style.setProperty('--progress', progress);
                progressEl.setAttribute('data-progress', Math.round(progress));
            }

            // Update remaining time
            const remainingEl = document.getElementById('fastingRemaining');
            if (remainingEl) {
                if (remaining > 0) {
                    const remainingHours = (remaining / 3600).toFixed(1);
                    remainingEl.textContent = `Faltan ${remainingHours}h`;
                } else {
                    remainingEl.textContent = '¬°Meta alcanzada!';
                    remainingEl.classList.add('text-green-500', 'font-bold');
                }
            }

            // Check if goal reached
            if (elapsed >= targetSeconds && !data.activeFast.goalReached) {
                data.activeFast.goalReached = true;
                saveFastingData(data);
                showNotification('üéâ ¬°Meta de ayuno alcanzada!');
            }
        }

        function startFasting(type, customHours = null) {
            if (hasActiveFast()) {
                showNotification('‚ö†Ô∏è Ya tienes un ayuno activo');
                return;
            }

            const targetHours = type === 'custom' ? customHours : FASTING_TYPES[type].hours;
            if (!targetHours || targetHours <= 0) {
                showNotification('‚ö†Ô∏è Duraci√≥n inv√°lida');
                return;
            }

            const data = getFastingData();
            data.activeFast = {
                id: Date.now(),
                type: type,
                targetHours: targetHours,
                startedAt: new Date().toISOString(),
                notes: { energy: 3, hunger: 3, focus: 3 },
                goalReached: false
            };
            saveFastingData(data);

            startFastingTimer();
            showNotification(`üïê Ayuno ${FASTING_TYPES[type]?.label || targetHours + 'h'} iniciado`);
            render();
        }

        function endFasting() {
            const data = getFastingData();
            if (!data.activeFast) return;

            const elapsed = calculateFastingElapsed();
            const actualHours = elapsed / 3600;
            const completed = actualHours >= data.activeFast.targetHours;

            // Save to history
            const historyEntry = {
                id: data.activeFast.id,
                type: data.activeFast.type,
                targetHours: data.activeFast.targetHours,
                startedAt: data.activeFast.startedAt,
                endedAt: new Date().toISOString(),
                actualHours: parseFloat(actualHours.toFixed(2)),
                completed: completed,
                notes: data.activeFast.notes,
                feedback: ''
            };

            data.history.unshift(historyEntry);
            data.activeFast = null;
            saveFastingData(data);

            stopFastingTimer();
            showFastingCompletionModal(completed ? '¬°Excelente!' : 'Buen intento', actualHours, historyEntry.targetHours);
            render();
        }

        function cancelFasting() {
            if (!confirm('¬øCancelar el ayuno actual? No se guardar√° en el historial.')) return;

            const data = getFastingData();
            data.activeFast = null;
            saveFastingData(data);

            stopFastingTimer();
            showNotification('‚ùå Ayuno cancelado');
            render();
        }

        // Fasting History CRUD
        function openEditFastingModal(id) {
            const data = getFastingData();
            const entry = data.history.find(h => h.id === id);
            if (!entry) return;

            document.getElementById('editFastingId').value = id;
            document.getElementById('editFastingEnergy').value = entry.notes?.energy || 3;
            document.getElementById('editFastingHunger').value = entry.notes?.hunger || 3;
            document.getElementById('editFastingFocus').value = entry.notes?.focus || 3;
            document.getElementById('editFastingFeedback').value = entry.feedback || '';

            // Update slider displays
            document.getElementById('editFastingEnergyValue').textContent = entry.notes?.energy || 3;
            document.getElementById('editFastingHungerValue').textContent = entry.notes?.hunger || 3;
            document.getElementById('editFastingFocusValue').textContent = entry.notes?.focus || 3;

            document.getElementById('editFastingModal').classList.remove('hidden');
        }

        function closeEditFastingModal() {
            document.getElementById('editFastingModal').classList.add('hidden');
        }

        function saveEditedFasting() {
            const id = parseInt(document.getElementById('editFastingId').value);
            const data = getFastingData();
            const entryIndex = data.history.findIndex(h => h.id === id);
            if (entryIndex === -1) return;

            data.history[entryIndex].notes = {
                energy: parseInt(document.getElementById('editFastingEnergy').value),
                hunger: parseInt(document.getElementById('editFastingHunger').value),
                focus: parseInt(document.getElementById('editFastingFocus').value)
            };
            data.history[entryIndex].feedback = document.getElementById('editFastingFeedback').value;

            saveFastingData(data);
            closeEditFastingModal();
            showNotification('‚úÖ Notas actualizadas');
            render();
        }

        function deleteFasting(id) {
            if (!confirm('¬øEliminar este registro de ayuno?')) return;

            const data = getFastingData();
            data.history = data.history.filter(h => h.id !== id);
            saveFastingData(data);

            showNotification('üóëÔ∏è Registro eliminado');
            render();
        }

        // Fasting Metrics
        function getFastingMetrics() {
            const data = getFastingData();
            const history = data.history;
            const now = new Date();

            // Last 7 days
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const last7Days = history.filter(h => new Date(h.endedAt) >= sevenDaysAgo);
            const avg7Days = last7Days.length > 0
                ? last7Days.reduce((sum, h) => sum + h.actualHours, 0) / last7Days.length
                : 0;

            // Last 30 days
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const last30Days = history.filter(h => new Date(h.endedAt) >= thirtyDaysAgo);
            const avg30Days = last30Days.length > 0
                ? last30Days.reduce((sum, h) => sum + h.actualHours, 0) / last30Days.length
                : 0;

            // Longest fast
            const longestFast = history.length > 0
                ? Math.max(...history.map(h => h.actualHours))
                : 0;

            // Total hours this month
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonth = history.filter(h => new Date(h.endedAt) >= startOfMonth);
            const totalHoursMonth = thisMonth.reduce((sum, h) => sum + h.actualHours, 0);

            return {
                avg7Days: avg7Days.toFixed(1),
                avg30Days: avg30Days.toFixed(1),
                longestFast: longestFast.toFixed(1),
                totalHoursMonth: Math.round(totalHoursMonth)
            };
        }

        // Fasting Modal Functions
        function openStartFastingModal() {
            if (hasActiveFast()) {
                showNotification('‚ö†Ô∏è Ya tienes un ayuno activo');
                return;
            }
            document.getElementById('customFastingHours').value = '';
            document.getElementById('customFastingHoursGroup').classList.add('hidden');
            document.getElementById('startFastingModal').classList.remove('hidden');
        }

        function closeStartFastingModal() {
            document.getElementById('startFastingModal').classList.add('hidden');
        }

        function selectFastingType(type) {
            // Update visual selection
            document.querySelectorAll('.fasting-type-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-amber-500', 'bg-amber-50');
            });
            event.currentTarget.classList.add('ring-2', 'ring-amber-500', 'bg-amber-50');

            // Show/hide custom hours input
            const customGroup = document.getElementById('customFastingHoursGroup');
            if (type === 'custom') {
                customGroup.classList.remove('hidden');
            } else {
                customGroup.classList.add('hidden');
            }

            // Store selected type
            document.getElementById('startFastingModal').dataset.selectedType = type;
        }

        function confirmStartFasting() {
            const modal = document.getElementById('startFastingModal');
            const type = modal.dataset.selectedType;

            if (!type) {
                showNotification('‚ö†Ô∏è Selecciona un tipo de ayuno');
                return;
            }

            let customHours = null;
            if (type === 'custom') {
                customHours = parseFloat(document.getElementById('customFastingHours').value);
                if (!customHours || customHours <= 0 || customHours > 72) {
                    showNotification('‚ö†Ô∏è Ingresa una duraci√≥n v√°lida (1-72 horas)');
                    return;
                }
            }

            closeStartFastingModal();
            startFasting(type, customHours);
        }

        function openFastingNotesModal() {
            const data = getFastingData();
            if (!data.activeFast) return;

            document.getElementById('activeFastingEnergy').value = data.activeFast.notes?.energy || 3;
            document.getElementById('activeFastingHunger').value = data.activeFast.notes?.hunger || 3;
            document.getElementById('activeFastingFocus').value = data.activeFast.notes?.focus || 3;

            // Update displays
            document.getElementById('activeFastingEnergyValue').textContent = data.activeFast.notes?.energy || 3;
            document.getElementById('activeFastingHungerValue').textContent = data.activeFast.notes?.hunger || 3;
            document.getElementById('activeFastingFocusValue').textContent = data.activeFast.notes?.focus || 3;

            document.getElementById('fastingNotesModal').classList.remove('hidden');
        }

        function closeFastingNotesModal() {
            document.getElementById('fastingNotesModal').classList.add('hidden');
        }

        function saveFastingNotes() {
            const data = getFastingData();
            if (!data.activeFast) return;

            data.activeFast.notes = {
                energy: parseInt(document.getElementById('activeFastingEnergy').value),
                hunger: parseInt(document.getElementById('activeFastingHunger').value),
                focus: parseInt(document.getElementById('activeFastingFocus').value)
            };

            saveFastingData(data);
            closeFastingNotesModal();
            showNotification('‚úÖ Notas guardadas');
        }

        function showFastingCompletionModal(feedback, actualHours, targetHours) {
            const percentage = Math.round((actualHours / targetHours) * 100);
            const isCompleted = actualHours >= targetHours;

            document.getElementById('completionFeedback').textContent = feedback;
            document.getElementById('completionActualHours').textContent = actualHours.toFixed(1) + 'h';
            document.getElementById('completionTargetHours').textContent = targetHours + 'h';
            document.getElementById('completionPercentage').textContent = percentage + '%';

            const icon = document.getElementById('completionIcon');
            if (isCompleted) {
                icon.textContent = 'üéâ';
                icon.parentElement.classList.remove('from-orange-500', 'to-red-500');
                icon.parentElement.classList.add('from-green-500', 'to-emerald-500');
            } else {
                icon.textContent = 'üí™';
                icon.parentElement.classList.remove('from-green-500', 'to-emerald-500');
                icon.parentElement.classList.add('from-orange-500', 'to-red-500');
            }

            document.getElementById('fastingCompletionModal').classList.remove('hidden');
        }

        function closeFastingCompletionModal() {
            document.getElementById('fastingCompletionModal').classList.add('hidden');
        }

        // ==========================================
        // TRAINING PLAN WIZARD FUNCTIONS
        // ==========================================

        function getActiveTrainingPlan() {
            const plan = JSON.parse(getStorage('training-plan') || 'null');
            if (plan && plan.status === 'active') {
                return plan;
            }
            return null;
        }

        function saveTrainingPlan(plan) {
            setStorage('training-plan', JSON.stringify(plan));
        }

        function hasActiveTrainingPlan() {
            return getActiveTrainingPlan() !== null;
        }

        function openTrainingPlanWizard() {
            trainingPlanStep = 1;
            trainingPlanData = {
                profile: { age: null, sex: null, height: null, weight: null, level: 'beginner', injuries: [] },
                goal: { primary: null, secondary: null },
                availability: { daysPerWeek: 3, preferredTime: 'morning', sessionDuration: 45, selectedDays: [] },
                preferences: { location: 'gym', equipment: ['dumbbells', 'machines'], priorityZones: [], avoidZones: [] }
            };
            document.getElementById('trainingPlanWizardModal').classList.remove('hidden');
            renderTrainingPlanStep();
        }

        function closeTrainingPlanWizard() {
            document.getElementById('trainingPlanWizardModal').classList.add('hidden');
        }

        function nextTrainingPlanStep() {
            if (!validateTrainingPlanStep(trainingPlanStep)) return;

            if (trainingPlanStep === 5) {
                const plan = generateTrainingPlan(trainingPlanData);
                saveTrainingPlan(plan);
                applyTrainingPlanToGym(plan);
                closeTrainingPlanWizard();
                render();
                return;
            }

            trainingPlanStep++;
            renderTrainingPlanStep();
        }

        function prevTrainingPlanStep() {
            if (trainingPlanStep > 1) {
                trainingPlanStep--;
                renderTrainingPlanStep();
            }
        }

        function validateTrainingPlanStep(step) {
            switch (step) {
                case 1:
                    if (!trainingPlanData.profile.age || trainingPlanData.profile.age < 14 || trainingPlanData.profile.age > 99) {
                        alert('Por favor ingresa tu edad (14-99 a√±os)');
                        return false;
                    }
                    if (!trainingPlanData.profile.sex) {
                        alert('Por favor selecciona tu sexo');
                        return false;
                    }
                    return true;
                case 2:
                    if (!trainingPlanData.goal.primary) {
                        alert('Por favor selecciona tu objetivo principal');
                        return false;
                    }
                    return true;
                case 3:
                    if (trainingPlanData.availability.selectedDays.length !== trainingPlanData.availability.daysPerWeek) {
                        alert('Por favor selecciona exactamente ' + trainingPlanData.availability.daysPerWeek + ' d√≠as');
                        return false;
                    }
                    return true;
                case 4:
                    if (trainingPlanData.preferences.equipment.length === 0) {
                        alert('Por favor selecciona al menos un tipo de equipamiento');
                        return false;
                    }
                    return true;
                case 5:
                    return true;
                default:
                    return true;
            }
        }

        function renderTrainingPlanStep() {
            const container = document.getElementById('trainingPlanStepContent');
            const progress = document.getElementById('trainingPlanProgress');
            const stepLabel = document.getElementById('trainingPlanStepLabel');
            const backBtn = document.getElementById('trainingPlanBackBtn');
            const nextBtn = document.getElementById('trainingPlanNextBtn');

            progress.style.width = ((trainingPlanStep / 5) * 100) + '%';
            stepLabel.textContent = trainingPlanStep + '/5';

            backBtn.classList.toggle('hidden', trainingPlanStep === 1);
            nextBtn.textContent = trainingPlanStep === 5 ? 'üöÄ Generar mi Plan' : 'Siguiente ‚Üí';

            switch (trainingPlanStep) {
                case 1: container.innerHTML = renderTrainingPlanStep1(); break;
                case 2: container.innerHTML = renderTrainingPlanStep2(); break;
                case 3: container.innerHTML = renderTrainingPlanStep3(); break;
                case 4: container.innerHTML = renderTrainingPlanStep4(); break;
                case 5: container.innerHTML = renderTrainingPlanStep5(); break;
            }
        }

        function renderTrainingPlanStep1() {
            const profile = trainingPlanData.profile;
            const injuries = ['rodilla', 'espalda', 'hombro', 'mu√±eca', 'cadera'];
            const levelLabels = { beginner: 'üå± Principiante', intermediate: 'üí™ Intermedio', advanced: 'üî• Avanzado' };
            const levelDescs = { beginner: '0-1 a√±o', intermediate: '1-3 a√±os', advanced: '3+ a√±os' };

            let html = '<div class="space-y-5">';
            html += '<div class="text-center mb-6"><span class="text-4xl">üìä</span>';
            html += '<h4 class="text-xl font-bold text-gray-800 mt-2">Tu Perfil F√≠sico</h4>';
            html += '<p class="text-gray-500 text-sm">Personaliza tu plan seg√∫n tu cuerpo</p></div>';

            html += '<div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">Edad</label>';
            html += '<input type="number" id="tpAge" value="' + (profile.age || '') + '" min="14" max="99" ';
            html += 'onchange="trainingPlanData.profile.age = parseInt(this.value)" ';
            html += 'class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent" placeholder="A√±os"></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">Sexo</label>';
            html += '<div class="flex gap-2">';
            html += '<button onclick="setTrainingPlanSex(\'male\')" class="flex-1 py-3 rounded-xl font-medium transition ' + (profile.sex === 'male' ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">‚ôÇÔ∏è M</button>';
            html += '<button onclick="setTrainingPlanSex(\'female\')" class="flex-1 py-3 rounded-xl font-medium transition ' + (profile.sex === 'female' ? 'bg-pink-100 text-pink-700 ring-2 ring-pink-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">‚ôÄÔ∏è F</button>';
            html += '</div></div></div>';

            html += '<div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">Altura (cm)</label>';
            html += '<input type="number" id="tpHeight" value="' + (profile.height || '') + '" min="100" max="250" ';
            html += 'onchange="trainingPlanData.profile.height = parseInt(this.value)" ';
            html += 'class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent" placeholder="cm"></div>';
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">Peso (kg)</label>';
            html += '<input type="number" id="tpWeight" value="' + (profile.weight || '') + '" min="30" max="300" ';
            html += 'onchange="trainingPlanData.profile.weight = parseInt(this.value)" ';
            html += 'class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent" placeholder="kg"></div></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Nivel de experiencia</label>';
            html += '<div class="grid grid-cols-3 gap-2">';
            ['beginner', 'intermediate', 'advanced'].forEach(function(level) {
                html += '<button onclick="setTrainingPlanLevel(\'' + level + '\')" class="py-3 px-2 rounded-xl text-center transition ' + (profile.level === level ? 'bg-purple-100 text-purple-700 ring-2 ring-purple-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">';
                html += '<span class="block text-sm font-medium">' + levelLabels[level] + '</span>';
                html += '<span class="block text-xs text-gray-500">' + levelDescs[level] + '</span></button>';
            });
            html += '</div></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">¬øTienes lesiones? (opcional)</label>';
            html += '<div class="flex flex-wrap gap-2">';
            injuries.forEach(function(injury) {
                html += '<button onclick="toggleTrainingPlanInjury(\'' + injury + '\')" class="px-3 py-2 rounded-lg text-sm font-medium transition ' + (profile.injuries.indexOf(injury) >= 0 ? 'bg-red-100 text-red-700 ring-2 ring-red-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">';
                html += injury.charAt(0).toUpperCase() + injury.slice(1) + '</button>';
            });
            html += '<button onclick="setNoInjuries()" class="px-3 py-2 rounded-lg text-sm font-medium transition ' + (profile.injuries.length === 0 ? 'bg-green-100 text-green-700 ring-2 ring-green-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">‚úì Ninguna</button>';
            html += '</div></div></div>';

            return html;
        }

        function renderTrainingPlanStep2() {
            const goal = trainingPlanData.goal;
            const goals = [
                { id: 'fat_loss', icon: 'üî•', name: 'Bajar grasa', desc: 'Quemar grasa y definir' },
                { id: 'muscle_gain', icon: 'üí™', name: 'Ganar m√∫sculo', desc: 'Aumentar masa muscular' },
                { id: 'tone', icon: '‚ú®', name: 'Tonificar', desc: 'Definici√≥n sin volumen' },
                { id: 'strength', icon: 'üèãÔ∏è', name: 'Fuerza', desc: 'M√°s peso, m√°s potencia' },
                { id: 'endurance', icon: 'üèÉ', name: 'Resistencia', desc: 'Aguante y cardio' },
                { id: 'health', icon: '‚ù§Ô∏è', name: 'Salud', desc: 'Bienestar general' }
            ];

            let html = '<div class="space-y-5">';
            html += '<div class="text-center mb-6"><span class="text-4xl">üéØ</span>';
            html += '<h4 class="text-xl font-bold text-gray-800 mt-2">Tu Objetivo</h4>';
            html += '<p class="text-gray-500 text-sm">¬øQu√© quieres lograr?</p></div>';

            html += '<div class="grid grid-cols-2 gap-3">';
            goals.forEach(function(g) {
                html += '<button onclick="setTrainingPlanGoal(\'' + g.id + '\')" class="p-4 rounded-xl text-center transition border-2 ' + (goal.primary === g.id ? 'bg-purple-50 border-purple-400 ring-2 ring-purple-200' : 'bg-white border-gray-200 hover:border-purple-200') + '">';
                html += '<span class="text-3xl block mb-2">' + g.icon + '</span>';
                html += '<span class="block font-bold text-gray-800">' + g.name + '</span>';
                html += '<span class="block text-xs text-gray-500">' + g.desc + '</span></button>';
            });
            html += '</div></div>';

            return html;
        }

        function renderTrainingPlanStep3() {
            const availability = trainingPlanData.availability;
            const days = ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'];
            const daysFull = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

            let html = '<div class="space-y-5">';
            html += '<div class="text-center mb-6"><span class="text-4xl">üìÖ</span>';
            html += '<h4 class="text-xl font-bold text-gray-800 mt-2">Tu Disponibilidad</h4>';
            html += '<p class="text-gray-500 text-sm">¬øCu√°ndo puedes entrenar?</p></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">D√≠as por semana</label>';
            html += '<div class="flex gap-2">';
            [3, 4, 5, 6].forEach(function(d) {
                html += '<button onclick="setTrainingPlanDaysPerWeek(' + d + ')" class="flex-1 py-3 rounded-xl font-bold transition ' + (availability.daysPerWeek === d ? 'bg-purple-100 text-purple-700 ring-2 ring-purple-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">' + d + '</button>';
            });
            html += '</div></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Selecciona los d√≠as <span class="text-purple-600">(' + availability.selectedDays.length + '/' + availability.daysPerWeek + ')</span></label>';
            html += '<div class="grid grid-cols-7 gap-1">';
            for (var i = 0; i < 7; i++) {
                var isSelected = availability.selectedDays.indexOf(i) >= 0;
                var isDisabled = availability.selectedDays.length >= availability.daysPerWeek && !isSelected;
                html += '<button onclick="toggleTrainingPlanDay(' + i + ')" class="py-3 rounded-xl font-medium text-sm transition ' + (isSelected ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + (isDisabled ? ' opacity-50' : '') + '">' + days[i] + '</button>';
            }
            html += '</div>';
            var selectedDayNames = availability.selectedDays.map(function(d) { return daysFull[d]; }).join(', ');
            html += '<p class="text-xs text-gray-500 mt-1">' + (selectedDayNames || 'Ning√∫n d√≠a seleccionado') + '</p></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Horario preferido</label>';
            html += '<div class="grid grid-cols-3 gap-2">';
            var times = [
                { id: 'morning', icon: 'üåÖ', name: 'Ma√±ana', time: '6-12h' },
                { id: 'afternoon', icon: '‚òÄÔ∏è', name: 'Tarde', time: '12-18h' },
                { id: 'evening', icon: 'üåô', name: 'Noche', time: '18-22h' }
            ];
            times.forEach(function(t) {
                html += '<button onclick="setTrainingPlanTime(\'' + t.id + '\')" class="py-3 px-2 rounded-xl text-center transition ' + (availability.preferredTime === t.id ? 'bg-purple-100 text-purple-700 ring-2 ring-purple-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">';
                html += '<span class="block text-xl">' + t.icon + '</span>';
                html += '<span class="block text-sm font-medium">' + t.name + '</span>';
                html += '<span class="block text-xs text-gray-500">' + t.time + '</span></button>';
            });
            html += '</div></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Duraci√≥n por sesi√≥n</label>';
            html += '<div class="flex gap-2">';
            [30, 45, 60, 75].forEach(function(d) {
                html += '<button onclick="setTrainingPlanDuration(' + d + ')" class="flex-1 py-3 rounded-xl font-medium transition ' + (availability.sessionDuration === d ? 'bg-purple-100 text-purple-700 ring-2 ring-purple-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">' + d + '\'</button>';
            });
            html += '</div></div></div>';

            return html;
        }

        function renderTrainingPlanStep4() {
            const preferences = trainingPlanData.preferences;
            const equipment = [
                { id: 'barbell', name: 'Barra' },
                { id: 'dumbbells', name: 'Mancuernas' },
                { id: 'machines', name: 'M√°quinas' },
                { id: 'cables', name: 'Poleas' },
                { id: 'bodyweight', name: 'Peso corporal' }
            ];
            const zones = [
                { id: 'glutes', name: 'Gl√∫teos', icon: 'üçë' },
                { id: 'legs', name: 'Piernas', icon: 'ü¶µ' },
                { id: 'back', name: 'Espalda', icon: 'üîô' },
                { id: 'chest', name: 'Pecho', icon: 'üí™' },
                { id: 'arms', name: 'Brazos', icon: 'üí™' },
                { id: 'core', name: 'Core', icon: 'üéØ' }
            ];
            const locations = [
                { id: 'gym', icon: 'üèãÔ∏è', name: 'Gimnasio' },
                { id: 'home', icon: 'üè†', name: 'Casa' },
                { id: 'mixed', icon: 'üîÑ', name: 'Mixto' }
            ];

            let html = '<div class="space-y-5">';
            html += '<div class="text-center mb-6"><span class="text-4xl">‚öôÔ∏è</span>';
            html += '<h4 class="text-xl font-bold text-gray-800 mt-2">Preferencias</h4>';
            html += '<p class="text-gray-500 text-sm">Personaliza tu entrenamiento</p></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">¬øD√≥nde entrenas?</label>';
            html += '<div class="grid grid-cols-3 gap-2">';
            locations.forEach(function(l) {
                html += '<button onclick="setTrainingPlanLocation(\'' + l.id + '\')" class="py-3 rounded-xl text-center transition ' + (preferences.location === l.id ? 'bg-purple-100 text-purple-700 ring-2 ring-purple-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">';
                html += '<span class="block text-2xl">' + l.icon + '</span>';
                html += '<span class="block text-sm font-medium">' + l.name + '</span></button>';
            });
            html += '</div></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Equipamiento disponible</label>';
            html += '<div class="flex flex-wrap gap-2">';
            equipment.forEach(function(e) {
                html += '<button onclick="toggleTrainingPlanEquipment(\'' + e.id + '\')" class="px-3 py-2 rounded-lg text-sm font-medium transition ' + (preferences.equipment.indexOf(e.id) >= 0 ? 'bg-purple-100 text-purple-700 ring-2 ring-purple-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">' + e.name + '</button>';
            });
            html += '</div></div>';

            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">Zonas a priorizar <span class="text-gray-500">(m√°x. 3)</span></label>';
            html += '<div class="grid grid-cols-3 gap-2">';
            zones.forEach(function(z) {
                var isSelected = preferences.priorityZones.indexOf(z.id) >= 0;
                var isDisabled = preferences.priorityZones.length >= 3 && !isSelected;
                html += '<button onclick="toggleTrainingPlanZone(\'' + z.id + '\', \'priority\')" class="py-2 px-3 rounded-lg text-sm font-medium transition ' + (isSelected ? 'bg-green-100 text-green-700 ring-2 ring-green-400' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + (isDisabled ? ' opacity-50' : '') + '">' + z.icon + ' ' + z.name + '</button>';
            });
            html += '</div></div></div>';

            return html;
        }

        function renderTrainingPlanStep5() {
            const profile = trainingPlanData.profile;
            const goal = trainingPlanData.goal;
            const availability = trainingPlanData.availability;
            const preferences = trainingPlanData.preferences;

            const goalLabels = {
                fat_loss: 'üî• Bajar grasa',
                muscle_gain: 'üí™ Ganar m√∫sculo',
                tone: '‚ú® Tonificar',
                strength: 'üèãÔ∏è Fuerza',
                endurance: 'üèÉ Resistencia',
                health: '‚ù§Ô∏è Salud'
            };
            const levelLabels = { beginner: 'Principiante', intermediate: 'Intermedio', advanced: 'Avanzado' };
            const timeLabels = { morning: 'üåÖ Ma√±ana', afternoon: '‚òÄÔ∏è Tarde', evening: 'üåô Noche' };
            const daysFull = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

            const splits = TRAINING_SPLIT_TYPES[availability.daysPerWeek];
            const splitKey = Object.keys(splits)[0];
            const split = splits[splitKey];

            const routineNames = {
                push: { name: 'Push (Empuje)', icon: 'üí™' },
                pull: { name: 'Pull (Tir√≥n)', icon: 'üîô' },
                legs: { name: 'Piernas + Gl√∫teos', icon: 'ü¶µ' },
                upper: { name: 'Tren Superior', icon: 'üí™' },
                lower: { name: 'Tren Inferior', icon: 'ü¶µ' },
                full: { name: 'Full Body', icon: 'üî•' },
                chest: { name: 'Pecho', icon: 'üí™' },
                back: { name: 'Espalda', icon: 'üîô' },
                shoulders: { name: 'Hombros', icon: 'üéØ' },
                arms: { name: 'Brazos', icon: 'üí™' },
                core: { name: 'Core', icon: 'üéØ' }
            };

            let html = '<div class="space-y-5">';
            html += '<div class="text-center mb-6"><span class="text-4xl">‚úÖ</span>';
            html += '<h4 class="text-xl font-bold text-gray-800 mt-2">Tu Plan Personalizado</h4>';
            html += '<p class="text-gray-500 text-sm">Revisa y confirma</p></div>';

            html += '<div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 space-y-2">';
            html += '<h5 class="font-bold text-gray-800 mb-3">üìã Resumen</h5>';
            html += '<div class="grid grid-cols-2 gap-2 text-sm">';
            html += '<div class="text-gray-600">Objetivo:</div><div class="font-medium text-gray-800">' + goalLabels[goal.primary] + '</div>';
            html += '<div class="text-gray-600">Nivel:</div><div class="font-medium text-gray-800">' + levelLabels[profile.level] + '</div>';
            html += '<div class="text-gray-600">D√≠as:</div><div class="font-medium text-gray-800">' + availability.daysPerWeek + ' d√≠as/semana</div>';
            html += '<div class="text-gray-600">Duraci√≥n:</div><div class="font-medium text-gray-800">' + availability.sessionDuration + ' min/sesi√≥n</div>';
            html += '<div class="text-gray-600">Horario:</div><div class="font-medium text-gray-800">' + timeLabels[availability.preferredTime] + '</div>';
            html += '<div class="text-gray-600">Split:</div><div class="font-medium text-gray-800">' + split.icon + ' ' + split.name + '</div>';
            html += '</div></div>';

            html += '<div class="bg-white rounded-xl border border-gray-200 p-4">';
            html += '<h5 class="font-bold text-gray-800 mb-3">üìÖ Tu Semana</h5>';
            html += '<div class="space-y-2">';
            availability.selectedDays.forEach(function(dayIndex, i) {
                var routineType = split.routine[i % split.routine.length];
                var routine = routineNames[routineType] || { name: 'Entrenamiento', icon: 'üí™' };
                html += '<div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">';
                html += '<span class="w-10 text-center font-bold text-purple-600">' + daysFull[dayIndex] + '</span>';
                html += '<span class="text-xl">' + routine.icon + '</span>';
                html += '<span class="flex-1 font-medium text-gray-700">' + routine.name + '</span></div>';
            });
            html += '</div></div>';

            html += '<div class="bg-amber-50 border border-amber-200 rounded-xl p-3">';
            html += '<p class="text-amber-800 text-sm">üí° <strong>Nota:</strong> Se agregar√° autom√°ticamente a tu secci√≥n de Entreno y podr√°s modificarlo cuando quieras.</p>';
            html += '</div></div>';

            return html;
        }

        function setTrainingPlanSex(sex) {
            trainingPlanData.profile.sex = sex;
            renderTrainingPlanStep();
        }

        function setTrainingPlanLevel(level) {
            trainingPlanData.profile.level = level;
            renderTrainingPlanStep();
        }

        function toggleTrainingPlanInjury(injury) {
            var idx = trainingPlanData.profile.injuries.indexOf(injury);
            if (idx >= 0) {
                trainingPlanData.profile.injuries.splice(idx, 1);
            } else {
                trainingPlanData.profile.injuries.push(injury);
            }
            renderTrainingPlanStep();
        }

        function setNoInjuries() {
            trainingPlanData.profile.injuries = [];
            renderTrainingPlanStep();
        }

        function setTrainingPlanGoal(goal) {
            trainingPlanData.goal.primary = goal;
            renderTrainingPlanStep();
        }

        function setTrainingPlanDaysPerWeek(days) {
            trainingPlanData.availability.daysPerWeek = days;
            if (trainingPlanData.availability.selectedDays.length > days) {
                trainingPlanData.availability.selectedDays = trainingPlanData.availability.selectedDays.slice(0, days);
            }
            renderTrainingPlanStep();
        }

        function toggleTrainingPlanDay(dayIndex) {
            var selected = trainingPlanData.availability.selectedDays;
            var idx = selected.indexOf(dayIndex);
            if (idx >= 0) {
                selected.splice(idx, 1);
            } else if (selected.length < trainingPlanData.availability.daysPerWeek) {
                selected.push(dayIndex);
                selected.sort(function(a, b) { return a - b; });
            }
            renderTrainingPlanStep();
        }

        function setTrainingPlanTime(time) {
            trainingPlanData.availability.preferredTime = time;
            renderTrainingPlanStep();
        }

        function setTrainingPlanDuration(duration) {
            trainingPlanData.availability.sessionDuration = duration;
            renderTrainingPlanStep();
        }

        function setTrainingPlanLocation(location) {
            trainingPlanData.preferences.location = location;
            if (location === 'home') {
                trainingPlanData.preferences.equipment = ['dumbbells', 'bodyweight'];
            } else if (location === 'gym') {
                trainingPlanData.preferences.equipment = ['dumbbells', 'machines', 'cables', 'barbell'];
            }
            renderTrainingPlanStep();
        }

        function toggleTrainingPlanEquipment(equipment) {
            var equip = trainingPlanData.preferences.equipment;
            var idx = equip.indexOf(equipment);
            if (idx >= 0) {
                equip.splice(idx, 1);
            } else {
                equip.push(equipment);
            }
            renderTrainingPlanStep();
        }

        function toggleTrainingPlanZone(zone, type) {
            var zones = type === 'priority' ? trainingPlanData.preferences.priorityZones : trainingPlanData.preferences.avoidZones;
            var idx = zones.indexOf(zone);
            if (idx >= 0) {
                zones.splice(idx, 1);
            } else if (zones.length < 3) {
                zones.push(zone);
            }
            renderTrainingPlanStep();
        }

        function generateTrainingPlan(data) {
            var profile = data.profile;
            var goal = data.goal;
            var availability = data.availability;
            var preferences = data.preferences;
            var splits = TRAINING_SPLIT_TYPES[availability.daysPerWeek];
            var splitKey = Object.keys(splits)[0];
            var split = splits[splitKey];

            var weeklyPlan = {};
            var routineNames = {
                push: { name: 'Push (Empuje)', icon: 'üí™' },
                pull: { name: 'Pull (Tir√≥n)', icon: 'üîô' },
                legs: { name: 'Piernas + Gl√∫teos', icon: 'ü¶µ' },
                upper: { name: 'Tren Superior', icon: 'üí™' },
                lower: { name: 'Tren Inferior', icon: 'ü¶µ' },
                full: { name: 'Full Body', icon: 'üî•' },
                chest: { name: 'Pecho', icon: 'üí™' },
                back: { name: 'Espalda', icon: 'üîô' },
                shoulders: { name: 'Hombros', icon: 'üéØ' },
                arms: { name: 'Brazos', icon: 'üí™' },
                core: { name: 'Core', icon: 'üéØ' }
            };

            availability.selectedDays.forEach(function(dayIndex, i) {
                var routineType = split.routine[i % split.routine.length];
                var routineInfo = routineNames[routineType] || { name: 'Entrenamiento', icon: 'üí™' };
                var exercises = generateDayExercises(routineType, {
                    level: profile.level,
                    goal: goal.primary,
                    equipment: preferences.equipment,
                    priority: preferences.priorityZones,
                    injuries: profile.injuries,
                    duration: availability.sessionDuration
                });

                weeklyPlan[dayIndex] = {
                    name: routineInfo.name,
                    icon: routineInfo.icon,
                    type: routineType,
                    exercises: exercises
                };
            });

            return {
                id: Date.now(),
                createdAt: new Date().toISOString(),
                status: 'active',
                profile: profile,
                goal: goal,
                availability: availability,
                preferences: preferences,
                weeklyPlan: weeklyPlan,
                splitName: split.name
            };
        }

        function generateDayExercises(routineType, options) {
            var level = options.level;
            var goal = options.goal;
            var equipment = options.equipment;
            var priority = options.priority;
            var injuries = options.injuries;
            var duration = options.duration;
            var muscles = ROUTINE_MUSCLES[routineType] || [];
            var exercises = [];

            var exerciseCount = duration <= 30 ? 4 : duration <= 45 ? 5 : duration <= 60 ? 6 : 7;

            muscles.forEach(function(muscle) {
                var muscleExercises = TRAINING_EXERCISE_DB[muscle] || [];

                var filtered = muscleExercises.filter(function(ex) {
                    var hasEquipment = ex.equipment.some(function(eq) { return equipment.indexOf(eq) >= 0; });
                    var levelOk = ex.level === 'all' || ex.level === level || (level === 'advanced');
                    return hasEquipment && levelOk;
                });

                if (injuries.indexOf('rodilla') >= 0) {
                    filtered = filtered.filter(function(ex) {
                        return ['Squat', 'Lunges', 'Bulgarian Split Squat'].indexOf(ex.name) < 0;
                    });
                }
                if (injuries.indexOf('espalda') >= 0) {
                    filtered = filtered.filter(function(ex) {
                        return ['Barbell Row', 'Romanian Deadlift'].indexOf(ex.name) < 0;
                    });
                }
                if (injuries.indexOf('hombro') >= 0) {
                    filtered = filtered.filter(function(ex) {
                        return ['Overhead Press', 'Bench Press', 'Incline DB Press'].indexOf(ex.name) < 0;
                    });
                }

                if (priority.indexOf(muscle) >= 0) {
                    var toAdd = filtered.slice(0, 2);
                    toAdd.forEach(function(ex) {
                        if (exercises.length < exerciseCount) {
                            exercises.push({
                                id: muscle + '-' + ex.name.replace(/\s+/g, '-').toLowerCase(),
                                name: ex.name,
                                muscle: muscle,
                                sets: adjustSetsForGoal(ex.sets, goal),
                                reps: adjustRepsForGoal(ex.reps, goal),
                                rest: getRestTime(goal),
                                order: exercises.length + 1
                            });
                        }
                    });
                } else if (filtered.length > 0 && exercises.length < exerciseCount) {
                    var ex = filtered[0];
                    exercises.push({
                        id: muscle + '-' + ex.name.replace(/\s+/g, '-').toLowerCase(),
                        name: ex.name,
                        muscle: muscle,
                        sets: adjustSetsForGoal(ex.sets, goal),
                        reps: adjustRepsForGoal(ex.reps, goal),
                        rest: getRestTime(goal),
                        order: exercises.length + 1
                    });
                }
            });

            return exercises.slice(0, exerciseCount);
        }

        function adjustSetsForGoal(baseSets, goal) {
            switch (goal) {
                case 'strength': return Math.max(baseSets, 4);
                case 'endurance': return 3;
                case 'fat_loss': return 3;
                default: return baseSets;
            }
        }

        function adjustRepsForGoal(baseReps, goal) {
            switch (goal) {
                case 'strength': return '5-6';
                case 'endurance': return '15-20';
                case 'fat_loss': return '12-15';
                case 'muscle_gain': return '8-12';
                default: return baseReps;
            }
        }

        function getRestTime(goal) {
            switch (goal) {
                case 'strength': return 180;
                case 'endurance': return 30;
                case 'fat_loss': return 45;
                default: return 90;
            }
        }

        function applyTrainingPlanToGym(plan) {
            Object.keys(plan.weeklyPlan).forEach(function(dayIndex) {
                var routine = plan.weeklyPlan[dayIndex];
                customGym[dayIndex] = {
                    name: routine.name,
                    icon: routine.icon,
                    exercises: routine.exercises.map(function(ex) { return ex.name + ' ' + ex.sets + 'x' + ex.reps; })
                };
            });

            for (var i = 0; i < 7; i++) {
                if (!plan.weeklyPlan[i]) {
                    customGym[i] = {
                        name: "Descanso",
                        icon: "üßò",
                        exercises: ["Recuperaci√≥n activa", "Estiramientos", "Descanso"]
                    };
                }
            }

            setStorage('custom-gym', JSON.stringify(customGym));
        }

        function deleteTrainingPlan() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar tu plan de entrenamiento?')) {
                var plan = getActiveTrainingPlan();
                if (plan) {
                    plan.status = 'deleted';
                    saveTrainingPlan(plan);
                }
                customGym = {};
                setStorage('custom-gym', JSON.stringify(customGym));
                render();
            }
        }

        // Render Fasting Section
        function renderFasting() {
            const data = getFastingData();
            const metrics = getFastingMetrics();
            const hasActive = data.activeFast !== null;

            // If there's an active fast, make sure timer is running
            if (hasActive && !fastingTimerInterval) {
                startFastingTimer();
            }

            let activeCardHtml = '';
            if (hasActive) {
                const elapsed = calculateFastingElapsed();
                const targetSeconds = data.activeFast.targetHours * 3600;
                const progress = Math.min((elapsed / targetSeconds) * 100, 100);
                const remaining = Math.max(targetSeconds - elapsed, 0);
                const remainingHours = (remaining / 3600).toFixed(1);
                const typeInfo = FASTING_TYPES[data.activeFast.type] || { label: data.activeFast.targetHours + 'h' };

                activeCardHtml = `
                    <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-amber-100 text-sm">Ayuno activo</p>
                                <p class="text-2xl font-bold">${typeInfo.label}</p>
                            </div>
                            <div class="relative w-24 h-24">
                                <svg class="w-24 h-24 transform -rotate-90">
                                    <circle cx="48" cy="48" r="40" stroke="rgba(255,255,255,0.3)" stroke-width="8" fill="none"/>
                                    <circle cx="48" cy="48" r="40" stroke="white" stroke-width="8" fill="none"
                                        stroke-dasharray="${2 * Math.PI * 40}"
                                        stroke-dashoffset="${2 * Math.PI * 40 * (1 - progress / 100)}"
                                        stroke-linecap="round"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-lg font-bold">${Math.round(progress)}%</span>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mb-4">
                            <p id="fastingTimer" class="text-5xl font-mono font-bold tracking-wider">${formatFastingTime(elapsed)}</p>
                            <p class="text-amber-100 mt-1">Meta: ${data.activeFast.targetHours}h</p>
                            <p id="fastingRemaining" class="text-sm mt-1 ${remaining <= 0 ? 'text-green-200 font-bold' : 'text-amber-100'}">
                                ${remaining > 0 ? `Faltan ${remainingHours}h` : '¬°Meta alcanzada!'}
                            </p>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="openFastingNotesModal()" class="flex-1 py-2 bg-white/20 hover:bg-white/30 rounded-xl font-medium transition text-sm">
                                üìù Notas
                            </button>
                            <button onclick="endFasting()" class="flex-1 py-2 bg-white hover:bg-amber-50 text-amber-600 rounded-xl font-medium transition text-sm">
                                ‚úÖ Finalizar
                            </button>
                            <button onclick="cancelFasting()" class="py-2 px-3 bg-white/20 hover:bg-red-500/50 rounded-xl font-medium transition text-sm">
                                ‚úï
                            </button>
                        </div>
                    </div>
                `;
            } else {
                activeCardHtml = `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="text-center py-4">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-amber-100 to-orange-100 rounded-full flex items-center justify-center mb-4">
                                <span class="text-4xl">üïê</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">Ayuno Intermitente</h3>
                            <p class="text-gray-500 text-sm mb-4">Mejora tu metabolismo y claridad mental</p>
                            <button onclick="openStartFastingModal()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-medium hover:opacity-90 transition shadow-lg">
                                üöÄ Iniciar Ayuno
                            </button>
                        </div>
                    </div>
                `;
            }

            // Metrics cards
            const metricsHtml = `
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        üìä Estad√≠sticas
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3 text-center">
                            <p class="text-2xl font-bold text-amber-600">${metrics.avg7Days}h</p>
                            <p class="text-xs text-gray-500">Promedio 7 d√≠as</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3 text-center">
                            <p class="text-2xl font-bold text-amber-600">${metrics.avg30Days}h</p>
                            <p class="text-xs text-gray-500">Promedio 30 d√≠as</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3 text-center">
                            <p class="text-2xl font-bold text-amber-600">${metrics.longestFast}h</p>
                            <p class="text-xs text-gray-500">M√°s largo</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-3 text-center">
                            <p class="text-2xl font-bold text-amber-600">${metrics.totalHoursMonth}h</p>
                            <p class="text-xs text-gray-500">Total este mes</p>
                        </div>
                    </div>
                </div>
            `;

            // History list (last 10)
            const recentHistory = data.history.slice(0, 10);
            const historyHtml = `
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        üìã Historial Reciente
                    </h4>
                    ${recentHistory.length > 0 ? `
                        <div class="space-y-2">
                            ${recentHistory.map(entry => {
                                const date = new Date(entry.endedAt);
                                const dateStr = date.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit' });
                                const typeInfo = FASTING_TYPES[entry.type] || { label: entry.targetHours + 'h' };
                                const icon = entry.completed ? '‚úÖ' : '‚è∏Ô∏è';
                                const bgClass = entry.completed ? 'bg-green-50 border-green-100' : 'bg-gray-50 border-gray-100';

                                return `
                                    <div class="flex items-center justify-between p-3 rounded-xl border ${bgClass}">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xl">${icon}</span>
                                            <div>
                                                <p class="font-medium text-gray-800">${typeInfo.label} <span class="text-sm text-gray-500">(${entry.actualHours}h)</span></p>
                                                <p class="text-xs text-gray-500">${dateStr}</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick="openEditFastingModal(${entry.id})" class="p-2 hover:bg-white rounded-lg transition text-gray-400 hover:text-amber-500">
                                                ‚úèÔ∏è
                                            </button>
                                            <button onclick="deleteFasting(${entry.id})" class="p-2 hover:bg-white rounded-lg transition text-gray-400 hover:text-red-500">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-6 text-gray-400">
                            <p class="text-4xl mb-2">üì≠</p>
                            <p class="text-sm">Sin registros a√∫n</p>
                            <p class="text-xs">Completa tu primer ayuno para ver el historial</p>
                        </div>
                    `}
                </div>
            `;

            return `
                <div class="space-y-4">
                    ${activeCardHtml}
                    ${metricsHtml}
                    ${historyHtml}
                </div>
            `;
        }
        // ==================== END FASTING INTERMITTENT ====================

        // Pomodoro Timer Functions
        let pomodoroState = {
            timeLeft: 25 * 60, // seconds
            initialTime: 25 * 60,
            isRunning: false,
            interval: null,
            mode: 'work' // 'work' or 'break'
        };

        function openPomodoroModal() {
            document.getElementById('pomodoroModal').classList.remove('hidden');
            updatePomodoroDisplay();
            updatePomodoroCount();
        }

        function closePomodoroModal() {
            document.getElementById('pomodoroModal').classList.add('hidden');
        }

        function togglePomodoroInfo() {
            const panel = document.getElementById('pomodoroInfoPanel');
            panel.classList.toggle('hidden');
        }

        function setPomodoroTime(minutes) {
            if (pomodoroState.isRunning) {
                stopPomodoroTimer();
            }
            pomodoroState.timeLeft = minutes * 60;
            pomodoroState.initialTime = minutes * 60;
            pomodoroState.mode = minutes === 25 ? 'work' : 'break';
            updatePomodoroDisplay();
            updatePomodoroStatus();
        }

        function togglePomodoro() {
            if (pomodoroState.isRunning) {
                stopPomodoroTimer();
            } else {
                startPomodoroTimer();
            }
        }

        function startPomodoroTimer() {
            pomodoroState.isRunning = true;
            updatePomodoroButton();
            updatePomodoroStatus();
            updateFloatButton();

            pomodoroState.interval = setInterval(() => {
                pomodoroState.timeLeft--;

                if (pomodoroState.timeLeft <= 0) {
                    completePomodoroSession();
                } else {
                    updatePomodoroDisplay();
                    updateFloatButton();
                }
            }, 1000);
        }

        function stopPomodoroTimer() {
            pomodoroState.isRunning = false;
            if (pomodoroState.interval) {
                clearInterval(pomodoroState.interval);
                pomodoroState.interval = null;
            }
            updatePomodoroButton();
            updatePomodoroStatus();
            updateFloatButton();
        }

        function resetPomodoro() {
            stopPomodoroTimer();
            pomodoroState.timeLeft = pomodoroState.initialTime;
            updatePomodoroDisplay();
            updatePomodoroStatus();
        }

        function completePomodoroSession() {
            stopPomodoroTimer();

            // Sound notification (optional beep)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQsAZJrk47JuCQdkne3os2oEB2Oc8++tbAQEZJ328a5tAwRjnfj0r24DBGOd+fWvbgMEY534862tAwRinfbzrKsDBGKd9fKqqQMEYp3086qpAwRinfTyqagDBGKc8/GoqAMDYpzz8aipAwRinfPyqagDBGKc8/GnqAMEYpzz8aepAwRinfPxp6gDBGKc8/GnqAMEYpzz8aepAwRinfPyp6gDBGKc8/KnqQMDYp3z8qipAwRjnfPyqagDBGOd8/KoqAMEY53z8qipAwRjnfPyqKkDBGOd8/KoqQMEY530');
                audio.volume = 0.5;
                audio.play();
            } catch(e) {}

            if (pomodoroState.mode === 'work') {
                // Incrementar contador de pomodoros
                incrementPomodoroCount();
                showNotification('üçÖ ¬°Pomodoro completado! Toma un descanso.');

                // Cambiar a break
                pomodoroState.mode = 'break';
                pomodoroState.timeLeft = 5 * 60;
                pomodoroState.initialTime = 5 * 60;
            } else {
                showNotification('‚òï ¬°Descanso terminado! ¬øListo para otro Pomodoro?');

                // Volver a work
                pomodoroState.mode = 'work';
                pomodoroState.timeLeft = 25 * 60;
                pomodoroState.initialTime = 25 * 60;
            }

            updatePomodoroDisplay();
            updatePomodoroStatus();
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroState.timeLeft / 60);
            const seconds = pomodoroState.timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pomodoroDisplay').textContent = display;
        }

        function updatePomodoroButton() {
            const btn = document.getElementById('pomodoroStartBtn');
            if (pomodoroState.isRunning) {
                btn.innerHTML = '‚è∏Ô∏è Pausar';
            } else {
                btn.innerHTML = '‚ñ∂Ô∏è Iniciar';
            }
        }

        function updatePomodoroStatus() {
            const status = document.getElementById('pomodoroStatus');
            if (pomodoroState.isRunning) {
                status.textContent = pomodoroState.mode === 'work' ? 'üî• Enfocado...' : '‚òï Descansando...';
            } else {
                status.textContent = pomodoroState.mode === 'work' ? '‚è±Ô∏è Listo para trabajar' : '‚òï Listo para descansar';
            }
        }

        function updateFloatButton() {
            const btn = document.getElementById('pomodoroFloatBtn');
            if (pomodoroState.isRunning) {
                const minutes = Math.floor(pomodoroState.timeLeft / 60);
                const seconds = pomodoroState.timeLeft % 60;
                btn.innerHTML = `<span class="text-sm font-mono">${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                btn.classList.add('animate-pulse');
            } else {
                btn.innerHTML = 'üçÖ';
                btn.classList.remove('animate-pulse');
            }
        }

        function getPomodoroCountKey() {
            const today = new Date();
            return `pomodoro-count-${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        }

        function getPomodoroCount() {
            return parseInt(getStorage(getPomodoroCountKey()) || '0');
        }

        function incrementPomodoroCount() {
            const count = getPomodoroCount() + 1;
            setStorage(getPomodoroCountKey(), count.toString());
            updatePomodoroCount();
        }

        function updatePomodoroCount() {
            const countEl = document.getElementById('pomodoroCount');
            if (countEl) {
                countEl.textContent = getPomodoroCount();
            }
        }

        // Export Functions
        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportToCSV() {
            const data = collectExportData();
            let csv = 'Fecha,Hora,Actividad,Duraci√≥n,Categor√≠a,Completada\n';

            data.activities.forEach(item => {
                csv += `"${item.date}","${item.time}","${item.activity}","${item.duration}","${item.category}","${item.completed ? 'S√≠' : 'No'}"\n`;
            });

            csv += '\n\nH√°bitos del d√≠a\n';
            csv += 'Fecha,H√°bito,Completado\n';
            data.habits.forEach(habit => {
                csv += `"${habit.date}","${habit.name}","${habit.completed ? 'S√≠' : 'No'}"\n`;
            });

            downloadFile(csv, `gestion-tiempo-${formatDateForFile(new Date())}.csv`, 'text/csv');
            showNotification('üìä CSV exportado exitosamente');
            closeExportModal();
        }

        function exportToPrint() {
            const data = collectExportData();
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mi Plan - ${currentUser.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #8b5cf6; }
                        h2 { color: #ec4899; margin-top: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: linear-gradient(135deg, #fdf2f8, #f3e8ff); }
                        .completed { background: #dcfce7; }
                        .progress { margin: 20px 0; padding: 15px; background: #f3e8ff; border-radius: 10px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <h1>üìã Mi Plan de Gesti√≥n del Tiempo</h1>
                    <p><strong>Usuario:</strong> ${currentUser.name}</p>
                    <p><strong>Meta:</strong> ${getGoalText(currentUser.goal)}</p>
                    <p><strong>Fecha de exportaci√≥n:</strong> ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>

                    <div class="progress">
                        <strong>Progreso:</strong> D√≠a ${getDailyProgress(currentDate)}% | Semana ${getWeeklyProgress()}% | Total ${getTotalProgress()}%
                    </div>

                    <h2>üìÖ Actividades de Hoy</h2>
                    <table>
                        <tr><th>Hora</th><th>Actividad</th><th>Duraci√≥n</th><th>Estado</th></tr>
                        ${data.todayActivities.map(item => `
                            <tr class="${item.completed ? 'completed' : ''}">
                                <td>${item.time}</td>
                                <td>${item.activity}</td>
                                <td>${item.duration}</td>
                                <td>${item.completed ? '‚úÖ' : '‚è≥'}</td>
                            </tr>
                        `).join('')}
                    </table>

                    <h2>‚úÖ H√°bitos de Hoy</h2>
                    <table>
                        <tr><th>H√°bito</th><th>Estado</th></tr>
                        ${data.todayHabits.map(habit => `
                            <tr class="${habit.completed ? 'completed' : ''}">
                                <td>${habit.icon} ${habit.name}</td>
                                <td>${habit.completed ? '‚úÖ' : '‚è≥'}</td>
                            </tr>
                        `).join('')}
                    </table>

                    <h2>üéØ Metas de la Semana</h2>
                    ${data.weeklyGoals.map(goal => `
                        <p><strong>${goal.category}:</strong> ${goal.text}</p>
                    `).join('')}

                    <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
                </body>
                </html>
            `);

            printWindow.document.close();
            closeExportModal();
        }

        function exportWeekSummary() {
            const data = collectExportData();
            let summary = `üìã RESUMEN SEMANAL - ${currentUser.name}\n`;
            summary += `${'='.repeat(50)}\n\n`;
            summary += `üìÖ Semana ${getWeekNumber(currentDate)} de ${totalWeeks}\n`;
            summary += `üìä Progreso Semanal: ${getWeeklyProgress()}%\n\n`;

            summary += `üéØ METAS DE LA SEMANA\n`;
            summary += `${'-'.repeat(30)}\n`;
            data.weeklyGoals.forEach(goal => {
                summary += `${goal.category}: ${goal.text}\n`;
            });

            summary += `\nüìÖ ACTIVIDADES DEL D√çA\n`;
            summary += `${'-'.repeat(30)}\n`;
            data.todayActivities.forEach(item => {
                summary += `${item.completed ? '‚úÖ' : '‚è≥'} ${item.time} - ${item.activity} (${item.duration})\n`;
            });

            summary += `\n‚úÖ H√ÅBITOS\n`;
            summary += `${'-'.repeat(30)}\n`;
            data.todayHabits.forEach(habit => {
                summary += `${habit.completed ? '‚úÖ' : '‚è≥'} ${habit.icon} ${habit.name}\n`;
            });

            summary += `\nüí™ ¬°Sigue adelante, ${currentUser.name.split(' ')[0]}! üí™\n`;

            downloadFile(summary, `resumen-semana-${getWeekNumber(currentDate)}.txt`, 'text/plain');
            showNotification('üìã Resumen exportado');
            closeExportModal();
        }

        function collectExportData() {
            const dateKey = getDateKey(currentDate);
            const schedule = getSchedule();
            const habits = getHabits();
            const goals = getWeeklyGoals();
            const weekNum = getWeekNumber(currentDate);

            return {
                todayActivities: schedule.map((item, idx) => ({
                    ...item,
                    completed: completedActivities[`${dateKey}-${idx}`] || false
                })),
                todayHabits: habits.map((habit, idx) => ({
                    ...habit,
                    completed: completedHabits[`${dateKey}-${idx}`] || false
                })),
                weeklyGoals: goals.filter(g => g.week === weekNum).map(g => [
                    { category: 'üí™ F√≠sica', text: g.fisica },
                    { category: 'üìö Personal', text: g.personal },
                    { category: 'üì± Digital', text: g.digital },
                    { category: 'üßò Espiritual', text: g.espiritual }
                ]).flat(),
                activities: schedule.map((item, idx) => ({
                    date: dateKey,
                    ...item,
                    completed: completedActivities[`${dateKey}-${idx}`] || false
                })),
                habits: habits.map((habit, idx) => ({
                    date: dateKey,
                    ...habit,
                    completed: completedHabits[`${dateKey}-${idx}`] || false
                }))
            };
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatDateForFile(date) {
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        // Search and Filter Functions
        function toggleSearch() {
            searchVisible = !searchVisible;
            if (!searchVisible) {
                // Clear search when closing
                searchQuery = '';
                activeFilter = '';
            }
            render();
            if (searchVisible) {
                setTimeout(() => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus({ preventScroll: true });
                    }
                }, 100);
            }
        }

        function focusSearchInput() {
            if (!searchVisible) {
                searchVisible = true;
                render();
                setTimeout(() => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus({ preventScroll: true });
                    }
                }, 100);
            } else {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.focus({ preventScroll: true });
                    searchInput.select();
                }
            }
        }

        function filterActivities() {
            const input = document.getElementById('searchInput');
            searchQuery = input ? input.value : '';
            render();
            // Restaurar foco al input despu√©s del render (sin scroll)
            setTimeout(() => {
                const newInput = document.getElementById('searchInput');
                if (newInput) {
                    newInput.focus({ preventScroll: true });
                    newInput.setSelectionRange(newInput.value.length, newInput.value.length);
                }
            }, 0);
        }

        function setFilter(category) {
            activeFilter = category;
            render();
        }

        function clearFilters() {
            searchQuery = '';
            activeFilter = '';
            render();
        }

        // Dashboard Toggle
        function toggleDashboard() {
            dashboardVisible = !dashboardVisible;
            setStorage('dashboard-visible', dashboardVisible.toString());
            render();
        }

        // Share Functions
        function openShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.remove('hidden');

            // Update share preview data
            const dailyProgress = getDailyProgress(currentDate);
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const currentStreak = getStreak();
            const bestStreak = getBestStreak();

            document.getElementById('shareDailyProgress').textContent = dailyProgress + '%';
            document.getElementById('shareWeeklyProgress').textContent = weeklyProgress + '%';
            document.getElementById('shareTotalProgress').textContent = totalProgress + '%';
            document.getElementById('shareStreak').textContent = currentStreak;
            document.getElementById('shareBestStreak').textContent = bestStreak;

            const message = totalProgress === 100 ? 'üèÜ ¬°Complet√© mi programa!' :
                           currentStreak >= 7 ? 'üî• ¬°' + currentStreak + ' d√≠as de racha!' :
                           currentStreak >= 3 ? 'üí™ ¬°Sigo avanzando!' :
                           '‚ú® ¬°Trabajando en mis metas!';
            document.getElementById('shareMessage').textContent = message;
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        function getShareText() {
            const dailyProgress = getDailyProgress(currentDate);
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const currentStreak = getStreak();

            let text = `üéØ Mi progreso en Gesti√≥n del Tiempo\n\n`;
            text += `üìä Hoy: ${dailyProgress}% | Semana: ${weeklyProgress}% | Total: ${totalProgress}%\n`;
            text += `üî• Racha: ${currentStreak} d√≠as\n\n`;

            if (totalProgress === 100) {
                text += `üèÜ ¬°Complet√© mi programa de ${userDuration} d√≠as!\n\n`;
            } else if (currentStreak >= 7) {
                text += `üí™ ¬°${currentStreak} d√≠as seguidos trabajando en mis metas!\n\n`;
            } else {
                text += `‚ú® Cada d√≠a cuenta. ¬°T√∫ tambi√©n puedes!\n\n`;
            }

            text += `#GestionDelTiempo #Productividad #Metas`;
            return text;
        }

        function copyShareText() {
            const text = getShareText();
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã Texto copiado al portapapeles');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('üìã Texto copiado');
            });
        }

        function shareToTwitter() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        function shareToWhatsApp() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareNative() {
            if (navigator.share) {
                navigator.share({
                    title: 'Mi Progreso - Gesti√≥n del Tiempo',
                    text: getShareText()
                }).catch(() => {
                    copyShareText();
                });
            } else {
                copyShareText();
            }
        }

        // Template Functions
        function getTemplates() {
            return JSON.parse(getStorage('day-templates') || '[]');
        }

        function saveTemplates(templates) {
            setStorage('day-templates', JSON.stringify(templates));
        }

        function openTemplateModal() {
            document.getElementById('templateModal').classList.remove('hidden');
            renderCommunityTemplates();
            renderTemplatesList();
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.add('hidden');
        }

        function renderCommunityTemplates() {
            const container = document.getElementById('communityTemplatesList');

            container.innerHTML = communityTemplates.map(template => `
                <div class="bg-gradient-to-r from-amber-50 via-orange-50 to-rose-50 rounded-xl p-4 border-2 border-amber-200 hover:border-amber-300 transition cursor-pointer group">
                    <div class="flex items-start gap-3">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-2xl shadow-lg group-hover:scale-105 transition">
                            ${template.icon}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h5 class="font-bold text-gray-800">${template.name}</h5>
                                <span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">${template.duration} d√≠as</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">por ${template.author}</p>
                            <p class="text-sm text-gray-600 mb-3">${template.description}</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-2 py-1 bg-rose-100 text-rose-600 rounded-lg text-xs">üí™ ${Object.keys(template.gymFocus).length} rutinas gym</span>
                                <span class="px-2 py-1 bg-green-100 text-green-600 rounded-lg text-xs">‚úÖ ${template.habits.length} h√°bitos</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs">ü•ó ${template.meals.length} comidas</span>
                                <span class="px-2 py-1 bg-purple-100 text-purple-600 rounded-lg text-xs">üéØ ${template.weeklyGoals.length} semanas</span>
                            </div>
                            <button onclick="previewUserTemplate('${template.id}')" class="w-full py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg text-sm font-medium hover:opacity-90 transition flex items-center justify-center gap-2">
                                <span>‚ú®</span> Ver y Cargar Plan Completo
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function previewUserTemplate(templateId) {
            const template = communityTemplates.find(t => t.id === templateId);
            if (!template) return;

            const previewHtml = `
                <div class="text-center mb-4">
                    <span class="text-5xl">${template.icon}</span>
                    <h3 class="text-xl font-bold text-gray-800 mt-2">${template.name}</h3>
                    <p class="text-sm text-gray-500">por ${template.author}</p>
                </div>

                <div class="bg-amber-50 rounded-xl p-4 mb-4">
                    <p class="text-sm text-amber-800 font-medium mb-2">‚ö†Ô∏è Esto cargar√°:</p>
                    <ul class="text-sm text-amber-700 space-y-1">
                        <li>‚Ä¢ Rutinas de gimnasio personalizadas</li>
                        <li>‚Ä¢ Lista de ${template.habits.length} h√°bitos diarios</li>
                        <li>‚Ä¢ Plan de ${template.meals.length} comidas</li>
                        <li>‚Ä¢ Metas semanales (${template.weeklyGoals.length} semanas)</li>
                    </ul>
                </div>

                <p class="text-gray-600 text-sm text-center mb-4">
                    Tus datos actuales se mantendr√°n. Los nuevos datos se agregar√°n como tu configuraci√≥n personalizada.
                </p>

                <div class="flex gap-3">
                    <button onclick="closePreviewModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition font-medium">
                        Cancelar
                    </button>
                    <button onclick="applyUserTemplate('${template.id}')" class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl hover:opacity-90 transition font-bold">
                        üöÄ Cargar Plan
                    </button>
                </div>
            `;

            // Create preview modal dynamically
            let previewModal = document.getElementById('previewTemplateModal');
            if (!previewModal) {
                previewModal = document.createElement('div');
                previewModal.id = 'previewTemplateModal';
                previewModal.className = 'fixed inset-0 modal-backdrop z-[60] flex items-center justify-center p-4';
                previewModal.onclick = function(e) { if (e.target === this) closePreviewModal(); };
                document.body.appendChild(previewModal);
            }

            previewModal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
                    ${previewHtml}
                </div>
            `;
            previewModal.classList.remove('hidden');
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewTemplateModal');
            if (modal) modal.classList.add('hidden');
        }

        function applyUserTemplate(templateId) {
            const template = communityTemplates.find(t => t.id === templateId);
            if (!template) return;

            // Show modal asking how to load the template
            const loadModal = document.createElement('div');
            loadModal.id = 'loadTemplateModal';
            loadModal.className = 'fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4';
            loadModal.onclick = (e) => { if (e.target === loadModal) loadModal.remove(); };
            loadModal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6" onclick="event.stopPropagation()">
                    <div class="text-center mb-5">
                        <span class="text-5xl block mb-3">${template.icon}</span>
                        <h3 class="text-lg font-bold text-gray-800">¬øC√≥mo deseas cargar la plantilla?</h3>
                        <p class="text-sm text-gray-500 mt-1">${template.name}</p>
                    </div>

                    <div class="space-y-3">
                        <button onclick="executeLoadTemplate('${templateId}', 'replace')" class="w-full py-3 px-4 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-xl font-semibold hover:opacity-90 transition flex items-center justify-center gap-2">
                            <span>üîÑ</span> Reemplazar todo
                            <span class="text-xs opacity-80">(borra lo actual)</span>
                        </button>

                        <button onclick="executeLoadTemplate('${templateId}', 'merge')" class="w-full py-3 px-4 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-semibold hover:opacity-90 transition flex items-center justify-center gap-2">
                            <span>‚ûï</span> Agregar a lo existente
                            <span class="text-xs opacity-80">(mantiene lo actual)</span>
                        </button>

                        <button onclick="this.closest('.fixed').remove()" class="w-full py-3 px-4 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200 transition">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(loadModal);
        }

        function executeLoadTemplate(templateId, mode) {
            const template = communityTemplates.find(t => t.id === templateId);
            if (!template) return;

            // Close the load mode modal
            const loadModal = document.getElementById('loadTemplateModal');
            if (loadModal) loadModal.remove();

            if (mode === 'replace') {
                // REPLACE MODE: Clear everything and load template

                // Clear existing data
                customGym = {};
                customHabits = null;
                customMeals = null;
                customGoals = null;
                customSchedules = {};
                completedActivities = {};
                checkedHabits = {};

                // Apply gym routines
                for (const [day, routine] of Object.entries(template.gymFocus)) {
                    customGym[parseInt(day)] = { ...routine };
                }
                setStorage('custom-gym', JSON.stringify(customGym));

                // Apply habits
                customHabits = [...template.habits];
                setStorage('custom-habits', JSON.stringify(customHabits));

                // Apply meals
                customMeals = [...template.meals];
                setStorage('custom-meals', JSON.stringify(customMeals));

                // Apply weekly goals
                customGoals = [...template.weeklyGoals];
                setStorage('custom-goals', JSON.stringify(customGoals));

                // Clear progress
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                setStorage('activities', JSON.stringify(completedActivities));
                setStorage('habits', JSON.stringify(checkedHabits));

            } else {
                // MERGE MODE: Add template data to existing

                // Merge gym routines (template overwrites conflicts)
                for (const [day, routine] of Object.entries(template.gymFocus)) {
                    customGym[parseInt(day)] = { ...routine };
                }
                setStorage('custom-gym', JSON.stringify(customGym));

                // Merge habits (add new ones, avoid duplicates by name)
                const existingHabits = customHabits || getDefaultHabits();
                const existingHabitNames = existingHabits.map(h => h.name.toLowerCase());
                const newHabits = template.habits.filter(h => !existingHabitNames.includes(h.name.toLowerCase()));

                // Re-assign IDs to avoid conflicts
                let maxId = Math.max(...existingHabits.map(h => h.id), 0);
                newHabits.forEach(h => {
                    h.id = ++maxId;
                });

                customHabits = [...existingHabits, ...newHabits];
                setStorage('custom-habits', JSON.stringify(customHabits));

                // Merge meals (add new meal times, avoid duplicates by time)
                const existingMeals = customMeals || getDefaultMeals();
                const existingMealTimes = existingMeals.map(m => m.time);
                const newMeals = template.meals.filter(m => !existingMealTimes.includes(m.time));

                customMeals = [...existingMeals, ...newMeals].sort((a, b) => a.time.localeCompare(b.time));
                setStorage('custom-meals', JSON.stringify(customMeals));

                // Goals: keep existing or use template if none
                if (!customGoals) {
                    customGoals = [...template.weeklyGoals];
                    setStorage('custom-goals', JSON.stringify(customGoals));
                }
            }

            // Apply custom schedules from template (if they exist)
            if (template.weekdaySchedule || template.weekendSchedule) {
                // Store template schedules in a special key
                const templateSchedules = {
                    weekday: template.weekdaySchedule || null,
                    weekend: template.weekendSchedule || null,
                    templateId: template.id
                };
                setStorage('active-template-schedules', JSON.stringify(templateSchedules));
            }

            // Close modals
            closePreviewModal();
            closeTemplateModal();

            // Show success notification with confetti
            createCelebration();
            const modeText = mode === 'replace' ? 'reemplazado todo' : 'agregado';
            showNotification(`‚ú® ¬°Plan "${template.name}" ${modeText} exitosamente!`);

            render();
        }

        function saveTemplate() {
            const nameInput = document.getElementById('templateName');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Por favor ingresa un nombre para la plantilla');
                return;
            }

            const schedule = getSchedule();
            const templates = getTemplates();

            templates.push({
                id: Date.now(),
                name: name,
                activities: schedule,
                createdAt: new Date().toISOString()
            });

            saveTemplates(templates);
            nameInput.value = '';
            showNotification('üìã Plantilla guardada');
            renderTemplatesList();
        }

        function renderTemplatesList() {
            const container = document.getElementById('templatesList');
            const templates = getTemplates();

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-400">
                        <span class="text-4xl block mb-2">üìÅ</span>
                        <p>No hay plantillas guardadas</p>
                        <p class="text-sm">Guarda el d√≠a actual para crear una</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = templates.map(template => `
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <p class="font-medium text-gray-800">${template.name}</p>
                            <p class="text-xs text-gray-400">${template.activities.length} actividades</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="applyTemplate(${template.id})" class="px-3 py-1 bg-purple-100 text-purple-600 rounded-lg text-sm font-medium hover:bg-purple-200 transition">
                                Aplicar
                            </button>
                            <button onclick="deleteTemplate(${template.id})" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-medium hover:bg-red-200 transition">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 space-y-1 max-h-24 overflow-y-auto">
                        ${template.activities.slice(0, 4).map(a => `<p>‚Ä¢ ${a.time} - ${a.activity}</p>`).join('')}
                        ${template.activities.length > 4 ? `<p class="text-gray-400">+${template.activities.length - 4} m√°s...</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function applyTemplate(templateId) {
            const templates = getTemplates();
            const template = templates.find(t => t.id === templateId);

            if (!template) return;

            if (confirm(`¬øAplicar la plantilla "${template.name}" al d√≠a actual? Esto reemplazar√° las actividades existentes.`)) {
                const dateKey = getDateKey(currentDate);
                customSchedules[dateKey] = [...template.activities];
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                showNotification('üìã Plantilla aplicada');
                closeTemplateModal();
                render();
            }
        }

        function deleteTemplate(templateId) {
            if (confirm('¬øEliminar esta plantilla?')) {
                let templates = getTemplates();
                templates = templates.filter(t => t.id !== templateId);
                saveTemplates(templates);
                showNotification('üóëÔ∏è Plantilla eliminada');
                renderTemplatesList();
            }
        }

        // Clean Section Functions
        let cleanSection = '';

        function openCleanModal(section) {
            cleanSection = section;
            const modal = document.getElementById('cleanModal');
            const description = document.getElementById('cleanModalDescription');
            const options = document.getElementById('cleanOptions');

            const sectionNames = {
                agenda: 'Agenda',
                habits: 'H√°bitos',
                gym: 'Gimnasio',
                meals: 'Nutrici√≥n',
                goals: 'Metas'
            };

            description.textContent = `Opciones de limpieza para ${sectionNames[section] || section}`;

            let optionsHtml = '';

            if (section === 'agenda') {
                optionsHtml = `
                    <button onclick="cleanDayProgress()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">‚úÖ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Limpiar progreso del d√≠a</p>
                            <p class="text-sm text-gray-500">Desmarcar todas las actividades completadas</p>
                        </div>
                    </button>
                    <button onclick="clearDayActivities()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">üßπ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Vaciar actividades del d√≠a</p>
                            <p class="text-sm text-gray-500">Eliminar TODAS las actividades de hoy (dejar vac√≠o)</p>
                        </div>
                    </button>
                    <button onclick="cleanDayActivities()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 hover:bg-blue-50 transition">
                        <span class="text-2xl">üîÑ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Restaurar actividades por defecto</p>
                            <p class="text-sm text-gray-500">Volver al horario predeterminado del d√≠a</p>
                        </div>
                    </button>
                    <button onclick="cleanAllProgress()" class="w-full flex items-center gap-3 p-4 border-2 border-red-100 rounded-xl hover:border-red-400 hover:bg-red-50 transition">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <div class="text-left">
                            <p class="font-medium text-red-600">Limpiar TODO el progreso</p>
                            <p class="text-sm text-gray-500">Eliminar todas las actividades completadas de todos los d√≠as</p>
                        </div>
                    </button>
                `;
            } else if (section === 'habits') {
                optionsHtml = `
                    <button onclick="cleanDayHabits()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">‚úÖ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Limpiar h√°bitos del d√≠a</p>
                            <p class="text-sm text-gray-500">Desmarcar todos los h√°bitos completados hoy</p>
                        </div>
                    </button>
                    <button onclick="cleanAllHabits()" class="w-full flex items-center gap-3 p-4 border-2 border-red-100 rounded-xl hover:border-red-400 hover:bg-red-50 transition">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <div class="text-left">
                            <p class="font-medium text-red-600">Limpiar TODOS los h√°bitos</p>
                            <p class="text-sm text-gray-500">Eliminar todo el progreso de h√°bitos de todos los d√≠as</p>
                        </div>
                    </button>
                `;
            } else if (section === 'gym') {
                optionsHtml = `
                    <button onclick="cleanDayGym()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">‚úÖ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Limpiar ejercicios del d√≠a</p>
                            <p class="text-sm text-gray-500">Desmarcar todos los ejercicios completados</p>
                        </div>
                    </button>
                    <button onclick="cleanCustomGym()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-red-300 hover:bg-red-50 transition">
                        <span class="text-2xl">üîÑ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Restaurar rutina por defecto</p>
                            <p class="text-sm text-gray-500">Eliminar ejercicios personalizados del d√≠a</p>
                        </div>
                    </button>
                `;
            }

            options.innerHTML = optionsHtml;
            modal.classList.remove('hidden');
        }

        function closeCleanModal() {
            document.getElementById('cleanModal').classList.add('hidden');
            cleanSection = '';
        }

        // ==================== RESET FUNCTIONS ====================
        function openResetModal() {
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
        }

        function resetProgress() {
            const confirmMsg = getLang() === 'en'
                ? 'Clear ALL completed progress? (activities, habits, exercises)'
                : '¬øLimpiar TODO el progreso completado? (actividades, h√°bitos, ejercicios)';

            if (confirm(confirmMsg)) {
                // Clear all completed activities
                setStorage('activities', '{}');
                completedActivities = {};

                // Clear all habit completions (correct key is 'habits')
                setStorage('habits', '{}');
                checkedHabits = {};

                // Clear congrats shown tracking
                setStorage('congrats-shown', '{}');

                closeResetModal();
                addNotification(getLang() === 'en' ? 'All progress cleared' : 'Todo el progreso limpiado', 'üßπ');
                render();
            }
        }

        function resetToDefaults() {
            const confirmMsg = getLang() === 'en'
                ? 'Restore default settings? Custom schedules, habits, meals, and goals will be deleted. Progress will be kept.'
                : '¬øRestaurar valores por defecto? Se eliminar√°n horarios, h√°bitos, comidas y metas personalizadas. El progreso se mantendr√°.';

            if (confirm(confirmMsg)) {
                // Clear custom schedules
                removeStorage('custom-schedules');

                // Clear custom habits
                removeStorage('custom-habits');

                // Clear custom gym routines
                removeStorage('custom-gym');

                // Clear custom meals
                removeStorage('custom-meals');

                // Clear custom goals
                removeStorage('custom-goals');

                // Clear tab orders
                removeStorage('tabs-order-main');
                removeStorage('tabs-order-gym');
                removeStorage('tabs-order-nutrition');

                // Clear active template schedules
                removeStorage('active-template-schedules');

                // Clear day templates
                removeStorage('day-templates');

                // Reload to reset all in-memory variables
                alert(getLang() === 'en' ? 'üîÑ Default settings restored. Page will reload.' : 'üîÑ Valores por defecto restaurados. La p√°gina se recargar√°.');
                window.location.reload();
            }
        }

        function resetKeepProfile() {
            const confirmMsg = getLang() === 'en'
                ? '‚ö†Ô∏è START OVER?\n\nThis will DELETE everything except your profile:\n- All progress\n- All customizations\n- All habits and meals\n- All goals and notes\n\nYour profile data will be kept.\n\nAre you sure?'
                : '‚ö†Ô∏è ¬øEMPEZAR DE NUEVO?\n\nEsto ELIMINAR√Å todo excepto tu perfil:\n- Todo el progreso\n- Todas las personalizaciones\n- Todos los h√°bitos y comidas\n- Todas las metas y notas\n\nTus datos de perfil se mantendr√°n.\n\n¬øEst√°s seguro?';

            if (confirm(confirmMsg)) {
                // Set empty values to override defaults (not just delete keys)
                // Progress
                setStorage('activities', '{}');
                setStorage('habits', '{}');
                setStorage('congrats-shown', '{}');

                // Custom data - use __cleared__ marker so defaults don't show
                setStorage('custom-schedules', '{"__cleared__": true}');
                setStorage('custom-habits', '[]');
                setStorage('custom-gym', '{"__cleared__": true}');
                setStorage('custom-meals', '[]');
                setStorage('custom-goals', '[]');

                // Other data
                removeStorage('day-templates');
                removeStorage('active-template-schedules');
                removeStorage('tabs-order-main');
                removeStorage('tabs-order-gym');
                removeStorage('tabs-order-nutrition');
                removeStorage('weight-history');
                removeStorage('workout-logs');
                removeStorage('physical-profile');
                removeStorage('macros-profile');
                removeStorage('protein-logs');
                removeStorage('protein-config');
                removeStorage('protein-favorites');
                removeStorage('expenses');
                removeStorage('notifications');
                removeStorage('dark-mode');
                removeStorage('floating-buttons');
                removeStorage('dashboard-visible');
                removeStorage('reminder-settings');
                removeStorage('lastReminderDay');

                // Reload page to reset all in-memory variables
                alert(getLang() === 'en' ? 'üîÉ Fresh start! Profile kept. Page will reload.' : 'üîÉ ¬°Nuevo comienzo! Perfil mantenido. La p√°gina se recargar√°.');
                window.location.reload();
            }
        }

        function resetTotal() {
            const confirmMsg = getLang() === 'en'
                ? 'üí• TOTAL RESET?\n\nThis will DELETE ABSOLUTELY EVERYTHING:\n- All your data\n- Your profile\n- All progress\n- Everything!\n\nYou will start completely from zero.\n\nTHIS CANNOT BE UNDONE!\n\nType "RESET" to confirm:'
                : 'üí• ¬øREINICIO TOTAL?\n\nEsto ELIMINAR√Å ABSOLUTAMENTE TODO:\n- Todos tus datos\n- Tu perfil\n- Todo el progreso\n- ¬°Todo!\n\nEmpezar√°s completamente desde cero.\n\n¬°ESTO NO SE PUEDE DESHACER!\n\nEscribe "RESET" para confirmar:';

            const userInput = prompt(confirmMsg);

            if (userInput && userInput.toUpperCase() === 'RESET') {
                // Get all keys for this user
                const keysToDelete = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(userKey + '-')) {
                        keysToDelete.push(key);
                    }
                }

                // Delete all user data
                keysToDelete.forEach(key => localStorage.removeItem(key));

                // Also clear the current user session (log out)
                localStorage.removeItem('gestion-currentUser');

                closeResetModal();

                // Show notification and redirect to login
                alert(getLang() === 'en' ? '‚úÖ Total reset complete. You will be redirected to login.' : '‚úÖ Reinicio total completado. Ser√°s redirigido al login.');
                window.location.href = 'login.html';
            }
        }
        // ==================== END RESET FUNCTIONS ====================

        function cleanDayProgress() {
            if (confirm('¬øDesmarcar todas las actividades completadas de hoy?')) {
                const dateKey = getDateKey(currentDate);
                const schedule = getSchedule();

                schedule.forEach((_, idx) => {
                    delete completedActivities[`${dateKey}-${idx}`];
                });

                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('‚úÖ Progreso del d√≠a limpiado');
                closeCleanModal();
                render();
            }
        }

        function clearDayActivities() {
            if (confirm('¬øVaciar TODAS las actividades de hoy? El d√≠a quedar√° sin actividades.')) {
                const dateKey = getDateKey(currentDate);
                // Set empty array as custom schedule for this day
                customSchedules[dateKey] = [];
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                // Also clear completed activities for this day
                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(dateKey)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('üßπ Actividades del d√≠a eliminadas');
                closeCleanModal();
                render();
            }
        }

        function cleanDayActivities() {
            if (confirm('¬øRestaurar las actividades del d√≠a a las predeterminadas?')) {
                const dateKey = getDateKey(currentDate);
                delete customSchedules[dateKey];
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                showNotification('üîÑ Actividades restauradas');
                closeCleanModal();
                render();
            }
        }

        function cleanAllProgress() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODO el progreso de actividades de TODOS los d√≠as. Esta acci√≥n no se puede deshacer.')) {
                completedActivities = {};
                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('üóëÔ∏è Todo el progreso ha sido eliminado');
                closeCleanModal();
                render();
            }
        }

        function cleanDayHabits() {
            if (confirm('¬øDesmarcar todos los h√°bitos completados de hoy?')) {
                const dateKey = getDateKey(currentDate);
                const habits = getHabits();

                habits.forEach((habit, idx) => {
                    delete checkedHabits[`${dateKey}-${habit.id}`];
                    delete checkedHabits[`${dateKey}-${idx}`];
                });

                setStorage('habits', JSON.stringify(checkedHabits));
                showNotification('‚úÖ H√°bitos del d√≠a limpiados');
                closeCleanModal();
                render();
            }
        }

        function cleanAllHabits() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODO el progreso de h√°bitos de TODOS los d√≠as.')) {
                checkedHabits = {};
                setStorage('habits', JSON.stringify(checkedHabits));
                showNotification('üóëÔ∏è Todo el progreso de h√°bitos eliminado');
                closeCleanModal();
                render();
            }
        }

        function cleanDayGym() {
            if (confirm('¬øDesmarcar todos los ejercicios completados de hoy?')) {
                const dateKey = getDateKey(currentDate);
                // Clean gym exercises for the day
                const prefix = `${dateKey}-gym-`;
                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(prefix)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('‚úÖ Ejercicios del d√≠a limpiados');
                closeCleanModal();
                render();
            }
        }

        function cleanCustomGym() {
            if (confirm('¬øRestaurar la rutina de gimnasio por defecto?')) {
                const dayIndex = currentDate.getDay();
                delete customGym[dayIndex];
                setStorage('custom-gym', JSON.stringify(customGym));
                showNotification('üîÑ Rutina restaurada');
                closeCleanModal();
                render();
            }
        }

        // Statistics Functions
        function getWeeklyProgressData() {
            const data = [];
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const inRange = date >= startDate && date <= endDate;
                data.push({
                    day: daysSpanish[i].substring(0, 3),
                    progress: inRange ? getDailyProgress(date) : 0,
                    isToday: date.toDateString() === currentDate.toDateString(),
                    inRange: inRange
                });
            }
            return data;
        }

        function getCategoryDistribution() {
            const schedule = getSchedule();
            const distribution = {};

            if (!schedule || schedule.length === 0) {
                return [];
            }

            schedule.forEach(item => {
                const cat = item.category || 'personal';
                distribution[cat] = (distribution[cat] || 0) + 1;
            });

            return Object.entries(distribution).map(([category, count]) => ({
                category,
                count,
                percentage: Math.round((count / schedule.length) * 100)
            }));
        }

        function getHistoricalData() {
            const data = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                if (date >= startDate) {
                    data.push({
                        date: date,
                        label: `${date.getDate()}/${date.getMonth() + 1}`,
                        progress: getDailyProgress(date)
                    });
                }
            }
            return data;
        }

        function getCompletionStats() {
            let totalDays = 0;
            let completedDays = 0;
            let totalTasks = 0;
            let completedTasks = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const checkDate = new Date(startDate);
            while (checkDate <= today && checkDate <= endDate) {
                totalDays++;
                const progress = getDailyProgress(checkDate);
                if (progress === 100) completedDays++;

                const dateKey = getDateKey(checkDate);
                const schedule = getScheduleForDate(checkDate);
                totalTasks += schedule.length;
                completedTasks += schedule.filter((_, idx) => completedActivities[`${dateKey}-${idx}`]).length;

                checkDate.setDate(checkDate.getDate() + 1);
            }

            return {
                totalDays,
                completedDays,
                completionRate: totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0,
                totalTasks,
                completedTasks,
                taskRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
            };
        }

        function getScheduleForDate(date) {
            const dateKey = getDateKey(date);
            // Check if schedules have been cleared by reset
            if (customSchedules.__cleared__) {
                return customSchedules[dateKey] || [];
            }
            if (customSchedules[dateKey]) {
                return customSchedules[dateKey];
            }
            return getDefaultSchedule(date.getDay());
        }

        // ==================== EXPENSES MODULE ====================

        let cameraStream = null;
        let currentReceiptImage = null;

        function getExpenses() {
            const expenses = JSON.parse(getStorage('expenses') || '[]');

            // Auto-repair expenses with invalid dates
            let needsSave = false;
            expenses.forEach(e => {
                if (!e.date || isNaN(new Date(e.date).getTime())) {
                    // Try to get date from createdAt
                    if (e.createdAt) {
                        const created = new Date(e.createdAt);
                        if (!isNaN(created.getTime())) {
                            e.date = created.toISOString().split('T')[0];
                            needsSave = true;
                        }
                    }
                    // If still no valid date, use today
                    if (!e.date || isNaN(new Date(e.date).getTime())) {
                        e.date = new Date().toISOString().split('T')[0];
                        needsSave = true;
                    }
                }
                // Ensure expense has an id
                if (!e.id) {
                    e.id = Date.now() + Math.random();
                    needsSave = true;
                }
            });

            if (needsSave) {
                setStorage('expenses', JSON.stringify(expenses));
            }

            return expenses;
        }

        // Async version that loads from Supabase first
        async function getExpensesAsync() {
            if (typeof syncService !== 'undefined' && syncService.userId) {
                try {
                    const expenses = await syncService.getExpenses();
                    return expenses;
                } catch (error) {
                    console.error('Error loading expenses from Supabase:', error);
                }
            }
            return getExpenses();
        }

        // Load expenses from Supabase on app init
        async function loadExpensesFromServer() {
            if (typeof syncService !== 'undefined' && syncService.userId) {
                try {
                    // First try to get expenses from expenses table
                    const expensesFromTable = await syncService.getExpenses();
                    console.log('Expenses from expenses table:', expensesFromTable.length);

                    // Also check user_data for expenses (backup source)
                    const userData = await syncService.getUserData('expenses', 'expenses');
                    if (userData && userData.length > 0 && userData[0].data_value) {
                        const expensesFromUserData = userData[0].data_value;
                        if (Array.isArray(expensesFromUserData) && expensesFromUserData.length > 0) {
                            console.log('Expenses from user_data:', expensesFromUserData.length);

                            // Merge: combine both sources, avoid duplicates by ID
                            const existingIds = new Set(expensesFromTable.map(e => String(e.id)));
                            const newFromUserData = expensesFromUserData.filter(e => !existingIds.has(String(e.id)));

                            if (newFromUserData.length > 0) {
                                const merged = [...expensesFromTable, ...newFromUserData];
                                // Save merged to localStorage
                                setStorage('expenses', JSON.stringify(merged));
                                console.log('Merged expenses total:', merged.length);
                            }
                        }
                    }

                    // Trigger re-render if we're on the expenses tab
                    if (currentTab === 'gastos') {
                        render();
                    }
                } catch (error) {
                    console.error('Error loading expenses from server:', error);
                }
            }
        }

        function saveExpenses(expenses) {
            setStorage('expenses', JSON.stringify(expenses));
        }

        // ==================== CATEGORY MANAGEMENT ====================

        // Default categories for all modules
        function getDefaultCategories() {
            return {
                expenses: [
                    { id: 'alimentacion', name: 'Alimentaci√≥n', emoji: 'üçî' },
                    { id: 'transporte', name: 'Transporte', emoji: 'üöó' },
                    { id: 'salud', name: 'Salud', emoji: 'üíä' },
                    { id: 'entretenimiento', name: 'Entretenimiento', emoji: 'üé¨' },
                    { id: 'ropa', name: 'Ropa', emoji: 'üëï' },
                    { id: 'servicios', name: 'Servicios', emoji: 'üì±' },
                    { id: 'hogar', name: 'Hogar', emoji: 'üè†' },
                    { id: 'educacion', name: 'Educaci√≥n', emoji: 'üìö' },
                    { id: 'otro', name: 'Otro', emoji: 'üì¶' }
                ],
                activities: [
                    { id: 'habitos', name: 'H√°bitos', emoji: '‚òÄÔ∏è' },
                    { id: 'nutricion', name: 'Nutrici√≥n', emoji: 'ü•ó' },
                    { id: 'fisico', name: 'F√≠sico', emoji: 'üí™' },
                    { id: 'personal', name: 'Personal', emoji: 'üìö' },
                    { id: 'digital', name: 'Digital', emoji: 'üì±' },
                    { id: 'espiritual', name: 'Espiritual', emoji: 'üßò' },
                    { id: 'descanso', name: 'Descanso', emoji: 'üò¥' }
                ]
            };
        }

        function getCategories(type = 'expenses') {
            const stored = JSON.parse(getStorage('app-categories') || '{}');
            return stored[type] || getDefaultCategories()[type] || [];
        }

        function saveCategories(type, categories) {
            const stored = JSON.parse(getStorage('app-categories') || '{}');
            stored[type] = categories;
            setStorage('app-categories', JSON.stringify(stored));
        }

        function addCategory(type, name, emoji) {
            const categories = getCategories(type);
            const id = name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '_');
            if (!categories.find(c => c.id === id)) {
                categories.push({ id, name, emoji });
                saveCategories(type, categories);
            }
            return id;
        }

        function deleteCategory(type, categoryId) {
            let categories = getCategories(type);
            categories = categories.filter(c => c.id !== categoryId);
            saveCategories(type, categories);
        }

        function updateCategory(type, categoryId, name, emoji) {
            const categories = getCategories(type);
            const cat = categories.find(c => c.id === categoryId);
            if (cat) {
                cat.name = name;
                cat.emoji = emoji;
                saveCategories(type, categories);
            }
        }

        function populateCategorySelect(selectId, type = 'expenses') {
            const select = document.getElementById(selectId);
            if (!select) return;
            const categories = getCategories(type);
            select.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`
            ).join('');
        }

        // Category Modal Functions
        let currentCategoryTab = 'expenses';

        function openCategoriesModal() {
            document.getElementById('categoriesModal').classList.remove('hidden');
            currentCategoryTab = 'expenses';
            updateCategoryTabUI();
            renderCategoriesList();
        }

        function closeCategoriesModal() {
            document.getElementById('categoriesModal').classList.add('hidden');
        }

        function setCategoryTab(tab) {
            currentCategoryTab = tab;
            updateCategoryTabUI();
            renderCategoriesList();
        }

        function updateCategoryTabUI() {
            const expensesTab = document.getElementById('catTabExpenses');
            const activitiesTab = document.getElementById('catTabActivities');

            if (currentCategoryTab === 'expenses') {
                expensesTab.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition bg-white shadow text-purple-600';
                activitiesTab.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition text-gray-500';
            } else {
                expensesTab.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition text-gray-500';
                activitiesTab.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition bg-white shadow text-purple-600';
            }
        }

        function renderCategoriesList() {
            const categories = getCategories(currentCategoryTab);
            const container = document.getElementById('categoriesList');

            container.innerHTML = categories.map(cat => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl group">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${cat.emoji}</span>
                        <span class="font-medium text-gray-700">${cat.name}</span>
                    </div>
                    <button onclick="deleteCategoryItem('${cat.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition p-1" title="Eliminar">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function addNewCategory() {
            const emoji = document.getElementById('newCategoryEmoji').value.trim() || 'üìå';
            const name = document.getElementById('newCategoryName').value.trim();

            if (!name) {
                alert('Por favor ingresa un nombre para la categor√≠a');
                return;
            }

            addCategory(currentCategoryTab, name, emoji);
            document.getElementById('newCategoryEmoji').value = '';
            document.getElementById('newCategoryName').value = '';
            renderCategoriesList();
        }

        function deleteCategoryItem(categoryId) {
            if (confirm('¬øEliminar esta categor√≠a?')) {
                deleteCategory(currentCategoryTab, categoryId);
                renderCategoriesList();
            }
        }

        function resetCategoriesToDefault() {
            if (confirm('¬øRestaurar las categor√≠as a los valores por defecto? Se perder√°n las personalizadas.')) {
                const defaults = getDefaultCategories();
                saveCategories(currentCategoryTab, defaults[currentCategoryTab]);
                renderCategoriesList();
            }
        }

        // ==================== END CATEGORY MANAGEMENT ====================

        function getExpenseCategoryIcon(category) {
            const categories = getCategories('expenses');
            const cat = categories.find(c => c.id === category);
            return cat ? cat.emoji : 'üì¶';
        }

        function getExpenseCategoryName(category) {
            const categories = getCategories('expenses');
            const cat = categories.find(c => c.id === category);
            return cat ? cat.name : 'Otro';
        }

        function renderGastos() {
            const expenses = getExpenses();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // Filter expenses for current month
            const monthlyExpenses = expenses.filter(e => {
                // Try to get a valid date from the expense
                let d = null;

                // First try the date field
                if (e.date) {
                    d = new Date(e.date);
                }

                // If invalid, try createdAt
                if (!d || isNaN(d.getTime())) {
                    if (e.createdAt) {
                        d = new Date(e.createdAt);
                    }
                }

                // If still invalid, skip this expense
                if (!d || isNaN(d.getTime())) {
                    console.log('Expense with invalid date:', e);
                    return false;
                }

                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const totalMonth = monthlyExpenses.reduce((sum, e) => sum + parseFloat(e.total || 0), 0);

            // Group by category
            const byCategory = {};
            monthlyExpenses.forEach(e => {
                if (!byCategory[e.category]) byCategory[e.category] = 0;
                byCategory[e.category] += parseFloat(e.total || 0);
            });

            // Get recent expenses (last 10) - store globally for event handlers
            const recentExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            window.currentRecentExpenses = recentExpenses;

            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            return `
                <div class="space-y-4">
                    <!-- Header & Actions -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">üí∞ Control de Gastos</h3>
                            <div class="flex gap-2">
                                <button onclick="openScanReceiptModal()" class="px-4 py-2 theme-btn rounded-xl font-medium hover:opacity-90 transition flex items-center gap-2 text-sm">
                                    üì∏ Escanear Boleta
                                </button>
                                <button onclick="openAddExpenseModal()" class="px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition flex items-center gap-2 text-sm">
                                    ‚úèÔ∏è Manual
                                </button>
                            </div>
                        </div>

                        <!-- Monthly Summary -->
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-4 text-white">
                            <p class="text-sm opacity-90">${monthNames[currentMonth]} ${currentYear}</p>
                            <p class="text-3xl font-bold mt-1">$${totalMonth.toLocaleString('es-CL', {minimumFractionDigits: 0})}</p>
                            <p class="text-sm opacity-90 mt-1">${monthlyExpenses.length} gastos registrados</p>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    ${Object.keys(byCategory).length > 0 ? `
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <h4 class="font-bold text-gray-800 mb-3">üìä Por Categor√≠a</h4>
                            <div class="space-y-2">
                                ${Object.entries(byCategory)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([cat, amount]) => {
                                        const percentage = totalMonth > 0 ? (amount / totalMonth * 100) : 0;
                                        return `
                                            <div class="flex items-center gap-3">
                                                <span class="text-xl">${getExpenseCategoryIcon(cat)}</span>
                                                <div class="flex-1">
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span class="text-gray-700">${getExpenseCategoryName(cat)}</span>
                                                        <span class="font-medium text-gray-800">$${amount.toLocaleString('es-CL', {minimumFractionDigits: 0})}</span>
                                                    </div>
                                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: ${percentage}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Recent Expenses -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">üìã √öltimos Gastos</h4>
                        ${recentExpenses.length === 0 ? `
                            <div class="text-center py-8 text-gray-400">
                                <span class="text-4xl block mb-2">üßæ</span>
                                <p>No hay gastos registrados</p>
                                <p class="text-sm mt-1">Escanea una boleta para comenzar</p>
                            </div>
                        ` : `
                            <div class="space-y-2">
                                ${recentExpenses.map((expense, idx) => `
                                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                        <span class="text-2xl">${getExpenseCategoryIcon(expense.category)}</span>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-medium text-gray-800 truncate">${expense.store || 'Sin nombre'}</p>
                                            <p class="text-xs text-gray-500">${new Date(expense.date).toLocaleDateString('es-CL', {day: 'numeric', month: 'short'})}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-gray-800">$${parseFloat(expense.total).toLocaleString('es-CL', {minimumFractionDigits: 0})}</p>
                                        </div>
                                        <button onclick="openEditExpenseModal(${idx})" class="p-2 text-gray-400 hover:text-blue-500 transition" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="deleteExpense(${idx})" class="p-2 text-gray-400 hover:text-red-500 transition" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Modal functions
        function openScanReceiptModal() {
            document.getElementById('scanReceiptModal').classList.remove('hidden');
            resetScanModal();
        }

        function closeScanReceiptModal() {
            document.getElementById('scanReceiptModal').classList.add('hidden');
            stopCamera();
            resetScanModal();
        }

        function resetScanModal() {
            document.getElementById('scanStep1').classList.remove('hidden');
            document.getElementById('scanStep2').classList.add('hidden');
            document.getElementById('scanStep3').classList.add('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            currentReceiptImage = null;
            stopCamera();
        }

        function openAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.remove('hidden');
            document.getElementById('manualExpenseDate').value = getTodayKey();
            document.getElementById('manualExpenseStore').value = '';
            document.getElementById('manualExpenseTotal').value = '';
            document.getElementById('manualExpenseDescription').value = '';
            populateCategorySelect('manualExpenseCategory', 'expenses');
        }

        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.add('hidden');
        }

        // Camera functions
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                cameraStream = stream;
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                document.getElementById('cameraContainer').classList.remove('hidden');
            } catch (err) {
                alert('No se pudo acceder a la c√°mara. Por favor, permite el acceso o sube una imagen.');
                console.error('Camera error:', err);
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            const video = document.getElementById('cameraPreview');
            if (video) video.srcObject = null;
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            currentReceiptImage = canvas.toDataURL('image/jpeg', 0.8);

            document.getElementById('receiptImagePreview').src = currentReceiptImage;
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            stopCamera();
        }

        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentReceiptImage = e.target.result;
                document.getElementById('receiptImagePreview').src = currentReceiptImage;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearReceiptImage() {
            currentReceiptImage = null;
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('receiptImagePreview').src = '';
        }

        // OCR Processing - Usando m√≥dulo mejorado para boletas chilenas
        async function processReceiptImage() {
            if (!currentReceiptImage) return;

            // Show processing step
            document.getElementById('scanStep1').classList.add('hidden');
            document.getElementById('scanStep2').classList.remove('hidden');

            try {
                const progressEl = document.getElementById('ocrProgress');

                // Importar m√≥dulo OCR mejorado
                const { processReceipt } = await import('./src/js/services/ocr.js');

                // Procesar con el nuevo m√≥dulo optimizado para Chile
                const result = await processReceipt(currentReceiptImage, (progress) => {
                    progressEl.textContent = progress.status;
                });

                console.log('OCR Result:', result);

                // Fill the form with parsed data
                document.getElementById('expenseStore').value = result.store || '';
                document.getElementById('expenseDate').value = result.date || getTodayKey();
                document.getElementById('expenseTotal').value = result.total || '';
                document.getElementById('expenseDescription').value = result.description || '';

                // Mostrar items extra√≠dos usando DOM seguro
                const itemsContainer = document.getElementById('extractedItemsContainer');
                const itemsList = document.getElementById('extractedItems');

                if (result.items && result.items.length > 0) {
                    itemsContainer.classList.remove('hidden');
                    itemsList.textContent = ''; // Limpiar contenido previo

                    result.items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'py-1 flex justify-between';

                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = item.name;

                        const priceSpan = document.createElement('span');
                        priceSpan.className = 'text-gray-500';
                        priceSpan.textContent = item.priceFormatted;

                        itemDiv.appendChild(nameSpan);
                        itemDiv.appendChild(priceSpan);
                        itemsList.appendChild(itemDiv);
                    });
                } else {
                    itemsContainer.classList.add('hidden');
                }

                // Show results form
                document.getElementById('scanStep2').classList.add('hidden');
                document.getElementById('scanStep3').classList.remove('hidden');
                populateCategorySelect('expenseCategory', 'expenses');

                // Pre-seleccionar categor√≠a sugerida
                if (result.suggestedCategory) {
                    const categorySelect = document.getElementById('expenseCategory');
                    const categoryMap = {
                        'alimentacion': 'üçî Alimentaci√≥n',
                        'transporte': 'üöó Transporte',
                        'salud': 'üíä Salud',
                        'entretenimiento': 'üé¨ Entretenimiento',
                        'ropa': 'üëï Ropa',
                        'servicios': 'üì± Servicios',
                        'hogar': 'üè† Hogar',
                        'educacion': 'üìö Educaci√≥n',
                        'otro': 'üì¶ Otro'
                    };
                    const categoryValue = categoryMap[result.suggestedCategory];
                    if (categoryValue) {
                        for (let option of categorySelect.options) {
                            if (option.value === categoryValue || option.text === categoryValue) {
                                option.selected = true;
                                break;
                            }
                        }
                    }
                }

                // Mostrar confianza del OCR
                if (result.confidence) {
                    console.log(`[OCR] Confianza: ${result.confidence.toFixed(1)}%`);
                }

            } catch (error) {
                console.error('OCR Error:', error);
                alert('Error al procesar la imagen. Por favor, intenta de nuevo o ingresa los datos manualmente.');
                resetScanModal();
            }
        }

        function parseReceiptText(text) {
            const lines = text.split('\n').filter(l => l.trim());
            let store = '';
            let total = '';
            let date = '';
            let items = [];

            console.log('OCR Text:', text); // Debug

            // Try to find store name - look for EMPRESA keyword or similar
            const storePatterns = [
                /EMPRESA[:\s]*(.+)/i,
                /RAZON\s*SOCIAL[:\s]*(.+)/i,
                /COMERCIO[:\s]*(.+)/i
            ];

            for (const pattern of storePatterns) {
                const match = text.match(pattern);
                if (match) {
                    store = match[1].replace(/[^a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]/g, '').trim();
                    break;
                }
            }

            // Fallback: use first line that looks like a name (not RUT, not BOLETA)
            if (!store) {
                for (const line of lines) {
                    const cleanLine = line.trim();
                    if (!cleanLine.match(/^(RUT|BOLETA|N¬∞|FECHA|CANTIDAD|TOTAL|IVA|\d)/i) && cleanLine.length > 3) {
                        store = cleanLine.replace(/[^a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]/g, '').trim();
                        if (store.length > 3) break;
                    }
                }
            }

            // Try to find total - improved patterns for Chilean receipts
            // Priority: TOTAL CON PROPINA (restaurant) > TOTAL A PAGAR > TOTAL
            const totalPatterns = [
                /TOTAL\s+CON\s+PROPINA\s*[:\s]*\$?\s*([\d]+[.,][\d]{3})/i,   // TOTAL CON PROPINA: $8.500
                /TOTAL\s+CON\s+PROPINA\s*[:\s]*\$?\s*([\d.,]+)/i,            // TOTAL CON PROPINA: $8500
                /TOTAL\s+A\s+PAGAR\s*[:\s]*\$?\s*([\d]+[.,][\d]{3})/i,       // TOTAL A PAGAR: $8.500
                /TOTAL\s+A\s+PAGAR\s*[:\s]*\$?\s*([\d.,]+)/i,                // TOTAL A PAGAR: $8500
                /MONTO\s*TOTAL\s*[:\s]*\$?\s*([\d]+[.,][\d]{3})/i,           // MONTO TOTAL: $8.500
                /MONTO\s*TOTAL\s*[:\s]*\$?\s*([\d.,]+)/i,                    // MONTO TOTAL: $8500
                /TOTAL\s*[:\s]*\$?\s*([\d]+[.,][\d]{3})/i,                   // TOTAL : $ 6.190
                /TOTAL\s*[:\s]*\$?\s*([\d.,]+)/i,                            // TOTAL: $6190
                /MONTO\s*[:\s]*\$?\s*([\d.,]+)/i,                            // MONTO
                /\$\s*([\d]+[.,][\d]{3})\s*$/m                                // $ 6.190 at end of line
            ];

            for (const pattern of totalPatterns) {
                const match = text.match(pattern);
                if (match) {
                    // For Chilean pesos: dots are thousand separators, no decimals
                    // Convert "6.190" to "6190"
                    total = match[1].replace(/\./g, '').replace(/,/g, '');
                    console.log('Found total:', match[0], '-> parsed as:', total);
                    break;
                }
            }

            // Try to find date - improved patterns including YYYY-MM-DD
            const datePatterns = [
                /FECHA\s*(?:EMISION)?[:\s]*(\d{4})-(\d{2})-(\d{2})/i,  // FECHA EMISION: 2020-08-16
                /(\d{4})-(\d{2})-(\d{2})/,                              // 2020-08-16
                /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,               // 16/08/2020
                /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,               // 16/08/20
                /(\d{1,2})\s+(?:de\s+)?(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)[a-z]*\s+(?:de\s+)?(\d{2,4})/i
            ];

            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    // Check if it's YYYY-MM-DD format (year comes first)
                    if (match[1].length === 4) {
                        // Already in YYYY-MM-DD format
                        date = `${match[1]}-${match[2]}-${match[3]}`;
                    } else if (match[2].length <= 2 && !isNaN(match[2])) {
                        // DD/MM/YYYY or DD-MM-YYYY format
                        let day = match[1].padStart(2, '0');
                        let month = match[2].padStart(2, '0');
                        let year = match[3].length === 2 ? '20' + match[3] : match[3];
                        date = `${year}-${month}-${day}`;
                    } else {
                        // DD mes YYYY format (e.g., "16 agosto 2020")
                        const monthMap = {ene: '01', feb: '02', mar: '03', abr: '04', may: '05', jun: '06', jul: '07', ago: '08', sep: '09', oct: '10', nov: '11', dic: '12'};
                        let day = match[1].padStart(2, '0');
                        let month = monthMap[match[2].toLowerCase().substring(0, 3)] || '01';
                        let year = match[3].length === 2 ? '20' + match[3] : match[3];
                        date = `${year}-${month}-${day}`;
                    }
                    console.log('Found date:', match[0], '-> parsed as:', date);
                    break;
                }
            }

            // Extract potential items (lines with numbers that look like prices)
            // Chilean format: CANTIDAD  DESCRIPCION  VALOR (e.g., "1  Cafe 50 gr.  1.500")
            const itemPatterns = [
                /^\d+\s+(.+?)\s+([\d]+[.,][\d]{3})\s*$/,  // 1  Cafe 50 gr.  1.500
                /^\d+\s+(.+?)\s+\$?([\d.,]+)\s*$/,         // 1  Item  $1500
                /^(.+?)\s+\$?([\d]+[.,][\d]{3})\s*$/,      // Item  1.500
                /^(.+?)\s+([\d]{1,3}(?:[.,]\d{3})+)\s*$/   // Item  1.500 or 10.500
            ];

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                if (!lowerLine.includes('total') &&
                    !lowerLine.includes('subtotal') &&
                    !lowerLine.includes('iva') &&
                    !lowerLine.includes('rut') &&
                    !lowerLine.includes('boleta') &&
                    !lowerLine.includes('fecha') &&
                    !lowerLine.includes('cantidad')) {

                    for (const pattern of itemPatterns) {
                        const match = line.match(pattern);
                        if (match && match[1].trim().length > 2) {
                            const itemName = match[1].trim().replace(/^\d+\s*/, ''); // Remove leading quantity
                            const itemPrice = match[2];
                            if (itemName.length > 2) {
                                items.push(`${itemName} - $${itemPrice}`);
                            }
                            break;
                        }
                    }
                }
            });

            console.log('Parsed receipt:', { store, total, date, items });
            return { store, total, date, items, description: items.length > 0 ? items.slice(0, 3).join(', ') : '' };
        }

        async function saveExpenseFromScan() {
            const store = document.getElementById('expenseStore').value.trim();
            const date = document.getElementById('expenseDate').value;
            const total = document.getElementById('expenseTotal').value;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();

            if (!total || parseFloat(total) <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            const expense = {
                id: Date.now(),
                store: store || 'Sin nombre',
                date: date || getTodayKey(),
                total: parseFloat(total),
                category,
                description,
                hasReceipt: true,
                createdAt: new Date().toISOString()
            };

            // ALWAYS save to localStorage via setStorage (which syncs to user_data)
            const expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses); // This uses setStorage which syncs to Supabase user_data

            // ALSO try to save to expenses table directly
            if (typeof syncService !== 'undefined' && syncService.userId) {
                try {
                    await syncService.saveExpense(expense);
                    console.log('Expense also synced to expenses table');
                } catch (error) {
                    console.error('Error syncing to expenses table:', error);
                }
            }

            closeScanReceiptModal();
            addNotification(`Gasto de $${parseFloat(total).toLocaleString('es-CL')} registrado`, 'üí∞');
            render();
        }

        async function saveManualExpense() {
            const store = document.getElementById('manualExpenseStore').value.trim();
            const date = document.getElementById('manualExpenseDate').value;
            const total = document.getElementById('manualExpenseTotal').value;
            const category = document.getElementById('manualExpenseCategory').value;
            const description = document.getElementById('manualExpenseDescription').value.trim();

            if (!total || parseFloat(total) <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            const expense = {
                id: Date.now(),
                store: store || 'Sin nombre',
                date: date || getTodayKey(),
                total: parseFloat(total),
                category,
                description,
                hasReceipt: false,
                createdAt: new Date().toISOString()
            };

            // ALWAYS save to localStorage via setStorage (which syncs to user_data)
            const expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses); // This uses setStorage which syncs to Supabase user_data

            // ALSO try to save to expenses table directly
            if (typeof syncService !== 'undefined' && syncService.userId) {
                try {
                    await syncService.saveExpense(expense);
                    console.log('Expense also synced to expenses table');
                } catch (error) {
                    console.error('Error syncing to expenses table:', error);
                }
            }

            closeAddExpenseModal();
            addNotification(`Gasto de $${parseFloat(total).toLocaleString('es-CL')} agregado`, 'üí∞');
            render();
        }

        let editingExpenseId = null;

        function openEditExpenseModal(recentIdx) {
            const recentExpenses = window.currentRecentExpenses || [];
            const expense = recentExpenses[recentIdx];

            if (!expense) {
                alert('No se encontr√≥ el gasto. Debug: idx=' + recentIdx + ', total=' + recentExpenses.length);
                return;
            }

            editingExpenseId = expense.id;

            // Populate category dropdown
            const categorySelect = document.getElementById('editExpenseCategory');
            const categories = getCategories('expenses');
            categorySelect.innerHTML = categories.map(cat =>
                `<option value="${cat.id}" ${expense.category === cat.id ? 'selected' : ''}>${cat.emoji} ${cat.name}</option>`
            ).join('');

            // Populate fields
            document.getElementById('editExpenseStore').value = expense.store || '';
            document.getElementById('editExpenseDate').value = expense.date || '';
            document.getElementById('editExpenseTotal').value = expense.total || '';
            document.getElementById('editExpenseDescription').value = expense.description || '';

            document.getElementById('editExpenseModal').classList.remove('hidden');
        }

        function closeEditExpenseModal() {
            document.getElementById('editExpenseModal').classList.add('hidden');
            editingExpenseId = null;
        }

        async function saveEditedExpense() {
            if (editingExpenseId === null) return;

            const store = document.getElementById('editExpenseStore').value.trim();
            const date = document.getElementById('editExpenseDate').value;
            const total = document.getElementById('editExpenseTotal').value;
            const category = document.getElementById('editExpenseCategory').value;
            const description = document.getElementById('editExpenseDescription').value.trim();

            if (!total || parseFloat(total) <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            const expenses = getExpenses();
            const expenseIndex = expenses.findIndex(e => String(e.id) === String(editingExpenseId));

            if (expenseIndex === -1) {
                alert('No se encontr√≥ el gasto');
                return;
            }

            // Update expense fields
            const updatedExpense = {
                ...expenses[expenseIndex],
                store: store || 'Sin nombre',
                date: date || getTodayKey(),
                total: parseFloat(total),
                category,
                description,
                updatedAt: new Date().toISOString()
            };

            expenses[expenseIndex] = updatedExpense;
            saveExpenses(expenses);

            // Sync update with Supabase if available
            if (typeof syncService !== 'undefined' && syncService.userId) {
                try {
                    await syncService.updateExpense(updatedExpense);
                    console.log('Expense update synced to Supabase');
                } catch (error) {
                    console.error('Error syncing expense update:', error);
                }
            }

            closeEditExpenseModal();
            addNotification('Gasto actualizado', '‚úèÔ∏è');
            render();
        }

        async function deleteExpense(recentIdx) {
            if (!confirm('¬øEliminar este gasto?')) return;

            const recentExpenses = window.currentRecentExpenses || [];
            const expenseToDelete = recentExpenses[recentIdx];

            if (!expenseToDelete) return;

            const expenses = getExpenses();
            const index = expenses.findIndex(e => String(e.id) === String(expenseToDelete.id));
            if (index !== -1) {
                const deletedExpenseId = expenses[index].id;
                expenses.splice(index, 1);
                saveExpenses(expenses);

                // Sync deletion with Supabase if available
                if (typeof syncService !== 'undefined' && syncService.userId) {
                    try {
                        await syncService.deleteExpense(deletedExpenseId);
                        console.log('Expense deletion synced to Supabase');
                    } catch (error) {
                        console.error('Error syncing expense deletion:', error);
                    }
                }

                render();
            }
        }

        // ==================== END EXPENSES MODULE ====================

        // Variable para el per√≠odo seleccionado en estad√≠sticas
        let statsPeriod = 'month';

        function renderStats() {
            const weeklyData = getWeeklyProgressData();
            const categoryData = getCategoryDistribution();
            const historicalData = getHistoricalData();
            const stats = getCompletionStats();
            const currentStreak = getStreak();
            const bestStreak = getBestStreak();
            const pomodorosToday = getPomodoroCount();

            // Obtener estad√≠sticas de gastos
            const expenseStats = getExpenseStats(statsPeriod);

            const categoryNames = {
                habitos: '‚òÄÔ∏è H√°bitos',
                nutricion: 'ü•ó Nutrici√≥n',
                fisico: 'üí™ F√≠sico',
                personal: 'üìö Personal',
                digital: 'üì± Digital',
                espiritual: 'üßò Espiritual',
                descanso: 'üò¥ Descanso'
            };

            const categoryColorMap = {
                habitos: 'bg-yellow-400',
                nutricion: 'bg-green-400',
                fisico: 'bg-red-400',
                personal: 'bg-blue-400',
                digital: 'bg-purple-400',
                espiritual: 'bg-indigo-400',
                descanso: 'bg-gray-400'
            };

            const periodLabels = {
                week: 'Esta Semana',
                month: 'Este Mes',
                last30: '√öltimos 30 d√≠as',
                last90: '√öltimos 90 d√≠as',
                year: 'Este A√±o'
            };

            return `
                <div class="space-y-6">
                    <!-- Selector de Per√≠odo -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-800">üìÖ Per√≠odo</h3>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${Object.entries(periodLabels).map(([key, label]) => `
                                <button onclick="changeStatsPeriod('${key}')"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition ${statsPeriod === key ? 'theme-btn' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                    ${label}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- üí∞ ESTAD√çSTICAS DE GASTOS -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üí∞ Resumen de Gastos - ${periodLabels[statsPeriod]}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl">
                                <p class="text-2xl font-bold text-green-600">$${expenseStats.total.toLocaleString('es-CL')}</p>
                                <p class="text-sm text-gray-500">Total gastado</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl">
                                <p class="text-2xl font-bold text-blue-600">$${expenseStats.average.toLocaleString('es-CL')}</p>
                                <p class="text-sm text-gray-500">Promedio diario</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl">
                                <p class="text-2xl font-bold text-purple-600">${expenseStats.count}</p>
                                <p class="text-sm text-gray-500">Transacciones</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br ${expenseStats.comparison.percentageChange > 0 ? 'from-red-50 to-orange-50' : 'from-green-50 to-teal-50'} rounded-xl">
                                <p class="text-2xl font-bold ${expenseStats.comparison.percentageChange > 0 ? 'text-red-600' : 'text-green-600'}">
                                    ${expenseStats.comparison.percentageChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(expenseStats.comparison.percentageChange)}%
                                </p>
                                <p class="text-sm text-gray-500">vs per√≠odo anterior</p>
                            </div>
                        </div>

                        <!-- Gr√°fica de Gastos por Categor√≠a -->
                        <h4 class="font-semibold text-gray-700 mb-3">üìä Gastos por Categor√≠a</h4>
                        ${expenseStats.byCategory.length > 0 ? `
                            <div class="space-y-3 mb-6">
                                ${expenseStats.byCategory.map(cat => `
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg w-8">${cat.emoji}</span>
                                        <span class="text-sm w-28 truncate">${cat.name}</span>
                                        <div class="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full transition-all" style="width: ${cat.percentage}%; background-color: ${cat.color};"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-700 w-24 text-right">$${cat.total.toLocaleString('es-CL')}</span>
                                        <span class="text-xs text-gray-400 w-12 text-right">${cat.percentage}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<p class="text-center text-gray-400 py-4">No hay gastos registrados</p>`}

                        <!-- Gastos por Mes (Gr√°fica de Barras) -->
                        <h4 class="font-semibold text-gray-700 mb-3">üìà Evoluci√≥n Mensual</h4>
                        ${expenseStats.byMonth.length > 0 ? `
                            <div class="flex items-end justify-between gap-2 h-40">
                                ${expenseStats.byMonth.map(month => {
                                    const maxTotal = Math.max(...expenseStats.byMonth.map(m => m.total));
                                    const heightPercent = maxTotal > 0 ? (month.total / maxTotal) * 100 : 0;
                                    const isCurrentMonth = month.month === new Date().toISOString().substring(0, 7);
                                    return `
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-gray-100 rounded-t-lg relative" style="height: 120px;">
                                                <div class="absolute bottom-0 w-full rounded-t-lg transition-all ${isCurrentMonth ? 'bg-gradient-to-t from-green-500 to-emerald-400' : 'bg-gradient-to-t from-green-300 to-emerald-200'}" style="height: ${heightPercent}%;">
                                                </div>
                                            </div>
                                            <span class="text-xs mt-2 font-medium ${isCurrentMonth ? 'text-green-600' : 'text-gray-500'}">${month.label.split(' ')[0]}</span>
                                            <span class="text-xs ${isCurrentMonth ? 'text-green-600 font-bold' : 'text-gray-400'}">$${(month.total/1000).toFixed(0)}k</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `<p class="text-center text-gray-400 py-4">No hay datos</p>`}

                        <!-- Top Gastos -->
                        ${expenseStats.topExpenses.length > 0 ? `
                            <h4 class="font-semibold text-gray-700 mt-6 mb-3">üèÜ Mayores Gastos</h4>
                            <div class="space-y-2">
                                ${expenseStats.topExpenses.map((expense, i) => `
                                    <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                                        <span class="text-lg font-bold text-gray-400 w-6">${i + 1}</span>
                                        <span class="flex-1 text-sm truncate">${expense.store || 'Sin nombre'}</span>
                                        <span class="text-xs text-gray-400">${expense.date}</span>
                                        <span class="font-semibold text-gray-700">$${parseFloat(expense.total).toLocaleString('es-CL')}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Resumen General de Actividades -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìä Resumen de Actividades</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gradient-to-br from-rose-50 to-purple-50 rounded-xl">
                                <p class="text-3xl font-bold text-purple-600">${stats.completionRate}%</p>
                                <p class="text-sm text-gray-500">D√≠as perfectos</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-xl">
                                <p class="text-3xl font-bold text-orange-600">${currentStreak}</p>
                                <p class="text-sm text-gray-500">Racha actual</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl">
                                <p class="text-3xl font-bold text-green-600">${stats.taskRate}%</p>
                                <p class="text-sm text-gray-500">Tareas completadas</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-red-50 to-pink-50 rounded-xl">
                                <p class="text-3xl font-bold text-red-600">${pomodorosToday}</p>
                                <p class="text-sm text-gray-500">Pomodoros hoy</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fica de Progreso Semanal -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìà Progreso de la Semana</h3>
                        ${weeklyData.length > 0 ? `
                            <div class="flex items-end justify-between gap-2 h-48">
                                ${weeklyData.map(day => `
                                    <div class="flex-1 flex flex-col items-center ${!day.inRange ? 'opacity-40' : ''}">
                                        <div class="w-full bg-gray-100 rounded-t-lg relative" style="height: 160px;">
                                            <div class="absolute bottom-0 w-full rounded-t-lg transition-all ${day.isToday ? 'theme-bar' : 'theme-bar-light'}" style="height: ${day.progress}%;">
                                            </div>
                                        </div>
                                        <span class="text-xs mt-2 font-medium ${day.isToday ? 'text-purple-600' : 'text-gray-500'}">${day.day}</span>
                                        <span class="text-xs ${day.isToday ? 'text-purple-600 font-bold' : 'text-gray-400'}">${day.inRange ? day.progress + '%' : '-'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<p class="text-center text-gray-400 py-8">No hay datos disponibles</p>`}
                    </div>

                    <!-- Gr√°fica de √öltimos 7 d√≠as -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìÖ √öltimos 7 D√≠as</h3>
                        <div class="space-y-3">
                            ${historicalData.map(day => `
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-gray-500 w-12">${day.label}</span>
                                    <div class="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full theme-progress rounded-full transition-all" style="width: ${day.progress}%;"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700 w-12 text-right">${day.progress}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Distribuci√≥n por Categor√≠a de Actividades -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üé® Distribuci√≥n por Categor√≠a</h3>
                        <div class="space-y-3">
                            ${categoryData.map(cat => `
                                <div class="flex items-center gap-3">
                                    <span class="text-sm w-28">${categoryNames[cat.category] || cat.category}</span>
                                    <div class="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full ${categoryColorMap[cat.category] || 'bg-gray-400'} rounded-full" style="width: ${cat.percentage}%;"></div>
                                    </div>
                                    <span class="text-sm text-gray-500 w-16 text-right">${cat.count} (${cat.percentage}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Estad√≠sticas Detalladas -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìã Detalles</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">D√≠as transcurridos</p>
                                <p class="text-xl font-bold text-gray-800">${stats.totalDays}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">D√≠as completados al 100%</p>
                                <p class="text-xl font-bold text-green-600">${stats.completedDays}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Total de tareas</p>
                                <p class="text-xl font-bold text-gray-800">${stats.totalTasks}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Tareas completadas</p>
                                <p class="text-xl font-bold text-purple-600">${stats.completedTasks}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Mejor racha</p>
                                <p class="text-xl font-bold text-orange-600">üî• ${bestStreak} d√≠as</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Promedio diario</p>
                                <p class="text-xl font-bold text-blue-600">${stats.totalDays > 0 ? Math.round(stats.completedTasks / stats.totalDays) : 0} tareas</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para cambiar el per√≠odo de estad√≠sticas
        function changeStatsPeriod(period) {
            statsPeriod = period;
            render();
        }

        // Funci√≥n para obtener estad√≠sticas de gastos
        function getExpenseStats(period) {
            const expenses = getExpenses();
            const now = new Date();
            let start, end;

            end = new Date(now);
            end.setHours(23, 59, 59, 999);
            start = new Date(now);
            start.setHours(0, 0, 0, 0);

            switch (period) {
                case 'week':
                    start.setDate(start.getDate() - start.getDay() + 1);
                    break;
                case 'month':
                    start.setDate(1);
                    break;
                case 'last30':
                    start.setDate(start.getDate() - 30);
                    break;
                case 'last90':
                    start.setDate(start.getDate() - 90);
                    break;
                case 'year':
                    start.setMonth(0, 1);
                    break;
            }

            // Filtrar por per√≠odo
            const filtered = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= start && expenseDate <= end;
            });

            // Calcular totales
            const total = filtered.reduce((sum, e) => sum + (parseFloat(e.total) || 0), 0);
            const days = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
            const average = Math.round(total / days);

            // Agrupar por categor√≠a
            const byCategory = {};
            const expenseCategoryInfo = {
                'alimentacion': { name: 'Alimentaci√≥n', emoji: 'üçî', color: '#f59e0b' },
                'transporte': { name: 'Transporte', emoji: 'üöó', color: '#3b82f6' },
                'salud': { name: 'Salud', emoji: 'üíä', color: '#10b981' },
                'entretenimiento': { name: 'Entretenimiento', emoji: 'üé¨', color: '#8b5cf6' },
                'ropa': { name: 'Ropa', emoji: 'üëï', color: '#ec4899' },
                'servicios': { name: 'Servicios', emoji: 'üì±', color: '#6366f1' },
                'hogar': { name: 'Hogar', emoji: 'üè†', color: '#14b8a6' },
                'educacion': { name: 'Educaci√≥n', emoji: 'üìö', color: '#f97316' },
                'belleza': { name: 'Belleza', emoji: 'üíÑ', color: '#e11d48' },
                'otro': { name: 'Otro', emoji: 'üì¶', color: '#6b7280' }
            };

            filtered.forEach(expense => {
                let catId = 'otro';
                const cat = expense.category || '';

                // Extraer ID de categor√≠a
                for (const [id, info] of Object.entries(expenseCategoryInfo)) {
                    if (cat.toLowerCase().includes(id) || cat.includes(info.emoji) || cat.toLowerCase().includes(info.name.toLowerCase())) {
                        catId = id;
                        break;
                    }
                }

                if (!byCategory[catId]) {
                    byCategory[catId] = { total: 0, count: 0 };
                }
                byCategory[catId].total += parseFloat(expense.total) || 0;
                byCategory[catId].count++;
            });

            const categoryArray = Object.entries(byCategory).map(([id, data]) => {
                const info = expenseCategoryInfo[id] || expenseCategoryInfo.otro;
                return {
                    id,
                    name: info.name,
                    emoji: info.emoji,
                    color: info.color,
                    total: data.total,
                    count: data.count,
                    percentage: total > 0 ? Math.round((data.total / total) * 100) : 0
                };
            }).sort((a, b) => b.total - a.total);

            // Gastos por mes (√∫ltimos 6 meses)
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const byMonth = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthTotal = expenses.filter(e => e.date && e.date.startsWith(key))
                    .reduce((sum, e) => sum + (parseFloat(e.total) || 0), 0);
                byMonth.push({
                    month: key,
                    label: `${monthNames[date.getMonth()]} ${date.getFullYear()}`,
                    total: monthTotal
                });
            }

            // Top gastos
            const topExpenses = filtered
                .sort((a, b) => (parseFloat(b.total) || 0) - (parseFloat(a.total) || 0))
                .slice(0, 5);

            // Comparaci√≥n con per√≠odo anterior
            const prevEnd = new Date(start);
            prevEnd.setDate(prevEnd.getDate() - 1);
            const prevStart = new Date(prevEnd);

            switch (period) {
                case 'week':
                    prevStart.setDate(prevStart.getDate() - 6);
                    break;
                case 'month':
                    prevStart.setDate(1);
                    break;
                default:
                    prevStart.setDate(prevStart.getDate() - days);
            }

            const prevFiltered = expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate >= prevStart && expenseDate <= prevEnd;
            });
            const prevTotal = prevFiltered.reduce((sum, e) => sum + (parseFloat(e.total) || 0), 0);
            const difference = total - prevTotal;
            const percentageChange = prevTotal > 0 ? Math.round((difference / prevTotal) * 100) : 0;

            return {
                total,
                average,
                count: filtered.length,
                byCategory: categoryArray,
                byMonth,
                topExpenses,
                comparison: {
                    current: total,
                    previous: prevTotal,
                    difference,
                    percentageChange
                }
            };
        }

        // Initial render
        render();
        updateFloatingButtons();

        // Initialize fasting timer if there's an active fast
        if (hasActiveFast()) {
            startFastingTimer();
        }

        // Initialize Lucide icons on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.lucide) {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
