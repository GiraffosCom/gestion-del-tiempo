<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Plan - Gesti√≥n del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, #ec4899, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.5s ease; }
        .tab-active { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; }
        .checked-item { opacity: 0.6; transform: scale(0.98); }
        .habit-checked { background: linear-gradient(135deg, #fdf2f8, #f3e8ff); border-color: #c084fc; }
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .btn-icon { transition: all 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ec4899, #8b5cf6); border-radius: 10px; }
        .glow { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
        .photo-glow { box-shadow: 0 0 20px rgba(236, 72, 153, 0.4), 0 0 40px rgba(139, 92, 246, 0.3); }
        @keyframes celebrationFall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* Dark Mode Styles */
        .dark { background: linear-gradient(135deg, #1a1a2e, #16213e, #1a1a2e) !important; }
        .dark .bg-white { background: #1e293b !important; }
        .dark .bg-white\/90 { background: rgba(30, 41, 59, 0.95) !important; }
        .dark .bg-white\/80 { background: rgba(30, 41, 59, 0.9) !important; }
        .dark .bg-white\/60 { background: rgba(30, 41, 59, 0.8) !important; }
        .dark .bg-white\/40 { background: rgba(30, 41, 59, 0.6) !important; }
        .dark .bg-white\/50 { background: rgba(30, 41, 59, 0.7) !important; }
        .dark .text-gray-800 { color: #f1f5f9 !important; }
        .dark .text-gray-700 { color: #e2e8f0 !important; }
        .dark .text-gray-600 { color: #cbd5e1 !important; }
        .dark .text-gray-500 { color: #94a3b8 !important; }
        .dark .text-gray-400 { color: #64748b !important; }
        .dark .border-gray-200 { border-color: #334155 !important; }
        .dark .border-gray-100 { border-color: #1e293b !important; }
        .dark .border-b { border-color: #334155 !important; }
        .dark .hover\:bg-gray-50:hover { background: #334155 !important; }
        .dark .hover\:bg-gray-100:hover { background: #334155 !important; }
        .dark .hover\:bg-white:hover { background: #334155 !important; }
        .dark .bg-gray-50 { background: #1e293b !important; }
        .dark .bg-gray-100 { background: #334155 !important; }
        .dark input, .dark select, .dark textarea { background: #1e293b !important; color: #f1f5f9 !important; border-color: #334155 !important; }
        .dark .modal-backdrop { background: rgba(0,0,0,0.7); }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark .habit-checked { background: linear-gradient(135deg, #2d1f3d, #1e293b) !important; }
        .dark .from-rose-50, .dark .via-purple-50, .dark .to-blue-50 { --tw-gradient-stops: #1a1a2e, #16213e, #1a1a2e !important; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-purple-50 to-blue-50">
    <div id="app"></div>

    <!-- Modal para Editar Actividad -->
    <div id="editModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Actividad</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="editTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 08:30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Actividad</label>
                    <input type="text" id="editActivity" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Descripci√≥n de la actividad">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Duraci√≥n</label>
                    <input type="text" id="editDuration" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1 hr">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categor√≠a</label>
                    <select id="editCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                        <option value="habitos">‚òÄÔ∏è H√°bitos</option>
                        <option value="nutricion">ü•ó Nutrici√≥n</option>
                        <option value="fisico">üí™ F√≠sico</option>
                        <option value="personal">üìö Personal</option>
                        <option value="digital">üì± Digital</option>
                        <option value="espiritual">üßò Espiritual</option>
                        <option value="descanso">üò¥ Descanso</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmar Borrado -->
    <div id="deleteModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <div class="text-center">
                <span class="text-5xl">üóëÔ∏è</span>
                <h3 class="text-xl font-bold text-gray-800 mt-3">¬øEliminar elemento?</h3>
                <p class="text-gray-500 mt-2" id="deleteActivityName">Esta acci√≥n no se puede deshacer</p>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition font-medium">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nueva Actividad -->
    <div id="addModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Actividad</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="addTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 08:30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Actividad</label>
                    <input type="text" id="addActivity" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Descripci√≥n de la actividad">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Duraci√≥n</label>
                    <input type="text" id="addDuration" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1 hr">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categor√≠a</label>
                    <select id="addCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                        <option value="habitos">‚òÄÔ∏è H√°bitos</option>
                        <option value="nutricion">ü•ó Nutrici√≥n</option>
                        <option value="fisico">üí™ F√≠sico</option>
                        <option value="personal">üìö Personal</option>
                        <option value="digital">üì± Digital</option>
                        <option value="espiritual">üßò Espiritual</option>
                        <option value="descanso">üò¥ Descanso</option>
                    </select>
                </div>

                <!-- Opci√≥n de repetir -->
                <div class="border-t pt-4">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="addRepeat" onchange="toggleRepeatOptions()" class="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">üîÑ Repetir en varios d√≠as</span>
                    </label>
                </div>

                <!-- Opciones de fecha (ocultas por defecto) -->
                <div id="repeatOptions" class="hidden space-y-3 bg-purple-50 p-3 rounded-xl">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">üìÖ Fecha inicio</label>
                        <input type="date" id="addStartDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">üìÖ Fecha fin</label>
                        <input type="date" id="addEndDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                    </div>
                    <p class="text-xs text-purple-600">La actividad se agregar√° a todos los d√≠as en este rango</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewActivity()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar H√°bito -->
    <div id="editHabitModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar H√°bito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="editHabitIcon" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: ‚òÄÔ∏è">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del h√°bito</label>
                    <input type="text" id="editHabitName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Despertar 7:00 AM">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditHabitModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveHabitEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar H√°bito -->
    <div id="addHabitModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nuevo H√°bito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="addHabitIcon" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: ‚òÄÔ∏è">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del h√°bito</label>
                    <input type="text" id="addHabitName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Despertar 7:00 AM">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddHabitModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewHabit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Ejercicio Gym -->
    <div id="editGymModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Ejercicio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Ejercicio</label>
                    <input type="text" id="editGymExercise" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Hip Thrust con barra 4x12">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditGymModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveGymEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Ejercicio Gym -->
    <div id="addGymModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nuevo Ejercicio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Ejercicio</label>
                    <input type="text" id="addGymExercise" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Hip Thrust con barra 4x12">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddGymModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewGymExercise()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Peso/Medidas -->
    <div id="weightModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeWeightModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚öñÔ∏è Registrar Peso</h3>
                <button onclick="closeWeightModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Fecha</label>
                    <input type="date" id="weightDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Peso (kg)</label>
                    <input type="number" step="0.1" id="weightValue" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 62.5">
                </div>
                <div class="border-t pt-4 mt-4">
                    <p class="text-sm font-medium text-gray-600 mb-3">Medidas opcionales (cm)</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Cintura</label>
                            <input type="number" step="0.1" id="measureWaist" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Cadera</label>
                            <input type="number" step="0.1" id="measureHip" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Pierna</label>
                            <input type="number" step="0.1" id="measureThigh" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Brazo</label>
                            <input type="number" step="0.1" id="measureArm" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="cm">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">% Grasa corporal (opcional)</label>
                    <input type="number" step="0.1" id="bodyFat" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 22.5">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeWeightModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveWeightEntry()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Configurar Perfil F√≠sico -->
    <div id="profileModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeProfileModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üë§ Mi Perfil F√≠sico</h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Estatura (cm)</label>
                    <input type="number" id="profileHeight" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 165">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Peso objetivo (kg)</label>
                    <input type="number" step="0.1" id="profileGoalWeight" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="ej: 58">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">D√≠a de check-in semanal</label>
                    <select id="profileCheckinDay" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                        <option value="1">Lunes</option>
                        <option value="2">Martes</option>
                        <option value="3">Mi√©rcoles</option>
                        <option value="4">Jueves</option>
                        <option value="5">Viernes</option>
                        <option value="6">S√°bado</option>
                        <option value="0">Domingo</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeProfileModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="savePhysicalProfile()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Ejercicio a Rutina -->
    <div id="addWorkoutExerciseModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeAddWorkoutExerciseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üèãÔ∏è Agregar Ejercicio</h3>
                <button onclick="closeAddWorkoutExerciseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="exerciseSearch" oninput="filterExerciseLibrary()" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="üîç Buscar ejercicio...">
            </div>

            <!-- Filter buttons -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button onclick="filterByMuscle('all')" class="muscle-filter-btn px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium" data-muscle="all">Todos</button>
                <button onclick="filterByMuscle('gluteos')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="gluteos">Gl√∫teos</button>
                <button onclick="filterByMuscle('piernas')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="piernas">Piernas</button>
                <button onclick="filterByMuscle('espalda')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="espalda">Espalda</button>
                <button onclick="filterByMuscle('pecho')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="pecho">Pecho</button>
                <button onclick="filterByMuscle('brazos')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="brazos">Brazos</button>
                <button onclick="filterByMuscle('core')" class="muscle-filter-btn px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm" data-muscle="core">Core</button>
            </div>

            <!-- Exercise list -->
            <div id="exerciseLibraryList" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Populated by JS -->
            </div>

            <!-- Custom exercise -->
            <div class="border-t mt-4 pt-4">
                <p class="text-sm text-gray-500 mb-2">¬øNo encuentras tu ejercicio?</p>
                <div class="flex gap-2">
                    <input type="text" id="customExerciseName" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Nombre del ejercicio">
                    <button onclick="addCustomExercise()" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium hover:bg-purple-200 transition">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Serie -->
    <div id="logSetModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeLogSetModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800" id="logSetTitle">Serie 1</h3>
                <button onclick="closeLogSetModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Peso (kg)</label>
                        <input type="number" step="0.5" id="setWeight" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-center text-xl font-bold" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Reps</label>
                        <input type="number" id="setReps" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-center text-xl font-bold" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">RPE (1-10) <span class="text-gray-400 text-xs">opcional</span></label>
                    <div class="flex gap-1">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button type="button" onclick="selectRPE(${n})" class="rpe-btn flex-1 py-2 border rounded-lg text-sm hover:bg-purple-100 transition" data-rpe="${n}">${n}</button>`).join('')}
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Notas <span class="text-gray-400 text-xs">opcional</span></label>
                    <input type="text" id="setNotes" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none text-sm" placeholder="ej: t√©cnica, dolor, ajustes...">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeLogSetModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveSetLog()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">‚úì Completar</button>
            </div>
        </div>
    </div>

    <!-- Floating Rest Timer -->
    <div id="restTimerFloat" class="fixed bottom-24 right-6 z-50 hidden">
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-2xl p-4 text-white min-w-[200px]">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium opacity-90">‚è±Ô∏è Descanso</span>
                <button onclick="closeRestTimer()" class="text-white/70 hover:text-white">√ó</button>
            </div>
            <div class="text-center">
                <span id="restTimerDisplay" class="text-4xl font-bold">1:30</span>
            </div>
            <div class="flex gap-2 mt-3">
                <button onclick="adjustRestTimer(-15)" class="flex-1 py-1 bg-white/20 rounded-lg text-sm hover:bg-white/30 transition">-15s</button>
                <button onclick="toggleRestTimer()" id="restTimerToggle" class="flex-1 py-1 bg-white/30 rounded-lg text-sm font-medium hover:bg-white/40 transition">‚è∏Ô∏è</button>
                <button onclick="adjustRestTimer(15)" class="flex-1 py-1 bg-white/20 rounded-lg text-sm hover:bg-white/30 transition">+15s</button>
            </div>
            <div class="flex gap-1 mt-2">
                <button onclick="setRestTimer(30)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">30s</button>
                <button onclick="setRestTimer(60)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">60s</button>
                <button onclick="setRestTimer(90)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">90s</button>
                <button onclick="setRestTimer(120)" class="flex-1 py-1 bg-white/10 rounded text-xs hover:bg-white/20">2m</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Comida -->
    <div id="editMealModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Comida</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="editMealTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 07:45">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="editMealName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Desayuno">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="editMealEmoji" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: üåÖ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Opciones (una por l√≠nea)</label>
                    <textarea id="editMealOptions" rows="4" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Opci√≥n 1&#10;Opci√≥n 2&#10;Opci√≥n 3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Macros</label>
                    <input type="text" id="editMealMacros" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: P:30g | C:45g | G:15g">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditMealModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveMealEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Comida -->
    <div id="addMealModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Comida</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="addMealTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 07:45">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="addMealName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Desayuno">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="addMealEmoji" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: üåÖ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Opciones (una por l√≠nea)</label>
                    <textarea id="addMealOptions" rows="4" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Opci√≥n 1&#10;Opci√≥n 2&#10;Opci√≥n 3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Macros</label>
                    <input type="text" id="addMealMacros" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: P:30g | C:45g | G:15g">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddMealModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewMeal()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Meta Semanal -->
    <div id="editGoalModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Meta Semanal</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Semana</label>
                    <input type="number" id="editGoalWeek" min="1" max="12" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Fechas</label>
                    <input type="text" id="editGoalDates" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 2-8 Feb">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üí™ Meta F√≠sica</label>
                    <input type="text" id="editGoalFisica" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üìö Meta Personal</label>
                    <input type="text" id="editGoalPersonal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üì± Meta Digital</label>
                    <input type="text" id="editGoalDigital" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üßò Meta Espiritual</label>
                    <input type="text" id="editGoalEspiritual" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditGoalModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveGoalEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Reemplazar Todos -->
    <div id="replaceAllModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">üîÑ ¬øAplicar a todos?</h3>
            <p id="replaceAllMessage" class="text-gray-600 text-center mb-6">¬øQuieres aplicar este cambio a todos los d√≠as?</p>

            <div class="space-y-3">
                <button onclick="confirmReplaceAll(true)" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    ‚úÖ S√≠, aplicar a todos
                </button>
                <button onclick="confirmReplaceAll(false)" class="w-full py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition">
                    üìÖ Solo este d√≠a
                </button>
                <button onclick="closeReplaceAllModal()" class="w-full py-2 text-gray-400 hover:text-gray-600 transition text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Foto de Perfil -->
    <div id="photoModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closePhotoModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üì∏ Foto de Perfil</h3>

            <!-- Vista normal (sin edici√≥n) -->
            <div id="photoNormalView">
                <!-- Preview actual -->
                <div class="flex justify-center mb-6">
                    <div id="photoPreview" class="w-32 h-32 rounded-full bg-gradient-to-r from-pink-500 to-purple-500 flex items-center justify-center text-white text-4xl font-bold border-4 border-purple-200 overflow-hidden">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <!-- Opciones -->
                <div class="space-y-3">
                    <label class="flex items-center justify-center gap-3 w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium cursor-pointer hover:opacity-90 transition">
                        <span>üìÅ Subir foto</span>
                        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    </label>

                    <label class="flex items-center justify-center gap-3 w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-medium cursor-pointer hover:opacity-90 transition">
                        <span>üì∑ Tomar foto</span>
                        <input type="file" id="cameraInput" accept="image/*" capture="user" class="hidden" onchange="handlePhotoUpload(event)">
                    </label>

                    <button onclick="removePhoto()" id="removePhotoBtn" class="w-full py-3 border-2 border-red-200 text-red-500 rounded-xl font-medium hover:bg-red-50 transition hidden">
                        üóëÔ∏è Eliminar foto
                    </button>
                </div>
            </div>

            <!-- Vista de edici√≥n (ajustar posici√≥n) -->
            <div id="photoEditView" class="hidden">
                <p class="text-sm text-gray-500 text-center mb-3">üëÜ Arrastra para ajustar la posici√≥n</p>

                <!-- √Årea de recorte -->
                <div class="flex justify-center mb-4">
                    <div id="cropperContainer" class="w-48 h-48 rounded-full border-4 border-purple-400 overflow-hidden relative cursor-move bg-gray-100"
                        onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                        <img id="cropperImage" class="absolute" style="max-width: none;" draggable="false">
                    </div>
                </div>

                <!-- Zoom slider -->
                <div class="mb-4">
                    <label class="text-sm text-gray-600 flex items-center justify-between mb-1">
                        <span>üîç Zoom</span>
                        <span id="zoomValue">100%</span>
                    </label>
                    <input type="range" id="zoomSlider" min="100" max="300" value="100"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        oninput="updateZoom(this.value)">
                </div>

                <!-- Botones de edici√≥n -->
                <div class="flex gap-3">
                    <button onclick="cancelCrop()" class="flex-1 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button onclick="saveCrop()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                        ‚úì Guardar
                    </button>
                </div>
            </div>

            <button onclick="closePhotoModal()" class="w-full mt-4 py-2 text-gray-500 hover:text-gray-700 transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Felicitaciones -->
    <div id="congratsModal" class="fixed inset-0 modal-backdrop z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all text-center">
            <div id="congratsEmoji" class="text-7xl mb-4"></div>
            <h3 id="congratsTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p id="congratsMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closeCongratsModal()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                ¬°Gracias! üôå
            </button>
        </div>
    </div>

    <!-- Modal Calendario -->
    <div id="calendarModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeCalendarModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-4 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition">‚óÄÔ∏è</button>
                <h3 id="calendarTitle" class="text-lg font-bold text-gray-800"></h3>
                <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition">‚ñ∂Ô∏è</button>
            </div>

            <!-- D√≠as de la semana -->
            <div class="grid grid-cols-7 gap-1 mb-2">
                <div class="text-center text-xs font-medium text-gray-500 py-1">Dom</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Lun</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Mar</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Mi√©</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Jue</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Vie</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">S√°b</div>
            </div>

            <!-- D√≠as del mes -->
            <div id="calendarDays" class="grid grid-cols-7 gap-1">
                <!-- Se genera din√°micamente -->
            </div>

            <button onclick="goToToday()" class="w-full mt-4 py-2 text-purple-600 font-medium hover:bg-purple-50 rounded-xl transition">
                üìç Ir a hoy
            </button>
        </div>
    </div>

    <!-- Modal Pomodoro -->
    <div id="pomodoroModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closePomodoroModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-2">üçÖ Pomodoro Timer</h3>
                <p class="text-gray-500 text-sm mb-4">Enf√≥cate en tus tareas</p>

                <!-- Timer Display -->
                <div id="pomodoroDisplay" class="text-6xl font-mono font-bold bg-gradient-to-r from-rose-500 to-purple-600 bg-clip-text text-transparent my-6">
                    25:00
                </div>

                <!-- Status -->
                <div id="pomodoroStatus" class="text-sm text-gray-500 mb-4">
                    ‚è±Ô∏è Listo para comenzar
                </div>

                <!-- Preset buttons -->
                <div class="flex justify-center gap-2 mb-6">
                    <button onclick="setPomodoroTime(25)" class="px-3 py-1 bg-rose-100 text-rose-600 rounded-full text-sm font-medium hover:bg-rose-200 transition">
                        üçÖ 25 min
                    </button>
                    <button onclick="setPomodoroTime(5)" class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-sm font-medium hover:bg-green-200 transition">
                        ‚òï 5 min
                    </button>
                    <button onclick="setPomodoroTime(15)" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-sm font-medium hover:bg-blue-200 transition">
                        üßò 15 min
                    </button>
                </div>

                <!-- Controls -->
                <div class="flex gap-3">
                    <button id="pomodoroStartBtn" onclick="togglePomodoro()" class="flex-1 px-4 py-3 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">
                        ‚ñ∂Ô∏è Iniciar
                    </button>
                    <button onclick="resetPomodoro()" class="px-4 py-3 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition font-medium">
                        üîÑ
                    </button>
                </div>

                <!-- Stats -->
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <p class="text-sm text-gray-500">
                        üèÜ Pomodoros hoy: <span id="pomodoroCount" class="font-bold text-purple-600">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante Pomodoro -->
    <button id="pomodoroFloatBtn" onclick="openPomodoroModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110 z-40 flex items-center justify-center text-2xl" title="Pomodoro Timer">
        üçÖ
    </button>

    <!-- Modal Exportar -->
    <div id="exportModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeExportModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-2">üì• Exportar Datos</h3>
            <p class="text-gray-500 text-sm mb-6">Descarga tu progreso y actividades</p>

            <div class="space-y-3">
                <button onclick="exportToCSV()" class="w-full flex items-center gap-4 p-4 border-2 border-gray-100 rounded-xl hover:border-green-300 hover:bg-green-50 transition">
                    <span class="text-3xl">üìä</span>
                    <div class="text-left">
                        <p class="font-medium text-gray-800">Exportar a CSV</p>
                        <p class="text-sm text-gray-500">Compatible con Excel y Google Sheets</p>
                    </div>
                </button>

                <button onclick="exportToPrint()" class="w-full flex items-center gap-4 p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 hover:bg-blue-50 transition">
                    <span class="text-3xl">üñ®Ô∏è</span>
                    <div class="text-left">
                        <p class="font-medium text-gray-800">Imprimir / PDF</p>
                        <p class="text-sm text-gray-500">Vista de impresi√≥n optimizada</p>
                    </div>
                </button>

                <button onclick="exportWeekSummary()" class="w-full flex items-center gap-4 p-4 border-2 border-gray-100 rounded-xl hover:border-purple-300 hover:bg-purple-50 transition">
                    <span class="text-3xl">üìã</span>
                    <div class="text-left">
                        <p class="font-medium text-gray-800">Resumen Semanal</p>
                        <p class="text-sm text-gray-500">Descarga el resumen de la semana actual</p>
                    </div>
                </button>
            </div>

            <button onclick="closeExportModal()" class="w-full mt-6 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Escanear Boleta -->
    <div id="scanReceiptModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeScanReceiptModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üì∏ Escanear Boleta</h3>
                <button onclick="closeScanReceiptModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <!-- Step 1: Capture/Upload -->
            <div id="scanStep1">
                <p class="text-gray-500 text-sm mb-4">Toma una foto o sube una imagen de tu boleta</p>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="startCamera()" class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-center">
                        <span class="text-4xl block mb-2">üì∑</span>
                        <p class="text-sm font-medium text-gray-700">Usar C√°mara</p>
                    </button>
                    <label class="p-4 border-2 border-dashed border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition text-center cursor-pointer">
                        <span class="text-4xl block mb-2">üñºÔ∏è</span>
                        <p class="text-sm font-medium text-gray-700">Subir Imagen</p>
                        <input type="file" accept="image/*" onchange="handleReceiptUpload(event)" class="hidden">
                    </label>
                </div>

                <!-- Camera Preview -->
                <div id="cameraContainer" class="hidden mb-4">
                    <video id="cameraPreview" class="w-full rounded-xl bg-black" autoplay playsinline></video>
                    <div class="flex gap-3 mt-3">
                        <button onclick="capturePhoto()" class="flex-1 py-3 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl font-medium hover:opacity-90 transition">
                            üì∏ Capturar
                        </button>
                        <button onclick="stopCamera()" class="px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                            Cancelar
                        </button>
                    </div>
                </div>

                <!-- Image Preview -->
                <div id="imagePreviewContainer" class="hidden mb-4">
                    <img id="receiptImagePreview" class="w-full rounded-xl max-h-64 object-contain bg-gray-100">
                    <div class="flex gap-3 mt-3">
                        <button onclick="processReceiptImage()" class="flex-1 py-3 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl font-medium hover:opacity-90 transition">
                            üîç Analizar Boleta
                        </button>
                        <button onclick="clearReceiptImage()" class="px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Processing -->
            <div id="scanStep2" class="hidden text-center py-8">
                <div class="animate-spin text-5xl mb-4">‚è≥</div>
                <p class="text-gray-600 font-medium">Analizando boleta...</p>
                <p class="text-gray-400 text-sm mt-2" id="ocrProgress">Iniciando OCR...</p>
            </div>

            <!-- Step 3: Results Form -->
            <div id="scanStep3" class="hidden">
                <p class="text-green-600 text-sm mb-4 flex items-center gap-2">
                    <span>‚úÖ</span> Datos extra√≠dos - verifica y corrige si es necesario
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tienda / Comercio</label>
                        <input type="text" id="expenseStore" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Nombre del comercio">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                            <input type="date" id="expenseDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                            <input type="number" step="0.01" id="expenseTotal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                        <select id="expenseCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                            <option value="alimentacion">üçî Alimentaci√≥n</option>
                            <option value="transporte">üöó Transporte</option>
                            <option value="salud">üíä Salud</option>
                            <option value="entretenimiento">üé¨ Entretenimiento</option>
                            <option value="ropa">üëï Ropa</option>
                            <option value="servicios">üì± Servicios</option>
                            <option value="hogar">üè† Hogar</option>
                            <option value="educacion">üìö Educaci√≥n</option>
                            <option value="otro">üì¶ Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n (opcional)</label>
                        <input type="text" id="expenseDescription" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Detalles adicionales">
                    </div>

                    <!-- Extracted items -->
                    <div id="extractedItemsContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Items detectados</label>
                        <div id="extractedItems" class="bg-gray-50 rounded-xl p-3 max-h-32 overflow-y-auto text-sm text-gray-600"></div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="resetScanModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                        Escanear otra
                    </button>
                    <button onclick="saveExpenseFromScan()" class="flex-1 px-4 py-3 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl font-medium hover:opacity-90 transition">
                        üíæ Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Gasto Manual -->
    <div id="addExpenseModal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4" onclick="closeAddExpenseModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è Agregar Gasto</h3>
                <button onclick="closeAddExpenseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tienda / Comercio</label>
                    <input type="text" id="manualExpenseStore" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Nombre del comercio">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="manualExpenseDate" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                        <input type="number" step="0.01" id="manualExpenseTotal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="0.00">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <select id="manualExpenseCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none">
                        <option value="alimentacion">üçî Alimentaci√≥n</option>
                        <option value="transporte">üöó Transporte</option>
                        <option value="salud">üíä Salud</option>
                        <option value="entretenimiento">üé¨ Entretenimiento</option>
                        <option value="ropa">üëï Ropa</option>
                        <option value="servicios">üì± Servicios</option>
                        <option value="hogar">üè† Hogar</option>
                        <option value="educacion">üìö Educaci√≥n</option>
                        <option value="otro">üì¶ Otro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n (opcional)</label>
                    <input type="text" id="manualExpenseDescription" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 outline-none" placeholder="Detalles adicionales">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeAddExpenseModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">
                    Cancelar
                </button>
                <button onclick="saveManualExpense()" class="flex-1 px-4 py-3 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl font-medium hover:opacity-90 transition">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Compartir -->
    <div id="shareModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeShareModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-2">üì§ Compartir Logros</h3>
            <p class="text-gray-500 text-sm mb-4">¬°Muestra tu progreso al mundo!</p>

            <!-- Preview Card -->
            <div id="sharePreview" class="bg-gradient-to-br from-rose-500 via-purple-500 to-blue-500 rounded-2xl p-6 text-white mb-4">
                <div class="text-center">
                    <p class="text-sm opacity-80">Mi progreso en</p>
                    <h4 class="text-xl font-bold mb-4">üéØ Gesti√≥n del Tiempo</h4>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-white/20 rounded-xl p-3">
                            <p id="shareDailyProgress" class="text-2xl font-bold">0%</p>
                            <p class="text-xs opacity-80">Hoy</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p id="shareWeeklyProgress" class="text-2xl font-bold">0%</p>
                            <p class="text-xs opacity-80">Semana</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p id="shareTotalProgress" class="text-2xl font-bold">0%</p>
                            <p class="text-xs opacity-80">Total</p>
                        </div>
                    </div>

                    <div class="flex justify-center gap-4">
                        <div class="flex items-center gap-1">
                            <span>üî•</span>
                            <span id="shareStreak" class="font-bold">0</span>
                            <span class="text-xs opacity-80">d√≠as</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span>üèÜ</span>
                            <span id="shareBestStreak" class="font-bold">0</span>
                            <span class="text-xs opacity-80">mejor</span>
                        </div>
                    </div>

                    <p id="shareMessage" class="mt-4 text-sm opacity-90 italic"></p>
                </div>
            </div>

            <!-- Share Options -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="copyShareText()" class="flex items-center justify-center gap-2 p-3 bg-gray-100 rounded-xl hover:bg-gray-200 transition">
                    <span class="text-xl">üìã</span>
                    <span class="text-sm font-medium text-gray-700">Copiar texto</span>
                </button>
                <button onclick="shareToTwitter()" class="flex items-center justify-center gap-2 p-3 bg-blue-100 rounded-xl hover:bg-blue-200 transition">
                    <span class="text-xl">üê¶</span>
                    <span class="text-sm font-medium text-blue-700">Twitter</span>
                </button>
                <button onclick="shareToWhatsApp()" class="flex items-center justify-center gap-2 p-3 bg-green-100 rounded-xl hover:bg-green-200 transition">
                    <span class="text-xl">üí¨</span>
                    <span class="text-sm font-medium text-green-700">WhatsApp</span>
                </button>
                <button onclick="shareNative()" class="flex items-center justify-center gap-2 p-3 bg-purple-100 rounded-xl hover:bg-purple-200 transition">
                    <span class="text-xl">üì≤</span>
                    <span class="text-sm font-medium text-purple-700">Compartir</span>
                </button>
            </div>

            <button onclick="closeShareModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Plantillas -->
    <div id="templateModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeTemplateModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all max-h-[85vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <button onclick="closeTemplateModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition" title="Cerrar">
                ‚úï
            </button>
            <h3 class="text-xl font-bold text-gray-800 mb-2">üìã Plantillas</h3>
            <p class="text-gray-500 text-sm mb-4">Carga planes completos o guarda tus propios horarios</p>

            <!-- Community Templates Section -->
            <div class="mb-6">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">üë•</span>
                    <h4 class="font-semibold text-gray-800">Plantillas de la Comunidad</h4>
                </div>
                <div id="communityTemplatesList" class="space-y-3">
                    <!-- Community templates will be rendered here -->
                </div>
            </div>

            <hr class="my-4 border-gray-200">

            <!-- Save current as template -->
            <div class="bg-gradient-to-r from-rose-50 to-purple-50 rounded-xl p-4 mb-4">
                <p class="font-medium text-gray-800 mb-2">üíæ Guardar d√≠a actual como plantilla</p>
                <div class="flex gap-2">
                    <input type="text" id="templateName" placeholder="Nombre de la plantilla..." class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-400 outline-none">
                    <button onclick="saveTemplate()" class="px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition">
                        Guardar
                    </button>
                </div>
            </div>

            <!-- My Templates list -->
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">üìÅ</span>
                    <h4 class="font-semibold text-gray-800">Mis Plantillas</h4>
                </div>
                <div id="templatesList" class="space-y-2">
                    <!-- Templates will be rendered here -->
                </div>
            </div>

            <button onclick="closeTemplateModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Limpiar Secci√≥n -->
    <div id="cleanModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeCleanModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <div class="text-center">
                <span class="text-5xl">üßπ</span>
                <h3 class="text-xl font-bold text-gray-800 mt-3">Limpiar Secci√≥n</h3>
                <p class="text-gray-500 mt-2" id="cleanModalDescription">Selecciona qu√© deseas limpiar</p>
            </div>

            <div id="cleanOptions" class="space-y-3 mt-6">
                <!-- Options will be rendered dynamically -->
            </div>

            <button onclick="closeCleanModal()" class="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-50 rounded-xl transition">
                Cancelar
            </button>
        </div>
    </div>

    <script>
        // Check login
        const currentUser = JSON.parse(localStorage.getItem('gestion-currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // Check if user needs onboarding (and hasn't completed it)
        if (currentUser && currentUser.needsOnboarding && !currentUser.onboardingCompleted) {
            window.location.href = 'onboarding.html';
        }

        // User-specific storage key prefix
        const userKey = currentUser ? currentUser.email.replace(/[^a-z0-9]/gi, '_') : 'guest';

        function getStorage(key) {
            return localStorage.getItem(`${userKey}-${key}`);
        }

        function setStorage(key, value) {
            localStorage.setItem(`${userKey}-${key}`, value);
        }

        function removeStorage(key) {
            localStorage.removeItem(`${userKey}-${key}`);
        }

        // Dark Mode Functions
        function isDarkMode() {
            return getStorage('dark-mode') === 'true';
        }

        function toggleDarkMode() {
            const isDark = !isDarkMode();
            setStorage('dark-mode', isDark.toString());
            applyDarkMode();
            render();
        }

        function applyDarkMode() {
            if (isDarkMode()) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }

        // Apply dark mode on page load
        applyDarkMode();

        function logout() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('gestion-currentUser');
                window.location.href = 'login.html';
            }
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        // Close settings menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('settingsMenu');
            const settingsBtn = e.target.closest('[onclick*="toggleSettingsMenu"]');
            if (menu && !menu.contains(e.target) && !settingsBtn) {
                menu.classList.add('hidden');
            }
            // Also close notifications menu
            const notifMenu = document.getElementById('notificationsMenu');
            const notifBtn = e.target.closest('[onclick*="toggleNotificationsMenu"]');
            if (notifMenu && !notifMenu.contains(e.target) && !notifBtn) {
                notifMenu.classList.add('hidden');
            }
        });

        // ==================== NOTIFICATIONS SYSTEM ====================

        function getNotifications() {
            return JSON.parse(getStorage('notifications') || '[]');
        }

        function saveNotifications(notifications) {
            setStorage('notifications', JSON.stringify(notifications));
        }

        function getUnreadNotificationsCount() {
            const notifications = getNotifications();
            return notifications.filter(n => !n.read).length;
        }

        function toggleNotificationsMenu() {
            const menu = document.getElementById('notificationsMenu');
            if (menu) {
                const wasHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                if (wasHidden) {
                    renderNotificationsList();
                }
            }
        }

        function renderNotificationsList() {
            const container = document.getElementById('notificationsList');
            if (!container) return;

            const notifications = getNotifications();

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-400">
                        <span class="text-4xl block mb-2">üîï</span>
                        <p>No tienes notificaciones</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map((notif, index) => `
                <div class="px-4 py-3 border-b border-gray-50 hover:bg-gray-50 transition cursor-pointer ${notif.read ? 'opacity-60' : ''}" onclick="markNotificationRead(${index})">
                    <div class="flex items-start gap-3">
                        <span class="text-xl">${notif.icon || 'üìå'}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-800 ${notif.read ? '' : 'font-medium'}">${notif.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${formatNotificationTime(notif.timestamp)}</p>
                        </div>
                        ${notif.read ? '' : '<span class="w-2 h-2 bg-purple-500 rounded-full flex-shrink-0 mt-2"></span>'}
                    </div>
                </div>
            `).join('');
        }

        function formatNotificationTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Ahora mismo';
            if (minutes < 60) return `Hace ${minutes} min`;
            if (hours < 24) return `Hace ${hours} hr`;
            if (days < 7) return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }

        function markNotificationRead(index) {
            const notifications = getNotifications();
            if (notifications[index]) {
                notifications[index].read = true;
                saveNotifications(notifications);
                renderNotificationsList();
                updateNotificationBadge();
            }
        }

        function markAllNotificationsRead() {
            const notifications = getNotifications();
            notifications.forEach(n => n.read = true);
            saveNotifications(notifications);
            renderNotificationsList();
            updateNotificationBadge();
        }

        function clearAllNotifications() {
            saveNotifications([]);
            renderNotificationsList();
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                const count = getUnreadNotificationsCount();
                badge.textContent = count > 9 ? '9+' : count;
                badge.classList.toggle('hidden', count === 0);
            }
        }

        function addNotification(message, icon = 'üìå') {
            const notifications = getNotifications();
            notifications.unshift({
                message,
                icon,
                timestamp: new Date().toISOString(),
                read: false
            });
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications.pop();
            }
            saveNotifications(notifications);
            updateNotificationBadge();
        }

        // Generate notifications based on user activity
        function generateDailyNotifications() {
            const today = getTodayKey();
            const lastNotifDay = getStorage('lastNotificationDay');

            if (lastNotifDay === today) return; // Already generated today

            setStorage('lastNotificationDay', today);

            const dayNum = getDayNumber();
            const userDuration = currentUser.duration || 60;

            // Welcome notification
            if (dayNum === 1) {
                addNotification(`¬°Bienvenido a tu primer d√≠a! üéâ Tu viaje de ${userDuration} d√≠as comienza hoy.`, 'üöÄ');
            }

            // Milestone notifications
            if (dayNum === 7) {
                addNotification('¬°Primera semana completada! üí™ Sigue as√≠.', 'üèÜ');
            } else if (dayNum === 14) {
                addNotification('¬°Dos semanas de progreso! üìà Ya eres un campe√≥n.', 'üåü');
            } else if (dayNum === 30) {
                addNotification('¬°Un mes de dedicaci√≥n! üéä Incre√≠ble logro.', 'üëë');
            } else if (dayNum === Math.floor(userDuration / 2)) {
                addNotification('¬°Mitad del camino! üõ§Ô∏è Ya puedes ver la meta.', 'üéØ');
            }

            // Check yesterday's progress
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().split('T')[0];
            const yesterdayCompleted = JSON.parse(getStorage(`completed-${yesterdayKey}`) || '[]');

            if (yesterdayCompleted.length >= 10) {
                addNotification('¬°Ayer completaste muchas actividades! üî• Excelente trabajo.', '‚≠ê');
            }

            // Motivational based on day of week
            const dayOfWeek = new Date().getDay();
            if (dayOfWeek === 1) { // Monday
                addNotification('¬°Nuevo lunes, nuevas oportunidades! üí™ A darle con todo.', 'üåÖ');
            } else if (dayOfWeek === 5) { // Friday
                addNotification('¬°Viernes! Termina fuerte la semana. üéâ', 'üéä');
            }
        }

        // Call this when app loads
        setTimeout(() => {
            generateDailyNotifications();
            updateNotificationBadge();
        }, 1000);

        // ==================== END NOTIFICATIONS ====================

        // Profile Photo Functions
        let cropperState = {
            image: null,
            imgWidth: 0,
            imgHeight: 0,
            posX: 0,
            posY: 0,
            zoom: 100,
            isDragging: false,
            startX: 0,
            startY: 0,
            containerSize: 192 // 48 * 4 = w-48
        };

        function openPhotoModal() {
            const modal = document.getElementById('photoModal');
            const preview = document.getElementById('photoPreview');
            const removeBtn = document.getElementById('removePhotoBtn');
            const photo = getStorage('profile-photo');

            // Mostrar vista normal, ocultar editor
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');

            if (photo) {
                preview.innerHTML = `<img src="${photo}" class="w-full h-full object-cover">`;
                removeBtn.classList.remove('hidden');
            } else {
                preview.innerHTML = currentUser.name.charAt(0).toUpperCase();
                removeBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (max 15MB original)
            if (file.size > 15 * 1024 * 1024) {
                alert('La imagen es muy grande. M√°ximo 15MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Guardar imagen original
                    cropperState.image = img;
                    cropperState.imgWidth = img.width;
                    cropperState.imgHeight = img.height;
                    cropperState.zoom = 100;

                    // Mostrar editor
                    showCropperEditor(e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Limpiar input para permitir subir la misma imagen
            event.target.value = '';
        }

        function showCropperEditor(imageSrc) {
            // Ocultar vista normal, mostrar editor
            document.getElementById('photoNormalView').classList.add('hidden');
            document.getElementById('photoEditView').classList.remove('hidden');

            const cropperImg = document.getElementById('cropperImage');
            cropperImg.src = imageSrc;

            // Resetear zoom
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomValue').textContent = '100%';
            cropperState.zoom = 100;

            // Calcular tama√±o inicial para que cubra el contenedor
            setTimeout(() => {
                const container = cropperState.containerSize;
                const imgRatio = cropperState.imgWidth / cropperState.imgHeight;

                let displayWidth, displayHeight;
                if (imgRatio > 1) {
                    // Imagen horizontal
                    displayHeight = container;
                    displayWidth = container * imgRatio;
                } else {
                    // Imagen vertical o cuadrada
                    displayWidth = container;
                    displayHeight = container / imgRatio;
                }

                cropperImg.style.width = displayWidth + 'px';
                cropperImg.style.height = displayHeight + 'px';

                // Centrar imagen
                cropperState.posX = (container - displayWidth) / 2;
                cropperState.posY = (container - displayHeight) / 2;
                updateCropperPosition();
            }, 50);
        }

        function updateCropperPosition() {
            const cropperImg = document.getElementById('cropperImage');
            cropperImg.style.left = cropperState.posX + 'px';
            cropperImg.style.top = cropperState.posY + 'px';
        }

        function updateZoom(value) {
            const zoomFactor = value / cropperState.zoom;
            cropperState.zoom = parseInt(value);
            document.getElementById('zoomValue').textContent = value + '%';

            const cropperImg = document.getElementById('cropperImage');
            const container = cropperState.containerSize;
            const imgRatio = cropperState.imgWidth / cropperState.imgHeight;

            let baseWidth, baseHeight;
            if (imgRatio > 1) {
                baseHeight = container;
                baseWidth = container * imgRatio;
            } else {
                baseWidth = container;
                baseHeight = container / imgRatio;
            }

            const newWidth = baseWidth * (value / 100);
            const newHeight = baseHeight * (value / 100);

            // Ajustar posici√≥n para mantener el centro
            const centerX = cropperState.posX + parseFloat(cropperImg.style.width) / 2;
            const centerY = cropperState.posY + parseFloat(cropperImg.style.height) / 2;

            cropperState.posX = centerX - newWidth / 2;
            cropperState.posY = centerY - newHeight / 2;

            cropperImg.style.width = newWidth + 'px';
            cropperImg.style.height = newHeight + 'px';
            updateCropperPosition();
        }

        function startDrag(e) {
            e.preventDefault();
            cropperState.isDragging = true;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropperState.startX = clientX - cropperState.posX;
            cropperState.startY = clientY - cropperState.posY;

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function doDrag(e) {
            if (!cropperState.isDragging) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropperState.posX = clientX - cropperState.startX;
            cropperState.posY = clientY - cropperState.startY;
            updateCropperPosition();
        }

        function stopDrag() {
            cropperState.isDragging = false;
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', doDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        function cancelCrop() {
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');
        }

        function saveCrop() {
            const container = cropperState.containerSize;
            const cropperImg = document.getElementById('cropperImage');

            // Crear canvas para recortar
            const canvas = document.createElement('canvas');
            const outputSize = 400; // Tama√±o final (mayor = mejor calidad)
            canvas.width = outputSize;
            canvas.height = outputSize;
            const ctx = canvas.getContext('2d');

            // Calcular qu√© parte de la imagen original recortar
            const displayWidth = parseFloat(cropperImg.style.width);
            const displayHeight = parseFloat(cropperImg.style.height);
            const scaleX = cropperState.imgWidth / displayWidth;
            const scaleY = cropperState.imgHeight / displayHeight;

            const srcX = -cropperState.posX * scaleX;
            const srcY = -cropperState.posY * scaleY;
            const srcSize = container * scaleX;

            // Dibujar la porci√≥n recortada
            ctx.drawImage(
                cropperState.image,
                srcX, srcY, srcSize, srcSize,
                0, 0, outputSize, outputSize
            );

            // Comprimir con alta calidad
            let photoData = canvas.toDataURL('image/jpeg', 0.92);
            let sizeKB = (photoData.length * 3/4) / 1024;

            // Reducir calidad solo si excede 150KB
            let quality = 0.92;
            while (sizeKB > 150 && quality > 0.5) {
                quality -= 0.05;
                photoData = canvas.toDataURL('image/jpeg', quality);
                sizeKB = (photoData.length * 3/4) / 1024;
            }

            console.log(`Foto guardada: ${Math.round(sizeKB)}KB (calidad: ${Math.round(quality*100)}%)`);

            // Guardar
            setStorage('profile-photo', photoData);

            // Actualizar preview y cerrar editor
            document.getElementById('photoPreview').innerHTML = `<img src="${photoData}" class="w-full h-full object-cover">`;
            document.getElementById('removePhotoBtn').classList.remove('hidden');
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');

            render();
        }

        function removePhoto() {
            if (confirm('¬øEliminar foto de perfil?')) {
                removeStorage('profile-photo');
                document.getElementById('photoPreview').innerHTML = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('removePhotoBtn').classList.add('hidden');
                render();
            }
        }

        function getUserPhoto() {
            return getStorage('profile-photo');
        }

        // Replace All Modal Functions
        let pendingReplaceAll = null; // { type, oldValue, newValue, callback }

        function showReplaceAllModal(type, message, callback) {
            pendingReplaceAll = { type, callback };
            document.getElementById('replaceAllMessage').textContent = message;
            document.getElementById('replaceAllModal').classList.remove('hidden');
        }

        function closeReplaceAllModal() {
            document.getElementById('replaceAllModal').classList.add('hidden');
            pendingReplaceAll = null;
        }

        function confirmReplaceAll(replaceAll) {
            if (pendingReplaceAll && pendingReplaceAll.callback) {
                pendingReplaceAll.callback(replaceAll);
            }
            closeReplaceAllModal();
            render();
        }

        // Goal text mapping
        function getGoalText(goal) {
            const goals = {
                fitness: 'üí™ Mejorando mi f√≠sico',
                productivity: 'üìà Siendo m√°s productivo',
                learning: 'üìö Aprendiendo algo nuevo',
                health: 'ü•ó Mejorando mi salud',
                business: 'üíº Haciendo crecer mi negocio',
                competition: 'üëë Prepar√°ndome para competir',
                personal: '‚ú® Desarrollo personal',
                other: 'üéØ Alcanzando mis metas'
            };
            return goals[goal] || goals.other;
        }

        // Data - User specific dates based on their plan
        const userStartDate = currentUser ? new Date(currentUser.startDate) : new Date();
        const userDuration = currentUser ? currentUser.duration : 60;
        const totalWeeks = Math.ceil(userDuration / 7);
        const startDate = new Date(userStartDate);
        const endDate = new Date(userStartDate);
        endDate.setDate(endDate.getDate() + userDuration - 1);

        let currentDate = new Date();
        // Clamp current date to plan range
        if (currentDate < startDate) currentDate = new Date(startDate);
        if (currentDate > endDate) currentDate = new Date(endDate);

        let activeTab = 'agenda';
        let checkedHabits = JSON.parse(getStorage('habits') || '{}');
        let completedActivities = JSON.parse(getStorage('activities') || '{}');
        let customSchedules = JSON.parse(getStorage('custom-schedules') || '{}');
        let customHabits = JSON.parse(getStorage('custom-habits') || 'null');
        let customGym = JSON.parse(getStorage('custom-gym') || '{}');
        let customMeals = JSON.parse(getStorage('custom-meals') || 'null');
        let customGoals = JSON.parse(getStorage('custom-goals') || 'null');

        let editingIndex = null;
        let deletingIndex = null;
        let deleteType = 'activity';

        // Search and Filter state
        let searchQuery = '';
        let activeFilter = '';

        // Dashboard visibility state
        let dashboardVisible = getStorage('dashboard-visible') !== 'false';

        const daysSpanish = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const monthsSpanish = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        const defaultGymFocus = {
            0: { name: "Descanso Activo", icon: "üßò", exercises: ["Yoga suave 30-45min", "Estiramientos profundos 20min", "Caminata ligera opcional", "Meditaci√≥n con movimiento 15min"] },
            1: { name: "Gl√∫teos + Cu√°driceps", icon: "üçë", exercises: ["Hip Thrust con barra 4x12", "Sentadilla profunda 4x10", "Prensa inclinada 4x12", "Zancadas caminando 3x12", "Extensi√≥n cu√°driceps 3x15", "Abductores m√°quina 3x20"] },
            2: { name: "Isquios + Gl√∫teos", icon: "ü¶µ", exercises: ["Peso muerto rumano 4x10", "Curl femoral acostada 4x12", "Patada gl√∫teo polea 3x15", "Puente gl√∫teos elevado 4x15", "Good mornings 3x12", "Hip abduction 3x20"] },
            3: { name: "Tren Superior + Core", icon: "üí™", exercises: ["Press pecho mancuernas 3x12", "Remo mancuerna 3x12", "Press hombro 3x12", "Curl b√≠ceps 3x15", "Tr√≠ceps polea 3x15", "Plancha 3x30seg + Crunches 3x20"] },
            4: { name: "Piernas + HIIT", icon: "üî•", exercises: ["Sentadilla b√∫lgara 4x10", "Leg press pies juntos 4x12", "Step ups con peso 3x12", "Curl femoral sentada 3x15", "HIIT: Burpees, Jumping jacks 4 rondas"] },
            5: { name: "Gl√∫teos (√©nfasis) + Brazos", icon: "‚ú®", exercises: ["Hip thrust unilateral 4x12", "Sumo squat mancuerna 4x15", "Kickbacks polea 3x15", "Frog pumps 3x25", "Curl martillo 3x12", "Fondos tr√≠ceps 3x12"] },
            6: { name: "Baile + Stretching", icon: "üíÉ", exercises: ["Clase baile/gimnasia 60-90min", "Estiramiento din√°mico 15min", "Foam roller piernas 15min", "Yoga flow 20min"] }
        };

        function getGymFocus(dayIndex) {
            if (customGym[dayIndex]) {
                return customGym[dayIndex];
            }
            return defaultGymFocus[dayIndex];
        }

        const defaultHabits = [
            { id: 1, name: "Despertar 7:00 AM", icon: "‚òÄÔ∏è" },
            { id: 2, name: "Agua al despertar (500ml)", icon: "üíß" },
            { id: 3, name: "Suplementos tomados", icon: "üíä" },
            { id: 4, name: "Meditaci√≥n 30 min", icon: "üßò" },
            { id: 5, name: "Afirmaciones positivas", icon: "‚ú®" },
            { id: 6, name: "Desayuno proteico", icon: "ü•ó" },
            { id: 7, name: "Clase de ingl√©s", icon: "üá¨üáß" },
            { id: 8, name: "Skincare AM", icon: "üß¥" },
            { id: 9, name: "Entrenamiento completado", icon: "üí™" },
            { id: 10, name: "Post-entreno proteico", icon: "ü•§" },
            { id: 11, name: "Contenido RRSS creado", icon: "üì∏" },
            { id: 12, name: "Publicado en RRSS", icon: "üì±" },
            { id: 13, name: "Interacci√≥n audiencia", icon: "üí¨" },
            { id: 14, name: "Cena sin az√∫car", icon: "ü•¶" },
            { id: 15, name: "Skincare PM + celulitis", icon: "üåô" },
            { id: 16, name: "Gratitud (3 cosas)", icon: "üôè" },
            { id: 17, name: "En cama 22:00", icon: "üò¥" },
            { id: 18, name: "3L agua bebidos", icon: "üí¶" }
        ];

        function getHabits() {
            return customHabits || defaultHabits;
        }

        const defaultMeals = [
            { time: "07:45", name: "Desayuno", emoji: "üåÖ", options: ["Avena + prote√≠na + frutos rojos", "Huevos revueltos + verduras + tostada integral", "Smoothie bowl proteico con semillas"], macros: "P:30g | C:45g | G:15g" },
            { time: "10:30", name: "Snack AM", emoji: "üçé", options: ["Yogurt griego + nueces", "Fruta + almendras", "Batido verde proteico"], macros: "P:15g | C:20g | G:10g" },
            { time: "12:00", name: "Almuerzo", emoji: "ü•ó", options: ["Prote√≠na 150g (pollo/pescado/pavo)", "Carbohidrato complejo 1 taza", "Vegetales variados ilimitados", "Grasa saludable (aguacate)"], macros: "P:40g | C:50g | G:15g" },
            { time: "16:00", name: "Post-Entreno", emoji: "üí™", options: ["Prote√≠na whey + banana + leche vegetal", "Yogurt griego + granola sin az√∫car"], macros: "P:30g | C:30g | G:5g" },
            { time: "20:00", name: "Cena", emoji: "üåô", options: ["Prote√≠na magra 120g", "Vegetales al vapor o ensalada grande", "Sin carbohidratos pesados"], macros: "P:35g | C:20g | G:12g" }
        ];

        function getMeals() {
            return customMeals || defaultMeals;
        }

        const defaultWeeklyGoals = [
            { week: 1, dates: "2-8 Feb", fisica: "Establecer rutina gym. Medir peso inicial", personal: "Inicio ingl√©s intensivo + pasarela", digital: "Crear web b√°sica", espiritual: "Establecer meditaci√≥n diaria" },
            { week: 2, dates: "9-15 Feb", fisica: "Ajustar plan nutricional. -0.5kg grasa", personal: "Mejorar pronunciaci√≥n ingl√©s", digital: "5 posts. Contactar marcas", espiritual: "Journaling diario" },
            { week: 3, dates: "16-22 Feb", fisica: "Incrementar peso en gl√∫teos", personal: "Conversaciones b√°sicas ingl√©s", digital: "12K seguidores. Portafolio", espiritual: "Bajar autoexigencia" },
            { week: 4, dates: "23 Feb-1 Mar", fisica: "Definici√≥n visible piernas", personal: "Presentaci√≥n en ingl√©s", digital: "15K. Primera colaboraci√≥n", espiritual: "Sin episodios nerviosismo" },
            { week: 5, dates: "2-8 Mar", fisica: "Abdominales marcados", personal: "Fluidez conversacional", digital: "Blog semanal. 5%+ engagement", espiritual: "Manejo emocional estable" },
            { week: 6, dates: "9-15 Mar", fisica: "Gl√∫teos definidos. Verificar 58kg", personal: "Speech en ingl√©s listo", digital: "17K. Contenido viral", espiritual: "Autoconfianza alta" },
            { week: 7, dates: "16-22 Mar", fisica: "Cuerpo √≥ptimo. Piel radiante", personal: "Ingl√©s intermedio-alto", digital: "19K. Portafolio completo", espiritual: "Nervios controlados" },
            { week: 8, dates: "23-30 Mar", fisica: "üéØ 58kg, definici√≥n total", personal: "üéØ Ingl√©s fluido, pasarela 100%", digital: "üéØ 20K+, marca s√≥lida", espiritual: "üéØ Confianza total" }
        ];

        function getWeeklyGoals() {
            return customGoals || defaultWeeklyGoals;
        }

        // Community Templates - Plantillas de usuarios que otros pueden cargar
        const communityTemplates = [
            {
                id: 'arantxa_miss_universo',
                name: 'Plan Miss Universo - Arantxa',
                author: 'Arantxa Ram√≠rez',
                description: 'Plan de 90 d√≠as para preparaci√≥n Miss Universo: fitness, ingl√©s, pasarela y redes sociales.',
                icon: 'üëë',
                duration: 90,
                goal: 'salud',
                gymFocus: {
                    0: { name: "Descanso Activo", icon: "üßò", exercises: ["Yoga suave 30-45min", "Estiramientos profundos 20min", "Caminata ligera opcional", "Meditaci√≥n con movimiento 15min"] },
                    1: { name: "Gl√∫teos + Cu√°driceps", icon: "üçë", exercises: ["Hip Thrust con barra 4x12", "Sentadilla profunda 4x10", "Prensa inclinada 4x12", "Zancadas caminando 3x12", "Extensi√≥n cu√°driceps 3x15", "Abductores m√°quina 3x20"] },
                    2: { name: "Isquios + Gl√∫teos", icon: "ü¶µ", exercises: ["Peso muerto rumano 4x10", "Curl femoral acostada 4x12", "Patada gl√∫teo polea 3x15", "Puente gl√∫teos elevado 4x15", "Good mornings 3x12", "Hip abduction 3x20"] },
                    3: { name: "Tren Superior + Core", icon: "üí™", exercises: ["Press pecho mancuernas 3x12", "Remo mancuerna 3x12", "Press hombro 3x12", "Curl b√≠ceps 3x15", "Tr√≠ceps polea 3x15", "Plancha 3x30seg + Crunches 3x20"] },
                    4: { name: "Piernas + HIIT", icon: "üî•", exercises: ["Sentadilla b√∫lgara 4x10", "Leg press pies juntos 4x12", "Step ups con peso 3x12", "Curl femoral sentada 3x15", "HIIT: Burpees, Jumping jacks 4 rondas"] },
                    5: { name: "Gl√∫teos (√©nfasis) + Brazos", icon: "‚ú®", exercises: ["Hip thrust unilateral 4x12", "Sumo squat mancuerna 4x15", "Kickbacks polea 3x15", "Frog pumps 3x25", "Curl martillo 3x12", "Fondos tr√≠ceps 3x12"] },
                    6: { name: "Baile + Stretching", icon: "üíÉ", exercises: ["Clase baile/gimnasia 60-90min", "Estiramiento din√°mico 15min", "Foam roller piernas 15min", "Yoga flow 20min"] }
                },
                habits: [
                    { id: 1, name: "Despertar 7:00 AM", icon: "‚òÄÔ∏è" },
                    { id: 2, name: "Agua al despertar (500ml)", icon: "üíß" },
                    { id: 3, name: "Suplementos tomados", icon: "üíä" },
                    { id: 4, name: "Meditaci√≥n 30 min", icon: "üßò" },
                    { id: 5, name: "Afirmaciones positivas", icon: "‚ú®" },
                    { id: 6, name: "Desayuno proteico", icon: "ü•ó" },
                    { id: 7, name: "Clase de ingl√©s", icon: "üá¨üáß" },
                    { id: 8, name: "Skincare AM", icon: "üß¥" },
                    { id: 9, name: "Entrenamiento completado", icon: "üí™" },
                    { id: 10, name: "Post-entreno proteico", icon: "ü•§" },
                    { id: 11, name: "Contenido RRSS creado", icon: "üì∏" },
                    { id: 12, name: "Publicado en RRSS", icon: "üì±" },
                    { id: 13, name: "Interacci√≥n audiencia", icon: "üí¨" },
                    { id: 14, name: "Cena sin az√∫car", icon: "ü•¶" },
                    { id: 15, name: "Skincare PM + celulitis", icon: "üåô" },
                    { id: 16, name: "Gratitud (3 cosas)", icon: "üôè" },
                    { id: 17, name: "En cama 22:00", icon: "üò¥" },
                    { id: 18, name: "3L agua bebidos", icon: "üí¶" }
                ],
                meals: [
                    { time: "07:45", name: "Desayuno", emoji: "üåÖ", options: ["Avena + prote√≠na + frutos rojos", "Huevos revueltos + verduras + tostada integral", "Smoothie bowl proteico con semillas"], macros: "P:30g | C:45g | G:15g" },
                    { time: "10:30", name: "Snack AM", emoji: "üçé", options: ["Yogurt griego + nueces", "Fruta + almendras", "Batido verde proteico"], macros: "P:15g | C:20g | G:10g" },
                    { time: "12:00", name: "Almuerzo", emoji: "ü•ó", options: ["Prote√≠na 150g (pollo/pescado/pavo)", "Carbohidrato complejo 1 taza", "Vegetales variados ilimitados", "Grasa saludable (aguacate)"], macros: "P:40g | C:50g | G:15g" },
                    { time: "16:00", name: "Post-Entreno", emoji: "üí™", options: ["Prote√≠na whey + banana + leche vegetal", "Yogurt griego + granola sin az√∫car"], macros: "P:30g | C:30g | G:5g" },
                    { time: "20:00", name: "Cena", emoji: "üåô", options: ["Prote√≠na magra 120g", "Vegetales al vapor o ensalada grande", "Sin carbohidratos pesados"], macros: "P:35g | C:20g | G:12g" }
                ],
                weeklyGoals: [
                    { week: 1, dates: "Semana 1", fisica: "Establecer rutina gym. Medir peso inicial", personal: "Inicio ingl√©s intensivo + pasarela", digital: "Crear web b√°sica", espiritual: "Establecer meditaci√≥n diaria" },
                    { week: 2, dates: "Semana 2", fisica: "Ajustar plan nutricional. -0.5kg grasa", personal: "Mejorar pronunciaci√≥n ingl√©s", digital: "5 posts. Contactar marcas", espiritual: "Journaling diario" },
                    { week: 3, dates: "Semana 3", fisica: "Incrementar peso en gl√∫teos", personal: "Conversaciones b√°sicas ingl√©s", digital: "12K seguidores. Portafolio", espiritual: "Bajar autoexigencia" },
                    { week: 4, dates: "Semana 4", fisica: "Definici√≥n visible piernas", personal: "Presentaci√≥n en ingl√©s", digital: "15K. Primera colaboraci√≥n", espiritual: "Sin episodios nerviosismo" },
                    { week: 5, dates: "Semana 5", fisica: "Abdominales marcados", personal: "Fluidez conversacional", digital: "Blog semanal. 5%+ engagement", espiritual: "Manejo emocional estable" },
                    { week: 6, dates: "Semana 6", fisica: "Gl√∫teos definidos. Verificar 58kg", personal: "Speech en ingl√©s listo", digital: "17K. Contenido viral", espiritual: "Autoconfianza alta" },
                    { week: 7, dates: "Semana 7", fisica: "Cuerpo √≥ptimo. Piel radiante", personal: "Ingl√©s intermedio-alto", digital: "19K. Portafolio completo", espiritual: "Nervios controlados" },
                    { week: 8, dates: "Semana 8", fisica: "üéØ 58kg, definici√≥n total", personal: "üéØ Ingl√©s fluido, pasarela 100%", digital: "üéØ 20K+, marca s√≥lida", espiritual: "üéØ Confianza total" }
                ]
            }
        ];

        const categoryColors = {
            habitos: { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-700", badge: "bg-amber-100" },
            nutricion: { bg: "bg-green-50", border: "border-green-200", text: "text-green-700", badge: "bg-green-100" },
            fisico: { bg: "bg-rose-50", border: "border-rose-200", text: "text-rose-700", badge: "bg-rose-100" },
            personal: { bg: "bg-blue-50", border: "border-blue-200", text: "text-blue-700", badge: "bg-blue-100" },
            digital: { bg: "bg-purple-50", border: "border-purple-200", text: "text-purple-700", badge: "bg-purple-100" },
            espiritual: { bg: "bg-indigo-50", border: "border-indigo-200", text: "text-indigo-700", badge: "bg-indigo-100" },
            descanso: { bg: "bg-slate-50", border: "border-slate-200", text: "text-slate-700", badge: "bg-slate-100" }
        };

        function getDefaultSchedule(dayIndex) {
            if (dayIndex === 0) return getSundaySchedule();
            if (dayIndex === 6) return getSaturdaySchedule();
            return getWeekdaySchedule(dayIndex);
        }

        function getSchedule(dayIndex = currentDate.getDay(), dateKey = getDateKey(currentDate)) {
            if (customSchedules[dateKey]) {
                return customSchedules[dateKey];
            }
            return getDefaultSchedule(dayIndex);
        }

        function saveCustomSchedule(dateKey, schedule) {
            customSchedules[dateKey] = schedule;
            setStorage('custom-schedules', JSON.stringify(customSchedules));
        }

        function getWeekdaySchedule(dayIndex) {
            const gym = getGymFocus(dayIndex);
            const schedule = [
                { time: "06:45", activity: "Despertar + Agua tibia con lim√≥n üçã", duration: "15 min", category: "habitos" },
                { time: "07:00", activity: "Suplementos: Creatina + Omega 3 + Vitamina C", duration: "15 min", category: "nutricion" },
                { time: "07:15", activity: "Meditaci√≥n guiada + Afirmaciones ‚ú®", duration: "30 min", category: "espiritual" },
                { time: "07:45", activity: "Desayuno proteico", duration: "45 min", category: "nutricion" },
                { time: "08:30", activity: "Clase de Ingl√©s Intensivo üá¨üáß", duration: "2 hrs", category: "personal" },
                { time: "10:30", activity: "Snack saludable + Hidrataci√≥n", duration: "30 min", category: "nutricion" },
                { time: "11:00", activity: "Skincare facial + Cuidado capilar üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "fisico" },
                { time: "12:00", activity: "Almuerzo balanceado", duration: "1 hr", category: "nutricion" },
                { time: "13:00", activity: "Descanso / Lectura / Journaling üìñ", duration: "1 hr", category: "espiritual" },
                { time: "14:00", activity: `Gimnasio: ${gym.name} ${gym.icon}`, duration: "2 hrs", category: "fisico" },
                { time: "16:00", activity: "Batido proteico post-entreno ü•§", duration: "30 min", category: "nutricion" }
            ];

            if ([1, 3, 5].includes(dayIndex)) {
                schedule.push({ time: "16:30", activity: "Clase de Pasarela (estilo Sheynnis Palacios) üë†", duration: "1.5 hrs", category: "personal" });
            } else {
                schedule.push({ time: "16:30", activity: "Coaching Oratoria con Coni üé§", duration: "1.5 hrs", category: "personal" });
            }

            schedule.push(
                { time: "18:00", activity: "Creaci√≥n contenido RRSS üì∏", duration: "1 hr", category: "digital" },
                { time: "19:00", activity: "Publicar + Interactuar audiencia üì±", duration: "30 min", category: "digital" },
                { time: "19:30", activity: "Revisar m√©tricas + Planificar üìä", duration: "30 min", category: "digital" },
                { time: "20:00", activity: "Cena saludable", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Skincare nocturno + Tratamiento celulitis üåô", duration: "30 min", category: "fisico" },
                { time: "21:30", activity: "Gratitud + Preparar ma√±ana üôè", duration: "30 min", category: "espiritual" },
                { time: "22:00", activity: "DORMIR üò¥ (9 horas)", duration: "9 hrs", category: "descanso" }
            );

            return schedule;
        }

        function getSaturdaySchedule() {
            return [
                { time: "07:00", activity: "Despertar + Hidrataci√≥n üíß", duration: "15 min", category: "habitos" },
                { time: "07:15", activity: "Suplementos matutinos", duration: "15 min", category: "nutricion" },
                { time: "07:30", activity: "Meditaci√≥n + Afirmaciones ‚ú®", duration: "30 min", category: "espiritual" },
                { time: "08:00", activity: "Desayuno proteico", duration: "1 hr", category: "nutricion" },
                { time: "09:00", activity: "Clase de Baile / Gimnasia üíÉ", duration: "1.5 hrs", category: "personal" },
                { time: "10:30", activity: "Snack + Hidrataci√≥n", duration: "30 min", category: "nutricion" },
                { time: "11:00", activity: "Sesi√≥n fotos / Contenido semanal üì∏", duration: "2 hrs", category: "digital" },
                { time: "13:00", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                { time: "14:00", activity: "Descanso / Autocuidado üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "espiritual" },
                { time: "15:00", activity: "Trabajo en P√°gina Web / Portafolio üíª", duration: "2 hrs", category: "digital" },
                { time: "17:00", activity: "Cardio suave + Stretching üßò", duration: "1 hr", category: "fisico" },
                { time: "18:00", activity: "Programar contenido semanal", duration: "1 hr", category: "digital" },
                { time: "19:00", activity: "Tiempo libre / Social üëØ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "personal" },
                { time: "20:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Rutina nocturna + Planificaci√≥n üåô", duration: "1 hr", category: "espiritual" },
                { time: "22:00", activity: "DORMIR üò¥", duration: "9 hrs", category: "descanso" }
            ];
        }

        function getSundaySchedule() {
            return [
                { time: "08:00", activity: "Despertar natural + Hidrataci√≥n ‚òÄÔ∏è", duration: "15 min", category: "habitos" },
                { time: "08:15", activity: "Omega 3 + Vitamina C (descanso creatina)", duration: "15 min", category: "nutricion" },
                { time: "08:30", activity: "Meditaci√≥n extendida + Visualizaci√≥n üßò", duration: "1 hr", category: "espiritual" },
                { time: "09:30", activity: "Brunch saludable ü•ë", duration: "1 hr", category: "nutricion" },
                { time: "10:30", activity: "Spa personal: mascarillas, tratamientos ‚ú®", duration: "1.5 hrs", category: "fisico" },
                { time: "12:00", activity: "Revisar metas + Ajustar plan üéØ", duration: "1 hr", category: "personal" },
                { time: "13:00", activity: "Almuerzo liviano", duration: "1 hr", category: "nutricion" },
                { time: "14:00", activity: "Siesta / Descanso profundo üò¥", duration: "1 hr", category: "descanso" },
                { time: "15:00", activity: "Yoga + Stretching profundo üßò", duration: "1 hr", category: "fisico" },
                { time: "16:00", activity: "Ingl√©s: pel√≠culas/series üé¨", duration: "1 hr", category: "personal" },
                { time: "17:00", activity: "Preparar outfits de la semana üëó", duration: "1 hr", category: "personal" },
                { time: "18:00", activity: "RRSS: Responder mensajes + Stories üì±", duration: "1 hr", category: "digital" },
                { time: "19:00", activity: "Tiempo familiar / Social üíï", duration: "1 hr", category: "personal" },
                { time: "20:00", activity: "Cena liviana", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Rutina nocturna üåô", duration: "30 min", category: "fisico" },
                { time: "21:30", activity: "Lectura + Gratitud + Intenciones ‚ú®", duration: "30 min", category: "espiritual" },
                { time: "22:00", activity: "DORMIR üò¥", duration: "9 hrs", category: "descanso" }
            ];
        }

        function getDateKey(date = currentDate) {
            return date.toISOString().split('T')[0];
        }

        function getWeekNumber(date = currentDate) {
            return Math.min(totalWeeks, Math.max(1, Math.floor((date - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1));
        }

        function getDayNumber(date = currentDate) {
            return Math.floor((date - startDate) / (24 * 60 * 60 * 1000)) + 1;
        }

        function getDailyProgress(date = currentDate) {
            const dateKey = getDateKey(date);
            const schedule = getSchedule(date.getDay(), dateKey);
            const totalActivities = schedule.length;
            if (totalActivities === 0) return 0;
            let completed = 0;

            for (let i = 0; i < totalActivities; i++) {
                if (completedActivities[`${dateKey}-${i}`]) {
                    completed++;
                }
            }

            return Math.round((completed / totalActivities) * 100);
        }

        function getWeeklyProgress() {
            const weekNum = getWeekNumber();
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (weekNum - 1) * 7);

            let totalActivities = 0;
            let completedCount = 0;

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + i);

                if (dayDate > endDate) break;

                const dateKey = getDateKey(dayDate);
                const schedule = getSchedule(dayDate.getDay(), dateKey);
                totalActivities += schedule.length;

                for (let j = 0; j < schedule.length; j++) {
                    if (completedActivities[`${dateKey}-${j}`]) {
                        completedCount++;
                    }
                }
            }

            return totalActivities > 0 ? Math.round((completedCount / totalActivities) * 100) : 0;
        }

        function getTotalProgress() {
            let totalActivities = 0;
            let completedCount = 0;

            const tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                const dateKey = getDateKey(tempDate);
                const schedule = getSchedule(tempDate.getDay(), dateKey);
                totalActivities += schedule.length;

                for (let j = 0; j < schedule.length; j++) {
                    if (completedActivities[`${dateKey}-${j}`]) {
                        completedCount++;
                    }
                }

                tempDate.setDate(tempDate.getDate() + 1);
            }

            return totalActivities > 0 ? Math.round((completedCount / totalActivities) * 100) : 0;
        }

        // Calcular racha de d√≠as consecutivos con 100%
        function getStreak() {
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Empezar desde ayer (o hoy si ya complet√≥)
            const checkDate = new Date(today);

            // Si hoy a√∫n no tiene 100%, empezar desde ayer
            const todayProgress = getDailyProgress(today);
            if (todayProgress < 100) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // Contar d√≠as hacia atr√°s con 100%
            while (checkDate >= startDate) {
                const dayProgress = getDailyProgress(checkDate);
                if (dayProgress === 100) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        // Calcular mejor racha hist√≥rica
        function getBestStreak() {
            let bestStreak = 0;
            let currentStreak = 0;

            const tempDate = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            while (tempDate <= today && tempDate <= endDate) {
                const dayProgress = getDailyProgress(tempDate);
                if (dayProgress === 100) {
                    currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            return bestStreak;
        }

        function navigateDay(direction) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + direction);
            if (newDate >= startDate && newDate <= endDate) {
                currentDate = newDate;
                render();
            }
        }

        // Calendar Modal Functions
        let calendarMonth = new Date();

        function openCalendarModal() {
            calendarMonth = new Date(currentDate);
            renderCalendar();
            document.getElementById('calendarModal').classList.remove('hidden');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.add('hidden');
        }

        function changeCalendarMonth(direction) {
            calendarMonth.setMonth(calendarMonth.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            document.getElementById('calendarTitle').textContent =
                `${monthNames[calendarMonth.getMonth()]} ${calendarMonth.getFullYear()}`;

            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            // Primer d√≠a del mes
            const firstDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), 1);
            const lastDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0);

            // D√≠as vac√≠os al inicio
            for (let i = 0; i < firstDay.getDay(); i++) {
                container.innerHTML += '<div></div>';
            }

            // D√≠as del mes
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), day);
                const isInRange = date >= startDate && date <= endDate;
                const isSelected = date.toDateString() === currentDate.toDateString();
                const isToday = date.toDateString() === new Date().toDateString();

                let classes = 'w-10 h-10 flex items-center justify-center rounded-full text-sm transition ';

                if (!isInRange) {
                    classes += 'text-gray-300 cursor-not-allowed';
                } else if (isSelected) {
                    classes += 'bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold cursor-pointer';
                } else if (isToday) {
                    classes += 'border-2 border-purple-400 text-purple-600 font-medium cursor-pointer hover:bg-purple-50';
                } else {
                    classes += 'text-gray-700 cursor-pointer hover:bg-gray-100';
                }

                container.innerHTML += `
                    <button class="${classes}"
                            ${isInRange ? `onclick="selectDate(${date.getFullYear()}, ${date.getMonth()}, ${day})"` : 'disabled'}>
                        ${day}
                    </button>
                `;
            }
        }

        function selectDate(year, month, day) {
            currentDate = new Date(year, month, day);
            closeCalendarModal();
            render();
        }

        function goToToday() {
            const today = new Date();
            if (today >= startDate && today <= endDate) {
                currentDate = today;
                closeCalendarModal();
                render();
            } else {
                alert('Hoy est√° fuera del rango de tu plan');
            }
        }

        // Congratulations Modal Functions
        const congratsShown = JSON.parse(getStorage('congrats-shown') || '{}');

        function closeCongratsModal() {
            document.getElementById('congratsModal').classList.add('hidden');
        }

        function showCongrats(type, emoji, title, message) {
            document.getElementById('congratsEmoji').textContent = emoji;
            document.getElementById('congratsTitle').textContent = title;
            document.getElementById('congratsMessage').textContent = message;
            document.getElementById('congratsModal').classList.remove('hidden');

            // Mostrar celebraci√≥n extra grande
            showBigCelebration();
        }

        function showBigCelebration() {
            const emojis = ['üéâ', 'üéä', 'ü•≥', '‚≠ê', '‚ú®', 'üåü', 'üèÜ', 'üëë', 'üí™', 'üî•', 'üíñ', 'üéÜ', 'üéá'];
            const container = document.createElement('div');
            container.className = 'fixed inset-0 pointer-events-none z-[150]';
            document.body.appendChild(container);

            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.cssText = `
                        position: absolute;
                        font-size: ${30 + Math.random() * 40}px;
                        left: ${Math.random() * 100}%;
                        top: -60px;
                        animation: celebrationFall 2s ease-out forwards;
                    `;
                    container.appendChild(emoji);
                }, i * 80);
            }

            setTimeout(() => container.remove(), 3500);
        }

        function checkAndShowCongrats(dailyProgress, weeklyProgress, totalProgress) {
            const dateKey = getDateKey();
            const weekKey = `week-${getWeekNumber()}`;

            // D√≠a completo (100%)
            if (dailyProgress === 100 && !congratsShown[dateKey]) {
                congratsShown[dateKey] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('day', 'üåü', '¬°D√≠a completado!',
                        '¬°Incre√≠ble! Completaste todas las tareas del d√≠a. ¬°Sigue as√≠!');
                }, 500);
                return;
            }

            // Semana completa (100%)
            if (weeklyProgress === 100 && !congratsShown[weekKey]) {
                congratsShown[weekKey] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('week', 'üèÜ', '¬°Semana perfecta!',
                        '¬°WOW! Completaste toda la semana. ¬°Eres imparable!');
                }, 500);
                return;
            }

            // Plan completo (100%)
            if (totalProgress === 100 && !congratsShown['plan-complete']) {
                congratsShown['plan-complete'] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('plan', 'üëë', '¬°¬°PLAN COMPLETADO!!',
                        '¬°LO LOGRASTE! Completaste todo tu plan. ¬°Eres una leyenda! üéâüéäü•≥');
                }, 500);
                return;
            }
        }

        function setTab(tab) {
            activeTab = tab;
            render();
        }

        function toggleHabit(habitId) {
            const key = `${getDateKey()}-${habitId}`;
            const wasCompleted = checkedHabits[key];
            checkedHabits[key] = !checkedHabits[key];
            setStorage('habits', JSON.stringify(checkedHabits));

            // Mostrar celebraci√≥n si se complet√≥
            if (!wasCompleted && checkedHabits[key]) {
                showCelebration();
                // Verificar si se complet√≥ d√≠a/semana/plan
                setTimeout(() => {
                    checkAndShowCongrats(getDailyProgress(), getWeeklyProgress(), getTotalProgress());
                }, 1000);
            }
            render();
        }

        function toggleActivity(index) {
            const key = `${getDateKey()}-${index}`;
            const wasCompleted = completedActivities[key];
            completedActivities[key] = !completedActivities[key];
            setStorage('activities', JSON.stringify(completedActivities));

            // Mostrar celebraci√≥n si se complet√≥
            if (!wasCompleted && completedActivities[key]) {
                showCelebration();
                // Verificar si se complet√≥ d√≠a/semana/plan
                setTimeout(() => {
                    checkAndShowCongrats(getDailyProgress(), getWeeklyProgress(), getTotalProgress());
                }, 1000);
            }
            render();
        }

        // Animaci√≥n de celebraci√≥n con emojis (3 opciones aleatorias)
        function showCelebration() {
            const emojiSets = [
                ['üéâ', 'üéä', 'ü•≥', 'üéà', 'üéÅ', 'ü™Ö', 'üéÄ', 'üçæ', 'ü•Ç', 'üéÜ'],  // Fiesta
                ['‚≠ê', '‚ú®', 'üåü', 'üí´', 'üåà', 'ü¶ã', 'üíñ', 'üíù', 'üå∏', 'üå∫'],  // M√°gico
                ['üèÜ', 'ü•á', 'üí™', 'üî•', 'üëë', 'üöÄ', 'üíØ', '‚ö°', 'üéØ', 'üëè']   // Campe√≥n
            ];
            const emojis = emojiSets[Math.floor(Math.random() * emojiSets.length)];
            const container = document.createElement('div');
            container.className = 'fixed inset-0 pointer-events-none z-[100]';
            document.body.appendChild(container);

            // Crear 15 emojis que caen
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.cssText = `
                        position: absolute;
                        font-size: ${20 + Math.random() * 25}px;
                        left: ${Math.random() * 100}%;
                        top: -50px;
                        animation: celebrationFall 1.5s ease-out forwards;
                        opacity: 1;
                    `;
                    container.appendChild(emoji);
                }, i * 50);
            }

            // Eliminar despu√©s de la animaci√≥n
            setTimeout(() => container.remove(), 2000);
        }

        // ========== ACTIVITY MODALS ==========
        function openEditModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const dateKey = getDateKey();
            const schedule = getSchedule(currentDate.getDay(), dateKey);
            const item = schedule[index];

            document.getElementById('editTime').value = item.time;
            document.getElementById('editActivity').value = item.activity;
            document.getElementById('editDuration').value = item.duration;
            document.getElementById('editCategory').value = item.category;

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveEdit() {
            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);
            const originalActivity = schedule[editingIndex].activity;

            const newItem = {
                time: document.getElementById('editTime').value,
                activity: document.getElementById('editActivity').value,
                duration: document.getElementById('editDuration').value,
                category: document.getElementById('editCategory').value
            };

            // Guardar este d√≠a primero
            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }
            schedule[editingIndex] = newItem;
            schedule.sort((a, b) => a.time.localeCompare(b.time));
            saveCustomSchedule(dateKey, schedule);

            closeEditModal();

            // Preguntar si reemplazar en todos los d√≠as
            showReplaceAllModal('schedule',
                `¬øAplicar este cambio a "${originalActivity}" en todos los d√≠as?`,
                (replaceAll) => {
                    if (replaceAll) {
                        replaceActivityInAllDays(originalActivity, newItem);
                    }
                }
            );
        }

        function replaceActivityInAllDays(originalName, newItem) {
            // Reemplazar en horarios por defecto customizados
            Object.keys(customSchedules).forEach(key => {
                const schedule = customSchedules[key];
                schedule.forEach((item, idx) => {
                    if (item.activity === originalName) {
                        schedule[idx] = { ...newItem };
                    }
                });
                setStorage(`schedule-${key}`, JSON.stringify(schedule));
            });
            render();
        }

        function openDeleteModal(index, type = 'activity') {
            event.stopPropagation();
            deletingIndex = index;
            deleteType = type;

            let itemName = '';
            if (type === 'activity') {
                const dateKey = getDateKey();
                const schedule = getSchedule(currentDate.getDay(), dateKey);
                itemName = schedule[index].activity;
            } else if (type === 'habit') {
                itemName = getHabits()[index].name;
            } else if (type === 'gym') {
                const dayIndex = currentDate.getDay();
                itemName = getGymFocus(dayIndex).exercises[index];
            } else if (type === 'meal') {
                itemName = getMeals()[index].name;
            } else if (type === 'goal') {
                itemName = `Semana ${getWeeklyGoals()[index].week}`;
            }

            document.getElementById('deleteActivityName').textContent = `"${itemName}"`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deletingIndex = null;
        }

        let pendingDeleteName = null; // Nombre del item a borrar

        function confirmDelete() {
            if (deleteType === 'activity') {
                // Guardar nombre antes de borrar
                const dateKey = getDateKey();
                const schedule = getSchedule(currentDate.getDay(), dateKey);
                pendingDeleteName = schedule[deletingIndex]?.activity;

                deleteActivity();
                closeDeleteModal();
                render();

                // Preguntar si borrar de todos los d√≠as
                if (pendingDeleteName) {
                    showReplaceAllModal('deleteActivity',
                        `¬øEliminar "${pendingDeleteName}" de todos los dem√°s d√≠as?`,
                        (deleteAll) => {
                            if (deleteAll) {
                                deleteActivityFromAllDays(pendingDeleteName);
                            }
                        }
                    );
                }
            } else if (deleteType === 'habit') {
                deleteHabit();
                closeDeleteModal();
                render();
            } else if (deleteType === 'gym') {
                // Guardar nombre antes de borrar
                const dayIndex = currentDate.getDay();
                const gym = getGymFocus(dayIndex);
                pendingDeleteName = gym.exercises[deletingIndex];

                deleteGymExercise();
                closeDeleteModal();
                render();

                // Preguntar si borrar de todos los d√≠as
                if (pendingDeleteName) {
                    showReplaceAllModal('deleteGym',
                        `¬øEliminar "${pendingDeleteName}" de todos los dem√°s d√≠as?`,
                        (deleteAll) => {
                            if (deleteAll) {
                                deleteGymFromAllDays(pendingDeleteName, dayIndex);
                            }
                        }
                    );
                }
            } else if (deleteType === 'meal') {
                deleteMeal();
                closeDeleteModal();
                render();
            } else if (deleteType === 'goal') {
                deleteGoal();
                closeDeleteModal();
                render();
            }
        }

        function deleteActivityFromAllDays(activityName) {
            Object.keys(customSchedules).forEach(key => {
                const schedule = customSchedules[key];
                const originalLength = schedule.length;
                customSchedules[key] = schedule.filter(item => item.activity !== activityName);
                if (customSchedules[key].length !== originalLength) {
                    setStorage(`schedule-${key}`, JSON.stringify(customSchedules[key]));
                }
            });
            render();
        }

        function deleteGymFromAllDays(exerciseName, excludeDayIndex) {
            for (let d = 0; d < 7; d++) {
                if (d !== excludeDayIndex && customGym[d]) {
                    const originalLength = customGym[d].exercises.length;
                    customGym[d].exercises = customGym[d].exercises.filter(ex => ex !== exerciseName);
                    if (customGym[d].exercises.length !== originalLength) {
                        setStorage('custom-gym', JSON.stringify(customGym));
                    }
                }
            }
            render();
        }

        function deleteActivity() {
            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);

            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }

            schedule.splice(deletingIndex, 1);

            const newCompleted = {};
            Object.keys(completedActivities).forEach(key => {
                if (key.startsWith(dateKey)) {
                    const idx = parseInt(key.split('-').pop());
                    if (idx < deletingIndex) {
                        newCompleted[key] = completedActivities[key];
                    } else if (idx > deletingIndex) {
                        newCompleted[`${dateKey}-${idx - 1}`] = completedActivities[key];
                    }
                } else {
                    newCompleted[key] = completedActivities[key];
                }
            });
            completedActivities = newCompleted;
            setStorage('activities', JSON.stringify(completedActivities));

            saveCustomSchedule(dateKey, schedule);
        }

        function openAddModal() {
            document.getElementById('addTime').value = '';
            document.getElementById('addActivity').value = '';
            document.getElementById('addDuration').value = '';
            document.getElementById('addCategory').value = 'personal';
            document.getElementById('addRepeat').checked = false;
            document.getElementById('repeatOptions').classList.add('hidden');

            // Establecer fechas por defecto
            const today = currentDate.toISOString().split('T')[0];
            document.getElementById('addStartDate').value = today;
            document.getElementById('addEndDate').value = today;

            document.getElementById('addModal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        function toggleRepeatOptions() {
            const isChecked = document.getElementById('addRepeat').checked;
            const options = document.getElementById('repeatOptions');

            if (isChecked) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        function saveNewActivity() {
            const time = document.getElementById('addTime').value;
            const activity = document.getElementById('addActivity').value;
            const duration = document.getElementById('addDuration').value;
            const category = document.getElementById('addCategory').value;
            const isRepeat = document.getElementById('addRepeat').checked;

            if (!time || !activity) {
                alert('Por favor completa la hora y la actividad');
                return;
            }

            const newItem = { time, activity, duration, category };

            if (isRepeat) {
                // Agregar a m√∫ltiples d√≠as
                const startDateStr = document.getElementById('addStartDate').value;
                const endDateStr = document.getElementById('addEndDate').value;

                if (!startDateStr || !endDateStr) {
                    alert('Por favor selecciona las fechas de inicio y fin');
                    return;
                }

                const repeatStartDate = new Date(startDateStr + 'T00:00:00');
                const repeatEndDate = new Date(endDateStr + 'T00:00:00');

                if (repeatEndDate < repeatStartDate) {
                    alert('La fecha fin debe ser igual o posterior a la fecha inicio');
                    return;
                }

                // Validar que las fechas est√©n dentro del rango del plan
                if (repeatStartDate < startDate || repeatEndDate > endDate) {
                    alert('Las fechas deben estar dentro del rango de tu plan');
                    return;
                }

                let daysAdded = 0;
                const tempDate = new Date(repeatStartDate);

                while (tempDate <= repeatEndDate) {
                    const dateKey = `${tempDate.getFullYear()}-${String(tempDate.getMonth() + 1).padStart(2, '0')}-${String(tempDate.getDate()).padStart(2, '0')}`;
                    let schedule = customSchedules[dateKey] || JSON.parse(JSON.stringify(getSchedule(tempDate.getDay(), dateKey)));

                    schedule.push({ ...newItem });
                    schedule.sort((a, b) => a.time.localeCompare(b.time));

                    customSchedules[dateKey] = schedule;
                    setStorage(`schedule-${dateKey}`, JSON.stringify(schedule));

                    daysAdded++;
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                alert(`‚úÖ Actividad agregada a ${daysAdded} d√≠as`);
            } else {
                // Agregar solo al d√≠a actual
                const dateKey = getDateKey();
                let schedule = getSchedule(currentDate.getDay(), dateKey);

                if (!customSchedules[dateKey]) {
                    schedule = JSON.parse(JSON.stringify(schedule));
                }

                schedule.push(newItem);
                schedule.sort((a, b) => a.time.localeCompare(b.time));

                saveCustomSchedule(dateKey, schedule);
            }

            closeAddModal();
            render();
        }

        function resetDay() {
            if (confirm('¬øRestaurar el plan original de este d√≠a? Se perder√°n los cambios.')) {
                const dateKey = getDateKey();
                delete customSchedules[dateKey];
                setStorage('custom-schedules', JSON.stringify(customSchedules));

                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(dateKey)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));

                render();
            }
        }

        // ========== HABIT MODALS ==========
        function openEditHabitModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const habit = getHabits()[index];

            document.getElementById('editHabitIcon').value = habit.icon;
            document.getElementById('editHabitName').value = habit.name;

            document.getElementById('editHabitModal').classList.remove('hidden');
        }

        function closeEditHabitModal() {
            document.getElementById('editHabitModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveHabitEdit() {
            const newIcon = document.getElementById('editHabitIcon').value;
            const newName = document.getElementById('editHabitName').value;
            const indexToEdit = editingIndex; // Guardar antes de cerrar modal

            closeEditHabitModal();

            showReplaceAllModal('habit',
                `Este cambio aplicar√° a "${newName}" en todos los d√≠as. ¬øContinuar?`,
                (confirmed) => {
                    if (confirmed) {
                        let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
                        habits[indexToEdit] = {
                            id: habits[indexToEdit].id,
                            icon: newIcon,
                            name: newName
                        };
                        customHabits = habits;
                        setStorage('custom-habits', JSON.stringify(customHabits));
                    }
                }
            );
        }

        function deleteHabit() {
            let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
            habits.splice(deletingIndex, 1);
            customHabits = habits;
            setStorage('custom-habits', JSON.stringify(customHabits));
        }

        function openAddHabitModal() {
            document.getElementById('addHabitIcon').value = '‚≠ê';
            document.getElementById('addHabitName').value = '';
            document.getElementById('addHabitModal').classList.remove('hidden');
        }

        function closeAddHabitModal() {
            document.getElementById('addHabitModal').classList.add('hidden');
        }

        function saveNewHabit() {
            const icon = document.getElementById('addHabitIcon').value;
            const name = document.getElementById('addHabitName').value;

            if (!name) {
                alert('Por favor ingresa el nombre del h√°bito');
                return;
            }

            let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
            const newId = Math.max(...habits.map(h => h.id)) + 1;
            habits.push({ id: newId, icon, name });

            customHabits = habits;
            setStorage('custom-habits', JSON.stringify(customHabits));
            closeAddHabitModal();
            render();
        }

        function resetHabits() {
            if (confirm('¬øRestaurar los h√°bitos originales?')) {
                customHabits = null;
                removeStorage('custom-habits');
                render();
            }
        }

        // ========== GYM MODALS ==========
        function openEditGymModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const dayIndex = currentDate.getDay();
            const gym = getGymFocus(dayIndex);

            document.getElementById('editGymExercise').value = gym.exercises[index];

            document.getElementById('editGymModal').classList.remove('hidden');
        }

        function closeEditGymModal() {
            document.getElementById('editGymModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveGymEdit() {
            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            const originalExercise = gym.exercises[editingIndex];
            const newExercise = document.getElementById('editGymExercise').value;

            // Guardar este d√≠a primero
            gym.exercises[editingIndex] = newExercise;
            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));

            closeEditGymModal();

            showReplaceAllModal('gym',
                `¬øReemplazar "${originalExercise}" en todos los d√≠as de la semana?`,
                (replaceAll) => {
                    if (replaceAll) {
                        // Reemplazar en todos los d√≠as
                        for (let d = 0; d < 7; d++) {
                            if (d !== dayIndex && customGym[d]) {
                                customGym[d].exercises = customGym[d].exercises.map(ex =>
                                    ex === originalExercise ? newExercise : ex
                                );
                            }
                        }
                        setStorage('custom-gym', JSON.stringify(customGym));
                    }
                }
            );
        }

        function deleteGymExercise() {
            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            gym.exercises.splice(deletingIndex, 1);
            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));
        }

        function openAddGymModal() {
            document.getElementById('addGymExercise').value = '';
            document.getElementById('addGymModal').classList.remove('hidden');
        }

        function closeAddGymModal() {
            document.getElementById('addGymModal').classList.add('hidden');
        }

        function saveNewGymExercise() {
            const exercise = document.getElementById('addGymExercise').value;

            if (!exercise) {
                alert('Por favor ingresa el ejercicio');
                return;
            }

            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            gym.exercises.push(exercise);

            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));
            closeAddGymModal();
            render();
        }

        function resetGym() {
            if (confirm('¬øRestaurar la rutina original de este d√≠a?')) {
                const dayIndex = currentDate.getDay();
                delete customGym[dayIndex];
                setStorage('custom-gym', JSON.stringify(customGym));
                render();
            }
        }

        // ========== ENHANCED GYM SYSTEM ==========

        // State for gym subsection
        let gymSubTab = 'workout'; // 'profile', 'workout', 'history'
        let activeWorkoutExerciseIdx = null;
        let currentSetIdx = 0;
        let selectedRPE = null;

        // Rest Timer State
        let restTimerInterval = null;
        let restTimerSeconds = 90;
        let restTimerRunning = false;

        // Exercise Library
        const exerciseLibrary = [
            { name: 'Hip Thrust (Smith Machine)', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Hip Thrust con Barra', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Peso Muerto Rumano', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Peso Muerto (M√°quina Smith)', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Patada de Gl√∫teo con Cable', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Empuje de Caderas (Barra)', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Elevaci√≥n de Cadera', muscle: 'gluteos', icon: 'üçë' },
            { name: 'Sentadilla (M√°quina Smith)', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Sentadilla B√∫lgara', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Sentadilla Goblet', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Prensa de Piernas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Extensi√≥n de Cu√°driceps', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Curl de Piernas Acostado', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Curl de Piernas Sentado', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Step con Mancuerna', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Zancada con Mancuernas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Abducci√≥n de Caderas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Aducci√≥n de Caderas', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Pantorrillas en M√°quina', muscle: 'piernas', icon: 'ü¶µ' },
            { name: 'Jal√≥n al Pecho', muscle: 'espalda', icon: 'üí™' },
            { name: 'Remo con Barra', muscle: 'espalda', icon: 'üí™' },
            { name: 'Remo con Mancuerna', muscle: 'espalda', icon: 'üí™' },
            { name: 'Remo en M√°quina', muscle: 'espalda', icon: 'üí™' },
            { name: 'Pullover con Mancuerna', muscle: 'espalda', icon: 'üí™' },
            { name: 'Press de Banca', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Press Inclinado', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Aperturas con Mancuernas', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Fondos en Paralelas', muscle: 'pecho', icon: 'üèãÔ∏è' },
            { name: 'Curl de B√≠ceps', muscle: 'brazos', icon: 'üí™' },
            { name: 'Curl Martillo', muscle: 'brazos', icon: 'üí™' },
            { name: 'Extensi√≥n de Tr√≠ceps', muscle: 'brazos', icon: 'üí™' },
            { name: 'Press Franc√©s', muscle: 'brazos', icon: 'üí™' },
            { name: 'Plancha', muscle: 'core', icon: 'üßò' },
            { name: 'Crunch Abdominal', muscle: 'core', icon: 'üßò' },
            { name: 'Elevaci√≥n de Piernas', muscle: 'core', icon: 'üßò' },
            { name: 'Russian Twist', muscle: 'core', icon: 'üßò' },
        ];

        // Physical Profile Functions
        function getPhysicalProfile() {
            return JSON.parse(getStorage('physical-profile') || '{"height": null, "goalWeight": null, "checkinDay": 1}');
        }

        function savePhysicalProfile() {
            const profile = {
                height: parseFloat(document.getElementById('profileHeight').value) || null,
                goalWeight: parseFloat(document.getElementById('profileGoalWeight').value) || null,
                checkinDay: parseInt(document.getElementById('profileCheckinDay').value) || 1
            };
            setStorage('physical-profile', JSON.stringify(profile));
            closeProfileModal();
            render();
        }

        function openProfileModal() {
            const profile = getPhysicalProfile();
            document.getElementById('profileHeight').value = profile.height || '';
            document.getElementById('profileGoalWeight').value = profile.goalWeight || '';
            document.getElementById('profileCheckinDay').value = profile.checkinDay || 1;
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        // Weight/Measurements Functions
        function getWeightHistory() {
            return JSON.parse(getStorage('weight-history') || '[]');
        }

        function saveWeightHistory(history) {
            setStorage('weight-history', JSON.stringify(history));
        }

        function openWeightModal() {
            document.getElementById('weightDate').value = getTodayKey();
            document.getElementById('weightValue').value = '';
            document.getElementById('measureWaist').value = '';
            document.getElementById('measureHip').value = '';
            document.getElementById('measureThigh').value = '';
            document.getElementById('measureArm').value = '';
            document.getElementById('bodyFat').value = '';
            document.getElementById('weightModal').classList.remove('hidden');
        }

        function closeWeightModal() {
            document.getElementById('weightModal').classList.add('hidden');
        }

        function saveWeightEntry() {
            const weight = parseFloat(document.getElementById('weightValue').value);
            if (!weight) {
                alert('Por favor ingresa tu peso');
                return;
            }

            const entry = {
                date: document.getElementById('weightDate').value,
                weight: weight,
                waist: parseFloat(document.getElementById('measureWaist').value) || null,
                hip: parseFloat(document.getElementById('measureHip').value) || null,
                thigh: parseFloat(document.getElementById('measureThigh').value) || null,
                arm: parseFloat(document.getElementById('measureArm').value) || null,
                bodyFat: parseFloat(document.getElementById('bodyFat').value) || null
            };

            const history = getWeightHistory();
            // Replace if same date exists
            const existingIdx = history.findIndex(h => h.date === entry.date);
            if (existingIdx >= 0) {
                history[existingIdx] = entry;
            } else {
                history.push(entry);
            }
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveWeightHistory(history);
            closeWeightModal();
            addNotification(`Peso registrado: ${weight} kg`, '‚öñÔ∏è');
            render();
        }

        function getLatestWeight() {
            const history = getWeightHistory();
            return history.length > 0 ? history[history.length - 1] : null;
        }

        // Workout Log Functions
        function getWorkoutLogs() {
            return JSON.parse(getStorage('workout-logs') || '[]');
        }

        function saveWorkoutLogs(logs) {
            setStorage('workout-logs', JSON.stringify(logs));
        }

        function getTodayWorkout() {
            const logs = getWorkoutLogs();
            const today = getTodayKey();
            return logs.find(l => l.date === today) || { date: today, exercises: [] };
        }

        function saveTodayWorkout(workout) {
            const logs = getWorkoutLogs();
            const idx = logs.findIndex(l => l.date === workout.date);
            if (idx >= 0) {
                logs[idx] = workout;
            } else {
                logs.push(workout);
            }
            saveWorkoutLogs(logs);
        }

        // Exercise Library Modal
        let exerciseFilter = 'all';
        let exerciseSearchQuery = '';

        function openAddWorkoutExerciseModal() {
            exerciseFilter = 'all';
            exerciseSearchQuery = '';
            document.getElementById('exerciseSearch').value = '';
            document.getElementById('customExerciseName').value = '';
            renderExerciseLibrary();
            document.getElementById('addWorkoutExerciseModal').classList.remove('hidden');
        }

        function closeAddWorkoutExerciseModal() {
            document.getElementById('addWorkoutExerciseModal').classList.add('hidden');
        }

        function filterExerciseLibrary() {
            exerciseSearchQuery = document.getElementById('exerciseSearch').value.toLowerCase();
            renderExerciseLibrary();
        }

        function filterByMuscle(muscle) {
            exerciseFilter = muscle;
            document.querySelectorAll('.muscle-filter-btn').forEach(btn => {
                btn.classList.remove('bg-purple-100', 'text-purple-700');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            document.querySelector(`.muscle-filter-btn[data-muscle="${muscle}"]`).classList.remove('bg-gray-100', 'text-gray-600');
            document.querySelector(`.muscle-filter-btn[data-muscle="${muscle}"]`).classList.add('bg-purple-100', 'text-purple-700');
            renderExerciseLibrary();
        }

        function renderExerciseLibrary() {
            const container = document.getElementById('exerciseLibraryList');
            let filtered = exerciseLibrary;

            if (exerciseFilter !== 'all') {
                filtered = filtered.filter(e => e.muscle === exerciseFilter);
            }
            if (exerciseSearchQuery) {
                filtered = filtered.filter(e => e.name.toLowerCase().includes(exerciseSearchQuery));
            }

            container.innerHTML = filtered.map(ex => `
                <button onclick="addExerciseToWorkout('${ex.name}')" class="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-purple-50 transition text-left">
                    <span class="text-2xl">${ex.icon}</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${ex.name}</p>
                        <p class="text-xs text-gray-500 capitalize">${ex.muscle}</p>
                    </div>
                    <span class="text-purple-500">+</span>
                </button>
            `).join('');
        }

        function addExerciseToWorkout(exerciseName) {
            const workout = getTodayWorkout();
            workout.exercises.push({
                name: exerciseName,
                sets: []
            });
            saveTodayWorkout(workout);
            closeAddWorkoutExerciseModal();
            render();
        }

        function addCustomExercise() {
            const name = document.getElementById('customExerciseName').value.trim();
            if (!name) return;
            addExerciseToWorkout(name);
        }

        function removeExerciseFromWorkout(idx) {
            if (!confirm('¬øEliminar este ejercicio del entrenamiento de hoy?')) return;
            const workout = getTodayWorkout();
            workout.exercises.splice(idx, 1);
            saveTodayWorkout(workout);
            render();
        }

        // Set Logging
        function openLogSetModal(exerciseIdx, setIdx) {
            activeWorkoutExerciseIdx = exerciseIdx;
            currentSetIdx = setIdx;
            selectedRPE = null;

            const workout = getTodayWorkout();
            const exercise = workout.exercises[exerciseIdx];
            const existingSet = exercise.sets[setIdx];

            document.getElementById('logSetTitle').textContent = `${exercise.name} - Serie ${setIdx + 1}`;
            document.getElementById('setWeight').value = existingSet?.weight || getLastWeight(exercise.name) || '';
            document.getElementById('setReps').value = existingSet?.reps || '';
            document.getElementById('setNotes').value = existingSet?.notes || '';

            // Reset RPE buttons
            document.querySelectorAll('.rpe-btn').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'text-white');
            });
            if (existingSet?.rpe) {
                selectRPE(existingSet.rpe);
            }

            document.getElementById('logSetModal').classList.remove('hidden');
        }

        function closeLogSetModal() {
            document.getElementById('logSetModal').classList.add('hidden');
        }

        function selectRPE(value) {
            selectedRPE = value;
            document.querySelectorAll('.rpe-btn').forEach(btn => {
                btn.classList.remove('bg-purple-500', 'text-white');
            });
            document.querySelector(`.rpe-btn[data-rpe="${value}"]`).classList.add('bg-purple-500', 'text-white');
        }

        function saveSetLog() {
            const weight = parseFloat(document.getElementById('setWeight').value) || 0;
            const reps = parseInt(document.getElementById('setReps').value) || 0;
            const notes = document.getElementById('setNotes').value;

            if (!reps) {
                alert('Por favor ingresa las repeticiones');
                return;
            }

            const workout = getTodayWorkout();
            const exercise = workout.exercises[activeWorkoutExerciseIdx];

            // Ensure sets array is long enough
            while (exercise.sets.length <= currentSetIdx) {
                exercise.sets.push(null);
            }

            exercise.sets[currentSetIdx] = {
                weight,
                reps,
                rpe: selectedRPE,
                notes,
                completedAt: new Date().toISOString()
            };

            saveTodayWorkout(workout);
            closeLogSetModal();

            // Check for PR
            checkAndNotifyPR(exercise.name, weight, reps);

            // Start rest timer
            startRestTimer();

            render();
        }

        function getLastWeight(exerciseName) {
            const logs = getWorkoutLogs();
            for (let i = logs.length - 1; i >= 0; i--) {
                const ex = logs[i].exercises.find(e => e.name === exerciseName);
                if (ex && ex.sets.length > 0) {
                    const lastSet = ex.sets.filter(s => s).pop();
                    if (lastSet) return lastSet.weight;
                }
            }
            return null;
        }

        function getExercisePR(exerciseName) {
            const logs = getWorkoutLogs();
            let maxWeight = 0;
            let maxVolume = 0;

            logs.forEach(log => {
                const ex = log.exercises.find(e => e.name === exerciseName);
                if (ex) {
                    ex.sets.filter(s => s).forEach(set => {
                        if (set.weight > maxWeight) maxWeight = set.weight;
                        const volume = set.weight * set.reps;
                        if (volume > maxVolume) maxVolume = volume;
                    });
                }
            });

            return { maxWeight, maxVolume };
        }

        function checkAndNotifyPR(exerciseName, weight, reps) {
            const pr = getExercisePR(exerciseName);
            if (weight > pr.maxWeight && pr.maxWeight > 0) {
                addNotification(`üèÜ ¬°Nuevo PR! ${exerciseName}: ${weight}kg`, 'üéâ');
            }
        }

        // Rest Timer
        function startRestTimer(seconds = 90) {
            restTimerSeconds = seconds;
            restTimerRunning = true;
            document.getElementById('restTimerFloat').classList.remove('hidden');
            document.getElementById('restTimerToggle').textContent = '‚è∏Ô∏è';
            updateRestTimerDisplay();

            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerInterval = setInterval(() => {
                if (restTimerRunning) {
                    restTimerSeconds--;
                    updateRestTimerDisplay();
                    if (restTimerSeconds <= 0) {
                        finishRestTimer();
                    }
                }
            }, 1000);
        }

        function updateRestTimerDisplay() {
            const mins = Math.floor(restTimerSeconds / 60);
            const secs = restTimerSeconds % 60;
            document.getElementById('restTimerDisplay').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function toggleRestTimer() {
            restTimerRunning = !restTimerRunning;
            document.getElementById('restTimerToggle').textContent = restTimerRunning ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        }

        function adjustRestTimer(delta) {
            restTimerSeconds = Math.max(0, restTimerSeconds + delta);
            updateRestTimerDisplay();
        }

        function setRestTimer(seconds) {
            restTimerSeconds = seconds;
            restTimerRunning = true;
            document.getElementById('restTimerToggle').textContent = '‚è∏Ô∏è';
            updateRestTimerDisplay();
        }

        function finishRestTimer() {
            clearInterval(restTimerInterval);
            restTimerInterval = null;
            restTimerRunning = false;

            // Play sound or vibrate
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }

            // Visual alert
            const display = document.getElementById('restTimerDisplay');
            display.textContent = '¬°GO!';
            display.classList.add('animate-pulse');

            setTimeout(() => {
                display.classList.remove('animate-pulse');
                closeRestTimer();
            }, 3000);
        }

        function closeRestTimer() {
            if (restTimerInterval) clearInterval(restTimerInterval);
            document.getElementById('restTimerFloat').classList.add('hidden');
        }

        // Set gym sub-tab
        function setGymSubTab(tab) {
            gymSubTab = tab;
            render();
        }

        // ========== MEAL MODALS ==========
        function openEditMealModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const meal = getMeals()[index];

            document.getElementById('editMealTime').value = meal.time;
            document.getElementById('editMealName').value = meal.name;
            document.getElementById('editMealEmoji').value = meal.emoji;
            document.getElementById('editMealOptions').value = meal.options.join('\n');
            document.getElementById('editMealMacros').value = meal.macros;

            document.getElementById('editMealModal').classList.remove('hidden');
        }

        function closeEditMealModal() {
            document.getElementById('editMealModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveMealEdit() {
            const newMeal = {
                time: document.getElementById('editMealTime').value,
                name: document.getElementById('editMealName').value,
                emoji: document.getElementById('editMealEmoji').value,
                options: document.getElementById('editMealOptions').value.split('\n').filter(o => o.trim()),
                macros: document.getElementById('editMealMacros').value
            };
            const indexToEdit = editingIndex; // Guardar antes de cerrar modal

            closeEditMealModal();

            showReplaceAllModal('meal',
                `Este cambio aplicar√° a "${newMeal.name}" en todos los d√≠as. ¬øContinuar?`,
                (confirmed) => {
                    if (confirmed) {
                        let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
                        meals[indexToEdit] = newMeal;
                        meals.sort((a, b) => a.time.localeCompare(b.time));
                        customMeals = meals;
                        setStorage('custom-meals', JSON.stringify(customMeals));
                    }
                }
            );
        }

        function deleteMeal() {
            let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
            meals.splice(deletingIndex, 1);
            customMeals = meals;
            setStorage('custom-meals', JSON.stringify(customMeals));
        }

        function openAddMealModal() {
            document.getElementById('addMealTime').value = '';
            document.getElementById('addMealName').value = '';
            document.getElementById('addMealEmoji').value = 'üçΩÔ∏è';
            document.getElementById('addMealOptions').value = '';
            document.getElementById('addMealMacros').value = '';
            document.getElementById('addMealModal').classList.remove('hidden');
        }

        function closeAddMealModal() {
            document.getElementById('addMealModal').classList.add('hidden');
        }

        function saveNewMeal() {
            const time = document.getElementById('addMealTime').value;
            const name = document.getElementById('addMealName').value;

            if (!time || !name) {
                alert('Por favor completa la hora y el nombre');
                return;
            }

            let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
            meals.push({
                time,
                name,
                emoji: document.getElementById('addMealEmoji').value || 'üçΩÔ∏è',
                options: document.getElementById('addMealOptions').value.split('\n').filter(o => o.trim()),
                macros: document.getElementById('addMealMacros').value
            });

            meals.sort((a, b) => a.time.localeCompare(b.time));

            customMeals = meals;
            setStorage('custom-meals', JSON.stringify(customMeals));
            closeAddMealModal();
            render();
        }

        function resetMeals() {
            if (confirm('¬øRestaurar el plan de comidas original?')) {
                customMeals = null;
                removeStorage('custom-meals');
                render();
            }
        }

        // ========== GOAL MODALS ==========
        function openEditGoalModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const goal = getWeeklyGoals()[index];

            document.getElementById('editGoalWeek').value = goal.week;
            document.getElementById('editGoalDates').value = goal.dates;
            document.getElementById('editGoalFisica').value = goal.fisica;
            document.getElementById('editGoalPersonal').value = goal.personal;
            document.getElementById('editGoalDigital').value = goal.digital;
            document.getElementById('editGoalEspiritual').value = goal.espiritual;

            document.getElementById('editGoalModal').classList.remove('hidden');
        }

        function closeEditGoalModal() {
            document.getElementById('editGoalModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveGoalEdit() {
            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));

            goals[editingIndex] = {
                week: parseInt(document.getElementById('editGoalWeek').value),
                dates: document.getElementById('editGoalDates').value,
                fisica: document.getElementById('editGoalFisica').value,
                personal: document.getElementById('editGoalPersonal').value,
                digital: document.getElementById('editGoalDigital').value,
                espiritual: document.getElementById('editGoalEspiritual').value
            };

            goals.sort((a, b) => a.week - b.week);

            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
            closeEditGoalModal();
            render();
        }

        function deleteGoal() {
            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));
            goals.splice(deletingIndex, 1);
            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
        }

        function resetGoals() {
            if (confirm('¬øRestaurar las metas originales?')) {
                customGoals = null;
                removeStorage('custom-goals');
                render();
            }
        }

        function renderProgressCircle(percent, size, strokeWidth, color, label) {
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percent / 100) * circumference;

            return `
                <div class="flex flex-col items-center">
                    <div class="relative" style="width: ${size}px; height: ${size}px;">
                        <svg class="transform -rotate-90" width="${size}" height="${size}">
                            <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="#e5e7eb" stroke-width="${strokeWidth}" fill="none"/>
                            <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#gradient-${label})" stroke-width="${strokeWidth}" fill="none" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" class="progress-ring"/>
                            <defs>
                                <linearGradient id="gradient-${label}" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:${color === 'rose' ? '#ec4899' : color === 'purple' ? '#8b5cf6' : '#06b6d4'}"/>
                                    <stop offset="100%" style="stop-color:${color === 'rose' ? '#f43f5e' : color === 'purple' ? '#a855f7' : '#0891b2'}"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-800">${percent}%</span>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500 mt-1 font-medium">${label}</span>
                </div>
            `;
        }

        function render() {
            const dayIndex = currentDate.getDay();
            const weekNum = getWeekNumber();
            const dayNum = getDayNumber();
            const dateKey = getDateKey();
            const dailyProgress = getDailyProgress();
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const currentStreak = getStreak();
            const bestStreak = getBestStreak();
            const schedule = getSchedule(dayIndex, dateKey);
            const gym = getGymFocus(dayIndex);
            const isCustomized = !!customSchedules[dateKey];

            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header -->
                <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-50">
                    <div class="max-w-4xl mx-auto px-3 py-2">
                        <div class="flex items-center gap-3">
                            <div class="relative flex-shrink-0 cursor-pointer group" onclick="openPhotoModal()" title="Cambiar foto de perfil">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-pink-500 to-purple-500 flex items-center justify-center text-white text-lg font-bold border-2 border-purple-200 photo-glow overflow-hidden group-hover:opacity-80 transition">
                                    ${getUserPhoto() ? `<img src="${getUserPhoto()}" class="w-full h-full object-cover">` : currentUser.name.charAt(0).toUpperCase()}
                                </div>
                                <span class="absolute -bottom-0.5 -right-0.5 text-sm group-hover:scale-110 transition">üì∑</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h1 class="text-base font-bold gradient-text">üëã ${currentUser.name}</h1>
                                <p class="text-xs text-gray-500">${getGoalText(currentUser.goal)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex flex-col items-end gap-1 text-xs flex-shrink-0">
                                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium">S${weekNum}/${totalWeeks}</span>
                                    <span class="px-2 py-0.5 bg-rose-100 text-rose-700 rounded-full font-medium">D${dayNum}/${userDuration}</span>
                                </div>
                                <!-- Notifications -->
                                <div class="relative">
                                    <button onclick="toggleNotificationsMenu()" class="p-2 text-gray-400 hover:text-purple-500 transition text-xl relative" title="Notificaciones">
                                        üîî
                                        <span id="notificationBadge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold ${getUnreadNotificationsCount() > 0 ? '' : 'hidden'}">${getUnreadNotificationsCount()}</span>
                                    </button>
                                    <div id="notificationsMenu" class="hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-100 z-50 max-h-96 overflow-hidden">
                                        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                                            <h4 class="font-bold text-gray-800">üîî Notificaciones</h4>
                                            <button onclick="markAllNotificationsRead()" class="text-xs text-purple-600 hover:underline">Marcar todo le√≠do</button>
                                        </div>
                                        <div id="notificationsList" class="overflow-y-auto max-h-72">
                                            <!-- Notifications will be rendered here -->
                                        </div>
                                        <div class="px-4 py-2 border-t border-gray-100 bg-gray-50">
                                            <button onclick="clearAllNotifications()" class="text-xs text-red-500 hover:underline">Limpiar todas</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Settings Menu -->
                                <div class="relative">
                                    <button onclick="toggleSettingsMenu()" class="p-2 text-gray-400 hover:text-purple-500 transition text-xl" title="Configuraci√≥n">
                                        ‚öôÔ∏è
                                    </button>
                                    <div id="settingsMenu" class="hidden absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50">
                                        <button onclick="toggleDarkMode(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition text-left">
                                            <span class="text-xl">${isDarkMode() ? '‚òÄÔ∏è' : 'üåô'}</span>
                                            <span class="text-gray-700">${isDarkMode() ? 'Modo claro' : 'Modo oscuro'}</span>
                                        </button>
                                        <button onclick="openExportModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition text-left">
                                            <span class="text-xl">üì•</span>
                                            <span class="text-gray-700">Exportar datos</span>
                                        </button>
                                        <button onclick="openTemplateModal(); toggleSettingsMenu();" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-50 transition text-left">
                                            <span class="text-xl">üìã</span>
                                            <span class="text-gray-700">Plantillas</span>
                                        </button>
                                        <hr class="my-2 border-gray-100">
                                        <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-50 transition text-left">
                                            <span class="text-xl">üö™</span>
                                            <span class="text-red-600">Cerrar sesi√≥n</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Progress Dashboard -->
                <div class="bg-white/80 backdrop-blur-sm border-b">
                    <div class="max-w-4xl mx-auto px-4 py-1">
                        <!-- Toggle Button -->
                        <button onclick="toggleDashboard()" class="w-full flex items-center justify-center gap-2 py-1 text-gray-500 hover:text-purple-600 transition">
                            <span class="text-xs font-medium">${dashboardVisible ? 'üìä Ocultar' : 'üìä Mostrar progreso'}</span>
                            <span class="text-sm">${dashboardVisible ? '‚ñ≤' : '‚ñº'}</span>
                        </button>

                        <!-- Collapsible Content -->
                        <div class="${dashboardVisible ? '' : 'hidden'} pt-3">
                            <div class="flex justify-around items-center">
                                ${renderProgressCircle(dailyProgress, 80, 8, 'rose', 'HOY')}
                                ${renderProgressCircle(weeklyProgress, 80, 8, 'purple', 'SEMANA')}
                                ${renderProgressCircle(totalProgress, 80, 8, 'cyan', 'TOTAL')}
                            </div>

                            <!-- Racha de d√≠as -->
                            <div class="mt-4 flex justify-center gap-6">
                                <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-100 to-yellow-100 rounded-xl">
                                    <span class="text-2xl">üî•</span>
                                    <div>
                                        <p class="text-lg font-bold text-orange-600">${currentStreak}</p>
                                        <p class="text-xs text-orange-500">Racha actual</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl">
                                    <span class="text-2xl">üèÜ</span>
                                    <div>
                                        <p class="text-lg font-bold text-purple-600">${bestStreak}</p>
                                        <p class="text-xs text-purple-500">Mejor racha</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 text-center">
                                <p class="text-sm text-gray-500">
                                    ${totalProgress === 100 ? 'üèÜ ¬°PROGRAMA COMPLETADO! ¬°Eres una campeona!' :
                                      currentStreak >= 7 ? 'üî• ¬°' + currentStreak + ' d√≠as seguidos! ¬°Imparable!' :
                                      currentStreak >= 3 ? 'üí™ ¬°' + currentStreak + ' d√≠as de racha! ¬°Sigue as√≠!' :
                                      totalProgress >= 50 ? '‚ú® ¬°M√°s de la mitad! No te detengas' :
                                      'üåü ¬°Cada d√≠a cuenta! T√∫ puedes'}
                                </p>
                                <button onclick="openShareModal()" class="mt-2 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-full text-sm font-medium hover:opacity-90 transition inline-flex items-center gap-2">
                                    üì§ Compartir mi progreso
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Navigation -->
                <div class="bg-white/60 backdrop-blur-sm border-b">
                    <div class="max-w-4xl mx-auto px-4 py-2">
                        <div class="flex items-center justify-between">
                            <button onclick="navigateDay(-1)" class="p-2 hover:bg-white rounded-full transition text-xl ${currentDate <= startDate ? 'opacity-30' : ''}">‚óÄÔ∏è</button>
                            <div class="text-center cursor-pointer hover:bg-white/50 px-3 py-1 rounded-xl transition" onclick="openCalendarModal()">
                                <p class="text-lg font-bold text-gray-800">${daysSpanish[dayIndex]} <span class="font-normal text-gray-500 text-sm">üìÖ ${currentDate.getDate()} ${monthsSpanish[currentDate.getMonth()]}</span></p>
                                ${isCustomized ? '<span class="text-xs text-purple-500">‚úèÔ∏è Personalizado</span>' : ''}
                            </div>
                            <button onclick="navigateDay(1)" class="p-2 hover:bg-white rounded-full transition text-xl ${currentDate >= endDate ? 'opacity-30' : ''}">‚ñ∂Ô∏è</button>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white/40 border-b sticky top-[56px] z-40 mt-1">
                    <div class="max-w-4xl mx-auto px-4">
                        <div class="flex gap-2 overflow-x-auto py-3 no-scrollbar">
                            ${['agenda', 'habits', 'gym', 'meals', 'goals', 'notes', 'gastos', 'stats'].map(tab => `
                                <button onclick="setTab('${tab}')" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap ${activeTab === tab ? 'tab-active shadow-md' : 'bg-white/80 text-gray-600 hover:bg-white'}">
                                    ${tab === 'agenda' ? 'üìÖ Agenda' : tab === 'habits' ? '‚úÖ H√°bitos' : tab === 'gym' ? 'üí™ Gym' : tab === 'meals' ? 'ü•ó Comidas' : tab === 'goals' ? 'üéØ Metas' : tab === 'notes' ? 'üìù Notas' : tab === 'gastos' ? 'üí∞ Gastos' : 'üìä Estad√≠sticas'}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <main class="max-w-4xl mx-auto px-4 py-3">
                    ${activeTab === 'agenda' ? renderAgenda(schedule, gym, dateKey, dailyProgress, isCustomized) : ''}
                    ${activeTab === 'habits' ? renderHabits(dateKey) : ''}
                    ${activeTab === 'gym' ? renderGym(gym, dayIndex, weekNum) : ''}
                    ${activeTab === 'meals' ? renderMeals() : ''}
                    ${activeTab === 'goals' ? renderGoals(weekNum) : ''}
                    ${activeTab === 'notes' ? renderNotes(dateKey) : ''}
                    ${activeTab === 'gastos' ? renderGastos() : ''}
                    ${activeTab === 'stats' ? renderStats() : ''}
                </main>

                <!-- Footer -->
                <footer class="bg-white/80 backdrop-blur-sm border-t mt-8">
                    <div class="max-w-4xl mx-auto px-4 py-6 text-center">
                        <p class="text-lg font-medium text-gray-700">"El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a"</p>
                        <p class="text-purple-500 mt-2 text-xl">‚ú® ¬°T√∫ puedes, ${currentUser.name.split(' ')[0]}! ‚ú®</p>
                    </div>
                </footer>
            `;
        }

        function renderAgenda(schedule, gym, dateKey, dailyProgress, isCustomized) {
            const completedCount = schedule.filter((_, idx) => completedActivities[`${dateKey}-${idx}`]).length;

            return `
                <div class="space-y-3">
                    <div class="bg-gradient-to-r from-rose-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <span class="text-5xl">${gym.icon}</span>
                                <div>
                                    <p class="font-bold text-xl">${gym.name}</p>
                                    <p class="text-white/80 text-sm">${schedule.length} actividades hoy</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-4xl font-bold">${dailyProgress}%</p>
                                <p class="text-white/80 text-sm">${completedCount}/${schedule.length} completadas</p>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-white rounded-full progress-bar" style="width: ${dailyProgress}%"></div>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4 flex-wrap">
                        <button onclick="openAddModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar Actividad
                        </button>
                        <button onclick="openTemplateModal()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-blue-600 border-2 border-blue-100">
                            <span class="text-xl">üìã</span> Plantillas
                        </button>
                        <button onclick="openCleanModal('agenda')" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-orange-500 border-2 border-orange-100">
                            <span class="text-xl">üßπ</span> Limpiar
                        </button>
                        <button onclick="resetDay()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                            <span class="text-xl">üîÑ</span> Restaurar
                        </button>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="bg-white rounded-xl p-3 shadow-sm mb-4">
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative flex-1">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                                <input type="text" id="searchInput" value="${searchQuery}" oninput="filterActivities()" placeholder="Buscar actividades..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none text-sm">
                            </div>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar">
                                <button onclick="setFilter('')" class="filter-btn px-3 py-2 rounded-lg text-xs font-medium transition whitespace-nowrap ${!activeFilter ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                    Todas
                                </button>
                                ${Object.entries(categoryColors).map(([cat, colors]) => `
                                    <button onclick="setFilter('${cat}')" class="filter-btn px-3 py-2 rounded-lg text-xs font-medium transition whitespace-nowrap ${activeFilter === cat ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                        ${cat === 'habitos' ? '‚òÄÔ∏è' : cat === 'nutricion' ? 'ü•ó' : cat === 'fisico' ? 'üí™' : cat === 'personal' ? 'üìö' : cat === 'digital' ? 'üì±' : cat === 'espiritual' ? 'üßò' : 'üò¥'}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    ${schedule.filter((item, idx) => {
                        const searchTerm = (searchQuery || '').toLowerCase();
                        const matchesSearch = !searchTerm || item.activity.toLowerCase().includes(searchTerm) || item.time.includes(searchTerm);
                        const matchesFilter = !activeFilter || item.category === activeFilter;
                        return matchesSearch && matchesFilter;
                    }).map((item) => {
                        const originalIdx = schedule.indexOf(item);
                        const colors = categoryColors[item.category] || categoryColors.personal;
                        const isCompleted = completedActivities[`${dateKey}-${originalIdx}`];
                        return `
                            <div class="${colors.bg} ${colors.border} border rounded-xl p-4 transition-all card-hover ${isCompleted ? 'checked-item' : ''}">
                                <div class="flex items-start gap-4">
                                    <div onclick="toggleActivity(${originalIdx})" class="w-12 h-12 rounded-full ${isCompleted ? 'bg-green-500' : colors.badge} flex items-center justify-center flex-shrink-0 text-xl transition-all cursor-pointer hover:scale-110 ${isCompleted ? 'text-white' : ''}">
                                        ${isCompleted ? '‚úì' : '‚óã'}
                                    </div>
                                    <div class="flex-1 min-w-0" onclick="toggleActivity(${originalIdx})" style="cursor: pointer;">
                                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                                            <span class="font-mono text-sm text-gray-500">${item.time}</span>
                                            <span class="text-xs px-2 py-0.5 rounded-full ${colors.badge} ${colors.text}">${item.duration}</span>
                                        </div>
                                        <p class="font-medium ${isCompleted ? 'line-through text-gray-400' : 'text-gray-800'}">${item.activity}</p>
                                    </div>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="openEditModal(${originalIdx})" class="btn-icon w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${originalIdx}, 'activity')" class="btn-icon w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}

                    ${schedule.length === 0 ? `
                        <div class="text-center py-12 text-gray-400">
                            <span class="text-5xl block mb-4">üìù</span>
                            <p>No hay actividades para este d√≠a</p>
                            <p class="text-sm">Presiona "Agregar Actividad" para comenzar</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderHabits(dateKey) {
            const habits = getHabits();
            const completedCount = habits.filter(h => checkedHabits[`${dateKey}-${h.id}`]).length;
            const progress = Math.round((completedCount / habits.length) * 100);
            const isCustomized = customHabits !== null;

            return `
                <div class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg text-gray-800">H√°bitos del d√≠a</h3>
                            <span class="text-2xl font-bold text-purple-600">${completedCount}/${habits.length}</span>
                        </div>
                        <div class="h-4 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-rose-400 to-purple-500 progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-center mt-3 text-sm text-gray-500">
                            ${progress === 100 ? 'üéâ ¬°Todos los h√°bitos completados!' : progress >= 80 ? 'üí™ ¬°Casi perfecto!' : progress >= 50 ? '‚ú® ¬°Vas muy bien!' : 'üåü ¬°Sigue adelante!'}
                        </p>
                    </div>

                    <div class="flex gap-2 mb-4 flex-wrap">
                        <button onclick="openAddHabitModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar H√°bito
                        </button>
                        <button onclick="openCleanModal('habits')" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-orange-500 border-2 border-orange-100">
                            <span class="text-xl">üßπ</span> Limpiar
                        </button>
                        <button onclick="resetHabits()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                            <span class="text-xl">üîÑ</span> Restaurar
                        </button>
                    </div>

                    <div class="grid gap-3">
                        ${habits.map((habit, idx) => {
                            const isChecked = checkedHabits[`${dateKey}-${habit.id}`];
                            return `
                                <div class="flex items-center gap-2 p-4 rounded-xl border-2 transition-all ${isChecked ? 'habit-checked' : 'bg-white border-gray-100 hover:border-gray-200'}">
                                    <button onclick="toggleHabit(${habit.id})" class="flex items-center gap-4 flex-1 text-left">
                                        <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${isChecked ? 'bg-purple-500 border-purple-500 text-white' : 'border-gray-300'}">
                                            ${isChecked ? '‚úì' : ''}
                                        </div>
                                        <span class="text-2xl">${habit.icon}</span>
                                        <span class="font-medium ${isChecked ? 'text-purple-700' : 'text-gray-700'}">${habit.name}</span>
                                    </button>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="openEditHabitModal(${idx})" class="btn-icon w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-sm" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${idx}, 'habit')" class="btn-icon w-9 h-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-sm" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderGym(gym, dayIndex, weekNum) {
            const profile = getPhysicalProfile();
            const latestWeight = getLatestWeight();
            const weightHistory = getWeightHistory();
            const todayWorkout = getTodayWorkout();

            return `
                <div class="space-y-4">
                    <!-- Sub-tabs -->
                    <div class="bg-white rounded-xl p-1 flex gap-1 shadow-sm">
                        <button onclick="setGymSubTab('profile')" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition ${gymSubTab === 'profile' ? 'bg-gradient-to-r from-rose-500 to-purple-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            üìä Perfil
                        </button>
                        <button onclick="setGymSubTab('workout')" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition ${gymSubTab === 'workout' ? 'bg-gradient-to-r from-rose-500 to-purple-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            üèãÔ∏è Entreno
                        </button>
                        <button onclick="setGymSubTab('history')" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition ${gymSubTab === 'history' ? 'bg-gradient-to-r from-rose-500 to-purple-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                            üìà Historial
                        </button>
                    </div>

                    ${gymSubTab === 'profile' ? renderGymProfile(profile, latestWeight, weightHistory) : ''}
                    ${gymSubTab === 'workout' ? renderGymWorkout(gym, dayIndex, todayWorkout) : ''}
                    ${gymSubTab === 'history' ? renderGymHistory() : ''}
                </div>
            `;
        }

        function renderGymProfile(profile, latestWeight, weightHistory) {
            const goalDiff = latestWeight && profile.goalWeight ? (latestWeight.weight - profile.goalWeight).toFixed(1) : null;
            const last7Days = weightHistory.slice(-7);

            return `
                <!-- Current Stats -->
                <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">‚öñÔ∏è Mi Progreso</h3>
                        <button onclick="openProfileModal()" class="text-white/80 hover:text-white text-sm">‚öôÔ∏è Configurar</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div class="bg-white/20 rounded-xl p-3">
                            <p class="text-2xl font-bold">${latestWeight ? latestWeight.weight : '--'}</p>
                            <p class="text-xs opacity-80">kg actual</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p class="text-2xl font-bold">${profile.goalWeight || '--'}</p>
                            <p class="text-xs opacity-80">kg meta</p>
                        </div>
                        <div class="bg-white/20 rounded-xl p-3">
                            <p class="text-2xl font-bold">${goalDiff ? (goalDiff > 0 ? '-' + goalDiff : '+' + Math.abs(goalDiff)) : '--'}</p>
                            <p class="text-xs opacity-80">kg faltan</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-3">
                    <button onclick="openWeightModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                        <span class="text-xl">‚öñÔ∏è</span> Registrar Peso
                    </button>
                </div>

                <!-- Weight Graph -->
                ${weightHistory.length > 1 ? `
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4">üìà Evoluci√≥n del Peso</h4>
                        <div class="h-40 flex items-end gap-1">
                            ${(() => {
                                const weights = last7Days.map(w => w.weight);
                                const min = Math.min(...weights) - 1;
                                const max = Math.max(...weights) + 1;
                                const range = max - min || 1;
                                return last7Days.map((entry, i) => {
                                    const height = ((entry.weight - min) / range) * 100;
                                    const isLatest = i === last7Days.length - 1;
                                    return `
                                        <div class="flex-1 flex flex-col items-center gap-1">
                                            <span class="text-xs font-medium ${isLatest ? 'text-purple-600' : 'text-gray-500'}">${entry.weight}</span>
                                            <div class="w-full ${isLatest ? 'bg-gradient-to-t from-purple-500 to-pink-500' : 'bg-gray-200'} rounded-t" style="height: ${Math.max(height, 10)}%"></div>
                                            <span class="text-xs text-gray-400">${new Date(entry.date).toLocaleDateString('es', {day: 'numeric', month: 'short'}).split(' ')[0]}</span>
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                ` : `
                    <div class="bg-white rounded-2xl p-5 shadow-sm text-center">
                        <span class="text-4xl mb-2 block">üìä</span>
                        <p class="text-gray-500">Registra tu peso para ver el gr√°fico de evoluci√≥n</p>
                    </div>
                `}

                <!-- Latest Measurements -->
                ${latestWeight && (latestWeight.waist || latestWeight.hip || latestWeight.thigh) ? `
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">üìê √öltimas Medidas</h4>
                        <div class="grid grid-cols-4 gap-3 text-center">
                            ${latestWeight.waist ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.waist}</p><p class="text-xs text-gray-500">Cintura</p></div>` : ''}
                            ${latestWeight.hip ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.hip}</p><p class="text-xs text-gray-500">Cadera</p></div>` : ''}
                            ${latestWeight.thigh ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.thigh}</p><p class="text-xs text-gray-500">Pierna</p></div>` : ''}
                            ${latestWeight.arm ? `<div class="bg-gray-50 rounded-xl p-3"><p class="text-lg font-bold text-gray-800">${latestWeight.arm}</p><p class="text-xs text-gray-500">Brazo</p></div>` : ''}
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-right">Actualizado: ${new Date(latestWeight.date).toLocaleDateString('es-CL')}</p>
                    </div>
                ` : ''}

                <!-- Profile Info -->
                <div class="bg-purple-50 border border-purple-200 rounded-2xl p-5">
                    <h4 class="font-bold text-purple-800 mb-2">üë§ Mi Perfil</h4>
                    <div class="text-purple-700 text-sm space-y-1">
                        <p>üìè Estatura: ${profile.height ? profile.height + ' cm' : 'No configurada'}</p>
                        <p>üéØ Meta: ${profile.goalWeight ? profile.goalWeight + ' kg' : 'No configurada'}</p>
                        <p>üìÖ Check-in: ${['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'][profile.checkinDay || 1]}</p>
                    </div>
                </div>
            `;
        }

        function renderGymWorkout(gym, dayIndex, todayWorkout) {
            const completedSets = todayWorkout.exercises.reduce((sum, ex) => sum + ex.sets.filter(s => s).length, 0);
            const totalSets = todayWorkout.exercises.length * 4; // Assume 4 sets per exercise

            return `
                <!-- Today's Routine Header -->
                <div class="bg-gradient-to-br from-rose-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg">
                    <div class="flex items-center gap-4">
                        <span class="text-5xl">${gym.icon}</span>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold">${gym.name}</h3>
                            <p class="opacity-90 text-sm">${daysSpanish[dayIndex]}</p>
                        </div>
                        ${todayWorkout.exercises.length > 0 ? `
                            <div class="text-right">
                                <p class="text-2xl font-bold">${completedSets}</p>
                                <p class="text-xs opacity-80">series</p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Add Exercise Button -->
                <button onclick="openAddWorkoutExerciseModal()" class="w-full flex items-center justify-center gap-2 px-4 py-4 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-dashed border-purple-200">
                    <span class="text-xl">‚ûï</span> Agregar Ejercicio
                </button>

                <!-- Exercises -->
                ${todayWorkout.exercises.length === 0 ? `
                    <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
                        <span class="text-5xl mb-3 block">üèãÔ∏è</span>
                        <p class="text-gray-500 mb-2">No hay ejercicios en tu rutina de hoy</p>
                        <p class="text-sm text-gray-400">Agrega ejercicios para comenzar a trackear</p>
                    </div>
                ` : `
                    <div class="space-y-4">
                        ${todayWorkout.exercises.map((exercise, exIdx) => {
                            const pr = getExercisePR(exercise.name);
                            const lastWeight = getLastWeight(exercise.name);
                            const completedSetsCount = exercise.sets.filter(s => s).length;

                            return `
                                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                                    <div class="p-4 border-b border-gray-100">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <span class="w-10 h-10 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold">${exIdx + 1}</span>
                                                <div>
                                                    <h4 class="font-bold text-gray-800">${exercise.name}</h4>
                                                    <div class="flex gap-3 text-xs text-gray-500">
                                                        ${lastWeight ? `<span>√öltimo: ${lastWeight}kg</span>` : ''}
                                                        ${pr.maxWeight ? `<span class="text-purple-600">üèÜ PR: ${pr.maxWeight}kg</span>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            <button onclick="removeExerciseFromWorkout(${exIdx})" class="text-gray-400 hover:text-red-500 p-2">üóëÔ∏è</button>
                                        </div>
                                    </div>

                                    <!-- Sets -->
                                    <div class="p-4">
                                        <div class="grid grid-cols-4 gap-2 text-center text-xs text-gray-500 mb-2">
                                            <span>SERIE</span>
                                            <span>KG</span>
                                            <span>REPS</span>
                                            <span></span>
                                        </div>
                                        ${[0, 1, 2, 3].map(setIdx => {
                                            const set = exercise.sets[setIdx];
                                            const isCompleted = !!set;
                                            return `
                                                <div class="grid grid-cols-4 gap-2 items-center py-2 ${isCompleted ? 'bg-green-50 -mx-4 px-4 rounded' : ''}">
                                                    <span class="font-bold text-center ${isCompleted ? 'text-green-600' : 'text-gray-400'}">${setIdx + 1}</span>
                                                    <span class="text-center font-medium ${isCompleted ? 'text-gray-800' : 'text-gray-300'}">${set ? set.weight : '-'}</span>
                                                    <span class="text-center font-medium ${isCompleted ? 'text-gray-800' : 'text-gray-300'}">${set ? set.reps : '-'}</span>
                                                    <button onclick="openLogSetModal(${exIdx}, ${setIdx})" class="py-2 px-3 rounded-lg text-sm font-medium transition ${isCompleted ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}">
                                                        ${isCompleted ? '‚úì' : 'Log'}
                                                    </button>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}

                <!-- Tips -->
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                    <h4 class="font-bold text-amber-800 mb-2 text-sm">üí° Tips</h4>
                    <p class="text-amber-700 text-xs">Descanso recomendado: 60-90s entre series. El temporizador se iniciar√° autom√°ticamente al completar cada serie.</p>
                </div>
            `;
        }

        function renderGymHistory() {
            const logs = getWorkoutLogs().slice(-14).reverse(); // Last 14 workouts
            const allExercises = new Set();
            logs.forEach(log => log.exercises.forEach(ex => allExercises.add(ex.name)));

            return `
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-4">üìÖ Entrenamientos Recientes</h4>
                    ${logs.length === 0 ? `
                        <div class="text-center py-6 text-gray-400">
                            <span class="text-4xl mb-2 block">üìã</span>
                            <p>No hay entrenamientos registrados</p>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${logs.map(log => {
                                const totalSets = log.exercises.reduce((sum, ex) => sum + ex.sets.filter(s => s).length, 0);
                                const totalVolume = log.exercises.reduce((sum, ex) => {
                                    return sum + ex.sets.filter(s => s).reduce((s, set) => s + (set.weight * set.reps), 0);
                                }, 0);

                                return `
                                    <div class="p-3 bg-gray-50 rounded-xl">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-medium text-gray-800">${new Date(log.date).toLocaleDateString('es-CL', {weekday: 'short', day: 'numeric', month: 'short'})}</span>
                                            <div class="flex gap-3 text-xs">
                                                <span class="text-purple-600">${log.exercises.length} ejercicios</span>
                                                <span class="text-gray-500">${totalSets} series</span>
                                                <span class="text-green-600">${Math.round(totalVolume).toLocaleString()}kg vol</span>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500">${log.exercises.map(e => e.name).join(', ')}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>

                <!-- PRs Section -->
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-4">üèÜ Mis Records (PRs)</h4>
                    ${allExercises.size === 0 ? `
                        <p class="text-center text-gray-400 py-4">Completa ejercicios para ver tus PRs</p>
                    ` : `
                        <div class="space-y-2">
                            ${Array.from(allExercises).slice(0, 10).map(exName => {
                                const pr = getExercisePR(exName);
                                if (!pr.maxWeight) return '';
                                return `
                                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl">
                                        <span class="text-sm font-medium text-gray-700">${exName}</span>
                                        <span class="font-bold text-orange-600">${pr.maxWeight} kg</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderMeals() {
            const meals = getMeals();
            const isCustomized = customMeals !== null;

            return `
                <div class="space-y-4">
                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddMealModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar Comida
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetMeals()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar
                            </button>
                        ` : ''}
                    </div>

                    ${meals.map((meal, idx) => `
                        <div class="bg-white rounded-2xl p-5 shadow-sm card-hover">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl">${meal.emoji}</span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${meal.name}</h4>
                                    <p class="text-sm text-gray-500">${meal.time}</p>
                                </div>
                                <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium">${meal.macros}</span>
                                <div class="flex gap-1 flex-shrink-0">
                                    <button onclick="openEditMealModal(${idx})" class="btn-icon w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-sm" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="openDeleteModal(${idx}, 'meal')" class="btn-icon w-9 h-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-sm" title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                ${meal.options.map(opt => `
                                    <div class="flex items-center gap-2 text-gray-600">
                                        <span class="w-2 h-2 bg-purple-400 rounded-full flex-shrink-0"></span>
                                        <span>${opt}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-5">
                            <h4 class="font-bold text-red-700 mb-3">‚ùå Prohibidos</h4>
                            <ul class="text-red-600 space-y-2">
                                <li>‚Ä¢ Az√∫car refinada</li>
                                <li>‚Ä¢ Bebidas azucaradas</li>
                                <li>‚Ä¢ Frituras</li>
                                <li>‚Ä¢ Harinas blancas</li>
                                <li>‚Ä¢ Alcohol</li>
                            </ul>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-2xl p-5">
                            <h4 class="font-bold text-green-700 mb-3">‚úÖ Suplementos</h4>
                            <ul class="text-green-600 space-y-2">
                                <li>‚Ä¢ Creatina: 5g AM</li>
                                <li>‚Ä¢ Omega 3: 1000mg</li>
                                <li>‚Ä¢ Vitamina C: 1000mg</li>
                                <li>‚Ä¢ Prote√≠na: 25-30g</li>
                                <li>‚Ä¢ Agua: 3L m√≠nimo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGoals(currentWeek) {
            const goals = getWeeklyGoals();
            const isCustomized = customGoals !== null;

            return `
                <div class="space-y-4">
                    <div class="flex gap-2 mb-4">
                        ${isCustomized ? `
                            <button onclick="resetGoals()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar Metas Originales
                            </button>
                        ` : ''}
                    </div>

                    ${goals.map((goal, idx) => `
                        <div class="rounded-2xl p-5 shadow-sm transition-all ${
                            goal.week === currentWeek
                                ? 'bg-gradient-to-r from-rose-500 to-purple-600 text-white ring-4 ring-purple-200 glow'
                                : goal.week < currentWeek
                                ? 'bg-gray-100 opacity-70'
                                : 'bg-white'
                        }">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${
                                    goal.week === currentWeek ? 'bg-white/20' : goal.week < currentWeek ? 'bg-green-100 text-green-600' : 'bg-purple-100 text-purple-600'
                                }">
                                    ${goal.week < currentWeek ? '‚úì' : goal.week}
                                </span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-lg">Semana ${goal.week}</h4>
                                    <p class="text-sm ${goal.week === currentWeek ? 'text-white/80' : 'text-gray-500'}">${goal.dates}</p>
                                </div>
                                ${goal.week === currentWeek ? '<span class="px-3 py-1 bg-white/20 rounded-full text-sm animate-pulse">üìç Est√°s aqu√≠</span>' : ''}
                                <button onclick="openEditGoalModal(${idx})" class="btn-icon w-10 h-10 rounded-full ${goal.week === currentWeek ? 'bg-white/20 text-white hover:bg-white/30' : 'bg-blue-100 text-blue-600 hover:bg-blue-200'} flex items-center justify-center" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-rose-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-rose-700'}">üí™ F√≠sica</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.fisica}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-blue-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-blue-700'}">üìö Personal</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.personal}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-purple-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-purple-700'}">üì± Digital</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.digital}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-indigo-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-indigo-700'}">üßò Espiritual</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.espiritual}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Notes Functions
        function getNotes(dateKey) {
            const saved = getStorage(`notes-${dateKey}`);
            return saved || '';
        }

        function saveNotes(dateKey) {
            const textarea = document.getElementById('notesTextarea');
            if (textarea) {
                setStorage(`notes-${dateKey}`, textarea.value);
                showNotification('üìù Nota guardada');
                render(); // Actualizar la vista para mostrar la nota en el historial
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-gradient-to-r from-rose-500 to-purple-600 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-pulse';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function renderNotes(dateKey) {
            const notes = getNotes(dateKey);
            const allNotes = getAllNotesWithContent();

            return `
                <div class="space-y-4">
                    <!-- Editor de nota del d√≠a -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">üìù</span>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">Notas del D√≠a</h3>
                                <p class="text-gray-500 text-sm">Escribe tus pensamientos, reflexiones o recordatorios</p>
                            </div>
                        </div>
                        <textarea
                            id="notesTextarea"
                            class="w-full h-48 p-4 border border-gray-200 rounded-xl resize-none focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none text-gray-700"
                            placeholder="¬øQu√© quieres recordar de hoy? ‚ú®"
                            onblur="saveNotes('${dateKey}')"
                        >${notes}</textarea>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-sm text-gray-400">Se guarda autom√°ticamente</span>
                            <button onclick="saveNotes('${dateKey}')" class="px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium text-sm">
                                üíæ Guardar
                            </button>
                        </div>
                    </div>

                    <!-- Historial de notas -->
                    ${allNotes.length > 0 ? `
                        <div class="bg-white rounded-2xl p-5 shadow-sm">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">üìö Historial de Notas</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${allNotes.map(note => `
                                    <div class="p-4 bg-gradient-to-r from-rose-50 to-purple-50 rounded-xl border border-purple-100 ${note.dateKey === dateKey ? 'ring-2 ring-purple-300' : ''}">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-medium text-purple-600">${formatNoteDate(note.dateKey)}</span>
                                                ${note.dateKey === dateKey ? '<span class="text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full">Hoy</span>' : ''}
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button onclick="editNote('${note.dateKey}')" class="text-sm text-purple-500 hover:text-purple-700 transition" title="Editar nota">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                <button onclick="deleteNote('${note.dateKey}')" class="text-sm text-red-400 hover:text-red-600 transition" title="Eliminar nota">
                                                    üóëÔ∏è
                                                </button>
                                                <button onclick="goToNoteDate('${note.dateKey}')" class="text-sm text-gray-400 hover:text-purple-600 transition">
                                                    üìÖ Ver d√≠a
                                                </button>
                                            </div>
                                        </div>
                                        <p class="text-gray-700 text-sm whitespace-pre-wrap line-clamp-3">${note.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-white rounded-2xl p-8 shadow-sm text-center">
                            <span class="text-5xl">‚ú®</span>
                            <p class="text-gray-500 mt-3">A√∫n no tienes notas guardadas</p>
                            <p class="text-gray-400 text-sm">Empieza a escribir tus reflexiones diarias</p>
                        </div>
                    `}
                </div>
            `;
        }

        function getAllNotesWithContent() {
            const notes = [];
            const prefix = `${userKey}-notes-`;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(prefix)) {
                    const dateKey = key.replace(prefix, '');
                    const content = localStorage.getItem(key);
                    if (content && content.trim()) {
                        notes.push({ dateKey, content });
                    }
                }
            }

            // Ordenar por fecha (m√°s reciente primero)
            notes.sort((a, b) => b.dateKey.localeCompare(a.dateKey));
            return notes.slice(0, 10); // √öltimas 10 notas
        }

        function formatNoteDate(dateKey) {
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                return date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            }
            return dateKey;
        }

        function goToNoteDate(dateKey) {
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                currentDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                render();
            }
        }

        function editNote(dateKey) {
            // Navegar al d√≠a de la nota
            const parts = dateKey.split('-');
            if (parts.length === 3) {
                currentDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                activeTab = 'notes';
                render();
                // Enfocar el textarea despu√©s del render
                setTimeout(() => {
                    const textarea = document.getElementById('notesTextarea');
                    if (textarea) {
                        textarea.focus();
                        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        function deleteNote(dateKey) {
            if (confirm('¬øEliminar esta nota? Esta acci√≥n no se puede deshacer.')) {
                setStorage(`notes-${dateKey}`, '');
                showNotification('üóëÔ∏è Nota eliminada');
                render();
            }
        }

        // Pomodoro Timer Functions
        let pomodoroState = {
            timeLeft: 25 * 60, // seconds
            initialTime: 25 * 60,
            isRunning: false,
            interval: null,
            mode: 'work' // 'work' or 'break'
        };

        function openPomodoroModal() {
            document.getElementById('pomodoroModal').classList.remove('hidden');
            updatePomodoroDisplay();
            updatePomodoroCount();
        }

        function closePomodoroModal() {
            document.getElementById('pomodoroModal').classList.add('hidden');
        }

        function setPomodoroTime(minutes) {
            if (pomodoroState.isRunning) {
                stopPomodoroTimer();
            }
            pomodoroState.timeLeft = minutes * 60;
            pomodoroState.initialTime = minutes * 60;
            pomodoroState.mode = minutes === 25 ? 'work' : 'break';
            updatePomodoroDisplay();
            updatePomodoroStatus();
        }

        function togglePomodoro() {
            if (pomodoroState.isRunning) {
                stopPomodoroTimer();
            } else {
                startPomodoroTimer();
            }
        }

        function startPomodoroTimer() {
            pomodoroState.isRunning = true;
            updatePomodoroButton();
            updatePomodoroStatus();
            updateFloatButton();

            pomodoroState.interval = setInterval(() => {
                pomodoroState.timeLeft--;

                if (pomodoroState.timeLeft <= 0) {
                    completePomodoroSession();
                } else {
                    updatePomodoroDisplay();
                    updateFloatButton();
                }
            }, 1000);
        }

        function stopPomodoroTimer() {
            pomodoroState.isRunning = false;
            if (pomodoroState.interval) {
                clearInterval(pomodoroState.interval);
                pomodoroState.interval = null;
            }
            updatePomodoroButton();
            updatePomodoroStatus();
            updateFloatButton();
        }

        function resetPomodoro() {
            stopPomodoroTimer();
            pomodoroState.timeLeft = pomodoroState.initialTime;
            updatePomodoroDisplay();
            updatePomodoroStatus();
        }

        function completePomodoroSession() {
            stopPomodoroTimer();

            // Sound notification (optional beep)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQsAZJrk47JuCQdkne3os2oEB2Oc8++tbAQEZJ328a5tAwRjnfj0r24DBGOd+fWvbgMEY534862tAwRinfbzrKsDBGKd9fKqqQMEYp3086qpAwRinfTyqagDBGKc8/GoqAMDYpzz8aipAwRinfPyqagDBGKc8/GnqAMEYpzz8aepAwRinfPxp6gDBGKc8/GnqAMEYpzz8aepAwRinfPyp6gDBGKc8/KnqQMDYp3z8qipAwRjnfPyqagDBGOd8/KoqAMEY53z8qipAwRjnfPyqKkDBGOd8/KoqQMEY530');
                audio.volume = 0.5;
                audio.play();
            } catch(e) {}

            if (pomodoroState.mode === 'work') {
                // Incrementar contador de pomodoros
                incrementPomodoroCount();
                showNotification('üçÖ ¬°Pomodoro completado! Toma un descanso.');

                // Cambiar a break
                pomodoroState.mode = 'break';
                pomodoroState.timeLeft = 5 * 60;
                pomodoroState.initialTime = 5 * 60;
            } else {
                showNotification('‚òï ¬°Descanso terminado! ¬øListo para otro Pomodoro?');

                // Volver a work
                pomodoroState.mode = 'work';
                pomodoroState.timeLeft = 25 * 60;
                pomodoroState.initialTime = 25 * 60;
            }

            updatePomodoroDisplay();
            updatePomodoroStatus();
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroState.timeLeft / 60);
            const seconds = pomodoroState.timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pomodoroDisplay').textContent = display;
        }

        function updatePomodoroButton() {
            const btn = document.getElementById('pomodoroStartBtn');
            if (pomodoroState.isRunning) {
                btn.innerHTML = '‚è∏Ô∏è Pausar';
            } else {
                btn.innerHTML = '‚ñ∂Ô∏è Iniciar';
            }
        }

        function updatePomodoroStatus() {
            const status = document.getElementById('pomodoroStatus');
            if (pomodoroState.isRunning) {
                status.textContent = pomodoroState.mode === 'work' ? 'üî• Enfocado...' : '‚òï Descansando...';
            } else {
                status.textContent = pomodoroState.mode === 'work' ? '‚è±Ô∏è Listo para trabajar' : '‚òï Listo para descansar';
            }
        }

        function updateFloatButton() {
            const btn = document.getElementById('pomodoroFloatBtn');
            if (pomodoroState.isRunning) {
                const minutes = Math.floor(pomodoroState.timeLeft / 60);
                const seconds = pomodoroState.timeLeft % 60;
                btn.innerHTML = `<span class="text-sm font-mono">${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                btn.classList.add('animate-pulse');
            } else {
                btn.innerHTML = 'üçÖ';
                btn.classList.remove('animate-pulse');
            }
        }

        function getPomodoroCountKey() {
            const today = new Date();
            return `pomodoro-count-${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        }

        function getPomodoroCount() {
            return parseInt(getStorage(getPomodoroCountKey()) || '0');
        }

        function incrementPomodoroCount() {
            const count = getPomodoroCount() + 1;
            setStorage(getPomodoroCountKey(), count.toString());
            updatePomodoroCount();
        }

        function updatePomodoroCount() {
            const countEl = document.getElementById('pomodoroCount');
            if (countEl) {
                countEl.textContent = getPomodoroCount();
            }
        }

        // Export Functions
        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportToCSV() {
            const data = collectExportData();
            let csv = 'Fecha,Hora,Actividad,Duraci√≥n,Categor√≠a,Completada\n';

            data.activities.forEach(item => {
                csv += `"${item.date}","${item.time}","${item.activity}","${item.duration}","${item.category}","${item.completed ? 'S√≠' : 'No'}"\n`;
            });

            csv += '\n\nH√°bitos del d√≠a\n';
            csv += 'Fecha,H√°bito,Completado\n';
            data.habits.forEach(habit => {
                csv += `"${habit.date}","${habit.name}","${habit.completed ? 'S√≠' : 'No'}"\n`;
            });

            downloadFile(csv, `gestion-tiempo-${formatDateForFile(new Date())}.csv`, 'text/csv');
            showNotification('üìä CSV exportado exitosamente');
            closeExportModal();
        }

        function exportToPrint() {
            const data = collectExportData();
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Mi Plan - ${currentUser.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #8b5cf6; }
                        h2 { color: #ec4899; margin-top: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: linear-gradient(135deg, #fdf2f8, #f3e8ff); }
                        .completed { background: #dcfce7; }
                        .progress { margin: 20px 0; padding: 15px; background: #f3e8ff; border-radius: 10px; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <h1>üìã Mi Plan de Gesti√≥n del Tiempo</h1>
                    <p><strong>Usuario:</strong> ${currentUser.name}</p>
                    <p><strong>Meta:</strong> ${getGoalText(currentUser.goal)}</p>
                    <p><strong>Fecha de exportaci√≥n:</strong> ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>

                    <div class="progress">
                        <strong>Progreso:</strong> D√≠a ${getDailyProgress(currentDate)}% | Semana ${getWeeklyProgress()}% | Total ${getTotalProgress()}%
                    </div>

                    <h2>üìÖ Actividades de Hoy</h2>
                    <table>
                        <tr><th>Hora</th><th>Actividad</th><th>Duraci√≥n</th><th>Estado</th></tr>
                        ${data.todayActivities.map(item => `
                            <tr class="${item.completed ? 'completed' : ''}">
                                <td>${item.time}</td>
                                <td>${item.activity}</td>
                                <td>${item.duration}</td>
                                <td>${item.completed ? '‚úÖ' : '‚è≥'}</td>
                            </tr>
                        `).join('')}
                    </table>

                    <h2>‚úÖ H√°bitos de Hoy</h2>
                    <table>
                        <tr><th>H√°bito</th><th>Estado</th></tr>
                        ${data.todayHabits.map(habit => `
                            <tr class="${habit.completed ? 'completed' : ''}">
                                <td>${habit.icon} ${habit.name}</td>
                                <td>${habit.completed ? '‚úÖ' : '‚è≥'}</td>
                            </tr>
                        `).join('')}
                    </table>

                    <h2>üéØ Metas de la Semana</h2>
                    ${data.weeklyGoals.map(goal => `
                        <p><strong>${goal.category}:</strong> ${goal.text}</p>
                    `).join('')}

                    <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
                </body>
                </html>
            `);

            printWindow.document.close();
            closeExportModal();
        }

        function exportWeekSummary() {
            const data = collectExportData();
            let summary = `üìã RESUMEN SEMANAL - ${currentUser.name}\n`;
            summary += `${'='.repeat(50)}\n\n`;
            summary += `üìÖ Semana ${getWeekNumber(currentDate)} de ${totalWeeks}\n`;
            summary += `üìä Progreso Semanal: ${getWeeklyProgress()}%\n\n`;

            summary += `üéØ METAS DE LA SEMANA\n`;
            summary += `${'-'.repeat(30)}\n`;
            data.weeklyGoals.forEach(goal => {
                summary += `${goal.category}: ${goal.text}\n`;
            });

            summary += `\nüìÖ ACTIVIDADES DEL D√çA\n`;
            summary += `${'-'.repeat(30)}\n`;
            data.todayActivities.forEach(item => {
                summary += `${item.completed ? '‚úÖ' : '‚è≥'} ${item.time} - ${item.activity} (${item.duration})\n`;
            });

            summary += `\n‚úÖ H√ÅBITOS\n`;
            summary += `${'-'.repeat(30)}\n`;
            data.todayHabits.forEach(habit => {
                summary += `${habit.completed ? '‚úÖ' : '‚è≥'} ${habit.icon} ${habit.name}\n`;
            });

            summary += `\nüí™ ¬°Sigue adelante, ${currentUser.name.split(' ')[0]}! üí™\n`;

            downloadFile(summary, `resumen-semana-${getWeekNumber(currentDate)}.txt`, 'text/plain');
            showNotification('üìã Resumen exportado');
            closeExportModal();
        }

        function collectExportData() {
            const dateKey = getDateKey(currentDate);
            const schedule = getSchedule();
            const habits = getHabits();
            const goals = getWeeklyGoals();
            const weekNum = getWeekNumber(currentDate);

            return {
                todayActivities: schedule.map((item, idx) => ({
                    ...item,
                    completed: completedActivities[`${dateKey}-${idx}`] || false
                })),
                todayHabits: habits.map((habit, idx) => ({
                    ...habit,
                    completed: completedHabits[`${dateKey}-${idx}`] || false
                })),
                weeklyGoals: goals.filter(g => g.week === weekNum).map(g => [
                    { category: 'üí™ F√≠sica', text: g.fisica },
                    { category: 'üìö Personal', text: g.personal },
                    { category: 'üì± Digital', text: g.digital },
                    { category: 'üßò Espiritual', text: g.espiritual }
                ]).flat(),
                activities: schedule.map((item, idx) => ({
                    date: dateKey,
                    ...item,
                    completed: completedActivities[`${dateKey}-${idx}`] || false
                })),
                habits: habits.map((habit, idx) => ({
                    date: dateKey,
                    ...habit,
                    completed: completedHabits[`${dateKey}-${idx}`] || false
                }))
            };
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatDateForFile(date) {
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        // Search and Filter Functions
        function filterActivities() {
            const input = document.getElementById('searchInput');
            searchQuery = input ? input.value : '';
            render();
            // Restaurar foco al input despu√©s del render
            setTimeout(() => {
                const newInput = document.getElementById('searchInput');
                if (newInput) {
                    newInput.focus();
                    newInput.setSelectionRange(newInput.value.length, newInput.value.length);
                }
            }, 0);
        }

        function setFilter(category) {
            activeFilter = category;
            render();
        }

        function clearFilters() {
            searchQuery = '';
            activeFilter = '';
            render();
        }

        // Dashboard Toggle
        function toggleDashboard() {
            dashboardVisible = !dashboardVisible;
            setStorage('dashboard-visible', dashboardVisible.toString());
            render();
        }

        // Share Functions
        function openShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.remove('hidden');

            // Update share preview data
            const dailyProgress = getDailyProgress(currentDate);
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const currentStreak = getStreak();
            const bestStreak = getBestStreak();

            document.getElementById('shareDailyProgress').textContent = dailyProgress + '%';
            document.getElementById('shareWeeklyProgress').textContent = weeklyProgress + '%';
            document.getElementById('shareTotalProgress').textContent = totalProgress + '%';
            document.getElementById('shareStreak').textContent = currentStreak;
            document.getElementById('shareBestStreak').textContent = bestStreak;

            const message = totalProgress === 100 ? 'üèÜ ¬°Complet√© mi programa!' :
                           currentStreak >= 7 ? 'üî• ¬°' + currentStreak + ' d√≠as de racha!' :
                           currentStreak >= 3 ? 'üí™ ¬°Sigo avanzando!' :
                           '‚ú® ¬°Trabajando en mis metas!';
            document.getElementById('shareMessage').textContent = message;
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        function getShareText() {
            const dailyProgress = getDailyProgress(currentDate);
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const currentStreak = getStreak();

            let text = `üéØ Mi progreso en Gesti√≥n del Tiempo\n\n`;
            text += `üìä Hoy: ${dailyProgress}% | Semana: ${weeklyProgress}% | Total: ${totalProgress}%\n`;
            text += `üî• Racha: ${currentStreak} d√≠as\n\n`;

            if (totalProgress === 100) {
                text += `üèÜ ¬°Complet√© mi programa de ${userDuration} d√≠as!\n\n`;
            } else if (currentStreak >= 7) {
                text += `üí™ ¬°${currentStreak} d√≠as seguidos trabajando en mis metas!\n\n`;
            } else {
                text += `‚ú® Cada d√≠a cuenta. ¬°T√∫ tambi√©n puedes!\n\n`;
            }

            text += `#GestionDelTiempo #Productividad #Metas`;
            return text;
        }

        function copyShareText() {
            const text = getShareText();
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã Texto copiado al portapapeles');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('üìã Texto copiado');
            });
        }

        function shareToTwitter() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        function shareToWhatsApp() {
            const text = encodeURIComponent(getShareText());
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function shareNative() {
            if (navigator.share) {
                navigator.share({
                    title: 'Mi Progreso - Gesti√≥n del Tiempo',
                    text: getShareText()
                }).catch(() => {
                    copyShareText();
                });
            } else {
                copyShareText();
            }
        }

        // Template Functions
        function getTemplates() {
            return JSON.parse(getStorage('day-templates') || '[]');
        }

        function saveTemplates(templates) {
            setStorage('day-templates', JSON.stringify(templates));
        }

        function openTemplateModal() {
            document.getElementById('templateModal').classList.remove('hidden');
            renderCommunityTemplates();
            renderTemplatesList();
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.add('hidden');
        }

        function renderCommunityTemplates() {
            const container = document.getElementById('communityTemplatesList');

            container.innerHTML = communityTemplates.map(template => `
                <div class="bg-gradient-to-r from-amber-50 via-orange-50 to-rose-50 rounded-xl p-4 border-2 border-amber-200 hover:border-amber-300 transition cursor-pointer group">
                    <div class="flex items-start gap-3">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-2xl shadow-lg group-hover:scale-105 transition">
                            ${template.icon}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h5 class="font-bold text-gray-800">${template.name}</h5>
                                <span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">${template.duration} d√≠as</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">por ${template.author}</p>
                            <p class="text-sm text-gray-600 mb-3">${template.description}</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-2 py-1 bg-rose-100 text-rose-600 rounded-lg text-xs">üí™ ${Object.keys(template.gymFocus).length} rutinas gym</span>
                                <span class="px-2 py-1 bg-green-100 text-green-600 rounded-lg text-xs">‚úÖ ${template.habits.length} h√°bitos</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs">ü•ó ${template.meals.length} comidas</span>
                                <span class="px-2 py-1 bg-purple-100 text-purple-600 rounded-lg text-xs">üéØ ${template.weeklyGoals.length} semanas</span>
                            </div>
                            <button onclick="previewUserTemplate('${template.id}')" class="w-full py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg text-sm font-medium hover:opacity-90 transition flex items-center justify-center gap-2">
                                <span>‚ú®</span> Ver y Cargar Plan Completo
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function previewUserTemplate(templateId) {
            const template = communityTemplates.find(t => t.id === templateId);
            if (!template) return;

            const previewHtml = `
                <div class="text-center mb-4">
                    <span class="text-5xl">${template.icon}</span>
                    <h3 class="text-xl font-bold text-gray-800 mt-2">${template.name}</h3>
                    <p class="text-sm text-gray-500">por ${template.author}</p>
                </div>

                <div class="bg-amber-50 rounded-xl p-4 mb-4">
                    <p class="text-sm text-amber-800 font-medium mb-2">‚ö†Ô∏è Esto cargar√°:</p>
                    <ul class="text-sm text-amber-700 space-y-1">
                        <li>‚Ä¢ Rutinas de gimnasio personalizadas</li>
                        <li>‚Ä¢ Lista de ${template.habits.length} h√°bitos diarios</li>
                        <li>‚Ä¢ Plan de ${template.meals.length} comidas</li>
                        <li>‚Ä¢ Metas semanales (${template.weeklyGoals.length} semanas)</li>
                    </ul>
                </div>

                <p class="text-gray-600 text-sm text-center mb-4">
                    Tus datos actuales se mantendr√°n. Los nuevos datos se agregar√°n como tu configuraci√≥n personalizada.
                </p>

                <div class="flex gap-3">
                    <button onclick="closePreviewModal()" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition font-medium">
                        Cancelar
                    </button>
                    <button onclick="applyUserTemplate('${template.id}')" class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl hover:opacity-90 transition font-bold">
                        üöÄ Cargar Plan
                    </button>
                </div>
            `;

            // Create preview modal dynamically
            let previewModal = document.getElementById('previewTemplateModal');
            if (!previewModal) {
                previewModal = document.createElement('div');
                previewModal.id = 'previewTemplateModal';
                previewModal.className = 'fixed inset-0 modal-backdrop z-[60] flex items-center justify-center p-4';
                previewModal.onclick = function(e) { if (e.target === this) closePreviewModal(); };
                document.body.appendChild(previewModal);
            }

            previewModal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all" onclick="event.stopPropagation()">
                    ${previewHtml}
                </div>
            `;
            previewModal.classList.remove('hidden');
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewTemplateModal');
            if (modal) modal.classList.add('hidden');
        }

        function applyUserTemplate(templateId) {
            const template = communityTemplates.find(t => t.id === templateId);
            if (!template) return;

            // Apply gym routines
            for (const [day, routine] of Object.entries(template.gymFocus)) {
                customGym[parseInt(day)] = { ...routine };
            }
            setStorage('custom-gym', JSON.stringify(customGym));

            // Apply habits
            customHabits = [...template.habits];
            setStorage('custom-habits', JSON.stringify(customHabits));

            // Apply meals
            customMeals = [...template.meals];
            setStorage('custom-meals', JSON.stringify(customMeals));

            // Apply weekly goals
            customGoals = [...template.weeklyGoals];
            setStorage('custom-goals', JSON.stringify(customGoals));

            // Close modals
            closePreviewModal();
            closeTemplateModal();

            // Show success notification with confetti
            createCelebration();
            showNotification(`üëë ¬°Plan "${template.name}" cargado exitosamente!`);

            render();
        }

        function saveTemplate() {
            const nameInput = document.getElementById('templateName');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Por favor ingresa un nombre para la plantilla');
                return;
            }

            const schedule = getSchedule();
            const templates = getTemplates();

            templates.push({
                id: Date.now(),
                name: name,
                activities: schedule,
                createdAt: new Date().toISOString()
            });

            saveTemplates(templates);
            nameInput.value = '';
            showNotification('üìã Plantilla guardada');
            renderTemplatesList();
        }

        function renderTemplatesList() {
            const container = document.getElementById('templatesList');
            const templates = getTemplates();

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-400">
                        <span class="text-4xl block mb-2">üìÅ</span>
                        <p>No hay plantillas guardadas</p>
                        <p class="text-sm">Guarda el d√≠a actual para crear una</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = templates.map(template => `
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <p class="font-medium text-gray-800">${template.name}</p>
                            <p class="text-xs text-gray-400">${template.activities.length} actividades</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="applyTemplate(${template.id})" class="px-3 py-1 bg-purple-100 text-purple-600 rounded-lg text-sm font-medium hover:bg-purple-200 transition">
                                Aplicar
                            </button>
                            <button onclick="deleteTemplate(${template.id})" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-medium hover:bg-red-200 transition">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 space-y-1 max-h-24 overflow-y-auto">
                        ${template.activities.slice(0, 4).map(a => `<p>‚Ä¢ ${a.time} - ${a.activity}</p>`).join('')}
                        ${template.activities.length > 4 ? `<p class="text-gray-400">+${template.activities.length - 4} m√°s...</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function applyTemplate(templateId) {
            const templates = getTemplates();
            const template = templates.find(t => t.id === templateId);

            if (!template) return;

            if (confirm(`¬øAplicar la plantilla "${template.name}" al d√≠a actual? Esto reemplazar√° las actividades existentes.`)) {
                const dateKey = getDateKey(currentDate);
                customSchedules[dateKey] = [...template.activities];
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                showNotification('üìã Plantilla aplicada');
                closeTemplateModal();
                render();
            }
        }

        function deleteTemplate(templateId) {
            if (confirm('¬øEliminar esta plantilla?')) {
                let templates = getTemplates();
                templates = templates.filter(t => t.id !== templateId);
                saveTemplates(templates);
                showNotification('üóëÔ∏è Plantilla eliminada');
                renderTemplatesList();
            }
        }

        // Clean Section Functions
        let cleanSection = '';

        function openCleanModal(section) {
            cleanSection = section;
            const modal = document.getElementById('cleanModal');
            const description = document.getElementById('cleanModalDescription');
            const options = document.getElementById('cleanOptions');

            const sectionNames = {
                agenda: 'Agenda',
                habits: 'H√°bitos',
                gym: 'Gimnasio',
                meals: 'Comidas',
                goals: 'Metas'
            };

            description.textContent = `Opciones de limpieza para ${sectionNames[section] || section}`;

            let optionsHtml = '';

            if (section === 'agenda') {
                optionsHtml = `
                    <button onclick="cleanDayProgress()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">‚úÖ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Limpiar progreso del d√≠a</p>
                            <p class="text-sm text-gray-500">Desmarcar todas las actividades completadas</p>
                        </div>
                    </button>
                    <button onclick="clearDayActivities()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">üßπ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Vaciar actividades del d√≠a</p>
                            <p class="text-sm text-gray-500">Eliminar TODAS las actividades de hoy (dejar vac√≠o)</p>
                        </div>
                    </button>
                    <button onclick="cleanDayActivities()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-blue-300 hover:bg-blue-50 transition">
                        <span class="text-2xl">üîÑ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Restaurar actividades por defecto</p>
                            <p class="text-sm text-gray-500">Volver al horario predeterminado del d√≠a</p>
                        </div>
                    </button>
                    <button onclick="cleanAllProgress()" class="w-full flex items-center gap-3 p-4 border-2 border-red-100 rounded-xl hover:border-red-400 hover:bg-red-50 transition">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <div class="text-left">
                            <p class="font-medium text-red-600">Limpiar TODO el progreso</p>
                            <p class="text-sm text-gray-500">Eliminar todas las actividades completadas de todos los d√≠as</p>
                        </div>
                    </button>
                `;
            } else if (section === 'habits') {
                optionsHtml = `
                    <button onclick="cleanDayHabits()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">‚úÖ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Limpiar h√°bitos del d√≠a</p>
                            <p class="text-sm text-gray-500">Desmarcar todos los h√°bitos completados hoy</p>
                        </div>
                    </button>
                    <button onclick="cleanAllHabits()" class="w-full flex items-center gap-3 p-4 border-2 border-red-100 rounded-xl hover:border-red-400 hover:bg-red-50 transition">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                        <div class="text-left">
                            <p class="font-medium text-red-600">Limpiar TODOS los h√°bitos</p>
                            <p class="text-sm text-gray-500">Eliminar todo el progreso de h√°bitos de todos los d√≠as</p>
                        </div>
                    </button>
                `;
            } else if (section === 'gym') {
                optionsHtml = `
                    <button onclick="cleanDayGym()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-orange-300 hover:bg-orange-50 transition">
                        <span class="text-2xl">‚úÖ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Limpiar ejercicios del d√≠a</p>
                            <p class="text-sm text-gray-500">Desmarcar todos los ejercicios completados</p>
                        </div>
                    </button>
                    <button onclick="cleanCustomGym()" class="w-full flex items-center gap-3 p-4 border-2 border-gray-100 rounded-xl hover:border-red-300 hover:bg-red-50 transition">
                        <span class="text-2xl">üîÑ</span>
                        <div class="text-left">
                            <p class="font-medium text-gray-800">Restaurar rutina por defecto</p>
                            <p class="text-sm text-gray-500">Eliminar ejercicios personalizados del d√≠a</p>
                        </div>
                    </button>
                `;
            }

            options.innerHTML = optionsHtml;
            modal.classList.remove('hidden');
        }

        function closeCleanModal() {
            document.getElementById('cleanModal').classList.add('hidden');
            cleanSection = '';
        }

        function cleanDayProgress() {
            if (confirm('¬øDesmarcar todas las actividades completadas de hoy?')) {
                const dateKey = getDateKey(currentDate);
                const schedule = getSchedule();

                schedule.forEach((_, idx) => {
                    delete completedActivities[`${dateKey}-${idx}`];
                });

                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('‚úÖ Progreso del d√≠a limpiado');
                closeCleanModal();
                render();
            }
        }

        function clearDayActivities() {
            if (confirm('¬øVaciar TODAS las actividades de hoy? El d√≠a quedar√° sin actividades.')) {
                const dateKey = getDateKey(currentDate);
                // Set empty array as custom schedule for this day
                customSchedules[dateKey] = [];
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                // Also clear completed activities for this day
                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(dateKey)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('üßπ Actividades del d√≠a eliminadas');
                closeCleanModal();
                render();
            }
        }

        function cleanDayActivities() {
            if (confirm('¬øRestaurar las actividades del d√≠a a las predeterminadas?')) {
                const dateKey = getDateKey(currentDate);
                delete customSchedules[dateKey];
                setStorage('custom-schedules', JSON.stringify(customSchedules));
                showNotification('üîÑ Actividades restauradas');
                closeCleanModal();
                render();
            }
        }

        function cleanAllProgress() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODO el progreso de actividades de TODOS los d√≠as. Esta acci√≥n no se puede deshacer.')) {
                completedActivities = {};
                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('üóëÔ∏è Todo el progreso ha sido eliminado');
                closeCleanModal();
                render();
            }
        }

        function cleanDayHabits() {
            if (confirm('¬øDesmarcar todos los h√°bitos completados de hoy?')) {
                const dateKey = getDateKey(currentDate);
                const habits = getHabits();

                habits.forEach((habit, idx) => {
                    delete checkedHabits[`${dateKey}-${habit.id}`];
                    delete checkedHabits[`${dateKey}-${idx}`];
                });

                setStorage('habits', JSON.stringify(checkedHabits));
                showNotification('‚úÖ H√°bitos del d√≠a limpiados');
                closeCleanModal();
                render();
            }
        }

        function cleanAllHabits() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODO el progreso de h√°bitos de TODOS los d√≠as.')) {
                checkedHabits = {};
                setStorage('habits', JSON.stringify(checkedHabits));
                showNotification('üóëÔ∏è Todo el progreso de h√°bitos eliminado');
                closeCleanModal();
                render();
            }
        }

        function cleanDayGym() {
            if (confirm('¬øDesmarcar todos los ejercicios completados de hoy?')) {
                const dateKey = getDateKey(currentDate);
                // Clean gym exercises for the day
                const prefix = `${dateKey}-gym-`;
                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(prefix)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));
                showNotification('‚úÖ Ejercicios del d√≠a limpiados');
                closeCleanModal();
                render();
            }
        }

        function cleanCustomGym() {
            if (confirm('¬øRestaurar la rutina de gimnasio por defecto?')) {
                const dayIndex = currentDate.getDay();
                delete customGym[dayIndex];
                setStorage('custom-gym', JSON.stringify(customGym));
                showNotification('üîÑ Rutina restaurada');
                closeCleanModal();
                render();
            }
        }

        // Statistics Functions
        function getWeeklyProgressData() {
            const data = [];
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const inRange = date >= startDate && date <= endDate;
                data.push({
                    day: daysSpanish[i].substring(0, 3),
                    progress: inRange ? getDailyProgress(date) : 0,
                    isToday: date.toDateString() === currentDate.toDateString(),
                    inRange: inRange
                });
            }
            return data;
        }

        function getCategoryDistribution() {
            const schedule = getSchedule();
            const distribution = {};

            if (!schedule || schedule.length === 0) {
                return [];
            }

            schedule.forEach(item => {
                const cat = item.category || 'personal';
                distribution[cat] = (distribution[cat] || 0) + 1;
            });

            return Object.entries(distribution).map(([category, count]) => ({
                category,
                count,
                percentage: Math.round((count / schedule.length) * 100)
            }));
        }

        function getHistoricalData() {
            const data = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                if (date >= startDate) {
                    data.push({
                        date: date,
                        label: `${date.getDate()}/${date.getMonth() + 1}`,
                        progress: getDailyProgress(date)
                    });
                }
            }
            return data;
        }

        function getCompletionStats() {
            let totalDays = 0;
            let completedDays = 0;
            let totalTasks = 0;
            let completedTasks = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const checkDate = new Date(startDate);
            while (checkDate <= today && checkDate <= endDate) {
                totalDays++;
                const progress = getDailyProgress(checkDate);
                if (progress === 100) completedDays++;

                const dateKey = getDateKey(checkDate);
                const schedule = getScheduleForDate(checkDate);
                totalTasks += schedule.length;
                completedTasks += schedule.filter((_, idx) => completedActivities[`${dateKey}-${idx}`]).length;

                checkDate.setDate(checkDate.getDate() + 1);
            }

            return {
                totalDays,
                completedDays,
                completionRate: totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0,
                totalTasks,
                completedTasks,
                taskRate: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0
            };
        }

        function getScheduleForDate(date) {
            const dateKey = getDateKey(date);
            if (customSchedules[dateKey]) {
                return customSchedules[dateKey];
            }
            return getDefaultSchedule(date.getDay());
        }

        // ==================== EXPENSES MODULE ====================

        let cameraStream = null;
        let currentReceiptImage = null;

        function getExpenses() {
            return JSON.parse(getStorage('expenses') || '[]');
        }

        function saveExpenses(expenses) {
            setStorage('expenses', JSON.stringify(expenses));
        }

        function getExpenseCategoryIcon(category) {
            const icons = {
                alimentacion: 'üçî',
                transporte: 'üöó',
                salud: 'üíä',
                entretenimiento: 'üé¨',
                ropa: 'üëï',
                servicios: 'üì±',
                hogar: 'üè†',
                educacion: 'üìö',
                otro: 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        function getExpenseCategoryName(category) {
            const names = {
                alimentacion: 'Alimentaci√≥n',
                transporte: 'Transporte',
                salud: 'Salud',
                entretenimiento: 'Entretenimiento',
                ropa: 'Ropa',
                servicios: 'Servicios',
                hogar: 'Hogar',
                educacion: 'Educaci√≥n',
                otro: 'Otro'
            };
            return names[category] || 'Otro';
        }

        function renderGastos() {
            const expenses = getExpenses();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // Filter expenses for current month
            const monthlyExpenses = expenses.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const totalMonth = monthlyExpenses.reduce((sum, e) => sum + parseFloat(e.total || 0), 0);

            // Group by category
            const byCategory = {};
            monthlyExpenses.forEach(e => {
                if (!byCategory[e.category]) byCategory[e.category] = 0;
                byCategory[e.category] += parseFloat(e.total || 0);
            });

            // Get recent expenses (last 10)
            const recentExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            return `
                <div class="space-y-4">
                    <!-- Header & Actions -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">üí∞ Control de Gastos</h3>
                            <div class="flex gap-2">
                                <button onclick="openScanReceiptModal()" class="px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl font-medium hover:opacity-90 transition flex items-center gap-2 text-sm">
                                    üì∏ Escanear Boleta
                                </button>
                                <button onclick="openAddExpenseModal()" class="px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition flex items-center gap-2 text-sm">
                                    ‚úèÔ∏è Manual
                                </button>
                            </div>
                        </div>

                        <!-- Monthly Summary -->
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-4 text-white">
                            <p class="text-sm opacity-90">${monthNames[currentMonth]} ${currentYear}</p>
                            <p class="text-3xl font-bold mt-1">$${totalMonth.toLocaleString('es-CL', {minimumFractionDigits: 0})}</p>
                            <p class="text-sm opacity-90 mt-1">${monthlyExpenses.length} gastos registrados</p>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    ${Object.keys(byCategory).length > 0 ? `
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <h4 class="font-bold text-gray-800 mb-3">üìä Por Categor√≠a</h4>
                            <div class="space-y-2">
                                ${Object.entries(byCategory)
                                    .sort((a, b) => b[1] - a[1])
                                    .map(([cat, amount]) => {
                                        const percentage = totalMonth > 0 ? (amount / totalMonth * 100) : 0;
                                        return `
                                            <div class="flex items-center gap-3">
                                                <span class="text-xl">${getExpenseCategoryIcon(cat)}</span>
                                                <div class="flex-1">
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span class="text-gray-700">${getExpenseCategoryName(cat)}</span>
                                                        <span class="font-medium text-gray-800">$${amount.toLocaleString('es-CL', {minimumFractionDigits: 0})}</span>
                                                    </div>
                                                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: ${percentage}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Recent Expenses -->
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">üìã √öltimos Gastos</h4>
                        ${recentExpenses.length === 0 ? `
                            <div class="text-center py-8 text-gray-400">
                                <span class="text-4xl block mb-2">üßæ</span>
                                <p>No hay gastos registrados</p>
                                <p class="text-sm mt-1">Escanea una boleta para comenzar</p>
                            </div>
                        ` : `
                            <div class="space-y-2">
                                ${recentExpenses.map((expense, idx) => `
                                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                        <span class="text-2xl">${getExpenseCategoryIcon(expense.category)}</span>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-medium text-gray-800 truncate">${expense.store || 'Sin nombre'}</p>
                                            <p class="text-xs text-gray-500">${new Date(expense.date).toLocaleDateString('es-CL', {day: 'numeric', month: 'short'})}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-gray-800">$${parseFloat(expense.total).toLocaleString('es-CL', {minimumFractionDigits: 0})}</p>
                                        </div>
                                        <button onclick="deleteExpense(${idx})" class="p-2 text-gray-400 hover:text-red-500 transition" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Modal functions
        function openScanReceiptModal() {
            document.getElementById('scanReceiptModal').classList.remove('hidden');
            resetScanModal();
        }

        function closeScanReceiptModal() {
            document.getElementById('scanReceiptModal').classList.add('hidden');
            stopCamera();
            resetScanModal();
        }

        function resetScanModal() {
            document.getElementById('scanStep1').classList.remove('hidden');
            document.getElementById('scanStep2').classList.add('hidden');
            document.getElementById('scanStep3').classList.add('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            currentReceiptImage = null;
            stopCamera();
        }

        function openAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.remove('hidden');
            document.getElementById('manualExpenseDate').value = getTodayKey();
            document.getElementById('manualExpenseStore').value = '';
            document.getElementById('manualExpenseTotal').value = '';
            document.getElementById('manualExpenseDescription').value = '';
        }

        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.add('hidden');
        }

        // Camera functions
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                cameraStream = stream;
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                document.getElementById('cameraContainer').classList.remove('hidden');
            } catch (err) {
                alert('No se pudo acceder a la c√°mara. Por favor, permite el acceso o sube una imagen.');
                console.error('Camera error:', err);
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            const video = document.getElementById('cameraPreview');
            if (video) video.srcObject = null;
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            currentReceiptImage = canvas.toDataURL('image/jpeg', 0.8);

            document.getElementById('receiptImagePreview').src = currentReceiptImage;
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            stopCamera();
        }

        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentReceiptImage = e.target.result;
                document.getElementById('receiptImagePreview').src = currentReceiptImage;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearReceiptImage() {
            currentReceiptImage = null;
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('receiptImagePreview').src = '';
        }

        // OCR Processing
        async function processReceiptImage() {
            if (!currentReceiptImage) return;

            // Show processing step
            document.getElementById('scanStep1').classList.add('hidden');
            document.getElementById('scanStep2').classList.remove('hidden');

            try {
                const progressEl = document.getElementById('ocrProgress');

                // Use Tesseract.js for OCR
                const result = await Tesseract.recognize(
                    currentReceiptImage,
                    'spa', // Spanish
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                progressEl.textContent = `Procesando: ${Math.round(m.progress * 100)}%`;
                            } else {
                                progressEl.textContent = m.status;
                            }
                        }
                    }
                );

                const text = result.data.text;
                console.log('OCR Result:', text);

                // Parse the receipt text
                const parsed = parseReceiptText(text);

                // Fill the form
                document.getElementById('expenseStore').value = parsed.store;
                document.getElementById('expenseDate').value = parsed.date || getTodayKey();
                document.getElementById('expenseTotal').value = parsed.total || '';
                document.getElementById('expenseDescription').value = parsed.description || '';

                if (parsed.items && parsed.items.length > 0) {
                    const itemsContainer = document.getElementById('extractedItemsContainer');
                    const itemsList = document.getElementById('extractedItems');
                    itemsContainer.classList.remove('hidden');
                    itemsList.innerHTML = parsed.items.map(item => `<div class="py-1">${item}</div>`).join('');
                } else {
                    document.getElementById('extractedItemsContainer').classList.add('hidden');
                }

                // Show results form
                document.getElementById('scanStep2').classList.add('hidden');
                document.getElementById('scanStep3').classList.remove('hidden');

            } catch (error) {
                console.error('OCR Error:', error);
                alert('Error al procesar la imagen. Por favor, intenta de nuevo o ingresa los datos manualmente.');
                resetScanModal();
            }
        }

        function parseReceiptText(text) {
            const lines = text.split('\n').filter(l => l.trim());
            let store = '';
            let total = '';
            let date = '';
            let items = [];

            console.log('OCR Text:', text); // Debug

            // Try to find store name - look for EMPRESA keyword or similar
            const storePatterns = [
                /EMPRESA[:\s]*(.+)/i,
                /RAZON\s*SOCIAL[:\s]*(.+)/i,
                /COMERCIO[:\s]*(.+)/i
            ];

            for (const pattern of storePatterns) {
                const match = text.match(pattern);
                if (match) {
                    store = match[1].replace(/[^a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]/g, '').trim();
                    break;
                }
            }

            // Fallback: use first line that looks like a name (not RUT, not BOLETA)
            if (!store) {
                for (const line of lines) {
                    const cleanLine = line.trim();
                    if (!cleanLine.match(/^(RUT|BOLETA|N¬∞|FECHA|CANTIDAD|TOTAL|IVA|\d)/i) && cleanLine.length > 3) {
                        store = cleanLine.replace(/[^a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]/g, '').trim();
                        if (store.length > 3) break;
                    }
                }
            }

            // Try to find total - improved patterns for Chilean receipts
            const totalPatterns = [
                /TOTAL\s*[:\s]*\$?\s*([\d]+[.,][\d]{3})/i,      // TOTAL : $ 6.190
                /TOTAL\s*[:\s]*\$?\s*([\d.,]+)/i,               // TOTAL: $6190
                /TOTAL\s+A\s+PAGAR\s*[:\s]*\$?\s*([\d.,]+)/i,   // TOTAL A PAGAR
                /MONTO\s*TOTAL\s*[:\s]*\$?\s*([\d.,]+)/i,       // MONTO TOTAL
                /MONTO\s*[:\s]*\$?\s*([\d.,]+)/i,               // MONTO
                /\$\s*([\d]+[.,][\d]{3})\s*$/m                   // $ 6.190 at end of line
            ];

            for (const pattern of totalPatterns) {
                const match = text.match(pattern);
                if (match) {
                    // For Chilean pesos: dots are thousand separators, no decimals
                    // Convert "6.190" to "6190"
                    total = match[1].replace(/\./g, '').replace(/,/g, '');
                    console.log('Found total:', match[1], '-> parsed as:', total);
                    break;
                }
            }

            // Try to find date - improved patterns including YYYY-MM-DD
            const datePatterns = [
                /FECHA\s*(?:EMISION)?[:\s]*(\d{4})-(\d{2})-(\d{2})/i,  // FECHA EMISION: 2020-08-16
                /(\d{4})-(\d{2})-(\d{2})/,                              // 2020-08-16
                /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,               // 16/08/2020
                /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,               // 16/08/20
                /(\d{1,2})\s+(?:de\s+)?(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)[a-z]*\s+(?:de\s+)?(\d{2,4})/i
            ];

            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    // Check if it's YYYY-MM-DD format (year comes first)
                    if (match[1].length === 4) {
                        // Already in YYYY-MM-DD format
                        date = `${match[1]}-${match[2]}-${match[3]}`;
                    } else if (match[2].length <= 2 && !isNaN(match[2])) {
                        // DD/MM/YYYY or DD-MM-YYYY format
                        let day = match[1].padStart(2, '0');
                        let month = match[2].padStart(2, '0');
                        let year = match[3].length === 2 ? '20' + match[3] : match[3];
                        date = `${year}-${month}-${day}`;
                    } else {
                        // DD mes YYYY format (e.g., "16 agosto 2020")
                        const monthMap = {ene: '01', feb: '02', mar: '03', abr: '04', may: '05', jun: '06', jul: '07', ago: '08', sep: '09', oct: '10', nov: '11', dic: '12'};
                        let day = match[1].padStart(2, '0');
                        let month = monthMap[match[2].toLowerCase().substring(0, 3)] || '01';
                        let year = match[3].length === 2 ? '20' + match[3] : match[3];
                        date = `${year}-${month}-${day}`;
                    }
                    console.log('Found date:', match[0], '-> parsed as:', date);
                    break;
                }
            }

            // Extract potential items (lines with numbers that look like prices)
            // Chilean format: CANTIDAD  DESCRIPCION  VALOR (e.g., "1  Cafe 50 gr.  1.500")
            const itemPatterns = [
                /^\d+\s+(.+?)\s+([\d]+[.,][\d]{3})\s*$/,  // 1  Cafe 50 gr.  1.500
                /^\d+\s+(.+?)\s+\$?([\d.,]+)\s*$/,         // 1  Item  $1500
                /^(.+?)\s+\$?([\d]+[.,][\d]{3})\s*$/,      // Item  1.500
                /^(.+?)\s+([\d]{1,3}(?:[.,]\d{3})+)\s*$/   // Item  1.500 or 10.500
            ];

            lines.forEach(line => {
                const lowerLine = line.toLowerCase();
                if (!lowerLine.includes('total') &&
                    !lowerLine.includes('subtotal') &&
                    !lowerLine.includes('iva') &&
                    !lowerLine.includes('rut') &&
                    !lowerLine.includes('boleta') &&
                    !lowerLine.includes('fecha') &&
                    !lowerLine.includes('cantidad')) {

                    for (const pattern of itemPatterns) {
                        const match = line.match(pattern);
                        if (match && match[1].trim().length > 2) {
                            const itemName = match[1].trim().replace(/^\d+\s*/, ''); // Remove leading quantity
                            const itemPrice = match[2];
                            if (itemName.length > 2) {
                                items.push(`${itemName} - $${itemPrice}`);
                            }
                            break;
                        }
                    }
                }
            });

            console.log('Parsed receipt:', { store, total, date, items });
            return { store, total, date, items, description: items.length > 0 ? items.slice(0, 3).join(', ') : '' };
        }

        function saveExpenseFromScan() {
            const store = document.getElementById('expenseStore').value.trim();
            const date = document.getElementById('expenseDate').value;
            const total = document.getElementById('expenseTotal').value;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();

            if (!total || parseFloat(total) <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            const expense = {
                id: Date.now(),
                store: store || 'Sin nombre',
                date: date || getTodayKey(),
                total: parseFloat(total),
                category,
                description,
                hasReceipt: true,
                createdAt: new Date().toISOString()
            };

            const expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);

            closeScanReceiptModal();
            addNotification(`Gasto de $${parseFloat(total).toLocaleString('es-CL')} registrado`, 'üí∞');
            render();
        }

        function saveManualExpense() {
            const store = document.getElementById('manualExpenseStore').value.trim();
            const date = document.getElementById('manualExpenseDate').value;
            const total = document.getElementById('manualExpenseTotal').value;
            const category = document.getElementById('manualExpenseCategory').value;
            const description = document.getElementById('manualExpenseDescription').value.trim();

            if (!total || parseFloat(total) <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            const expense = {
                id: Date.now(),
                store: store || 'Sin nombre',
                date: date || getTodayKey(),
                total: parseFloat(total),
                category,
                description,
                hasReceipt: false,
                createdAt: new Date().toISOString()
            };

            const expenses = getExpenses();
            expenses.push(expense);
            saveExpenses(expenses);

            closeAddExpenseModal();
            addNotification(`Gasto de $${parseFloat(total).toLocaleString('es-CL')} agregado`, 'üí∞');
            render();
        }

        function deleteExpense(index) {
            if (!confirm('¬øEliminar este gasto?')) return;

            const expenses = getExpenses();
            expenses.splice(index, 1);
            saveExpenses(expenses);
            render();
        }

        // ==================== END EXPENSES MODULE ====================

        function renderStats() {
            const weeklyData = getWeeklyProgressData();
            const categoryData = getCategoryDistribution();
            const historicalData = getHistoricalData();
            const stats = getCompletionStats();
            const currentStreak = getStreak();
            const bestStreak = getBestStreak();
            const pomodorosToday = getPomodoroCount();

            const categoryNames = {
                habitos: '‚òÄÔ∏è H√°bitos',
                nutricion: 'ü•ó Nutrici√≥n',
                fisico: 'üí™ F√≠sico',
                personal: 'üìö Personal',
                digital: 'üì± Digital',
                espiritual: 'üßò Espiritual',
                descanso: 'üò¥ Descanso'
            };

            const categoryColorMap = {
                habitos: 'bg-yellow-400',
                nutricion: 'bg-green-400',
                fisico: 'bg-red-400',
                personal: 'bg-blue-400',
                digital: 'bg-purple-400',
                espiritual: 'bg-indigo-400',
                descanso: 'bg-gray-400'
            };

            return `
                <div class="space-y-6">
                    <!-- Resumen General -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìä Resumen General</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gradient-to-br from-rose-50 to-purple-50 rounded-xl">
                                <p class="text-3xl font-bold text-purple-600">${stats.completionRate}%</p>
                                <p class="text-sm text-gray-500">D√≠as perfectos</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-xl">
                                <p class="text-3xl font-bold text-orange-600">${currentStreak}</p>
                                <p class="text-sm text-gray-500">Racha actual</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl">
                                <p class="text-3xl font-bold text-green-600">${stats.taskRate}%</p>
                                <p class="text-sm text-gray-500">Tareas completadas</p>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-red-50 to-pink-50 rounded-xl">
                                <p class="text-3xl font-bold text-red-600">${pomodorosToday}</p>
                                <p class="text-sm text-gray-500">Pomodoros hoy</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fica de Progreso Semanal -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìà Progreso de la Semana</h3>
                        ${weeklyData.length > 0 ? `
                            <div class="flex items-end justify-between gap-2 h-48">
                                ${weeklyData.map(day => `
                                    <div class="flex-1 flex flex-col items-center ${!day.inRange ? 'opacity-40' : ''}">
                                        <div class="w-full bg-gray-100 rounded-t-lg relative" style="height: 160px;">
                                            <div class="absolute bottom-0 w-full rounded-t-lg transition-all ${day.isToday ? 'bg-gradient-to-t from-rose-500 to-purple-500' : 'bg-gradient-to-t from-purple-300 to-purple-400'}" style="height: ${day.progress}%;">
                                            </div>
                                        </div>
                                        <span class="text-xs mt-2 font-medium ${day.isToday ? 'text-purple-600' : 'text-gray-500'}">${day.day}</span>
                                        <span class="text-xs ${day.isToday ? 'text-purple-600 font-bold' : 'text-gray-400'}">${day.inRange ? day.progress + '%' : '-'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<p class="text-center text-gray-400 py-8">No hay datos disponibles</p>`}
                    </div>

                    <!-- Gr√°fica de √öltimos 7 d√≠as -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìÖ √öltimos 7 D√≠as</h3>
                        <div class="space-y-3">
                            ${historicalData.map(day => `
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-gray-500 w-12">${day.label}</span>
                                    <div class="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-rose-500 to-purple-500 rounded-full transition-all" style="width: ${day.progress}%;"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700 w-12 text-right">${day.progress}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Distribuci√≥n por Categor√≠a -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üé® Distribuci√≥n por Categor√≠a</h3>
                        <div class="space-y-3">
                            ${categoryData.map(cat => `
                                <div class="flex items-center gap-3">
                                    <span class="text-sm w-28">${categoryNames[cat.category] || cat.category}</span>
                                    <div class="flex-1 h-4 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full ${categoryColorMap[cat.category] || 'bg-gray-400'} rounded-full" style="width: ${cat.percentage}%;"></div>
                                    </div>
                                    <span class="text-sm text-gray-500 w-16 text-right">${cat.count} (${cat.percentage}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Estad√≠sticas Detalladas -->
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg mb-4">üìã Detalles</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">D√≠as transcurridos</p>
                                <p class="text-xl font-bold text-gray-800">${stats.totalDays}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">D√≠as completados al 100%</p>
                                <p class="text-xl font-bold text-green-600">${stats.completedDays}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Total de tareas</p>
                                <p class="text-xl font-bold text-gray-800">${stats.totalTasks}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Tareas completadas</p>
                                <p class="text-xl font-bold text-purple-600">${stats.completedTasks}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Mejor racha</p>
                                <p class="text-xl font-bold text-orange-600">üî• ${bestStreak} d√≠as</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <p class="text-gray-500">Promedio diario</p>
                                <p class="text-xl font-bold text-blue-600">${stats.totalDays > 0 ? Math.round(stats.completedTasks / stats.totalDays) : 0} tareas</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initial render
        render();
    </script>
</body>
</html>
