<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Plan - Gesti√≥n del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, #ec4899, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.5s ease; }
        .tab-active { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; }
        .checked-item { opacity: 0.6; transform: scale(0.98); }
        .habit-checked { background: linear-gradient(135deg, #fdf2f8, #f3e8ff); border-color: #c084fc; }
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .btn-icon { transition: all 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ec4899, #8b5cf6); border-radius: 10px; }
        .glow { box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
        .photo-glow { box-shadow: 0 0 20px rgba(236, 72, 153, 0.4), 0 0 40px rgba(139, 92, 246, 0.3); }
        @keyframes celebrationFall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-purple-50 to-blue-50">
    <div id="app"></div>

    <!-- Modal para Editar Actividad -->
    <div id="editModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Actividad</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="editTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 08:30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Actividad</label>
                    <input type="text" id="editActivity" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Descripci√≥n de la actividad">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Duraci√≥n</label>
                    <input type="text" id="editDuration" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1 hr">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categor√≠a</label>
                    <select id="editCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                        <option value="habitos">‚òÄÔ∏è H√°bitos</option>
                        <option value="nutricion">ü•ó Nutrici√≥n</option>
                        <option value="fisico">üí™ F√≠sico</option>
                        <option value="personal">üìö Personal</option>
                        <option value="digital">üì± Digital</option>
                        <option value="espiritual">üßò Espiritual</option>
                        <option value="descanso">üò¥ Descanso</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmar Borrado -->
    <div id="deleteModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <div class="text-center">
                <span class="text-5xl">üóëÔ∏è</span>
                <h3 class="text-xl font-bold text-gray-800 mt-3">¬øEliminar elemento?</h3>
                <p class="text-gray-500 mt-2" id="deleteActivityName">Esta acci√≥n no se puede deshacer</p>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition font-medium">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Nueva Actividad -->
    <div id="addModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Actividad</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="addTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 08:30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Actividad</label>
                    <input type="text" id="addActivity" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Descripci√≥n de la actividad">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Duraci√≥n</label>
                    <input type="text" id="addDuration" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1 hr">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categor√≠a</label>
                    <select id="addCategory" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                        <option value="habitos">‚òÄÔ∏è H√°bitos</option>
                        <option value="nutricion">ü•ó Nutrici√≥n</option>
                        <option value="fisico">üí™ F√≠sico</option>
                        <option value="personal">üìö Personal</option>
                        <option value="digital">üì± Digital</option>
                        <option value="espiritual">üßò Espiritual</option>
                        <option value="descanso">üò¥ Descanso</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewActivity()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar H√°bito -->
    <div id="editHabitModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar H√°bito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="editHabitIcon" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: ‚òÄÔ∏è">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del h√°bito</label>
                    <input type="text" id="editHabitName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Despertar 7:00 AM">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditHabitModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveHabitEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar H√°bito -->
    <div id="addHabitModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nuevo H√°bito</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="addHabitIcon" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: ‚òÄÔ∏è">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre del h√°bito</label>
                    <input type="text" id="addHabitName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Despertar 7:00 AM">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddHabitModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewHabit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Ejercicio Gym -->
    <div id="editGymModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Ejercicio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Ejercicio</label>
                    <input type="text" id="editGymExercise" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Hip Thrust con barra 4x12">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditGymModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveGymEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Ejercicio Gym -->
    <div id="addGymModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nuevo Ejercicio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Ejercicio</label>
                    <input type="text" id="addGymExercise" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Hip Thrust con barra 4x12">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddGymModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewGymExercise()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Comida -->
    <div id="editMealModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Comida</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="editMealTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 07:45">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="editMealName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Desayuno">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="editMealEmoji" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: üåÖ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Opciones (una por l√≠nea)</label>
                    <textarea id="editMealOptions" rows="4" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Opci√≥n 1&#10;Opci√≥n 2&#10;Opci√≥n 3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Macros</label>
                    <input type="text" id="editMealMacros" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: P:30g | C:45g | G:15g">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditMealModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveMealEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Comida -->
    <div id="addMealModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Nueva Comida</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Hora</label>
                    <input type="text" id="addMealTime" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 07:45">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nombre</label>
                    <input type="text" id="addMealName" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: Desayuno">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Emoji</label>
                    <input type="text" id="addMealEmoji" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: üåÖ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Opciones (una por l√≠nea)</label>
                    <textarea id="addMealOptions" rows="4" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="Opci√≥n 1&#10;Opci√≥n 2&#10;Opci√≥n 3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Macros</label>
                    <input type="text" id="addMealMacros" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: P:30g | C:45g | G:15g">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddMealModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveNewMeal()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Agregar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Meta Semanal -->
    <div id="editGoalModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Meta Semanal</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Semana</label>
                    <input type="number" id="editGoalWeek" min="1" max="12" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Fechas</label>
                    <input type="text" id="editGoalDates" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none" placeholder="ej: 2-8 Feb">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üí™ Meta F√≠sica</label>
                    <input type="text" id="editGoalFisica" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üìö Meta Personal</label>
                    <input type="text" id="editGoalPersonal" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üì± Meta Digital</label>
                    <input type="text" id="editGoalDigital" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">üßò Meta Espiritual</label>
                    <input type="text" id="editGoalEspiritual" class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditGoalModal()" class="flex-1 px-4 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                <button onclick="saveGoalEdit()" class="flex-1 px-4 py-2 bg-gradient-to-r from-rose-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Reemplazar Todos -->
    <div id="replaceAllModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">üîÑ ¬øAplicar a todos?</h3>
            <p id="replaceAllMessage" class="text-gray-600 text-center mb-6">¬øQuieres aplicar este cambio a todos los d√≠as?</p>

            <div class="space-y-3">
                <button onclick="confirmReplaceAll(true)" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                    ‚úÖ S√≠, aplicar a todos
                </button>
                <button onclick="confirmReplaceAll(false)" class="w-full py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition">
                    üìÖ Solo este d√≠a
                </button>
                <button onclick="closeReplaceAllModal()" class="w-full py-2 text-gray-400 hover:text-gray-600 transition text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Foto de Perfil -->
    <div id="photoModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closePhotoModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üì∏ Foto de Perfil</h3>

            <!-- Vista normal (sin edici√≥n) -->
            <div id="photoNormalView">
                <!-- Preview actual -->
                <div class="flex justify-center mb-6">
                    <div id="photoPreview" class="w-32 h-32 rounded-full bg-gradient-to-r from-pink-500 to-purple-500 flex items-center justify-center text-white text-4xl font-bold border-4 border-purple-200 overflow-hidden">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <!-- Opciones -->
                <div class="space-y-3">
                    <label class="flex items-center justify-center gap-3 w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium cursor-pointer hover:opacity-90 transition">
                        <span>üìÅ Subir foto</span>
                        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    </label>

                    <label class="flex items-center justify-center gap-3 w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-medium cursor-pointer hover:opacity-90 transition">
                        <span>üì∑ Tomar foto</span>
                        <input type="file" id="cameraInput" accept="image/*" capture="user" class="hidden" onchange="handlePhotoUpload(event)">
                    </label>

                    <button onclick="removePhoto()" id="removePhotoBtn" class="w-full py-3 border-2 border-red-200 text-red-500 rounded-xl font-medium hover:bg-red-50 transition hidden">
                        üóëÔ∏è Eliminar foto
                    </button>
                </div>
            </div>

            <!-- Vista de edici√≥n (ajustar posici√≥n) -->
            <div id="photoEditView" class="hidden">
                <p class="text-sm text-gray-500 text-center mb-3">üëÜ Arrastra para ajustar la posici√≥n</p>

                <!-- √Årea de recorte -->
                <div class="flex justify-center mb-4">
                    <div id="cropperContainer" class="w-48 h-48 rounded-full border-4 border-purple-400 overflow-hidden relative cursor-move bg-gray-100"
                        onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                        <img id="cropperImage" class="absolute" style="max-width: none;" draggable="false">
                    </div>
                </div>

                <!-- Zoom slider -->
                <div class="mb-4">
                    <label class="text-sm text-gray-600 flex items-center justify-between mb-1">
                        <span>üîç Zoom</span>
                        <span id="zoomValue">100%</span>
                    </label>
                    <input type="range" id="zoomSlider" min="100" max="300" value="100"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        oninput="updateZoom(this.value)">
                </div>

                <!-- Botones de edici√≥n -->
                <div class="flex gap-3">
                    <button onclick="cancelCrop()" class="flex-1 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button onclick="saveCrop()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                        ‚úì Guardar
                    </button>
                </div>
            </div>

            <button onclick="closePhotoModal()" class="w-full mt-4 py-2 text-gray-500 hover:text-gray-700 transition">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Felicitaciones -->
    <div id="congratsModal" class="fixed inset-0 modal-backdrop z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all text-center">
            <div id="congratsEmoji" class="text-7xl mb-4"></div>
            <h3 id="congratsTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p id="congratsMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closeCongratsModal()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium hover:opacity-90 transition">
                ¬°Gracias! üôå
            </button>
        </div>
    </div>

    <!-- Modal Calendario -->
    <div id="calendarModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4" onclick="closeCalendarModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-4 transform transition-all" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition">‚óÄÔ∏è</button>
                <h3 id="calendarTitle" class="text-lg font-bold text-gray-800"></h3>
                <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition">‚ñ∂Ô∏è</button>
            </div>

            <!-- D√≠as de la semana -->
            <div class="grid grid-cols-7 gap-1 mb-2">
                <div class="text-center text-xs font-medium text-gray-500 py-1">Dom</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Lun</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Mar</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Mi√©</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Jue</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">Vie</div>
                <div class="text-center text-xs font-medium text-gray-500 py-1">S√°b</div>
            </div>

            <!-- D√≠as del mes -->
            <div id="calendarDays" class="grid grid-cols-7 gap-1">
                <!-- Se genera din√°micamente -->
            </div>

            <button onclick="goToToday()" class="w-full mt-4 py-2 text-purple-600 font-medium hover:bg-purple-50 rounded-xl transition">
                üìç Ir a hoy
            </button>
        </div>
    </div>

    <script>
        // Check login
        const currentUser = JSON.parse(localStorage.getItem('gestion-currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // Check if user needs onboarding (and hasn't completed it)
        if (currentUser && currentUser.needsOnboarding && !currentUser.onboardingCompleted) {
            window.location.href = 'onboarding.html';
        }

        // User-specific storage key prefix
        const userKey = currentUser ? currentUser.email.replace(/[^a-z0-9]/gi, '_') : 'guest';

        function getStorage(key) {
            return localStorage.getItem(`${userKey}-${key}`);
        }

        function setStorage(key, value) {
            localStorage.setItem(`${userKey}-${key}`, value);
        }

        function removeStorage(key) {
            localStorage.removeItem(`${userKey}-${key}`);
        }

        function logout() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('gestion-currentUser');
                window.location.href = 'login.html';
            }
        }

        // Profile Photo Functions
        let cropperState = {
            image: null,
            imgWidth: 0,
            imgHeight: 0,
            posX: 0,
            posY: 0,
            zoom: 100,
            isDragging: false,
            startX: 0,
            startY: 0,
            containerSize: 192 // 48 * 4 = w-48
        };

        function openPhotoModal() {
            const modal = document.getElementById('photoModal');
            const preview = document.getElementById('photoPreview');
            const removeBtn = document.getElementById('removePhotoBtn');
            const photo = getStorage('profile-photo');

            // Mostrar vista normal, ocultar editor
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');

            if (photo) {
                preview.innerHTML = `<img src="${photo}" class="w-full h-full object-cover">`;
                removeBtn.classList.remove('hidden');
            } else {
                preview.innerHTML = currentUser.name.charAt(0).toUpperCase();
                removeBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (max 15MB original)
            if (file.size > 15 * 1024 * 1024) {
                alert('La imagen es muy grande. M√°ximo 15MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Guardar imagen original
                    cropperState.image = img;
                    cropperState.imgWidth = img.width;
                    cropperState.imgHeight = img.height;
                    cropperState.zoom = 100;

                    // Mostrar editor
                    showCropperEditor(e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Limpiar input para permitir subir la misma imagen
            event.target.value = '';
        }

        function showCropperEditor(imageSrc) {
            // Ocultar vista normal, mostrar editor
            document.getElementById('photoNormalView').classList.add('hidden');
            document.getElementById('photoEditView').classList.remove('hidden');

            const cropperImg = document.getElementById('cropperImage');
            cropperImg.src = imageSrc;

            // Resetear zoom
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomValue').textContent = '100%';
            cropperState.zoom = 100;

            // Calcular tama√±o inicial para que cubra el contenedor
            setTimeout(() => {
                const container = cropperState.containerSize;
                const imgRatio = cropperState.imgWidth / cropperState.imgHeight;

                let displayWidth, displayHeight;
                if (imgRatio > 1) {
                    // Imagen horizontal
                    displayHeight = container;
                    displayWidth = container * imgRatio;
                } else {
                    // Imagen vertical o cuadrada
                    displayWidth = container;
                    displayHeight = container / imgRatio;
                }

                cropperImg.style.width = displayWidth + 'px';
                cropperImg.style.height = displayHeight + 'px';

                // Centrar imagen
                cropperState.posX = (container - displayWidth) / 2;
                cropperState.posY = (container - displayHeight) / 2;
                updateCropperPosition();
            }, 50);
        }

        function updateCropperPosition() {
            const cropperImg = document.getElementById('cropperImage');
            cropperImg.style.left = cropperState.posX + 'px';
            cropperImg.style.top = cropperState.posY + 'px';
        }

        function updateZoom(value) {
            const zoomFactor = value / cropperState.zoom;
            cropperState.zoom = parseInt(value);
            document.getElementById('zoomValue').textContent = value + '%';

            const cropperImg = document.getElementById('cropperImage');
            const container = cropperState.containerSize;
            const imgRatio = cropperState.imgWidth / cropperState.imgHeight;

            let baseWidth, baseHeight;
            if (imgRatio > 1) {
                baseHeight = container;
                baseWidth = container * imgRatio;
            } else {
                baseWidth = container;
                baseHeight = container / imgRatio;
            }

            const newWidth = baseWidth * (value / 100);
            const newHeight = baseHeight * (value / 100);

            // Ajustar posici√≥n para mantener el centro
            const centerX = cropperState.posX + parseFloat(cropperImg.style.width) / 2;
            const centerY = cropperState.posY + parseFloat(cropperImg.style.height) / 2;

            cropperState.posX = centerX - newWidth / 2;
            cropperState.posY = centerY - newHeight / 2;

            cropperImg.style.width = newWidth + 'px';
            cropperImg.style.height = newHeight + 'px';
            updateCropperPosition();
        }

        function startDrag(e) {
            e.preventDefault();
            cropperState.isDragging = true;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropperState.startX = clientX - cropperState.posX;
            cropperState.startY = clientY - cropperState.posY;

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function doDrag(e) {
            if (!cropperState.isDragging) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropperState.posX = clientX - cropperState.startX;
            cropperState.posY = clientY - cropperState.startY;
            updateCropperPosition();
        }

        function stopDrag() {
            cropperState.isDragging = false;
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', doDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        function cancelCrop() {
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');
        }

        function saveCrop() {
            const container = cropperState.containerSize;
            const cropperImg = document.getElementById('cropperImage');

            // Crear canvas para recortar
            const canvas = document.createElement('canvas');
            const outputSize = 400; // Tama√±o final (mayor = mejor calidad)
            canvas.width = outputSize;
            canvas.height = outputSize;
            const ctx = canvas.getContext('2d');

            // Calcular qu√© parte de la imagen original recortar
            const displayWidth = parseFloat(cropperImg.style.width);
            const displayHeight = parseFloat(cropperImg.style.height);
            const scaleX = cropperState.imgWidth / displayWidth;
            const scaleY = cropperState.imgHeight / displayHeight;

            const srcX = -cropperState.posX * scaleX;
            const srcY = -cropperState.posY * scaleY;
            const srcSize = container * scaleX;

            // Dibujar la porci√≥n recortada
            ctx.drawImage(
                cropperState.image,
                srcX, srcY, srcSize, srcSize,
                0, 0, outputSize, outputSize
            );

            // Comprimir con alta calidad
            let photoData = canvas.toDataURL('image/jpeg', 0.92);
            let sizeKB = (photoData.length * 3/4) / 1024;

            // Reducir calidad solo si excede 150KB
            let quality = 0.92;
            while (sizeKB > 150 && quality > 0.5) {
                quality -= 0.05;
                photoData = canvas.toDataURL('image/jpeg', quality);
                sizeKB = (photoData.length * 3/4) / 1024;
            }

            console.log(`Foto guardada: ${Math.round(sizeKB)}KB (calidad: ${Math.round(quality*100)}%)`);

            // Guardar
            setStorage('profile-photo', photoData);

            // Actualizar preview y cerrar editor
            document.getElementById('photoPreview').innerHTML = `<img src="${photoData}" class="w-full h-full object-cover">`;
            document.getElementById('removePhotoBtn').classList.remove('hidden');
            document.getElementById('photoNormalView').classList.remove('hidden');
            document.getElementById('photoEditView').classList.add('hidden');

            render();
        }

        function removePhoto() {
            if (confirm('¬øEliminar foto de perfil?')) {
                removeStorage('profile-photo');
                document.getElementById('photoPreview').innerHTML = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('removePhotoBtn').classList.add('hidden');
                render();
            }
        }

        function getUserPhoto() {
            return getStorage('profile-photo');
        }

        // Replace All Modal Functions
        let pendingReplaceAll = null; // { type, oldValue, newValue, callback }

        function showReplaceAllModal(type, message, callback) {
            pendingReplaceAll = { type, callback };
            document.getElementById('replaceAllMessage').textContent = message;
            document.getElementById('replaceAllModal').classList.remove('hidden');
        }

        function closeReplaceAllModal() {
            document.getElementById('replaceAllModal').classList.add('hidden');
            pendingReplaceAll = null;
        }

        function confirmReplaceAll(replaceAll) {
            if (pendingReplaceAll && pendingReplaceAll.callback) {
                pendingReplaceAll.callback(replaceAll);
            }
            closeReplaceAllModal();
            render();
        }

        // Goal text mapping
        function getGoalText(goal) {
            const goals = {
                fitness: 'üí™ Mejorando mi f√≠sico',
                productivity: 'üìà Siendo m√°s productivo',
                learning: 'üìö Aprendiendo algo nuevo',
                health: 'ü•ó Mejorando mi salud',
                business: 'üíº Haciendo crecer mi negocio',
                competition: 'üëë Prepar√°ndome para competir',
                personal: '‚ú® Desarrollo personal',
                other: 'üéØ Alcanzando mis metas'
            };
            return goals[goal] || goals.other;
        }

        // Data - User specific dates based on their plan
        const userStartDate = currentUser ? new Date(currentUser.startDate) : new Date();
        const userDuration = currentUser ? currentUser.duration : 60;
        const totalWeeks = Math.ceil(userDuration / 7);
        const startDate = new Date(userStartDate);
        const endDate = new Date(userStartDate);
        endDate.setDate(endDate.getDate() + userDuration - 1);

        let currentDate = new Date();
        // Clamp current date to plan range
        if (currentDate < startDate) currentDate = new Date(startDate);
        if (currentDate > endDate) currentDate = new Date(endDate);

        let activeTab = 'agenda';
        let checkedHabits = JSON.parse(getStorage('habits') || '{}');
        let completedActivities = JSON.parse(getStorage('activities') || '{}');
        let customSchedules = JSON.parse(getStorage('custom-schedules') || '{}');
        let customHabits = JSON.parse(getStorage('custom-habits') || 'null');
        let customGym = JSON.parse(getStorage('custom-gym') || '{}');
        let customMeals = JSON.parse(getStorage('custom-meals') || 'null');
        let customGoals = JSON.parse(getStorage('custom-goals') || 'null');

        let editingIndex = null;
        let deletingIndex = null;
        let deleteType = 'activity';

        const daysSpanish = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const monthsSpanish = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        const defaultGymFocus = {
            0: { name: "Descanso Activo", icon: "üßò", exercises: ["Yoga suave 30-45min", "Estiramientos profundos 20min", "Caminata ligera opcional", "Meditaci√≥n con movimiento 15min"] },
            1: { name: "Gl√∫teos + Cu√°driceps", icon: "üçë", exercises: ["Hip Thrust con barra 4x12", "Sentadilla profunda 4x10", "Prensa inclinada 4x12", "Zancadas caminando 3x12", "Extensi√≥n cu√°driceps 3x15", "Abductores m√°quina 3x20"] },
            2: { name: "Isquios + Gl√∫teos", icon: "ü¶µ", exercises: ["Peso muerto rumano 4x10", "Curl femoral acostada 4x12", "Patada gl√∫teo polea 3x15", "Puente gl√∫teos elevado 4x15", "Good mornings 3x12", "Hip abduction 3x20"] },
            3: { name: "Tren Superior + Core", icon: "üí™", exercises: ["Press pecho mancuernas 3x12", "Remo mancuerna 3x12", "Press hombro 3x12", "Curl b√≠ceps 3x15", "Tr√≠ceps polea 3x15", "Plancha 3x30seg + Crunches 3x20"] },
            4: { name: "Piernas + HIIT", icon: "üî•", exercises: ["Sentadilla b√∫lgara 4x10", "Leg press pies juntos 4x12", "Step ups con peso 3x12", "Curl femoral sentada 3x15", "HIIT: Burpees, Jumping jacks 4 rondas"] },
            5: { name: "Gl√∫teos (√©nfasis) + Brazos", icon: "‚ú®", exercises: ["Hip thrust unilateral 4x12", "Sumo squat mancuerna 4x15", "Kickbacks polea 3x15", "Frog pumps 3x25", "Curl martillo 3x12", "Fondos tr√≠ceps 3x12"] },
            6: { name: "Baile + Stretching", icon: "üíÉ", exercises: ["Clase baile/gimnasia 60-90min", "Estiramiento din√°mico 15min", "Foam roller piernas 15min", "Yoga flow 20min"] }
        };

        function getGymFocus(dayIndex) {
            if (customGym[dayIndex]) {
                return customGym[dayIndex];
            }
            return defaultGymFocus[dayIndex];
        }

        const defaultHabits = [
            { id: 1, name: "Despertar 7:00 AM", icon: "‚òÄÔ∏è" },
            { id: 2, name: "Agua al despertar (500ml)", icon: "üíß" },
            { id: 3, name: "Suplementos tomados", icon: "üíä" },
            { id: 4, name: "Meditaci√≥n 30 min", icon: "üßò" },
            { id: 5, name: "Afirmaciones positivas", icon: "‚ú®" },
            { id: 6, name: "Desayuno proteico", icon: "ü•ó" },
            { id: 7, name: "Clase de ingl√©s", icon: "üá¨üáß" },
            { id: 8, name: "Skincare AM", icon: "üß¥" },
            { id: 9, name: "Entrenamiento completado", icon: "üí™" },
            { id: 10, name: "Post-entreno proteico", icon: "ü•§" },
            { id: 11, name: "Contenido RRSS creado", icon: "üì∏" },
            { id: 12, name: "Publicado en RRSS", icon: "üì±" },
            { id: 13, name: "Interacci√≥n audiencia", icon: "üí¨" },
            { id: 14, name: "Cena sin az√∫car", icon: "ü•¶" },
            { id: 15, name: "Skincare PM + celulitis", icon: "üåô" },
            { id: 16, name: "Gratitud (3 cosas)", icon: "üôè" },
            { id: 17, name: "En cama 22:00", icon: "üò¥" },
            { id: 18, name: "3L agua bebidos", icon: "üí¶" }
        ];

        function getHabits() {
            return customHabits || defaultHabits;
        }

        const defaultMeals = [
            { time: "07:45", name: "Desayuno", emoji: "üåÖ", options: ["Avena + prote√≠na + frutos rojos", "Huevos revueltos + verduras + tostada integral", "Smoothie bowl proteico con semillas"], macros: "P:30g | C:45g | G:15g" },
            { time: "10:30", name: "Snack AM", emoji: "üçé", options: ["Yogurt griego + nueces", "Fruta + almendras", "Batido verde proteico"], macros: "P:15g | C:20g | G:10g" },
            { time: "12:00", name: "Almuerzo", emoji: "ü•ó", options: ["Prote√≠na 150g (pollo/pescado/pavo)", "Carbohidrato complejo 1 taza", "Vegetales variados ilimitados", "Grasa saludable (aguacate)"], macros: "P:40g | C:50g | G:15g" },
            { time: "16:00", name: "Post-Entreno", emoji: "üí™", options: ["Prote√≠na whey + banana + leche vegetal", "Yogurt griego + granola sin az√∫car"], macros: "P:30g | C:30g | G:5g" },
            { time: "20:00", name: "Cena", emoji: "üåô", options: ["Prote√≠na magra 120g", "Vegetales al vapor o ensalada grande", "Sin carbohidratos pesados"], macros: "P:35g | C:20g | G:12g" }
        ];

        function getMeals() {
            return customMeals || defaultMeals;
        }

        const defaultWeeklyGoals = [
            { week: 1, dates: "2-8 Feb", fisica: "Establecer rutina gym. Medir peso inicial", personal: "Inicio ingl√©s intensivo + pasarela", digital: "Crear web b√°sica", espiritual: "Establecer meditaci√≥n diaria" },
            { week: 2, dates: "9-15 Feb", fisica: "Ajustar plan nutricional. -0.5kg grasa", personal: "Mejorar pronunciaci√≥n ingl√©s", digital: "5 posts. Contactar marcas", espiritual: "Journaling diario" },
            { week: 3, dates: "16-22 Feb", fisica: "Incrementar peso en gl√∫teos", personal: "Conversaciones b√°sicas ingl√©s", digital: "12K seguidores. Portafolio", espiritual: "Bajar autoexigencia" },
            { week: 4, dates: "23 Feb-1 Mar", fisica: "Definici√≥n visible piernas", personal: "Presentaci√≥n en ingl√©s", digital: "15K. Primera colaboraci√≥n", espiritual: "Sin episodios nerviosismo" },
            { week: 5, dates: "2-8 Mar", fisica: "Abdominales marcados", personal: "Fluidez conversacional", digital: "Blog semanal. 5%+ engagement", espiritual: "Manejo emocional estable" },
            { week: 6, dates: "9-15 Mar", fisica: "Gl√∫teos definidos. Verificar 58kg", personal: "Speech en ingl√©s listo", digital: "17K. Contenido viral", espiritual: "Autoconfianza alta" },
            { week: 7, dates: "16-22 Mar", fisica: "Cuerpo √≥ptimo. Piel radiante", personal: "Ingl√©s intermedio-alto", digital: "19K. Portafolio completo", espiritual: "Nervios controlados" },
            { week: 8, dates: "23-30 Mar", fisica: "üéØ 58kg, definici√≥n total", personal: "üéØ Ingl√©s fluido, pasarela 100%", digital: "üéØ 20K+, marca s√≥lida", espiritual: "üéØ Confianza total" }
        ];

        function getWeeklyGoals() {
            return customGoals || defaultWeeklyGoals;
        }

        const categoryColors = {
            habitos: { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-700", badge: "bg-amber-100" },
            nutricion: { bg: "bg-green-50", border: "border-green-200", text: "text-green-700", badge: "bg-green-100" },
            fisico: { bg: "bg-rose-50", border: "border-rose-200", text: "text-rose-700", badge: "bg-rose-100" },
            personal: { bg: "bg-blue-50", border: "border-blue-200", text: "text-blue-700", badge: "bg-blue-100" },
            digital: { bg: "bg-purple-50", border: "border-purple-200", text: "text-purple-700", badge: "bg-purple-100" },
            espiritual: { bg: "bg-indigo-50", border: "border-indigo-200", text: "text-indigo-700", badge: "bg-indigo-100" },
            descanso: { bg: "bg-slate-50", border: "border-slate-200", text: "text-slate-700", badge: "bg-slate-100" }
        };

        function getDefaultSchedule(dayIndex) {
            if (dayIndex === 0) return getSundaySchedule();
            if (dayIndex === 6) return getSaturdaySchedule();
            return getWeekdaySchedule(dayIndex);
        }

        function getSchedule(dayIndex, dateKey) {
            if (customSchedules[dateKey]) {
                return customSchedules[dateKey];
            }
            return getDefaultSchedule(dayIndex);
        }

        function saveCustomSchedule(dateKey, schedule) {
            customSchedules[dateKey] = schedule;
            setStorage('custom-schedules', JSON.stringify(customSchedules));
        }

        function getWeekdaySchedule(dayIndex) {
            const gym = getGymFocus(dayIndex);
            const schedule = [
                { time: "06:45", activity: "Despertar + Agua tibia con lim√≥n üçã", duration: "15 min", category: "habitos" },
                { time: "07:00", activity: "Suplementos: Creatina + Omega 3 + Vitamina C", duration: "15 min", category: "nutricion" },
                { time: "07:15", activity: "Meditaci√≥n guiada + Afirmaciones ‚ú®", duration: "30 min", category: "espiritual" },
                { time: "07:45", activity: "Desayuno proteico", duration: "45 min", category: "nutricion" },
                { time: "08:30", activity: "Clase de Ingl√©s Intensivo üá¨üáß", duration: "2 hrs", category: "personal" },
                { time: "10:30", activity: "Snack saludable + Hidrataci√≥n", duration: "30 min", category: "nutricion" },
                { time: "11:00", activity: "Skincare facial + Cuidado capilar üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "fisico" },
                { time: "12:00", activity: "Almuerzo balanceado", duration: "1 hr", category: "nutricion" },
                { time: "13:00", activity: "Descanso / Lectura / Journaling üìñ", duration: "1 hr", category: "espiritual" },
                { time: "14:00", activity: `Gimnasio: ${gym.name} ${gym.icon}`, duration: "2 hrs", category: "fisico" },
                { time: "16:00", activity: "Batido proteico post-entreno ü•§", duration: "30 min", category: "nutricion" }
            ];

            if ([1, 3, 5].includes(dayIndex)) {
                schedule.push({ time: "16:30", activity: "Clase de Pasarela (estilo Sheynnis Palacios) üë†", duration: "1.5 hrs", category: "personal" });
            } else {
                schedule.push({ time: "16:30", activity: "Coaching Oratoria con Coni üé§", duration: "1.5 hrs", category: "personal" });
            }

            schedule.push(
                { time: "18:00", activity: "Creaci√≥n contenido RRSS üì∏", duration: "1 hr", category: "digital" },
                { time: "19:00", activity: "Publicar + Interactuar audiencia üì±", duration: "30 min", category: "digital" },
                { time: "19:30", activity: "Revisar m√©tricas + Planificar üìä", duration: "30 min", category: "digital" },
                { time: "20:00", activity: "Cena saludable", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Skincare nocturno + Tratamiento celulitis üåô", duration: "30 min", category: "fisico" },
                { time: "21:30", activity: "Gratitud + Preparar ma√±ana üôè", duration: "30 min", category: "espiritual" },
                { time: "22:00", activity: "DORMIR üò¥ (9 horas)", duration: "9 hrs", category: "descanso" }
            );

            return schedule;
        }

        function getSaturdaySchedule() {
            return [
                { time: "07:00", activity: "Despertar + Hidrataci√≥n üíß", duration: "15 min", category: "habitos" },
                { time: "07:15", activity: "Suplementos matutinos", duration: "15 min", category: "nutricion" },
                { time: "07:30", activity: "Meditaci√≥n + Afirmaciones ‚ú®", duration: "30 min", category: "espiritual" },
                { time: "08:00", activity: "Desayuno proteico", duration: "1 hr", category: "nutricion" },
                { time: "09:00", activity: "Clase de Baile / Gimnasia üíÉ", duration: "1.5 hrs", category: "personal" },
                { time: "10:30", activity: "Snack + Hidrataci√≥n", duration: "30 min", category: "nutricion" },
                { time: "11:00", activity: "Sesi√≥n fotos / Contenido semanal üì∏", duration: "2 hrs", category: "digital" },
                { time: "13:00", activity: "Almuerzo", duration: "1 hr", category: "nutricion" },
                { time: "14:00", activity: "Descanso / Autocuidado üíÜ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "espiritual" },
                { time: "15:00", activity: "Trabajo en P√°gina Web / Portafolio üíª", duration: "2 hrs", category: "digital" },
                { time: "17:00", activity: "Cardio suave + Stretching üßò", duration: "1 hr", category: "fisico" },
                { time: "18:00", activity: "Programar contenido semanal", duration: "1 hr", category: "digital" },
                { time: "19:00", activity: "Tiempo libre / Social üëØ‚Äç‚ôÄÔ∏è", duration: "1 hr", category: "personal" },
                { time: "20:00", activity: "Cena", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Rutina nocturna + Planificaci√≥n üåô", duration: "1 hr", category: "espiritual" },
                { time: "22:00", activity: "DORMIR üò¥", duration: "9 hrs", category: "descanso" }
            ];
        }

        function getSundaySchedule() {
            return [
                { time: "08:00", activity: "Despertar natural + Hidrataci√≥n ‚òÄÔ∏è", duration: "15 min", category: "habitos" },
                { time: "08:15", activity: "Omega 3 + Vitamina C (descanso creatina)", duration: "15 min", category: "nutricion" },
                { time: "08:30", activity: "Meditaci√≥n extendida + Visualizaci√≥n üßò", duration: "1 hr", category: "espiritual" },
                { time: "09:30", activity: "Brunch saludable ü•ë", duration: "1 hr", category: "nutricion" },
                { time: "10:30", activity: "Spa personal: mascarillas, tratamientos ‚ú®", duration: "1.5 hrs", category: "fisico" },
                { time: "12:00", activity: "Revisar metas + Ajustar plan üéØ", duration: "1 hr", category: "personal" },
                { time: "13:00", activity: "Almuerzo liviano", duration: "1 hr", category: "nutricion" },
                { time: "14:00", activity: "Siesta / Descanso profundo üò¥", duration: "1 hr", category: "descanso" },
                { time: "15:00", activity: "Yoga + Stretching profundo üßò", duration: "1 hr", category: "fisico" },
                { time: "16:00", activity: "Ingl√©s: pel√≠culas/series üé¨", duration: "1 hr", category: "personal" },
                { time: "17:00", activity: "Preparar outfits de la semana üëó", duration: "1 hr", category: "personal" },
                { time: "18:00", activity: "RRSS: Responder mensajes + Stories üì±", duration: "1 hr", category: "digital" },
                { time: "19:00", activity: "Tiempo familiar / Social üíï", duration: "1 hr", category: "personal" },
                { time: "20:00", activity: "Cena liviana", duration: "1 hr", category: "nutricion" },
                { time: "21:00", activity: "Rutina nocturna üåô", duration: "30 min", category: "fisico" },
                { time: "21:30", activity: "Lectura + Gratitud + Intenciones ‚ú®", duration: "30 min", category: "espiritual" },
                { time: "22:00", activity: "DORMIR üò¥", duration: "9 hrs", category: "descanso" }
            ];
        }

        function getDateKey(date = currentDate) {
            return date.toISOString().split('T')[0];
        }

        function getWeekNumber(date = currentDate) {
            return Math.min(totalWeeks, Math.max(1, Math.floor((date - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1));
        }

        function getDayNumber(date = currentDate) {
            return Math.floor((date - startDate) / (24 * 60 * 60 * 1000)) + 1;
        }

        function getDailyProgress(date = currentDate) {
            const dateKey = getDateKey(date);
            const schedule = getSchedule(date.getDay(), dateKey);
            const totalActivities = schedule.length;
            if (totalActivities === 0) return 0;
            let completed = 0;

            for (let i = 0; i < totalActivities; i++) {
                if (completedActivities[`${dateKey}-${i}`]) {
                    completed++;
                }
            }

            return Math.round((completed / totalActivities) * 100);
        }

        function getWeeklyProgress() {
            const weekNum = getWeekNumber();
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() + (weekNum - 1) * 7);

            let totalActivities = 0;
            let completedCount = 0;

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + i);

                if (dayDate > endDate) break;

                const dateKey = getDateKey(dayDate);
                const schedule = getSchedule(dayDate.getDay(), dateKey);
                totalActivities += schedule.length;

                for (let j = 0; j < schedule.length; j++) {
                    if (completedActivities[`${dateKey}-${j}`]) {
                        completedCount++;
                    }
                }
            }

            return totalActivities > 0 ? Math.round((completedCount / totalActivities) * 100) : 0;
        }

        function getTotalProgress() {
            let totalActivities = 0;
            let completedCount = 0;

            const tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                const dateKey = getDateKey(tempDate);
                const schedule = getSchedule(tempDate.getDay(), dateKey);
                totalActivities += schedule.length;

                for (let j = 0; j < schedule.length; j++) {
                    if (completedActivities[`${dateKey}-${j}`]) {
                        completedCount++;
                    }
                }

                tempDate.setDate(tempDate.getDate() + 1);
            }

            return totalActivities > 0 ? Math.round((completedCount / totalActivities) * 100) : 0;
        }

        function navigateDay(direction) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + direction);
            if (newDate >= startDate && newDate <= endDate) {
                currentDate = newDate;
                render();
            }
        }

        // Calendar Modal Functions
        let calendarMonth = new Date();

        function openCalendarModal() {
            calendarMonth = new Date(currentDate);
            renderCalendar();
            document.getElementById('calendarModal').classList.remove('hidden');
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.add('hidden');
        }

        function changeCalendarMonth(direction) {
            calendarMonth.setMonth(calendarMonth.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            document.getElementById('calendarTitle').textContent =
                `${monthNames[calendarMonth.getMonth()]} ${calendarMonth.getFullYear()}`;

            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            // Primer d√≠a del mes
            const firstDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), 1);
            const lastDay = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 0);

            // D√≠as vac√≠os al inicio
            for (let i = 0; i < firstDay.getDay(); i++) {
                container.innerHTML += '<div></div>';
            }

            // D√≠as del mes
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth(), day);
                const isInRange = date >= startDate && date <= endDate;
                const isSelected = date.toDateString() === currentDate.toDateString();
                const isToday = date.toDateString() === new Date().toDateString();

                let classes = 'w-10 h-10 flex items-center justify-center rounded-full text-sm transition ';

                if (!isInRange) {
                    classes += 'text-gray-300 cursor-not-allowed';
                } else if (isSelected) {
                    classes += 'bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold cursor-pointer';
                } else if (isToday) {
                    classes += 'border-2 border-purple-400 text-purple-600 font-medium cursor-pointer hover:bg-purple-50';
                } else {
                    classes += 'text-gray-700 cursor-pointer hover:bg-gray-100';
                }

                container.innerHTML += `
                    <button class="${classes}"
                            ${isInRange ? `onclick="selectDate(${date.getFullYear()}, ${date.getMonth()}, ${day})"` : 'disabled'}>
                        ${day}
                    </button>
                `;
            }
        }

        function selectDate(year, month, day) {
            currentDate = new Date(year, month, day);
            closeCalendarModal();
            render();
        }

        function goToToday() {
            const today = new Date();
            if (today >= startDate && today <= endDate) {
                currentDate = today;
                closeCalendarModal();
                render();
            } else {
                alert('Hoy est√° fuera del rango de tu plan');
            }
        }

        // Congratulations Modal Functions
        const congratsShown = JSON.parse(getStorage('congrats-shown') || '{}');

        function closeCongratsModal() {
            document.getElementById('congratsModal').classList.add('hidden');
        }

        function showCongrats(type, emoji, title, message) {
            document.getElementById('congratsEmoji').textContent = emoji;
            document.getElementById('congratsTitle').textContent = title;
            document.getElementById('congratsMessage').textContent = message;
            document.getElementById('congratsModal').classList.remove('hidden');

            // Mostrar celebraci√≥n extra grande
            showBigCelebration();
        }

        function showBigCelebration() {
            const emojis = ['üéâ', 'üéä', 'ü•≥', '‚≠ê', '‚ú®', 'üåü', 'üèÜ', 'üëë', 'üí™', 'üî•', 'üíñ', 'üéÜ', 'üéá'];
            const container = document.createElement('div');
            container.className = 'fixed inset-0 pointer-events-none z-[150]';
            document.body.appendChild(container);

            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.cssText = `
                        position: absolute;
                        font-size: ${30 + Math.random() * 40}px;
                        left: ${Math.random() * 100}%;
                        top: -60px;
                        animation: celebrationFall 2s ease-out forwards;
                    `;
                    container.appendChild(emoji);
                }, i * 80);
            }

            setTimeout(() => container.remove(), 3500);
        }

        function checkAndShowCongrats(dailyProgress, weeklyProgress, totalProgress) {
            const dateKey = getDateKey();
            const weekKey = `week-${getWeekNumber()}`;

            // D√≠a completo (100%)
            if (dailyProgress === 100 && !congratsShown[dateKey]) {
                congratsShown[dateKey] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('day', 'üåü', '¬°D√≠a completado!',
                        '¬°Incre√≠ble! Completaste todas las tareas del d√≠a. ¬°Sigue as√≠!');
                }, 500);
                return;
            }

            // Semana completa (100%)
            if (weeklyProgress === 100 && !congratsShown[weekKey]) {
                congratsShown[weekKey] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('week', 'üèÜ', '¬°Semana perfecta!',
                        '¬°WOW! Completaste toda la semana. ¬°Eres imparable!');
                }, 500);
                return;
            }

            // Plan completo (100%)
            if (totalProgress === 100 && !congratsShown['plan-complete']) {
                congratsShown['plan-complete'] = true;
                setStorage('congrats-shown', JSON.stringify(congratsShown));
                setTimeout(() => {
                    showCongrats('plan', 'üëë', '¬°¬°PLAN COMPLETADO!!',
                        '¬°LO LOGRASTE! Completaste todo tu plan. ¬°Eres una leyenda! üéâüéäü•≥');
                }, 500);
                return;
            }
        }

        function setTab(tab) {
            activeTab = tab;
            render();
        }

        function toggleHabit(habitId) {
            const key = `${getDateKey()}-${habitId}`;
            const wasCompleted = checkedHabits[key];
            checkedHabits[key] = !checkedHabits[key];
            setStorage('habits', JSON.stringify(checkedHabits));

            // Mostrar celebraci√≥n si se complet√≥
            if (!wasCompleted && checkedHabits[key]) {
                showCelebration();
                // Verificar si se complet√≥ d√≠a/semana/plan
                setTimeout(() => {
                    checkAndShowCongrats(getDailyProgress(), getWeeklyProgress(), getTotalProgress());
                }, 1000);
            }
            render();
        }

        function toggleActivity(index) {
            const key = `${getDateKey()}-${index}`;
            const wasCompleted = completedActivities[key];
            completedActivities[key] = !completedActivities[key];
            setStorage('activities', JSON.stringify(completedActivities));

            // Mostrar celebraci√≥n si se complet√≥
            if (!wasCompleted && completedActivities[key]) {
                showCelebration();
                // Verificar si se complet√≥ d√≠a/semana/plan
                setTimeout(() => {
                    checkAndShowCongrats(getDailyProgress(), getWeeklyProgress(), getTotalProgress());
                }, 1000);
            }
            render();
        }

        // Animaci√≥n de celebraci√≥n con emojis (3 opciones aleatorias)
        function showCelebration() {
            const emojiSets = [
                ['üéâ', 'üéä', 'ü•≥', 'üéà', 'üéÅ', 'ü™Ö', 'üéÄ', 'üçæ', 'ü•Ç', 'üéÜ'],  // Fiesta
                ['‚≠ê', '‚ú®', 'üåü', 'üí´', 'üåà', 'ü¶ã', 'üíñ', 'üíù', 'üå∏', 'üå∫'],  // M√°gico
                ['üèÜ', 'ü•á', 'üí™', 'üî•', 'üëë', 'üöÄ', 'üíØ', '‚ö°', 'üéØ', 'üëè']   // Campe√≥n
            ];
            const emojis = emojiSets[Math.floor(Math.random() * emojiSets.length)];
            const container = document.createElement('div');
            container.className = 'fixed inset-0 pointer-events-none z-[100]';
            document.body.appendChild(container);

            // Crear 15 emojis que caen
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.cssText = `
                        position: absolute;
                        font-size: ${20 + Math.random() * 25}px;
                        left: ${Math.random() * 100}%;
                        top: -50px;
                        animation: celebrationFall 1.5s ease-out forwards;
                        opacity: 1;
                    `;
                    container.appendChild(emoji);
                }, i * 50);
            }

            // Eliminar despu√©s de la animaci√≥n
            setTimeout(() => container.remove(), 2000);
        }

        // ========== ACTIVITY MODALS ==========
        function openEditModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const dateKey = getDateKey();
            const schedule = getSchedule(currentDate.getDay(), dateKey);
            const item = schedule[index];

            document.getElementById('editTime').value = item.time;
            document.getElementById('editActivity').value = item.activity;
            document.getElementById('editDuration').value = item.duration;
            document.getElementById('editCategory').value = item.category;

            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveEdit() {
            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);
            const originalActivity = schedule[editingIndex].activity;

            const newItem = {
                time: document.getElementById('editTime').value,
                activity: document.getElementById('editActivity').value,
                duration: document.getElementById('editDuration').value,
                category: document.getElementById('editCategory').value
            };

            // Guardar este d√≠a primero
            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }
            schedule[editingIndex] = newItem;
            schedule.sort((a, b) => a.time.localeCompare(b.time));
            saveCustomSchedule(dateKey, schedule);

            closeEditModal();

            // Preguntar si reemplazar en todos los d√≠as
            showReplaceAllModal('schedule',
                `¬øAplicar este cambio a "${originalActivity}" en todos los d√≠as?`,
                (replaceAll) => {
                    if (replaceAll) {
                        replaceActivityInAllDays(originalActivity, newItem);
                    }
                }
            );
        }

        function replaceActivityInAllDays(originalName, newItem) {
            // Reemplazar en horarios por defecto customizados
            Object.keys(customSchedules).forEach(key => {
                const schedule = customSchedules[key];
                schedule.forEach((item, idx) => {
                    if (item.activity === originalName) {
                        schedule[idx] = { ...newItem };
                    }
                });
                setStorage(`schedule-${key}`, JSON.stringify(schedule));
            });
            render();
        }

        function openDeleteModal(index, type = 'activity') {
            event.stopPropagation();
            deletingIndex = index;
            deleteType = type;

            let itemName = '';
            if (type === 'activity') {
                const dateKey = getDateKey();
                const schedule = getSchedule(currentDate.getDay(), dateKey);
                itemName = schedule[index].activity;
            } else if (type === 'habit') {
                itemName = getHabits()[index].name;
            } else if (type === 'gym') {
                const dayIndex = currentDate.getDay();
                itemName = getGymFocus(dayIndex).exercises[index];
            } else if (type === 'meal') {
                itemName = getMeals()[index].name;
            } else if (type === 'goal') {
                itemName = `Semana ${getWeeklyGoals()[index].week}`;
            }

            document.getElementById('deleteActivityName').textContent = `"${itemName}"`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deletingIndex = null;
        }

        function confirmDelete() {
            if (deleteType === 'activity') {
                deleteActivity();
            } else if (deleteType === 'habit') {
                deleteHabit();
            } else if (deleteType === 'gym') {
                deleteGymExercise();
            } else if (deleteType === 'meal') {
                deleteMeal();
            } else if (deleteType === 'goal') {
                deleteGoal();
            }
            closeDeleteModal();
            render();
        }

        function deleteActivity() {
            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);

            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }

            schedule.splice(deletingIndex, 1);

            const newCompleted = {};
            Object.keys(completedActivities).forEach(key => {
                if (key.startsWith(dateKey)) {
                    const idx = parseInt(key.split('-').pop());
                    if (idx < deletingIndex) {
                        newCompleted[key] = completedActivities[key];
                    } else if (idx > deletingIndex) {
                        newCompleted[`${dateKey}-${idx - 1}`] = completedActivities[key];
                    }
                } else {
                    newCompleted[key] = completedActivities[key];
                }
            });
            completedActivities = newCompleted;
            setStorage('activities', JSON.stringify(completedActivities));

            saveCustomSchedule(dateKey, schedule);
        }

        function openAddModal() {
            document.getElementById('addTime').value = '';
            document.getElementById('addActivity').value = '';
            document.getElementById('addDuration').value = '';
            document.getElementById('addCategory').value = 'personal';
            document.getElementById('addModal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        function saveNewActivity() {
            const time = document.getElementById('addTime').value;
            const activity = document.getElementById('addActivity').value;
            const duration = document.getElementById('addDuration').value;
            const category = document.getElementById('addCategory').value;

            if (!time || !activity) {
                alert('Por favor completa la hora y la actividad');
                return;
            }

            const dateKey = getDateKey();
            let schedule = getSchedule(currentDate.getDay(), dateKey);

            if (!customSchedules[dateKey]) {
                schedule = JSON.parse(JSON.stringify(schedule));
            }

            schedule.push({ time, activity, duration, category });
            schedule.sort((a, b) => a.time.localeCompare(b.time));

            saveCustomSchedule(dateKey, schedule);
            closeAddModal();
            render();
        }

        function resetDay() {
            if (confirm('¬øRestaurar el plan original de este d√≠a? Se perder√°n los cambios.')) {
                const dateKey = getDateKey();
                delete customSchedules[dateKey];
                setStorage('custom-schedules', JSON.stringify(customSchedules));

                Object.keys(completedActivities).forEach(key => {
                    if (key.startsWith(dateKey)) {
                        delete completedActivities[key];
                    }
                });
                setStorage('activities', JSON.stringify(completedActivities));

                render();
            }
        }

        // ========== HABIT MODALS ==========
        function openEditHabitModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const habit = getHabits()[index];

            document.getElementById('editHabitIcon').value = habit.icon;
            document.getElementById('editHabitName').value = habit.name;

            document.getElementById('editHabitModal').classList.remove('hidden');
        }

        function closeEditHabitModal() {
            document.getElementById('editHabitModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveHabitEdit() {
            const newIcon = document.getElementById('editHabitIcon').value;
            const newName = document.getElementById('editHabitName').value;
            const indexToEdit = editingIndex; // Guardar antes de cerrar modal

            closeEditHabitModal();

            showReplaceAllModal('habit',
                `Este cambio aplicar√° a "${newName}" en todos los d√≠as. ¬øContinuar?`,
                (confirmed) => {
                    if (confirmed) {
                        let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
                        habits[indexToEdit] = {
                            id: habits[indexToEdit].id,
                            icon: newIcon,
                            name: newName
                        };
                        customHabits = habits;
                        setStorage('custom-habits', JSON.stringify(customHabits));
                    }
                }
            );
        }

        function deleteHabit() {
            let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
            habits.splice(deletingIndex, 1);
            customHabits = habits;
            setStorage('custom-habits', JSON.stringify(customHabits));
        }

        function openAddHabitModal() {
            document.getElementById('addHabitIcon').value = '‚≠ê';
            document.getElementById('addHabitName').value = '';
            document.getElementById('addHabitModal').classList.remove('hidden');
        }

        function closeAddHabitModal() {
            document.getElementById('addHabitModal').classList.add('hidden');
        }

        function saveNewHabit() {
            const icon = document.getElementById('addHabitIcon').value;
            const name = document.getElementById('addHabitName').value;

            if (!name) {
                alert('Por favor ingresa el nombre del h√°bito');
                return;
            }

            let habits = customHabits || JSON.parse(JSON.stringify(defaultHabits));
            const newId = Math.max(...habits.map(h => h.id)) + 1;
            habits.push({ id: newId, icon, name });

            customHabits = habits;
            setStorage('custom-habits', JSON.stringify(customHabits));
            closeAddHabitModal();
            render();
        }

        function resetHabits() {
            if (confirm('¬øRestaurar los h√°bitos originales?')) {
                customHabits = null;
                removeStorage('custom-habits');
                render();
            }
        }

        // ========== GYM MODALS ==========
        function openEditGymModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const dayIndex = currentDate.getDay();
            const gym = getGymFocus(dayIndex);

            document.getElementById('editGymExercise').value = gym.exercises[index];

            document.getElementById('editGymModal').classList.remove('hidden');
        }

        function closeEditGymModal() {
            document.getElementById('editGymModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveGymEdit() {
            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            const originalExercise = gym.exercises[editingIndex];
            const newExercise = document.getElementById('editGymExercise').value;

            // Guardar este d√≠a primero
            gym.exercises[editingIndex] = newExercise;
            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));

            closeEditGymModal();

            showReplaceAllModal('gym',
                `¬øReemplazar "${originalExercise}" en todos los d√≠as de la semana?`,
                (replaceAll) => {
                    if (replaceAll) {
                        // Reemplazar en todos los d√≠as
                        for (let d = 0; d < 7; d++) {
                            if (d !== dayIndex && customGym[d]) {
                                customGym[d].exercises = customGym[d].exercises.map(ex =>
                                    ex === originalExercise ? newExercise : ex
                                );
                            }
                        }
                        setStorage('custom-gym', JSON.stringify(customGym));
                    }
                }
            );
        }

        function deleteGymExercise() {
            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            gym.exercises.splice(deletingIndex, 1);
            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));
        }

        function openAddGymModal() {
            document.getElementById('addGymExercise').value = '';
            document.getElementById('addGymModal').classList.remove('hidden');
        }

        function closeAddGymModal() {
            document.getElementById('addGymModal').classList.add('hidden');
        }

        function saveNewGymExercise() {
            const exercise = document.getElementById('addGymExercise').value;

            if (!exercise) {
                alert('Por favor ingresa el ejercicio');
                return;
            }

            const dayIndex = currentDate.getDay();
            let gym = customGym[dayIndex] || JSON.parse(JSON.stringify(defaultGymFocus[dayIndex]));
            gym.exercises.push(exercise);

            customGym[dayIndex] = gym;
            setStorage('custom-gym', JSON.stringify(customGym));
            closeAddGymModal();
            render();
        }

        function resetGym() {
            if (confirm('¬øRestaurar la rutina original de este d√≠a?')) {
                const dayIndex = currentDate.getDay();
                delete customGym[dayIndex];
                setStorage('custom-gym', JSON.stringify(customGym));
                render();
            }
        }

        // ========== MEAL MODALS ==========
        function openEditMealModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const meal = getMeals()[index];

            document.getElementById('editMealTime').value = meal.time;
            document.getElementById('editMealName').value = meal.name;
            document.getElementById('editMealEmoji').value = meal.emoji;
            document.getElementById('editMealOptions').value = meal.options.join('\n');
            document.getElementById('editMealMacros').value = meal.macros;

            document.getElementById('editMealModal').classList.remove('hidden');
        }

        function closeEditMealModal() {
            document.getElementById('editMealModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveMealEdit() {
            const newMeal = {
                time: document.getElementById('editMealTime').value,
                name: document.getElementById('editMealName').value,
                emoji: document.getElementById('editMealEmoji').value,
                options: document.getElementById('editMealOptions').value.split('\n').filter(o => o.trim()),
                macros: document.getElementById('editMealMacros').value
            };
            const indexToEdit = editingIndex; // Guardar antes de cerrar modal

            closeEditMealModal();

            showReplaceAllModal('meal',
                `Este cambio aplicar√° a "${newMeal.name}" en todos los d√≠as. ¬øContinuar?`,
                (confirmed) => {
                    if (confirmed) {
                        let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
                        meals[indexToEdit] = newMeal;
                        meals.sort((a, b) => a.time.localeCompare(b.time));
                        customMeals = meals;
                        setStorage('custom-meals', JSON.stringify(customMeals));
                    }
                }
            );
        }

        function deleteMeal() {
            let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
            meals.splice(deletingIndex, 1);
            customMeals = meals;
            setStorage('custom-meals', JSON.stringify(customMeals));
        }

        function openAddMealModal() {
            document.getElementById('addMealTime').value = '';
            document.getElementById('addMealName').value = '';
            document.getElementById('addMealEmoji').value = 'üçΩÔ∏è';
            document.getElementById('addMealOptions').value = '';
            document.getElementById('addMealMacros').value = '';
            document.getElementById('addMealModal').classList.remove('hidden');
        }

        function closeAddMealModal() {
            document.getElementById('addMealModal').classList.add('hidden');
        }

        function saveNewMeal() {
            const time = document.getElementById('addMealTime').value;
            const name = document.getElementById('addMealName').value;

            if (!time || !name) {
                alert('Por favor completa la hora y el nombre');
                return;
            }

            let meals = customMeals || JSON.parse(JSON.stringify(defaultMeals));
            meals.push({
                time,
                name,
                emoji: document.getElementById('addMealEmoji').value || 'üçΩÔ∏è',
                options: document.getElementById('addMealOptions').value.split('\n').filter(o => o.trim()),
                macros: document.getElementById('addMealMacros').value
            });

            meals.sort((a, b) => a.time.localeCompare(b.time));

            customMeals = meals;
            setStorage('custom-meals', JSON.stringify(customMeals));
            closeAddMealModal();
            render();
        }

        function resetMeals() {
            if (confirm('¬øRestaurar el plan de comidas original?')) {
                customMeals = null;
                removeStorage('custom-meals');
                render();
            }
        }

        // ========== GOAL MODALS ==========
        function openEditGoalModal(index) {
            event.stopPropagation();
            editingIndex = index;
            const goal = getWeeklyGoals()[index];

            document.getElementById('editGoalWeek').value = goal.week;
            document.getElementById('editGoalDates').value = goal.dates;
            document.getElementById('editGoalFisica').value = goal.fisica;
            document.getElementById('editGoalPersonal').value = goal.personal;
            document.getElementById('editGoalDigital').value = goal.digital;
            document.getElementById('editGoalEspiritual').value = goal.espiritual;

            document.getElementById('editGoalModal').classList.remove('hidden');
        }

        function closeEditGoalModal() {
            document.getElementById('editGoalModal').classList.add('hidden');
            editingIndex = null;
        }

        function saveGoalEdit() {
            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));

            goals[editingIndex] = {
                week: parseInt(document.getElementById('editGoalWeek').value),
                dates: document.getElementById('editGoalDates').value,
                fisica: document.getElementById('editGoalFisica').value,
                personal: document.getElementById('editGoalPersonal').value,
                digital: document.getElementById('editGoalDigital').value,
                espiritual: document.getElementById('editGoalEspiritual').value
            };

            goals.sort((a, b) => a.week - b.week);

            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
            closeEditGoalModal();
            render();
        }

        function deleteGoal() {
            let goals = customGoals || JSON.parse(JSON.stringify(defaultWeeklyGoals));
            goals.splice(deletingIndex, 1);
            customGoals = goals;
            setStorage('custom-goals', JSON.stringify(customGoals));
        }

        function resetGoals() {
            if (confirm('¬øRestaurar las metas originales?')) {
                customGoals = null;
                removeStorage('custom-goals');
                render();
            }
        }

        function renderProgressCircle(percent, size, strokeWidth, color, label) {
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percent / 100) * circumference;

            return `
                <div class="flex flex-col items-center">
                    <div class="relative" style="width: ${size}px; height: ${size}px;">
                        <svg class="transform -rotate-90" width="${size}" height="${size}">
                            <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="#e5e7eb" stroke-width="${strokeWidth}" fill="none"/>
                            <circle cx="${size/2}" cy="${size/2}" r="${radius}" stroke="url(#gradient-${label})" stroke-width="${strokeWidth}" fill="none" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" class="progress-ring"/>
                            <defs>
                                <linearGradient id="gradient-${label}" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:${color === 'rose' ? '#ec4899' : color === 'purple' ? '#8b5cf6' : '#06b6d4'}"/>
                                    <stop offset="100%" style="stop-color:${color === 'rose' ? '#f43f5e' : color === 'purple' ? '#a855f7' : '#0891b2'}"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-800">${percent}%</span>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500 mt-1 font-medium">${label}</span>
                </div>
            `;
        }

        function render() {
            const dayIndex = currentDate.getDay();
            const weekNum = getWeekNumber();
            const dayNum = getDayNumber();
            const dateKey = getDateKey();
            const dailyProgress = getDailyProgress();
            const weeklyProgress = getWeeklyProgress();
            const totalProgress = getTotalProgress();
            const schedule = getSchedule(dayIndex, dateKey);
            const gym = getGymFocus(dayIndex);
            const isCustomized = !!customSchedules[dateKey];

            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header -->
                <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-50">
                    <div class="max-w-4xl mx-auto px-3 py-2">
                        <div class="flex items-center gap-3">
                            <div class="relative flex-shrink-0 cursor-pointer group" onclick="openPhotoModal()" title="Cambiar foto de perfil">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-pink-500 to-purple-500 flex items-center justify-center text-white text-lg font-bold border-2 border-purple-200 photo-glow overflow-hidden group-hover:opacity-80 transition">
                                    ${getUserPhoto() ? `<img src="${getUserPhoto()}" class="w-full h-full object-cover">` : currentUser.name.charAt(0).toUpperCase()}
                                </div>
                                <span class="absolute -bottom-0.5 -right-0.5 text-sm group-hover:scale-110 transition">üì∑</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h1 class="text-base font-bold gradient-text">üëã ${currentUser.name}</h1>
                                <p class="text-xs text-gray-500">${getGoalText(currentUser.goal)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex flex-col items-end gap-1 text-xs flex-shrink-0">
                                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium">S${weekNum}/${totalWeeks}</span>
                                    <span class="px-2 py-0.5 bg-rose-100 text-rose-700 rounded-full font-medium">D${dayNum}/${userDuration}</span>
                                </div>
                                <button onclick="logout()" class="p-2 text-gray-400 hover:text-red-500 transition" title="Cerrar sesi√≥n">
                                    üö™
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Progress Dashboard -->
                <div class="bg-white/80 backdrop-blur-sm border-b">
                    <div class="max-w-4xl mx-auto px-4 py-5">
                        <div class="flex justify-around items-center">
                            ${renderProgressCircle(dailyProgress, 80, 8, 'rose', 'HOY')}
                            ${renderProgressCircle(weeklyProgress, 80, 8, 'purple', 'SEMANA')}
                            ${renderProgressCircle(totalProgress, 80, 8, 'cyan', 'TOTAL')}
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-sm text-gray-500">
                                ${totalProgress === 100 ? 'üèÜ ¬°PROGRAMA COMPLETADO! ¬°Eres una campeona!' :
                                  totalProgress >= 75 ? 'üî• ¬°Vas incre√≠ble! La corona te espera' :
                                  totalProgress >= 50 ? 'üí™ ¬°M√°s de la mitad! Sigue as√≠' :
                                  totalProgress >= 25 ? '‚ú® ¬°Buen progreso! No te detengas' :
                                  'üåü ¬°Cada d√≠a cuenta! T√∫ puedes'}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Date Navigation -->
                <div class="bg-white/60 backdrop-blur-sm border-b">
                    <div class="max-w-4xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <button onclick="navigateDay(-1)" class="p-3 hover:bg-white rounded-full transition text-2xl ${currentDate <= startDate ? 'opacity-30' : ''}">‚óÄÔ∏è</button>
                            <div class="text-center cursor-pointer hover:bg-white/50 px-4 py-2 rounded-xl transition" onclick="openCalendarModal()">
                                <p class="text-2xl font-bold text-gray-800">${daysSpanish[dayIndex]}</p>
                                <p class="text-gray-500 flex items-center justify-center gap-2">
                                    <span>üìÖ</span>
                                    ${currentDate.getDate()} de ${monthsSpanish[currentDate.getMonth()]} 2026
                                </p>
                                ${isCustomized ? '<span class="text-xs text-purple-500">‚úèÔ∏è Personalizado</span>' : ''}
                            </div>
                            <button onclick="navigateDay(1)" class="p-3 hover:bg-white rounded-full transition text-2xl ${currentDate >= endDate ? 'opacity-30' : ''}">‚ñ∂Ô∏è</button>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white/40 border-b sticky top-[88px] z-40">
                    <div class="max-w-4xl mx-auto px-4">
                        <div class="flex gap-2 overflow-x-auto py-3 no-scrollbar">
                            ${['agenda', 'habits', 'gym', 'meals', 'goals'].map(tab => `
                                <button onclick="setTab('${tab}')" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap ${activeTab === tab ? 'tab-active shadow-md' : 'bg-white/80 text-gray-600 hover:bg-white'}">
                                    ${tab === 'agenda' ? 'üìÖ Agenda' : tab === 'habits' ? '‚úÖ H√°bitos' : tab === 'gym' ? 'üí™ Gym' : tab === 'meals' ? 'ü•ó Comidas' : 'üéØ Metas'}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <main class="max-w-4xl mx-auto px-4 py-6">
                    ${activeTab === 'agenda' ? renderAgenda(schedule, gym, dateKey, dailyProgress, isCustomized) : ''}
                    ${activeTab === 'habits' ? renderHabits(dateKey) : ''}
                    ${activeTab === 'gym' ? renderGym(gym, dayIndex, weekNum) : ''}
                    ${activeTab === 'meals' ? renderMeals() : ''}
                    ${activeTab === 'goals' ? renderGoals(weekNum) : ''}
                </main>

                <!-- Footer -->
                <footer class="bg-white/80 backdrop-blur-sm border-t mt-8">
                    <div class="max-w-4xl mx-auto px-4 py-6 text-center">
                        <p class="text-lg font-medium text-gray-700">"El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a"</p>
                        <p class="text-purple-500 mt-2 text-xl">‚ú® ¬°T√∫ puedes, ${currentUser.name.split(' ')[0]}! ‚ú®</p>
                    </div>
                </footer>
            `;
        }

        function renderAgenda(schedule, gym, dateKey, dailyProgress, isCustomized) {
            const completedCount = schedule.filter((_, idx) => completedActivities[`${dateKey}-${idx}`]).length;

            return `
                <div class="space-y-3">
                    <div class="bg-gradient-to-r from-rose-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <span class="text-5xl">${gym.icon}</span>
                                <div>
                                    <p class="font-bold text-xl">${gym.name}</p>
                                    <p class="text-white/80 text-sm">${schedule.length} actividades hoy</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-4xl font-bold">${dailyProgress}%</p>
                                <p class="text-white/80 text-sm">${completedCount}/${schedule.length} completadas</p>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-white rounded-full progress-bar" style="width: ${dailyProgress}%"></div>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar Actividad
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetDay()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar
                            </button>
                        ` : ''}
                    </div>

                    ${schedule.map((item, idx) => {
                        const colors = categoryColors[item.category] || categoryColors.personal;
                        const isCompleted = completedActivities[`${dateKey}-${idx}`];
                        return `
                            <div class="${colors.bg} ${colors.border} border rounded-xl p-4 transition-all card-hover ${isCompleted ? 'checked-item' : ''}">
                                <div class="flex items-start gap-4">
                                    <div onclick="toggleActivity(${idx})" class="w-12 h-12 rounded-full ${isCompleted ? 'bg-green-500' : colors.badge} flex items-center justify-center flex-shrink-0 text-xl transition-all cursor-pointer hover:scale-110 ${isCompleted ? 'text-white' : ''}">
                                        ${isCompleted ? '‚úì' : '‚óã'}
                                    </div>
                                    <div class="flex-1 min-w-0" onclick="toggleActivity(${idx})" style="cursor: pointer;">
                                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                                            <span class="font-mono text-sm text-gray-500">${item.time}</span>
                                            <span class="text-xs px-2 py-0.5 rounded-full ${colors.badge} ${colors.text}">${item.duration}</span>
                                        </div>
                                        <p class="font-medium ${isCompleted ? 'line-through text-gray-400' : 'text-gray-800'}">${item.activity}</p>
                                    </div>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="openEditModal(${idx})" class="btn-icon w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${idx}, 'activity')" class="btn-icon w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}

                    ${schedule.length === 0 ? `
                        <div class="text-center py-12 text-gray-400">
                            <span class="text-5xl block mb-4">üìù</span>
                            <p>No hay actividades para este d√≠a</p>
                            <p class="text-sm">Presiona "Agregar Actividad" para comenzar</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderHabits(dateKey) {
            const habits = getHabits();
            const completedCount = habits.filter(h => checkedHabits[`${dateKey}-${h.id}`]).length;
            const progress = Math.round((completedCount / habits.length) * 100);
            const isCustomized = customHabits !== null;

            return `
                <div class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg text-gray-800">H√°bitos del d√≠a</h3>
                            <span class="text-2xl font-bold text-purple-600">${completedCount}/${habits.length}</span>
                        </div>
                        <div class="h-4 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-rose-400 to-purple-500 progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-center mt-3 text-sm text-gray-500">
                            ${progress === 100 ? 'üéâ ¬°Todos los h√°bitos completados!' : progress >= 80 ? 'üí™ ¬°Casi perfecto!' : progress >= 50 ? '‚ú® ¬°Vas muy bien!' : 'üåü ¬°Sigue adelante!'}
                        </p>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddHabitModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar H√°bito
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetHabits()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar
                            </button>
                        ` : ''}
                    </div>

                    <div class="grid gap-3">
                        ${habits.map((habit, idx) => {
                            const isChecked = checkedHabits[`${dateKey}-${habit.id}`];
                            return `
                                <div class="flex items-center gap-2 p-4 rounded-xl border-2 transition-all ${isChecked ? 'habit-checked' : 'bg-white border-gray-100 hover:border-gray-200'}">
                                    <button onclick="toggleHabit(${habit.id})" class="flex items-center gap-4 flex-1 text-left">
                                        <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${isChecked ? 'bg-purple-500 border-purple-500 text-white' : 'border-gray-300'}">
                                            ${isChecked ? '‚úì' : ''}
                                        </div>
                                        <span class="text-2xl">${habit.icon}</span>
                                        <span class="font-medium ${isChecked ? 'text-purple-700' : 'text-gray-700'}">${habit.name}</span>
                                    </button>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="openEditHabitModal(${idx})" class="btn-icon w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-sm" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${idx}, 'habit')" class="btn-icon w-9 h-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-sm" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderGym(gym, dayIndex, weekNum) {
            const isCustomized = !!customGym[dayIndex];

            return `
                <div class="space-y-4">
                    <div class="bg-gradient-to-br from-rose-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center gap-4">
                            <span class="text-6xl">${gym.icon}</span>
                            <div>
                                <h3 class="text-2xl font-bold">${gym.name}</h3>
                                <p class="opacity-90">${daysSpanish[dayIndex]} - Semana ${weekNum}</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddGymModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar Ejercicio
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetGym()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar
                            </button>
                        ` : ''}
                    </div>

                    <div class="bg-white rounded-2xl p-5 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">üí™ Ejercicios del d√≠a</h4>
                        <div class="space-y-3">
                            ${gym.exercises.map((ex, idx) => `
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                                    <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">${idx + 1}</span>
                                    <span class="text-gray-700 flex-1">${ex}</span>
                                    <div class="flex gap-1 flex-shrink-0">
                                        <button onclick="openEditGymModal(${idx})" class="btn-icon w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-sm" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button onclick="openDeleteModal(${idx}, 'gym')" class="btn-icon w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-sm" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-5">
                        <h4 class="font-bold text-amber-800 mb-2">üí° Tips del d√≠a</h4>
                        <ul class="text-amber-700 text-sm space-y-2">
                            <li>‚Ä¢ Descanso entre series: 60-90 segundos</li>
                            <li>‚Ä¢ Mant√©n la conexi√≥n mente-m√∫sculo</li>
                            <li>‚Ä¢ Hidrataci√≥n constante durante el entreno</li>
                            <li>‚Ä¢ Batido proteico dentro de 30 min post-gym</li>
                        </ul>
                    </div>

                    <div class="bg-rose-50 border border-rose-200 rounded-2xl p-5">
                        <h4 class="font-bold text-rose-800 mb-2">üéØ Objetivos f√≠sicos</h4>
                        <ul class="text-rose-700 text-sm space-y-2">
                            <li>‚Ä¢ Peso ideal: 58 kg</li>
                            <li>‚Ä¢ Gl√∫teos m√°s grandes y definidos</li>
                            <li>‚Ä¢ Cu√°driceps e isquios trabajados</li>
                            <li>‚Ä¢ Abdominales marcados</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderMeals() {
            const meals = getMeals();
            const isCustomized = customMeals !== null;

            return `
                <div class="space-y-4">
                    <div class="flex gap-2 mb-4">
                        <button onclick="openAddMealModal()" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-purple-600 border-2 border-purple-100">
                            <span class="text-xl">‚ûï</span> Agregar Comida
                        </button>
                        ${isCustomized ? `
                            <button onclick="resetMeals()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar
                            </button>
                        ` : ''}
                    </div>

                    ${meals.map((meal, idx) => `
                        <div class="bg-white rounded-2xl p-5 shadow-sm card-hover">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl">${meal.emoji}</span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${meal.name}</h4>
                                    <p class="text-sm text-gray-500">${meal.time}</p>
                                </div>
                                <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium">${meal.macros}</span>
                                <div class="flex gap-1 flex-shrink-0">
                                    <button onclick="openEditMealModal(${idx})" class="btn-icon w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 text-sm" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="openDeleteModal(${idx}, 'meal')" class="btn-icon w-9 h-9 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 text-sm" title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                ${meal.options.map(opt => `
                                    <div class="flex items-center gap-2 text-gray-600">
                                        <span class="w-2 h-2 bg-purple-400 rounded-full flex-shrink-0"></span>
                                        <span>${opt}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-5">
                            <h4 class="font-bold text-red-700 mb-3">‚ùå Prohibidos</h4>
                            <ul class="text-red-600 space-y-2">
                                <li>‚Ä¢ Az√∫car refinada</li>
                                <li>‚Ä¢ Bebidas azucaradas</li>
                                <li>‚Ä¢ Frituras</li>
                                <li>‚Ä¢ Harinas blancas</li>
                                <li>‚Ä¢ Alcohol</li>
                            </ul>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-2xl p-5">
                            <h4 class="font-bold text-green-700 mb-3">‚úÖ Suplementos</h4>
                            <ul class="text-green-600 space-y-2">
                                <li>‚Ä¢ Creatina: 5g AM</li>
                                <li>‚Ä¢ Omega 3: 1000mg</li>
                                <li>‚Ä¢ Vitamina C: 1000mg</li>
                                <li>‚Ä¢ Prote√≠na: 25-30g</li>
                                <li>‚Ä¢ Agua: 3L m√≠nimo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGoals(currentWeek) {
            const goals = getWeeklyGoals();
            const isCustomized = customGoals !== null;

            return `
                <div class="space-y-4">
                    <div class="flex gap-2 mb-4">
                        ${isCustomized ? `
                            <button onclick="resetGoals()" class="flex items-center justify-center gap-2 px-4 py-3 bg-white rounded-xl shadow-sm hover:shadow-md transition font-medium text-gray-500 border-2 border-gray-100">
                                <span class="text-xl">üîÑ</span> Restaurar Metas Originales
                            </button>
                        ` : ''}
                    </div>

                    ${goals.map((goal, idx) => `
                        <div class="rounded-2xl p-5 shadow-sm transition-all ${
                            goal.week === currentWeek
                                ? 'bg-gradient-to-r from-rose-500 to-purple-600 text-white ring-4 ring-purple-200 glow'
                                : goal.week < currentWeek
                                ? 'bg-gray-100 opacity-70'
                                : 'bg-white'
                        }">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg ${
                                    goal.week === currentWeek ? 'bg-white/20' : goal.week < currentWeek ? 'bg-green-100 text-green-600' : 'bg-purple-100 text-purple-600'
                                }">
                                    ${goal.week < currentWeek ? '‚úì' : goal.week}
                                </span>
                                <div class="flex-1">
                                    <h4 class="font-bold text-lg">Semana ${goal.week}</h4>
                                    <p class="text-sm ${goal.week === currentWeek ? 'text-white/80' : 'text-gray-500'}">${goal.dates}</p>
                                </div>
                                ${goal.week === currentWeek ? '<span class="px-3 py-1 bg-white/20 rounded-full text-sm animate-pulse">üìç Est√°s aqu√≠</span>' : ''}
                                <button onclick="openEditGoalModal(${idx})" class="btn-icon w-10 h-10 rounded-full ${goal.week === currentWeek ? 'bg-white/20 text-white hover:bg-white/30' : 'bg-blue-100 text-blue-600 hover:bg-blue-200'} flex items-center justify-center" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-rose-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-rose-700'}">üí™ F√≠sica</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.fisica}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-blue-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-blue-700'}">üìö Personal</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.personal}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-purple-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-purple-700'}">üì± Digital</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.digital}</p>
                                </div>
                                <div class="p-3 rounded-xl ${goal.week === currentWeek ? 'bg-white/10' : 'bg-indigo-50'}">
                                    <p class="font-medium mb-1 ${goal.week === currentWeek ? '' : 'text-indigo-700'}">üßò Espiritual</p>
                                    <p class="${goal.week === currentWeek ? 'text-white/90' : 'text-gray-600'}">${goal.espiritual}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Initial render
        render();
    </script>
</body>
</html>
