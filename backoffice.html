<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice — Gestión del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf9f7;
            --bg-card: #ffffff;
            --bg-elevated: #f5f4f2;
            --text-primary: #1a1a1a;
            --text-secondary: #6b6b6b;
            --text-muted: #9a9a9a;
            --border: #e8e6e3;
            --accent: #1a1a1a;
            --accent-soft: #f0efed;
            --success: #2d7a4f;
            --warning: #b5830a;
            --danger: #b53d3d;
        }

        * {
            font-family: 'DM Sans', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Elegant scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
        }

        .nav-item {
            color: var(--text-secondary);
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px 0;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: var(--accent-soft);
        }

        .nav-item.active {
            color: var(--text-primary);
            background: var(--accent-soft);
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.04);
        }

        /* Stat cards */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.03em;
            line-height: 1;
        }

        /* Buttons */
        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #333;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--accent-soft);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-ghost {
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-ghost:hover {
            color: var(--text-primary);
            background: var(--accent-soft);
        }

        /* Inputs */
        .input {
            background: var(--bg-elevated);
            border: 1px solid transparent;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        /* Table */
        .table-header {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .table-row {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }

        .table-row:hover {
            background: var(--accent-soft);
        }

        .table-row:last-child {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #e8f5ed;
            color: var(--success);
        }

        .badge-warning {
            background: #fef7e6;
            color: var(--warning);
        }

        .badge-danger {
            background: #fceaea;
            color: var(--danger);
        }

        .badge-neutral {
            background: var(--accent-soft);
            color: var(--text-secondary);
        }

        /* Modal */
        .modal-backdrop {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
        }

        /* Toast */
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        /* Action icon buttons */
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .icon-btn:hover {
            transform: scale(1.05);
        }

        /* Quick actions */
        .quick-action {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        /* Select styling */
        .select {
            background: var(--bg-elevated);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Avatar */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        /* Section title */
        .section-title {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* Checkbox */
        .checkbox {
            width: 18px;
            height: 18px;
            border-radius: 5px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .checkbox:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Connection indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .section {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
        <!-- Logo -->
        <div class="p-8 pb-6">
            <h1 class="font-semibold text-2xl tracking-tight">Gestión</h1>
            <p class="text-sm text-[var(--text-muted)] mt-1">Panel de administración</p>
        </div>

        <!-- Navigation -->
        <nav class="px-4 space-y-1">
            <button onclick="showSection('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-left" data-section="dashboard">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zm0 7a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1h-4a1 1 0 01-1-1v-5zm-10-1a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2z"/></svg>
                Dashboard
            </button>
            <button onclick="showSection('customers')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left" data-section="customers">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Clientes
            </button>
            <button onclick="showSection('subscriptions')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left" data-section="subscriptions">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                Suscripciones
            </button>
            <button onclick="showSection('payments')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left" data-section="payments">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Pagos
            </button>
            <button onclick="showSection('reports')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left" data-section="reports">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                Reportes
            </button>
            <button onclick="showSection('templates')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left" data-section="templates">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm0 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zm12 0a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                Plantillas
            </button>
            <button onclick="showSection('settings')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left" data-section="settings">
                <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Configuración
            </button>
        </nav>

        <!-- Logout -->
        <div class="absolute bottom-0 left-0 right-0 p-4">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 text-[var(--text-muted)] hover:text-[var(--danger)] hover:bg-[#fceaea] rounded-xl transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Cerrar sesión
            </button>
        </div>
    </aside>

    <!-- Mobile menu toggle -->
    <button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-white rounded-xl shadow-sm border border-[var(--border)]">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        <!-- Top Bar -->
        <header class="sticky top-0 z-30 bg-[var(--bg-primary)]/80 backdrop-blur-xl border-b border-[var(--border)]">
            <div class="px-8 py-5 flex items-center justify-between">
                <h2 id="pageTitle" class="section-title">Dashboard</h2>
                <div class="flex items-center gap-4">
                    <div id="connectionStatus" class="flex items-center gap-2 px-4 py-2 rounded-full bg-[var(--accent-soft)]">
                        <span class="status-dot bg-amber-400"></span>
                        <span class="text-sm text-[var(--text-secondary)]">Conectando...</span>
                    </div>
                    <button onclick="refreshData()" class="btn-primary flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Actualizar
                    </button>
                </div>
            </div>
        </header>

        <div class="p-8">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="stat-card flex items-start justify-between">
                        <div>
                            <p class="text-[var(--text-muted)] text-sm mb-3">Ingresos mensuales</p>
                            <p id="statMRR" class="stat-value">$0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-emerald-50 flex items-center justify-center">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                    </div>
                    <div class="stat-card flex items-start justify-between">
                        <div>
                            <p class="text-[var(--text-muted)] text-sm mb-3">Clientes activos</p>
                            <p id="statActiveCustomers" class="stat-value">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        </div>
                    </div>
                    <div class="stat-card flex items-start justify-between">
                        <div>
                            <p class="text-[var(--text-muted)] text-sm mb-3">Nuevos este mes</p>
                            <p id="statNewCustomers" class="stat-value">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-violet-50 flex items-center justify-center">
                            <svg class="w-6 h-6 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                        </div>
                    </div>
                    <div class="stat-card flex items-start justify-between">
                        <div>
                            <p class="text-[var(--text-muted)] text-sm mb-3">Tasa de abandono</p>
                            <p id="statChurnRate" class="stat-value">0%</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-amber-50 flex items-center justify-center">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
                    <div class="card p-8">
                        <h3 class="text-lg font-medium mb-6 flex items-center gap-3">
                            <svg class="w-5 h-5 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                            Ingresos mensuales
                        </h3>
                        <canvas id="revenueChart" height="200"></canvas>
                    </div>
                    <div class="card p-8">
                        <h3 class="text-lg font-medium mb-6 flex items-center gap-3">
                            <svg class="w-5 h-5 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>
                            Distribución por plan
                        </h3>
                        <canvas id="planDistributionChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="p-6 border-b border-[var(--border)]">
                        <h3 class="text-lg font-medium flex items-center gap-3">
                            <svg class="w-5 h-5 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Actividad reciente
                        </h3>
                    </div>
                    <div id="recentActivity" class="p-6">
                        <p class="text-[var(--text-muted)] text-center py-8">Cargando actividad...</p>
                    </div>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="section-customers" class="section hidden">
                <!-- Quick Actions -->
                <div class="flex flex-wrap items-center gap-4 mb-8">
                    <button onclick="openCreateCustomerModal()" class="btn-primary flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Nuevo cliente
                    </button>
                    <div class="h-6 w-px bg-[var(--border)]"></div>
                    <button onclick="bulkActivatePro()" class="quick-action bg-emerald-50 text-emerald-700 hover:bg-emerald-100 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Activar Pro
                    </button>
                    <button onclick="bulkExtendTrial()" class="quick-action bg-blue-50 text-blue-700 hover:bg-blue-100 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        +7 días trial
                    </button>
                    <button onclick="bulkDeactivate()" class="quick-action bg-red-50 text-red-700 hover:bg-red-100 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                        Desactivar
                    </button>
                    <span id="selectedCount" class="ml-auto text-sm text-[var(--text-muted)] hidden">0 seleccionados</span>
                </div>

                <!-- Customers Table -->
                <div class="card overflow-hidden">
                    <div class="p-6 border-b border-[var(--border)] flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <h3 class="text-lg font-medium">Todos los clientes</h3>
                        <div class="flex flex-wrap gap-3">
                            <input type="text" id="customerSearch" onkeyup="filterCustomers()" placeholder="Buscar..." class="input w-48">
                            <select id="customerPlanFilter" onchange="filterCustomers()" class="select">
                                <option value="">Todos los planes</option>
                                <option value="Free">Free</option>
                                <option value="Pro">Pro</option>
                                <option value="Teams">Teams</option>
                            </select>
                            <button onclick="exportCustomers()" class="btn-secondary flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Exportar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-[var(--border)]">
                                    <th class="px-6 py-4 text-left">
                                        <input type="checkbox" onclick="toggleSelectAll()" class="checkbox" title="Seleccionar todos">
                                    </th>
                                    <th class="px-6 py-4 text-left table-header">Cliente</th>
                                    <th class="px-6 py-4 text-left table-header">Email</th>
                                    <th class="px-6 py-4 text-left table-header">Plan</th>
                                    <th class="px-6 py-4 text-left table-header">Estado</th>
                                    <th class="px-6 py-4 text-left table-header">Registro</th>
                                    <th class="px-6 py-4 text-left table-header">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <tr><td colspan="7" class="px-6 py-16 text-center text-[var(--text-muted)]">Cargando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="customersPagination" class="p-5 border-t border-[var(--border)] flex items-center justify-between">
                        <p class="text-sm text-[var(--text-muted)]">Mostrando <span id="customersShowing">0</span> de <span id="customersTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadCustomers(currentCustomerPage - 1)" id="customersPrevBtn" class="btn-ghost" disabled>Anterior</button>
                            <button onclick="loadCustomers(currentCustomerPage + 1)" id="customersNextBtn" class="btn-ghost">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section id="section-subscriptions" class="section hidden">
                <div class="card overflow-hidden">
                    <div class="p-6 border-b border-[var(--border)] flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <h3 class="text-lg font-medium">Suscripciones</h3>
                        <div class="flex flex-wrap gap-3">
                            <select id="subscriptionStatusFilter" onchange="filterSubscriptions()" class="select">
                                <option value="">Todos los estados</option>
                                <option value="Active">Activas</option>
                                <option value="Paused">Pausadas</option>
                                <option value="Cancelled">Canceladas</option>
                                <option value="Expired">Expiradas</option>
                            </select>
                            <button onclick="exportSubscriptions()" class="btn-secondary flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Exportar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-[var(--border)]">
                                    <th class="px-6 py-4 text-left table-header">ID</th>
                                    <th class="px-6 py-4 text-left table-header">Cliente</th>
                                    <th class="px-6 py-4 text-left table-header">Plan</th>
                                    <th class="px-6 py-4 text-left table-header">Ciclo</th>
                                    <th class="px-6 py-4 text-left table-header">Estado</th>
                                    <th class="px-6 py-4 text-left table-header">Vence</th>
                                    <th class="px-6 py-4 text-left table-header">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsTableBody">
                                <tr><td colspan="7" class="px-6 py-16 text-center text-[var(--text-muted)]">Cargando suscripciones...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="subscriptionsPagination" class="p-5 border-t border-[var(--border)] flex items-center justify-between">
                        <p class="text-sm text-[var(--text-muted)]">Mostrando <span id="subscriptionsShowing">0</span> de <span id="subscriptionsTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadSubscriptions(currentSubscriptionPage - 1)" id="subscriptionsPrevBtn" class="btn-ghost" disabled>Anterior</button>
                            <button onclick="loadSubscriptions(currentSubscriptionPage + 1)" id="subscriptionsNextBtn" class="btn-ghost">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section id="section-payments" class="section hidden">
                <div class="card overflow-hidden">
                    <div class="p-6 border-b border-[var(--border)] flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <h3 class="text-lg font-medium">Historial de pagos</h3>
                        <div class="flex flex-wrap gap-3">
                            <input type="date" id="paymentDateFrom" class="input">
                            <input type="date" id="paymentDateTo" class="input">
                            <button onclick="filterPayments()" class="btn-secondary">Filtrar</button>
                            <button onclick="exportPayments()" class="btn-secondary flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Exportar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-[var(--border)]">
                                    <th class="px-6 py-4 text-left table-header">ID</th>
                                    <th class="px-6 py-4 text-left table-header">Cliente</th>
                                    <th class="px-6 py-4 text-left table-header">Monto</th>
                                    <th class="px-6 py-4 text-left table-header">Fecha</th>
                                    <th class="px-6 py-4 text-left table-header">Método</th>
                                    <th class="px-6 py-4 text-left table-header">Estado</th>
                                    <th class="px-6 py-4 text-left table-header">Transacción</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr><td colspan="7" class="px-6 py-16 text-center text-[var(--text-muted)]">Cargando pagos...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="paymentsPagination" class="p-5 border-t border-[var(--border)] flex items-center justify-between">
                        <p class="text-sm text-[var(--text-muted)]">Mostrando <span id="paymentsShowing">0</span> de <span id="paymentsTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadPayments(currentPaymentPage - 1)" id="paymentsPrevBtn" class="btn-ghost" disabled>Anterior</button>
                            <button onclick="loadPayments(currentPaymentPage + 1)" id="paymentsNextBtn" class="btn-ghost">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="section hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card p-8 cursor-pointer hover:border-[var(--accent)]" onclick="generateReport('customers')">
                        <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center mb-5">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        </div>
                        <h3 class="font-medium mb-2">Reporte de clientes</h3>
                        <p class="text-sm text-[var(--text-muted)]">Lista completa con información de contacto y plan.</p>
                    </div>
                    <div class="card p-8 cursor-pointer hover:border-[var(--accent)]" onclick="generateReport('subscriptions')">
                        <div class="w-12 h-12 rounded-xl bg-purple-50 flex items-center justify-center mb-5">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                        </div>
                        <h3 class="font-medium mb-2">Reporte de suscripciones</h3>
                        <p class="text-sm text-[var(--text-muted)]">Estado de todas las suscripciones activas y canceladas.</p>
                    </div>
                    <div class="card p-8 cursor-pointer hover:border-[var(--accent)]" onclick="generateReport('payments')">
                        <div class="w-12 h-12 rounded-xl bg-emerald-50 flex items-center justify-center mb-5">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <h3 class="font-medium mb-2">Reporte de pagos</h3>
                        <p class="text-sm text-[var(--text-muted)]">Historial de transacciones con montos y métodos.</p>
                    </div>
                    <div class="card p-8 cursor-pointer hover:border-[var(--accent)]" onclick="generateReport('revenue')">
                        <div class="w-12 h-12 rounded-xl bg-amber-50 flex items-center justify-center mb-5">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        </div>
                        <h3 class="font-medium mb-2">Reporte de ingresos</h3>
                        <p class="text-sm text-[var(--text-muted)]">Análisis de ingresos mensuales y tendencias.</p>
                    </div>
                </div>
            </section>

            <!-- Templates Section -->
            <section id="section-templates" class="section hidden">
                <div class="space-y-8">
                    <!-- Goal Templates -->
                    <div class="card p-8">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h3 class="text-lg font-medium">Plantillas por objetivo</h3>
                                <p class="text-sm text-[var(--text-muted)] mt-1">Define hábitos y metas según el objetivo del usuario</p>
                            </div>
                            <button onclick="saveAllTemplates()" class="btn-primary">Guardar todo</button>
                        </div>

                        <!-- Goal Type Tabs -->
                        <div class="flex flex-wrap gap-2 mb-8 pb-6 border-b border-[var(--border)]">
                            <button onclick="selectGoalTab('fitness')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent)] text-white" data-goal="fitness">
                                Fitness
                            </button>
                            <button onclick="selectGoalTab('productivity')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:bg-[var(--border)]" data-goal="productivity">
                                Productividad
                            </button>
                            <button onclick="selectGoalTab('learning')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:bg-[var(--border)]" data-goal="learning">
                                Aprendizaje
                            </button>
                            <button onclick="selectGoalTab('business')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:bg-[var(--border)]" data-goal="business">
                                Negocio
                            </button>
                            <button onclick="selectGoalTab('competition')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:bg-[var(--border)]" data-goal="competition">
                                Competencia
                            </button>
                            <button onclick="selectGoalTab('wellness')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:bg-[var(--border)]" data-goal="wellness">
                                Bienestar
                            </button>
                        </div>

                        <!-- Goal Content -->
                        <div id="goalTemplateContent" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-[var(--bg-elevated)] rounded-xl p-6">
                                <div class="flex items-center justify-between mb-5">
                                    <h4 class="font-medium">Hábitos sugeridos</h4>
                                    <button onclick="addHabitToGoal()" class="text-sm text-[var(--accent)] hover:underline">+ Agregar</button>
                                </div>
                                <div id="goalHabitsList" class="space-y-3"></div>
                            </div>

                            <div class="bg-[var(--bg-elevated)] rounded-xl p-6">
                                <h4 class="font-medium mb-5">Metas semanales</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-xs text-[var(--text-muted)] mb-2 block">Meta Física</label>
                                        <input type="text" id="goalMetaFisica" class="input w-full" placeholder="Ej: Establecer rutina de ejercicio">
                                    </div>
                                    <div>
                                        <label class="text-xs text-[var(--text-muted)] mb-2 block">Meta Personal</label>
                                        <input type="text" id="goalMetaPersonal" class="input w-full" placeholder="Ej: Mejorar autoestima">
                                    </div>
                                    <div>
                                        <label class="text-xs text-[var(--text-muted)] mb-2 block">Meta Digital</label>
                                        <input type="text" id="goalMetaDigital" class="input w-full" placeholder="Ej: Documentar progreso">
                                    </div>
                                    <div>
                                        <label class="text-xs text-[var(--text-muted)] mb-2 block">Meta Espiritual</label>
                                        <input type="text" id="goalMetaEspiritual" class="input w-full" placeholder="Ej: Practicar gratitud">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exercise Templates -->
                    <div class="card p-8">
                        <div class="mb-8">
                            <h3 class="text-lg font-medium">Rutinas de ejercicio</h3>
                            <p class="text-sm text-[var(--text-muted)] mt-1">Define rutinas personalizadas según objetivo y tipo de ejercicio</p>
                        </div>

                        <div class="mb-6">
                            <label class="text-xs text-[var(--text-muted)] mb-3 block">Tipo de ejercicio</label>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="selectExerciseTab('gym')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent)] text-white" data-exercise="gym">Gimnasio</button>
                                <button onclick="selectExerciseTab('cardio')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-exercise="cardio">Cardio</button>
                                <button onclick="selectExerciseTab('yoga')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-exercise="yoga">Yoga</button>
                                <button onclick="selectExerciseTab('dance')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-exercise="dance">Baile</button>
                                <button onclick="selectExerciseTab('sports')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-exercise="sports">Deportes</button>
                            </div>
                        </div>

                        <div class="mb-8 pb-6 border-b border-[var(--border)]">
                            <label class="text-xs text-[var(--text-muted)] mb-3 block">Objetivo del usuario</label>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="selectExerciseGoal('fitness')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-emerald-100 text-emerald-700" data-goal="fitness">Fitness</button>
                                <button onclick="selectExerciseGoal('competition')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-goal="competition">Competencia</button>
                                <button onclick="selectExerciseGoal('wellness')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-goal="wellness">Bienestar</button>
                                <button onclick="selectExerciseGoal('weightloss')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-goal="weightloss">Bajar de peso</button>
                                <button onclick="selectExerciseGoal('muscle')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-goal="muscle">Ganar músculo</button>
                                <button onclick="selectExerciseGoal('beginner')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-[var(--accent-soft)] text-[var(--text-secondary)]" data-goal="beginner">Principiante</button>
                            </div>
                        </div>

                        <div id="exerciseSelectionLabel" class="mb-6 p-4 bg-[var(--bg-elevated)] rounded-xl">
                            <span class="text-sm text-[var(--text-muted)]">Editando: </span>
                            <span class="text-sm font-medium">Gimnasio + Fitness</span>
                        </div>

                        <div id="exerciseTemplateContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Habit Catalog -->
                    <div class="card p-8">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h3 class="text-lg font-medium">Catálogo de hábitos</h3>
                                <p class="text-sm text-[var(--text-muted)] mt-1">Hábitos disponibles para los usuarios</p>
                            </div>
                            <button onclick="addNewHabit()" class="btn-primary">+ Nuevo hábito</button>
                        </div>

                        <div id="habitCatalog" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section hidden">
                <div class="max-w-2xl space-y-8">
                    <!-- API Configuration -->
                    <div class="card p-8">
                        <h3 class="text-lg font-medium mb-6">Configuración de Supabase</h3>
                        <div class="space-y-5">
                            <div>
                                <label class="text-sm text-[var(--text-secondary)] mb-2 block">URL del proyecto</label>
                                <input type="url" id="apiUrlInput" placeholder="https://xxxxx.supabase.co" class="input w-full">
                            </div>
                            <div>
                                <label class="text-sm text-[var(--text-secondary)] mb-2 block">API Key (anon public)</label>
                                <input type="password" id="apiKeyInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="input w-full">
                            </div>
                            <button onclick="saveApiConfig()" class="btn-primary">Guardar y conectar</button>
                        </div>
                    </div>

                    <!-- Admin Password -->
                    <div class="card p-8">
                        <h3 class="text-lg font-medium mb-6">Cambiar contraseña</h3>
                        <div class="space-y-5">
                            <div>
                                <label class="text-sm text-[var(--text-secondary)] mb-2 block">Contraseña actual</label>
                                <input type="password" id="currentPassword" class="input w-full">
                            </div>
                            <div>
                                <label class="text-sm text-[var(--text-secondary)] mb-2 block">Nueva contraseña</label>
                                <input type="password" id="newPassword" class="input w-full">
                            </div>
                            <div>
                                <label class="text-sm text-[var(--text-secondary)] mb-2 block">Confirmar contraseña</label>
                                <input type="password" id="confirmPassword" class="input w-full">
                            </div>
                            <button onclick="changePassword()" class="btn-primary">Cambiar contraseña</button>
                        </div>
                    </div>

                    <!-- Subscription Plans -->
                    <div class="card p-8">
                        <h3 class="text-lg font-medium mb-6">Planes de suscripción</h3>
                        <div id="plansContainer" class="space-y-4">
                            <p class="text-[var(--text-muted)]">Cargando planes...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Create/Edit Customer Modal -->
    <div id="createCustomerModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md">
            <div class="p-6 border-b border-[var(--border)] flex items-center justify-between">
                <h3 id="createCustomerModalTitle" class="text-lg font-medium">Nuevo cliente</h3>
                <button onclick="closeModal('createCustomerModal')" class="p-2 hover:bg-[var(--accent-soft)] rounded-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-6 space-y-5">
                <input type="hidden" id="editCustomerId" value="">
                <div>
                    <label class="text-sm text-[var(--text-secondary)] mb-2 block">Nombre completo</label>
                    <input type="text" id="newCustomerName" placeholder="Juan Pérez" class="input w-full">
                </div>
                <div>
                    <label class="text-sm text-[var(--text-secondary)] mb-2 block">Email</label>
                    <input type="email" id="newCustomerEmail" placeholder="cliente@email.com" class="input w-full">
                </div>
                <div>
                    <label class="text-sm text-[var(--text-secondary)] mb-2 block">Contraseña</label>
                    <input type="password" id="newCustomerPassword" placeholder="••••••••" class="input w-full">
                    <p class="text-xs text-[var(--text-muted)] mt-2">Mínimo 6 caracteres</p>
                </div>
                <div>
                    <label class="text-sm text-[var(--text-secondary)] mb-2 block">Plan inicial</label>
                    <select id="newCustomerPlan" class="select w-full">
                        <option value="free">Free</option>
                        <option value="trial">Trial Pro (7 días)</option>
                        <option value="pro">Pro</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal('createCustomerModal')" class="flex-1 btn-secondary">Cancelar</button>
                    <button onclick="saveCustomer()" class="flex-1 btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-[var(--border)] flex items-center justify-between">
                <h3 class="text-lg font-medium">Detalle del cliente</h3>
                <button onclick="closeModal('customerModal')" class="p-2 hover:bg-[var(--accent-soft)] rounded-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="customerModalContent" class="p-6 overflow-y-auto max-h-[70vh]"></div>
        </div>
    </div>

    <!-- Subscription Action Modal -->
    <div id="subscriptionModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md">
            <div class="p-6 border-b border-[var(--border)]">
                <h3 id="subscriptionModalTitle" class="text-lg font-medium">Acción de suscripción</h3>
            </div>
            <div id="subscriptionModalContent" class="p-6"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="toast p-4 flex items-center gap-3">
            <span id="toastIcon" class="text-lg">✓</span>
            <span id="toastMessage" class="text-sm">Mensaje</span>
        </div>
    </div>

    <script src="src/js/services/supabase-api.js"></script>
    <script>
        // Alias for compatibility
        const frappeAPI = supabaseAPI;
    </script>
    <script>
        // Check admin session
        if (!localStorage.getItem('gestion-admin-session')) {
            window.location.href = 'admin-login.html';
        }

        // Sanitize helpers
        function sanitizeHTML(html) {
            return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
        }

        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // State
        let currentSection = 'dashboard';
        let currentCustomerPage = 1;
        let currentSubscriptionPage = 1;
        let currentPaymentPage = 1;
        let allCustomers = [];
        let allSubscriptions = [];
        let allPayments = [];
        let subscriptionPlans = [];
        let revenueChart = null;
        let planChart = null;
        let isConnected = false;
        let selectedCustomers = [];

        // Init config
        document.getElementById('apiUrlInput').value = localStorage.getItem('supabase_url') || 'https://crpotifjwqoljvcvsdje.supabase.co';
        document.getElementById('apiKeyInput').value = localStorage.getItem('supabase_key') || '';

        // Navigation
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        }

        function showSection(section) {
            currentSection = section;

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === section) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + section).classList.remove('hidden');

            const titles = {
                dashboard: 'Dashboard',
                customers: 'Clientes',
                subscriptions: 'Suscripciones',
                payments: 'Pagos',
                reports: 'Reportes',
                templates: 'Plantillas',
                settings: 'Configuración'
            };
            document.getElementById('pageTitle').textContent = titles[section];

            if (section === 'customers') loadCustomers();
            if (section === 'subscriptions') loadSubscriptions();
            if (section === 'payments') loadPayments();
            if (section === 'templates') initTemplatesSection();
            if (section === 'settings') loadPlans();

            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        // Connection
        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const connected = await supabaseAPI.testConnection();
                if (connected) {
                    isConnected = true;
                    statusEl.innerHTML = '<span class="status-dot bg-emerald-500"></span><span class="text-sm text-[var(--text-secondary)]">Conectado</span>';
                    return true;
                }
            } catch (e) {
                console.log('Using localStorage fallback');
            }
            isConnected = false;
            statusEl.innerHTML = '<span class="status-dot bg-amber-400"></span><span class="text-sm text-[var(--text-secondary)]">Modo local</span>';
            return false;
        }

        async function refreshData() {
            await checkConnection();
            if (isConnected) {
                loadDashboard();
            } else {
                loadLocalData();
            }
        }

        async function loadDashboard() {
            if (isConnected) {
                try {
                    const stats = await frappeAPI.getDashboardStats();
                    updateDashboardUI(stats);
                } catch (e) {
                    console.error('Error loading dashboard:', e);
                    loadLocalData();
                }
            } else {
                loadLocalData();
            }
        }

        function loadLocalData() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const emails = Object.keys(users);

            document.getElementById('statMRR').textContent = '$0';
            document.getElementById('statActiveCustomers').textContent = String(emails.length);
            document.getElementById('statNewCustomers').textContent = String(countNewThisMonth(users));
            document.getElementById('statChurnRate').textContent = '0%';

            updateRevenueChart([
                { month: 'Ene', revenue: 0 },
                { month: 'Feb', revenue: 0 },
                { month: 'Mar', revenue: 0 },
                { month: 'Abr', revenue: 0 },
                { month: 'May', revenue: 0 },
                { month: 'Jun', revenue: 0 }
            ]);

            updatePlanChart([
                { plan_name: 'Free', customer_count: emails.length }
            ]);

            updateRecentActivity([]);
        }

        function countNewThisMonth(users) {
            const now = new Date();
            const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let count = 0;
            Object.values(users).forEach(function(user) {
                if (user.createdAt && new Date(user.createdAt) >= firstOfMonth) count++;
            });
            return count;
        }

        function updateDashboardUI(stats) {
            document.getElementById('statMRR').textContent = frappeAPI.formatCurrency(stats.mrr);
            document.getElementById('statActiveCustomers').textContent = String(stats.active_subscriptions);
            document.getElementById('statNewCustomers').textContent = String(stats.new_customers_month);
            document.getElementById('statChurnRate').textContent = stats.churn_rate + '%';

            updateRevenueChart(stats.revenue_trend);
            updatePlanChart(stats.customers_by_plan);
            updateRecentActivity([]);
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Ingresos',
                        data: data.map(d => d.revenue),
                        borderColor: '#1a1a1a',
                        backgroundColor: 'rgba(26, 26, 26, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#9a9a9a' }, grid: { color: '#f0efed' } },
                        x: { ticks: { color: '#9a9a9a' }, grid: { display: false } }
                    }
                }
            });
        }

        function updatePlanChart(data) {
            if (!Array.isArray(data)) {
                data = data && typeof data === 'object'
                    ? Object.keys(data).map(key => ({ plan_name: key, customer_count: data[key] }))
                    : [];
            }
            const ctx = document.getElementById('planDistributionChart').getContext('2d');
            if (planChart) planChart.destroy();

            planChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.plan_name),
                    datasets: [{
                        data: data.map(d => d.customer_count),
                        backgroundColor: ['#1a1a1a', '#6b6b6b', '#9a9a9a', '#c4c4c4']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#6b6b6b', padding: 20 } } }
                }
            });
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-[var(--text-muted)] text-center py-8">Sin actividad reciente</p>';
                return;
            }
            container.innerHTML = '';
            activities.forEach(a => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-4 p-4 bg-[var(--bg-elevated)] rounded-xl';
                div.innerHTML = `
                    <span class="text-xl">${a.icon}</span>
                    <div>
                        <p class="text-[var(--text-primary)]">${escapeHTML(a.message)}</p>
                        <p class="text-[var(--text-muted)] text-sm">${escapeHTML(a.time)}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Customers
        async function loadCustomers(page) {
            page = page || 1;
            currentCustomerPage = page;

            if (isConnected) {
                try {
                    const result = await frappeAPI.getCustomers({ page: page, pageSize: 20 });
                    allCustomers = result.data || result.customers || [];
                    const localCustomers = getLocalCustomersArray();
                    const supabaseEmails = allCustomers.map(c => c.email);
                    const missingLocal = localCustomers.filter(c => !supabaseEmails.includes(c.email));
                    allCustomers = allCustomers.concat(missingLocal);
                    renderCustomersTable(allCustomers);
                    updatePagination('customers', result);
                } catch (e) {
                    console.error('Error loading customers:', e);
                    loadLocalCustomers();
                }
            } else {
                loadLocalCustomers();
            }
        }

        function getLocalCustomersArray() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            return Object.keys(users).map(email => ({
                id: email,
                name: email,
                full_name: users[email].name,
                email: email,
                plan_name: getCustomerPlanLabel(email),
                subscription: { status: 'Active' },
                creation: users[email].createdAt
            }));
        }

        function loadLocalCustomers() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            allCustomers = Object.keys(users).map(email => ({
                id: email,
                name: email,
                full_name: users[email].name,
                email: email,
                plan_name: getCustomerPlanLabel(email),
                subscription: { status: 'Active' },
                creation: users[email].createdAt
            }));
            renderCustomersTable(allCustomers);
            document.getElementById('customersTotal').textContent = String(allCustomers.length);
            document.getElementById('customersShowing').textContent = String(allCustomers.length);
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            selectedCustomers = [];
            updateSelectedCount();

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-16 text-center text-[var(--text-muted)]">No hay clientes</td></tr>';
                return;
            }

            customers.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';

                const localPlan = c.email ? getCustomerPlanLabel(c.email) : 'Free';
                const planName = localPlan !== 'Free' ? localPlan : (c.plan_name && c.plan_name !== 'Sin plan' ? c.plan_name : 'Free');

                // Generate avatar color based on name
                const colors = ['#e8f5ed', '#fef7e6', '#f3e8ff', '#e0f2fe', '#fce7f3'];
                const textColors = ['#2d7a4f', '#b5830a', '#7c3aed', '#0284c7', '#be185d'];
                const colorIndex = (c.full_name || c.email || '').charCodeAt(0) % colors.length;

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" class="checkbox customer-checkbox" onchange="toggleCustomerSelection('${c.email}')">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="avatar" style="background: ${colors[colorIndex]}; color: ${textColors[colorIndex]}">
                                ${(c.full_name || '?').charAt(0).toUpperCase()}
                            </div>
                            <span class="font-medium">${escapeHTML(c.full_name || '-')}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-[var(--text-secondary)] text-sm">${escapeHTML(c.email)}</td>
                    <td class="px-6 py-4">
                        <select class="select text-sm" onchange="quickChangePlan('${c.email}', this.value)">
                            <option value="free" ${planName === 'Free' ? 'selected' : ''}>Free</option>
                            <option value="trial" ${planName.startsWith('Trial') ? 'selected' : ''}>Trial</option>
                            <option value="pro" ${planName === 'Pro' ? 'selected' : ''}>Pro</option>
                        </select>
                    </td>
                    <td class="px-6 py-4">
                        <span class="badge badge-success">${c.subscription ? c.subscription.status : 'Active'}</span>
                    </td>
                    <td class="px-6 py-4 text-[var(--text-secondary)] text-sm">${formatDate(c.creation)}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick="openEditCustomerModal('${c.email}')" class="icon-btn bg-blue-50 text-blue-600 hover:bg-blue-100" title="Editar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </button>
                            <button onclick="viewCustomer('${c.id}', '${c.email}')" class="icon-btn bg-[var(--accent-soft)] text-[var(--text-secondary)] hover:bg-[var(--border)]" title="Ver">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            </button>
                            <button onclick="deleteCustomer('${c.id}', '${c.email}')" class="icon-btn bg-red-50 text-red-600 hover:bg-red-100" title="Eliminar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const planFilter = document.getElementById('customerPlanFilter').value;

            const filtered = allCustomers.filter(c => {
                const matchesSearch = (c.full_name || '').toLowerCase().includes(search) ||
                                     c.email.toLowerCase().includes(search);
                const matchesPlan = !planFilter || c.plan_name === planFilter;
                return matchesSearch && matchesPlan;
            });

            renderCustomersTable(filtered);
        }

        // Customer selection
        function toggleCustomerSelection(email) {
            const index = selectedCustomers.indexOf(email);
            if (index === -1) {
                selectedCustomers.push(email);
            } else {
                selectedCustomers.splice(index, 1);
            }
            updateSelectedCount();
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            const allChecked = selectedCustomers.length === allCustomers.length;

            if (allChecked) {
                selectedCustomers = [];
                checkboxes.forEach(cb => cb.checked = false);
            } else {
                selectedCustomers = allCustomers.map(c => c.email);
                checkboxes.forEach(cb => cb.checked = true);
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            if (selectedCustomers.length > 0) {
                countEl.textContent = selectedCustomers.length + ' seleccionados';
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }

        // Bulk actions
        async function bulkActivatePro() {
            if (selectedCustomers.length === 0) {
                showToast('Selecciona clientes primero', '⚠️');
                return;
            }
            if (!confirm(`¿Activar Pro para ${selectedCustomers.length} clientes?`)) return;

            for (const email of selectedCustomers) {
                await activateCustomerPro(email);
            }
            showToast(`Pro activado para ${selectedCustomers.length} clientes`, '✓');
            loadCustomers();
        }

        async function bulkExtendTrial() {
            if (selectedCustomers.length === 0) {
                showToast('Selecciona clientes primero', '⚠️');
                return;
            }

            for (const email of selectedCustomers) {
                await extendCustomerTrial(email, 7);
            }
            showToast(`Trial extendido para ${selectedCustomers.length} clientes`, '✓');
            loadCustomers();
        }

        async function bulkDeactivate() {
            if (selectedCustomers.length === 0) {
                showToast('Selecciona clientes primero', '⚠️');
                return;
            }
            if (!confirm(`¿Desactivar Pro para ${selectedCustomers.length} clientes?`)) return;

            for (const email of selectedCustomers) {
                await deactivateCustomerPro(email);
            }
            showToast(`Pro desactivado para ${selectedCustomers.length} clientes`, '✓');
            loadCustomers();
        }

        async function quickChangePlan(email, newPlan) {
            if (newPlan === 'pro') {
                await activateCustomerPro(email);
                showToast('Plan Pro activado', '✓');
            } else if (newPlan === 'trial') {
                await extendCustomerTrial(email, 7);
                showToast('Trial de 7 días activado', '✓');
            } else {
                await deactivateCustomerPro(email);
                showToast('Plan cambiado a Free', '✓');
            }
        }

        // Customer modal functions
        function openCreateCustomerModal() {
            document.getElementById('editCustomerId').value = '';
            document.getElementById('createCustomerModalTitle').textContent = 'Nuevo cliente';
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerEmail').value = '';
            document.getElementById('newCustomerPassword').value = '';
            document.getElementById('newCustomerPlan').value = 'free';
            document.getElementById('createCustomerModal').classList.remove('hidden');
        }

        function openEditCustomerModal(email) {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const user = users[email];

            if (!user) {
                showToast('Cliente no encontrado', '⚠️');
                return;
            }

            document.getElementById('editCustomerId').value = email;
            document.getElementById('createCustomerModalTitle').textContent = 'Editar cliente';
            document.getElementById('newCustomerName').value = user.name || '';
            document.getElementById('newCustomerEmail').value = email;
            document.getElementById('newCustomerPassword').value = '';

            const plan = getCustomerPlanLabel(email);
            document.getElementById('newCustomerPlan').value = plan === 'Pro' ? 'pro' : plan.startsWith('Trial') ? 'trial' : 'free';

            document.getElementById('createCustomerModal').classList.remove('hidden');
        }

        async function saveCustomer() {
            const editId = document.getElementById('editCustomerId').value;
            const name = document.getElementById('newCustomerName').value.trim();
            const email = document.getElementById('newCustomerEmail').value.trim();
            const password = document.getElementById('newCustomerPassword').value;
            const plan = document.getElementById('newCustomerPlan').value;

            if (!name || !email) {
                showToast('Completa nombre y email', '⚠️');
                return;
            }

            if (!editId && password.length < 6) {
                showToast('Contraseña mínimo 6 caracteres', '⚠️');
                return;
            }

            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');

            if (editId) {
                users[editId].name = name;
                if (password) users[editId].password = password;
            } else {
                if (users[email]) {
                    showToast('El email ya existe', '⚠️');
                    return;
                }
                users[email] = {
                    name: name,
                    password: password,
                    createdAt: new Date().toISOString()
                };
            }

            localStorage.setItem('gestion-users', JSON.stringify(users));

            if (plan === 'pro') {
                await activateCustomerPro(email);
            } else if (plan === 'trial') {
                await extendCustomerTrial(email, 7);
            }

            closeModal('createCustomerModal');
            showToast(editId ? 'Cliente actualizado' : 'Cliente creado', '✓');
            loadCustomers();
        }

        async function viewCustomer(customerId, email) {
            const modal = document.getElementById('customerModal');
            const content = document.getElementById('customerModalContent');
            content.innerHTML = '<p class="text-[var(--text-muted)] text-center py-8">Cargando...</p>';
            modal.classList.remove('hidden');

            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const localUser = users[email];

            if (isConnected) {
                try {
                    const data = await supabaseAPI.getCustomerDetails(email);
                    renderCustomerDetail(data);
                } catch (e) {
                    if (localUser) {
                        renderCustomerDetail({
                            customer: { full_name: localUser.name, email: email, created_at: localUser.createdAt },
                            subscriptions: [],
                            payments: []
                        });
                    } else {
                        content.innerHTML = '<p class="text-red-500 text-center py-8">Error al cargar datos</p>';
                    }
                }
            } else {
                if (localUser) {
                    renderCustomerDetail({
                        customer: { full_name: localUser.name, email: email, created_at: localUser.createdAt },
                        subscriptions: [],
                        payments: []
                    });
                } else {
                    content.innerHTML = '<p class="text-[var(--text-muted)] text-center py-8">Cliente no encontrado</p>';
                }
            }
        }

        async function deleteCustomer(customerId, customerEmail) {
            const customer = allCustomers.find(c => c.id === customerId || c.email === customerEmail);
            const displayName = customer ? (customer.full_name || customer.email) : customerEmail;

            if (!confirm(`¿Eliminar cliente "${displayName}"?`)) return;

            if (isConnected && customerId && customerId !== customerEmail) {
                try {
                    await supabaseAPI.deleteCustomer(customerId);
                    showToast('Cliente eliminado', '✓');
                    loadCustomers();
                } catch (e) {
                    showToast('Error al eliminar', '✗');
                }
            } else {
                const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
                if (users[customerEmail]) {
                    delete users[customerEmail];
                    localStorage.setItem('gestion-users', JSON.stringify(users));
                    showToast('Cliente eliminado', '✓');
                    loadCustomers();
                }
            }
        }

        function renderCustomerDetail(data) {
            const content = document.getElementById('customerModalContent');
            const customer = data.customer;
            const subscriptions = data.subscriptions || [];
            const subscription = subscriptions.find(s => s.status === 'Active') || subscriptions[0];
            const payments = data.payments || [];
            const localSub = getCustomerSubscription(customer.email);
            const planLabel = getCustomerPlanLabel(customer.email);

            const colors = ['#e8f5ed', '#fef7e6', '#f3e8ff', '#e0f2fe', '#fce7f3'];
            const textColors = ['#2d7a4f', '#b5830a', '#7c3aed', '#0284c7', '#be185d'];
            const colorIndex = (customer.full_name || customer.email || '').charCodeAt(0) % colors.length;

            content.innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center gap-4 p-5 bg-[var(--bg-elevated)] rounded-xl">
                        <div class="avatar w-16 h-16 text-2xl" style="background: ${colors[colorIndex]}; color: ${textColors[colorIndex]}">
                            ${(customer.full_name || '?').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-semibold text-xl">${escapeHTML(customer.full_name || '-')}</h4>
                            <p class="text-[var(--text-secondary)]">${escapeHTML(customer.email)}</p>
                            <p class="text-sm text-[var(--text-muted)]">Registrado: ${formatDate(customer.created_at)}</p>
                        </div>
                    </div>

                    <div class="p-5 bg-[var(--bg-elevated)] rounded-xl">
                        <h5 class="font-medium mb-4">Suscripción</h5>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                            <div>
                                <p class="text-[var(--text-muted)]">Plan</p>
                                <p class="font-medium">${planLabel}</p>
                            </div>
                            <div>
                                <p class="text-[var(--text-muted)]">Trial hasta</p>
                                <p>${localSub ? new Date(localSub.trialEndDate).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${localSub?.plan !== 'pro' ? `
                                <button onclick="activateCustomerProAndRefresh('${customer.email}')" class="btn-primary text-sm">Activar Pro</button>
                            ` : `
                                <button onclick="deactivateCustomerProAndRefresh('${customer.email}')" class="quick-action bg-red-50 text-red-700">Desactivar Pro</button>
                            `}
                        </div>
                    </div>

                    ${payments.length > 0 ? `
                        <div class="p-5 bg-[var(--bg-elevated)] rounded-xl">
                            <h5 class="font-medium mb-4">Últimos pagos</h5>
                            <div class="space-y-2">
                                ${payments.slice(0, 5).map(p => `
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-[var(--text-secondary)]">${formatDate(p.payment_date)}</span>
                                        <span class="font-medium">${formatCurrency(p.amount)}</span>
                                        <span class="${p.status === 'Completed' ? 'text-emerald-600' : 'text-amber-600'}">${p.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function activateCustomerProAndRefresh(email) {
            await activateCustomerPro(email);
            showToast('Pro activado', '✓');
            viewCustomer(email, email);
            loadCustomers();
        }

        async function deactivateCustomerProAndRefresh(email) {
            if (!confirm('¿Desactivar Pro?')) return;
            await deactivateCustomerPro(email);
            showToast('Pro desactivado', '✓');
            viewCustomer(email, email);
            loadCustomers();
        }

        // Subscription helpers
        function getUserKey(email) {
            return email.replace(/[^a-z0-9]/gi, '_');
        }

        function getCustomerSubscription(email) {
            const key = getUserKey(email) + '-subscription';
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : null;
        }

        function saveCustomerSubscription(email, sub) {
            const key = getUserKey(email) + '-subscription';
            localStorage.setItem(key, JSON.stringify(sub));
        }

        async function activateCustomerPro(email) {
            var sub = getCustomerSubscription(email) || createDefaultSubscription();
            sub.plan = 'pro';
            sub.proActivatedDate = new Date().toISOString();
            sub.trialUsed = true;
            saveCustomerSubscription(email, sub);
        }

        async function deactivateCustomerPro(email) {
            var sub = getCustomerSubscription(email) || createDefaultSubscription();
            sub.plan = 'free';
            sub.proActivatedDate = null;
            saveCustomerSubscription(email, sub);
        }

        async function extendCustomerTrial(email, days) {
            var sub = getCustomerSubscription(email) || createDefaultSubscription();
            var newEnd = new Date();
            newEnd.setDate(newEnd.getDate() + days);
            sub.trialEndDate = newEnd.toISOString();
            sub.trialUsed = false;
            saveCustomerSubscription(email, sub);
        }

        function createDefaultSubscription() {
            var now = new Date();
            var trialEnd = new Date(now);
            trialEnd.setDate(trialEnd.getDate() + 7);
            return {
                plan: 'free',
                trialStartDate: now.toISOString(),
                trialEndDate: trialEnd.toISOString(),
                trialUsed: false,
                proActivatedDate: null
            };
        }

        function getCustomerPlanLabel(email) {
            var sub = getCustomerSubscription(email);
            if (!sub) return 'Free';
            if (sub.plan === 'pro') return 'Pro';
            var now = new Date();
            var trialEnd = new Date(sub.trialEndDate);
            if (!sub.trialUsed && now <= trialEnd) {
                var diff = trialEnd - now;
                var days = Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
                return 'Trial (' + days + 'd)';
            }
            return 'Free';
        }

        // Subscriptions section
        async function loadSubscriptions(page) {
            page = page || 1;
            currentSubscriptionPage = page;
            const tbody = document.getElementById('subscriptionsTableBody');

            if (isConnected) {
                try {
                    const statusFilter = document.getElementById('subscriptionStatusFilter').value;
                    const filters = statusFilter ? { status: statusFilter } : null;
                    const result = await frappeAPI.getSubscriptions({ page: page, pageSize: 20, filters: filters });
                    allSubscriptions = result.subscriptions || [];
                    renderSubscriptionsTable(allSubscriptions);
                    updatePagination('subscriptions', result);
                } catch (e) {
                    renderSubscriptionsTable([]);
                }
            } else {
                renderSubscriptionsTable([]);
            }
        }

        function renderSubscriptionsTable(subscriptions) {
            const tbody = document.getElementById('subscriptionsTableBody');
            tbody.innerHTML = '';

            if (subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-16 text-center text-[var(--text-muted)]">No hay suscripciones (conectar backend)</td></tr>';
                return;
            }

            subscriptions.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                const statusClass = {
                    Active: 'badge-success',
                    Paused: 'badge-warning',
                    Cancelled: 'badge-danger',
                    Expired: 'badge-neutral'
                }[s.status] || 'badge-neutral';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-[var(--text-secondary)] text-sm">${escapeHTML(s.name)}</td>
                    <td class="px-6 py-4">
                        <div>
                            <p class="font-medium">${escapeHTML(s.customer_name || '-')}</p>
                            <p class="text-sm text-[var(--text-muted)]">${escapeHTML(s.customer_email || '-')}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4"><span class="badge badge-neutral">${escapeHTML(s.plan_name || s.plan)}</span></td>
                    <td class="px-6 py-4 text-[var(--text-secondary)]">${escapeHTML(s.billing_cycle)}</td>
                    <td class="px-6 py-4"><span class="badge ${statusClass}">${s.status}</span></td>
                    <td class="px-6 py-4 text-[var(--text-secondary)]">${formatDate(s.end_date)}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            ${s.status === 'Active' ? `
                                <button onclick="showExtendModal('${s.name}')" class="icon-btn bg-emerald-50 text-emerald-600 hover:bg-emerald-100" title="Extender">+</button>
                                <button onclick="showCancelModal('${s.name}')" class="icon-btn bg-red-50 text-red-600 hover:bg-red-100" title="Cancelar">×</button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterSubscriptions() {
            loadSubscriptions(1);
        }

        // Payments section
        async function loadPayments(page) {
            page = page || 1;
            currentPaymentPage = page;
            const tbody = document.getElementById('paymentsTableBody');

            if (isConnected) {
                try {
                    const dateFrom = document.getElementById('paymentDateFrom').value;
                    const dateTo = document.getElementById('paymentDateTo').value;
                    const filters = {};
                    if (dateFrom) filters.date_from = dateFrom;
                    if (dateTo) filters.date_to = dateTo;
                    const result = await frappeAPI.getPayments({ page: page, pageSize: 20, filters: filters });
                    allPayments = result.payments || [];
                    renderPaymentsTable(allPayments);
                    updatePagination('payments', result);
                } catch (e) {
                    renderPaymentsTable([]);
                }
            } else {
                renderPaymentsTable([]);
            }
        }

        function renderPaymentsTable(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-16 text-center text-[var(--text-muted)]">No hay pagos (conectar backend)</td></tr>';
                return;
            }

            payments.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                const statusClass = p.status === 'Completed' ? 'badge-success' : p.status === 'Pending' ? 'badge-warning' : 'badge-danger';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-[var(--text-secondary)] text-sm">${escapeHTML(p.name)}</td>
                    <td class="px-6 py-4 font-medium">${escapeHTML(p.customer_name || '-')}</td>
                    <td class="px-6 py-4 font-semibold text-lg">${formatCurrency(p.amount)}</td>
                    <td class="px-6 py-4 text-[var(--text-secondary)]">${formatDate(p.payment_date)}</td>
                    <td class="px-6 py-4 text-[var(--text-secondary)]">${escapeHTML(p.payment_method || '-')}</td>
                    <td class="px-6 py-4"><span class="badge ${statusClass}">${p.status}</span></td>
                    <td class="px-6 py-4 text-[var(--text-muted)] text-sm font-mono">${escapeHTML(p.transaction_id || '-')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterPayments() {
            loadPayments(1);
        }

        // Exports
        async function exportCustomers() {
            const rows = allCustomers.map(c =>
                `"${escapeCSV(c.full_name)}","${escapeCSV(c.email)}","${escapeCSV(c.plan_name)}","${formatDate(c.creation)}"`
            );
            downloadCSV('Nombre,Email,Plan,Registro\n' + rows.join('\n'), 'clientes');
            showToast('Exportado', '✓');
        }

        async function exportSubscriptions() {
            showToast('Exportando...', '⏳');
        }

        async function exportPayments() {
            showToast('Exportando...', '⏳');
        }

        function escapeCSV(str) {
            return str ? String(str).replace(/"/g, '""') : '';
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Reports
        function generateReport(type) {
            showToast('Generando reporte...', '⏳');
        }

        // Templates section
        function initTemplatesSection() {
            // Initialize templates UI
        }

        function selectGoalTab(goal) {
            document.querySelectorAll('.goal-tab').forEach(btn => {
                btn.classList.remove('bg-[var(--accent)]', 'text-white');
                btn.classList.add('bg-[var(--accent-soft)]', 'text-[var(--text-secondary)]');
            });
            const active = document.querySelector(`.goal-tab[data-goal="${goal}"]`);
            if (active) {
                active.classList.remove('bg-[var(--accent-soft)]', 'text-[var(--text-secondary)]');
                active.classList.add('bg-[var(--accent)]', 'text-white');
            }
        }

        function selectExerciseTab(type) {
            document.querySelectorAll('.exercise-tab').forEach(btn => {
                btn.classList.remove('bg-[var(--accent)]', 'text-white');
                btn.classList.add('bg-[var(--accent-soft)]', 'text-[var(--text-secondary)]');
            });
            const active = document.querySelector(`.exercise-tab[data-exercise="${type}"]`);
            if (active) {
                active.classList.remove('bg-[var(--accent-soft)]', 'text-[var(--text-secondary)]');
                active.classList.add('bg-[var(--accent)]', 'text-white');
            }
        }

        function selectExerciseGoal(goal) {
            document.querySelectorAll('.exercise-goal-tab').forEach(btn => {
                btn.classList.remove('bg-emerald-100', 'text-emerald-700');
                btn.classList.add('bg-[var(--accent-soft)]', 'text-[var(--text-secondary)]');
            });
            const active = document.querySelector(`.exercise-goal-tab[data-goal="${goal}"]`);
            if (active) {
                active.classList.remove('bg-[var(--accent-soft)]', 'text-[var(--text-secondary)]');
                active.classList.add('bg-emerald-100', 'text-emerald-700');
            }
        }

        function addHabitToGoal() {
            showToast('Función en desarrollo', '⚠️');
        }

        function addNewHabit() {
            showToast('Función en desarrollo', '⚠️');
        }

        function saveAllTemplates() {
            showToast('Plantillas guardadas', '✓');
        }

        // Settings
        function loadPlans() {
            const container = document.getElementById('plansContainer');
            container.innerHTML = `
                <div class="p-4 bg-[var(--bg-elevated)] rounded-xl flex items-center justify-between">
                    <div>
                        <p class="font-medium">Free</p>
                        <p class="text-sm text-[var(--text-muted)]">Funciones básicas</p>
                    </div>
                    <span class="text-lg font-semibold">$0</span>
                </div>
                <div class="p-4 bg-[var(--bg-elevated)] rounded-xl flex items-center justify-between">
                    <div>
                        <p class="font-medium">Pro</p>
                        <p class="text-sm text-[var(--text-muted)]">Todas las funciones</p>
                    </div>
                    <span class="text-lg font-semibold">$9.99/mes</span>
                </div>
            `;
        }

        function saveApiConfig() {
            const url = document.getElementById('apiUrlInput').value;
            const key = document.getElementById('apiKeyInput').value;
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            showToast('Configuración guardada', '✓');
            refreshData();
        }

        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (newPass !== confirm) {
                showToast('Las contraseñas no coinciden', '✗');
                return;
            }

            const admin = JSON.parse(localStorage.getItem('gestion-admin') || '{}');
            if (admin.password !== current) {
                showToast('Contraseña actual incorrecta', '✗');
                return;
            }

            admin.password = newPass;
            localStorage.setItem('gestion-admin', JSON.stringify(admin));
            showToast('Contraseña cambiada', '✓');

            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // Utilities
        function formatDate(date) {
            if (!date) return '-';
            return new Date(date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatCurrency(amount) {
            return '$' + (Number(amount) || 0).toFixed(2);
        }

        function updatePagination(section, result) {
            const total = result.total || result.count || 0;
            const pageSize = result.pageSize || 20;
            const page = result.page || 1;
            const showing = Math.min(pageSize, total - (page - 1) * pageSize);

            document.getElementById(section + 'Total').textContent = String(total);
            document.getElementById(section + 'Showing').textContent = String(showing);
            document.getElementById(section + 'PrevBtn').disabled = page <= 1;
            document.getElementById(section + 'NextBtn').disabled = page * pageSize >= total;
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function logout() {
            if (!confirm('¿Cerrar sesión?')) return;
            localStorage.removeItem('gestion-admin-session');
            window.location.href = 'admin-login.html';
        }

        function showToast(message, icon) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastIcon').textContent = icon || '✓';
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        // Init
        refreshData();
    </script>
</body>
</html>
