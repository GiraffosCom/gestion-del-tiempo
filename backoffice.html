<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice - Gestion del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a, #4338ca); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(59, 130, 246, 0.1); }
        .sidebar-item.active { background: rgba(59, 130, 246, 0.2); border-left: 3px solid #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-slate-900">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-slate-800 border-r border-slate-700 z-40 transform -translate-x-full md:translate-x-0 transition-transform">
        <div class="p-6 border-b border-slate-700">
            <div class="flex items-center gap-3">
                <span class="text-3xl">üîê</span>
                <div>
                    <h1 class="text-xl font-bold text-white">Backoffice</h1>
                    <p class="text-sm text-slate-400">Gestion del Tiempo</p>
                </div>
            </div>
        </div>

        <nav class="p-4 space-y-2">
            <button onclick="showSection('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="dashboard">
                <span>üìä</span> Dashboard
            </button>
            <button onclick="showSection('customers')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="customers">
                <span>üë•</span> Clientes
            </button>
            <button onclick="showSection('subscriptions')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="subscriptions">
                <span>üí≥</span> Suscripciones
            </button>
            <button onclick="showSection('payments')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="payments">
                <span>üí∞</span> Pagos
            </button>
            <button onclick="showSection('reports')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="reports">
                <span>üìà</span> Reportes
            </button>
            <button onclick="showSection('templates')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="templates">
                <span>üéØ</span> Plantillas
            </button>
            <button onclick="showSection('settings')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="settings">
                <span>‚öôÔ∏è</span> Configuracion
            </button>
        </nav>

        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-700">
            <button onclick="logout()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm flex items-center justify-center gap-2">
                <span>üö™</span> Cerrar Sesion
            </button>
        </div>
    </aside>

    <!-- Mobile menu toggle -->
    <button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-slate-800 rounded-lg text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        <!-- Top Bar -->
        <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-30">
            <div class="px-6 py-4 flex items-center justify-between">
                <h2 id="pageTitle" class="text-xl font-bold text-white">Dashboard</h2>
                <div class="flex items-center gap-4">
                    <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 rounded-full text-sm">
                        <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                        <span class="text-slate-400">Conectando...</span>
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm flex items-center gap-2">
                        <span>üîÑ</span> Actualizar
                    </button>
                </div>
            </div>
        </header>

        <div class="p-6">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-200 text-sm">MRR</p>
                                <p id="statMRR" class="text-3xl font-bold mt-1">$0</p>
                            </div>
                            <span class="text-5xl opacity-80">üíµ</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-200 text-sm">Clientes Activos</p>
                                <p id="statActiveCustomers" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <span class="text-5xl opacity-80">üë•</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-200 text-sm">Nuevos este mes</p>
                                <p id="statNewCustomers" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <span class="text-5xl opacity-80">üÜï</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-amber-200 text-sm">Churn Rate</p>
                                <p id="statChurnRate" class="text-3xl font-bold mt-1">0%</p>
                            </div>
                            <span class="text-5xl opacity-80">üìâ</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
                        <h3 class="text-lg font-bold text-white mb-4">üìà Ingresos Mensuales</h3>
                        <canvas id="revenueChart" height="200"></canvas>
                    </div>
                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
                        <h3 class="text-lg font-bold text-white mb-4">ü•ß Clientes por Plan</h3>
                        <canvas id="planDistributionChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <h3 class="text-lg font-bold text-white">üïê Actividad Reciente</h3>
                    </div>
                    <div id="recentActivity" class="p-6 space-y-4">
                        <p class="text-slate-400 text-center">Cargando actividad...</p>
                    </div>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="section-customers" class="section hidden">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-bold text-white">üë• Clientes</h3>
                            <div class="flex flex-wrap gap-3">
                                <input type="text" id="customerSearch" onkeyup="filterCustomers()" placeholder="üîç Buscar..."
                                    class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                                <select id="customerPlanFilter" onchange="filterCustomers()" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Todos los planes</option>
                                    <option value="Free">Free</option>
                                    <option value="Pro">Pro</option>
                                    <option value="Teams">Teams</option>
                                </select>
                                <button onclick="exportCustomers()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Email</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Plan</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Registro</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">Cargando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="customersPagination" class="p-4 border-t border-slate-700 flex items-center justify-between">
                        <p class="text-slate-400 text-sm">Mostrando <span id="customersShowing">0</span> de <span id="customersTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadCustomers(currentCustomerPage - 1)" id="customersPrevBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50" disabled>Anterior</button>
                            <button onclick="loadCustomers(currentCustomerPage + 1)" id="customersNextBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section id="section-subscriptions" class="section hidden">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-bold text-white">üí≥ Suscripciones</h3>
                            <div class="flex flex-wrap gap-3">
                                <select id="subscriptionStatusFilter" onchange="filterSubscriptions()" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Todos los estados</option>
                                    <option value="Active">Activas</option>
                                    <option value="Paused">Pausadas</option>
                                    <option value="Cancelled">Canceladas</option>
                                    <option value="Expired">Expiradas</option>
                                </select>
                                <button onclick="exportSubscriptions()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Plan</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Ciclo</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Vence</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-slate-400">Cargando suscripciones...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="subscriptionsPagination" class="p-4 border-t border-slate-700 flex items-center justify-between">
                        <p class="text-slate-400 text-sm">Mostrando <span id="subscriptionsShowing">0</span> de <span id="subscriptionsTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadSubscriptions(currentSubscriptionPage - 1)" id="subscriptionsPrevBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50" disabled>Anterior</button>
                            <button onclick="loadSubscriptions(currentSubscriptionPage + 1)" id="subscriptionsNextBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section id="section-payments" class="section hidden">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-bold text-white">üí∞ Pagos</h3>
                            <div class="flex flex-wrap gap-3">
                                <input type="date" id="paymentDateFrom" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <input type="date" id="paymentDateTo" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <button onclick="filterPayments()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    Filtrar
                                </button>
                                <button onclick="exportPayments()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Monto</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Fecha</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Metodo</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Transaccion</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-slate-400">Cargando pagos...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="paymentsPagination" class="p-4 border-t border-slate-700 flex items-center justify-between">
                        <p class="text-slate-400 text-sm">Mostrando <span id="paymentsShowing">0</span> de <span id="paymentsTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadPayments(currentPaymentPage - 1)" id="paymentsPrevBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50" disabled>Anterior</button>
                            <button onclick="loadPayments(currentPaymentPage + 1)" id="paymentsNextBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="section hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('customers')">
                        <div class="text-4xl mb-4">üë•</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Clientes</h3>
                        <p class="text-slate-400 text-sm">Lista completa de clientes con informacion de contacto y plan.</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('subscriptions')">
                        <div class="text-4xl mb-4">üí≥</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Suscripciones</h3>
                        <p class="text-slate-400 text-sm">Estado de todas las suscripciones, activas y canceladas.</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('payments')">
                        <div class="text-4xl mb-4">üí∞</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Pagos</h3>
                        <p class="text-slate-400 text-sm">Historial de pagos con montos, fechas y metodos.</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('revenue')">
                        <div class="text-4xl mb-4">üìà</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Ingresos</h3>
                        <p class="text-slate-400 text-sm">Ingresos mensuales con totales y tendencias.</p>
                    </div>
                </div>
            </section>

            <!-- Templates Section -->
            <section id="section-templates" class="section hidden">
                <div class="space-y-6">
                    <!-- Goal Templates -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-white">üéØ Plantillas por Objetivo</h3>
                                <p class="text-slate-400 text-sm mt-1">Define qu√© h√°bitos y metas se asignan seg√∫n el objetivo del usuario</p>
                            </div>
                            <button onclick="saveAllTemplates()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                <span>üíæ</span> Guardar Todo
                            </button>
                        </div>

                        <!-- Goal Type Tabs -->
                        <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-700 pb-4">
                            <button onclick="selectGoalTab('fitness')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white" data-goal="fitness">
                                üí™ Fitness
                            </button>
                            <button onclick="selectGoalTab('productivity')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-goal="productivity">
                                üìà Productividad
                            </button>
                            <button onclick="selectGoalTab('learning')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-goal="learning">
                                üìö Aprendizaje
                            </button>
                            <button onclick="selectGoalTab('business')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-goal="business">
                                üíº Negocio
                            </button>
                            <button onclick="selectGoalTab('competition')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-goal="competition">
                                üëë Competencia
                            </button>
                            <button onclick="selectGoalTab('wellness')" class="goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-goal="wellness">
                                üßò Bienestar
                            </button>
                        </div>

                        <!-- Goal Content -->
                        <div id="goalTemplateContent" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Habits for this goal -->
                            <div class="bg-slate-700/50 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-white">‚ú® H√°bitos Sugeridos</h4>
                                    <button onclick="addHabitToGoal()" class="text-blue-400 hover:text-blue-300 text-sm">+ Agregar</button>
                                </div>
                                <div id="goalHabitsList" class="space-y-2">
                                    <!-- Dynamic content -->
                                </div>
                            </div>

                            <!-- Weekly goals for this goal -->
                            <div class="bg-slate-700/50 rounded-xl p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-medium text-white">üìã Metas Semanales</h4>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-slate-400">Meta F√≠sica</label>
                                        <input type="text" id="goalMetaFisica" class="w-full px-3 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm mt-1" placeholder="Ej: Establecer rutina de ejercicio">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400">Meta Personal</label>
                                        <input type="text" id="goalMetaPersonal" class="w-full px-3 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm mt-1" placeholder="Ej: Mejorar autoestima">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400">Meta Digital</label>
                                        <input type="text" id="goalMetaDigital" class="w-full px-3 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm mt-1" placeholder="Ej: Documentar progreso">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400">Meta Espiritual</label>
                                        <input type="text" id="goalMetaEspiritual" class="w-full px-3 py-2 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm mt-1" placeholder="Ej: Practicar gratitud">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exercise Templates -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-white">üèãÔ∏è Rutinas de Ejercicio por Objetivo</h3>
                                <p class="text-slate-400 text-sm mt-1">Define rutinas personalizadas seg√∫n el objetivo y tipo de ejercicio del usuario</p>
                            </div>
                        </div>

                        <!-- Exercise Type Tabs -->
                        <div class="mb-4">
                            <label class="text-xs text-slate-400 mb-2 block">Tipo de Ejercicio</label>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="selectExerciseTab('gym')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-purple-600 text-white" data-exercise="gym">
                                    üèãÔ∏è Gimnasio
                                </button>
                                <button onclick="selectExerciseTab('cardio')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-exercise="cardio">
                                    üèÉ Cardio
                                </button>
                                <button onclick="selectExerciseTab('yoga')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-exercise="yoga">
                                    üßò Yoga
                                </button>
                                <button onclick="selectExerciseTab('dance')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-exercise="dance">
                                    üíÉ Baile
                                </button>
                                <button onclick="selectExerciseTab('sports')" class="exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600" data-exercise="sports">
                                    ‚öΩ Deportes
                                </button>
                            </div>
                        </div>

                        <!-- Goal/Objective Tabs -->
                        <div class="mb-6 border-b border-slate-700 pb-4">
                            <label class="text-xs text-slate-400 mb-2 block">Objetivo del Usuario</label>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="selectExerciseGoal('fitness')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-green-600 text-white" data-goal="fitness">
                                    üí™ Fitness
                                </button>
                                <button onclick="selectExerciseGoal('competition')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-600 text-slate-300 hover:bg-slate-500" data-goal="competition">
                                    üëë Competencia
                                </button>
                                <button onclick="selectExerciseGoal('wellness')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-600 text-slate-300 hover:bg-slate-500" data-goal="wellness">
                                    üßò Bienestar
                                </button>
                                <button onclick="selectExerciseGoal('weightloss')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-600 text-slate-300 hover:bg-slate-500" data-goal="weightloss">
                                    üî• Bajar de Peso
                                </button>
                                <button onclick="selectExerciseGoal('muscle')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-600 text-slate-300 hover:bg-slate-500" data-goal="muscle">
                                    üí™ Ganar M√∫sculo
                                </button>
                                <button onclick="selectExerciseGoal('beginner')" class="exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-600 text-slate-300 hover:bg-slate-500" data-goal="beginner">
                                    üå± Principiante
                                </button>
                            </div>
                        </div>

                        <!-- Current Selection Label -->
                        <div id="exerciseSelectionLabel" class="mb-4 p-3 bg-slate-700/50 rounded-lg">
                            <span class="text-sm text-slate-300">Editando: </span>
                            <span class="text-sm font-medium text-white">üèãÔ∏è Gimnasio + üí™ Fitness</span>
                        </div>

                        <!-- Weekly Routine Grid -->
                        <div id="exerciseTemplateContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Dynamic content -->
                        </div>
                    </div>

                    <!-- Habit Options -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-white">‚ú® Cat√°logo de H√°bitos</h3>
                                <p class="text-slate-400 text-sm mt-1">H√°bitos disponibles que los usuarios pueden seleccionar</p>
                            </div>
                            <button onclick="addNewHabit()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                + Nuevo H√°bito
                            </button>
                        </div>

                        <div id="habitCatalog" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section hidden">
                <div class="max-w-2xl space-y-6">
                    <!-- API Configuration -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-bold text-white mb-4">üîó Configuracion de Supabase</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">URL del Proyecto Supabase</label>
                                <input type="url" id="apiUrlInput" placeholder="https://xxxxx.supabase.co"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">API Key (anon public)</label>
                                <input type="password" id="apiKeyInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <button onclick="saveApiConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                Guardar y Conectar
                            </button>
                        </div>
                    </div>

                    <!-- Admin Password -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-bold text-white mb-4">üîë Cambiar Contrasena Admin</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Contrasena Actual</label>
                                <input type="password" id="currentPassword"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Nueva Contrasena</label>
                                <input type="password" id="newPassword"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Confirmar Nueva Contrasena</label>
                                <input type="password" id="confirmPassword"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <button onclick="changePassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                Cambiar Contrasena
                            </button>
                        </div>
                    </div>

                    <!-- Subscription Plans -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-bold text-white mb-4">üìã Planes de Suscripcion</h3>
                        <div id="plansContainer" class="space-y-4">
                            <p class="text-slate-400">Cargando planes...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden border border-slate-700">
            <div class="p-6 border-b border-slate-700 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white">üë§ Detalle del Cliente</h3>
                <button onclick="closeModal('customerModal')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="customerModalContent" class="p-6 overflow-y-auto max-h-[70vh]">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Subscription Action Modal -->
    <div id="subscriptionModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
            <div class="p-6 border-b border-slate-700">
                <h3 id="subscriptionModalTitle" class="text-xl font-bold text-white">Accion de Suscripcion</h3>
            </div>
            <div id="subscriptionModalContent" class="p-6">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 transform translate-y-full transition-transform duration-300 z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-xl flex items-center gap-3">
            <span id="toastIcon" class="text-2xl">‚úÖ</span>
            <span id="toastMessage" class="text-white">Mensaje</span>
        </div>
    </div>

    <script src="src/js/services/supabase-api.js"></script>
    <script>
        // Alias for compatibility with existing code
        const frappeAPI = supabaseAPI;
    </script>
    <script>
        // Check admin session
        if (!localStorage.getItem('gestion-admin-session')) {
            window.location.href = 'admin-login.html';
        }

        // Sanitize HTML helper - uses DOMPurify
        function sanitizeHTML(html) {
            return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
        }

        // Escape text for safe display
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // State
        let currentSection = 'dashboard';
        let currentCustomerPage = 1;
        let currentSubscriptionPage = 1;
        let currentPaymentPage = 1;
        let allCustomers = [];
        let allSubscriptions = [];
        let allPayments = [];
        let subscriptionPlans = [];
        let revenueChart = null;
        let planChart = null;
        let isConnected = false;

        // Initialize Supabase config
        document.getElementById('apiUrlInput').value = localStorage.getItem('supabase_url') || 'https://crpotifjwqoljvcvsdje.supabase.co';
        document.getElementById('apiKeyInput').value = localStorage.getItem('supabase_key') || '';

        // ==================== Navigation ====================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function showSection(section) {
            currentSection = section;

            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === section) {
                    item.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + section).classList.remove('hidden');

            // Update title
            const titles = {
                dashboard: 'Dashboard',
                customers: 'Clientes',
                subscriptions: 'Suscripciones',
                payments: 'Pagos',
                reports: 'Reportes',
                templates: 'Plantillas',
                settings: 'Configuracion'
            };
            document.getElementById('pageTitle').textContent = titles[section];

            // Load data for section
            if (section === 'customers') loadCustomers();
            if (section === 'subscriptions') loadSubscriptions();
            if (section === 'payments') loadPayments();
            if (section === 'templates') initTemplatesSection();
            if (section === 'settings') loadPlans();

            // Close mobile sidebar
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        // ==================== Connection & Data Loading ====================

        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const connected = await supabaseAPI.testConnection();
                if (connected) {
                    isConnected = true;
                    statusEl.innerHTML = sanitizeHTML('<span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-green-400">Supabase Conectado</span>');
                    return true;
                }
            } catch (e) {
                console.log('Supabase not available, using localStorage fallback');
            }
            isConnected = false;
            statusEl.innerHTML = sanitizeHTML('<span class="w-2 h-2 rounded-full bg-yellow-500"></span><span class="text-yellow-400">Modo Local</span>');
            return false;
        }

        async function refreshData() {
            await checkConnection();
            if (isConnected) {
                loadDashboard();
            } else {
                loadLocalData();
            }
        }

        async function loadDashboard() {
            if (isConnected) {
                try {
                    const stats = await frappeAPI.getDashboardStats();
                    updateDashboardUI(stats);
                } catch (e) {
                    console.error('Error loading dashboard:', e);
                    loadLocalData();
                }
            } else {
                loadLocalData();
            }
        }

        function loadLocalData() {
            // Load from localStorage as fallback
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const emails = Object.keys(users);

            document.getElementById('statMRR').textContent = '$0';
            document.getElementById('statActiveCustomers').textContent = String(emails.length);
            document.getElementById('statNewCustomers').textContent = String(countNewThisMonth(users));
            document.getElementById('statChurnRate').textContent = '0%';

            // Update charts with local data
            updateRevenueChart([
                { month: 'Ene', revenue: 0 },
                { month: 'Feb', revenue: 0 },
                { month: 'Mar', revenue: 0 },
                { month: 'Abr', revenue: 0 },
                { month: 'May', revenue: 0 },
                { month: 'Jun', revenue: 0 }
            ]);

            updatePlanChart([
                { plan_name: 'Free', customer_count: emails.length }
            ]);

            updateRecentActivity([]);
        }

        function countNewThisMonth(users) {
            const now = new Date();
            const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let count = 0;
            Object.values(users).forEach(function(user) {
                if (user.createdAt && new Date(user.createdAt) >= firstOfMonth) count++;
            });
            return count;
        }

        function updateDashboardUI(stats) {
            document.getElementById('statMRR').textContent = frappeAPI.formatCurrency(stats.mrr);
            document.getElementById('statActiveCustomers').textContent = String(stats.active_subscriptions);
            document.getElementById('statNewCustomers').textContent = String(stats.new_customers_month);
            document.getElementById('statChurnRate').textContent = stats.churn_rate + '%';

            updateRevenueChart(stats.revenue_trend);
            updatePlanChart(stats.customers_by_plan);
            updateRecentActivity([]);
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(function(d) { return d.month; }),
                    datasets: [{
                        label: 'Ingresos',
                        data: data.map(function(d) { return d.revenue; }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updatePlanChart(data) {
            const ctx = document.getElementById('planDistributionChart').getContext('2d');

            if (planChart) planChart.destroy();

            planChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(function(d) { return d.plan_name; }),
                    datasets: [{
                        data: data.map(function(d) { return d.customer_count; }),
                        backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            if (activities.length === 0) {
                container.textContent = 'No hay actividad reciente';
                container.className = 'p-6 text-slate-400 text-center';
                return;
            }
            // Clear and rebuild using DOM methods
            container.innerHTML = '';
            container.className = 'p-6 space-y-4';
            activities.forEach(function(a) {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-4 p-3 bg-slate-700/50 rounded-lg';

                const icon = document.createElement('span');
                icon.className = 'text-2xl';
                icon.textContent = a.icon;

                const info = document.createElement('div');
                const msg = document.createElement('p');
                msg.className = 'text-white';
                msg.textContent = a.message;
                const time = document.createElement('p');
                time.className = 'text-slate-500 text-sm';
                time.textContent = a.time;
                info.appendChild(msg);
                info.appendChild(time);

                div.appendChild(icon);
                div.appendChild(info);
                container.appendChild(div);
            });
        }

        // ==================== Customers ====================

        async function loadCustomers(page) {
            page = page || 1;
            currentCustomerPage = page;
            const tbody = document.getElementById('customersTableBody');

            if (isConnected) {
                try {
                    const result = await frappeAPI.getCustomers({ page: page, pageSize: 20 });
                    allCustomers = result.data || result.customers || [];

                    // Also include local customers that might not be in Supabase
                    const localCustomers = getLocalCustomersArray();
                    const supabaseEmails = allCustomers.map(function(c) { return c.email; });
                    const missingLocal = localCustomers.filter(function(c) {
                        return supabaseEmails.indexOf(c.email) === -1;
                    });
                    allCustomers = allCustomers.concat(missingLocal);

                    renderCustomersTable(allCustomers);
                    updatePagination('customers', result);
                } catch (e) {
                    console.error('Error loading customers:', e);
                    loadLocalCustomers();
                }
            } else {
                loadLocalCustomers();
            }
        }

        function getLocalCustomersArray() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            return Object.keys(users).map(function(email) {
                return {
                    id: email,
                    name: email,
                    full_name: users[email].name,
                    email: email,
                    plan_name: getCustomerPlanLabel(email),
                    subscription: { status: 'Active' },
                    creation: users[email].createdAt
                };
            });
        }

        function loadLocalCustomers() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            allCustomers = Object.keys(users).map(function(email) {
                return {
                    id: email,  // Use email as ID for localStorage
                    name: email,
                    full_name: users[email].name,
                    email: email,
                    plan_name: getCustomerPlanLabel(email),
                    subscription: { status: 'Active' },
                    creation: users[email].createdAt
                };
            });
            renderCustomersTable(allCustomers);
            document.getElementById('customersTotal').textContent = String(allCustomers.length);
            document.getElementById('customersShowing').textContent = String(allCustomers.length);
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';

            if (customers.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 6;
                td.className = 'px-6 py-12 text-center text-slate-400';
                td.textContent = 'No hay clientes';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            customers.forEach(function(c) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700/50 transition';

                // Client cell
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4';
                const div1 = document.createElement('div');
                div1.className = 'flex items-center gap-3';
                const avatar = document.createElement('div');
                avatar.className = 'w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold';
                avatar.textContent = (c.full_name || '?').charAt(0).toUpperCase();
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-white font-medium';
                nameSpan.textContent = c.full_name || '-';
                div1.appendChild(avatar);
                div1.appendChild(nameSpan);
                td1.appendChild(div1);

                // Email cell
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4 text-slate-300';
                td2.textContent = c.email;

                // Plan cell
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4';
                const planBadge = document.createElement('span');
                var localPlan = c.email ? getCustomerPlanLabel(c.email) : 'Free';
                var planName = localPlan !== 'Free' ? localPlan : (c.plan_name && c.plan_name !== 'Sin plan' ? c.plan_name : 'Free');
                var planStyle = planName === 'Pro' ? 'bg-amber-600/20 text-amber-400' :
                    planName.startsWith('Trial') ? 'bg-blue-600/20 text-blue-400' :
                    'bg-slate-600/20 text-slate-400';
                planBadge.className = 'px-3 py-1 rounded-full text-sm ' + planStyle;
                planBadge.textContent = planName;
                td3.appendChild(planBadge);

                // Status cell
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4';
                const status = c.subscription ? c.subscription.status : 'Active';
                const statusBadge = document.createElement('span');
                const statusStyles = {
                    Active: 'bg-green-600/20 text-green-400',
                    Paused: 'bg-yellow-600/20 text-yellow-400',
                    Cancelled: 'bg-red-600/20 text-red-400',
                    Expired: 'bg-slate-600/20 text-slate-400'
                };
                statusBadge.className = 'px-3 py-1 rounded-full text-sm ' + (statusStyles[status] || statusStyles.Active);
                statusBadge.textContent = status;
                td4.appendChild(statusBadge);

                // Date cell
                const td5 = document.createElement('td');
                td5.className = 'px-6 py-4 text-slate-300';
                td5.textContent = formatDate(c.creation);

                // Actions cell
                const td6 = document.createElement('td');
                td6.className = 'px-6 py-4';
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2';

                const viewBtn = document.createElement('button');
                viewBtn.className = 'p-2 bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/40 transition';
                viewBtn.title = 'Ver detalle';
                viewBtn.textContent = 'üëÅÔ∏è';
                viewBtn.onclick = function() { viewCustomer(c.id, c.email); };

                const manageBtn = document.createElement('button');
                manageBtn.className = 'p-2 bg-purple-600/20 text-purple-400 rounded-lg hover:bg-purple-600/40 transition';
                manageBtn.title = 'Gestionar suscripcion';
                manageBtn.textContent = 'üí≥';
                manageBtn.onclick = function() { editCustomerSubscription(c.id); };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition';
                deleteBtn.title = 'Eliminar cliente';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = function() { deleteCustomer(c.id, c.email); };

                actionsDiv.appendChild(viewBtn);
                actionsDiv.appendChild(manageBtn);
                actionsDiv.appendChild(deleteBtn);
                td6.appendChild(actionsDiv);

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tbody.appendChild(tr);
            });
        }

        function filterCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const planFilter = document.getElementById('customerPlanFilter').value;

            const filtered = allCustomers.filter(function(c) {
                const matchesSearch = (c.full_name || '').toLowerCase().indexOf(search) !== -1 ||
                                     c.email.toLowerCase().indexOf(search) !== -1;
                const matchesPlan = !planFilter || c.plan_name === planFilter;
                return matchesSearch && matchesPlan;
            });

            renderCustomersTable(filtered);
        }

        async function viewCustomer(customerId, email) {
            const modal = document.getElementById('customerModal');
            const content = document.getElementById('customerModalContent');

            content.textContent = 'Cargando...';
            content.className = 'p-6 text-slate-400 text-center';
            modal.classList.remove('hidden');

            // Try to load from localStorage first (for local customers)
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const localUser = users[email];

            if (isConnected) {
                try {
                    const data = await supabaseAPI.getCustomerDetails(email);
                    renderCustomerDetail(data);
                } catch (e) {
                    // Fallback to localStorage if not found in Supabase
                    if (localUser) {
                        renderCustomerDetail({
                            customer: { full_name: localUser.name, email: email, created_at: localUser.createdAt },
                            subscriptions: [],
                            payments: []
                        });
                    } else {
                        console.error('Error loading customer:', e);
                        content.textContent = 'Error al cargar datos: ' + e.message;
                        content.className = 'p-6 text-red-400 text-center';
                    }
                }
            } else {
                if (localUser) {
                    renderCustomerDetail({
                        customer: { full_name: localUser.name, email: email, created_at: localUser.createdAt },
                        subscriptions: [],
                        payments: []
                    });
                } else {
                    content.textContent = 'Cliente no encontrado';
                    content.className = 'p-6 text-red-400 text-center';
                }
            }
        }

        async function deleteCustomer(customerId, customerEmail) {
            // Get customer name for confirm dialog
            const customer = allCustomers.find(function(c) { return c.id === customerId || c.email === customerEmail; });
            const displayName = customer ? (customer.full_name || customer.email) : customerEmail;

            if (!confirm('¬øEliminar cliente "' + displayName + '"? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            if (isConnected && customerId && customerId !== customerEmail) {
                // Connected to Supabase and have a real UUID
                try {
                    await supabaseAPI.deleteCustomer(customerId);
                    showToast('Cliente eliminado', '‚úÖ');
                    loadCustomers();
                } catch (e) {
                    showToast('Error al eliminar: ' + e.message, '‚ùå');
                }
            } else {
                // Delete from localStorage using email
                const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
                if (users[customerEmail]) {
                    delete users[customerEmail];
                    localStorage.setItem('gestion-users', JSON.stringify(users));
                    showToast('Cliente eliminado', '‚úÖ');
                    loadCustomers();
                } else {
                    showToast('Cliente no encontrado', '‚ùå');
                }
            }
        }

        function renderCustomerDetail(data) {
            const content = document.getElementById('customerModalContent');
            content.innerHTML = '';
            content.className = 'p-6 overflow-y-auto max-h-[70vh]';

            const customer = data.customer;
            const subscriptions = data.subscriptions || [];
            const subscription = subscriptions.find(function(s) { return s.status === 'Active'; }) || subscriptions[0];
            const payments = data.payments || [];

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-6';

            // Header
            const header = document.createElement('div');
            header.className = 'flex items-center gap-4 p-4 bg-slate-700/50 rounded-xl';

            const avatar = document.createElement('div');
            avatar.className = 'w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-2xl font-bold';
            avatar.textContent = (customer.full_name || '?').charAt(0).toUpperCase();

            const info = document.createElement('div');
            const nameEl = document.createElement('h4');
            nameEl.className = 'text-xl font-bold text-white';
            nameEl.textContent = customer.full_name || '-';
            const emailEl = document.createElement('p');
            emailEl.className = 'text-slate-400';
            emailEl.textContent = customer.email;
            const dateEl = document.createElement('p');
            dateEl.className = 'text-slate-500 text-sm';
            dateEl.textContent = 'Registrado: ' + formatDate(customer.created_at);
            info.appendChild(nameEl);
            info.appendChild(emailEl);
            info.appendChild(dateEl);

            header.appendChild(avatar);
            header.appendChild(info);
            wrapper.appendChild(header);

            // Subscription info
            if (subscription) {
                const subSection = document.createElement('div');
                subSection.className = 'p-4 bg-slate-700/50 rounded-xl';

                const subTitle = document.createElement('h5');
                subTitle.className = 'font-bold text-white mb-3';
                subTitle.textContent = 'üí≥ Suscripcion';
                subSection.appendChild(subTitle);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-4 text-sm';

                const fields = [
                    { label: 'Plan', value: subscription.plan_name || 'N/A' },
                    { label: 'Estado', value: subscription.status },
                    { label: 'Ciclo', value: subscription.billing_cycle },
                    { label: 'Vence', value: formatDate(subscription.end_date) }
                ];

                fields.forEach(function(f) {
                    const cell = document.createElement('div');
                    const label = document.createElement('p');
                    label.className = 'text-slate-400';
                    label.textContent = f.label;
                    const val = document.createElement('p');
                    val.className = 'text-white';
                    val.textContent = f.value;
                    cell.appendChild(label);
                    cell.appendChild(val);
                    grid.appendChild(cell);
                });

                subSection.appendChild(grid);
                wrapper.appendChild(subSection);
            } else {
                var subSection2 = document.createElement('div');
                subSection2.className = 'p-4 bg-slate-700/50 rounded-xl';

                var subTitle2 = document.createElement('h5');
                subTitle2.className = 'font-bold text-white mb-3';
                subTitle2.textContent = 'Suscripcion';
                subSection2.appendChild(subTitle2);

                var localSub = getCustomerSubscription(customer.email);
                if (localSub) {
                    var planLabel = getCustomerPlanLabel(customer.email);
                    var grid2 = document.createElement('div');
                    grid2.className = 'grid grid-cols-2 gap-3 text-sm mb-3';

                    var fields2 = [
                        { label: 'Plan', value: planLabel },
                        { label: 'Trial hasta', value: new Date(localSub.trialEndDate).toLocaleDateString() },
                        { label: 'Pro desde', value: localSub.proActivatedDate ? new Date(localSub.proActivatedDate).toLocaleDateString() : 'N/A' }
                    ];

                    fields2.forEach(function(f) {
                        var cell = document.createElement('div');
                        var lbl = document.createElement('p');
                        lbl.className = 'text-slate-400';
                        lbl.textContent = f.label;
                        var val = document.createElement('p');
                        val.className = 'text-white';
                        val.textContent = f.value;
                        cell.appendChild(lbl);
                        cell.appendChild(val);
                        grid2.appendChild(cell);
                    });
                    subSection2.appendChild(grid2);

                    var btnInline = document.createElement('button');
                    if (localSub.plan !== 'pro') {
                        btnInline.className = 'px-3 py-1.5 bg-green-500/20 text-green-400 rounded-lg text-sm font-medium hover:bg-green-500/30 transition-all';
                        btnInline.textContent = 'Activar Pro';
                        btnInline.addEventListener('click', async function() {
                            await activateCustomerPro(customer.email);
                            showToast('Plan Pro activado', '‚úÖ');
                            await refreshCustomerList();
                            viewCustomer(customer.id, customer.email);
                        });
                    } else {
                        btnInline.className = 'px-3 py-1.5 bg-red-500/20 text-red-400 rounded-lg text-sm font-medium hover:bg-red-500/30 transition-all';
                        btnInline.textContent = 'Desactivar Pro';
                        btnInline.addEventListener('click', async function() {
                            if (!confirm('Desactivar Pro?')) return;
                            await deactivateCustomerPro(customer.email);
                            showToast('Plan cambiado a Free', '‚úÖ');
                            await refreshCustomerList();
                            viewCustomer(customer.id, customer.email);
                        });
                    }
                    subSection2.appendChild(btnInline);
                } else {
                    var noData2 = document.createElement('p');
                    noData2.className = 'text-slate-400 text-sm';
                    noData2.textContent = 'Sin datos de suscripcion';
                    subSection2.appendChild(noData2);
                }

                wrapper.appendChild(subSection2);
            }

            // Payments
            if (payments && payments.length > 0) {
                const paySection = document.createElement('div');
                paySection.className = 'p-4 bg-slate-700/50 rounded-xl';

                const payTitle = document.createElement('h5');
                payTitle.className = 'font-bold text-white mb-3';
                payTitle.textContent = 'üí∞ Ultimos Pagos';
                paySection.appendChild(payTitle);

                const payList = document.createElement('div');
                payList.className = 'space-y-2';

                payments.slice(0, 5).forEach(function(p) {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center text-sm';

                    const date = document.createElement('span');
                    date.className = 'text-slate-300';
                    date.textContent = formatDate(p.payment_date);

                    const amount = document.createElement('span');
                    amount.className = 'text-white font-medium';
                    amount.textContent = formatCurrency(p.amount);

                    const status = document.createElement('span');
                    status.className = p.status === 'Completed' ? 'text-green-400' : 'text-yellow-400';
                    status.textContent = p.status;

                    row.appendChild(date);
                    row.appendChild(amount);
                    row.appendChild(status);
                    payList.appendChild(row);
                });

                paySection.appendChild(payList);
                wrapper.appendChild(paySection);
            }

            content.appendChild(wrapper);
        }

        // ==================== SUBSCRIPTION HELPERS ====================
        function getUserKey(email) {
            return email.replace(/[^a-z0-9]/gi, '_');
        }

        function getCustomerSubscription(email) {
            const key = getUserKey(email) + '-subscription';
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : null;
        }

        function saveCustomerSubscription(email, sub) {
            const key = getUserKey(email) + '-subscription';
            localStorage.setItem(key, JSON.stringify(sub));
        }

        async function activateCustomerPro(email) {
            var sub = getCustomerSubscription(email) || createDefaultSubscription();
            sub.plan = 'pro';
            sub.proActivatedDate = new Date().toISOString();
            sub.trialUsed = true;
            saveCustomerSubscription(email, sub);

            if (isConnected) {
                try {
                    var customer = allCustomers.find(function(c) { return c.email === email; });
                    var proPlan = subscriptionPlans.find(function(p) { return p.plan_name === 'Pro'; });
                    if (customer && customer.id && proPlan) {
                        var existing = await supabaseAPI.checkSubscriptionStatus(email);
                        if (existing.has_subscription && existing.subscription) {
                            await supabaseAPI.upgradePlan(existing.subscription.id, proPlan.id);
                        } else {
                            await supabaseAPI.createSubscription(customer.id, proPlan.id, 'Monthly');
                        }
                    }
                } catch (e) {
                    console.error('Error syncing Pro to Supabase:', e);
                }
            }
        }

        async function deactivateCustomerPro(email) {
            var sub = getCustomerSubscription(email) || createDefaultSubscription();
            sub.plan = 'free';
            sub.proActivatedDate = null;
            saveCustomerSubscription(email, sub);

            if (isConnected) {
                try {
                    var existing = await supabaseAPI.checkSubscriptionStatus(email);
                    if (existing.has_subscription && existing.subscription) {
                        await supabaseAPI.cancelSubscription(existing.subscription.id, 'Desactivado desde backoffice');
                    }
                } catch (e) {
                    console.error('Error syncing deactivation to Supabase:', e);
                }
            }
        }

        async function extendCustomerTrial(email, days) {
            var sub = getCustomerSubscription(email) || createDefaultSubscription();
            var newEnd = new Date();
            newEnd.setDate(newEnd.getDate() + days);
            sub.trialEndDate = newEnd.toISOString();
            sub.trialUsed = false;
            saveCustomerSubscription(email, sub);

            if (isConnected) {
                try {
                    var existing = await supabaseAPI.checkSubscriptionStatus(email);
                    if (existing.has_subscription && existing.subscription) {
                        await supabaseAPI.extendSubscription(existing.subscription.id, days);
                    }
                } catch (e) {
                    console.error('Error syncing trial extension to Supabase:', e);
                }
            }
        }

        function createDefaultSubscription() {
            var now = new Date();
            var trialEnd = new Date(now);
            trialEnd.setDate(trialEnd.getDate() + 7);
            return {
                plan: 'free',
                trialStartDate: now.toISOString(),
                trialEndDate: trialEnd.toISOString(),
                trialUsed: false,
                proActivatedDate: null,
                monthlyExpenseCount: 0,
                monthlyExpenseResetMonth: now.toISOString().substring(0, 7),
                dailyVoiceCount: 0,
                dailyVoiceResetDate: now.toISOString().substring(0, 10)
            };
        }

        function getCustomerPlanLabel(email) {
            var sub = getCustomerSubscription(email);
            if (!sub) return 'Free';
            if (sub.plan === 'pro') return 'Pro';
            var now = new Date();
            var trialEnd = new Date(sub.trialEndDate);
            if (!sub.trialUsed && now <= trialEnd) {
                var diff = trialEnd - now;
                var days = Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
                return 'Trial (' + days + 'd)';
            }
            return 'Free';
        }

        function editCustomerSubscription(customerId) {
            var customer = allCustomers.find(function(c) { return c.id === customerId; });
            if (!customer) {
                showToast('Cliente no encontrado', '‚ö†Ô∏è');
                return;
            }
            var email = customer.email;
            var sub = getCustomerSubscription(email);

            var modal = document.getElementById('subscriptionModal');
            var titleEl = document.getElementById('subscriptionModalTitle');
            var content = document.getElementById('subscriptionModalContent');

            titleEl.textContent = 'Suscripcion - ' + (customer.full_name || email);
            content.textContent = '';

            // Info section
            var infoDiv = document.createElement('div');
            infoDiv.className = 'grid grid-cols-2 gap-3 text-sm mb-4';

            function addInfoCell(label, valueText, valueClass) {
                var cell = document.createElement('div');
                var lbl = document.createElement('p');
                lbl.className = 'text-slate-400';
                lbl.textContent = label;
                var val = document.createElement('p');
                val.className = valueClass || 'text-white';
                val.textContent = valueText;
                cell.appendChild(lbl);
                cell.appendChild(val);
                infoDiv.appendChild(cell);
            }

            if (sub) {
                var trialEnd = new Date(sub.trialEndDate);
                var now = new Date();
                var trialActive = !sub.trialUsed && now <= trialEnd;
                var daysLeft = Math.max(0, Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24)));

                var planText = sub.plan === 'pro' ? 'Pro' : trialActive ? 'Trial' : 'Free';
                addInfoCell('Plan', planText, sub.plan === 'pro' ? 'text-amber-400 font-bold' : trialActive ? 'text-blue-400 font-bold' : 'text-white');
                addInfoCell('Estado Trial', trialActive ? 'Activo (' + daysLeft + ' dias)' : sub.trialUsed ? 'Usado' : 'Expirado');
                addInfoCell('Activacion Pro', sub.proActivatedDate ? new Date(sub.proActivatedDate).toLocaleDateString() : 'N/A');
                addInfoCell('Trial hasta', trialEnd.toLocaleDateString());
            } else {
                var noData = document.createElement('p');
                noData.className = 'text-slate-400 text-sm mb-4';
                noData.textContent = 'Sin datos de suscripcion. Se creara al activar.';
                content.appendChild(noData);
            }
            content.appendChild(infoDiv);

            // Actions
            var actionsDiv = document.createElement('div');
            actionsDiv.className = 'space-y-3';

            if (!sub || sub.plan !== 'pro') {
                var btnPro = document.createElement('button');
                btnPro.className = 'w-full py-2 px-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:from-green-600 hover:to-emerald-700 transition-all';
                btnPro.textContent = 'Activar Pro';
                btnPro.addEventListener('click', function() { handleActivatePro(email); });
                actionsDiv.appendChild(btnPro);
            } else {
                var btnDeactivate = document.createElement('button');
                btnDeactivate.className = 'w-full py-2 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-medium hover:from-red-600 hover:to-red-700 transition-all';
                btnDeactivate.textContent = 'Desactivar Pro ‚Üí Free';
                btnDeactivate.addEventListener('click', function() { handleDeactivatePro(email); });
                actionsDiv.appendChild(btnDeactivate);
            }

            var trialRow = document.createElement('div');
            trialRow.className = 'flex gap-2';
            var trialInput = document.createElement('input');
            trialInput.type = 'number';
            trialInput.id = 'trialDaysInput';
            trialInput.value = '7';
            trialInput.min = '1';
            trialInput.max = '365';
            trialInput.className = 'flex-1 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-center';
            var btnTrial = document.createElement('button');
            btnTrial.className = 'px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-medium hover:from-blue-600 hover:to-blue-700 transition-all';
            btnTrial.textContent = 'Extender Trial';
            btnTrial.addEventListener('click', function() { handleExtendTrial(email); });
            trialRow.appendChild(trialInput);
            trialRow.appendChild(btnTrial);
            actionsDiv.appendChild(trialRow);

            var btnClose = document.createElement('button');
            btnClose.className = 'w-full py-2 px-4 bg-slate-600 text-white rounded-lg font-medium hover:bg-slate-500 transition-all';
            btnClose.textContent = 'Cerrar';
            btnClose.addEventListener('click', function() { closeModal('subscriptionModal'); });
            actionsDiv.appendChild(btnClose);

            content.appendChild(actionsDiv);
            modal.classList.remove('hidden');
        }

        async function handleActivatePro(email) {
            await activateCustomerPro(email);
            showToast('Plan Pro activado correctamente', '‚úÖ');
            await refreshCustomerList();
            editCustomerSubscription(email);
        }

        async function handleDeactivatePro(email) {
            if (!confirm('Desactivar Pro para ' + email + '? Volvera al plan Free.')) return;
            await deactivateCustomerPro(email);
            showToast('Plan cambiado a Free', '‚úÖ');
            await refreshCustomerList();
            editCustomerSubscription(email);
        }

        async function handleExtendTrial(email) {
            var input = document.getElementById('trialDaysInput');
            var days = parseInt(input.value) || 7;
            await extendCustomerTrial(email, days);
            showToast('Trial extendido ' + days + ' dias', '‚úÖ');
            await refreshCustomerList();
            editCustomerSubscription(email);
        }

        async function refreshCustomerList() {
            if (isConnected) {
                await loadCustomers();
            } else {
                loadLocalCustomers();
            }
        }

        async function exportCustomers() {
            if (isConnected) {
                try {
                    const data = await frappeAPI.exportReport('customers');
                    frappeAPI.downloadAsCSV(data, 'clientes');
                    showToast('Reporte exportado', '‚úÖ');
                } catch (e) {
                    showToast('Error al exportar', '‚ùå');
                }
            } else {
                const rows = allCustomers.map(function(c) {
                    return '"' + escapeCSV(c.full_name) + '","' + escapeCSV(c.email) + '","' + escapeCSV(c.plan_name) + '","' + formatDate(c.creation) + '"';
                });
                downloadCSV('Nombre,Email,Plan,Registro\n' + rows.join('\n'), 'clientes');
            }
        }

        function escapeCSV(str) {
            if (!str) return '';
            return String(str).replace(/"/g, '""');
        }

        // ==================== Subscriptions ====================

        async function loadSubscriptions(page) {
            page = page || 1;
            currentSubscriptionPage = page;

            if (isConnected) {
                try {
                    const statusFilter = document.getElementById('subscriptionStatusFilter').value;
                    const filters = statusFilter ? { status: statusFilter } : null;
                    const result = await frappeAPI.getSubscriptions({ page: page, pageSize: 20, filters: filters });
                    allSubscriptions = result.subscriptions;
                    renderSubscriptionsTable(allSubscriptions);
                    updatePagination('subscriptions', result);
                } catch (e) {
                    console.error('Error loading subscriptions:', e);
                    renderSubscriptionsTable([]);
                }
            } else {
                renderSubscriptionsTable([]);
            }
        }

        function renderSubscriptionsTable(subscriptions) {
            const tbody = document.getElementById('subscriptionsTableBody');
            tbody.innerHTML = '';

            if (subscriptions.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.className = 'px-6 py-12 text-center text-slate-400';
                td.textContent = 'No hay suscripciones (conectar backend)';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            subscriptions.forEach(function(s) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700/50 transition';

                // ID
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4 text-slate-300';
                td1.textContent = s.name;

                // Customer
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4';
                const custDiv = document.createElement('div');
                const custName = document.createElement('p');
                custName.className = 'text-white';
                custName.textContent = s.customer_name || '-';
                const custEmail = document.createElement('p');
                custEmail.className = 'text-slate-500 text-sm';
                custEmail.textContent = s.customer_email || '-';
                custDiv.appendChild(custName);
                custDiv.appendChild(custEmail);
                td2.appendChild(custDiv);

                // Plan
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4';
                const planBadge = document.createElement('span');
                planBadge.className = 'px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full text-sm';
                planBadge.textContent = s.plan_name || s.plan;
                td3.appendChild(planBadge);

                // Billing cycle
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4 text-slate-300';
                td4.textContent = s.billing_cycle;

                // Status
                const td5 = document.createElement('td');
                td5.className = 'px-6 py-4';
                const statusBadge = document.createElement('span');
                const statusStyles = {
                    Active: 'bg-green-600/20 text-green-400',
                    Paused: 'bg-yellow-600/20 text-yellow-400',
                    Cancelled: 'bg-red-600/20 text-red-400',
                    Expired: 'bg-slate-600/20 text-slate-400'
                };
                statusBadge.className = 'px-3 py-1 rounded-full text-sm ' + (statusStyles[s.status] || statusStyles.Active);
                statusBadge.textContent = s.status;
                td5.appendChild(statusBadge);

                // End date
                const td6 = document.createElement('td');
                td6.className = 'px-6 py-4 text-slate-300';
                td6.textContent = formatDate(s.end_date);

                // Actions
                const td7 = document.createElement('td');
                td7.className = 'px-6 py-4';
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2';

                if (s.status === 'Active') {
                    const extendBtn = document.createElement('button');
                    extendBtn.className = 'p-2 bg-green-600/20 text-green-400 rounded-lg hover:bg-green-600/40 transition';
                    extendBtn.title = 'Extender';
                    extendBtn.textContent = '‚ûï';
                    extendBtn.onclick = function() { showExtendModal(s.name); };
                    actionsDiv.appendChild(extendBtn);

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition';
                    cancelBtn.title = 'Cancelar';
                    cancelBtn.textContent = '‚ùå';
                    cancelBtn.onclick = function() { showCancelModal(s.name); };
                    actionsDiv.appendChild(cancelBtn);
                }

                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'p-2 bg-purple-600/20 text-purple-400 rounded-lg hover:bg-purple-600/40 transition';
                upgradeBtn.title = 'Cambiar plan';
                upgradeBtn.textContent = 'üîÑ';
                upgradeBtn.onclick = function() { showUpgradeModal(s.name, s.plan); };
                actionsDiv.appendChild(upgradeBtn);

                td7.appendChild(actionsDiv);

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tr.appendChild(td7);
                tbody.appendChild(tr);
            });
        }

        function filterSubscriptions() {
            loadSubscriptions(1);
        }

        function showExtendModal(subscriptionId) {
            const modal = document.getElementById('subscriptionModal');
            document.getElementById('subscriptionModalTitle').textContent = 'Extender Suscripcion';

            const content = document.getElementById('subscriptionModalContent');
            content.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';

            const inputDiv = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-slate-300 mb-2';
            label.textContent = 'Dias a extender';
            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'extendDays';
            input.value = '30';
            input.min = '1';
            input.max = '365';
            input.className = 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none';
            inputDiv.appendChild(label);
            inputDiv.appendChild(input);

            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.onclick = function() { closeModal('subscriptionModal'); };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition';
            confirmBtn.textContent = 'Extender';
            confirmBtn.onclick = function() { extendSubscription(subscriptionId); };

            btnDiv.appendChild(cancelBtn);
            btnDiv.appendChild(confirmBtn);

            wrapper.appendChild(inputDiv);
            wrapper.appendChild(btnDiv);
            content.appendChild(wrapper);

            modal.classList.remove('hidden');
        }

        async function extendSubscription(subscriptionId) {
            const days = document.getElementById('extendDays').value;
            try {
                await frappeAPI.extendSubscription(subscriptionId, days);
                closeModal('subscriptionModal');
                showToast('Suscripcion extendida ' + days + ' dias', '‚úÖ');
                loadSubscriptions(currentSubscriptionPage);
            } catch (e) {
                showToast('Error al extender', '‚ùå');
            }
        }

        function showCancelModal(subscriptionId) {
            const modal = document.getElementById('subscriptionModal');
            document.getElementById('subscriptionModalTitle').textContent = 'Cancelar Suscripcion';

            const content = document.getElementById('subscriptionModalContent');
            content.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';

            const msg = document.createElement('p');
            msg.className = 'text-slate-300';
            msg.textContent = '¬øEstas seguro de cancelar esta suscripcion?';

            const inputDiv = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-slate-300 mb-2';
            label.textContent = 'Razon (opcional)';
            const textarea = document.createElement('textarea');
            textarea.id = 'cancelReason';
            textarea.rows = 3;
            textarea.className = 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none';
            inputDiv.appendChild(label);
            inputDiv.appendChild(textarea);

            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3';

            const keepBtn = document.createElement('button');
            keepBtn.className = 'flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition';
            keepBtn.textContent = 'No, mantener';
            keepBtn.onclick = function() { closeModal('subscriptionModal'); };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition';
            confirmBtn.textContent = 'Si, cancelar';
            confirmBtn.onclick = function() { cancelSubscription(subscriptionId); };

            btnDiv.appendChild(keepBtn);
            btnDiv.appendChild(confirmBtn);

            wrapper.appendChild(msg);
            wrapper.appendChild(inputDiv);
            wrapper.appendChild(btnDiv);
            content.appendChild(wrapper);

            modal.classList.remove('hidden');
        }

        async function cancelSubscription(subscriptionId) {
            const reason = document.getElementById('cancelReason').value;
            try {
                await frappeAPI.cancelSubscription(subscriptionId, reason);
                closeModal('subscriptionModal');
                showToast('Suscripcion cancelada', '‚úÖ');
                loadSubscriptions(currentSubscriptionPage);
            } catch (e) {
                showToast('Error al cancelar', '‚ùå');
            }
        }

        function showUpgradeModal(subscriptionId, currentPlan) {
            const modal = document.getElementById('subscriptionModal');
            document.getElementById('subscriptionModalTitle').textContent = 'Cambiar Plan';

            const content = document.getElementById('subscriptionModalContent');
            content.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';

            const inputDiv = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-slate-300 mb-2';
            label.textContent = 'Nuevo plan';
            const select = document.createElement('select');
            select.id = 'newPlan';
            select.className = 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none';

            subscriptionPlans.forEach(function(p) {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.plan_name + ' - ' + formatCurrency(p.price_monthly) + '/mes';
                if (p.plan_name === currentPlan) opt.selected = true;
                select.appendChild(opt);
            });

            inputDiv.appendChild(label);
            inputDiv.appendChild(select);

            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.onclick = function() { closeModal('subscriptionModal'); };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition';
            confirmBtn.textContent = 'Cambiar';
            confirmBtn.onclick = function() { upgradePlan(subscriptionId); };

            btnDiv.appendChild(cancelBtn);
            btnDiv.appendChild(confirmBtn);

            wrapper.appendChild(inputDiv);
            wrapper.appendChild(btnDiv);
            content.appendChild(wrapper);

            modal.classList.remove('hidden');
        }

        async function upgradePlan(subscriptionId) {
            const newPlan = document.getElementById('newPlan').value;
            try {
                await frappeAPI.upgradePlan(subscriptionId, newPlan);
                closeModal('subscriptionModal');
                showToast('Plan actualizado', '‚úÖ');
                loadSubscriptions(currentSubscriptionPage);
            } catch (e) {
                showToast('Error al cambiar plan', '‚ùå');
            }
        }

        async function exportSubscriptions() {
            if (isConnected) {
                try {
                    const data = await frappeAPI.exportReport('subscriptions');
                    frappeAPI.downloadAsCSV(data, 'suscripciones');
                    showToast('Reporte exportado', '‚úÖ');
                } catch (e) {
                    showToast('Error al exportar', '‚ùå');
                }
            }
        }

        // ==================== Payments ====================

        async function loadPayments(page) {
            page = page || 1;
            currentPaymentPage = page;

            if (isConnected) {
                try {
                    const result = await frappeAPI.getPayments({ page: page, pageSize: 20 });
                    allPayments = result.payments;
                    renderPaymentsTable(allPayments);
                    updatePagination('payments', result);
                } catch (e) {
                    console.error('Error loading payments:', e);
                    renderPaymentsTable([]);
                }
            } else {
                renderPaymentsTable([]);
            }
        }

        function renderPaymentsTable(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            if (payments.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.className = 'px-6 py-12 text-center text-slate-400';
                td.textContent = 'No hay pagos registrados (conectar backend)';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            payments.forEach(function(p) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700/50 transition';

                // ID
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4 text-slate-300';
                td1.textContent = p.name;

                // Customer
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4';
                const custDiv = document.createElement('div');
                const custName = document.createElement('p');
                custName.className = 'text-white';
                custName.textContent = p.customer_name || '-';
                const custEmail = document.createElement('p');
                custEmail.className = 'text-slate-500 text-sm';
                custEmail.textContent = p.customer_email || '-';
                custDiv.appendChild(custName);
                custDiv.appendChild(custEmail);
                td2.appendChild(custDiv);

                // Amount
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4 text-white font-medium';
                td3.textContent = formatCurrency(p.amount);

                // Date
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4 text-slate-300';
                td4.textContent = formatDate(p.payment_date);

                // Method
                const td5 = document.createElement('td');
                td5.className = 'px-6 py-4 text-slate-300';
                td5.textContent = p.payment_method;

                // Status
                const td6 = document.createElement('td');
                td6.className = 'px-6 py-4';
                const statusBadge = document.createElement('span');
                const statusStyles = {
                    Completed: 'bg-green-600/20 text-green-400',
                    Pending: 'bg-yellow-600/20 text-yellow-400',
                    Failed: 'bg-red-600/20 text-red-400',
                    Refunded: 'bg-purple-600/20 text-purple-400'
                };
                statusBadge.className = 'px-3 py-1 rounded-full text-sm ' + (statusStyles[p.status] || statusStyles.Pending);
                statusBadge.textContent = p.status;
                td6.appendChild(statusBadge);

                // Transaction ID
                const td7 = document.createElement('td');
                td7.className = 'px-6 py-4 text-slate-400 text-sm';
                td7.textContent = p.transaction_id || '-';

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tr.appendChild(td7);
                tbody.appendChild(tr);
            });
        }

        function filterPayments() {
            loadPayments(1);
        }

        async function exportPayments() {
            if (isConnected) {
                try {
                    const dateFrom = document.getElementById('paymentDateFrom').value || null;
                    const dateTo = document.getElementById('paymentDateTo').value || null;
                    const data = await frappeAPI.exportReport('payments', dateFrom, dateTo);
                    frappeAPI.downloadAsCSV(data, 'pagos');
                    showToast('Reporte exportado', '‚úÖ');
                } catch (e) {
                    showToast('Error al exportar', '‚ùå');
                }
            }
        }

        // ==================== Reports ====================

        async function generateReport(type) {
            showToast('Generando reporte...', '‚è≥');
            try {
                const data = await frappeAPI.exportReport(type);
                frappeAPI.downloadAsCSV(data, 'reporte_' + type);
                showToast('Reporte descargado', '‚úÖ');
            } catch (e) {
                showToast('Error al generar reporte', '‚ùå');
            }
        }

        // ==================== Settings ====================

        async function loadPlans() {
            const container = document.getElementById('plansContainer');

            if (isConnected) {
                try {
                    subscriptionPlans = await frappeAPI.getSubscriptionPlans();
                    renderPlans(subscriptionPlans);
                } catch (e) {
                    container.textContent = 'Error al cargar planes';
                    container.className = 'text-red-400';
                }
            } else {
                // Default plans
                subscriptionPlans = [
                    { name: 'Free', plan_name: 'Free', price_monthly: 0, price_yearly: 0 },
                    { name: 'Pro', plan_name: 'Pro', price_monthly: 9900, price_yearly: 99000 },
                    { name: 'Teams', plan_name: 'Teams', price_monthly: 29900, price_yearly: 299000 }
                ];
                renderPlans(subscriptionPlans);
            }
        }

        function renderPlans(plans) {
            const container = document.getElementById('plansContainer');
            container.innerHTML = '';
            container.className = 'space-y-4';

            plans.forEach(function(p) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-slate-700/50 rounded-lg';

                const info = document.createElement('div');
                const name = document.createElement('p');
                name.className = 'text-white font-medium';
                name.textContent = p.plan_name;
                const price = document.createElement('p');
                price.className = 'text-slate-400 text-sm';
                price.textContent = formatCurrency(p.price_monthly) + '/mes - ' + formatCurrency(p.price_yearly) + '/a√±o';
                info.appendChild(name);
                info.appendChild(price);

                const icon = document.createElement('span');
                icon.className = 'text-2xl';
                icon.textContent = p.price_monthly === 0 ? 'üÜì' : (p.plan_name === 'Pro' ? '‚≠ê' : 'üë•');

                div.appendChild(info);
                div.appendChild(icon);
                container.appendChild(div);
            });
        }

        function saveApiConfig() {
            const url = document.getElementById('apiUrlInput').value;
            const key = document.getElementById('apiKeyInput').value;
            if (url && key) {
                supabaseAPI.configure(url, key);
                showToast('Configuracion guardada', '‚úÖ');
                refreshData();
            } else {
                showToast('Completa URL y API Key', '‚ö†Ô∏è');
            }
        }

        // Legacy alias
        function saveApiUrl() { saveApiConfig(); }

        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            const admin = JSON.parse(localStorage.getItem('gestion-admin') || '{}');

            if (current !== admin.password) {
                showToast('Contrasena actual incorrecta', '‚ùå');
                return;
            }

            if (newPass.length < 6) {
                showToast('La contrasena debe tener al menos 6 caracteres', '‚ùå');
                return;
            }

            if (newPass !== confirm) {
                showToast('Las contrasenas no coinciden', '‚ùå');
                return;
            }

            admin.password = newPass;
            localStorage.setItem('gestion-admin', JSON.stringify(admin));
            showToast('Contrasena actualizada', '‚úÖ');

            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // ==================== Utilities ====================

        function updatePagination(type, result) {
            var page = result.page;
            var total = result.total;
            var page_size = result.page_size;
            var total_pages = result.total_pages;
            var showing = Math.min(page * page_size, total);

            document.getElementById(type + 'Total').textContent = String(total);
            document.getElementById(type + 'Showing').textContent = String(showing);
            document.getElementById(type + 'PrevBtn').disabled = page <= 1;
            document.getElementById(type + 'NextBtn').disabled = page >= total_pages;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Intl.DateTimeFormat('es-CL', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).format(new Date(dateStr));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function downloadCSV(content, filename) {
            var blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function showToast(message, icon) {
            icon = icon || '‚úÖ';
            var toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastIcon').textContent = icon;
            toast.classList.remove('translate-y-full');
            setTimeout(function() { toast.classList.add('translate-y-full'); }, 3000);
        }

        function logout() {
            localStorage.removeItem('gestion-admin-session');
            window.location.href = 'admin-login.html';
        }

        // ==================== Templates Management ====================

        let currentGoalType = 'fitness';
        let currentExerciseType = 'gym';
        let currentExerciseGoal = 'fitness';

        // Default templates data
        let templates = {
            goals: {
                fitness: {
                    habits: [
                        { icon: '‚òÄÔ∏è', name: 'Despertar temprano' },
                        { icon: 'üíß', name: 'Beber agua al despertar' },
                        { icon: 'üí™', name: 'Ejercicio completado' },
                        { icon: 'ü•ó', name: 'Alimentaci√≥n saludable' },
                        { icon: 'üí¶', name: 'Beber 2-3L de agua' },
                        { icon: 'üò¥', name: 'Dormir 7-8 horas' }
                    ],
                    metas: {
                        fisica: 'Establecer rutina de ejercicio',
                        personal: 'Mejorar autoestima y confianza',
                        digital: 'Documentar progreso en fotos',
                        espiritual: 'Practicar gratitud diaria'
                    }
                },
                productivity: {
                    habits: [
                        { icon: '‚òÄÔ∏è', name: 'Despertar 6:00 AM' },
                        { icon: 'üìù', name: 'Planificar el d√≠a' },
                        { icon: 'üéØ', name: 'Completar 3 tareas importantes' },
                        { icon: 'üìµ', name: 'Bloques sin distracciones' },
                        { icon: 'üìä', name: 'Revisar progreso diario' },
                        { icon: 'üò¥', name: 'Descanso adecuado' }
                    ],
                    metas: {
                        fisica: 'Rutina de energ√≠a matutina',
                        personal: 'Sistema de productividad personal',
                        digital: 'Herramientas de productividad',
                        espiritual: 'Prop√≥sito claro y enfocado'
                    }
                },
                learning: {
                    habits: [
                        { icon: 'üìñ', name: 'Leer 30 minutos' },
                        { icon: 'üìù', name: 'Tomar notas' },
                        { icon: 'üéØ', name: 'Pr√°ctica deliberada' },
                        { icon: 'üåç', name: 'Practicar idioma' },
                        { icon: 'üí°', name: 'Aplicar lo aprendido' },
                        { icon: 'üîÑ', name: 'Revisar material anterior' }
                    ],
                    metas: {
                        fisica: 'Establecer horario de estudio',
                        personal: 'Definir objetivos de aprendizaje',
                        digital: 'Organizar recursos digitales',
                        espiritual: 'Paciencia con el proceso'
                    }
                },
                business: {
                    habits: [
                        { icon: 'üìà', name: 'Revisar m√©tricas' },
                        { icon: 'ü§ù', name: 'Hacer networking' },
                        { icon: 'üí∞', name: 'Revisar finanzas' },
                        { icon: 'üì±', name: 'Crear contenido' },
                        { icon: 'üìû', name: 'Contactar clientes' },
                        { icon: 'üìö', name: 'Aprender sobre negocio' }
                    ],
                    metas: {
                        fisica: 'Energ√≠a para emprender',
                        personal: 'Definir modelo de negocio',
                        digital: 'Presencia online s√≥lida',
                        espiritual: 'Resiliencia ante obst√°culos'
                    }
                },
                competition: {
                    habits: [
                        { icon: 'üí™', name: 'Entrenamiento intenso' },
                        { icon: 'ü•ó', name: 'Dieta estricta' },
                        { icon: 'üì∏', name: 'Documentar progreso' },
                        { icon: 'üßò', name: 'Visualizaci√≥n' },
                        { icon: 'üò¥', name: 'Descanso √≥ptimo' },
                        { icon: 'üìã', name: 'Seguir plan al pie' }
                    ],
                    metas: {
                        fisica: 'Preparaci√≥n f√≠sica inicial',
                        personal: 'Mentalidad ganadora',
                        digital: 'Estudiar a la competencia',
                        espiritual: 'Visualizaci√≥n del √©xito'
                    }
                },
                wellness: {
                    habits: [
                        { icon: 'üßò', name: 'Meditaci√≥n 15 min' },
                        { icon: 'üôè', name: 'Escribir gratitudes' },
                        { icon: 'üö∂', name: 'Caminata consciente' },
                        { icon: 'üìµ', name: 'Detox digital' },
                        { icon: 'üõÅ', name: 'Autocuidado' },
                        { icon: 'üò¥', name: 'Sue√±o reparador' }
                    ],
                    metas: {
                        fisica: 'Movimiento diario suave',
                        personal: 'Autoconocimiento profundo',
                        digital: 'Detox digital semanal',
                        espiritual: 'Paz mental y equilibrio'
                    }
                }
            },
            exercises: {
                gym: {
                    fitness: {
                        0: { name: 'Descanso Activo', icon: 'üßò', exercises: ['Estiramientos 20min', 'Caminata ligera 30min', 'Foam roller 15min'] },
                        1: { name: 'Tren Inferior', icon: 'ü¶µ', exercises: ['Sentadillas 4x12', 'Peso muerto 4x10', 'Prensa 4x12', 'Zancadas 3x12'] },
                        2: { name: 'Tren Superior', icon: 'üí™', exercises: ['Press banca 4x10', 'Remo 4x12', 'Press hombro 3x12', 'Curl b√≠ceps 3x15'] },
                        3: { name: 'Full Body', icon: 'üî•', exercises: ['Sentadilla 3x12', 'Press pecho 3x12', 'Peso muerto 3x10', 'Plancha 3x30seg'] },
                        4: { name: 'Piernas + Core', icon: 'üçë', exercises: ['Hip thrust 4x12', 'Sentadilla b√∫lgara 3x10', 'Curl femoral 3x12', 'Crunches 3x20'] },
                        5: { name: 'Cardio + Fuerza', icon: '‚ù§Ô∏è', exercises: ['HIIT 20min', 'Circuito funcional 3 rondas', 'Abs 15min'] },
                        6: { name: 'Flexibilidad', icon: 'üßò', exercises: ['Yoga 45min', 'Estiramientos profundos 20min'] }
                    },
                    competition: {
                        0: { name: 'Descanso Estrat√©gico', icon: 'üò¥', exercises: ['Recuperaci√≥n activa 30min', 'Foam roller 20min', 'Hidrataci√≥n'] },
                        1: { name: 'Fuerza M√°xima', icon: 'üèãÔ∏è', exercises: ['Sentadilla 5x5 (85%)', 'Peso muerto 5x5 (85%)', 'Press banca 5x5 (85%)'] },
                        2: { name: 'Hipertrofia', icon: 'üí™', exercises: ['Press inclinado 4x10', 'Remo 4x10', 'Elevaciones laterales 4x12', 'Curl 4x12'] },
                        3: { name: 'Potencia', icon: '‚ö°', exercises: ['Clean & Jerk 5x3', 'Snatch 5x3', 'Box jumps 4x8', 'Med ball throws 4x10'] },
                        4: { name: 'Piernas Intenso', icon: 'üî•', exercises: ['Front squat 4x8', 'Romanian DL 4x10', 'Leg press 4x12', 'Walking lunges 3x20'] },
                        5: { name: 'Peak Week', icon: 'üëë', exercises: ['Deload - 50% volumen', 'T√©cnica y activaci√≥n', 'Visualizaci√≥n 15min'] },
                        6: { name: 'Movilidad', icon: 'üßò', exercises: ['Yoga restaurativo 40min', 'Estiramientos din√°micos 20min', 'Meditaci√≥n 15min'] }
                    },
                    wellness: {
                        0: { name: 'Descanso Total', icon: 'üò¥', exercises: ['Caminata suave 20min', 'Estiramientos suaves 15min'] },
                        1: { name: 'Movilidad', icon: 'üßò', exercises: ['Yoga suave 30min', 'Estiramientos 15min', 'Respiraci√≥n 10min'] },
                        2: { name: 'Fuerza Funcional', icon: 'üí™', exercises: ['Sentadillas 3x10', 'Plancha 3x20seg', 'Remo ligero 3x12'] },
                        3: { name: 'Cardio Suave', icon: 'üö∂', exercises: ['Caminata 30min', 'Estiramientos 15min'] },
                        4: { name: 'Core + Balance', icon: '‚öñÔ∏è', exercises: ['Pilates 30min', 'Equilibrio 15min', 'Respiraci√≥n 10min'] },
                        5: { name: 'Circuito Ligero', icon: 'üå∏', exercises: ['Circuito full body 20min', 'Yoga 20min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üåô', exercises: ['Yoga restaurativo 30min', 'Meditaci√≥n 20min'] }
                    },
                    weightloss: {
                        0: { name: 'Descanso Activo', icon: 'üö∂', exercises: ['Caminata 45min', 'Estiramientos 15min'] },
                        1: { name: 'HIIT + Fuerza', icon: 'üî•', exercises: ['HIIT 25min', 'Sentadillas 3x15', 'Plancha 3x30seg'] },
                        2: { name: 'Cardio Largo', icon: 'üèÉ', exercises: ['Cardio moderado 45min', 'Abs 15min'] },
                        3: { name: 'Full Body Circuit', icon: '‚ö°', exercises: ['Circuito 4 rondas: 10 burpees, 15 sentadillas, 20 mountain climbers'] },
                        4: { name: 'HIIT Intenso', icon: 'üí¶', exercises: ['Tabata 20min', 'Core 15min', 'Estiramientos 10min'] },
                        5: { name: 'Fuerza + Cardio', icon: 'üí™', exercises: ['Pesas 30min', 'Cardio 20min', 'Abs 10min'] },
                        6: { name: 'Cardio Largo', icon: 'üö¥', exercises: ['Bicicleta/Caminata 60min'] }
                    },
                    muscle: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Estiramientos 20min', 'Foam roller 15min', 'Caminar 20min'] },
                        1: { name: 'Pecho + Tr√≠ceps', icon: 'üí™', exercises: ['Press banca 4x8', 'Press inclinado 4x10', 'Fondos 3x12', 'Extensi√≥n tr√≠ceps 3x15'] },
                        2: { name: 'Espalda + B√≠ceps', icon: 'ü¶æ', exercises: ['Dominadas 4x8', 'Remo 4x10', 'Jal√≥n 3x12', 'Curl b√≠ceps 3x12'] },
                        3: { name: 'Piernas', icon: 'ü¶µ', exercises: ['Sentadilla 4x8', 'Prensa 4x12', 'Extensi√≥n 3x15', 'Curl femoral 3x15'] },
                        4: { name: 'Hombros + Core', icon: 'üéØ', exercises: ['Press militar 4x10', 'Elevaciones 4x12', 'Face pulls 3x15', 'Plancha 3x45seg'] },
                        5: { name: 'Full Body', icon: 'üî•', exercises: ['Peso muerto 4x6', 'Press 4x8', 'Sentadilla 4x8', 'Remo 4x10'] },
                        6: { name: 'Brazos + Core', icon: 'üí™', exercises: ['Superseries b√≠ceps/tr√≠ceps 4x12', 'Core circuit 20min'] }
                    },
                    beginner: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Caminata suave 20min', 'Estiramientos b√°sicos 15min'] },
                        1: { name: 'Introducci√≥n', icon: 'üå±', exercises: ['Sentadillas sin peso 3x10', 'Flexiones de rodillas 3x8', 'Plancha 3x15seg'] },
                        2: { name: 'Cardio B√°sico', icon: 'üö∂', exercises: ['Caminata 30min', 'Estiramientos 15min'] },
                        3: { name: 'Full Body Ligero', icon: '‚ú®', exercises: ['Circuito b√°sico 2 rondas', 'Estiramientos 15min'] },
                        4: { name: 'Movilidad', icon: 'üßò', exercises: ['Yoga para principiantes 30min'] },
                        5: { name: 'Progresi√≥n', icon: 'üìà', exercises: ['Sentadillas 3x12', 'Flexiones 3x10', 'Remo con banda 3x12'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üå∏', exercises: ['Estiramientos completos 30min', 'Caminata 20min'] }
                    }
                },
                cardio: {
                    fitness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Caminata suave 20min'] },
                        1: { name: 'Cardio Moderado', icon: 'üèÉ', exercises: ['Correr 30min zona 2'] },
                        2: { name: 'HIIT', icon: 'üî•', exercises: ['HIIT 25min'] },
                        3: { name: 'Cardio Largo', icon: 'üö¥', exercises: ['Bicicleta 45min'] },
                        4: { name: 'Intervalos', icon: '‚ö°', exercises: ['Intervalos 30min'] },
                        5: { name: 'Cardio + Core', icon: 'üí™', exercises: ['Cardio 25min', 'Abs 15min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Yoga 30min'] }
                    },
                    competition: {
                        0: { name: 'Recuperaci√≥n', icon: 'üò¥', exercises: ['Cardio zona 1 - 20min', 'Estiramientos'] },
                        1: { name: 'Tempo Run', icon: 'üèÉ', exercises: ['Tempo run 40min zona 3-4'] },
                        2: { name: 'Intervalos VO2', icon: '‚ö°', exercises: ['5x1000m con descanso 2min'] },
                        3: { name: 'Carrera Larga', icon: 'üèîÔ∏è', exercises: ['Long run 60-90min zona 2'] },
                        4: { name: 'Fartlek', icon: 'üî•', exercises: ['Fartlek 45min'] },
                        5: { name: 'Race Pace', icon: 'üëë', exercises: ['Pr√°ctica ritmo competencia 30min'] },
                        6: { name: 'Recuperaci√≥n Activa', icon: 'üßò', exercises: ['Trote suave 20min', 'Estiramientos 20min'] }
                    },
                    wellness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso total o caminata muy suave'] },
                        1: { name: 'Caminata', icon: 'üö∂', exercises: ['Caminata consciente 30min'] },
                        2: { name: 'Cardio Suave', icon: 'üå∏', exercises: ['Bicicleta est√°tica 25min suave'] },
                        3: { name: 'Nataci√≥n', icon: 'üèä', exercises: ['Nataci√≥n suave 30min'] },
                        4: { name: 'El√≠ptica', icon: 'üéØ', exercises: ['El√≠ptica 25min baja intensidad'] },
                        5: { name: 'Cardio + Yoga', icon: 'üßò', exercises: ['Cardio suave 20min', 'Yoga 20min'] },
                        6: { name: 'Naturaleza', icon: 'üå≤', exercises: ['Caminata en naturaleza 45min'] }
                    },
                    weightloss: {
                        0: { name: 'Descanso Activo', icon: 'üö∂', exercises: ['Caminata 30min'] },
                        1: { name: 'HIIT Quema', icon: 'üî•', exercises: ['HIIT 30min alta intensidad'] },
                        2: { name: 'Cardio Zona Quema', icon: 'üí¶', exercises: ['Cardio zona 2-3 por 45min'] },
                        3: { name: 'Intervalos', icon: '‚ö°', exercises: ['30seg sprint / 1min caminar x20'] },
                        4: { name: 'Cardio Largo', icon: 'üèÉ', exercises: ['Correr/Caminar 50min'] },
                        5: { name: 'HIIT + Abs', icon: 'üéØ', exercises: ['Tabata 20min', 'Core 20min'] },
                        6: { name: 'Cardio Moderado', icon: 'üö¥', exercises: ['Bicicleta 45min'] }
                    },
                    muscle: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso completo'] },
                        1: { name: 'LISS', icon: 'üö∂', exercises: ['Caminata inclinada 30min'] },
                        2: { name: 'Cardio Corto', icon: 'üèÉ', exercises: ['Cardio 20min post-pesas'] },
                        3: { name: 'LISS', icon: 'üö¥', exercises: ['Bicicleta suave 25min'] },
                        4: { name: 'Cardio Ligero', icon: 'üéØ', exercises: ['El√≠ptica 20min'] },
                        5: { name: 'HIIT Corto', icon: '‚ö°', exercises: ['HIIT 15min (preservar m√∫sculo)'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Caminata 20min', 'Estiramientos'] }
                    },
                    beginner: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso'] },
                        1: { name: 'Caminata', icon: 'üö∂', exercises: ['Caminata 20min'] },
                        2: { name: 'Cardio Intro', icon: 'üå±', exercises: ['Bicicleta suave 15min', 'Caminata 10min'] },
                        3: { name: 'Caminata+', icon: 'üìà', exercises: ['Caminata 25min'] },
                        4: { name: 'Intervalos Suaves', icon: '‚ö°', exercises: ['2min caminar r√°pido / 3min normal x5'] },
                        5: { name: 'Cardio Moderado', icon: 'üéØ', exercises: ['Cardio elecci√≥n 25min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Caminata suave 15min', 'Estiramientos'] }
                    }
                },
                yoga: {
                    fitness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Meditaci√≥n 20min'] },
                        1: { name: 'Vinyasa Flow', icon: 'üßò', exercises: ['Vinyasa 45min'] },
                        2: { name: 'Power Yoga', icon: 'üí™', exercises: ['Power yoga 45min'] },
                        3: { name: 'Flexibilidad', icon: 'ü§∏', exercises: ['Yin yoga 45min'] },
                        4: { name: 'Core Yoga', icon: 'üî•', exercises: ['Yoga core 35min'] },
                        5: { name: 'Balance', icon: '‚öñÔ∏è', exercises: ['Equilibrio y fuerza 40min'] },
                        6: { name: 'Restaurativo', icon: 'üåô', exercises: ['Yoga restaurativo 40min'] }
                    },
                    competition: {
                        0: { name: 'Recuperaci√≥n', icon: 'üò¥', exercises: ['Yoga Nidra 30min'] },
                        1: { name: 'Ashtanga', icon: 'üî•', exercises: ['Ashtanga Primary Series 90min'] },
                        2: { name: 'Power Flow', icon: 'üí™', exercises: ['Power Vinyasa 60min'] },
                        3: { name: 'T√©cnica', icon: 'üéØ', exercises: ['Pr√°ctica de inversiones 45min'] },
                        4: { name: 'Flexibilidad Profunda', icon: 'ü§∏', exercises: ['Yin avanzado 60min'] },
                        5: { name: 'Flow Intenso', icon: '‚ö°', exercises: ['Vinyasa avanzado 75min'] },
                        6: { name: 'Meditaci√≥n', icon: 'üßò', exercises: ['Meditaci√≥n profunda 45min', 'Pranayama 20min'] }
                    },
                    wellness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso o meditaci√≥n suave'] },
                        1: { name: 'Yoga Suave', icon: 'üå∏', exercises: ['Hatha yoga suave 30min'] },
                        2: { name: 'Yin Yoga', icon: 'üßò', exercises: ['Yin yoga 40min'] },
                        3: { name: 'Yoga + Meditaci√≥n', icon: 'üôè', exercises: ['Yoga 25min', 'Meditaci√≥n 20min'] },
                        4: { name: 'Restorative', icon: 'üåô', exercises: ['Yoga restaurativo 35min'] },
                        5: { name: 'Gentle Flow', icon: 'üåä', exercises: ['Flow suave 30min'] },
                        6: { name: 'Yoga Nidra', icon: 'üí§', exercises: ['Yoga Nidra 45min'] }
                    },
                    weightloss: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Meditaci√≥n 15min'] },
                        1: { name: 'Power Yoga', icon: 'üî•', exercises: ['Power yoga 45min'] },
                        2: { name: 'Vinyasa Cardio', icon: 'üí¶', exercises: ['Vinyasa din√°mico 50min'] },
                        3: { name: 'Core Focus', icon: 'üéØ', exercises: ['Yoga core intensive 40min'] },
                        4: { name: 'Hot Yoga Style', icon: 'üî•', exercises: ['Yoga caliente/intenso 45min'] },
                        5: { name: 'Flow Activo', icon: '‚ö°', exercises: ['Flow continuo 50min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Yin yoga 40min'] }
                    },
                    muscle: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Meditaci√≥n 20min'] },
                        1: { name: 'Yoga Fuerza', icon: 'üí™', exercises: ['Yoga para fuerza 40min'] },
                        2: { name: 'Flexibilidad', icon: 'ü§∏', exercises: ['Estiramientos profundos 35min'] },
                        3: { name: 'Core + Balance', icon: '‚öñÔ∏è', exercises: ['Core y equilibrio 35min'] },
                        4: { name: 'Recuperaci√≥n Muscular', icon: 'üßò', exercises: ['Yoga recovery 40min'] },
                        5: { name: 'Movilidad', icon: 'üîÑ', exercises: ['Movilidad articular 35min'] },
                        6: { name: 'Yin Recovery', icon: 'üåô', exercises: ['Yin yoga recovery 45min'] }
                    },
                    beginner: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso'] },
                        1: { name: 'Introducci√≥n', icon: 'üå±', exercises: ['Yoga b√°sico 20min'] },
                        2: { name: 'Posturas B√°sicas', icon: 'üßò', exercises: ['Posturas fundamentales 25min'] },
                        3: { name: 'Respiraci√≥n', icon: 'üå¨Ô∏è', exercises: ['Pranayama b√°sico 15min', 'Yoga 15min'] },
                        4: { name: 'Flexibilidad', icon: 'ü§∏', exercises: ['Estiramientos suaves 25min'] },
                        5: { name: 'Flow Suave', icon: 'üåä', exercises: ['Flow para principiantes 25min'] },
                        6: { name: 'Relajaci√≥n', icon: 'üå∏', exercises: ['Yoga restaurativo 20min'] }
                    }
                },
                dance: {
                    fitness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Estiramientos 20min'] },
                        1: { name: 'Zumba', icon: 'üíÉ', exercises: ['Zumba 45min'] },
                        2: { name: 'Baile Cardio', icon: 'üéµ', exercises: ['Cardio dance 45min'] },
                        3: { name: 'T√©cnica', icon: 'üë†', exercises: ['T√©cnica 30min', 'Coreograf√≠a 15min'] },
                        4: { name: 'Ritmos Latinos', icon: 'üå¥', exercises: ['Salsa/Bachata 45min'] },
                        5: { name: 'Dance Fitness', icon: 'üî•', exercises: ['Dance workout 50min'] },
                        6: { name: 'Stretching', icon: 'üßò', exercises: ['Stretching bailarines 30min'] }
                    },
                    competition: {
                        0: { name: 'Recuperaci√≥n', icon: 'üò¥', exercises: ['Estiramientos 30min', 'Visualizaci√≥n'] },
                        1: { name: 'T√©cnica Intensiva', icon: 'üéØ', exercises: ['T√©cnica avanzada 60min'] },
                        2: { name: 'Coreograf√≠a', icon: 'üíÉ', exercises: ['Pr√°ctica coreograf√≠a 90min'] },
                        3: { name: 'Condici√≥n F√≠sica', icon: 'üí™', exercises: ['Fuerza para bailarines 45min'] },
                        4: { name: 'Ensayo General', icon: 'üé≠', exercises: ['Run-through completo 60min'] },
                        5: { name: 'Performance', icon: 'üëë', exercises: ['Pr√°ctica con vestuario 45min'] },
                        6: { name: 'Flexibilidad', icon: 'ü§∏', exercises: ['Stretching profundo 45min'] }
                    },
                    wellness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso'] },
                        1: { name: 'Baile Libre', icon: 'üéµ', exercises: ['Baile libre 25min'] },
                        2: { name: 'Movimiento', icon: 'üå∏', exercises: ['Movimiento consciente 30min'] },
                        3: { name: 'Dance Meditation', icon: 'üßò', exercises: ['Ecstatic dance 30min'] },
                        4: { name: 'Ritmos Suaves', icon: 'üåä', exercises: ['Ritmos suaves 25min'] },
                        5: { name: 'Expresi√≥n', icon: '‚ú®', exercises: ['Danza expresiva 30min'] },
                        6: { name: 'Stretching', icon: 'üåô', exercises: ['Stretching relajante 25min'] }
                    },
                    weightloss: {
                        0: { name: 'Descanso Activo', icon: 'üö∂', exercises: ['Caminata 30min'] },
                        1: { name: 'Zumba Intenso', icon: 'üî•', exercises: ['Zumba alta intensidad 50min'] },
                        2: { name: 'Dance HIIT', icon: 'üí¶', exercises: ['Dance HIIT 45min'] },
                        3: { name: 'Cardio Latino', icon: 'üå¥', exercises: ['Ritmos latinos 50min'] },
                        4: { name: 'Dance Workout', icon: '‚ö°', exercises: ['Dance workout intenso 45min'] },
                        5: { name: 'Baile + Core', icon: 'üéØ', exercises: ['Baile 35min', 'Core 15min'] },
                        6: { name: 'Stretching', icon: 'üßò', exercises: ['Stretching 30min'] }
                    },
                    muscle: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Estiramientos suaves 20min'] },
                        1: { name: 'Dance + Fuerza', icon: 'üí™', exercises: ['Baile 30min', 'Fuerza tren inferior 20min'] },
                        2: { name: 'T√©cnica', icon: 'üéØ', exercises: ['T√©cnica y control 40min'] },
                        3: { name: 'Core Dance', icon: 'üî•', exercises: ['Core para bailarines 35min'] },
                        4: { name: 'Fuerza + Baile', icon: 'üíÉ', exercises: ['Fuerza 25min', 'Baile 25min'] },
                        5: { name: 'Acondicionamiento', icon: '‚ö°', exercises: ['Acondicionamiento bailar√≠n 45min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Yoga para bailarines 35min'] }
                    },
                    beginner: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso'] },
                        1: { name: 'Ritmos B√°sicos', icon: 'üå±', exercises: ['Pasos b√°sicos 25min'] },
                        2: { name: 'Coordinaci√≥n', icon: 'üéµ', exercises: ['Ejercicios coordinaci√≥n 20min'] },
                        3: { name: 'Baile F√°cil', icon: 'üíÉ', exercises: ['Coreograf√≠a f√°cil 25min'] },
                        4: { name: 'Movimiento', icon: 'üåä', exercises: ['Movimiento libre 20min'] },
                        5: { name: 'Pr√°ctica', icon: 'üìà', exercises: ['Repaso pasos 25min'] },
                        6: { name: 'Stretching', icon: 'üßò', exercises: ['Estiramientos b√°sicos 20min'] }
                    }
                },
                sports: {
                    fitness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Recuperaci√≥n activa'] },
                        1: { name: 'T√©cnica', icon: 'üéØ', exercises: ['Pr√°ctica t√©cnica 45min'] },
                        2: { name: 'Fuerza', icon: 'üí™', exercises: ['Fuerza deportiva 40min'] },
                        3: { name: 'T√°ctica', icon: 'üß†', exercises: ['Entrenamiento t√°ctico 45min'] },
                        4: { name: 'Resistencia', icon: '‚ù§Ô∏è', exercises: ['Cardio espec√≠fico 40min'] },
                        5: { name: 'Partido', icon: '‚öΩ', exercises: ['Pr√°ctica/Partido 90min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Yoga/Pilates 30min'] }
                    },
                    competition: {
                        0: { name: 'Recuperaci√≥n', icon: 'üò¥', exercises: ['Recuperaci√≥n completa', 'Visualizaci√≥n 20min'] },
                        1: { name: 'T√°ctica Avanzada', icon: 'üß†', exercises: ['An√°lisis video 30min', 'Pr√°ctica t√°ctica 60min'] },
                        2: { name: 'Fuerza Espec√≠fica', icon: 'üí™', exercises: ['Fuerza espec√≠fica deporte 50min'] },
                        3: { name: 'Simulaci√≥n', icon: 'üéØ', exercises: ['Simulaci√≥n competencia 75min'] },
                        4: { name: 'Velocidad', icon: '‚ö°', exercises: ['Entrenamiento velocidad/agilidad 45min'] },
                        5: { name: 'Pre-Competencia', icon: 'üëë', exercises: ['Activaci√≥n 30min', 'Mental prep 20min'] },
                        6: { name: 'Recuperaci√≥n Activa', icon: 'üßò', exercises: ['Yoga recovery 35min', 'Massage/Foam roller'] }
                    },
                    wellness: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso'] },
                        1: { name: 'Juego Recreativo', icon: '‚öΩ', exercises: ['Deporte recreativo 30min'] },
                        2: { name: 'Movilidad', icon: 'üßò', exercises: ['Movilidad deportiva 25min'] },
                        3: { name: 'T√©cnica Suave', icon: 'üéØ', exercises: ['Pr√°ctica t√©cnica suave 30min'] },
                        4: { name: 'Cardio Suave', icon: 'üö∂', exercises: ['Cardio suave 25min'] },
                        5: { name: 'Juego Libre', icon: 'üéÆ', exercises: ['Juego libre/recreativo 45min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üå∏', exercises: ['Estiramientos 25min'] }
                    },
                    weightloss: {
                        0: { name: 'Descanso Activo', icon: 'üö∂', exercises: ['Caminata 30min'] },
                        1: { name: 'Deporte Cardio', icon: '‚öΩ', exercises: ['Pr√°ctica intensa 60min'] },
                        2: { name: 'HIIT Deportivo', icon: 'üî•', exercises: ['Circuitos deportivos 45min'] },
                        3: { name: 'T√©cnica + Cardio', icon: 'üéØ', exercises: ['T√©cnica 30min', 'Cardio 20min'] },
                        4: { name: 'Partido/Pr√°ctica', icon: '‚ö°', exercises: ['Partido intenso 60min'] },
                        5: { name: 'Acondicionamiento', icon: 'üí¶', exercises: ['Acondicionamiento f√≠sico 50min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Yoga 30min'] }
                    },
                    muscle: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso completo'] },
                        1: { name: 'Fuerza Deportiva', icon: 'üí™', exercises: ['Fuerza espec√≠fica 50min'] },
                        2: { name: 'T√©cnica', icon: 'üéØ', exercises: ['Pr√°ctica t√©cnica 45min'] },
                        3: { name: 'Potencia', icon: '‚ö°', exercises: ['Entrenamiento potencia 45min'] },
                        4: { name: 'Fuerza + Deporte', icon: 'üèãÔ∏è', exercises: ['Pesas 35min', 'Pr√°ctica 30min'] },
                        5: { name: 'Partido', icon: '‚öΩ', exercises: ['Pr√°ctica/Partido 60min'] },
                        6: { name: 'Recuperaci√≥n', icon: 'üßò', exercises: ['Recovery yoga 35min'] }
                    },
                    beginner: {
                        0: { name: 'Descanso', icon: 'üò¥', exercises: ['Descanso'] },
                        1: { name: 'Introducci√≥n', icon: 'üå±', exercises: ['Reglas y t√©cnica b√°sica 30min'] },
                        2: { name: 'Fundamentos', icon: 'üìö', exercises: ['Fundamentos 25min'] },
                        3: { name: 'Pr√°ctica Suave', icon: '‚öΩ', exercises: ['Pr√°ctica suave 30min'] },
                        4: { name: 'Coordinaci√≥n', icon: 'üéØ', exercises: ['Ejercicios coordinaci√≥n 25min'] },
                        5: { name: 'Mini Juego', icon: 'üéÆ', exercises: ['Juego simplificado 30min'] },
                        6: { name: 'Estiramientos', icon: 'üßò', exercises: ['Estiramientos 20min'] }
                    }
                }
            },
            habitCatalog: [
                { id: 'meditation', icon: 'üßò', name: 'Meditaci√≥n' },
                { id: 'reading', icon: 'üìñ', name: 'Lectura' },
                { id: 'journaling', icon: 'üìù', name: 'Journaling' },
                { id: 'languages', icon: 'üåç', name: 'Idiomas' },
                { id: 'water', icon: 'üíß', name: 'Beber agua' },
                { id: 'skincare', icon: 'üß¥', name: 'Skincare' },
                { id: 'gratitude', icon: 'üôè', name: 'Gratitud' },
                { id: 'nosugar', icon: 'üö´', name: 'Sin az√∫car' },
                { id: 'sleep', icon: 'üò¥', name: 'Dormir bien' },
                { id: 'socialmedia', icon: 'üì±', name: 'Redes sociales' },
                { id: 'networking', icon: 'ü§ù', name: 'Networking' },
                { id: 'finances', icon: 'üí∞', name: 'Finanzas' }
            ]
        };

        async function loadTemplates() {
            // Try to load from Supabase first
            try {
                var cloudTemplates = await supabaseAPI.getAppTemplates();
                if (cloudTemplates) {
                    templates = cloudTemplates;
                    console.log('Templates loaded from Supabase');
                    return;
                }
            } catch (e) {
                console.log('Could not load templates from Supabase');
            }

            // Fallback to localStorage
            var saved = localStorage.getItem('backoffice-templates');
            if (saved) {
                try {
                    templates = JSON.parse(saved);
                } catch (e) {
                    console.log('Using default templates');
                }
            }
        }

        async function saveAllTemplates() {
            saveCurrentGoalData();
            saveCurrentExerciseData();

            // Save to localStorage as backup
            localStorage.setItem('backoffice-templates', JSON.stringify(templates));

            // Save to Supabase for cross-device access
            try {
                await supabaseAPI.saveAppTemplates(templates);
                showToast('Plantillas guardadas y sincronizadas', '‚úÖ');
            } catch (e) {
                console.error('Error saving to Supabase:', e);
                showToast('Plantillas guardadas localmente (error al sincronizar)', '‚ö†Ô∏è');
            }
        }

        function saveCurrentGoalData() {
            var goal = templates.goals[currentGoalType];
            if (!goal) return;
            goal.metas.fisica = document.getElementById('goalMetaFisica').value;
            goal.metas.personal = document.getElementById('goalMetaPersonal').value;
            goal.metas.digital = document.getElementById('goalMetaDigital').value;
            goal.metas.espiritual = document.getElementById('goalMetaEspiritual').value;
        }

        function saveCurrentExerciseData() {
            // Ensure the nested structure exists
            if (!templates.exercises[currentExerciseType]) {
                templates.exercises[currentExerciseType] = {};
            }
            if (!templates.exercises[currentExerciseType][currentExerciseGoal]) {
                templates.exercises[currentExerciseType][currentExerciseGoal] = {};
            }

            for (var i = 0; i < 7; i++) {
                var nameInput = document.getElementById('exercise-' + i + '-name');
                var iconInput = document.getElementById('exercise-' + i + '-icon');
                var exercisesInput = document.getElementById('exercise-' + i + '-exercises');
                if (nameInput) {
                    templates.exercises[currentExerciseType][currentExerciseGoal][i] = {
                        name: nameInput.value,
                        icon: iconInput.value || 'üí™',
                        exercises: exercisesInput.value.split('\n').filter(function(e) { return e.trim(); })
                    };
                }
            }
        }

        function selectGoalTab(goalType) {
            if (currentGoalType) saveCurrentGoalData();
            currentGoalType = goalType;
            document.querySelectorAll('.goal-tab').forEach(function(tab) {
                if (tab.dataset.goal === goalType) {
                    tab.className = 'goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white';
                } else {
                    tab.className = 'goal-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
                }
            });
            renderGoalTemplate();
        }

        function selectExerciseTab(exerciseType) {
            if (currentExerciseType && currentExerciseGoal) saveCurrentExerciseData();
            currentExerciseType = exerciseType;
            document.querySelectorAll('.exercise-tab').forEach(function(tab) {
                if (tab.dataset.exercise === exerciseType) {
                    tab.className = 'exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-purple-600 text-white';
                } else {
                    tab.className = 'exercise-tab px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600';
                }
            });
            updateExerciseSelectionLabel();
            renderExerciseTemplate();
        }

        function selectExerciseGoal(goal) {
            if (currentExerciseType && currentExerciseGoal) saveCurrentExerciseData();
            currentExerciseGoal = goal;
            document.querySelectorAll('.exercise-goal-tab').forEach(function(tab) {
                if (tab.dataset.goal === goal) {
                    tab.className = 'exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-green-600 text-white';
                } else {
                    tab.className = 'exercise-goal-tab px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-600 text-slate-300 hover:bg-slate-500';
                }
            });
            updateExerciseSelectionLabel();
            renderExerciseTemplate();
        }

        function updateExerciseSelectionLabel() {
            var typeLabels = {
                gym: 'üèãÔ∏è Gimnasio',
                cardio: 'üèÉ Cardio',
                yoga: 'üßò Yoga',
                dance: 'üíÉ Baile',
                sports: '‚öΩ Deportes'
            };
            var goalLabels = {
                fitness: 'üí™ Fitness',
                competition: 'üëë Competencia',
                wellness: 'üßò Bienestar',
                weightloss: 'üî• Bajar de Peso',
                muscle: 'üí™ Ganar M√∫sculo',
                beginner: 'üå± Principiante'
            };
            var label = document.getElementById('exerciseSelectionLabel');
            if (label) {
                label.innerHTML = '<span class="text-sm text-slate-300">Editando: </span><span class="text-sm font-medium text-white">' +
                    (typeLabels[currentExerciseType] || currentExerciseType) + ' + ' +
                    (goalLabels[currentExerciseGoal] || currentExerciseGoal) + '</span>';
            }
        }

        function renderGoalTemplate() {
            var goal = templates.goals[currentGoalType];
            if (!goal) return;

            var habitsList = document.getElementById('goalHabitsList');
            habitsList.textContent = '';

            goal.habits.forEach(function(h, idx) {
                var div = document.createElement('div');
                div.className = 'flex items-center gap-2 bg-slate-600 rounded-lg p-2';

                var iconInput = document.createElement('input');
                iconInput.type = 'text';
                iconInput.value = h.icon;
                iconInput.className = 'w-10 text-center bg-slate-500 rounded px-1 py-1 text-white';
                iconInput.onchange = function() { updateGoalHabit(idx, 'icon', this.value); };

                var nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = h.name;
                nameInput.className = 'flex-1 bg-slate-500 rounded px-2 py-1 text-white text-sm';
                nameInput.onchange = function() { updateGoalHabit(idx, 'name', this.value); };

                var removeBtn = document.createElement('button');
                removeBtn.textContent = '√ó';
                removeBtn.className = 'text-red-400 hover:text-red-300 px-2';
                removeBtn.onclick = function() { removeGoalHabit(idx); };

                div.appendChild(iconInput);
                div.appendChild(nameInput);
                div.appendChild(removeBtn);
                habitsList.appendChild(div);
            });

            document.getElementById('goalMetaFisica').value = goal.metas.fisica || '';
            document.getElementById('goalMetaPersonal').value = goal.metas.personal || '';
            document.getElementById('goalMetaDigital').value = goal.metas.digital || '';
            document.getElementById('goalMetaEspiritual').value = goal.metas.espiritual || '';
        }

        function renderExerciseTemplate() {
            var exerciseType = templates.exercises[currentExerciseType];
            if (!exerciseType) return;

            var exercise = exerciseType[currentExerciseGoal];
            if (!exercise) {
                // If goal doesn't exist for this type, show message
                var container = document.getElementById('exerciseTemplateContent');
                container.innerHTML = '<div class="col-span-4 text-center py-8 text-slate-400">No hay rutina configurada para esta combinaci√≥n. Los datos se crear√°n al guardar.</div>';
                return;
            }

            var days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            var container = document.getElementById('exerciseTemplateContent');
            container.textContent = '';

            for (var dayIdx = 0; dayIdx < 7; dayIdx++) {
                var day = exercise[dayIdx] || { name: '', icon: 'üí™', exercises: [] };
                var card = document.createElement('div');
                card.className = 'bg-slate-700/50 rounded-xl p-4';

                var dayLabel = document.createElement('div');
                dayLabel.className = 'text-xs text-slate-400 mb-2';
                dayLabel.textContent = days[dayIdx];

                var inputsDiv = document.createElement('div');
                inputsDiv.className = 'space-y-2';

                var row = document.createElement('div');
                row.className = 'flex gap-2';

                var iconInput = document.createElement('input');
                iconInput.type = 'text';
                iconInput.id = 'exercise-' + dayIdx + '-icon';
                iconInput.value = day.icon || 'üí™';
                iconInput.className = 'w-12 text-center bg-slate-600 rounded px-1 py-1 text-white text-lg';

                var nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.id = 'exercise-' + dayIdx + '-name';
                nameInput.value = day.name || '';
                nameInput.className = 'flex-1 bg-slate-600 rounded px-2 py-1 text-white text-sm font-medium';

                row.appendChild(iconInput);
                row.appendChild(nameInput);

                var textarea = document.createElement('textarea');
                textarea.id = 'exercise-' + dayIdx + '-exercises';
                textarea.className = 'w-full bg-slate-600 rounded px-2 py-1 text-white text-xs h-20 resize-none';
                textarea.placeholder = 'Ejercicios (uno por l√≠nea)';
                textarea.value = (day.exercises || []).join('\n');

                inputsDiv.appendChild(row);
                inputsDiv.appendChild(textarea);
                card.appendChild(dayLabel);
                card.appendChild(inputsDiv);
                container.appendChild(card);
            }
        }

        function renderHabitCatalog() {
            var container = document.getElementById('habitCatalog');
            container.textContent = '';

            templates.habitCatalog.forEach(function(h, idx) {
                var div = document.createElement('div');
                div.className = 'bg-slate-700/50 rounded-lg p-3 flex items-center gap-2';

                var icon = document.createElement('span');
                icon.className = 'text-xl';
                icon.textContent = h.icon;

                var name = document.createElement('span');
                name.className = 'text-white text-sm flex-1';
                name.textContent = h.name;

                var editBtn = document.createElement('button');
                editBtn.className = 'text-blue-400 hover:text-blue-300 text-sm';
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.onclick = function() { editCatalogHabit(idx); };

                var removeBtn = document.createElement('button');
                removeBtn.className = 'text-red-400 hover:text-red-300 text-sm';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = function() { removeCatalogHabit(idx); };

                div.appendChild(icon);
                div.appendChild(name);
                div.appendChild(editBtn);
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }

        function updateGoalHabit(idx, field, value) {
            templates.goals[currentGoalType].habits[idx][field] = value;
        }

        function removeGoalHabit(idx) {
            templates.goals[currentGoalType].habits.splice(idx, 1);
            renderGoalTemplate();
        }

        function addHabitToGoal() {
            templates.goals[currentGoalType].habits.push({ icon: '‚ú®', name: 'Nuevo h√°bito' });
            renderGoalTemplate();
        }

        function addNewHabit() {
            var name = prompt('Nombre del h√°bito:');
            if (name) {
                var icon = prompt('Emoji del h√°bito:', '‚ú®');
                templates.habitCatalog.push({ id: name.toLowerCase().replace(/\s+/g, '_'), icon: icon || '‚ú®', name: name });
                renderHabitCatalog();
            }
        }

        function editCatalogHabit(idx) {
            var habit = templates.habitCatalog[idx];
            var name = prompt('Nombre del h√°bito:', habit.name);
            if (name) {
                var icon = prompt('Emoji del h√°bito:', habit.icon);
                templates.habitCatalog[idx].name = name;
                templates.habitCatalog[idx].icon = icon || habit.icon;
                renderHabitCatalog();
            }
        }

        function removeCatalogHabit(idx) {
            if (confirm('¬øEliminar este h√°bito del cat√°logo?')) {
                templates.habitCatalog.splice(idx, 1);
                renderHabitCatalog();
            }
        }

        async function initTemplatesSection() {
            await loadTemplates();
            renderGoalTemplate();
            renderExerciseTemplate();
            renderHabitCatalog();
        }

        // ==================== Initialize ====================

        async function init() {
            await checkConnection();
            loadDashboard();
            loadPlans();
        }

        init();
    </script>
</body>
</html>
