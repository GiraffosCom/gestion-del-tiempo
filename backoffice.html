<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backoffice - Gestion del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a, #4338ca); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(59, 130, 246, 0.1); }
        .sidebar-item.active { background: rgba(59, 130, 246, 0.2); border-left: 3px solid #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-slate-900">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-slate-800 border-r border-slate-700 z-40 transform -translate-x-full md:translate-x-0 transition-transform">
        <div class="p-6 border-b border-slate-700">
            <div class="flex items-center gap-3">
                <span class="text-3xl">üîê</span>
                <div>
                    <h1 class="text-xl font-bold text-white">Backoffice</h1>
                    <p class="text-sm text-slate-400">Gestion del Tiempo</p>
                </div>
            </div>
        </div>

        <nav class="p-4 space-y-2">
            <button onclick="showSection('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="dashboard">
                <span>üìä</span> Dashboard
            </button>
            <button onclick="showSection('customers')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="customers">
                <span>üë•</span> Clientes
            </button>
            <button onclick="showSection('subscriptions')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="subscriptions">
                <span>üí≥</span> Suscripciones
            </button>
            <button onclick="showSection('payments')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="payments">
                <span>üí∞</span> Pagos
            </button>
            <button onclick="showSection('reports')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="reports">
                <span>üìà</span> Reportes
            </button>
            <button onclick="showSection('settings')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:text-white" data-section="settings">
                <span>‚öôÔ∏è</span> Configuracion
            </button>
        </nav>

        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-700">
            <button onclick="logout()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm flex items-center justify-center gap-2">
                <span>üö™</span> Cerrar Sesion
            </button>
        </div>
    </aside>

    <!-- Mobile menu toggle -->
    <button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-slate-800 rounded-lg text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        <!-- Top Bar -->
        <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-30">
            <div class="px-6 py-4 flex items-center justify-between">
                <h2 id="pageTitle" class="text-xl font-bold text-white">Dashboard</h2>
                <div class="flex items-center gap-4">
                    <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 rounded-full text-sm">
                        <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                        <span class="text-slate-400">Conectando...</span>
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm flex items-center gap-2">
                        <span>üîÑ</span> Actualizar
                    </button>
                </div>
            </div>
        </header>

        <div class="p-6">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-200 text-sm">MRR</p>
                                <p id="statMRR" class="text-3xl font-bold mt-1">$0</p>
                            </div>
                            <span class="text-5xl opacity-80">üíµ</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-200 text-sm">Clientes Activos</p>
                                <p id="statActiveCustomers" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <span class="text-5xl opacity-80">üë•</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-200 text-sm">Nuevos este mes</p>
                                <p id="statNewCustomers" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <span class="text-5xl opacity-80">üÜï</span>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-2xl p-6 text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-amber-200 text-sm">Churn Rate</p>
                                <p id="statChurnRate" class="text-3xl font-bold mt-1">0%</p>
                            </div>
                            <span class="text-5xl opacity-80">üìâ</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
                        <h3 class="text-lg font-bold text-white mb-4">üìà Ingresos Mensuales</h3>
                        <canvas id="revenueChart" height="200"></canvas>
                    </div>
                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
                        <h3 class="text-lg font-bold text-white mb-4">ü•ß Clientes por Plan</h3>
                        <canvas id="planDistributionChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <h3 class="text-lg font-bold text-white">üïê Actividad Reciente</h3>
                    </div>
                    <div id="recentActivity" class="p-6 space-y-4">
                        <p class="text-slate-400 text-center">Cargando actividad...</p>
                    </div>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="section-customers" class="section hidden">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-bold text-white">üë• Clientes</h3>
                            <div class="flex flex-wrap gap-3">
                                <input type="text" id="customerSearch" onkeyup="filterCustomers()" placeholder="üîç Buscar..."
                                    class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                                <select id="customerPlanFilter" onchange="filterCustomers()" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Todos los planes</option>
                                    <option value="Free">Free</option>
                                    <option value="Pro">Pro</option>
                                    <option value="Teams">Teams</option>
                                </select>
                                <button onclick="exportCustomers()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Email</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Plan</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Registro</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">Cargando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="customersPagination" class="p-4 border-t border-slate-700 flex items-center justify-between">
                        <p class="text-slate-400 text-sm">Mostrando <span id="customersShowing">0</span> de <span id="customersTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadCustomers(currentCustomerPage - 1)" id="customersPrevBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50" disabled>Anterior</button>
                            <button onclick="loadCustomers(currentCustomerPage + 1)" id="customersNextBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section id="section-subscriptions" class="section hidden">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-bold text-white">üí≥ Suscripciones</h3>
                            <div class="flex flex-wrap gap-3">
                                <select id="subscriptionStatusFilter" onchange="filterSubscriptions()" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Todos los estados</option>
                                    <option value="Active">Activas</option>
                                    <option value="Paused">Pausadas</option>
                                    <option value="Cancelled">Canceladas</option>
                                    <option value="Expired">Expiradas</option>
                                </select>
                                <button onclick="exportSubscriptions()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Plan</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Ciclo</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Vence</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-slate-400">Cargando suscripciones...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="subscriptionsPagination" class="p-4 border-t border-slate-700 flex items-center justify-between">
                        <p class="text-slate-400 text-sm">Mostrando <span id="subscriptionsShowing">0</span> de <span id="subscriptionsTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadSubscriptions(currentSubscriptionPage - 1)" id="subscriptionsPrevBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50" disabled>Anterior</button>
                            <button onclick="loadSubscriptions(currentSubscriptionPage + 1)" id="subscriptionsNextBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section id="section-payments" class="section hidden">
                <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <h3 class="text-lg font-bold text-white">üí∞ Pagos</h3>
                            <div class="flex flex-wrap gap-3">
                                <input type="date" id="paymentDateFrom" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <input type="date" id="paymentDateTo" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <button onclick="filterPayments()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    Filtrar
                                </button>
                                <button onclick="exportPayments()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Monto</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Fecha</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Metodo</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-slate-300 uppercase">Transaccion</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody" class="divide-y divide-slate-700">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-slate-400">Cargando pagos...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="paymentsPagination" class="p-4 border-t border-slate-700 flex items-center justify-between">
                        <p class="text-slate-400 text-sm">Mostrando <span id="paymentsShowing">0</span> de <span id="paymentsTotal">0</span></p>
                        <div class="flex gap-2">
                            <button onclick="loadPayments(currentPaymentPage - 1)" id="paymentsPrevBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50" disabled>Anterior</button>
                            <button onclick="loadPayments(currentPaymentPage + 1)" id="paymentsNextBtn" class="px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 disabled:opacity-50">Siguiente</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="section hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('customers')">
                        <div class="text-4xl mb-4">üë•</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Clientes</h3>
                        <p class="text-slate-400 text-sm">Lista completa de clientes con informacion de contacto y plan.</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('subscriptions')">
                        <div class="text-4xl mb-4">üí≥</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Suscripciones</h3>
                        <p class="text-slate-400 text-sm">Estado de todas las suscripciones, activas y canceladas.</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('payments')">
                        <div class="text-4xl mb-4">üí∞</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Pagos</h3>
                        <p class="text-slate-400 text-sm">Historial de pagos con montos, fechas y metodos.</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 card-hover cursor-pointer" onclick="generateReport('revenue')">
                        <div class="text-4xl mb-4">üìà</div>
                        <h3 class="text-lg font-bold text-white mb-2">Reporte de Ingresos</h3>
                        <p class="text-slate-400 text-sm">Ingresos mensuales con totales y tendencias.</p>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section hidden">
                <div class="max-w-2xl space-y-6">
                    <!-- API Configuration -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-bold text-white mb-4">üîó Configuracion de Supabase</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">URL del Proyecto Supabase</label>
                                <input type="url" id="apiUrlInput" placeholder="https://xxxxx.supabase.co"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">API Key (anon public)</label>
                                <input type="password" id="apiKeyInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <button onclick="saveApiConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                Guardar y Conectar
                            </button>
                        </div>
                    </div>

                    <!-- Admin Password -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-bold text-white mb-4">üîë Cambiar Contrasena Admin</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Contrasena Actual</label>
                                <input type="password" id="currentPassword"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Nueva Contrasena</label>
                                <input type="password" id="newPassword"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Confirmar Nueva Contrasena</label>
                                <input type="password" id="confirmPassword"
                                    class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <button onclick="changePassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                Cambiar Contrasena
                            </button>
                        </div>
                    </div>

                    <!-- Subscription Plans -->
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                        <h3 class="text-lg font-bold text-white mb-4">üìã Planes de Suscripcion</h3>
                        <div id="plansContainer" class="space-y-4">
                            <p class="text-slate-400">Cargando planes...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden border border-slate-700">
            <div class="p-6 border-b border-slate-700 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white">üë§ Detalle del Cliente</h3>
                <button onclick="closeModal('customerModal')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="customerModalContent" class="p-6 overflow-y-auto max-h-[70vh]">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Subscription Action Modal -->
    <div id="subscriptionModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
            <div class="p-6 border-b border-slate-700">
                <h3 id="subscriptionModalTitle" class="text-xl font-bold text-white">Accion de Suscripcion</h3>
            </div>
            <div id="subscriptionModalContent" class="p-6">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 transform translate-y-full transition-transform duration-300 z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-xl flex items-center gap-3">
            <span id="toastIcon" class="text-2xl">‚úÖ</span>
            <span id="toastMessage" class="text-white">Mensaje</span>
        </div>
    </div>

    <script src="src/js/services/supabase-api.js"></script>
    <script>
        // Alias for compatibility with existing code
        const frappeAPI = supabaseAPI;
    </script>
    <script>
        // Check admin session
        if (!localStorage.getItem('gestion-admin-session')) {
            window.location.href = 'admin-login.html';
        }

        // Sanitize HTML helper - uses DOMPurify
        function sanitizeHTML(html) {
            return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
        }

        // Escape text for safe display
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // State
        let currentSection = 'dashboard';
        let currentCustomerPage = 1;
        let currentSubscriptionPage = 1;
        let currentPaymentPage = 1;
        let allCustomers = [];
        let allSubscriptions = [];
        let allPayments = [];
        let subscriptionPlans = [];
        let revenueChart = null;
        let planChart = null;
        let isConnected = false;

        // Initialize Supabase config
        document.getElementById('apiUrlInput').value = localStorage.getItem('supabase_url') || 'https://crpotifjwqoljvcvsdje.supabase.co';
        document.getElementById('apiKeyInput').value = localStorage.getItem('supabase_key') || '';

        // ==================== Navigation ====================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function showSection(section) {
            currentSection = section;

            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section === section) {
                    item.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + section).classList.remove('hidden');

            // Update title
            const titles = {
                dashboard: 'Dashboard',
                customers: 'Clientes',
                subscriptions: 'Suscripciones',
                payments: 'Pagos',
                reports: 'Reportes',
                settings: 'Configuracion'
            };
            document.getElementById('pageTitle').textContent = titles[section];

            // Load data for section
            if (section === 'customers') loadCustomers();
            if (section === 'subscriptions') loadSubscriptions();
            if (section === 'payments') loadPayments();
            if (section === 'settings') loadPlans();

            // Close mobile sidebar
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        // ==================== Connection & Data Loading ====================

        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                const connected = await supabaseAPI.testConnection();
                if (connected) {
                    isConnected = true;
                    statusEl.innerHTML = sanitizeHTML('<span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-green-400">Supabase Conectado</span>');
                    return true;
                }
            } catch (e) {
                console.log('Supabase not available, using localStorage fallback');
            }
            isConnected = false;
            statusEl.innerHTML = sanitizeHTML('<span class="w-2 h-2 rounded-full bg-yellow-500"></span><span class="text-yellow-400">Modo Local</span>');
            return false;
        }

        async function refreshData() {
            await checkConnection();
            if (isConnected) {
                loadDashboard();
            } else {
                loadLocalData();
            }
        }

        async function loadDashboard() {
            if (isConnected) {
                try {
                    const stats = await frappeAPI.getDashboardStats();
                    updateDashboardUI(stats);
                } catch (e) {
                    console.error('Error loading dashboard:', e);
                    loadLocalData();
                }
            } else {
                loadLocalData();
            }
        }

        function loadLocalData() {
            // Load from localStorage as fallback
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const emails = Object.keys(users);

            document.getElementById('statMRR').textContent = '$0';
            document.getElementById('statActiveCustomers').textContent = String(emails.length);
            document.getElementById('statNewCustomers').textContent = String(countNewThisMonth(users));
            document.getElementById('statChurnRate').textContent = '0%';

            // Update charts with local data
            updateRevenueChart([
                { month: 'Ene', revenue: 0 },
                { month: 'Feb', revenue: 0 },
                { month: 'Mar', revenue: 0 },
                { month: 'Abr', revenue: 0 },
                { month: 'May', revenue: 0 },
                { month: 'Jun', revenue: 0 }
            ]);

            updatePlanChart([
                { plan_name: 'Free', customer_count: emails.length }
            ]);

            updateRecentActivity([]);
        }

        function countNewThisMonth(users) {
            const now = new Date();
            const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let count = 0;
            Object.values(users).forEach(function(user) {
                if (user.createdAt && new Date(user.createdAt) >= firstOfMonth) count++;
            });
            return count;
        }

        function updateDashboardUI(stats) {
            document.getElementById('statMRR').textContent = frappeAPI.formatCurrency(stats.mrr);
            document.getElementById('statActiveCustomers').textContent = String(stats.active_subscriptions);
            document.getElementById('statNewCustomers').textContent = String(stats.new_customers_month);
            document.getElementById('statChurnRate').textContent = stats.churn_rate + '%';

            updateRevenueChart(stats.revenue_trend);
            updatePlanChart(stats.customers_by_plan);
            updateRecentActivity([]);
        }

        function updateRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(function(d) { return d.month; }),
                    datasets: [{
                        label: 'Ingresos',
                        data: data.map(function(d) { return d.revenue; }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updatePlanChart(data) {
            const ctx = document.getElementById('planDistributionChart').getContext('2d');

            if (planChart) planChart.destroy();

            planChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(function(d) { return d.plan_name; }),
                    datasets: [{
                        data: data.map(function(d) { return d.customer_count; }),
                        backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            if (activities.length === 0) {
                container.textContent = 'No hay actividad reciente';
                container.className = 'p-6 text-slate-400 text-center';
                return;
            }
            // Clear and rebuild using DOM methods
            container.innerHTML = '';
            container.className = 'p-6 space-y-4';
            activities.forEach(function(a) {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-4 p-3 bg-slate-700/50 rounded-lg';

                const icon = document.createElement('span');
                icon.className = 'text-2xl';
                icon.textContent = a.icon;

                const info = document.createElement('div');
                const msg = document.createElement('p');
                msg.className = 'text-white';
                msg.textContent = a.message;
                const time = document.createElement('p');
                time.className = 'text-slate-500 text-sm';
                time.textContent = a.time;
                info.appendChild(msg);
                info.appendChild(time);

                div.appendChild(icon);
                div.appendChild(info);
                container.appendChild(div);
            });
        }

        // ==================== Customers ====================

        async function loadCustomers(page) {
            page = page || 1;
            currentCustomerPage = page;
            const tbody = document.getElementById('customersTableBody');

            if (isConnected) {
                try {
                    const result = await frappeAPI.getCustomers({ page: page, pageSize: 20 });
                    allCustomers = result.data || result.customers || [];

                    // Also include local customers that might not be in Supabase
                    const localCustomers = getLocalCustomersArray();
                    const supabaseEmails = allCustomers.map(function(c) { return c.email; });
                    const missingLocal = localCustomers.filter(function(c) {
                        return supabaseEmails.indexOf(c.email) === -1;
                    });
                    allCustomers = allCustomers.concat(missingLocal);

                    renderCustomersTable(allCustomers);
                    updatePagination('customers', result);
                } catch (e) {
                    console.error('Error loading customers:', e);
                    loadLocalCustomers();
                }
            } else {
                loadLocalCustomers();
            }
        }

        function getLocalCustomersArray() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            return Object.keys(users).map(function(email) {
                return {
                    id: email,
                    name: email,
                    full_name: users[email].name,
                    email: email,
                    plan_name: 'Free (Local)',
                    subscription: { status: 'Active' },
                    creation: users[email].createdAt
                };
            });
        }

        function loadLocalCustomers() {
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            allCustomers = Object.keys(users).map(function(email) {
                return {
                    id: email,  // Use email as ID for localStorage
                    name: email,
                    full_name: users[email].name,
                    email: email,
                    plan_name: 'Free',
                    subscription: { status: 'Active' },
                    creation: users[email].createdAt
                };
            });
            renderCustomersTable(allCustomers);
            document.getElementById('customersTotal').textContent = String(allCustomers.length);
            document.getElementById('customersShowing').textContent = String(allCustomers.length);
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';

            if (customers.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 6;
                td.className = 'px-6 py-12 text-center text-slate-400';
                td.textContent = 'No hay clientes';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            customers.forEach(function(c) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700/50 transition';

                // Client cell
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4';
                const div1 = document.createElement('div');
                div1.className = 'flex items-center gap-3';
                const avatar = document.createElement('div');
                avatar.className = 'w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold';
                avatar.textContent = (c.full_name || '?').charAt(0).toUpperCase();
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-white font-medium';
                nameSpan.textContent = c.full_name || '-';
                div1.appendChild(avatar);
                div1.appendChild(nameSpan);
                td1.appendChild(div1);

                // Email cell
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4 text-slate-300';
                td2.textContent = c.email;

                // Plan cell
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4';
                const planBadge = document.createElement('span');
                planBadge.className = 'px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full text-sm';
                planBadge.textContent = c.plan_name || 'Free';
                td3.appendChild(planBadge);

                // Status cell
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4';
                const status = c.subscription ? c.subscription.status : 'Active';
                const statusBadge = document.createElement('span');
                const statusStyles = {
                    Active: 'bg-green-600/20 text-green-400',
                    Paused: 'bg-yellow-600/20 text-yellow-400',
                    Cancelled: 'bg-red-600/20 text-red-400',
                    Expired: 'bg-slate-600/20 text-slate-400'
                };
                statusBadge.className = 'px-3 py-1 rounded-full text-sm ' + (statusStyles[status] || statusStyles.Active);
                statusBadge.textContent = status;
                td4.appendChild(statusBadge);

                // Date cell
                const td5 = document.createElement('td');
                td5.className = 'px-6 py-4 text-slate-300';
                td5.textContent = formatDate(c.creation);

                // Actions cell
                const td6 = document.createElement('td');
                td6.className = 'px-6 py-4';
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2';

                const viewBtn = document.createElement('button');
                viewBtn.className = 'p-2 bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/40 transition';
                viewBtn.title = 'Ver detalle';
                viewBtn.textContent = 'üëÅÔ∏è';
                viewBtn.onclick = function() { viewCustomer(c.id, c.email); };

                const manageBtn = document.createElement('button');
                manageBtn.className = 'p-2 bg-purple-600/20 text-purple-400 rounded-lg hover:bg-purple-600/40 transition';
                manageBtn.title = 'Gestionar suscripcion';
                manageBtn.textContent = 'üí≥';
                manageBtn.onclick = function() { editCustomerSubscription(c.id); };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition';
                deleteBtn.title = 'Eliminar cliente';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = function() { deleteCustomer(c.id, c.email); };

                actionsDiv.appendChild(viewBtn);
                actionsDiv.appendChild(manageBtn);
                actionsDiv.appendChild(deleteBtn);
                td6.appendChild(actionsDiv);

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tbody.appendChild(tr);
            });
        }

        function filterCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const planFilter = document.getElementById('customerPlanFilter').value;

            const filtered = allCustomers.filter(function(c) {
                const matchesSearch = (c.full_name || '').toLowerCase().indexOf(search) !== -1 ||
                                     c.email.toLowerCase().indexOf(search) !== -1;
                const matchesPlan = !planFilter || c.plan_name === planFilter;
                return matchesSearch && matchesPlan;
            });

            renderCustomersTable(filtered);
        }

        async function viewCustomer(customerId, email) {
            const modal = document.getElementById('customerModal');
            const content = document.getElementById('customerModalContent');

            content.textContent = 'Cargando...';
            content.className = 'p-6 text-slate-400 text-center';
            modal.classList.remove('hidden');

            // Try to load from localStorage first (for local customers)
            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            const localUser = users[email];

            if (isConnected) {
                try {
                    const data = await supabaseAPI.getCustomerDetails(email);
                    renderCustomerDetail(data);
                } catch (e) {
                    // Fallback to localStorage if not found in Supabase
                    if (localUser) {
                        renderCustomerDetail({
                            customer: { full_name: localUser.name, email: email, created_at: localUser.createdAt },
                            subscriptions: [],
                            payments: []
                        });
                    } else {
                        console.error('Error loading customer:', e);
                        content.textContent = 'Error al cargar datos: ' + e.message;
                        content.className = 'p-6 text-red-400 text-center';
                    }
                }
            } else {
                if (localUser) {
                    renderCustomerDetail({
                        customer: { full_name: localUser.name, email: email, created_at: localUser.createdAt },
                        subscriptions: [],
                        payments: []
                    });
                } else {
                    content.textContent = 'Cliente no encontrado';
                    content.className = 'p-6 text-red-400 text-center';
                }
            }
        }

        async function deleteCustomer(customerId, customerEmail) {
            // Get customer name for confirm dialog
            const customer = allCustomers.find(function(c) { return c.id === customerId || c.email === customerEmail; });
            const displayName = customer ? (customer.full_name || customer.email) : customerEmail;

            if (!confirm('¬øEliminar cliente "' + displayName + '"? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            if (isConnected && customerId && customerId !== customerEmail) {
                // Connected to Supabase and have a real UUID
                try {
                    await supabaseAPI.deleteCustomer(customerId);
                    showToast('Cliente eliminado', '‚úÖ');
                    loadCustomers();
                } catch (e) {
                    showToast('Error al eliminar: ' + e.message, '‚ùå');
                }
            } else {
                // Delete from localStorage using email
                const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
                if (users[customerEmail]) {
                    delete users[customerEmail];
                    localStorage.setItem('gestion-users', JSON.stringify(users));
                    showToast('Cliente eliminado', '‚úÖ');
                    loadCustomers();
                } else {
                    showToast('Cliente no encontrado', '‚ùå');
                }
            }
        }

        function renderCustomerDetail(data) {
            const content = document.getElementById('customerModalContent');
            content.innerHTML = '';
            content.className = 'p-6 overflow-y-auto max-h-[70vh]';

            const customer = data.customer;
            const subscriptions = data.subscriptions || [];
            const subscription = subscriptions.find(function(s) { return s.status === 'Active'; }) || subscriptions[0];
            const payments = data.payments || [];

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-6';

            // Header
            const header = document.createElement('div');
            header.className = 'flex items-center gap-4 p-4 bg-slate-700/50 rounded-xl';

            const avatar = document.createElement('div');
            avatar.className = 'w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-2xl font-bold';
            avatar.textContent = (customer.full_name || '?').charAt(0).toUpperCase();

            const info = document.createElement('div');
            const nameEl = document.createElement('h4');
            nameEl.className = 'text-xl font-bold text-white';
            nameEl.textContent = customer.full_name || '-';
            const emailEl = document.createElement('p');
            emailEl.className = 'text-slate-400';
            emailEl.textContent = customer.email;
            const dateEl = document.createElement('p');
            dateEl.className = 'text-slate-500 text-sm';
            dateEl.textContent = 'Registrado: ' + formatDate(customer.created_at);
            info.appendChild(nameEl);
            info.appendChild(emailEl);
            info.appendChild(dateEl);

            header.appendChild(avatar);
            header.appendChild(info);
            wrapper.appendChild(header);

            // Subscription info
            if (subscription) {
                const subSection = document.createElement('div');
                subSection.className = 'p-4 bg-slate-700/50 rounded-xl';

                const subTitle = document.createElement('h5');
                subTitle.className = 'font-bold text-white mb-3';
                subTitle.textContent = 'üí≥ Suscripcion';
                subSection.appendChild(subTitle);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-4 text-sm';

                const fields = [
                    { label: 'Plan', value: subscription.plan_name || 'N/A' },
                    { label: 'Estado', value: subscription.status },
                    { label: 'Ciclo', value: subscription.billing_cycle },
                    { label: 'Vence', value: formatDate(subscription.end_date) }
                ];

                fields.forEach(function(f) {
                    const cell = document.createElement('div');
                    const label = document.createElement('p');
                    label.className = 'text-slate-400';
                    label.textContent = f.label;
                    const val = document.createElement('p');
                    val.className = 'text-white';
                    val.textContent = f.value;
                    cell.appendChild(label);
                    cell.appendChild(val);
                    grid.appendChild(cell);
                });

                subSection.appendChild(grid);
                wrapper.appendChild(subSection);
            } else {
                const noSub = document.createElement('div');
                noSub.className = 'p-4 bg-slate-700/50 rounded-xl text-center';
                noSub.textContent = 'Sin suscripcion activa';
                noSub.style.color = '#94a3b8';
                wrapper.appendChild(noSub);
            }

            // Payments
            if (payments && payments.length > 0) {
                const paySection = document.createElement('div');
                paySection.className = 'p-4 bg-slate-700/50 rounded-xl';

                const payTitle = document.createElement('h5');
                payTitle.className = 'font-bold text-white mb-3';
                payTitle.textContent = 'üí∞ Ultimos Pagos';
                paySection.appendChild(payTitle);

                const payList = document.createElement('div');
                payList.className = 'space-y-2';

                payments.slice(0, 5).forEach(function(p) {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center text-sm';

                    const date = document.createElement('span');
                    date.className = 'text-slate-300';
                    date.textContent = formatDate(p.payment_date);

                    const amount = document.createElement('span');
                    amount.className = 'text-white font-medium';
                    amount.textContent = formatCurrency(p.amount);

                    const status = document.createElement('span');
                    status.className = p.status === 'Completed' ? 'text-green-400' : 'text-yellow-400';
                    status.textContent = p.status;

                    row.appendChild(date);
                    row.appendChild(amount);
                    row.appendChild(status);
                    payList.appendChild(row);
                });

                paySection.appendChild(payList);
                wrapper.appendChild(paySection);
            }

            content.appendChild(wrapper);
        }

        function editCustomerSubscription(customerId) {
            showToast('Funcion disponible con backend conectado', '‚ö†Ô∏è');
        }

        async function exportCustomers() {
            if (isConnected) {
                try {
                    const data = await frappeAPI.exportReport('customers');
                    frappeAPI.downloadAsCSV(data, 'clientes');
                    showToast('Reporte exportado', '‚úÖ');
                } catch (e) {
                    showToast('Error al exportar', '‚ùå');
                }
            } else {
                const rows = allCustomers.map(function(c) {
                    return '"' + escapeCSV(c.full_name) + '","' + escapeCSV(c.email) + '","' + escapeCSV(c.plan_name) + '","' + formatDate(c.creation) + '"';
                });
                downloadCSV('Nombre,Email,Plan,Registro\n' + rows.join('\n'), 'clientes');
            }
        }

        function escapeCSV(str) {
            if (!str) return '';
            return String(str).replace(/"/g, '""');
        }

        // ==================== Subscriptions ====================

        async function loadSubscriptions(page) {
            page = page || 1;
            currentSubscriptionPage = page;

            if (isConnected) {
                try {
                    const statusFilter = document.getElementById('subscriptionStatusFilter').value;
                    const filters = statusFilter ? { status: statusFilter } : null;
                    const result = await frappeAPI.getSubscriptions({ page: page, pageSize: 20, filters: filters });
                    allSubscriptions = result.subscriptions;
                    renderSubscriptionsTable(allSubscriptions);
                    updatePagination('subscriptions', result);
                } catch (e) {
                    console.error('Error loading subscriptions:', e);
                    renderSubscriptionsTable([]);
                }
            } else {
                renderSubscriptionsTable([]);
            }
        }

        function renderSubscriptionsTable(subscriptions) {
            const tbody = document.getElementById('subscriptionsTableBody');
            tbody.innerHTML = '';

            if (subscriptions.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.className = 'px-6 py-12 text-center text-slate-400';
                td.textContent = 'No hay suscripciones (conectar backend)';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            subscriptions.forEach(function(s) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700/50 transition';

                // ID
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4 text-slate-300';
                td1.textContent = s.name;

                // Customer
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4';
                const custDiv = document.createElement('div');
                const custName = document.createElement('p');
                custName.className = 'text-white';
                custName.textContent = s.customer_name || '-';
                const custEmail = document.createElement('p');
                custEmail.className = 'text-slate-500 text-sm';
                custEmail.textContent = s.customer_email || '-';
                custDiv.appendChild(custName);
                custDiv.appendChild(custEmail);
                td2.appendChild(custDiv);

                // Plan
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4';
                const planBadge = document.createElement('span');
                planBadge.className = 'px-3 py-1 bg-blue-600/20 text-blue-400 rounded-full text-sm';
                planBadge.textContent = s.plan_name || s.plan;
                td3.appendChild(planBadge);

                // Billing cycle
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4 text-slate-300';
                td4.textContent = s.billing_cycle;

                // Status
                const td5 = document.createElement('td');
                td5.className = 'px-6 py-4';
                const statusBadge = document.createElement('span');
                const statusStyles = {
                    Active: 'bg-green-600/20 text-green-400',
                    Paused: 'bg-yellow-600/20 text-yellow-400',
                    Cancelled: 'bg-red-600/20 text-red-400',
                    Expired: 'bg-slate-600/20 text-slate-400'
                };
                statusBadge.className = 'px-3 py-1 rounded-full text-sm ' + (statusStyles[s.status] || statusStyles.Active);
                statusBadge.textContent = s.status;
                td5.appendChild(statusBadge);

                // End date
                const td6 = document.createElement('td');
                td6.className = 'px-6 py-4 text-slate-300';
                td6.textContent = formatDate(s.end_date);

                // Actions
                const td7 = document.createElement('td');
                td7.className = 'px-6 py-4';
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2';

                if (s.status === 'Active') {
                    const extendBtn = document.createElement('button');
                    extendBtn.className = 'p-2 bg-green-600/20 text-green-400 rounded-lg hover:bg-green-600/40 transition';
                    extendBtn.title = 'Extender';
                    extendBtn.textContent = '‚ûï';
                    extendBtn.onclick = function() { showExtendModal(s.name); };
                    actionsDiv.appendChild(extendBtn);

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition';
                    cancelBtn.title = 'Cancelar';
                    cancelBtn.textContent = '‚ùå';
                    cancelBtn.onclick = function() { showCancelModal(s.name); };
                    actionsDiv.appendChild(cancelBtn);
                }

                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'p-2 bg-purple-600/20 text-purple-400 rounded-lg hover:bg-purple-600/40 transition';
                upgradeBtn.title = 'Cambiar plan';
                upgradeBtn.textContent = 'üîÑ';
                upgradeBtn.onclick = function() { showUpgradeModal(s.name, s.plan); };
                actionsDiv.appendChild(upgradeBtn);

                td7.appendChild(actionsDiv);

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tr.appendChild(td7);
                tbody.appendChild(tr);
            });
        }

        function filterSubscriptions() {
            loadSubscriptions(1);
        }

        function showExtendModal(subscriptionId) {
            const modal = document.getElementById('subscriptionModal');
            document.getElementById('subscriptionModalTitle').textContent = 'Extender Suscripcion';

            const content = document.getElementById('subscriptionModalContent');
            content.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';

            const inputDiv = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-slate-300 mb-2';
            label.textContent = 'Dias a extender';
            const input = document.createElement('input');
            input.type = 'number';
            input.id = 'extendDays';
            input.value = '30';
            input.min = '1';
            input.max = '365';
            input.className = 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none';
            inputDiv.appendChild(label);
            inputDiv.appendChild(input);

            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.onclick = function() { closeModal('subscriptionModal'); };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition';
            confirmBtn.textContent = 'Extender';
            confirmBtn.onclick = function() { extendSubscription(subscriptionId); };

            btnDiv.appendChild(cancelBtn);
            btnDiv.appendChild(confirmBtn);

            wrapper.appendChild(inputDiv);
            wrapper.appendChild(btnDiv);
            content.appendChild(wrapper);

            modal.classList.remove('hidden');
        }

        async function extendSubscription(subscriptionId) {
            const days = document.getElementById('extendDays').value;
            try {
                await frappeAPI.extendSubscription(subscriptionId, days);
                closeModal('subscriptionModal');
                showToast('Suscripcion extendida ' + days + ' dias', '‚úÖ');
                loadSubscriptions(currentSubscriptionPage);
            } catch (e) {
                showToast('Error al extender', '‚ùå');
            }
        }

        function showCancelModal(subscriptionId) {
            const modal = document.getElementById('subscriptionModal');
            document.getElementById('subscriptionModalTitle').textContent = 'Cancelar Suscripcion';

            const content = document.getElementById('subscriptionModalContent');
            content.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';

            const msg = document.createElement('p');
            msg.className = 'text-slate-300';
            msg.textContent = '¬øEstas seguro de cancelar esta suscripcion?';

            const inputDiv = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-slate-300 mb-2';
            label.textContent = 'Razon (opcional)';
            const textarea = document.createElement('textarea');
            textarea.id = 'cancelReason';
            textarea.rows = 3;
            textarea.className = 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none';
            inputDiv.appendChild(label);
            inputDiv.appendChild(textarea);

            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3';

            const keepBtn = document.createElement('button');
            keepBtn.className = 'flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition';
            keepBtn.textContent = 'No, mantener';
            keepBtn.onclick = function() { closeModal('subscriptionModal'); };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition';
            confirmBtn.textContent = 'Si, cancelar';
            confirmBtn.onclick = function() { cancelSubscription(subscriptionId); };

            btnDiv.appendChild(keepBtn);
            btnDiv.appendChild(confirmBtn);

            wrapper.appendChild(msg);
            wrapper.appendChild(inputDiv);
            wrapper.appendChild(btnDiv);
            content.appendChild(wrapper);

            modal.classList.remove('hidden');
        }

        async function cancelSubscription(subscriptionId) {
            const reason = document.getElementById('cancelReason').value;
            try {
                await frappeAPI.cancelSubscription(subscriptionId, reason);
                closeModal('subscriptionModal');
                showToast('Suscripcion cancelada', '‚úÖ');
                loadSubscriptions(currentSubscriptionPage);
            } catch (e) {
                showToast('Error al cancelar', '‚ùå');
            }
        }

        function showUpgradeModal(subscriptionId, currentPlan) {
            const modal = document.getElementById('subscriptionModal');
            document.getElementById('subscriptionModalTitle').textContent = 'Cambiar Plan';

            const content = document.getElementById('subscriptionModalContent');
            content.innerHTML = '';

            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-4';

            const inputDiv = document.createElement('div');
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-slate-300 mb-2';
            label.textContent = 'Nuevo plan';
            const select = document.createElement('select');
            select.id = 'newPlan';
            select.className = 'w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none';

            subscriptionPlans.forEach(function(p) {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.plan_name + ' - ' + formatCurrency(p.price_monthly) + '/mes';
                if (p.plan_name === currentPlan) opt.selected = true;
                select.appendChild(opt);
            });

            inputDiv.appendChild(label);
            inputDiv.appendChild(select);

            const btnDiv = document.createElement('div');
            btnDiv.className = 'flex gap-3';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'flex-1 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.onclick = function() { closeModal('subscriptionModal'); };

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition';
            confirmBtn.textContent = 'Cambiar';
            confirmBtn.onclick = function() { upgradePlan(subscriptionId); };

            btnDiv.appendChild(cancelBtn);
            btnDiv.appendChild(confirmBtn);

            wrapper.appendChild(inputDiv);
            wrapper.appendChild(btnDiv);
            content.appendChild(wrapper);

            modal.classList.remove('hidden');
        }

        async function upgradePlan(subscriptionId) {
            const newPlan = document.getElementById('newPlan').value;
            try {
                await frappeAPI.upgradePlan(subscriptionId, newPlan);
                closeModal('subscriptionModal');
                showToast('Plan actualizado', '‚úÖ');
                loadSubscriptions(currentSubscriptionPage);
            } catch (e) {
                showToast('Error al cambiar plan', '‚ùå');
            }
        }

        async function exportSubscriptions() {
            if (isConnected) {
                try {
                    const data = await frappeAPI.exportReport('subscriptions');
                    frappeAPI.downloadAsCSV(data, 'suscripciones');
                    showToast('Reporte exportado', '‚úÖ');
                } catch (e) {
                    showToast('Error al exportar', '‚ùå');
                }
            }
        }

        // ==================== Payments ====================

        async function loadPayments(page) {
            page = page || 1;
            currentPaymentPage = page;

            if (isConnected) {
                try {
                    const result = await frappeAPI.getPayments({ page: page, pageSize: 20 });
                    allPayments = result.payments;
                    renderPaymentsTable(allPayments);
                    updatePagination('payments', result);
                } catch (e) {
                    console.error('Error loading payments:', e);
                    renderPaymentsTable([]);
                }
            } else {
                renderPaymentsTable([]);
            }
        }

        function renderPaymentsTable(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            if (payments.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.className = 'px-6 py-12 text-center text-slate-400';
                td.textContent = 'No hay pagos registrados (conectar backend)';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            payments.forEach(function(p) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700/50 transition';

                // ID
                const td1 = document.createElement('td');
                td1.className = 'px-6 py-4 text-slate-300';
                td1.textContent = p.name;

                // Customer
                const td2 = document.createElement('td');
                td2.className = 'px-6 py-4';
                const custDiv = document.createElement('div');
                const custName = document.createElement('p');
                custName.className = 'text-white';
                custName.textContent = p.customer_name || '-';
                const custEmail = document.createElement('p');
                custEmail.className = 'text-slate-500 text-sm';
                custEmail.textContent = p.customer_email || '-';
                custDiv.appendChild(custName);
                custDiv.appendChild(custEmail);
                td2.appendChild(custDiv);

                // Amount
                const td3 = document.createElement('td');
                td3.className = 'px-6 py-4 text-white font-medium';
                td3.textContent = formatCurrency(p.amount);

                // Date
                const td4 = document.createElement('td');
                td4.className = 'px-6 py-4 text-slate-300';
                td4.textContent = formatDate(p.payment_date);

                // Method
                const td5 = document.createElement('td');
                td5.className = 'px-6 py-4 text-slate-300';
                td5.textContent = p.payment_method;

                // Status
                const td6 = document.createElement('td');
                td6.className = 'px-6 py-4';
                const statusBadge = document.createElement('span');
                const statusStyles = {
                    Completed: 'bg-green-600/20 text-green-400',
                    Pending: 'bg-yellow-600/20 text-yellow-400',
                    Failed: 'bg-red-600/20 text-red-400',
                    Refunded: 'bg-purple-600/20 text-purple-400'
                };
                statusBadge.className = 'px-3 py-1 rounded-full text-sm ' + (statusStyles[p.status] || statusStyles.Pending);
                statusBadge.textContent = p.status;
                td6.appendChild(statusBadge);

                // Transaction ID
                const td7 = document.createElement('td');
                td7.className = 'px-6 py-4 text-slate-400 text-sm';
                td7.textContent = p.transaction_id || '-';

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tr.appendChild(td7);
                tbody.appendChild(tr);
            });
        }

        function filterPayments() {
            loadPayments(1);
        }

        async function exportPayments() {
            if (isConnected) {
                try {
                    const dateFrom = document.getElementById('paymentDateFrom').value || null;
                    const dateTo = document.getElementById('paymentDateTo').value || null;
                    const data = await frappeAPI.exportReport('payments', dateFrom, dateTo);
                    frappeAPI.downloadAsCSV(data, 'pagos');
                    showToast('Reporte exportado', '‚úÖ');
                } catch (e) {
                    showToast('Error al exportar', '‚ùå');
                }
            }
        }

        // ==================== Reports ====================

        async function generateReport(type) {
            showToast('Generando reporte...', '‚è≥');
            try {
                const data = await frappeAPI.exportReport(type);
                frappeAPI.downloadAsCSV(data, 'reporte_' + type);
                showToast('Reporte descargado', '‚úÖ');
            } catch (e) {
                showToast('Error al generar reporte', '‚ùå');
            }
        }

        // ==================== Settings ====================

        async function loadPlans() {
            const container = document.getElementById('plansContainer');

            if (isConnected) {
                try {
                    subscriptionPlans = await frappeAPI.getSubscriptionPlans();
                    renderPlans(subscriptionPlans);
                } catch (e) {
                    container.textContent = 'Error al cargar planes';
                    container.className = 'text-red-400';
                }
            } else {
                // Default plans
                subscriptionPlans = [
                    { name: 'Free', plan_name: 'Free', price_monthly: 0, price_yearly: 0 },
                    { name: 'Pro', plan_name: 'Pro', price_monthly: 9900, price_yearly: 99000 },
                    { name: 'Teams', plan_name: 'Teams', price_monthly: 29900, price_yearly: 299000 }
                ];
                renderPlans(subscriptionPlans);
            }
        }

        function renderPlans(plans) {
            const container = document.getElementById('plansContainer');
            container.innerHTML = '';
            container.className = 'space-y-4';

            plans.forEach(function(p) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-slate-700/50 rounded-lg';

                const info = document.createElement('div');
                const name = document.createElement('p');
                name.className = 'text-white font-medium';
                name.textContent = p.plan_name;
                const price = document.createElement('p');
                price.className = 'text-slate-400 text-sm';
                price.textContent = formatCurrency(p.price_monthly) + '/mes - ' + formatCurrency(p.price_yearly) + '/a√±o';
                info.appendChild(name);
                info.appendChild(price);

                const icon = document.createElement('span');
                icon.className = 'text-2xl';
                icon.textContent = p.price_monthly === 0 ? 'üÜì' : (p.plan_name === 'Pro' ? '‚≠ê' : 'üë•');

                div.appendChild(info);
                div.appendChild(icon);
                container.appendChild(div);
            });
        }

        function saveApiConfig() {
            const url = document.getElementById('apiUrlInput').value;
            const key = document.getElementById('apiKeyInput').value;
            if (url && key) {
                supabaseAPI.configure(url, key);
                showToast('Configuracion guardada', '‚úÖ');
                refreshData();
            } else {
                showToast('Completa URL y API Key', '‚ö†Ô∏è');
            }
        }

        // Legacy alias
        function saveApiUrl() { saveApiConfig(); }

        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            const admin = JSON.parse(localStorage.getItem('gestion-admin') || '{}');

            if (current !== admin.password) {
                showToast('Contrasena actual incorrecta', '‚ùå');
                return;
            }

            if (newPass.length < 6) {
                showToast('La contrasena debe tener al menos 6 caracteres', '‚ùå');
                return;
            }

            if (newPass !== confirm) {
                showToast('Las contrasenas no coinciden', '‚ùå');
                return;
            }

            admin.password = newPass;
            localStorage.setItem('gestion-admin', JSON.stringify(admin));
            showToast('Contrasena actualizada', '‚úÖ');

            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // ==================== Utilities ====================

        function updatePagination(type, result) {
            var page = result.page;
            var total = result.total;
            var page_size = result.page_size;
            var total_pages = result.total_pages;
            var showing = Math.min(page * page_size, total);

            document.getElementById(type + 'Total').textContent = String(total);
            document.getElementById(type + 'Showing').textContent = String(showing);
            document.getElementById(type + 'PrevBtn').disabled = page <= 1;
            document.getElementById(type + 'NextBtn').disabled = page >= total_pages;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Intl.DateTimeFormat('es-CL', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).format(new Date(dateStr));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function downloadCSV(content, filename) {
            var blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function showToast(message, icon) {
            icon = icon || '‚úÖ';
            var toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastIcon').textContent = icon;
            toast.classList.remove('translate-y-full');
            setTimeout(function() { toast.classList.add('translate-y-full'); }, 3000);
        }

        function logout() {
            localStorage.removeItem('gestion-admin-session');
            window.location.href = 'admin-login.html';
        }

        // ==================== Initialize ====================

        async function init() {
            await checkConnection();
            loadDashboard();
            loadPlans();
        }

        init();
    </script>
</body>
</html>
