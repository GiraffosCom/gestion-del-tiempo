<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura tus Actividades - Gesti√≥n del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .option-card { transition: all 0.3s ease; }
        .option-card:hover { transform: translateY(-2px); }
        .option-card.selected { border-color: #8b5cf6; background: linear-gradient(135deg, #ede9fe, #fae8ff); }
        .option-card.selected .check-icon { display: flex; }
        .check-icon { display: none; }
        .step-dot.active { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .step-dot.completed { background: #22c55e; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .task-card { transition: all 0.2s ease; }
        .task-card.selected { background: #f0fdf4; border-color: #22c55e; }
        .task-card.selected .task-check { background: #22c55e; color: white; }
        .category-fisica { border-left: 4px solid #ef4444; }
        .category-personal { border-left: 4px solid #3b82f6; }
        .category-digital { border-left: 4px solid #8b5cf6; }
        .category-espiritual { border-left: 4px solid #10b981; }
        .category-habitos { border-left: 4px solid #f59e0b; }
        .habit-section { border-left: 4px solid #8b5cf6; }
        .exercise-section { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">

    <!-- Progress Header -->
    <header class="bg-white/80 backdrop-blur-sm border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìÖ</span>
                    <span class="font-bold gradient-text">Configura tu Agenda</span>
                </div>
                <span id="stepIndicator" class="text-sm text-gray-500">Paso 1 de 4</span>
            </div>
            <!-- Progress bar -->
            <div class="flex gap-2">
                <div id="dot1" class="step-dot w-full h-2 rounded-full bg-gray-200 active"></div>
                <div id="dot2" class="step-dot w-full h-2 rounded-full bg-gray-200"></div>
                <div id="dot3" class="step-dot w-full h-2 rounded-full bg-gray-200"></div>
                <div id="dot4" class="step-dot w-full h-2 rounded-full bg-gray-200"></div>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8">
        <!-- Step 1: Select Habits -->
        <div id="step1" class="step-content fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">‚ú®</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">¬øQu√© h√°bitos quieres incluir?</h1>
                <p class="text-gray-600">Selecciona los h√°bitos para los que quieres generar actividades en tu agenda</p>
            </div>

            <div id="habitsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <!-- Habits will be rendered here -->
            </div>
        </div>

        <!-- Step 2: Select Exercise -->
        <div id="step2" class="step-content hidden fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">üí™</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">¬øQu√© tipo de ejercicio practicas?</h1>
                <p class="text-gray-600">Selecciona los ejercicios para agregarlos a tu rutina</p>
            </div>

            <div id="exerciseGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Exercises will be rendered here -->
            </div>
        </div>

        <!-- Step 3: Configure Tasks per Habit/Exercise -->
        <div id="step3" class="step-content hidden fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">üìã</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Personaliza tus actividades</h1>
                <p class="text-gray-600">Por cada h√°bito y ejercicio, elige las tareas que quieres agregar</p>
            </div>

            <div id="tasksContainer" class="space-y-6">
                <!-- Tasks per habit/exercise will be rendered here -->
            </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div id="step4" class="step-content hidden fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">‚úÖ</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Confirma tu Plan</h1>
                <p class="text-gray-600">Revisa las actividades que se agregar√°n a tu agenda</p>
            </div>

            <div class="space-y-4">
                <!-- Weekday Summary -->
                <div class="bg-white rounded-2xl p-5 border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span>üìÖ</span> Entre Semana (Lun-Vie)
                        <span id="weekdayCount" class="text-sm font-normal text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full">0</span>
                    </h3>
                    <div id="weekdaySummary" class="space-y-2 max-h-48 overflow-y-auto">
                    </div>
                </div>

                <!-- Weekend Summary -->
                <div class="bg-white rounded-2xl p-5 border border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span>üå¥</span> Fin de Semana (S√°b-Dom)
                        <span id="weekendCount" class="text-sm font-normal text-green-600 bg-green-100 px-2 py-0.5 rounded-full">0</span>
                    </h3>
                    <div id="weekendSummary" class="space-y-2 max-h-48 overflow-y-auto">
                    </div>
                </div>

                <!-- Info box -->
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <p class="text-sm text-blue-700">
                        <span class="font-medium">üí° Tip:</span> Puedes modificar los horarios y agregar m√°s actividades desde la app despu√©s de completar este wizard.
                    </p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8">
            <button id="prevBtn" onclick="prevStep()" class="px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200 transition hidden">
                ‚Üê Anterior
            </button>
            <button id="skipBtn" onclick="skipSetup()" class="px-6 py-3 bg-gray-100 text-gray-500 rounded-xl font-medium hover:bg-gray-200 transition">
                Omitir
            </button>
            <button id="nextBtn" onclick="nextStep()" class="px-8 py-3 gradient-bg text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg shadow-purple-200 ml-auto">
                Siguiente ‚Üí
            </button>
            <button id="finishBtn" onclick="finishActivitySetup()" class="px-8 py-3 gradient-bg text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg shadow-purple-200 ml-auto hidden">
                ‚ú® Comenzar mi plan
            </button>
        </div>
    </main>

    <script>
        // Check if user is logged in
        const currentUser = JSON.parse(localStorage.getItem('gestion-currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        // Get user preferences from onboarding
        const userKey = currentUser.email.replace(/[^a-z0-9]/gi, '_');
        const userProfile = JSON.parse(localStorage.getItem(userKey + '-user-profile') || '{}');
        const userPreferences = currentUser.preferences || {};

        let currentStep = 1;
        const totalSteps = 4;

        // Selected items
        let selectedHabits = [];
        let selectedExercises = [];
        let selectedTasks = {}; // { habitId: [taskIds], exerciseId: [taskIds] }

        // Habits definition
        const habitsData = {
            meditation: { icon: 'üßò', name: 'Meditaci√≥n', description: 'Calma tu mente' },
            reading: { icon: 'üìñ', name: 'Lectura', description: 'Expande tu conocimiento' },
            journaling: { icon: 'üìù', name: 'Journaling', description: 'Reflexiona y escribe' },
            languages: { icon: 'üåç', name: 'Idiomas', description: 'Aprende nuevos idiomas' },
            water: { icon: 'üíß', name: 'Hidrataci√≥n', description: 'Bebe suficiente agua' },
            skincare: { icon: 'üß¥', name: 'Skincare', description: 'Cuida tu piel' },
            gratitude: { icon: 'üôè', name: 'Gratitud', description: 'Agradece cada d√≠a' },
            socialmedia: { icon: 'üì±', name: 'Redes Sociales', description: 'Crea contenido' },
            networking: { icon: 'ü§ù', name: 'Networking', description: 'Conecta con otros' },
            finances: { icon: 'üí∞', name: 'Finanzas', description: 'Controla tu dinero' }
        };

        // Exercises definition
        const exercisesData = {
            gym: { icon: 'üèãÔ∏è', name: 'Gimnasio', description: 'Pesas y m√°quinas' },
            cardio: { icon: 'üèÉ', name: 'Cardio', description: 'Correr, bicicleta, HIIT' },
            yoga: { icon: 'üßò', name: 'Yoga / Pilates', description: 'Flexibilidad y equilibrio' },
            dance: { icon: 'üíÉ', name: 'Baile / Zumba', description: 'Mu√©vete con ritmo' },
            sports: { icon: '‚öΩ', name: 'Deportes', description: 'F√∫tbol, tenis, nataci√≥n' }
        };

        // Tasks per habit
        const habitTasks = {
            meditation: [
                { id: 'med_morning', name: 'Meditaci√≥n matutina', duration: 15, time: 'morning', category: 'espiritual', weekday: true, weekend: true },
                { id: 'med_guided', name: 'Meditaci√≥n guiada', duration: 20, time: 'morning', category: 'espiritual', weekday: true, weekend: true },
                { id: 'med_night', name: 'Meditaci√≥n antes de dormir', duration: 10, time: 'night', category: 'espiritual', weekday: true, weekend: true },
                { id: 'med_breathing', name: 'Ejercicios de respiraci√≥n', duration: 5, time: 'afternoon', category: 'espiritual', weekday: true, weekend: false }
            ],
            reading: [
                { id: 'read_morning', name: 'Lectura matutina', duration: 20, time: 'morning', category: 'personal', weekday: true, weekend: true },
                { id: 'read_night', name: 'Lectura antes de dormir', duration: 30, time: 'night', category: 'personal', weekday: true, weekend: true },
                { id: 'read_lunch', name: 'Lectura en pausa de almuerzo', duration: 15, time: 'afternoon', category: 'personal', weekday: true, weekend: false }
            ],
            journaling: [
                { id: 'journal_morning', name: 'Journaling matutino', duration: 15, time: 'morning', category: 'espiritual', weekday: true, weekend: true },
                { id: 'journal_night', name: 'Reflexi√≥n nocturna', duration: 10, time: 'night', category: 'espiritual', weekday: true, weekend: true },
                { id: 'journal_gratitude', name: 'Diario de gratitud', duration: 5, time: 'morning', category: 'espiritual', weekday: true, weekend: true }
            ],
            languages: [
                { id: 'lang_app', name: 'Pr√°ctica con app (Duolingo)', duration: 15, time: 'morning', category: 'personal', weekday: true, weekend: true },
                { id: 'lang_vocab', name: 'Estudio de vocabulario', duration: 20, time: 'afternoon', category: 'personal', weekday: true, weekend: false },
                { id: 'lang_listen', name: 'Escuchar podcast en idioma', duration: 30, time: 'afternoon', category: 'personal', weekday: true, weekend: true },
                { id: 'lang_practice', name: 'Pr√°ctica conversacional', duration: 30, time: 'evening', category: 'personal', weekday: false, weekend: true }
            ],
            water: [
                { id: 'water_morning', name: 'Vaso de agua al despertar', duration: 5, time: 'morning', category: 'habitos', weekday: true, weekend: true },
                { id: 'water_track', name: 'Trackear consumo de agua', duration: 2, time: 'afternoon', category: 'habitos', weekday: true, weekend: true }
            ],
            skincare: [
                { id: 'skin_am', name: 'Rutina skincare AM', duration: 10, time: 'morning', category: 'habitos', weekday: true, weekend: true },
                { id: 'skin_pm', name: 'Rutina skincare PM', duration: 15, time: 'night', category: 'habitos', weekday: true, weekend: true },
                { id: 'skin_mask', name: 'Mascarilla facial', duration: 20, time: 'evening', category: 'habitos', weekday: false, weekend: true }
            ],
            gratitude: [
                { id: 'grat_morning', name: 'Escribir 3 gratitudes', duration: 5, time: 'morning', category: 'espiritual', weekday: true, weekend: true },
                { id: 'grat_reflect', name: 'Reflexi√≥n de gratitud nocturna', duration: 5, time: 'night', category: 'espiritual', weekday: true, weekend: true }
            ],
            socialmedia: [
                { id: 'social_create', name: 'Crear contenido', duration: 60, time: 'morning', category: 'digital', weekday: true, weekend: false },
                { id: 'social_engage', name: 'Interactuar con audiencia', duration: 30, time: 'afternoon', category: 'digital', weekday: true, weekend: false },
                { id: 'social_plan', name: 'Planificar contenido semanal', duration: 45, time: 'morning', category: 'digital', weekday: false, weekend: true },
                { id: 'social_analytics', name: 'Revisar m√©tricas', duration: 15, time: 'evening', category: 'digital', weekday: false, weekend: true }
            ],
            networking: [
                { id: 'net_linkedin', name: 'Interactuar en LinkedIn', duration: 15, time: 'morning', category: 'personal', weekday: true, weekend: false },
                { id: 'net_messages', name: 'Responder mensajes profesionales', duration: 20, time: 'afternoon', category: 'personal', weekday: true, weekend: false },
                { id: 'net_event', name: 'Evento de networking', duration: 120, time: 'evening', category: 'personal', weekday: false, weekend: true }
            ],
            finances: [
                { id: 'fin_track', name: 'Registrar gastos del d√≠a', duration: 5, time: 'night', category: 'personal', weekday: true, weekend: true },
                { id: 'fin_review', name: 'Revisi√≥n semanal de finanzas', duration: 30, time: 'morning', category: 'personal', weekday: false, weekend: true },
                { id: 'fin_budget', name: 'Actualizar presupuesto', duration: 15, time: 'evening', category: 'personal', weekday: false, weekend: true }
            ]
        };

        // Tasks per exercise
        const exerciseTasks = {
            gym: [
                { id: 'gym_train', name: 'Entrenamiento en gimnasio', duration: 90, time: 'morning', category: 'fisica', weekday: true, weekend: true },
                { id: 'gym_warmup', name: 'Calentamiento pre-gym', duration: 10, time: 'morning', category: 'fisica', weekday: true, weekend: true },
                { id: 'gym_stretch', name: 'Estiramientos post-gym', duration: 15, time: 'morning', category: 'fisica', weekday: true, weekend: true },
                { id: 'gym_meal', name: 'Comida post-entrenamiento', duration: 30, time: 'morning', category: 'habitos', weekday: true, weekend: true }
            ],
            cardio: [
                { id: 'cardio_run', name: 'Sesi√≥n de running', duration: 45, time: 'morning', category: 'fisica', weekday: true, weekend: true },
                { id: 'cardio_hiit', name: 'HIIT en casa', duration: 30, time: 'morning', category: 'fisica', weekday: true, weekend: false },
                { id: 'cardio_bike', name: 'Bicicleta', duration: 60, time: 'morning', category: 'fisica', weekday: false, weekend: true },
                { id: 'cardio_walk', name: 'Caminata activa', duration: 30, time: 'evening', category: 'fisica', weekday: true, weekend: true }
            ],
            yoga: [
                { id: 'yoga_morning', name: 'Yoga matutino', duration: 45, time: 'morning', category: 'fisica', weekday: true, weekend: true },
                { id: 'yoga_stretch', name: 'Sesi√≥n de estiramientos', duration: 20, time: 'night', category: 'fisica', weekday: true, weekend: true },
                { id: 'yoga_class', name: 'Clase de yoga/pilates', duration: 60, time: 'morning', category: 'fisica', weekday: false, weekend: true },
                { id: 'yoga_meditation', name: 'Yoga + meditaci√≥n', duration: 30, time: 'morning', category: 'fisica', weekday: true, weekend: true }
            ],
            dance: [
                { id: 'dance_class', name: 'Clase de baile', duration: 60, time: 'evening', category: 'fisica', weekday: true, weekend: false },
                { id: 'dance_zumba', name: 'Zumba', duration: 45, time: 'morning', category: 'fisica', weekday: true, weekend: true },
                { id: 'dance_practice', name: 'Pr√°ctica de coreograf√≠a', duration: 30, time: 'afternoon', category: 'fisica', weekday: false, weekend: true },
                { id: 'dance_free', name: 'Baile libre en casa', duration: 20, time: 'evening', category: 'fisica', weekday: true, weekend: true }
            ],
            sports: [
                { id: 'sport_practice', name: 'Pr√°ctica deportiva', duration: 90, time: 'afternoon', category: 'fisica', weekday: true, weekend: true },
                { id: 'sport_match', name: 'Partido/Competencia', duration: 120, time: 'morning', category: 'fisica', weekday: false, weekend: true },
                { id: 'sport_technique', name: 'Entrenamiento t√©cnico', duration: 45, time: 'afternoon', category: 'fisica', weekday: true, weekend: false },
                { id: 'sport_conditioning', name: 'Acondicionamiento f√≠sico', duration: 30, time: 'morning', category: 'fisica', weekday: true, weekend: false }
            ]
        };

        // Pre-select from onboarding preferences or existing template
        function initFromPreferences() {
            // Try to load from existing template first (if user is re-running wizard)
            // Check both keys (active-template-schedules and template-schedules)
            const existingTemplate = localStorage.getItem(userKey + '-active-template-schedules') ||
                                     localStorage.getItem(userKey + '-template-schedules');
            if (existingTemplate) {
                try {
                    const template = JSON.parse(existingTemplate);
                    if (template.selectedHabits && template.selectedHabits.length > 0) {
                        selectedHabits = [...template.selectedHabits];
                        console.log('Loaded habits from template:', selectedHabits);
                    }
                    if (template.selectedExercises && template.selectedExercises.length > 0) {
                        selectedExercises = [...template.selectedExercises];
                        console.log('Loaded exercises from template:', selectedExercises);
                    }
                    if (template.selectedTasks) {
                        selectedTasks = JSON.parse(JSON.stringify(template.selectedTasks));
                        console.log('Loaded tasks from template:', selectedTasks);
                    }
                } catch (e) {
                    console.warn('Error parsing existing template:', e);
                }
            }

            // If no template, try onboarding preferences
            if (selectedHabits.length === 0 && userPreferences.habits) {
                selectedHabits = [...userPreferences.habits];
                console.log('Loaded habits from onboarding:', selectedHabits);
            }
            if (selectedExercises.length === 0 && userPreferences.exercise) {
                selectedExercises = userPreferences.exercise.filter(function(e) { return e !== 'none'; });
                console.log('Loaded exercises from onboarding:', selectedExercises);
            }

            console.log('Init complete - habits:', selectedHabits, 'exercises:', selectedExercises);
        }

        function renderHabits() {
            const container = document.getElementById('habitsGrid');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            Object.keys(habitsData).forEach(function(habitId) {
                const habit = habitsData[habitId];
                const isSelected = selectedHabits.indexOf(habitId) !== -1;

                const card = document.createElement('div');
                card.className = 'option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center' + (isSelected ? ' selected' : '');
                card.setAttribute('data-id', habitId);

                const checkIcon = document.createElement('div');
                checkIcon.className = 'check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs';
                checkIcon.textContent = '‚úì';

                const icon = document.createElement('span');
                icon.className = 'text-3xl block mb-1';
                icon.textContent = habit.icon;

                const name = document.createElement('p');
                name.className = 'text-sm font-medium text-gray-800';
                name.textContent = habit.name;

                const desc = document.createElement('p');
                desc.className = 'text-xs text-gray-500';
                desc.textContent = habit.description;

                card.appendChild(checkIcon);
                card.appendChild(icon);
                card.appendChild(name);
                card.appendChild(desc);

                card.addEventListener('click', function() {
                    toggleHabit(habitId);
                });

                container.appendChild(card);
            });
        }

        function renderExercises() {
            const container = document.getElementById('exerciseGrid');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            Object.keys(exercisesData).forEach(function(exerciseId) {
                const exercise = exercisesData[exerciseId];
                const isSelected = selectedExercises.indexOf(exerciseId) !== -1;

                const card = document.createElement('div');
                card.className = 'option-card cursor-pointer p-5 bg-white rounded-2xl border-2 border-gray-200 relative' + (isSelected ? ' selected' : '');
                card.setAttribute('data-id', exerciseId);

                const checkIcon = document.createElement('div');
                checkIcon.className = 'check-icon absolute top-3 right-3 w-6 h-6 bg-purple-500 rounded-full items-center justify-center text-white text-sm';
                checkIcon.textContent = '‚úì';

                const icon = document.createElement('span');
                icon.className = 'text-4xl mb-3 block';
                icon.textContent = exercise.icon;

                const name = document.createElement('h3');
                name.className = 'font-bold text-gray-900';
                name.textContent = exercise.name;

                const desc = document.createElement('p');
                desc.className = 'text-sm text-gray-500 mt-1';
                desc.textContent = exercise.description;

                card.appendChild(checkIcon);
                card.appendChild(icon);
                card.appendChild(name);
                card.appendChild(desc);

                card.addEventListener('click', function() {
                    toggleExercise(exerciseId);
                });

                container.appendChild(card);
            });

            // Add "No exercise" option
            const noExCard = document.createElement('div');
            noExCard.className = 'option-card cursor-pointer p-5 bg-white rounded-2xl border-2 border-gray-200 relative' + (selectedExercises.length === 0 ? ' selected' : '');

            const noExCheck = document.createElement('div');
            noExCheck.className = 'check-icon absolute top-3 right-3 w-6 h-6 bg-purple-500 rounded-full items-center justify-center text-white text-sm';
            noExCheck.textContent = '‚úì';

            const noExIcon = document.createElement('span');
            noExIcon.className = 'text-4xl mb-3 block';
            noExIcon.textContent = 'üö∂';

            const noExName = document.createElement('h3');
            noExName.className = 'font-bold text-gray-900';
            noExName.textContent = 'Sin ejercicio';

            const noExDesc = document.createElement('p');
            noExDesc.className = 'text-sm text-gray-500 mt-1';
            noExDesc.textContent = 'Por ahora no incluir ejercicio';

            noExCard.appendChild(noExCheck);
            noExCard.appendChild(noExIcon);
            noExCard.appendChild(noExName);
            noExCard.appendChild(noExDesc);

            noExCard.addEventListener('click', function() {
                selectedExercises = [];
                renderExercises();
            });

            container.appendChild(noExCard);
        }

        function toggleHabit(habitId) {
            const index = selectedHabits.indexOf(habitId);
            if (index === -1) {
                selectedHabits.push(habitId);
            } else {
                selectedHabits.splice(index, 1);
            }
            renderHabits();
        }

        function toggleExercise(exerciseId) {
            const index = selectedExercises.indexOf(exerciseId);
            if (index === -1) {
                selectedExercises.push(exerciseId);
            } else {
                selectedExercises.splice(index, 1);
            }
            renderExercises();
        }

        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            // Initialize selectedTasks for new items
            selectedHabits.forEach(function(habitId) {
                if (!selectedTasks[habitId]) {
                    // Pre-select first 2 tasks by default
                    const tasks = habitTasks[habitId] || [];
                    selectedTasks[habitId] = tasks.slice(0, 2).map(function(t) { return t.id; });
                }
            });

            selectedExercises.forEach(function(exerciseId) {
                if (!selectedTasks[exerciseId]) {
                    // Pre-select first 2 tasks by default
                    const tasks = exerciseTasks[exerciseId] || [];
                    selectedTasks[exerciseId] = tasks.slice(0, 2).map(function(t) { return t.id; });
                }
            });

            console.log('renderTasks - selectedHabits:', selectedHabits);
            console.log('renderTasks - selectedExercises:', selectedExercises);

            // Render habit sections
            selectedHabits.forEach(function(habitId) {
                const habit = habitsData[habitId];
                const tasks = habitTasks[habitId] || [];

                // Skip if habit data not found
                if (!habit) {
                    console.warn('Habit not found:', habitId);
                    return;
                }

                const section = document.createElement('div');
                section.className = 'bg-white rounded-xl p-4 border border-gray-200 habit-section';

                const header = document.createElement('div');
                header.className = 'flex items-center gap-3 mb-4';

                const headerIcon = document.createElement('span');
                headerIcon.className = 'text-2xl';
                headerIcon.textContent = habit.icon;

                const headerTitle = document.createElement('h3');
                headerTitle.className = 'font-bold text-gray-800';
                headerTitle.textContent = habit.name;

                const headerCount = document.createElement('span');
                headerCount.className = 'text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full';
                headerCount.textContent = (selectedTasks[habitId] || []).length + ' seleccionadas';

                header.appendChild(headerIcon);
                header.appendChild(headerTitle);
                header.appendChild(headerCount);
                section.appendChild(header);

                const tasksList = document.createElement('div');
                tasksList.className = 'space-y-2';

                tasks.forEach(function(task) {
                    const isSelected = (selectedTasks[habitId] || []).indexOf(task.id) !== -1;
                    const taskCard = createTaskCard(task, habitId, isSelected);
                    tasksList.appendChild(taskCard);
                });

                section.appendChild(tasksList);
                container.appendChild(section);
            });

            // Render exercise sections
            selectedExercises.forEach(function(exerciseId) {
                const exercise = exercisesData[exerciseId];
                const tasks = exerciseTasks[exerciseId] || [];

                // Skip if exercise data not found
                if (!exercise) {
                    console.warn('Exercise not found:', exerciseId);
                    return;
                }

                const section = document.createElement('div');
                section.className = 'bg-white rounded-xl p-4 border border-gray-200 exercise-section';

                const header = document.createElement('div');
                header.className = 'flex items-center gap-3 mb-4';

                const headerIcon = document.createElement('span');
                headerIcon.className = 'text-2xl';
                headerIcon.textContent = exercise.icon;

                const headerTitle = document.createElement('h3');
                headerTitle.className = 'font-bold text-gray-800';
                headerTitle.textContent = exercise.name;

                const headerCount = document.createElement('span');
                headerCount.className = 'text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full';
                headerCount.textContent = (selectedTasks[exerciseId] || []).length + ' seleccionadas';

                header.appendChild(headerIcon);
                header.appendChild(headerTitle);
                header.appendChild(headerCount);
                section.appendChild(header);

                const tasksList = document.createElement('div');
                tasksList.className = 'space-y-2';

                tasks.forEach(function(task) {
                    const isSelected = (selectedTasks[exerciseId] || []).indexOf(task.id) !== -1;
                    const taskCard = createTaskCard(task, exerciseId, isSelected);
                    tasksList.appendChild(taskCard);
                });

                section.appendChild(tasksList);
                container.appendChild(section);
            });

            // Show message if nothing selected
            if (selectedHabits.length === 0 && selectedExercises.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'text-center py-8 text-gray-500';
                emptyMsg.textContent = 'No has seleccionado ning√∫n h√°bito o ejercicio. Vuelve atr√°s para seleccionar.';
                container.appendChild(emptyMsg);
            }
        }

        function createTaskCard(task, parentId, isSelected) {
            const card = document.createElement('div');
            card.className = 'task-card flex items-center gap-3 p-3 rounded-lg border border-gray-100 cursor-pointer' + (isSelected ? ' selected' : '');

            const checkbox = document.createElement('div');
            checkbox.className = 'task-check w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-xs flex-shrink-0';
            if (isSelected) {
                checkbox.textContent = '‚úì';
            }

            const content = document.createElement('div');
            content.className = 'flex-1';

            const name = document.createElement('p');
            name.className = 'font-medium text-gray-800 text-sm';
            name.textContent = task.name;

            const meta = document.createElement('div');
            meta.className = 'flex items-center gap-2 text-xs text-gray-500';

            const duration = document.createElement('span');
            duration.textContent = '‚è±Ô∏è ' + task.duration + ' min';

            const days = document.createElement('span');
            const daysText = [];
            if (task.weekday) daysText.push('L-V');
            if (task.weekend) daysText.push('S-D');
            days.textContent = 'üìÖ ' + daysText.join(', ');

            meta.appendChild(duration);
            meta.appendChild(days);
            content.appendChild(name);
            content.appendChild(meta);

            card.appendChild(checkbox);
            card.appendChild(content);

            card.addEventListener('click', function() {
                toggleTask(parentId, task.id);
            });

            return card;
        }

        function toggleTask(parentId, taskId) {
            if (!selectedTasks[parentId]) {
                selectedTasks[parentId] = [];
            }

            const index = selectedTasks[parentId].indexOf(taskId);
            if (index === -1) {
                selectedTasks[parentId].push(taskId);
            } else {
                selectedTasks[parentId].splice(index, 1);
            }

            renderTasks();
        }

        function renderSummary() {
            const weekdayActivities = [];
            const weekendActivities = [];

            // Collect all selected tasks
            Object.keys(selectedTasks).forEach(function(parentId) {
                const taskIds = selectedTasks[parentId];
                const isHabit = habitsData[parentId] !== undefined;
                const tasks = isHabit ? habitTasks[parentId] : exerciseTasks[parentId];
                const parentData = isHabit ? habitsData[parentId] : exercisesData[parentId];

                if (tasks) {
                    tasks.forEach(function(task) {
                        if (taskIds.indexOf(task.id) !== -1) {
                            const activity = {
                                name: task.name,
                                duration: task.duration,
                                category: task.category,
                                icon: parentData.icon,
                                time: task.time
                            };

                            if (task.weekday) {
                                weekdayActivities.push(activity);
                            }
                            if (task.weekend) {
                                weekendActivities.push(activity);
                            }
                        }
                    });
                }
            });

            // Update counts
            document.getElementById('weekdayCount').textContent = weekdayActivities.length + ' actividades';
            document.getElementById('weekendCount').textContent = weekendActivities.length + ' actividades';

            // Render weekday summary
            const weekdaySummary = document.getElementById('weekdaySummary');
            while (weekdaySummary.firstChild) {
                weekdaySummary.removeChild(weekdaySummary.firstChild);
            }

            if (weekdayActivities.length > 0) {
                weekdayActivities.forEach(function(a) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 p-2 bg-gray-50 rounded-lg';

                    const icon = document.createElement('span');
                    icon.textContent = a.icon;

                    const name = document.createElement('span');
                    name.className = 'flex-1 text-sm text-gray-700';
                    name.textContent = a.name;

                    const duration = document.createElement('span');
                    duration.className = 'text-xs text-gray-500';
                    duration.textContent = a.duration + ' min';

                    div.appendChild(icon);
                    div.appendChild(name);
                    div.appendChild(duration);
                    weekdaySummary.appendChild(div);
                });
            } else {
                const empty = document.createElement('p');
                empty.className = 'text-gray-400 text-sm text-center py-4';
                empty.textContent = 'No hay actividades seleccionadas';
                weekdaySummary.appendChild(empty);
            }

            // Render weekend summary
            const weekendSummary = document.getElementById('weekendSummary');
            while (weekendSummary.firstChild) {
                weekendSummary.removeChild(weekendSummary.firstChild);
            }

            if (weekendActivities.length > 0) {
                weekendActivities.forEach(function(a) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 p-2 bg-gray-50 rounded-lg';

                    const icon = document.createElement('span');
                    icon.textContent = a.icon;

                    const name = document.createElement('span');
                    name.className = 'flex-1 text-sm text-gray-700';
                    name.textContent = a.name;

                    const duration = document.createElement('span');
                    duration.className = 'text-xs text-gray-500';
                    duration.textContent = a.duration + ' min';

                    div.appendChild(icon);
                    div.appendChild(name);
                    div.appendChild(duration);
                    weekendSummary.appendChild(div);
                });
            } else {
                const empty = document.createElement('p');
                empty.className = 'text-gray-400 text-sm text-center py-4';
                empty.textContent = 'No hay actividades seleccionadas';
                weekendSummary.appendChild(empty);
            }

            // Store for saving
            window.finalWeekdayActivities = weekdayActivities;
            window.finalWeekendActivities = weekendActivities;
        }

        function updateProgress() {
            for (let i = 1; i <= totalSteps; i++) {
                const dot = document.getElementById('dot' + i);
                dot.classList.remove('active', 'completed');
                if (i < currentStep) {
                    dot.classList.add('completed');
                } else if (i === currentStep) {
                    dot.classList.add('active');
                }
            }
            document.getElementById('stepIndicator').textContent = 'Paso ' + currentStep + ' de ' + totalSteps;
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(function(el) { el.classList.add('hidden'); });
            document.getElementById('step' + step).classList.remove('hidden');
            document.getElementById('step' + step).classList.add('fade-in');

            // Update buttons
            document.getElementById('prevBtn').classList.toggle('hidden', step === 1);
            document.getElementById('skipBtn').classList.toggle('hidden', step === totalSteps);
            document.getElementById('nextBtn').classList.toggle('hidden', step === totalSteps);
            document.getElementById('finishBtn').classList.toggle('hidden', step !== totalSteps);

            // Render content
            if (step === 1) {
                renderHabits();
            } else if (step === 2) {
                renderExercises();
            } else if (step === 3) {
                renderTasks();
            } else if (step === 4) {
                renderSummary();
            }

            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function skipSetup() {
            if (confirm('¬øOmitir la configuraci√≥n? Podr√°s personalizarla m√°s tarde desde Configuraci√≥n.')) {
                markSetupComplete();
                window.location.href = 'app.html';
            }
        }

        function getTimeForSlot(slot, isWeekend) {
            const wakeUp = userProfile.wakeUp || userPreferences.wakeUp || '07:00';
            const sleepTime = userProfile.sleep || userPreferences.sleep || '22:00';
            const wakeHour = parseInt(wakeUp.split(':')[0]) + (isWeekend ? 1 : 0);
            const sleepHour = parseInt(sleepTime.split(':')[0]);

            switch (slot) {
                case 'morning': return formatTime(wakeHour + 1, 0);
                case 'afternoon': return formatTime(12, 30);
                case 'evening': return formatTime(sleepHour - 3, 0);
                case 'night': return formatTime(sleepHour - 1, 0);
                default: return formatTime(wakeHour + 2, 0);
            }
        }

        function formatTime(hour, minutes) {
            const h = Math.min(23, Math.max(0, hour));
            const m = Math.min(59, Math.max(0, minutes));
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
        }

        function formatDurationString(minutes) {
            if (minutes < 60) return minutes + ' min';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (mins === 0) return hours + ' hr' + (hours > 1 ? 's' : '');
            return hours + ' hr ' + mins + ' min';
        }

        function finishActivitySetup() {
            const weekdayActivities = (window.finalWeekdayActivities || []).map(function(a) {
                return {
                    time: getTimeForSlot(a.time, false),
                    activity: a.icon + ' ' + a.name,
                    duration: formatDurationString(a.duration),
                    category: a.category
                };
            });

            const weekendActivities = (window.finalWeekendActivities || []).map(function(a) {
                return {
                    time: getTimeForSlot(a.time, true),
                    activity: a.icon + ' ' + a.name,
                    duration: formatDurationString(a.duration),
                    category: a.category
                };
            });

            // Sort by time
            weekdayActivities.sort(function(a, b) { return a.time.localeCompare(b.time); });
            weekendActivities.sort(function(a, b) { return a.time.localeCompare(b.time); });

            // Save to active-template-schedules (this is what app.html reads)
            const templateSchedules = {
                weekday: weekdayActivities,
                weekend: weekendActivities,
                templateId: 'user-custom-wizard',
                createdAt: new Date().toISOString(),
                selectedHabits: selectedHabits,
                selectedExercises: selectedExercises,
                selectedTasks: selectedTasks
            };

            // Save to the key that app.html looks for
            localStorage.setItem(userKey + '-active-template-schedules', JSON.stringify(templateSchedules));

            // Also save to template-schedules for wizard re-entry
            localStorage.setItem(userKey + '-template-schedules', JSON.stringify(templateSchedules));

            console.log('Saved template schedules:', templateSchedules);

            // Mark setup complete
            markSetupComplete();

            // Redirect to app
            window.location.href = 'app.html';
        }

        function markSetupComplete() {
            currentUser.needsActivitySetup = false;
            currentUser.activitySetupCompleted = true;
            localStorage.setItem('gestion-currentUser', JSON.stringify(currentUser));

            const users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            if (users[currentUser.email]) {
                users[currentUser.email].needsActivitySetup = false;
                users[currentUser.email].activitySetupCompleted = true;
                localStorage.setItem('gestion-users', JSON.stringify(users));
            }
        }

        // Initialize
        initFromPreferences();
        showStep(1);
    </script>
</body>
</html>
