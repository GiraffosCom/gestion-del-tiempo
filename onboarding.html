<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personaliza tu Plan - GestiÃ³n del Tiempo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, #3b82f6, #8b5cf6, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .option-card { transition: all 0.3s ease; }
        .option-card:hover { transform: translateY(-2px); }
        .option-card.selected { border-color: #8b5cf6; background: linear-gradient(135deg, #ede9fe, #fae8ff); }
        .option-card.selected .check-icon { display: flex; }
        .check-icon { display: none; }
        .step-dot.active { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .step-dot.completed { background: #22c55e; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .time-btn.selected { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border-color: transparent; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">

    <!-- Progress Header -->
    <header class="bg-white/80 backdrop-blur-sm border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">â°</span>
                    <span class="font-bold gradient-text">GestiÃ³n del Tiempo</span>
                </div>
                <span id="stepIndicator" class="text-sm text-gray-500">Paso 1 de 3</span>
            </div>
            <!-- Progress bar -->
            <div class="flex gap-2">
                <div id="dot1" class="step-dot w-full h-2 rounded-full bg-gray-200 active"></div>
                <div id="dot2" class="step-dot w-full h-2 rounded-full bg-gray-200"></div>
                <div id="dot3" class="step-dot w-full h-2 rounded-full bg-gray-200"></div>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8">
        <!-- Step 1: Objetivo + Color -->
        <div id="step1" class="step-content fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">ğŸ¯</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-1">Â¿CuÃ¡l es tu objetivo?</h1>
                <p class="text-gray-500 text-sm">Selecciona tu meta principal</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-8">
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('goal', 'fitness', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-3xl mb-2 block">ğŸ’ª</span>
                    <h3 class="font-bold text-gray-900 text-sm">Fitness</h3>
                    <p class="text-xs text-gray-500">TransformaciÃ³n fÃ­sica</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('goal', 'learning', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-3xl mb-2 block">ğŸ“š</span>
                    <h3 class="font-bold text-gray-900 text-sm">Aprender</h3>
                    <p class="text-xs text-gray-500">Nuevas habilidades</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('goal', 'productivity', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-3xl mb-2 block">ğŸ“ˆ</span>
                    <h3 class="font-bold text-gray-900 text-sm">Productividad</h3>
                    <p class="text-xs text-gray-500">Lograr mÃ¡s cada dÃ­a</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('goal', 'business', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-3xl mb-2 block">ğŸ’¼</span>
                    <h3 class="font-bold text-gray-900 text-sm">Negocio</h3>
                    <p class="text-xs text-gray-500">Emprender / crecer</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('goal', 'competition', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-3xl mb-2 block">ğŸ‘‘</span>
                    <h3 class="font-bold text-gray-900 text-sm">Competencia</h3>
                    <p class="text-xs text-gray-500">Miss, deportes, etc.</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('goal', 'wellness', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-3xl mb-2 block">ğŸ§˜</span>
                    <h3 class="font-bold text-gray-900 text-sm">Bienestar</h3>
                    <p class="text-xs text-gray-500">Salud y equilibrio</p>
                </div>
            </div>

            <!-- Color Selection -->
            <div class="border-t border-gray-200 pt-6">
                <h2 class="text-center font-bold text-gray-800 mb-4">ğŸ¨ Elige tu color</h2>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                    <div class="option-card cursor-pointer p-3 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('themeColor', 'rosa', this)">
                        <div class="check-icon absolute top-1 right-1 w-4 h-4 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="h-8 rounded-lg bg-gradient-to-r from-pink-500 to-purple-600 mb-2"></div>
                        <span class="text-xs font-medium">Rosa</span>
                    </div>
                    <div class="option-card cursor-pointer p-3 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('themeColor', 'azul', this)">
                        <div class="check-icon absolute top-1 right-1 w-4 h-4 bg-blue-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="h-8 rounded-lg bg-gradient-to-r from-blue-500 to-cyan-600 mb-2"></div>
                        <span class="text-xs font-medium">Azul</span>
                    </div>
                    <div class="option-card cursor-pointer p-3 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('themeColor', 'verde', this)">
                        <div class="check-icon absolute top-1 right-1 w-4 h-4 bg-emerald-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="h-8 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 mb-2"></div>
                        <span class="text-xs font-medium">Verde</span>
                    </div>
                    <div class="option-card cursor-pointer p-3 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('themeColor', 'naranja', this)">
                        <div class="check-icon absolute top-1 right-1 w-4 h-4 bg-orange-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="h-8 rounded-lg bg-gradient-to-r from-orange-500 to-amber-500 mb-2"></div>
                        <span class="text-xs font-medium">Naranja</span>
                    </div>
                    <div class="option-card cursor-pointer p-3 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('themeColor', 'coral', this)">
                        <div class="check-icon absolute top-1 right-1 w-4 h-4 bg-rose-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="h-8 rounded-lg bg-gradient-to-r from-rose-500 to-red-600 mb-2"></div>
                        <span class="text-xs font-medium">Coral</span>
                    </div>
                    <div class="option-card cursor-pointer p-3 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('themeColor', 'morado', this)">
                        <div class="check-icon absolute top-1 right-1 w-4 h-4 bg-violet-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="h-8 rounded-lg bg-gradient-to-r from-violet-500 to-indigo-600 mb-2"></div>
                        <span class="text-xs font-medium">Morado</span>
                    </div>
                </div>
            </div>

            <!-- Icon Style Selection -->
            <div class="border-t border-gray-200 pt-6 mt-6">
                <h2 class="text-center font-bold text-gray-800 mb-4">âœ¨ Estilo de iconos</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center selected" onclick="selectOption('iconStyle', 'emoji', this)">
                        <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="flex justify-center gap-2 mb-3 text-2xl">
                            <span>ğŸ‹ï¸</span><span>ğŸ’ª</span><span>ğŸ”¥</span><span>ğŸ¯</span>
                        </div>
                        <h3 class="font-bold text-gray-900 text-sm">Emojis</h3>
                        <p class="text-xs text-gray-500">Coloridos y expresivos</p>
                    </div>
                    <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('iconStyle', 'lucide', this)">
                        <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                        <div class="flex justify-center gap-2 mb-3">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2"/></svg>
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        </div>
                        <h3 class="font-bold text-gray-900 text-sm">Minimalista</h3>
                        <p class="text-xs text-gray-500">Limpio y profesional</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Horarios + Ejercicio -->
        <div id="step2" class="step-content hidden fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">â°</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-1">Tu rutina diaria</h1>
                <p class="text-gray-500 text-sm">Configura tus horarios y actividad fÃ­sica</p>
            </div>

            <div class="bg-white rounded-2xl p-5 border border-gray-200 mb-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-medium text-gray-700 mb-2 text-sm">ğŸŒ… Despertar</label>
                        <div class="flex flex-wrap gap-2">
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition" onclick="selectTime('wakeUp', '05:00', this)">5:00</button>
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition" onclick="selectTime('wakeUp', '06:00', this)">6:00</button>
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition selected" onclick="selectTime('wakeUp', '07:00', this)">7:00</button>
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition" onclick="selectTime('wakeUp', '08:00', this)">8:00</button>
                        </div>
                    </div>
                    <div>
                        <label class="block font-medium text-gray-700 mb-2 text-sm">ğŸŒ™ Dormir</label>
                        <div class="flex flex-wrap gap-2">
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition" onclick="selectTime('sleep', '21:00', this)">21:00</button>
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition selected" onclick="selectTime('sleep', '22:00', this)">22:00</button>
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition" onclick="selectTime('sleep', '23:00', this)">23:00</button>
                            <button class="time-btn px-3 py-2 border-2 border-gray-200 rounded-lg text-sm hover:border-purple-300 transition" onclick="selectTime('sleep', '00:00', this)">00:00</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ejercicio simplificado -->
            <h2 class="font-bold text-gray-800 mb-3">ğŸ’ª Tipo de ejercicio</h2>
            <div class="grid grid-cols-3 gap-3">
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="toggleMultiOption('exercise', 'gym', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl mb-1 block">ğŸ‹ï¸</span>
                    <h3 class="font-medium text-gray-900 text-sm">Gimnasio</h3>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="toggleMultiOption('exercise', 'cardio', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl mb-1 block">ğŸƒ</span>
                    <h3 class="font-medium text-gray-900 text-sm">Cardio</h3>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="toggleMultiOption('exercise', 'yoga', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl mb-1 block">ğŸ§˜</span>
                    <h3 class="font-medium text-gray-900 text-sm">Yoga</h3>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="toggleMultiOption('exercise', 'dance', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl mb-1 block">ğŸ’ƒ</span>
                    <h3 class="font-medium text-gray-900 text-sm">Baile</h3>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="toggleMultiOption('exercise', 'sports', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl mb-1 block">âš½</span>
                    <h3 class="font-medium text-gray-900 text-sm">Deportes</h3>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="toggleMultiOption('exercise', 'none', this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl mb-1 block">ğŸš¶</span>
                    <h3 class="font-medium text-gray-900 text-sm">Ninguno</h3>
                </div>
            </div>
        </div>

        <!-- Step 3: DuraciÃ³n + Resumen -->
        <div id="step3" class="step-content hidden fade-in">
            <div class="text-center mb-6">
                <span class="text-5xl mb-3 block">ğŸ“…</span>
                <h1 class="text-2xl font-bold text-gray-900 mb-1">DuraciÃ³n del plan</h1>
                <p class="text-gray-500 text-sm">Â¿CuÃ¡nto tiempo durarÃ¡ tu transformaciÃ³n?</p>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-6">
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('duration', 30, this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl font-bold text-gray-900">30</span>
                    <p class="text-xs text-gray-500">dÃ­as</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('duration', 60, this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl font-bold text-gray-900">60</span>
                    <p class="text-xs text-gray-500">dÃ­as</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('duration', 90, this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl font-bold text-gray-900">90</span>
                    <p class="text-xs text-gray-500">dÃ­as</p>
                </div>
                <div class="option-card cursor-pointer p-4 bg-white rounded-xl border-2 border-gray-200 relative text-center" onclick="selectOption('duration', 180, this)">
                    <div class="check-icon absolute top-2 right-2 w-5 h-5 bg-purple-500 rounded-full items-center justify-center text-white text-xs">âœ“</div>
                    <span class="text-2xl font-bold text-gray-900">180</span>
                    <p class="text-xs text-gray-500">dÃ­as</p>
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-white rounded-2xl p-5 border border-gray-200">
                <h3 class="font-bold text-gray-900 mb-4">ğŸ“‹ Resumen de tu plan</h3>
                <div id="planSummary" class="space-y-2 text-sm"></div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between mt-8">
            <button id="prevBtn" onclick="prevStep()" class="px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200 transition hidden">
                â† Anterior
            </button>
            <button id="nextBtn" onclick="nextStep()" class="px-8 py-3 gradient-bg text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg shadow-purple-200 ml-auto">
                Siguiente â†’
            </button>
            <button id="finishBtn" onclick="generatePlan()" class="px-8 py-3 gradient-bg text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg shadow-purple-200 ml-auto hidden">
                âœ¨ Crear mi plan
            </button>
        </div>
    </main>

    <script src="src/js/services/supabase-api.js"></script>

    <script>
        const currentUser = JSON.parse(localStorage.getItem('gestion-currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        let currentStep = 1;
        const totalSteps = 3;
        let cloudTemplates = null;

        const userPreferences = {
            goal: null,
            themeColor: null,
            iconStyle: 'emoji',
            wakeUp: '07:00',
            sleep: '22:00',
            occupation: 'flexible',
            exercise: [],
            habits: [],
            duration: 60
        };

        function selectOption(key, value, element) {
            const scrollPos = window.scrollY;
            userPreferences[key] = value;
            element.parentElement.querySelectorAll('.option-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            requestAnimationFrame(function() {
                window.scrollTo(0, scrollPos);
            });
        }

        function selectTime(key, value, element) {
            userPreferences[key] = value;
            element.parentElement.querySelectorAll('.time-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function toggleMultiOption(key, value, element) {
            const scrollPos = window.scrollY;
            const index = userPreferences[key].indexOf(value);

            if (index > -1) {
                userPreferences[key].splice(index, 1);
                element.classList.remove('selected');
            } else {
                if (key === 'exercise' && value === 'none') {
                    userPreferences[key] = ['none'];
                    element.parentElement.querySelectorAll('.option-card').forEach(function(card) {
                        card.classList.remove('selected');
                    });
                } else if (key === 'exercise' && userPreferences[key].includes('none')) {
                    userPreferences[key] = [];
                    var selectedCard = element.parentElement.querySelector('.option-card.selected');
                    if (selectedCard) selectedCard.classList.remove('selected');
                }
                userPreferences[key].push(value);
                element.classList.add('selected');
            }

            requestAnimationFrame(function() {
                window.scrollTo(0, scrollPos);
            });
        }

        function updateProgress() {
            for (var i = 1; i <= totalSteps; i++) {
                var dot = document.getElementById('dot' + i);
                dot.classList.remove('active', 'completed');
                if (i < currentStep) {
                    dot.classList.add('completed');
                } else if (i === currentStep) {
                    dot.classList.add('active');
                }
            }
            document.getElementById('stepIndicator').textContent = 'Paso ' + currentStep + ' de ' + totalSteps;
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(function(el) {
                el.classList.add('hidden');
            });
            document.getElementById('step' + step).classList.remove('hidden');
            document.getElementById('step' + step).classList.add('fade-in');

            document.getElementById('prevBtn').classList.toggle('hidden', step === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', step === totalSteps);
            document.getElementById('finishBtn').classList.toggle('hidden', step !== totalSteps);

            if (step === totalSteps) {
                updateSummary();
            }

            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextStep() {
            if (currentStep === 1 && !userPreferences.goal) {
                alert('Por favor selecciona tu objetivo');
                return;
            }
            if (currentStep === 1 && !userPreferences.themeColor) {
                alert('Por favor selecciona un color');
                return;
            }

            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function updateSummary() {
            var goalLabels = {
                fitness: 'ğŸ’ª Fitness',
                learning: 'ğŸ“š Aprendizaje',
                productivity: 'ğŸ“ˆ Productividad',
                business: 'ğŸ’¼ Negocio',
                competition: 'ğŸ‘‘ Competencia',
                wellness: 'ğŸ§˜ Bienestar'
            };

            var themeLabels = {
                rosa: 'ğŸŒ¸ Rosa',
                azul: 'ğŸŒŠ Azul',
                verde: 'ğŸŒ¿ Verde',
                naranja: 'ğŸ”¥ Naranja',
                coral: 'â¤ï¸ Coral',
                morado: 'ğŸ’œ Morado'
            };

            var exerciseLabels = {
                gym: 'ğŸ‹ï¸ Gimnasio',
                cardio: 'ğŸƒ Cardio',
                yoga: 'ğŸ§˜ Yoga',
                dance: 'ğŸ’ƒ Baile',
                sports: 'âš½ Deportes',
                none: 'ğŸš¶ Ninguno'
            };

            var exerciseText = userPreferences.exercise.length > 0
                ? userPreferences.exercise.map(function(e) { return exerciseLabels[e]; }).join(', ')
                : 'No seleccionado';

            var summaryEl = document.getElementById('planSummary');
            summaryEl.textContent = '';

            var iconStyleLabels = {
                emoji: 'ğŸ˜€ Emojis',
                lucide: 'â—¯ Minimalista'
            };

            var items = [
                { label: 'Objetivo', value: goalLabels[userPreferences.goal] || '-' },
                { label: 'Color', value: themeLabels[userPreferences.themeColor] || '-' },
                { label: 'Iconos', value: iconStyleLabels[userPreferences.iconStyle] || 'Emojis' },
                { label: 'Horario', value: userPreferences.wakeUp + ' - ' + userPreferences.sleep },
                { label: 'Ejercicio', value: exerciseText },
                { label: 'DuraciÃ³n', value: (userPreferences.duration || 60) + ' dÃ­as' }
            ];

            items.forEach(function(item, idx) {
                var row = document.createElement('div');
                row.className = 'flex justify-between py-2' + (idx < items.length - 1 ? ' border-b border-gray-100' : '');

                var labelSpan = document.createElement('span');
                labelSpan.className = 'text-gray-500';
                labelSpan.textContent = item.label;

                var valueSpan = document.createElement('span');
                valueSpan.className = 'font-medium';
                valueSpan.textContent = item.value;

                row.appendChild(labelSpan);
                row.appendChild(valueSpan);
                summaryEl.appendChild(row);
            });
        }

        function generatePlan() {
            if (!userPreferences.duration) {
                alert('Por favor selecciona la duraciÃ³n del plan');
                return;
            }

            var userKey = currentUser.email.replace(/[^a-z0-9]/gi, '_');

            var users = JSON.parse(localStorage.getItem('gestion-users') || '{}');
            if (users[currentUser.email]) {
                users[currentUser.email].goal = userPreferences.goal;
                users[currentUser.email].duration = userPreferences.duration;
                users[currentUser.email].preferences = userPreferences;
                users[currentUser.email].needsActivitySetup = true;
                localStorage.setItem('gestion-users', JSON.stringify(users));
            }

            currentUser.goal = userPreferences.goal;
            currentUser.duration = userPreferences.duration;
            currentUser.preferences = userPreferences;
            currentUser.onboardingCompleted = true;
            currentUser.needsActivitySetup = true;
            delete currentUser.needsOnboarding;
            localStorage.setItem('gestion-currentUser', JSON.stringify(currentUser));

            var customHabits = generateHabits(userPreferences);
            localStorage.setItem(userKey + '-custom-habits', JSON.stringify(customHabits));

            if (userPreferences.exercise.length > 0 && !userPreferences.exercise.includes('none')) {
                var customGym = generateGymRoutines(userPreferences);
                localStorage.setItem(userKey + '-custom-gym', JSON.stringify(customGym));
            }

            var customGoals = generateWeeklyGoals(userPreferences);
            localStorage.setItem(userKey + '-custom-goals', JSON.stringify(customGoals));

            var userProfile = {
                wakeUp: userPreferences.wakeUp,
                sleep: userPreferences.sleep,
                goal: userPreferences.goal,
                occupation: userPreferences.occupation,
                themeColor: userPreferences.themeColor || 'rosa',
                iconStyle: userPreferences.iconStyle || 'emoji'
            };
            localStorage.setItem(userKey + '-user-profile', JSON.stringify(userProfile));
            localStorage.setItem(userKey + '-icon-style', userPreferences.iconStyle || 'emoji');

            window.location.href = 'app.html';
        }

        function generateHabits(prefs) {
            var habits = [
                { id: 1, icon: 'â˜€ï¸', name: 'Despertar ' + prefs.wakeUp },
                { id: 2, icon: 'ğŸ’§', name: 'Beber agua al despertar' }
            ];
            var id = 3;

            if (prefs.exercise.length > 0 && !prefs.exercise.includes('none')) {
                habits.push({ id: id++, icon: 'ğŸ’ª', name: 'Ejercicio completado' });
            }

            habits.push({ id: id++, icon: 'ğŸ“–', name: 'Leer 15-20 min' });
            habits.push({ id: id++, icon: 'ğŸ™', name: 'Momento de gratitud' });
            habits.push({ id: id++, icon: 'ğŸ˜´', name: 'Dormir antes de ' + prefs.sleep });

            return habits;
        }

        function generateGymRoutines(prefs) {
            var routines = {};
            var exerciseType = prefs.exercise.includes('gym') ? 'gym' :
                               prefs.exercise.includes('cardio') ? 'cardio' :
                               prefs.exercise.includes('yoga') ? 'yoga' :
                               prefs.exercise.includes('dance') ? 'dance' :
                               prefs.exercise.includes('sports') ? 'sports' : null;

            if (prefs.exercise.includes('gym')) {
                routines[0] = { name: 'Descanso Activo', icon: 'ğŸ§˜', exercises: ['Estiramientos 20min', 'Caminata ligera 30min'] };
                routines[1] = { name: 'Tren Inferior', icon: 'ğŸ¦µ', exercises: ['Sentadillas 4x12', 'Peso muerto 4x10', 'Prensa 4x12', 'Zancadas 3x12'] };
                routines[2] = { name: 'Tren Superior', icon: 'ğŸ’ª', exercises: ['Press banca 4x10', 'Remo 4x12', 'Press hombro 3x12', 'Curl bÃ­ceps 3x15'] };
                routines[3] = { name: 'Full Body', icon: 'ğŸ”¥', exercises: ['Sentadilla 3x12', 'Press pecho 3x12', 'Peso muerto 3x10', 'Remo 3x12'] };
                routines[4] = { name: 'Piernas + Core', icon: 'ğŸ‘', exercises: ['Hip thrust 4x12', 'Sentadilla bÃºlgara 3x10', 'Curl femoral 3x12', 'Plancha 3x30seg'] };
                routines[5] = { name: 'Cardio + Fuerza', icon: 'â¤ï¸', exercises: ['HIIT 20min', 'Circuito funcional 3 rondas', 'Abdominales 3x20'] };
                routines[6] = { name: 'Flexibilidad', icon: 'ğŸ§˜', exercises: ['Yoga 45min', 'Estiramientos profundos 20min'] };
            } else if (prefs.exercise.includes('cardio')) {
                routines[0] = { name: 'Descanso', icon: 'ğŸ˜´', exercises: ['Caminata suave 20min'] };
                routines[1] = { name: 'Cardio Moderado', icon: 'ğŸƒ', exercises: ['Correr 30min'] };
                routines[2] = { name: 'HIIT', icon: 'ğŸ”¥', exercises: ['HIIT 20min'] };
                routines[3] = { name: 'Cardio Largo', icon: 'ğŸš´', exercises: ['Bicicleta 45min'] };
                routines[4] = { name: 'Intervalos', icon: 'âš¡', exercises: ['Intervalos 25min'] };
                routines[5] = { name: 'Cardio + Core', icon: 'ğŸ’ª', exercises: ['Cardio 20min', 'Abdominales 15min'] };
                routines[6] = { name: 'RecuperaciÃ³n', icon: 'ğŸ§˜', exercises: ['Caminata 30min', 'Yoga 20min'] };
            } else if (prefs.exercise.includes('yoga')) {
                routines[0] = { name: 'Descanso', icon: 'ğŸ˜´', exercises: ['MeditaciÃ³n 20min'] };
                routines[1] = { name: 'Vinyasa Flow', icon: 'ğŸ§˜', exercises: ['Vinyasa 40min'] };
                routines[2] = { name: 'Fuerza Yoga', icon: 'ğŸ’ª', exercises: ['Power yoga 40min'] };
                routines[3] = { name: 'Flexibilidad', icon: 'ğŸ¤¸', exercises: ['Yin yoga 45min'] };
                routines[4] = { name: 'Core Yoga', icon: 'ğŸ”¥', exercises: ['Yoga para core 30min'] };
                routines[5] = { name: 'Balance', icon: 'âš–ï¸', exercises: ['Posturas de equilibrio 30min'] };
                routines[6] = { name: 'Restaurativo', icon: 'ğŸŒ™', exercises: ['Yoga restaurativo 40min'] };
            } else if (prefs.exercise.includes('dance')) {
                routines[0] = { name: 'Descanso', icon: 'ğŸ˜´', exercises: ['Estiramientos 20min'] };
                routines[1] = { name: 'Zumba', icon: 'ğŸ’ƒ', exercises: ['Zumba 45min'] };
                routines[2] = { name: 'Baile Cardio', icon: 'ğŸµ', exercises: ['Cardio dance 40min'] };
                routines[3] = { name: 'TÃ©cnica', icon: 'ğŸ‘ ', exercises: ['TÃ©cnica de baile 30min'] };
                routines[4] = { name: 'Ritmos Latinos', icon: 'ğŸŒ´', exercises: ['Salsa/Bachata 45min'] };
                routines[5] = { name: 'Dance Fitness', icon: 'ğŸ”¥', exercises: ['Dance workout 40min'] };
                routines[6] = { name: 'Stretching', icon: 'ğŸ§˜', exercises: ['Stretching 30min'] };
            } else if (prefs.exercise.includes('sports')) {
                routines[0] = { name: 'Descanso', icon: 'ğŸ˜´', exercises: ['RecuperaciÃ³n activa'] };
                routines[1] = { name: 'TÃ©cnica', icon: 'ğŸ¯', exercises: ['PrÃ¡ctica tÃ©cnica 45min'] };
                routines[2] = { name: 'Fuerza', icon: 'ğŸ’ª', exercises: ['Fuerza 40min'] };
                routines[3] = { name: 'TÃ¡ctica', icon: 'ğŸ§ ', exercises: ['Entrenamiento tÃ¡ctico 45min'] };
                routines[4] = { name: 'Resistencia', icon: 'â¤ï¸', exercises: ['Cardio especÃ­fico 40min'] };
                routines[5] = { name: 'Partido', icon: 'âš½', exercises: ['PrÃ¡ctica completa 90min'] };
                routines[6] = { name: 'RecuperaciÃ³n', icon: 'ğŸ§˜', exercises: ['Yoga 30min'] };
            }

            return routines;
        }

        function generateWeeklyGoals(prefs) {
            var totalWeeks = Math.ceil(prefs.duration / 7);
            var goals = [];

            var templates = {
                fitness: {
                    fisica: ['Establecer rutina', 'Aumentar intensidad', 'Mejorar resistencia', 'Definir mÃºsculos', 'Alcanzar meta'],
                    personal: ['Aprender nutriciÃ³n', 'Rutina de sueÃ±o', 'Gestionar estrÃ©s', 'Mejorar autoestima', 'Consistencia'],
                    digital: ['Seguir cuentas fitness', 'Documentar progreso', 'Recetas saludables', 'Comunidad', 'Compartir logros'],
                    espiritual: ['Practicar gratitud', 'MeditaciÃ³n', 'Visualizar metas', 'AutocompasiÃ³n', 'Celebrar']
                },
                learning: {
                    fisica: ['Horario de estudio', 'Descansos activos', 'Cuidar postura', 'Ejercicio', 'Balance'],
                    personal: ['Definir objetivos', 'TÃ©cnicas de estudio', 'PrÃ¡ctica diaria', 'Medir progreso', 'Aplicar'],
                    digital: ['Organizar recursos', 'Apps de aprendizaje', 'Comunidad online', 'Certificaciones', 'Portfolio'],
                    espiritual: ['Paciencia', 'Celebrar logros', 'Mentalidad de crecimiento', 'Gestionar frustraciÃ³n', 'Disfrutar']
                },
                productivity: {
                    fisica: ['Rutina matutina', 'Pausas activas', 'Ejercicio regular', 'SueÃ±o de calidad', 'AlimentaciÃ³n'],
                    personal: ['Sistema productivo', 'Eliminar distracciones', 'Priorizar', 'Delegar', 'Automatizar'],
                    digital: ['Herramientas', 'Calendario', 'Inbox zero', 'Limitar redes', 'Tracking tiempo'],
                    espiritual: ['PropÃ³sito claro', 'Mindfulness', 'Evitar burnout', 'Equilibrio', 'Gratitud']
                },
                business: {
                    fisica: ['EnergÃ­a', 'Ejercicio', 'GestiÃ³n estrÃ©s', 'Networking', 'Presencia profesional'],
                    personal: ['Modelo de negocio', 'Validar idea', 'Primeros clientes', 'Escalar', 'Liderazgo'],
                    digital: ['Presencia online', 'Marketing', 'AutomatizaciÃ³n', 'MÃ©tricas', 'Marca personal'],
                    espiritual: ['Resiliencia', 'Manejar incertidumbre', 'VisiÃ³n', 'Celebrar', 'Aprender de errores']
                },
                competition: {
                    fisica: ['PreparaciÃ³n inicial', 'Intensificar', 'Perfeccionar tÃ©cnica', 'Peak performance', 'Competencia'],
                    personal: ['Investigar', 'Coach/Mentor', 'PrÃ¡ctica deliberada', 'Simulacros', 'Mentalidad ganadora'],
                    digital: ['Estudiar ganadores', 'Documentar', 'Comunidad', 'Visibilidad', 'Marca personal'],
                    espiritual: ['VisualizaciÃ³n', 'Manejo nervios', 'Confianza', 'Presencia', 'Disfrutar']
                },
                wellness: {
                    fisica: ['Movimiento diario', 'AlimentaciÃ³n consciente', 'SueÃ±o', 'Reducir tensiÃ³n', 'EnergÃ­a'],
                    personal: ['Autoconocimiento', 'LÃ­mites', 'Relaciones', 'Hobbies', 'Tiempo para ti'],
                    digital: ['Detox digital', 'Apps bienestar', 'Contenido positivo', 'Comunidad', 'Balance'],
                    espiritual: ['MeditaciÃ³n', 'ConexiÃ³n interior', 'PropÃ³sito', 'Paz mental', 'Plenitud']
                }
            };

            var template = templates[prefs.goal] || templates.wellness;

            for (var week = 1; week <= totalWeeks; week++) {
                var progress = (week - 1) / (totalWeeks - 1 || 1);
                var phaseIndex = Math.min(4, Math.floor(progress * 5));

                goals.push({
                    week: week,
                    dates: 'Semana ' + week,
                    fisica: template.fisica[phaseIndex],
                    personal: template.personal[phaseIndex],
                    digital: template.digital[phaseIndex],
                    espiritual: template.espiritual[phaseIndex]
                });
            }

            return goals;
        }

        async function loadCloudTemplates() {
            try {
                if (typeof supabaseAPI !== 'undefined') {
                    cloudTemplates = await supabaseAPI.getAppTemplates();
                }
            } catch (e) {
                console.log('Using default templates');
            }
        }

        (async function init() {
            await loadCloudTemplates();
            showStep(1);
        })();
    </script>
</body>
</html>
